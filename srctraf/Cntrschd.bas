Attribute VB_Name = "CNTRSCHD"
'******************************************************************************************
'***** VB Compress Pro 6.11.32 generated this copy of Cntrschd.bas on Wed 6/17/09 @ 12:56 P
'***** Mode: AutoSelect Standard Mode (Internal References Only)***************************
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Private Variables (Removed)                                                            *
'*  tmSmfSrchKey3                 tmRafSrchKey2                 tmSefSrchKey              *
'*                                                                                        *
'******************************************************************************************

' Copyright 1993 Counterpoint Software, Inc. All rights reserved.
' Proprietary Software, Do not copy
'
' File Name: CntrSchd.BAS
'
' Release: 1.0
'
' Description:
'   This file contains the schedule subs and functions
Option Explicit
Option Compare Text
Public igDoEvent As Integer
Public igSchdInBkgd As Integer
Dim edcMessage As CHF       'Current
Dim tmChfSrchKey As LONGKEY0
Dim tmCChf As CHF           'Current
Dim tmPChf As CHF           'Previous
Dim tmChf As CHF            'Previous
Dim tmChfSrchKey1 As CHFKEY1
Dim hmCHF As Integer        'CHF handle
Dim imCHFRecLen As Integer  'Record length
Dim lmCChfRecPos As Long
Dim tmClfExt() As CLFEXT
Dim lmPLnRecPos() As Long
Dim smLnSchStatus() As String
Dim hmClf As Integer        'Clf handle
Dim tmCClf As CLF           'Current line
Dim tmSvCClf As CLF         'Save Current when looping thru multi-vehicles
Dim smOrigLnSchStatus As String
Dim tmPclf As CLF           'Previous line
Dim imClfRecLen As Integer  'Record length
Dim hmCff As Integer        'CFF handle
Dim tmCCff() As CFF         'Current flights for the line
Dim tmPCff() As CFF         'Previous flights for the line
Dim imCffRecLen As Integer  'Record length
Dim hmCgf As Integer
Dim tmCCgf() As CGF         'Current flights for the line
Dim tmPCgf() As CGF         'Previous flights for the line
Dim tmReSchdCgf() As CGF
Dim imCgfRecLen As Integer
Dim tmCgfSrchKey1 As CGFKEY1
Dim hmGsf As Integer
Dim imGsfRecLen As Integer
Dim tmGsf As GSF
Dim tmGsfSrchKey3 As GSFKEY3
Dim tmGsfSrchKey4 As GSFKEY4
Dim hmGhf As Integer
Dim tmVcf As VCF
Dim hmVcf As Integer        'VCF handle
Dim imVcfRecLen As Integer  'Record length
Dim tmLcf As LCF
Dim hmLcf As Integer        'LCF handle
Dim imLcfRecLen As Integer  'Record length
Dim tmStf As STF
Dim hmStf As Integer        'VCF handle
Dim imStfRecLen As Integer  'Record length
Dim tmSsf As SSF            'Used for repositioning hmssf
Dim hmSsf As Integer        'SSF handle
Dim tmSsfSrchKey As SSFKEY0 'SSF key record image
Dim imSsfRecLen As Integer  'Record length
Dim tmProg As PROGRAMSS
Dim tmAvail As AVAILSS
Dim tmSpot As CSPOTSS
Dim tmProgTest As PROGRAMSS
Dim tmAvailTest As AVAILSS
Dim tmSpotTest As CSPOTSS
Dim tmBBSpotTest As BBSPOTSS
Dim tmSdf As SDF
Dim hmSdf As Integer        'SDF handle
Dim imSdfRecLen As Integer  'Record length
'Dim lmSdfRecPos As Long
Dim lmSdfCode As Long
Dim tmSdfSrchKey0 As SDFKEY0
Dim tmSdfSrchKey2 As SDFKEY2
Dim tmSdfSrchKey3 As LONGKEY0
Dim tmSdfSrchKey5 As LONGKEY0
'Package spots
'
Dim tmSmf As SMF
Dim hmSmf As Integer        'SMF handle
Dim imSmfRecLen As Integer  'Record length
Dim tmSmfSrchKey As SMFKEY0
Dim tmSmfSrchKey2 As LONGKEY0
Dim tmMtf As MTF
Dim hmMtf As Integer        'SMF handle
Dim imMtfRecLen As Integer  'Record length
Dim tmMtfSrchKey0 As LONGKEY0
'Rate Card
Dim tmCRdf As RDF
Dim tmPRdf As RDF
Dim hmRdf As Integer        'RDF handle
Dim imRdfRecLen As Integer  'Record length
'Vehicle
Dim tmVef As VEF
Dim hmVef As Integer        'VEF handle
Dim imVefRecLen As Integer  'Record length
Dim tmVefSrchKey As INTKEY0
Dim tmVehLock() As Integer  'Vehicles locked when scheduling contract
'Virtual Vehcile
Dim tmCVsf As VSF
Dim tmPVsf As VSF
Dim hmVsf As Integer        'VSF handle
Dim tmVsfSrchKey As LONGKEY0
Dim imVsfRecLen As Integer  'Record length
Dim tmVsf As VSF
'Copy Rotation
Dim hmCrf As Integer
Dim tmCrf As CRF
Dim imCrfRecLen As Integer  'Record length
Dim tmCrfSrchKey1 As CRFKEY1
'NTR Billing
Dim hmSbf As Integer
Dim tmSbf As SBF
Dim imSbfRecLen As Integer
Dim tmSbfSrchKey0 As SBFKEY0    'SBF key record image
Dim tmSbfSrchKey1 As LONGKEY0
Dim tmCSbf() As SBF     'Used when swapping
Dim tmPSbf() As SBF     'Used when swapping
'Podcast CPM
Dim hmPcf As Integer
Dim tmPcf As PCF
Dim imPcfRecLen As Integer
Dim tmPcfSrchKey0 As LONGKEY0
Dim tmPcfSrchKey2 As PCFKEY2    'SBF key record image
Dim tmCPcf() As PCF     'Used when swapping
Dim tmPPcf() As PCF     'Used when swapping
'MultiMedia
Dim hmMsf As Integer
Dim tmMsf As MSF
Dim imMsfRecLen As Integer
Dim tmMsfSrchKey0 As LONGKEY0
Dim tmMsfSrchKey2 As MSFKEY2
Dim tmCMsf() As MSF     'Used when swapping
Dim tmPMsf() As MSF     'Used when swapping
'Feed
Dim hmFsf As Integer
Dim imFsfRecLen As Integer
Dim tmFsfSrchKey0 As LONGKEY0
Dim tmCFsf As FSF
Dim tmPFsf As FSF
Dim lmFsfRecPos As Long
Dim lmFsfCode() As Long
'Pledge
Dim hmFpf As Integer
Dim imFpfRecLen As Integer
Dim tmFpf As FSF
'Feed Name
Dim hmFnf As Integer
Dim imFnfRecLen As Integer
Dim tmFnfSrchKey0 As INTKEY0
Dim tmFnf As FNF
'Product Name
Dim hmPrf As Integer
Dim imPrfRecLen As Integer
Dim tmPrfSrchKey0 As LONGKEY0
Dim tmPrf As PRF
'Record Lock
Dim hmRlf As Integer
Dim lmLockRecCode As Long

Dim hmSxf As Integer

'Delete
'Dim hmDsf As Integer
'Dim tmDsf As DSF
'Dim imDsfRecLen As Integer  'Record length
Dim smSyncDate As String
Dim smSyncTime As String
Dim imCVefCode As Integer   'Current VefCode
Dim imCVpfIndex As Integer  'Index into tgVpf for imCVefCode
Dim lmCompTime As Long      'Comptitive separation time if sCompType = "T"
Dim imAnyZeroPct As Integer  'Any Zero Dayparts defined (set in mNorPct)
'Dim fmRdfPct(1 To 7) As Single      'Number of spots within each of the seven
Dim fmRdfPct(0 To 6) As Single      'Number of spots within each of the seven
                                    'time periods of the rate card program
                                    '(-1 if time period not defined).  This is used
                                    'to distribute the spots according to % defined
                                    'with each time period (% are normalized to the
                                    'smallest percent. i.e. 20%, 20%, 60% => 1.0, 1.0, 3.0)
'Dim fmRdfPctBase(1 To 7) As Single  'see comment above
Dim fmRdfPctBase(0 To 6) As Single  'see comment above
'Dim imRdfCnt(1 To 7) As Integer     'Count of spots within time period
Dim imRdfCnt(0 To 6) As Integer     'Count of spots within time period
Dim lmEarliestAllowedDate As Long   'set to largest of Now+1 Or Earliest LCF or Last Log Date + 1
Dim lmLastLogDate As Long
'Dim lmCTBStartTime(1 To 49) As Long  'Allowed times if time buy
'Dim lmCTBEndTime(1 To 49) As Long
'Dim lmPTBStartTime(1 To 49) As Long  'Allowed times if time buy
'Dim lmPTBEndTime(1 To 49) As Long
'Dim lmCResvStartTime(1 To 49) As Long  'Allowed times if time buy
'Dim lmCResvEndTime(1 To 49) As Long
Dim lmCTBStartTime(0 To 48) As Long  'Allowed times if time buy
Dim lmCTBEndTime(0 To 48) As Long
Dim lmPTBStartTime(0 To 48) As Long  'Allowed times if time buy
Dim lmPTBEndTime(0 To 48) As Long
Dim lmCResvStartTime(0 To 48) As Long  'Allowed times if time buy
Dim lmCResvEndTime(0 To 48) As Long
'Spot adjustment for virtual vehicle
Dim imVirtVehSpotAdj As Integer
'Separation length information
'Current line
Dim lmCSepLength As Long            'Separation length
Dim imCAdfCodeSLen As Integer       'Advertiser code for valid separtion length
Dim lmCStartDateSLen As Long        'Valid start date of length (start date encompasses sch date)
Dim lmCEndDateSLen As Long          'Valid end date of length (end date that encompasses sch date)
Dim lmCChfCode As Long              'Contract code
Dim imCLineNo As Integer            'Line Number
Dim imCVehComp As Integer           'Vehicle code for gGetLineSchParameters
Dim imBkQH As Integer               'Number of booking quarter hours
Dim imPriceLevel As Integer
'Preempted spot
Dim lmPSepLength As Long            'Separation length
Dim imPAdfCodeSLen As Integer       'Advertiser code for valid separtion length
Dim lmPStartDateSLen As Long        'Valid start date of length
Dim lmPEndDateSLen As Long          'Valid end date of length
Dim lmPChfCode As Long              'Contract code
Dim imPLineNo As Integer            'Line Number
Dim imPVehComp As Integer           'Vehicle code for gGetLineSchParameters
'Statistic buckets
'Line being scheduled statistics
'Dim imCHour(1 To 24) As Integer     'Hour count (Index 1 for 12m-1a; Index 2 for 1a-2a;...)
'Dim imCDay(1 To 7) As Integer       'Day count (Index 1 for monday; Index 2 for tuesday;..)
'Dim imCQH(1 To 4) As Integer        'Quarter hour count (Index 1 for 0min to 15min; Index 2 for 15min to 30min;..)
Dim imCHour(0 To 23) As Integer     'Hour count (Index 1 for 12m-1a; Index 2 for 1a-2a;...)
Dim imCDay(0 To 6) As Integer       'Day count (Index 1 for monday; Index 2 for tuesday;..)
Dim imCQH(0 To 3) As Integer        'Quarter hour count (Index 1 for 0min to 15min; Index 2 for 15min to 30min;..)
'Preempt spot statistics
'Dim imPHour(1 To 24) As Integer     'Hour count
'Dim imPDay(1 To 7) As Integer       'Day count
'Dim imPQH(1 To 4) As Integer        'Quarter hour count
Dim imPHour(0 To 23) As Integer     'Hour count
Dim imPDay(0 To 6) As Integer       'Day count
Dim imPQH(0 To 3) As Integer        'Quarter hour count
'Actual for the day or week be processed- this will be a subset from
'imC---- or imP----
'Dim imCAHour(1 To 24) As Integer    'Hour count (Index 1 for 12m-1a; Index 2 for 1a-2a;...)
'Dim imCADay(1 To 7) As Integer      'Day count (Index 1 for monday; Index 2 for tuesday;..)
'Dim imCAQH(1 To 4) As Integer       'Quarter hour count (Index 1 for 0min to 15min; Index 2 for 15min to 30min;..)
'Dim imPAHour(1 To 24) As Integer    'Hour count (Index 1 for 12m-1a; Index 2 for 1a-2a;...)
'Dim imPADay(1 To 7) As Integer      'Day count (Index 1 for monday; Index 2 for tuesday;..)
'Dim imPAQH(1 To 4) As Integer       'Quarter hour count (Index 1 for 0min to 15min; Index 2 for 15min to 30min;..)
'Dim imSkip(1 To 24, 1 To 4, 0 To 6) As Integer  '-1=Skip all test;0=All test;
'                                    'Bit 0=Skip insert;
'                                    'Bit 1=Skip move;
'                                    'Bit 2=Skip competitive pack;
'                                    'Bit 3=Skip Preempt
Dim imCAHour(0 To 23) As Integer    'Hour count (Index 1 for 12m-1a; Index 2 for 1a-2a;...)
Dim imCADay(0 To 6) As Integer      'Day count (Index 1 for monday; Index 2 for tuesday;..)
Dim imCAQH(0 To 3) As Integer       'Quarter hour count (Index 1 for 0min to 15min; Index 2 for 15min to 30min;..)
Dim imPAHour(0 To 23) As Integer    'Hour count (Index 1 for 12m-1a; Index 2 for 1a-2a;...)
Dim imPADay(0 To 6) As Integer      'Day count (Index 1 for monday; Index 2 for tuesday;..)
Dim imPAQH(0 To 3) As Integer       'Quarter hour count (Index 1 for 0min to 15min; Index 2 for 15min to 30min;..)
Dim imSkip(0 To 23, 0 To 3, 0 To 6) As Integer  '-1=Skip all test;0=All test;
                                    'Bit 0=Skip insert;
                                    'Bit 1=Skip move;
                                    'Bit 2=Skip competitive pack;
                                    'Bit 3=Skip Preempt
Dim imMajor() As Integer      'Major sort indicies (either imSHour; imSDay or imSQH)
Dim imMiddle() As Integer     'Middle sort indicies (either imSHour; imSDay or imSQH)
Dim imMinor() As Integer      'Minor sort indicies (either imSHour; imSDay or imSQH)
'Dim imSHour() As Integer  'Sorted indicies (1 thru 24) into ilHour. ilHour contains the counts
Dim imSHour() As Integer  'Sorted indicies (0 thru 23) into ilHour. ilHour contains the counts
'Dim imSDay() As Integer   'Sorted indicies (1 thru 7) into ilDay.  ilDay contains the counts
Dim imSDay() As Integer   'Sorted indicies (0 thru 6) into ilDay.  ilDay contains the counts
'Dim imSQH() As Integer    'Sorted indices (1 thru 4) into ilQH.  ilQH contains the counts
Dim imSQH() As Integer    'Sorted indices (0 thru 3) into ilQH.  ilQH contains the counts
'Dim imHourIndex As Integer  'Hour to be processed (1 thru 24)
Dim imHourIndex As Integer  'Hour to be processed (0 thru 23)
Dim imDayIndex As Integer   'Day to be processed (0 thru 6)
Dim lmMondayDate As Long    'Monday of week that spot is being scheduled within
                            '(actual date = lmMondayDate+imDayIndex)
'Dim imQHIndex As Integer    'Quarter hour to be processed (1 thru 4)
Dim imQHIndex As Integer    'Quarter hour to be processed (0 thru 3)
Dim imAvailSubRec() As Integer    'Index values for avails to be checked within Ssd
                                        'for imHourIndex, imQHIndex
'Test to be performed at each iternation ( using the count instead of ReDim)
Dim imACount As Integer     'Number of "A" specified above (each iternation with minor)
Dim imBCount As Integer     'Number of "B" specified above (each time count changes with minor)
Dim imCCount As Integer     'Number of "B" specified above (Number of test a minor cycle)
Dim imDCount As Integer     'Number of "C" specified above (Number of test a minor cycle)
Dim imECount As Integer     'Number of "D" specified above (Number of test a minor cycle)
'Dim imAMode(1 To 4) As Integer  '0=Insert; 1=Move; 2=Compact; 3=Preempt
'Dim imBMode(1 To 4) As Integer  '0=Insert; 1=Move; 2=Compact; 3=Preempt
'Dim imCMode(1 To 4) As Integer  '0=Insert; 1=Move; 2=Compact; 3=Preempt
'Dim imDMode(1 To 4) As Integer  '0=Insert; 1=Move; 2=Compact; 3=Preempt
'Dim imEMode(1 To 4) As Integer  '0=Insert; 1=Move; 2=Compact; 3=Preempt
Dim imAMode(0 To 3) As Integer  '0=Insert; 1=Move; 2=Compact; 3=Preempt
Dim imBMode(0 To 3) As Integer  '0=Insert; 1=Move; 2=Compact; 3=Preempt
Dim imCMode(0 To 3) As Integer  '0=Insert; 1=Move; 2=Compact; 3=Preempt
Dim imDMode(0 To 3) As Integer  '0=Insert; 1=Move; 2=Compact; 3=Preempt
Dim imEMode(0 To 3) As Integer  '0=Insert; 1=Move; 2=Compact; 3=Preempt
Dim tmVcf0() As VCF
Dim tmVcf6() As VCF
Dim tmVcf7() As VCF
Dim lmClearSdfCode() As Long    'Used in mRemoveCrf
Type SORTRESCH
    sKey As String * 26 'Contract #, Line #
    lSdfCode As Long
End Type
Dim tmSortResch() As SORTRESCH
Dim tmSdfExtSort() As SDFEXTSORT
Dim tmSdfExt() As SDFEXT
'tmPreferredInfo used to know if spot is to use preferred days/times when svheduling into a new week
'set in mBalanceSpots
Type PREFERREDINFO
    lSDate As Long
    lEDate As Long
    iDays(0 To 6) As Integer
    lSTime As Long
    lETime As Long
    iNoPrefSpots As Integer
End Type
Dim tmPreferredInfo() As PREFERREDINFO
Type SCHVEHINFO
    iVefCode As Integer
    iVirtSpotAdj As Integer
    iGameNo As Integer
    iGameIndex As Integer
End Type
Dim tmCSchVehInfo() As SCHVEHINFO
Dim tmPSchVehInfo() As SCHVEHINFO

'Region Area
Dim tmRaf As RAF            'RAF record image
Dim tmRafSrchKey As LONGKEY0  'RAF key record image
Dim hmRaf As Integer        'RAF Handle
Dim imRafRecLen As Integer      'RAF record length

'Split Entity
Dim tmSef As SEF            'SEF record image
Dim tmSefSrchKey1 As SEFKEY1  'SEF key record image
Dim hmSef As Integer        'SEF Handle
Dim imSefRecLen As Integer      'SEF record length

Dim imRafPass As Integer    '0=Look for other region buys to link with; 1=look for any open avail
Dim lmRafCode As Long
Dim smClfInclExcl As String
Dim tmStationsClf() As INTKEY0

Dim tmAtt As ATT
Dim imAttRecLen As Integer
Dim tmAttSrchKey2 As INTKEY0     'ATT key 1 image

Type LOCKCNTR
    lCntrNo As Long
    lLockRecCode As Long
End Type
Public tgLockCntr() As LOCKCNTR

'---------------------------------
'Megaphone API
Dim hmMnf As Integer                            'mnf file handle
Dim imMnfRecLen As Integer
Dim tmMnf As MNF
Dim tmMnfSrchKey As INTKEY0                     'MNF key record
Public igMegaphoneAvfCode As Integer            'Must be <> 0
Public sgMegaphoneOrganizationID As String      'Required
Public sgMegaphoneRootURL As String             'Required
Public sgMegaphonePassword As String            'Required
Public sgMegaphoneTimezone As String            'E=Eastern, C=Central, M=Mountain, P=Pacific, A=Alaska, H=Hawaiian A and H not currently allowed
Dim tmHttpRequestHeaders() As HttpRequestHeader 'If any header(s) need to be sent in the API request
Public Const grdStatus_DigitalCntr_Col = 0      'Status grid columns: Is this a Digital Contract
Public Const grdStatus_LineDetail_Col = 1       'Status grid columns: This holds details like 1:Added, 2:Updated, 3:Deleted
Public Const grdStatus_CHFCode_Col = 2          'Status grid columns: chf Code
Public Const grdStatus_Advertiser_Col = 3       'Status grid columns: Advertiser Name
Public Const grdStatus_CntrNo_Col = 4           'Status grid columns: Contract Number
Public Const grdStatus_Status_Col = 5           'Status grid columns: Status
Public Const GridColor_White = 0                'Status grid colors
Public Const GridColor_Blue = 1                 'Status grid colors
Public Const GridColor_Green = 2                'Status grid colors
Public Const GridColor_Red = 3                  'Status grid colors
Public sgCntrSchStatus As String                'Current status, to be shown in the status grid
Public sgCntrLineDetail As String               'Current Contract Line details
Public bgMegaphoneContract As Boolean           'If this was a Megaphone API Contract, we'll want to know so we can Email the results for the contract(s)
Public bgCntrSchError As Boolean                'If a Scheduling Error occured
Public lgCntrSchGridRow As Long                 'Which Row is being processed
Public sgAPIActivityLog As String               'buffer messages, when an Error occurs we can Log the enitre history of the API transaction
Const FunctionResult_NA = 0                     'API Function result values
Const FunctionResult_Success = 1                'API Function result values
Const FunctionResult_Failure = 2                'API Function result values
Dim smAPIContract As String                     'Contract Number returned from API (Vendor Contract ID)
Dim smScheduleException As String               'If Scheduled with a API Exception

'*******************************************************
'*                                                     *
'*      Procedure Name:gCloseSchFiles                  *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Close files used for scheduling *
'*                     contracts                       *
'*                                                     *
'*******************************************************
Sub gCloseSchFiles()
    Dim ilRet As Integer

    lgOpenSchFileCount = lgOpenSchFileCount - 1
    If lgOpenSchFileCount <> 0 Then
        If lgOpenSchFileCount < 0 Then
            lgOpenSchFileCount = 0
        End If
        Exit Sub
    End If
    Erase tmClfExt
    Erase lmPLnRecPos
    Erase smLnSchStatus
    Erase tmCCgf
    Erase tmPCgf
    Erase tmCCff
    Erase tmPCff
    Erase imMajor
    Erase imMiddle
    Erase imMinor
    Erase imSHour
    Erase imSDay
    Erase imSQH
    Erase imAvailSubRec
    Erase tmVcf0
    Erase tmVcf6
    Erase tmVcf7
    Erase lmClearSdfCode
    Erase tmPreferredInfo
    Erase tmVehLock
    Erase tmCSbf
    Erase tmPSbf
    Erase tmCMsf
    Erase tmPMsf
'    ilRet = btrClose(hmDsf)
'    btrDestroy hmDsf
    ilRet = btrClose(hmSxf)
    btrDestroy hmSxf
    ilRet = btrClose(hmRlf)
    btrDestroy hmRlf
    ilRet = btrClose(hmCrf)
    btrDestroy hmCrf
    ilRet = btrClose(hmStf)
    btrDestroy hmStf
    If hmMtf <> -1 Then
        ilRet = btrClose(hmMtf)
        btrDestroy hmMtf
    End If
    If ((Asc(tgSpf.sUsingFeatures2) And SPLITNETWORKS) = SPLITNETWORKS) Then
        ilRet = btrClose(hmRaf)
        btrDestroy hmRaf
        ilRet = btrClose(hmSef)
        btrDestroy hmSef
    End If
    If tgSpf.sSystemType = "R" Then
        ilRet = btrClose(hmFpf)
        btrDestroy hmFpf
        ilRet = btrClose(hmFsf)
        btrDestroy hmFsf
        ilRet = btrClose(hmFnf)
        btrDestroy hmFnf
    End If
    ilRet = btrClose(hmPrf)
    btrDestroy hmPrf
    ilRet = btrClose(hmPcf)
    btrDestroy hmPcf
    ilRet = btrClose(hmMsf)
    btrDestroy hmMsf
    ilRet = btrClose(hmSbf)
    btrDestroy hmSbf
    ilRet = btrClose(hmSmf)
    btrDestroy hmSmf
    ilRet = btrClose(hmSsf)
    btrDestroy hmSsf
    ilRet = btrClose(hmVsf)
    btrDestroy hmVsf
    ilRet = btrClose(hmVef)
    btrDestroy hmVef
    ilRet = btrClose(hmRdf)
    btrDestroy hmRdf
    ilRet = btrClose(hmSdf)
    btrDestroy hmSdf
    ilRet = btrClose(hmLcf)
    btrDestroy hmLcf
    ilRet = btrClose(hmVcf)
    btrDestroy hmVcf
    ilRet = btrClose(hmGsf)
    btrDestroy hmGsf
    btrDestroy hmGhf
    ilRet = btrClose(hmCgf)
    btrDestroy hmCgf
    ilRet = btrClose(hmCff)
    btrDestroy hmCff
    ilRet = btrClose(hmClf)
    btrDestroy hmClf
    ilRet = btrClose(hmCHF)
    btrDestroy hmCHF
    'Megaphone API
    ilRet = btrClose(hmMnf)
    btrDestroy hmMnf
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:gCntrSchdSpotChkUnSchd          *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Check if a scheduled contract   *
'*                     contains the correct number of  *
'*                     spots                           *
'* (Called by UnSchd.Frm-mUnSchd: Contract Balancing)  *
'*                                                     *
'*******************************************************
Function gCntrSchdSpotChkUnSchd(ilClf As Integer, ilCheckAll As Integer, ilCheckType As Integer, slStartDate As String, ilTotalAdded As Integer, ilTotalDeleted As Integer) As Integer
'
'   ilRet = gCntrSchdSpotChkUnSchd(ilClf, ilCheckAll, ilCheckType, slStartDate)
'   Where:
'       ilClf(I)- Index into tgClfSpot (which contains the line to be checked)
'                 tgCffSpot must contain the flights for the line
'                 tgChfSpot must contain contract header if ilCheckType = True
'       ilCheckAll(I)- Check all vehicles for spot of the line
'       ilCheckType(I)- Check contract type
'       slStartDate(I)- start date of check
    Dim ilRet As Integer
    Dim llStartDate As Long
    Dim slDate As String
    Dim slSDate As String
    Dim slEDate As String
    Dim slCffStartDate As String
    Dim slCffEndDate As String
    Dim slSdfDate As String
    Dim llCffStartDate As Long
    Dim llCffEndDate As Long
    Dim tlCff As CFF
    Dim llMonDate As Long
    Dim llSunDate As Long
    Dim llChkStartDate As Long
    Dim llChkEndDate As Long
    Dim ilCff As Integer
    Dim ilCffSpots As Integer
    Dim ilSdfSpots As Integer
    'Dim ilSdfIndex As Integer
    Dim llSdfIndex As Long
    Dim ilDay As Integer
    Dim ilSmfFound As Integer
    Dim slMissedDate As String
    Dim slMissedOkDate As String
    Dim llOkDate As Long
    Dim slSdfTime As String
    Dim llSDFTime As Long
    'Dim llStartTime(1 To 7) As Long
    'Dim llEndTime(1 To 7) As Long
    Dim ilTimeFound As Integer
    Dim ilLoop As Integer
    Dim ilRemoveNo As Integer
    Dim llEarliestCffDate As Long
    Dim llLatestCffDate As Long
    Dim tlRdfSrchKey As INTKEY0
    Dim ilCVsf As Integer
    Dim ilVefFound As Integer
    Dim ilVefCode As Integer
    Dim ilMforNFound As Integer
    Dim ilGameNo As Integer
    Dim ilOrigGameNo As Integer
    ReDim tmSdfExtSort(0 To 0) As SDFEXTSORT
    'ReDim tmSdfExt(1 To 1) As SDFEXT
    ReDim tmSdfExt(0 To 0) As SDFEXT
    mInitSchVar True
    If igRnd Then
        Randomize   'Remove this if same results are to be obtained
    End If
    ilTotalAdded = 0
    ilTotalDeleted = 0
    imCVefCode = tgClfSpot(ilClf).ClfRec.iVefCode

    tmCChf = tgChfSpot
    tmCClf = tgClfSpot(ilClf).ClfRec
    If (tmCClf.sType = "O") Or (tmCClf.sType = "A") Or (tmCClf.sType = "E") Then
        gCntrSchdSpotChkUnSchd = True
        Erase tmSdfExtSort
        Erase tmSdfExt
        Exit Function
    End If

    'Get tmCRdf
    tlRdfSrchKey.iCode = tmCClf.iRdfCode
    ilRet = btrGetEqual(hmRdf, tmCRdf, imRdfRecLen, tlRdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If ilRet <> BTRV_ERR_NONE Then
        gCntrSchdSpotChkUnSchd = False
        Erase tmSdfExtSort
        Erase tmSdfExt
        Exit Function
    End If
    'Obtain rate card times as normalized numbers (spot counts)
    mNorPCT tmCRdf
    'Obtain all scheduled spots
    llStartDate = gDateValue(slStartDate)
    'lbcSortCtrl.Clear
    'lbcSortCtrl.Tag = ""
    slSDate = ""    'Because of MG's prior to spots- obtain all spots gObtainPrevMonday(slStartDate)  'First flight start date might be within week- back up to monday
    slEDate = ""
    If ilCheckAll Then
        ilRet = gObtainCntrSpot(-1, False, tgClfSpot(ilClf).ClfRec.lChfCode, tgClfSpot(ilClf).ClfRec.iLine, "S", slSDate, slEDate, tmSdfExtSort(), tmSdfExt(), 0, False)
    Else
        ilRet = gObtainCntrSpot(CLng(tgClfSpot(ilClf).ClfRec.iVefCode), False, tgClfSpot(ilClf).ClfRec.lChfCode, tgClfSpot(ilClf).ClfRec.iLine, "S", slSDate, slEDate, tmSdfExtSort(), tmSdfExt(), 0, False)
    End If
    'Leave Fill, Open BB and Close BB spots
    For llSdfIndex = LBound(tmSdfExt) To UBound(tmSdfExt) - 1 Step 1
        If tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine Then
            If tmSdfExt(llSdfIndex).sSpotType = "X" Then
                tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
            ElseIf (tmSdfExt(llSdfIndex).sSpotType = "O") Or (tmSdfExt(llSdfIndex).sSpotType = "C") Then
                tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
            End If
        End If
    Next llSdfIndex
    tmVefSrchKey.iCode = tgClfSpot(ilClf).ClfRec.iVefCode
    ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
    If ilRet <> BTRV_ERR_NONE Then
        gCntrSchdSpotChkUnSchd = False
        Erase tmSdfExtSort
        Erase tmSdfExt
        Exit Function
    End If
    If tmVef.sType = "V" Then
        tmVsfSrchKey.lCode = tmVef.lVsfCode
        ilRet = btrGetEqual(hmVsf, tmCVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If ilRet <> BTRV_ERR_NONE Then
            gCntrSchdSpotChkUnSchd = False
            Erase tmSdfExtSort
            Erase tmSdfExt
            Exit Function
        End If
        'Store the virtual vehicle as the first vehicle
        For ilCVsf = UBound(tmCVsf.iFSCode) To LBound(tmCVsf.iFSCode) + 1 Step -1
            tmCVsf.iFSCode(ilCVsf) = tmCVsf.iFSCode(ilCVsf - 1)
            tmCVsf.iNoSpots(ilCVsf) = tmCVsf.iNoSpots(ilCVsf - 1)
        Next ilCVsf
        tmCVsf.iFSCode(LBound(tmCVsf.iFSCode)) = tgClfSpot(ilClf).ClfRec.iVefCode
        tmCVsf.iNoSpots(LBound(tmCVsf.iFSCode)) = 1
    Else
        For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
            tmCVsf.iFSCode(ilCVsf) = 0
        Next ilCVsf
        tmCVsf.iFSCode(LBound(tmCVsf.iFSCode)) = tgClfSpot(ilClf).ClfRec.iVefCode
        tmCVsf.iNoSpots(LBound(tmCVsf.iFSCode)) = 1
    End If
    'Check all missed spots times- if in error correct
    llEarliestCffDate = 0
    llLatestCffDate = 0
    ilGameNo = 0
    ilCff = tgClfSpot(ilClf).iFirstCff
    Do While ilCff <> -1
        tlCff = tgCffSpot(ilCff).CffRec
        gUnpackDate tgCffSpot(ilCff).CffRec.iStartDate(0), tgCffSpot(ilCff).CffRec.iStartDate(1), slCffStartDate
        gUnpackDate tgCffSpot(ilCff).CffRec.iEndDate(0), tgCffSpot(ilCff).CffRec.iEndDate(1), slCffEndDate
        llCffStartDate = gDateValue(slCffStartDate)
        llCffEndDate = gDateValue(slCffEndDate)
        If llCffEndDate < llCffStartDate Then
            Exit Do
        End If
        If llEarliestCffDate = 0 Then
            llEarliestCffDate = llCffStartDate
            llLatestCffDate = llCffEndDate
        Else
            If llCffStartDate < llEarliestCffDate Then
                llEarliestCffDate = llCffStartDate
            End If
            If llCffEndDate > llLatestCffDate Then
                llLatestCffDate = llCffEndDate
            End If
        End If
        slDate = Format$(llCffStartDate, "m/d/yy")
        slDate = gObtainPrevMonday(slDate)  'First flight start date might be within week- back up to monday
        llMonDate = gDateValue(slDate)
        slDate = gObtainNextSunday(slDate)
        llSunDate = gDateValue(slDate)
        If llSunDate > llCffEndDate Then
            llSunDate = llCffEndDate
        End If
        Do  'Current line week loop
            If llSunDate >= llStartDate Then
                'If (tgCffSpot(ilCff).CffRec.iSpotsWk <> 0) Or (tgCffSpot(ilCff).CffRec.iXSpotsWk <> 0) Then  'Weekly buy
                If (tgCffSpot(ilCff).CffRec.sDyWk <> "D") Then  'Weekly buy
                    ilCffSpots = tgCffSpot(ilCff).CffRec.iSpotsWk + tgCffSpot(ilCff).CffRec.iXSpotsWk
                    llChkStartDate = llMonDate
                    llChkEndDate = llSunDate
                    'set missed date to first valid date
                    slMissedDate = ""
                    For ilDay = 0 To 6 Step 1
                        If tgCffSpot(ilCff).CffRec.iDay(ilDay) <> 0 Then
                            If (llMonDate + ilDay >= llCffStartDate) And (llMonDate + ilDay <= llCffEndDate) Then
                                slMissedDate = Format$(llMonDate + ilDay, "m/d/yy")
                                Exit For
                            End If
                        End If
                    Next ilDay
                    If slMissedDate = "" Then
                        For ilDay = 0 To 6 Step 1
                            If (tgCffSpot(ilCff).CffRec.sXDay(ilDay) <> "0") And (tgCffSpot(ilCff).CffRec.sXDay(ilDay) <> " ") Then
                                If (llMonDate + ilDay >= llCffStartDate) And (llMonDate + ilDay <= llCffEndDate) Then
                                    slMissedDate = Format$(llMonDate + ilDay, "m/d/yy")
                                    Exit For
                                End If
                            End If
                        Next ilDay
                    End If
                    'If no days defined- bypass creating spots
                    'If slMissedDate = "" Then
                    '    slMissedDate = Format$(llMonDate, "m/d/yy")
                    'End If
                    ilGameNo = tgCffSpot(ilCff).iGameNo
                    '6/4/16: Replaced GoSub
                    'GoSub lObtainCount
                    If Not mObtainCount(ilClf, ilCff, ilGameNo, ilTotalDeleted, ilRemoveNo, llChkStartDate, llChkEndDate, ilCffSpots, ilTotalAdded, tlCff, ilCheckType, slMissedDate) Then
                        gCntrSchdSpotChkUnSchd = False
                        Exit Function
                    End If
                Else    'Daily buy
                    ilCffSpots = 0
                    For ilDay = 0 To 6 Step 1
                        If llMonDate + ilDay >= llStartDate Then
                            If (llMonDate + ilDay >= llCffStartDate) And (llMonDate + ilDay <= llCffEndDate) Then
                                ilCffSpots = tgCffSpot(ilCff).CffRec.iDay(ilDay)
                                llChkStartDate = llMonDate + ilDay
                                llChkEndDate = llMonDate + ilDay
                                slMissedDate = Format$(llMonDate + ilDay, "m/d/yy")
                                ilGameNo = tgCffSpot(ilCff).iGameNo
                                '6/4/16: Replaced GoSub
                                'GoSub lObtainCount
                                If Not mObtainCount(ilClf, ilCff, ilGameNo, ilTotalDeleted, ilRemoveNo, llChkStartDate, llChkEndDate, ilCffSpots, ilTotalAdded, tlCff, ilCheckType, slMissedDate) Then
                                    gCntrSchdSpotChkUnSchd = False
                                    Exit Function
                                End If
                            End If
                        End If
                    Next ilDay
                End If
            End If
            llMonDate = llSunDate + 1
            slDate = Format$(llMonDate, "m/d/yy")
            slDate = gObtainNextSunday(slDate)
            llSunDate = gDateValue(slDate)
            If llSunDate > llCffEndDate Then
                llSunDate = llCffEndDate
            End If
        Loop While llMonDate <= llCffEndDate
        ilCff = tgCffSpot(ilCff).iNextCff
    Loop
    'For ilSdfIndex = LBound(tmSdfExt) To UBound(tmSdfExt) - 1 Step 1
    '    If tmSdfExt(ilSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine Then
    '        If tmSdfExt(ilSdfIndex).sSpotType = "X" Then
     '           tmSdfExt(ilSdfIndex).iLineNo = -1   'Spot not counted again
    '        End If
    '    End If
    'Next ilSdfIndex
    'Remove any spot not referenced (iLine set to -1 when referenced)
    'First set spot as reference if in area not checked
    If llEarliestCffDate > 0 Then
        For llSdfIndex = LBound(tmSdfExt) To UBound(tmSdfExt) - 1 Step 1
            If tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine Then
                gUnpackDate tmSdfExt(llSdfIndex).iDate(0), tmSdfExt(llSdfIndex).iDate(1), slDate
                'If outside line limits and not account for- delete in next area of code
                If (tmSdfExt(llSdfIndex).sSchStatus = "O") Or (tmSdfExt(llSdfIndex).sSchStatus = "G") Then
                    '2/21/11: Replace GetDirect with GetEqual
                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If gFindSmf(tmSdf, hmSmf, tmSmf) Then
                        For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
                            If tmCVsf.iFSCode(ilCVsf) > 0 Then
                                If tmSmf.iOrigSchVef = tmCVsf.iFSCode(ilCVsf) Then
                                    gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                    Exit For
                                End If
                            End If
                        Next ilCVsf
                    End If
                End If
                If (gDateValue(slDate) <= llLatestCffDate) Then
                    If gDateValue(slDate) < llStartDate Then    'Retain spot as it is in area not checked
                        tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
                    End If
                End If
            End If
        Next llSdfIndex
    End If
    For llSdfIndex = LBound(tmSdfExt) To UBound(tmSdfExt) - 1 Step 1
        If (tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine) Then
            imCVefCode = tmSdfExt(llSdfIndex).iVefCode
            gUnpackDate tmSdfExt(llSdfIndex).iDate(0), tmSdfExt(llSdfIndex).iDate(1), slDate
            If Not mGetVefDates(imCVefCode, imCVpfIndex) Then
                gCntrSchdSpotChkUnSchd = False
                Erase tmSdfExtSort
                Erase tmSdfExt
                Exit Function
            End If
            ilRet = mDeleteASpot(tmSdfExt(llSdfIndex).lCode)
            If Not ilRet Then
                gCntrSchdSpotChkUnSchd = False
                Erase tmSdfExtSort
                Erase tmSdfExt
                Exit Function
            End If
            '2/21/11: Replace GetDirect with GetEqual
            'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
            tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
            ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                ilTotalDeleted = ilTotalDeleted + 1
                tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
            End If
        End If
    Next llSdfIndex
    gCntrSchdSpotChkUnSchd = True
    Erase tmSdfExtSort
    Erase tmSdfExt
    Exit Function
'lObtainCount:
'    'Scan scheduled spots- checking if from this date span
'    'Remove any spot within wrong vehicle
'    ilMforNFound = False
'    For llSdfIndex = LBound(tmSdfExt) To UBound(tmSdfExt) - 1 Step 1
'        ilOrigGameNo = tmSdfExt(llSdfIndex).iGameNo
'        If (tmSdfExt(llSdfIndex).sSchStatus = "O") Or (tmSdfExt(llSdfIndex).sSchStatus = "G") Then
'            '2/21/11: Replace GetDirect with GetEqual
'            'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
'            tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
'            ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'            If gFindSmf(tmSdf, hmSmf, tmSmf) Then
'                If (tmSmf.lMtfCode > 0) And (lgMtfNoRecs > 0) Then
'                    tmSdfExt(llSdfIndex).iLineNo = -1
'                    ilMforNFound = True
'                End If
'                ilOrigGameNo = tmSmf.iGameNo
'            End If
'        End If
'        If (tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine) And (ilOrigGameNo = ilGameNo) Then
'            ilVefFound = False
'            For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
'                If tmCVsf.iFSCode(ilCVsf) > 0 Then
'                    If tmSdfExt(llSdfIndex).iVefCode = tmCVsf.iFSCode(ilCVsf) Then
'                        ilVefFound = True
'                        Exit For
'                    End If
'                End If
'            Next ilCVsf
'            If Not ilVefFound Then
'                If (tmSdfExt(llSdfIndex).sSchStatus = "O") Or (tmSdfExt(llSdfIndex).sSchStatus = "G") Then
'                    '2/21/11: Replace GetDirect with GetEqual
'                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
'                    tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
'                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'                    If gFindSmf(tmSdf, hmSmf, tmSmf) Then
'                        For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
'                            If tmCVsf.iFSCode(ilCVsf) > 0 Then
'                                If tmSmf.iOrigSchVef = tmCVsf.iFSCode(ilCVsf) Then
'                                    ilVefFound = True
'                                    Exit For
'                                End If
'                            End If
'                        Next ilCVsf
'                    End If
'                End If
'                If Not ilVefFound Then
'                    imCVefCode = tmSdfExt(llSdfIndex).iVefCode
'                    If Not mGetVefDates(imCVefCode, imCVpfIndex) Then
'                        gCntrSchdSpotChkUnSchd = False
'                        Erase tmSdfExtSort
'                        Erase tmSdfExt
'                        Exit Function
'                    End If
'                    'Remove spot
'                    ilRet = mDeleteASpot(tmSdfExt(llSdfIndex).lCode)
'                    If Not ilRet Then
'                        gCntrSchdSpotChkUnSchd = False
'                        Erase tmSdfExtSort
'                        Erase tmSdfExt
'                        Exit Function
'                    End If
'                    '2/21/11: Replace GetDirect with GetEqual
'                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
'                    tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
'                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'                    If ilRet <> BTRV_ERR_NONE Then
'                        ilTotalDeleted = ilTotalDeleted + 1
'                        tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
'                    End If
'                Else
'                    'Check Day
'                    '2/21/11: Replace GetDirect with GetEqual
'                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
'                    tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
'                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'                    'If Not mCheckSchDay(tmSdf, tmCClf) Then
'                    If Not mCheckSchDay(tmSdf, tlCff) Then
'                        ilRet = mDeleteASpot(tmSdfExt(llSdfIndex).lCode)
'                        If Not ilRet Then
'                            gCntrSchdSpotChkUnSchd = False
'                            Erase tmSdfExtSort
'                            Erase tmSdfExt
'                            Exit Function
'                        End If
'                        '2/21/11: Replace GetDirect with GetEqual
'                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
'                        tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
'                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'                        If ilRet <> BTRV_ERR_NONE Then
'                            ilTotalDeleted = ilTotalDeleted + 1
'                            tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
'                        End If
'                    End If
'                End If
'            End If
'        End If
'    Next llSdfIndex
'    'Check spots within correct vehicles
'    For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
'        If tmCVsf.iFSCode(ilCVsf) > 0 Then
'            imCVefCode = tmCVsf.iFSCode(ilCVsf)
'            If Not mGetVefDates(imCVefCode, imCVpfIndex) Then
'                gCntrSchdSpotChkUnSchd = False
'                Erase tmSdfExtSort
'                Erase tmSdfExt
'                Exit Function
'            End If
'            ilSdfSpots = 0
'            For llSdfIndex = LBound(tmSdfExt) To UBound(tmSdfExt) - 1 Step 1
'                ilVefCode = tmSdfExt(llSdfIndex).iVefCode
'                ilOrigGameNo = tmSdfExt(llSdfIndex).iGameNo
'                'If (tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine) And (tmSdfExt(llSdfIndex).iGameNo = ilGameNo) Then
'                If (tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine) Then
'                    If (tmSdfExt(llSdfIndex).sSchStatus = "O") Or (tmSdfExt(llSdfIndex).sSchStatus = "G") Then
'                        '2/21/11: Replace GetDirect with GetEqual
'                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
'                        tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
'                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'                        If gFindSmf(tmSdf, hmSmf, tmSmf) Then
'                            ilOrigGameNo = tmSmf.iGameNo
'                            If ilOrigGameNo = ilGameNo Then
'                                ilVefCode = tmSmf.iOrigSchVef
'                            End If
'                        End If
'                    End If
'                End If
'                'If (tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine) And (ilVefCode = tmCVsf.iFSCode(ilCVsf)) And (tmSdfExt(llSdfIndex).iGameNo = ilGameNo) Then
'                If (tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine) And (ilVefCode = tmCVsf.iFSCode(ilCVsf)) And (ilOrigGameNo = ilGameNo) Then
'                    If tmSdfExt(llSdfIndex).iLen <> tgClfSpot(ilClf).ClfRec.iLen Then
'                        'Remove spot
'                        ilRet = mDeleteASpot(tmSdfExt(llSdfIndex).lCode)
'                        If Not ilRet Then
'                            gCntrSchdSpotChkUnSchd = False
'                            Erase tmSdfExtSort
'                            Erase tmSdfExt
'                            Exit Function
'                        End If
'                        '2/21/11: Replace GetDirect with GetEqual
'                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
'                        tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
'                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'                        If ilRet <> BTRV_ERR_NONE Then
'                            ilTotalDeleted = ilTotalDeleted + 1
'                            tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
'                        End If
'                    'ElseIf (ilCheckType) And (tmSdfExt(ilSdfIndex).sSpotType <> tmCChf.sType) And ((tmSdfExt(ilSdfIndex).sSpotType = "M") Or (tmSdfExt(ilSdfIndex).sSpotType = "S") Or (tmSdfExt(ilSdfIndex).sSpotType = "T") Or (tmSdfExt(ilSdfIndex).sSpotType = "Q") Or (tmCChf.sType = "M") Or (tmCChf.sType = "S") Or (tmCChf.sType = "T") Or (tmCChf.sType = "Q")) Then
'                    'ElseIf (ilCheckType) And (tmSdfExt(ilSdfIndex).sSpotType <> tmCChf.sType) And ((tmSdfExt(ilSdfIndex).sSpotType = "M") Or (tmSdfExt(ilSdfIndex).sSpotType = "S") Or (tmSdfExt(ilSdfIndex).sSpotType = "T") Or (tmSdfExt(ilSdfIndex).sSpotType = "Q") Or ((tmCChf.sType = "M") And (tgSpf.sSchdPromo <> "Y")) Or ((tmCChf.sType = "S") And (tgSpf.sSchdPSA <> "Y")) Or ((tmCChf.sType = "T") And (tgSpf.sSchdRemnant <> "Y")) Or (tmCChf.sType = "Q")) Then
'                    ElseIf (ilCheckType) And (tmSdfExt(llSdfIndex).sSpotType <> tmCChf.sType) And (((tmSdfExt(llSdfIndex).sSpotType = "M") And (tgSpf.sSchdPromo <> "Y")) Or ((tmSdfExt(llSdfIndex).sSpotType = "S") And (tgSpf.sSchdPSA <> "Y")) Or ((tmSdfExt(llSdfIndex).sSpotType = "T") And (tgSpf.sSchdRemnant <> "Y")) Or (tmSdfExt(llSdfIndex).sSpotType = "Q") Or ((tmCChf.sType = "M") And (tgSpf.sSchdPromo <> "Y")) Or ((tmCChf.sType = "S") And (tgSpf.sSchdPSA <> "Y")) Or ((tmCChf.sType = "T") And (tgSpf.sSchdRemnant <> "Y")) Or (tmCChf.sType = "Q")) Then
'                        'Remove spot
'                        ilRet = mDeleteASpot(tmSdfExt(llSdfIndex).lCode)
'                        If Not ilRet Then
'                            gCntrSchdSpotChkUnSchd = False
'                            Erase tmSdfExtSort
'                            Erase tmSdfExt
'                            Exit Function
'                        End If
'                        '2/21/11: Replace GetDirect with GetEqual
'                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
'                        tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
'                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'                        If ilRet <> BTRV_ERR_NONE Then
'                            ilTotalDeleted = ilTotalDeleted + 1
'                            tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
'                        End If
'                    ElseIf (tmSdfExt(llSdfIndex).sSchStatus = "O") Or (tmSdfExt(llSdfIndex).sSchStatus = "G") Then
'                        'Obtain original dates
'                        ilSmfFound = False
'                        '2/21/11: Replace GetDirect with GetEqual
'                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
'                        tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
'                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'                        If ilRet <> BTRV_ERR_NONE Then
'                            gCntrSchdSpotChkUnSchd = False
'                            Erase tmSdfExtSort
'                            Erase tmSdfExt
'                            Exit Function
'                        End If
'                        If gFindSmf(tmSdf, hmSmf, tmSmf) Then
'                            ilSmfFound = True
'                            gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slSdfDate
'                            If (gDateValue(slSdfDate) >= llChkStartDate) And (gDateValue(slSdfDate) <= llChkEndDate) Then
'                                If tmSdfExt(llSdfIndex).sSpotType <> "X" Then
'                                    ilSdfSpots = ilSdfSpots + 1
'                                End If
'                                tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
'                            End If
'                        End If
'                    Else
'                        gUnpackDate tmSdfExt(llSdfIndex).iDate(0), tmSdfExt(llSdfIndex).iDate(1), slSdfDate
'                        If (gDateValue(slSdfDate) >= llChkStartDate) And (gDateValue(slSdfDate) <= llChkEndDate) Then
'                            If tmSdfExt(llSdfIndex).sSpotType <> "X" Then
'                                ilSdfSpots = ilSdfSpots + 1
'                            End If
'                            tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
'                            If (tmSmf.sSchStatus <> "O") And (tmSmf.sSchStatus <> "G") And (tmSmf.sSchStatus <> "S") Then
'                                'If missed spot, check its time
'                                mGetLegalTimes slSdfDate, ilGameNo, llStartTime(), llEndTime()
'                                gUnpackTime tmSdfExt(llSdfIndex).iTime(0), tmSdfExt(llSdfIndex).iTime(1), "A", "1", slSdfTime
'                                llSdfTime = CLng(gTimeToCurrency(slSdfTime, False))
'                                'If (llSdfTime < llStartTime) Or (llSdfTime > llEndTime) Then
'                                ilTimeFound = False
'                                For ilLoop = LBound(llStartTime) To UBound(llStartTime) Step 1
'                                    If (llSdfTime >= llStartTime(ilLoop)) And (llSdfTime <= llEndTime(ilLoop)) Then
'                                        ilTimeFound = True
'                                        Exit For
'                                    End If
'                                Next ilLoop
'                                If Not ilTimeFound Then
'                                    Do
'                                        '2/21/11: Replace GetDirect with GetEqual
'                                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
'                                        tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
'                                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'                                        If ilRet <> BTRV_ERR_NONE Then
'                                            gCntrSchdSpotChkUnSchd = False
'                                            Erase tmSdfExtSort
'                                            Erase tmSdfExt
'                                            Exit Function
'                                        End If
'                                        'tmSRec = tmSdf
'                                        'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
'                                        'tmSdf = tmSRec
'                                        'If ilRet <> BTRV_ERR_NONE Then
'                                        '    gCntrSchdSpotChkUnSchd = False
'                                        '    Erase tmSdfExtSort
'                                        '    Erase tmSdfExt
'                                        '    Exit Function
'                                        'End If
'                                        slSdfTime = gCurrencyToTime(CCur(llStartTime(LBound(llStartTime))))
'                                        gPackTime slSdfTime, tmSdf.iTime(0), tmSdf.iTime(1)
'                                        tmSdf.sXCrossMidnight = "N"
'                                        'Leave setting as currently set, just updating time
'                                        'tmSdf.sWasMG = "N"
'                                        'tmSdf.sFromWorkArea = "N"
'                                        ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
'                                    Loop While ilRet = BTRV_ERR_CONFLICT
'                                    If ilRet <> BTRV_ERR_NONE Then
'                                        gCntrSchdSpotChkUnSchd = False
'                                        Erase tmSdfExtSort
'                                        Erase tmSdfExt
'                                        Exit Function
'                                    End If
'                                End If
'                            End If
'                        End If
'                    End If
'                End If
'            Next llSdfIndex
'            If Not ilMforNFound Then
'                If tmCVsf.iNoSpots(ilCVsf) * ilCffSpots < ilSdfSpots Then
'                    'Remove spots
'                    ilRemoveNo = ilSdfSpots - tmCVsf.iNoSpots(ilCVsf) * ilCffSpots
'                    ilRet = mDeleteSpots(tgClfSpot(ilClf).ClfRec.lChfCode, tgClfSpot(ilClf).ClfRec.iLine, 0, ilGameNo, llChkStartDate, llChkEndDate, ilRemoveNo, False, tmCChf.sCBSOrder)
'                    If Not ilRet Then
'                        gCntrSchdSpotChkUnSchd = False
'                        Erase tmSdfExtSort
'                        Erase tmSdfExt
'                        Exit Function
'                    End If
'                    ilTotalDeleted = ilTotalDeleted + ilSdfSpots - tmCVsf.iNoSpots(ilCVsf) * ilCffSpots - ilRemoveNo
'                ElseIf tmCVsf.iNoSpots(ilCVsf) * ilCffSpots > ilSdfSpots Then
'                    'Add spots
'                    If slMissedDate <> "" Then
'                        'If (tmCChf.sType <> "T") And (tmCChf.sType <> "Q") And (tmCChf.sType <> "S") And (tmCChf.sType <> "M") Then
'                        If ((tmCChf.sType <> "T") And (tmCChf.sType <> "Q") And (tmCChf.sType <> "S") And (tmCChf.sType <> "M")) Or ((tgSpf.sSchdPromo = "Y") And (tmCChf.sType = "M")) Or ((tgSpf.sSchdPSA = "Y") And (tmCChf.sType = "S")) Or ((tgSpf.sSchdRemnant = "Y") And (tmCChf.sType = "T")) Then
'                            ilTotalAdded = ilTotalAdded + tmCVsf.iNoSpots(ilCVsf) * ilCffSpots - ilSdfSpots
'                            llOkDate = gDateValue(slMissedDate)
'                            slMissedOkDate = mGetFirstLegalWkDate(hmLcf, "C", imCVefCode, llOkDate, tgCffSpot(ilCff).CffRec)
'                            ilRet = mMakeUnschSpot(tgCffSpot(ilCff).CffRec, slMissedOkDate, tmCVsf.iNoSpots(ilCVsf) * ilCffSpots - ilSdfSpots, ilGameNo)
'                            If Not ilRet Then
'                                gCntrSchdSpotChkUnSchd = False
'                                Erase tmSdfExtSort
'                                Erase tmSdfExt
'                                Exit Function
'                            End If
'                        End If
'                    End If
'                End If
'            End If
'        End If
'    Next ilCVsf
'    Return
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:gMGSchSpots                     *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Schedule specified spot as MG   *
'*                                                     *
'*******************************************************
Function gMGSchSpots(ilMakeSSF As Integer, slSchStatus As String, llSDFCode As Long, ilBkRdfCode As Integer, ilBkVefCode As Integer, llSchStartTime As Long, llSchEndTime As Long, ilInDays() As Integer) As Integer
'
'   gMGSchSpots(ilMakeSSF)
'   Where:
'       ilMakeSSF(I)- True:Check and make ssf if missing; False: bypass test
'       lgUnschRecPos contains the record position of all spots to be scheduled
'
    Dim ilRet As Integer
    Dim tlClfSrchKey As CLFKEY0
    Dim tlRdfSrchKey As INTKEY0
    Dim ilLoop As Integer
    Dim llLastCffDate As Long
    Dim slDate As String
    Dim llDate As Long
    Dim slLength As String
    Dim llLcfEarliestDate As Long
    Dim llLcfLatestDate As Long
    Dim llSundayDate As Long
    Dim ilLogDate0 As Integer
    Dim ilLogDate1 As Integer
    Dim llExtendDate As Long
    'Add for sort and speed
    Dim llPChfCode As Long
    Dim ilPLineNo As Integer
    Dim ilDay As Integer
    Dim ilSvMnfComp0 As Integer
    Dim ilSvMnfComp1 As Integer
    Dim ilVpfIndex As Integer
    mInitSchVar True
    If igRnd Then
        Randomize   'Remove this if same results are to be obtained
    End If
    'Obtain spot to be scheduled
    llPChfCode = 0
    ilPLineNo = 0
    tmCChf.lCode = 0
    If llSDFCode > 0 Then
        tmSdfSrchKey3.lCode = llSDFCode
        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If (ilRet = BTRV_ERR_NONE) And (tmSdf.sSchStatus = "M") Then
            'ilRet = btrGetPosition(hmSdf, lmSdfRecPos)
            If tmCChf.lCode <> tmSdf.lChfCode Then
                tmChfSrchKey.lCode = tmSdf.lChfCode
                ilRet = btrGetEqual(hmCHF, tmCChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
            Else
                ilRet = BTRV_ERR_NONE
            End If
            If ilRet = BTRV_ERR_NONE Then
                If (llPChfCode <> tmSdf.lChfCode) Or (ilPLineNo <> tmSdf.iLineNo) Then
                    tlClfSrchKey.lChfCode = tmCChf.lCode
                    tlClfSrchKey.iLine = tmSdf.iLineNo
                    tlClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
                    tlClfSrchKey.iPropVer = 32000 ' 0 show latest version
                    ilRet = btrGetGreaterOrEqual(hmClf, tmCClf, imClfRecLen, tlClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    Do While (ilRet = BTRV_ERR_NONE) And (tmCClf.lChfCode = tmCChf.lCode) And (tmCClf.iLine = tmSdf.iLineNo) And ((tmCClf.sSchStatus <> "M") And (tmCClf.sSchStatus <> "F"))
                        ilRet = btrGetNext(hmClf, tmCClf, imClfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                    Loop
                Else
                    ilRet = BTRV_ERR_NONE
                End If
                If (ilRet = BTRV_ERR_NONE) And (tmCClf.lChfCode = tmCChf.lCode) And (tmCClf.iLine = tmSdf.iLineNo) And ((tmCClf.sSchStatus = "M") Or (tmCClf.sSchStatus = "F")) Then
                    imCVefCode = ilBkVefCode
                    ilVpfIndex = gVpfFindIndex(imCVefCode)
                    'Get earliest allowed date
                    If Not mGetVefDates(imCVefCode, imCVpfIndex) Then
                        gMGSchSpots = False
                        Exit Function
                    End If
                    If ilMakeSSF Then
                        'Make sure SSF Created
                        gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llLastCffDate
                        slDate = Format$(llLastCffDate, "m/d/yy")
                        slDate = gObtainNextSunday(slDate)
                        llSundayDate = gDateValue(slDate)
                        llLcfEarliestDate = gGetEarliestLCFDate(hmLcf, "C", imCVefCode)
                        If (llLcfEarliestDate > 0) And (llSundayDate < llLcfEarliestDate) Then
                            For llDate = llSundayDate - 6 To llLcfEarliestDate - 1 Step 1
                                slDate = Format$(llDate, "m/d/yy")
                                gPackDate slDate, ilLogDate0, ilLogDate1
                                ilRet = gExtendTFN(hmLcf, hmSsf, hmSdf, hmSmf, "C", imCVefCode, ilLogDate0, ilLogDate1, False)
                                If Not ilRet Then
                                    gMGSchSpots = False
                                    Exit Function
                                End If
                            Next llDate
                        End If
                        llLcfLatestDate = gGetLatestLCFDate(hmLcf, "C", imCVefCode)
                        If (llLcfLatestDate > 0) Then
                            llExtendDate = llLcfLatestDate + 1
                        Else
                            llExtendDate = lmEarliestAllowedDate
                        End If
                        For llDate = llExtendDate To llSundayDate Step 1
                            slDate = Format$(llDate, "m/d/yy")
                            gPackDate slDate, ilLogDate0, ilLogDate1
                            ilRet = gExtendTFN(hmLcf, hmSsf, hmSdf, hmSmf, "C", imCVefCode, ilLogDate0, ilLogDate1, False)
                            If Not ilRet Then
                                gMGSchSpots = False
                                Exit Function
                            End If
                        Next llDate
                    End If
                    'Obtain competitive separation time
                    If tgVpf(imCVpfIndex).sSCompType = "T" Then
                        gUnpackLength tgVpf(imCVpfIndex).iSCompLen(0), tgVpf(imCVpfIndex).iSCompLen(1), "3", False, slLength
                        lmCompTime = CLng(gLengthToCurrency(slLength))
                    Else
                        lmCompTime = 0&
                    End If
                    If ilBkRdfCode <> -1 Then
                        tlRdfSrchKey.iCode = ilBkRdfCode    'tmCClf.iRdfCode
                        ilRet = btrGetEqual(hmRdf, tmPRdf, imRdfRecLen, tlRdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If (ilRet <> BTRV_ERR_NONE) Then
                            If ilVpfIndex >= 0 Then
                                If tgVpf(ilVpfIndex).sGMedium = "S" Then
                                    For ilLoop = LBound(tmPRdf.iStartTime, 2) To UBound(tmPRdf.iStartTime, 2) Step 1
                                        tmPRdf.iSpotPct(ilLoop) = 0
                                        If ilLoop <> UBound(tmPRdf.iStartTime, 2) Then
                                            tmPRdf.iStartTime(0, ilLoop) = 1
                                            tmPRdf.iStartTime(1, ilLoop) = 0
                                        Else
                                            gPackTime "12AM", tmPRdf.iStartTime(0, ilLoop), tmPRdf.iStartTime(1, ilLoop)
                                            gPackTime "12AM", tmPRdf.iEndTime(0, ilLoop), tmPRdf.iEndTime(1, ilLoop)
                                        End If
                                    Next ilLoop
                                    tmPRdf.sInOut = "N" 'Ignore In/Out rules
                                End If
                            End If
                        End If
                    Else
                        For ilLoop = LBound(tmPRdf.iStartTime, 2) To UBound(tmPRdf.iStartTime, 2) Step 1
                            tmPRdf.iSpotPct(ilLoop) = 0
                            If ilLoop <> UBound(tmPRdf.iStartTime, 2) Then
                                tmPRdf.iStartTime(0, ilLoop) = 1
                                tmPRdf.iStartTime(1, ilLoop) = 0
                            Else
                                If llSchStartTime = -1 Then
                                    gPackTime "12AM", tmPRdf.iStartTime(0, ilLoop), tmPRdf.iStartTime(1, ilLoop)
                                Else
                                    gPackTimeLong llSchStartTime, tmPRdf.iStartTime(0, ilLoop), tmPRdf.iStartTime(1, ilLoop)
                                End If
                                If llSchEndTime = -1 Then
                                    gPackTime "12AM", tmPRdf.iEndTime(0, ilLoop), tmPRdf.iEndTime(1, ilLoop)
                                Else
                                    gPackTimeLong llSchEndTime, tmPRdf.iEndTime(0, ilLoop), tmPRdf.iEndTime(1, ilLoop)
                                End If
                            End If
                        Next ilLoop
                        tmPRdf.sInOut = "N" 'Ignore In/Out rules
                        ilRet = BTRV_ERR_NONE
                    End If
                    If ilRet = BTRV_ERR_NONE Then
                        'tmPRdf.sInOut = "N" 'Ignore In/Out rules
                        'Determine if new weeks should be added to LCF and SSF
                        llLcfEarliestDate = gGetEarliestLCFDate(hmLcf, "C", imCVefCode)
                        If llLcfEarliestDate > lmEarliestAllowedDate Then
                            lmEarliestAllowedDate = llLcfEarliestDate
                        End If
                        llLcfLatestDate = gGetLatestLCFDate(hmLcf, "C", imCVefCode)
                        'Obtain rate card times as normalized numbers (spot counts)
                        'Ignore Overrides- use daypart times
                        If ilVpfIndex >= 0 Then
                            If ((llSchStartTime = -1) Or (llSchEndTime = -1)) Or (tgVpf(ilVpfIndex).sGMedium = "S") Then
                                tmCClf.iStartTime(0) = 1
                                tmCClf.iStartTime(1) = 0
                            Else
                                gPackTimeLong llSchStartTime, tmCClf.iStartTime(0), tmCClf.iStartTime(1)
                                gPackTimeLong llSchEndTime, tmCClf.iEndTime(0), tmCClf.iEndTime(1)
                            End If
                        Else
                            If (llSchStartTime = -1) Or (llSchEndTime = -1) Then
                                tmCClf.iStartTime(0) = 1
                                tmCClf.iStartTime(1) = 0
                            Else
                                gPackTimeLong llSchStartTime, tmCClf.iStartTime(0), tmCClf.iStartTime(1)
                                gPackTimeLong llSchEndTime, tmCClf.iEndTime(0), tmCClf.iEndTime(1)
                            End If
                        End If
                        mNorPCT tmPRdf
                        'Obtain flight information
                        'mObtainFlights tmCClf, tmPCff()
                        ReDim tmPCff(0 To 1) As CFF
                        tmPCff(0).lChfCode = tmCClf.lChfCode  'tlChf.lCode
                        tmPCff(0).iClfLine = tmCClf.iLine
                        tmPCff(0).iCntRevNo = tmCClf.iCntRevNo
                        tmPCff(0).iPropVer = tmCClf.iPropVer
                        gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llDate
                        slDate = Format$(llDate, "m/d/yy")
                        slDate = gObtainPrevMonday(slDate)
                        gPackDate slDate, tmPCff(0).iStartDate(0), tmPCff(0).iStartDate(1)
                        slDate = gObtainNextSunday(slDate)
                        gPackDate slDate, tmPCff(0).iEndDate(0), tmPCff(0).iEndDate(1)
                        tmPCff(0).sDyWk = "W"
                        tmPCff(0).iSpotsWk = 1
                        tmPCff(0).iXSpotsWk = 0
                        For ilDay = 0 To 6 Step 1
                            If ilInDays(ilDay) <> 0 Then
                                tmPCff(0).iDay(ilDay) = 1
                            Else
                                tmPCff(0).iDay(ilDay) = 0
                            End If
                            tmPCff(0).sXDay(ilDay) = "0"
                        Next ilDay
                        tmPCff(0).sDelete = "N"
                        If (llPChfCode <> tmSdf.lChfCode) Or (ilPLineNo <> tmSdf.iLineNo) Then
                            imCVefCode = tmCClf.iVefCode
                            mInitCounts tmPRdf, tmCClf.lChfCode, tmCClf.iLine, 0, 0, imPHour(), imPDay(), imPQH(), True
                            imCVefCode = ilBkVefCode
                        End If
                        llPChfCode = tmSdf.lChfCode
                        ilPLineNo = tmSdf.iLineNo
                        imPAdfCodeSLen = 0   'Advertiser code for last valid Separation computation
                        gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                        llDate = gDateValue(gObtainPrevMonday(slDate))
                        'Advance to first valid day
                        For ilDay = 0 To 6 Step 1
                            If tmPCff(0).iDay(ilDay) <> 0 Then
                                Exit For
                            End If
                            llDate = llDate + 1
                        Next ilDay
                        gGetLineSchParameters hmSsf, tgSsf(), lgSsfDate(), lgSsfRecPos(), llDate, imCVefCode, tmSdf.iAdfCode, 0, tmPCff(), tmCClf, tmPRdf, lmPSepLength, lmPStartDateSLen, lmPEndDateSLen, lmPChfCode, imPLineNo, imPAdfCodeSLen, imPVehComp, imPHour(), imPDay(), imPQH(), imPAHour(), imPADay(), imPAQH(), lmPTBStartTime(), lmPTBEndTime(), lmEarliestAllowedDate, imSkip(), tmCChf.sType, tmCChf.iPctTrade, imBkQH, False, imPriceLevel
                        imBkQH = 1  'MG or Outside Priority
                        '6/16/09:  Removed menu item Import Contracts because out of memory
                        'If tgSpf.sImptCntr <> "Y" Then
                            lmPSepLength = 1    'advertiser separation in same avail
                        'End If
                        imRafPass = 1
                        lmRafCode = 0
                        If lmPEndDateSLen >= lmEarliestAllowedDate Then
                            If lmPStartDateSLen < lmEarliestAllowedDate Then
                                'Advance date to earliest allow date
                                llDate = lmEarliestAllowedDate
                                slDate = Format$(llDate, "m/d/yy")
                            End If
                            'Obtain conflict records
                            gObtainVcf hmVcf, imCVefCode, llDate, tmVcf0(), tmVcf6(), tmVcf7()
                            'ReDim tmPreferredInfo(1 To 1) As PREFERREDINFO
                            ReDim tmPreferredInfo(0 To 0) As PREFERREDINFO
                            If Not mSchPasses(slSchStatus, slDate, tmCChf, tmCClf, tmPRdf, 0, lmPSepLength, lmPTBStartTime(), lmPTBEndTime(), imPAHour(), imPADay(), imPAQH(), imPriceLevel, 0, "YYYYYYY", 0, 86400) Then
                                '6/16/09:  Removed menu item Import Contracts because out of memory
                                'If tgSpf.sImptCntr = "Y" Then
                                '    gMGSchSpots = False
                                '    Exit Function
                                'End If
                                lmPSepLength = 0
                                lmCompTime = 0&
                                ilSvMnfComp0 = tmCChf.iMnfComp(0)
                                ilSvMnfComp1 = tmCChf.iMnfComp(1)
                                tmCChf.iMnfComp(0) = 0
                                tmCChf.iMnfComp(1) = 0
                                If Not mSchPasses(slSchStatus, slDate, tmCChf, tmCClf, tmPRdf, 0, lmPSepLength, lmPTBStartTime(), lmPTBEndTime(), imPAHour(), imPADay(), imPAQH(), imPriceLevel, 0, "YYYYYYY", 0, 86400) Then
                                    tmCChf.iMnfComp(0) = ilSvMnfComp0
                                    tmCChf.iMnfComp(1) = ilSvMnfComp1
                                    gMGSchSpots = False
                                    Exit Function
                                End If
                                tmCChf.iMnfComp(0) = ilSvMnfComp0
                                tmCChf.iMnfComp(1) = ilSvMnfComp1
                            End If
                        Else
                            gMGSchSpots = False
                            Exit Function
                        End If
                    Else
                        gMGSchSpots = False
                        Exit Function
                    End If
                Else
                    gMGSchSpots = False
                    Exit Function
                End If
            Else
                gMGSchSpots = False
                Exit Function
            End If
        Else
            gMGSchSpots = False
            Exit Function
        End If
    Else
        gMGSchSpots = False
        Exit Function
    End If
    gMGSchSpots = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:gFeedSchSpots                     *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Schedule specified spot as MG   *
'*                                                     *
'*******************************************************
Function gFeedSchSpots(ilMakeSSF As Integer) As Integer
'
'   gFeedSchSpots(ilMakeSSF)
'   Where:
'       ilMakeSSF(I)- True:Check and make ssf if missing; False: bypass test
'
    Dim ilRet As Integer
    Dim llLastFsfDate As Long
    Dim slDate As String
    Dim llDate As Long
    Dim slLength As String
    Dim llLcfEarliestDate As Long
    Dim llLcfLatestDate As Long
    Dim llSundayDate As Long
    Dim ilLogDate0 As Integer
    Dim ilLogDate1 As Integer
    Dim llExtendDate As Long
    'Add for sort and speed
    Dim llPChfCode As Long
    Dim llPFsfCode As Long
    Dim ilPLineNo As Integer
    Dim ilVpfIndex As Integer
    Dim llBypassStartDate As Long
    Dim llBypassEndDate As Long
    Dim slSchStatus As String
    Dim ilFsf As Integer
    Dim llFsfCode As Long
    Dim slFeedSchStatus As String
    Dim llSdfRecPos As Long

    ilRet = gVpfRead()

    gGetSchParameters
    gObtainMissedReasonCode
    'ReDim lgReschSdfCode(1 To 1) As Long
    ReDim lgReschSdfCode(0 To 0) As Long

    gOpenSchFiles

    mGetFeedSpots
    If UBound(lmFsfCode) <= LBound(lmFsfCode) Then
        gCloseSchFiles
        gFeedSchSpots = True
        Exit Function
    End If

    mInitSchVar True
    If igRnd Then
        Randomize   'Remove this if same results are to be obtained
    End If
    'Obtain spot to be scheduled
    llPChfCode = 0
    ilPLineNo = 0
    tmCChf.lCode = 0
    slSchStatus = "S"
    For ilFsf = LBound(lmFsfCode) To UBound(lmFsfCode) - 1 Step 1
        llFsfCode = lmFsfCode(ilFsf)
        tmFsfSrchKey0.lCode = llFsfCode
        ilRet = btrGetEqual(hmFsf, tmCFsf, imFsfRecLen, tmFsfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
        If (ilRet = BTRV_ERR_NONE) And (tmCFsf.sSchStatus <> "F") Then
            ilRet = btrGetPosition(hmFsf, lmFsfRecPos)
            If ilRet = BTRV_ERR_NONE Then
                slFeedSchStatus = tmCFsf.sSchStatus
                tmCFsf.sSchStatus = "I"
                ilRet = btrUpdate(hmFsf, tmCFsf, imFsfRecLen)

                gMoveFeedToCntr tmCFsf, tmCRdf, tmCChf, tmCClf, tmCCff(), hmFnf, hmPrf

                'Determine if previous existed
                'For know assume that it does not exist
                If tmCFsf.lPrevFsfCode > 0 Then
                    tmFsfSrchKey0.lCode = tmCFsf.lPrevFsfCode
                    ilRet = btrGetEqual(hmFsf, tmPFsf, imFsfRecLen, tmFsfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                    If ilRet = BTRV_ERR_NONE Then
                        gMoveFeedToCntr tmPFsf, tmPRdf, tmPChf, tmPclf, tmPCff(), hmFnf, hmPrf
                    Else
                        smOrigLnSchStatus = ""
                        tmPChf.lCode = 0
                        tmPclf.lChfCode = 0
                        ReDim tmPCff(0 To 0) As CFF
                        'ReDim tmPCgf(1 To 1) As CGF
                        ReDim tmPCgf(0 To 0) As CGF
                        tmPFsf.lCode = 0
                    End If
                Else
                    smOrigLnSchStatus = ""
                    tmPChf.lCode = 0
                    tmPclf.lChfCode = 0
                    ReDim tmPCff(0 To 0) As CFF
                    'ReDim tmPCgf(1 To 1) As CGF
                    ReDim tmPCgf(0 To 0) As CGF
                    tmPFsf.lCode = 0
                End If

                imCVefCode = tmCFsf.iVefCode
                imVirtVehSpotAdj = 1
                ilVpfIndex = gVpfFindIndex(imCVefCode)
                'Get earliest allowed date
                If Not mGetVefDates(imCVefCode, imCVpfIndex) Then
                    gCloseSchFiles
                    Erase lmFsfCode
                    gFeedSchSpots = False
                    Exit Function
                End If
                If ilMakeSSF Then
                    'Make sure SSF Created
                    gUnpackDateLong tmCFsf.iEndDate(0), tmCFsf.iEndDate(1), llLastFsfDate
                    slDate = Format$(llLastFsfDate, "m/d/yy")
                    slDate = gObtainNextSunday(slDate)
                    llSundayDate = gDateValue(slDate)
                    llLcfEarliestDate = gGetEarliestLCFDate(hmLcf, "C", imCVefCode)
                    If (llLcfEarliestDate > 0) And (llSundayDate < llLcfEarliestDate) Then
                        For llDate = llSundayDate - 6 To llLcfEarliestDate - 1 Step 1
                            slDate = Format$(llDate, "m/d/yy")
                            gPackDate slDate, ilLogDate0, ilLogDate1
                            ilRet = gExtendTFN(hmLcf, hmSsf, hmSdf, hmSmf, "C", imCVefCode, ilLogDate0, ilLogDate1, False)
                            If Not ilRet Then
                                gCloseSchFiles
                                Erase lmFsfCode
                                gFeedSchSpots = False
                                Exit Function
                            End If
                        Next llDate
                    End If
                    llLcfLatestDate = gGetLatestLCFDate(hmLcf, "C", imCVefCode)
                    If (llLcfLatestDate > 0) Then
                        llExtendDate = llLcfLatestDate + 1
                    Else
                        llExtendDate = lmEarliestAllowedDate
                    End If
                    For llDate = llExtendDate To llSundayDate Step 1
                        slDate = Format$(llDate, "m/d/yy")
                        gPackDate slDate, ilLogDate0, ilLogDate1
                        ilRet = gExtendTFN(hmLcf, hmSsf, hmSdf, hmSmf, "C", imCVefCode, ilLogDate0, ilLogDate1, False)
                        If Not ilRet Then
                            gCloseSchFiles
                            Erase lmFsfCode
                            gFeedSchSpots = False
                            Exit Function
                        End If
                    Next llDate
                End If
                If tmCFsf.lPrevFsfCode > 0 Then
                    tmCChf.lCode = tmPChf.lCode 'Alter code so spots will be found
                    tmCClf.lChfCode = tmPChf.lCode 'Alter code so spots will be found
                    tmCFsf.lCode = tmPFsf.lCode
                End If
                'Obtain competitive separation time
                If tgVpf(imCVpfIndex).sSCompType = "T" Then
                    gUnpackLength tgVpf(imCVpfIndex).iSCompLen(0), tgVpf(imCVpfIndex).iSCompLen(1), "3", False, slLength
                    lmCompTime = CLng(gLengthToCurrency(slLength))
                Else
                    lmCompTime = 0&
                End If
                'Determine if new weeks should be added to LCF and SSF
                llLcfEarliestDate = gGetEarliestLCFDate(hmLcf, "C", imCVefCode)
                If llLcfEarliestDate > lmEarliestAllowedDate Then
                    lmEarliestAllowedDate = llLcfEarliestDate
                End If
                llLcfLatestDate = gGetLatestLCFDate(hmLcf, "C", imCVefCode)
                'Obtain rate card times as normalized numbers (spot counts)
                'Ignore Overrides- use daypart times
                mNorPCT tmCRdf
                'Obtain flight information
                'mObtainFlights tmCClf, tmCCff()
                imCVefCode = tmCFsf.iVefCode

                ilRet = mBalanceSpots(0)

                'Adjust Copy if required
                If tmCFsf.lPrevFsfCode > 0 Then
                    If tmCFsf.lCifCode <> tmPFsf.lCifCode Then
                        mAdjFeedCopy
                    End If
                End If

                mInitCounts tmCRdf, llPChfCode, ilPLineNo, tmCFsf.lCode, 0, imPHour(), imPDay(), imPQH(), True
                imCAdfCodeSLen = 0   'Advertiser code for last valid Separation computation
                imCVefCode = tmCFsf.iVefCode
                llPChfCode = 0
                ilPLineNo = 0
                llPFsfCode = tmCFsf.lCode
                imPAdfCodeSLen = 0   'Advertiser code for last valid Separation computation
                lmPChfCode = -1
                imPLineNo = -1
                lmPStartDateSLen = -1
                lmPEndDateSLen = -1
                llBypassStartDate = 0
                llBypassEndDate = 0
                'Obtain spot to be scheduled
                imRafPass = 1
                lmRafCode = 0
                lgUnschIndex = LBound(lgUnschSdfCode)
                Do While lgUnschIndex < UBound(lgUnschSdfCode)
                    'llSdfRecPos = lgUnschRecPos(lgUnschIndex)    'lChfCode replaced with line record position
                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, llSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSdfSrchKey3.lCode = lgUnschSdfCode(lgUnschIndex)
                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet = BTRV_ERR_NONE Then
                        gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                        llDate = gDateValue(slDate)
                        gGetLineSchParameters hmSsf, tgSsf(), lgSsfDate(), lgSsfRecPos(), llDate, imCVefCode, tmCFsf.iAdfCode, 0, tmCCff(), tmCClf, tmCRdf, lmPSepLength, lmPStartDateSLen, lmPEndDateSLen, lmPChfCode, imPLineNo, imPAdfCodeSLen, imPVehComp, imPHour(), imPDay(), imPQH(), imPAHour(), imPADay(), imPAQH(), lmPTBStartTime(), lmPTBEndTime(), lmEarliestAllowedDate, imSkip(), tmCChf.sType, tmCChf.iPctTrade, imBkQH, False, imPriceLevel
                        imBkQH = 1  'MG or Outside Priority
                        imPriceLevel = 0
                        If lmPEndDateSLen >= lmEarliestAllowedDate Then
                            If lmPStartDateSLen < lmEarliestAllowedDate Then
                                'Advance date to earliest allow date
                                llDate = lmEarliestAllowedDate
                                slDate = Format$(llDate, "m/d/yy")
                            End If
                            'Obtain conflict records
                            gObtainVcf hmVcf, imCVefCode, llDate, tmVcf0(), tmVcf6(), tmVcf7()
                            'ReDim tmPreferredInfo(1 To 1) As PREFERREDINFO
                            ReDim tmPreferredInfo(0 To 0) As PREFERREDINFO
                            If Not mSchPasses(slSchStatus, slDate, tmCChf, tmCClf, tmCRdf, 0, lmPSepLength, lmPTBStartTime(), lmPTBEndTime(), imPAHour(), imPADay(), imPAQH(), imPriceLevel, 0, "YYYYYYY", 0, 86400) Then
                                mCompBypassDates llDate, tmCCff(), llBypassStartDate, llBypassEndDate
                                lgUnschIndex = lgUnschIndex + 1
                            Else
                                lgUnschIndex = lgUnschIndex + 1
                                llBypassStartDate = 0
                                llBypassEndDate = 0
                                mAdjustCounts imCAHour(), imCADay(), imCAQH(), imCHour(), imCDay(), imCQH()
                            End If
                        Else
                            lgUnschIndex = lgUnschIndex + 1
                        End If
                    Else
                        lgUnschIndex = lgUnschIndex + 1
                    End If
                Loop
                llFsfCode = lmFsfCode(ilFsf)
                tmFsfSrchKey0.lCode = llFsfCode
                ilRet = btrGetEqual(hmFsf, tmCFsf, imFsfRecLen, tmFsfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                If (ilRet = BTRV_ERR_NONE) Then
                    If tmCFsf.lPrevFsfCode > 0 Then
                        ilRet = btrDelete(hmFsf)
                        tmFsfSrchKey0.lCode = tmCFsf.lPrevFsfCode
                        ilRet = btrGetEqual(hmFsf, tmPFsf, imFsfRecLen, tmFsfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                        If ilRet = BTRV_ERR_NONE Then
                            tmPFsf.lCode = llFsfCode
                            ilRet = btrDelete(hmFsf)
                        End If
                        tmCFsf.lCode = tmCFsf.lPrevFsfCode
                        tmCFsf.lPrevFsfCode = llFsfCode
                        tmCFsf.sSchStatus = "F"
                        ilRet = btrInsert(hmFsf, tmCFsf, imFsfRecLen, INDEXKEY0)
                        ilRet = btrInsert(hmFsf, tmPFsf, imFsfRecLen, INDEXKEY0)
                    Else
                        tmCFsf.sSchStatus = "F"
                        ilRet = btrUpdate(hmFsf, tmCFsf, imFsfRecLen)
                    End If
                End If
            Else
                gCloseSchFiles
                Erase lmFsfCode
                gFeedSchSpots = False
                Exit Function
            End If
        Else
'            gCloseSchFiles
'            Erase lmFsfCode
'            gFeedSchSpots = False
'            Exit Function
        End If
    Next ilFsf
    gCloseSchFiles
    Erase lmFsfCode
    gFeedSchSpots = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:gOpenSchFiles                   *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Close files used for scheduling *
'*                     contracts                       *
'*                                                     *
'*******************************************************
Function gOpenSchFiles() As Integer
    Dim ilRet As Integer
    Dim tlCff As CFF
    Dim tlCgf As CGF
    '5/2/19: Only open the schedule file one time
    If lgOpenSchFileCount <> 0 Then
        lgOpenSchFileCount = lgOpenSchFileCount + 1
        gOpenSchFiles = True
        Exit Function
    End If
    lgOpenSchFileCount = lgOpenSchFileCount + 1
    hmCHF = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmCHF, "", sgDBPath & "Chf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imCHFRecLen = Len(tmCChf) 'btrRecordLength(hlChf)  'Get and save record length
    hmClf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmClf, "", sgDBPath & "Clf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imClfRecLen = Len(tmCClf) 'btrRecordLength(hlChf)  'Get and save record length
    hmCff = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmCff, "", sgDBPath & "Cff.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imCffRecLen = Len(tlCff) 'btrRecordLength(hlVcf)  'Get and save record length
    hmCgf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmCgf, "", sgDBPath & "Cgf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imCgfRecLen = Len(tlCgf) 'btrRecordLength(hlVcf)  'Get and save record length
    hmVcf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVcf, "", sgDBPath & "Vcf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    hmGsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmGsf, "", sgDBPath & "Gsf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imGsfRecLen = Len(tmGsf) 'btrRecordLength(hlVcf)  'Get and save record length
    hmGhf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmGhf, "", sgDBPath & "Ghf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imVcfRecLen = Len(tmVcf) 'btrRecordLength(hlVcf)  'Get and save record length
    hmLcf = CBtrvTable(TWOHANDLES) 'gExtendTFN CBtrvObj()
    ilRet = btrOpen(hmLcf, "", sgDBPath & "Lcf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imLcfRecLen = Len(tmLcf) 'btrRecordLength(hlLcf)  'Get and save record length
    hmSdf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmSdf, "", sgDBPath & "Sdf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imSdfRecLen = Len(tmSdf) 'btrRecordLength(hlChf)  'Get and save record length
    hmStf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmStf, "", sgDBPath & "Stf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imStfRecLen = Len(tmStf) 'btrRecordLength(hlChf)  'Get and save record length
    hmRdf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmRdf, "", sgDBPath & "Rdf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imRdfRecLen = Len(tmCRdf) 'btrRecordLength(hlRdf)  'Get and save record length


    hmVef = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmVef, "", sgDBPath & "Vef.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imVefRecLen = Len(tmVef) 'btrRecordLength(hlVef)  'Get and save record length
    ReDim tmVehLock(0 To 0) As Integer  'Vehicles locked when scheduling contract
    hmVsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVsf, "", sgDBPath & "Vsf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imVsfRecLen = Len(tmCVsf) 'btrRecordLength(hlVsf)  'Get and save record length
    hmCrf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmCrf, "", sgDBPath & "Crf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imCrfRecLen = Len(tmCrf) 'btrRecordLength(hlVsf)  'Get and save record length
'    hmDsf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
'    ilRet = btrOpen(hmDsf, "", sgDBPath & "Dsf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
'    If ilRet <> BTRV_ERR_NONE Then
'        gOpenSchFiles = False
'        ilRet = btrClose(hmDsf)
'        ilRet = btrClose(hmCrf)
'        ilRet = btrClose(hmVsf)
'        ilRet = btrClose(hmVef)
'        ilRet = btrClose(hmRdf)
'        ilRet = btrClose(hmStf)
'        ilRet = btrClose(hmSdf)
'        ilRet = btrClose(hmLcf)
'        ilRet = btrClose(hmVcf)
'        ilRet = btrClose(hmCff)
'        ilRet = btrClose(hmClf)
'        ilRet = btrClose(hmChf)
'        btrDestroy hmDsf
'        btrDestroy hmCrf
'        btrDestroy hmVsf
'        btrDestroy hmVef
'        btrDestroy hmRdf
'        btrDestroy hmStf
'        btrDestroy hmSdf
'        btrDestroy hmLcf
'        btrDestroy hmVcf
'        btrDestroy hmCff
'        btrDestroy hmClf
'        btrDestroy hmChf
'        Exit Function
'    End If
'    imDsfRecLen = Len(tmDsf) 'btrRecordLength(hlVsf)  'Get and save record length
    hmSsf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmSsf, "", sgDBPath & "Ssf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    'xxxxxxx
    hmMtf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmMtf, "", sgDBPath & "Mtf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        hmMtf = -1
    End If
    imMtfRecLen = Len(tmMtf) 'btrRecordLength(hmSsf)  'Get and save record length
    lgMtfNoRecs = btrRecords(hmMtf)
    imSsfRecLen = Len(tgSsf(0)) 'btrRecordLength(hmSsf)  'Get and save record length
    hmSmf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmSmf, "", sgDBPath & "Smf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imSmfRecLen = Len(tmSmf) 'btrRecordLength(hmSsf)   'Get and save record length
    hmSbf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmSbf, "", sgDBPath & "Sbf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imSbfRecLen = Len(tmSbf)
    
    hmPcf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmPcf, "", sgDBPath & "Pcf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imPcfRecLen = Len(tmPcf)
    hmMsf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmMsf, "", sgDBPath & "Msf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imMsfRecLen = Len(tmMsf)
    hmPrf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmPrf, "", sgDBPath & "Prf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imPrfRecLen = Len(tmPrf)
    If tgSpf.sSystemType = "R" Then
        hmFsf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
        ilRet = btrOpen(hmFsf, "", sgDBPath & "Fsf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            gOpenSchFiles = False
            gCloseSchFiles
            Exit Function
        End If
        imFsfRecLen = Len(tmCFsf)
        hmFpf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmFpf, "", sgDBPath & "Fpf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            gOpenSchFiles = False
            gCloseSchFiles
            Exit Function
        End If
        imFpfRecLen = Len(tmFpf)
        hmFnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmFnf, "", sgDBPath & "Fnf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            gOpenSchFiles = False
            gCloseSchFiles
            Exit Function
        End If
        imFnfRecLen = Len(tmFnf)
    End If
    hmRlf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmRlf, "", sgDBPath & "Rlf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    hmSxf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmSxf, "", sgDBPath & "Sxf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    If ((Asc(tgSpf.sUsingFeatures2) And SPLITNETWORKS) = SPLITNETWORKS) Then
        hmRaf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmRaf, "", sgDBPath & "Raf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            gOpenSchFiles = False
            gCloseSchFiles
            Exit Function
        End If
        imRafRecLen = Len(tmRaf)
        hmSef = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmSef, "", sgDBPath & "Sef.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            gOpenSchFiles = False
            gCloseSchFiles
            Exit Function
        End If
        imSefRecLen = Len(tmSef)
        ilRet = gObtainStations()
    End If

    hmMnf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmMnf, "", sgDBPath & "Mnf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        gOpenSchFiles = False
        gCloseSchFiles
        Exit Function
    End If
    imMnfRecLen = Len(tmMnf)
    
    igReschNoPasses = 1
    lgNoBonusRemoved = 0
    igSetEarliestDateAsToday = 1
    igUsePreferred = False
    gOpenSchFiles = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:gBuildCntrSchInfo               *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Build table of contracts        *
'*                     which indicates type of         *
'*                     scheduling required             *
'*                                                     *
'*******************************************************
Function gPopCntrSchBox(frm As Form, ilSort As Integer, lbcLocal As Control, lbcMster As Control, lbcNotSchd As Control) As Integer
'   ilRet = gPopCntrSchBox (MainForm, ilSort, lbcLocal, lbcCtrl)
'   Where:
'       MainForm (I)- Name of Form to unload if error exist
'       ilSort (I)- 0=Advertiser; Start Date; Contract #
'                   1=Start date; advertiser; contract #
'                   2=Start Date; Contract #
'                   3=Contract #
'       lbcLocal (O)- List box to be populated from the master list box
'       lbcCtrl (O)- Master List box Control containing name and code #
'       lbcNotSchd(O)- Contracts not scheduled and reason
'       ilRet (O)- Error code (0 if no error)

    Dim slStamp As String       'CHF date/time stamp
    Dim hlChf As Integer        'CHF handle
    Dim ilRecLen As Integer     'Record length
    Dim llNoRec As Long         'Number of records in Sof
    Dim tlChf As CHF
    Dim tlChfExt As CHFEXT      'Contract extract record
    Dim slName As String
    Dim ilExtLen As Integer
    Dim llRecPos As Long        'Record location
    Dim ilRet As Integer
    Dim ilFound As Integer
    Dim ilLoop As Integer
    Dim slNameCode As String
    Dim llRevCntrNo As Long
    Dim slCntrNo As String
    Dim slAdvtName As String
    Dim hlVsf As Integer        'Vsf handle
    Dim ilVsfReclen As Integer  'Record length
    Dim hlAdf As Integer        'Vsf handle
    Dim tlAdf As ADF
    Dim ilAdfRecLen As Integer  'Record length
    Dim tlAdfSrchKey As INTKEY0
    Dim hlAgf As Integer        'Vsf handle
    Dim tlagf As AGF
    Dim ilAgfRecLen As Integer  'Record length
    Dim tlAgfSrchKey As INTKEY0
    Dim ilOffSet As Integer
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
    Dim slSortDate As String
    Dim llUnLen As Long
    Dim ilUnLenMsg As Integer
    Dim llLen As Long
    Dim ilLenMsg As Integer
    Dim ilUser As Integer
    Dim hlRlf As Integer
    Dim slUserName As String
    
    slStamp = gFileDateTime(sgDBPath & "Chf.Btr")
    If lbcMster.Tag <> "" Then
        If StrComp(slStamp, lbcMster.Tag, 1) = 0 Then
            If lbcLocal.ListCount > 0 Then
                gPopCntrSchBox = CP_MSG_NOPOPREQ
                Exit Function
            End If
        End If
    End If
    ReDim tgLockCntr(0 To 0) As LOCKCNTR
    llUnLen = 0
    ilUnLenMsg = True
    llLen = 0
    ilLenMsg = True
    gPopCntrSchBox = CP_MSG_POPREQ
    'gObtainVehComboList
    hlChf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hlChf, "", sgDBPath & "Chf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrOpen):" & "Chf.Btr", frm
    On Error GoTo 0
    ilRecLen = Len(tlChf) 'btrRecordLength(hlChf)  'Get and save record length
    hlVsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hlVsf, "", sgDBPath & "Vsf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrOpen):" & "Vsf.Btr", frm
    On Error GoTo 0
    ilVsfReclen = Len(tmVsf) 'btrRecordLength(hlSlf)  'Get and save record length
    hlAdf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hlAdf, "", sgDBPath & "Adf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrOpen):" & "Adf.Btr", frm
    On Error GoTo 0
    ilAdfRecLen = Len(tlAdf) 'btrRecordLength(hlAdf)  'Get and save record length
    hlAgf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hlAgf, "", sgDBPath & "Agf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrOpen):" & "Agf.Btr", frm
    On Error GoTo 0
    ilAgfRecLen = Len(tlagf) 'btrRecordLength(hlAdf)  'Get and save record length
    hlRlf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hlRlf, "", sgDBPath & "Rlf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrOpen):" & "Rlf.Btr", frm
    On Error GoTo 0
    lbcMster.Clear   'VB list box clear (list box used to retain code number so record can be found)
    lbcLocal.Clear
    lbcMster.Tag = slStamp
    'llNoRec = btrRecords(hlChf) \ Len(tlChfExt)'Obtain number of records
    llNoRec = gExtNoRec(Len(tlChfExt)) 'Obtain number of records
    btrExtClear hlChf   'Clear any previous extend operation
    ilRet = btrGetFirst(hlChf, tlChf, ilRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If ilRet = BTRV_ERR_END_OF_FILE Then
        ilRet = btrClose(hlChf)
        On Error GoTo gPopCntrSchBoxErr
        gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrClose):" & "Chf.Btr", frm
        On Error GoTo 0
        btrDestroy hlChf
        ilRet = btrClose(hlVsf)
        On Error GoTo gPopCntrSchBoxErr
        gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrClose):" & "Vsf.Btr", frm
        On Error GoTo 0
        btrDestroy hlVsf
        ilRet = btrClose(hlAdf)
        On Error GoTo gPopCntrSchBoxErr
        gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrClose):" & "Adf.Btr", frm
        On Error GoTo 0
        btrDestroy hlAdf
        Exit Function
    Else
        On Error GoTo gPopCntrSchBoxErr
        gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrGetFirst):" & "Chf.Btr", frm
        On Error GoTo 0
    End If
    Call btrExtSetBounds(hlChf, llNoRec, -1, "UC", "CHFEXTPK", CHFEXTPK) 'Set extract limits (all records)
    tlCharTypeBuff.sType = "A"  'Old contract which requires scheduling
    ilOffSet = gFieldOffset("Chf", "ChfSchStatus")
    ilRet = btrExtAddLogicConst(hlChf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_OR, tlCharTypeBuff, 1)
    DoEvents
    tlCharTypeBuff.sType = "I"  'Old contract which requires scheduling
    ilOffSet = gFieldOffset("Chf", "ChfSchStatus")
    ilRet = btrExtAddLogicConst(hlChf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_OR, tlCharTypeBuff, 1)
    
    'Add fields
    DoEvents
    tlCharTypeBuff.sType = "N"  'New contract which requires scheduling
    ilOffSet = gFieldOffset("Chf", "ChfSchStatus")
    ilRet = btrExtAddLogicConst(hlChf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_LAST_TERM, tlCharTypeBuff, 1)
    ilOffSet = gFieldOffset("Chf", "ChfCode")
    ilRet = btrExtAddField(hlChf, ilOffSet, 4)  'Extract iCode field
    
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    On Error GoTo 0
    ilOffSet = gFieldOffset("Chf", "ChfCntrNo")
    ilRet = btrExtAddField(hlChf, ilOffSet, 4)  'Extract Contract number
    
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    On Error GoTo 0
    ilOffSet = gFieldOffset("Chf", "ChfPropDate")
    ilRet = btrExtAddField(hlChf, ilOffSet, 4) 'Extract Start date
    
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    On Error GoTo 0
    ilOffSet = gFieldOffset("Chf", "ChfType")
    ilRet = btrExtAddField(hlChf, ilOffSet, 1) 'Extract type
    
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    On Error GoTo 0
    ilOffSet = gFieldOffset("Chf", "ChfAdfCode")
    ilRet = btrExtAddField(hlChf, ilOffSet, 2) 'Extract advertiser code
    
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    On Error GoTo 0
    ilOffSet = gFieldOffset("Chf", "ChfProduct")
    ilRet = btrExtAddField(hlChf, ilOffSet, 35) 'Extract Product
    
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    On Error GoTo 0
    ilOffSet = gFieldOffset("Chf", "ChfAgfCode")
    ilRet = btrExtAddField(hlChf, ilOffSet, 2) 'Extract advertiser code
    
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    On Error GoTo 0
    ilOffSet = gFieldOffset("Chf", "ChfSlfCode1")
    ilRet = btrExtAddField(hlChf, ilOffSet, 20) 'Extract salesperson code
    
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    On Error GoTo 0
    ilOffSet = gFieldOffset("Chf", "ChfStartDate")
    ilRet = btrExtAddField(hlChf, ilOffSet, 4) 'Extract Start date
    
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    On Error GoTo 0
    ilOffSet = gFieldOffset("Chf", "ChfEndDate")
    ilRet = btrExtAddField(hlChf, ilOffSet, 4) 'Extract End date
    
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    On Error GoTo 0
    ilOffSet = gFieldOffset("Chf", "ChfVefCode")
    ilRet = btrExtAddField(hlChf, ilOffSet, 4) 'Extract Vehicle
    
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    On Error GoTo 0
    ilOffSet = gFieldOffset("Chf", "ChfCBSOrder")
    ilRet = btrExtAddField(hlChf, ilOffSet, 1) 'Extract SellNet
    
    'DoEvents
    'On Error GoTo gPopCntrSchBoxErr
    'gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    'On Error GoTo 0
    
    'TTP 11033 - Schedule screen: disallow allow user who last edited a contract from being able to schedule it
    DoEvents
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtAddField):" & "Chf.Btr", frm
    On Error GoTo 0
    ilOffSet = gFieldOffset("Chf", "ChfUrfCode")
    ilRet = btrExtAddField(hlChf, ilOffSet, 2) 'Extract UrfCode, fix TTP 11033 6/12/24 - change size for this int field from 1 to 2
    
    'ilRet = btrExtGetNextExt(hlChf)    'Extract record
    ilExtLen = Len(tlChfExt)  'Extract operation record size
    ilRet = btrExtGetNext(hlChf, tlChfExt, ilExtLen, llRecPos)
    If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
        DoEvents
        On Error GoTo gPopCntrSchBoxErr
        gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrExtGetNextExt):" & "Chf.Btr", frm
        On Error GoTo 0
        ilExtLen = Len(tlChfExt)  'Extract operation record size
        'ilRet = btrExtGetFirst(hlChf, tlChfExt, ilExtLen, llRecPos)
        Do While ilRet = BTRV_ERR_REJECT_COUNT
            ilRet = btrExtGetNext(hlChf, tlChfExt, ilExtLen, llRecPos)
        Loop
        Do While ilRet = BTRV_ERR_NONE
            DoEvents
            ilFound = False
            If (tgUrf(0).iCode = 1) Or (tgUrf(0).iCode = 2) Then
                ilFound = True
            Else
                ilFound = False
                For ilLoop = LBound(tgUrf) To UBound(tgUrf) Step 1
                    If (tgUrf(ilLoop).iVefCode = 0) Then
                        ilFound = True
                        Exit For
                    End If
                Next ilLoop
            End If
            
            'TTP 11033 - Schedule screen: disallow allow user who last edited a contract from being able to schedule it
            If (tgSpfx.iSchdFeature And SCHD_DISALLOWSAMEUSER) = SCHD_DISALLOWSAMEUSER Then
                If tlChfExt.iUrfCode = tgUrf(0).iCode Then
                    tlAdfSrchKey.iCode = tlChfExt.iAdfCode
                    If tlAdf.iCode <> tlChfExt.iAdfCode Then
                        ilRet = btrGetEqual(hlAdf, tlAdf, ilAdfRecLen, tlAdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                        On Error GoTo gPopCntrSchBoxErr
                        gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrGetEqual): Adf.Btr", frm
                        On Error GoTo 0
                    End If
                    
                    slName = Trim$(str$(tlChfExt.lCntrNo)) & " " & Trim$(tlAdf.sName) & ": cannot be scheduled by the user who edited contract"
                    If Not gOkAddStrToListBox(slName, llUnLen, ilUnLenMsg) Then
                        ilUnLenMsg = False
                    Else
                        lbcNotSchd.AddItem slName
                    End If
                    GoTo Skip 'Skip adding to Contract list
                End If
            End If
            
            If Not ilFound Then
                If tlChfExt.lVefCode > 0 Then
                    For ilLoop = LBound(tgUrf) To UBound(tgUrf) Step 1
                        If (tgUrf(ilLoop).iVefCode = tlChfExt.lVefCode) Or (tgUrf(0).iCode = 1) Or (tgUrf(0).iCode = 2) Then
                            ilFound = True
                            Exit For
                        End If
                    Next ilLoop
                ElseIf tlChfExt.lVefCode < 0 Then
                    If Not ilFound Then
                        'For ilLoop = LBound(lgVehComboCode) To UBound(lgVehComboCode) - 1 Step 1
                        '    If lgVehComboCode(ilLoop) = -tlChfExt.lVefCode Then
                        '        ilFound = True
                        '        Exit For
                        '    End If
                        'Next ilLoop
                        tmVsfSrchKey.lCode = -tlChfExt.lVefCode
                        ilRet = btrGetEqual(hlVsf, tmVsf, ilVsfReclen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                        DoEvents
                        On Error GoTo gPopCntrSchBoxErr
                        gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrGetEqual): Vsf.Btr", frm
                        On Error GoTo 0
                        For ilLoop = LBound(tmVsf.iFSCode) To UBound(tmVsf.iFSCode) Step 1
                            If tmVsf.iFSCode(ilLoop) > 0 Then
                                For ilUser = LBound(tgUrf) To UBound(tgUrf) Step 1
                                    If (tgUrf(ilUser).iVefCode = tmVsf.iFSCode(ilLoop)) Then
                                        ilFound = True
                                        Exit For
                                    End If
                                Next ilUser
                                If ilFound Then
                                    Exit For
                                End If
                            End If
                        Next ilLoop
                    End If
                Else
                    ilFound = True  'all vehicles
                End If
            End If
            If ilFound Then
                If tgUrf(0).iSlfCode <> 0 Then
                    'If tlChfExt.iSlfCode >= 0 Then
                        ilFound = False
                        For ilLoop = LBound(tlChfExt.iSlfCode) To UBound(tlChfExt.iSlfCode) Step 1
                            If tgUrf(0).iSlfCode = tlChfExt.iSlfCode(ilLoop) Then
                                ilFound = True
                                Exit For
                            End If
                        Next ilLoop
                    'Else
                    '    tlSrchKey.iCode = -tlChfExt.iSlfCode
                    '    ilRet = btrGetEqual(hlVsf, tlVsf, ilVsfRecLen, tlSrchKey, INDEXKEY0, BTRV_LOCK_NONE)
                    '    On Error GoTo gPopCntrSchBoxErr
                    '    gBtrvErrorMsg ilRet, "mPopCntrBoxRec (btrGetEqual): Vsf.Btr", Frm
                    '    On Error GoTo 0
                    '    ilFound = False
                    '    For ilLoop = LBound(tlVsf.iFSCode) To UBound(tlVsf.iFSCode) Step 1
                    '        If tlVsf.iFSCode(ilLoop) = tgUrf(0).iSlfCode Then
                    '            ilFound = True
                    '            Exit For
                    '        End If
                    '    Next ilLoop
                    'End If
                End If
            End If
            If ilFound Then
                tlAdfSrchKey.iCode = tlChfExt.iAdfCode
                If tlAdf.iCode <> tlChfExt.iAdfCode Then
                    ilRet = btrGetEqual(hlAdf, tlAdf, ilAdfRecLen, tlAdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                    On Error GoTo gPopCntrSchBoxErr
                    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrGetEqual): Adf.Btr", frm
                    On Error GoTo 0
                End If
                DoEvents
                If tlAdf.sCrdApp <> "A" Then
                    ilFound = False
                    'lbcNotSchd.AddItem Trim$(Str$(tlChfExt.lCntrNo)) & " " & Trim$(tlAdf.sName) & " Unapproved Credit: " & Trim$(tlAdf.sName)
                    If (tlAdf.sBillAgyDir = "D") And (Trim$(tlAdf.sAddrID) <> "") Then
                        slName = Trim$(str$(tlChfExt.lCntrNo)) & " " & Trim$(tlAdf.sName) & ", " & Trim$(tlAdf.sAddrID) & " Unapproved Credit: " & Trim$(tlAdf.sName)
                    Else
                        slName = Trim$(str$(tlChfExt.lCntrNo)) & " " & Trim$(tlAdf.sName) & " Unapproved Credit: " & Trim$(tlAdf.sName)
                    End If
                    If Not gOkAddStrToListBox(slName, llUnLen, ilUnLenMsg) Then
                        ilUnLenMsg = False
                    Else
                        lbcNotSchd.AddItem slName
                    End If
                Else
                    If tlChfExt.iAgfCode > 0 Then
                        tlAgfSrchKey.iCode = tlChfExt.iAgfCode
                        If tlagf.iCode <> tlChfExt.iAgfCode Then
                            ilRet = btrGetEqual(hlAgf, tlagf, ilAgfRecLen, tlAgfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                            On Error GoTo gPopCntrSchBoxErr
                            gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrGetEqual): Agf.Btr", frm
                            On Error GoTo 0
                        End If
                        DoEvents
                        If tlagf.sCrdApp <> "A" Then
                            ilFound = False
                            'lbcNotSchd.AddItem Trim$(Str$(tlChfExt.lCntrNo)) & " " & Trim$(tlAdf.sName) & " Unapproved Credit: " & Trim$(tlAgf.sName)
                            If (tlAdf.sBillAgyDir = "D") And (Trim$(tlAdf.sAddrID) <> "") Then
                                slName = Trim$(str$(tlChfExt.lCntrNo)) & " " & Trim$(tlAdf.sName) & ", " & Trim$(tlAdf.sAddrID) & " Unapproved Credit: " & Trim$(tlagf.sName)
                            Else
                                slName = Trim$(str$(tlChfExt.lCntrNo)) & " " & Trim$(tlAdf.sName) & " Unapproved Credit: " & Trim$(tlagf.sName)
                            End If
                            If Not gOkAddStrToListBox(slName, llUnLen, ilUnLenMsg) Then
                                ilUnLenMsg = False
                            Else
                                lbcNotSchd.AddItem slName
                            End If
                        End If
                    End If
                End If
            End If
            If ilFound Then
                DoEvents
                tgLockCntr(UBound(tgLockCntr)).lCntrNo = tlChfExt.lCntrNo
                tgLockCntr(UBound(tgLockCntr)).lLockRecCode = gCreateLockRec(hlRlf, "C", "S", tlChfExt.lCntrNo, True, slUserName)
                DoEvents
                If tgLockCntr(UBound(tgLockCntr)).lLockRecCode > 0 Then
                    ReDim Preserve tgLockCntr(0 To UBound(tgLockCntr) + 1) As LOCKCNTR
                Else
                    ilFound = False
                    slName = Trim$(str$(tlChfExt.lCntrNo)) & " being Altered by " & slUserName
                    If Not gOkAddStrToListBox(slName, llUnLen, ilUnLenMsg) Then
                        ilUnLenMsg = False
                    Else
                        lbcNotSchd.AddItem slName
                    End If
                End If
            End If
            If ilFound Then
                'Note: start date stored into end date filed
                gUnpackDateForSort tlChfExt.iEndDate(0), tlChfExt.iEndDate(1), slSortDate
                llRevCntrNo = tlChfExt.lCntrNo  '99999999 - tlChfExt.lCntrNo
                slCntrNo = Trim$(str$(llRevCntrNo))
                Do While Len(slCntrNo) < 8
                    slCntrNo = "0" & slCntrNo
                Loop
                If (tlAdf.sBillAgyDir = "D") And (Trim$(tlAdf.sAddrID) <> "") Then
                    slAdvtName = Trim$(tlAdf.sName) & ", " & Trim$(tlAdf.sAddrID)
                Else
                    slAdvtName = Trim$(tlAdf.sName)
                End If
                If ilSort = 0 Then  'Advertiser order; start date; contract#
                    slName = slAdvtName & "|" & slSortDate & "|" & slCntrNo
                ElseIf ilSort = 1 Then  'Start date; Advertiser; contract
                    slName = slSortDate & "|" & slAdvtName & "|" & slCntrNo
                ElseIf ilSort = 2 Then   'Start date; Contract #
                    slName = slSortDate & "|" & slCntrNo
                Else    'Contract #
                    slName = slCntrNo
                End If
                slName = slName & "\" & Trim$(str$(tlChfExt.lCode))
                If Not gOkAddStrToListBox(slName, llLen, ilLenMsg) Then
                    ilLenMsg = False
                Else
                    lbcMster.AddItem slName    'Add ID (retain matching sorted order) and Code number to list box
                End If
            End If
Skip:
            ilRet = btrExtGetNext(hlChf, tlChfExt, ilExtLen, llRecPos)
            Do While ilRet = BTRV_ERR_REJECT_COUNT
                ilRet = btrExtGetNext(hlChf, tlChfExt, ilExtLen, llRecPos)
            Loop
        Loop
        For ilLoop = 0 To lbcMster.ListCount - 1 Step 1
            DoEvents
            slNameCode = lbcMster.List(ilLoop)
            ilRet = gParseItem(slNameCode, 1, "\", slName)
            If ilSort = 0 Then  'Advertiser order; start date; contract#
                ilRet = gParseItem(slName, 3, "|", slCntrNo)
                slCntrNo = Trim$(str$(Val(slCntrNo)))
                ilRet = gParseItem(slName, 1, "|", slAdvtName)
                slName = slAdvtName & "/" & slCntrNo
            ElseIf ilSort = 1 Then  'Start date; Advertiser; contract
                ilRet = gParseItem(slName, 3, "|", slCntrNo)
                slCntrNo = Trim$(str$(Val(slCntrNo)))
                ilRet = gParseItem(slName, 2, "|", slAdvtName)
                slName = slAdvtName & "/" & slCntrNo
            ElseIf ilSort = 2 Then   'Start date; Contract #
                ilRet = gParseItem(slName, 2, "|", slCntrNo)
                slName = Trim$(str$(Val(slCntrNo)))
            Else    'Contract #
                slName = Trim$(str$(Val(slName)))
            End If
            lbcLocal.AddItem Trim$(slName)  'Add ID to list box
        Next ilLoop
    End If
    ilRet = btrClose(hlRlf)
    btrDestroy hlRlf
    DoEvents
    ilRet = btrClose(hlAgf)
    btrDestroy hlAgf
    DoEvents
    ilRet = btrClose(hlAdf)
    btrDestroy hlAdf
    DoEvents
    ilRet = btrClose(hlVsf)
    btrDestroy hlVsf
    DoEvents
    ilRet = btrClose(hlChf)
    On Error GoTo gPopCntrSchBoxErr
    gBtrvErrorMsg ilRet, "gPopCntrSchBox (btrClose):" & "Chf.Btr", frm
    On Error GoTo 0
    btrDestroy hlChf
    Exit Function
gPopCntrSchBoxErr:
    sgTmfStatus = "E"
    ilRet = btrClose(hlAgf)
    btrDestroy hlAgf
    ilRet = btrClose(hlAdf)
    btrDestroy hlAdf
    ilRet = btrClose(hlVsf)
    btrDestroy hlVsf
    ilRet = btrClose(hlChf)
    btrDestroy hlChf
    gPopCntrSchBox = CP_MSG_NOSHOW
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:gReSchSpots                     *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Schedule specified contract     *
'*              (Called by PrgSchd.Bas-gBuildLCF)      *
'*              (Called by UnSchd.Frm-mSchd)           *
'*                                                     *
'*******************************************************
Function gReSchSpots(ilMakeSSF As Integer, ilCallType As Integer, slCallTypeDays As String, llCallTypeStartTime As Long, llCallTypeEndTime As Long) As Integer
'
'   gReSchSpots(ilMakeSSF)
'   Where:
'       ilMakeSSF(I)- True:Check and make ssf if missing; False: bypass test
'       ilCallType(I)- 0=Standard, 1= Front Load from Action button, 2= Pre-empt from Action button
'       slCallTypeDays(I)- Valid for ilCallType = 1 (Front Load). Y and N with string set as Mo-Su and ilCallType = 2 (Pre-empt from Action)
'       igReschNoPasses(I)- Number of passes to book missed spot: 2 = pass 1 look for holes only, pass 2 preempt; <> 2= Preempt allowed
'       lgUnschRecPos contains the record position of all spots to be scheduled
'
    Dim ilRet As Integer
    Dim tlClfSrchKey As CLFKEY0
    Dim tlRdfSrchKey As INTKEY0
    Dim tlCffSrchKey As CFFKEY0
    Dim tlTempCff As CFF
    Dim ilLoop As Integer
    Dim llLastCffDate As Long
    Dim slDate As String
    Dim llDate As Long
    Dim slLength As String
    Dim llLcfEarliestDate As Long
    Dim llLcfLatestDate As Long
    Dim llSundayDate As Long
    Dim ilLogDate0 As Integer
    Dim ilLogDate1 As Integer
    Dim llExtendDate As Long
    'Add for sort and speed
    Dim slChfCode As String
    Dim slLineNo As String
    Dim slFsfCode As String
    Dim llPChfCode As Long
    Dim ilPLineNo As Integer
    Dim llPFsfCode As Long
    Dim ilTranSet As Integer
    Dim ilToVefCode As Integer
    Dim llToSTime As Long
    Dim llToETime As Long
    Dim ilToRdfCode As Integer
    Dim slPreemptPass As String
    Dim llSDFCode As Long
    Dim ilOk As Integer
    Dim llInitUBoundIndex As Long
    Dim llFlightSDate As Long
    Dim llFlightEDate As Long
    Dim ilTest As Integer
    Dim ilFound As Integer
    Dim ilUpper As Integer
    Dim ilDay As Integer
    Dim ilGameNo As Integer
    Dim ilCgf As Integer
    Dim slGameStatus As String
    Dim llPrevReschIndex As Long
    Dim ilGameNoIndex As Integer
    Dim slGameDate As String
    Dim llMoGameDate As Long
    Dim ilSpotRet As Integer
    '3/8/13: Add date to be used with game number match
    Dim llCgfAirDate As Long
    Dim llCgfMoAirDate As Long
    
    ReDim tmReSchdCgf(0 To 0) As CGF
    mInitSchVar True
    If igRnd Then
        Randomize   'Remove this if same results are to be obtained
    End If
    If LBound(lgReschSdfCode) = 1 Then
        ReDim tmSortResch(LBound(lgReschSdfCode) - 1 To UBound(lgReschSdfCode) - 1) As SORTRESCH
    Else
        ReDim tmSortResch(LBound(lgReschSdfCode) To UBound(lgReschSdfCode)) As SORTRESCH
    End If
    For ilLoop = LBound(lgReschSdfCode) To UBound(lgReschSdfCode) - 1 Step 1
        If igDoEvent Then
            DoEvents
        End If
        'lmSdfRecPos = lgReschRecPos(ilLoop)    'lChfCode replaced with line record position
        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, lmSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
        tmSdfSrchKey3.lCode = lgReschSdfCode(ilLoop)
        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If igDoEvent Then
            DoEvents
        End If
        slChfCode = Trim$(str$(tmSdf.lChfCode))
        Do While Len(slChfCode) < 10
            slChfCode = "0" & slChfCode
        Loop
        slLineNo = Trim$(str$(tmSdf.iLineNo))
        Do While Len(slLineNo) < 4
            slLineNo = "0" & slLineNo
        Loop
        slFsfCode = Trim$(str$(tmSdf.lFsfCode))
        Do While Len(slFsfCode) < 10
            slFsfCode = "0" & slFsfCode
        Loop
        tmSortResch(ilLoop - LBound(lgReschSdfCode)).sKey = slChfCode & slLineNo & slFsfCode
        tmSortResch(ilLoop - LBound(lgReschSdfCode)).lSdfCode = tmSdf.lCode
        If igDoEvent Then
            DoEvents
        End If
    Next ilLoop
    If igDoEvent Then
        DoEvents
    End If
    If UBound(tmSortResch) - 1 > 0 Then
        ArraySortTyp fnAV(tmSortResch(), 0), UBound(tmSortResch), 0, LenB(tmSortResch(0)), 0, LenB(tmSortResch(0).sKey), 0
    End If
    If igDoEvent Then
        DoEvents
    End If
    For ilLoop = 0 To UBound(tmSortResch) - 1 Step 1
        lgReschSdfCode(ilLoop + LBound(lgReschSdfCode)) = tmSortResch(ilLoop).lSdfCode
    Next ilLoop
    If igDoEvent Then
        DoEvents
    End If
    Erase tmSortResch
    'Obtain spot to be scheduled
    'ReDim tmPreferredInfo(1 To 1) As PREFERREDINFO
    ReDim tmPreferredInfo(0 To 0) As PREFERREDINFO
    llPChfCode = 0
    ilPLineNo = 0
    llPFsfCode = 0
    tmCChf.lCode = 0
    imRafPass = 0
    lmRafCode = 0
    ilTranSet = False
    ilGameNoIndex = -1
    lgReschIndex = LBound(lgReschSdfCode)
    llPrevReschIndex = -1
    llInitUBoundIndex = UBound(lgReschSdfCode)
    Do While lgReschIndex < UBound(lgReschSdfCode)
        'ilTranSet = True
        'ilRet = btrBeginTrans(hmSdf, 1000)
        'If ilRet <> BTRV_ERR_NONE Then
        '    gReSchSpots = False
        '    Exit Function
        'End If
        'lmSdfRecPos = lgReschRecPos(lgReschIndex)    'lChfCode replaced with line record position
        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, lmSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
        If igDoEvent Then
            DoEvents
        End If
        llSDFCode = lgReschSdfCode(lgReschIndex)
        tmSdfSrchKey3.lCode = llSDFCode
        ilSpotRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If igDoEvent Then
            DoEvents
        End If
        If ilGameNoIndex = -1 Then
            ReDim tmReSchdCgf(0 To 0) As CGF
            If tmSdf.iGameNo > 0 Then
                'Build array of game numbers to check if weekly game buy
                tlClfSrchKey.lChfCode = tmSdf.lChfCode
                tlClfSrchKey.iLine = tmSdf.iLineNo
                tlClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
                tlClfSrchKey.iPropVer = 32000 ' 0 show latest version
                ilRet = btrGetGreaterOrEqual(hmClf, tmCClf, imClfRecLen, tlClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                If igDoEvent Then
                    DoEvents
                End If
                Do While (ilRet = BTRV_ERR_NONE) And (tmCClf.lChfCode = tmSdf.lChfCode) And (tmCClf.iLine = tmSdf.iLineNo) And ((tmCClf.sSchStatus <> "M") And (tmCClf.sSchStatus <> "F"))
                    ilRet = btrGetNext(hmClf, tmCClf, imClfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop
                If tmCClf.sSportsByWeek = "W" Then
                    ilGameNoIndex = LBound(tmReSchdCgf)
                    tmReSchdCgf(ilGameNoIndex).iGameNo = tmSdf.iGameNo
                    tmReSchdCgf(ilGameNoIndex).iAirDate(0) = tmSdf.iDate(0)
                    tmReSchdCgf(ilGameNoIndex).iAirDate(1) = tmSdf.iDate(1)
                    tmReSchdCgf(ilGameNoIndex).iNoSpots = 1
                    tmReSchdCgf(ilGameNoIndex).lClfCode = tmCClf.lCode
                    ReDim Preserve tmReSchdCgf(0 To UBound(tmReSchdCgf) + 1) As CGF
                    gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slGameDate
                    llMoGameDate = gDateValue(gObtainPrevMonday(slGameDate))
                    tmGsfSrchKey3.iVefCode = tmSdf.iVefCode
                    tmGsfSrchKey3.iGameNo = 0
                    ilRet = btrGetGreaterOrEqual(hmGsf, tmGsf, imGsfRecLen, tmGsfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE)
                    Do While (ilRet = BTRV_ERR_NONE) And (tmGsf.iVefCode = tmSdf.iVefCode)
                        gUnpackDateLong tmGsf.iAirDate(0), tmGsf.iAirDate(1), llDate
                        If (llDate >= llMoGameDate) And (llDate <= llMoGameDate + 6) Then
                            If tmGsf.iGameNo <> tmSdf.iGameNo Then
                                ilGameNoIndex = UBound(tmReSchdCgf)
                                tmReSchdCgf(ilGameNoIndex).iGameNo = tmGsf.iGameNo
                                tmReSchdCgf(ilGameNoIndex).iAirDate(0) = tmGsf.iAirDate(0)
                                tmReSchdCgf(ilGameNoIndex).iAirDate(1) = tmGsf.iAirDate(1)
                                tmReSchdCgf(ilGameNoIndex).iNoSpots = 1
                                tmReSchdCgf(ilGameNoIndex).lClfCode = tmCClf.lCode
                                ReDim Preserve tmReSchdCgf(0 To UBound(tmReSchdCgf) + 1) As CGF
                            End If
                        End If
                        ilRet = btrGetNext(hmGsf, tmGsf, imGsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                    Loop
                    ilGameNoIndex = LBound(tmReSchdCgf)
                End If
            End If
        End If
        If ilGameNoIndex >= 0 Then
            tmSdf.iGameNo = tmReSchdCgf(ilGameNoIndex).iGameNo
            tmSdf.iDate(0) = tmReSchdCgf(ilGameNoIndex).iAirDate(0)
            tmSdf.iDate(1) = tmReSchdCgf(ilGameNoIndex).iAirDate(1)
        End If
        slGameStatus = mGetGameStatus(tmSdf)
        'If (ilRet = BTRV_ERR_NONE) And (tmSdf.sSchStatus = "M") And (slGameStatus <> "C") Then
        If ((ilSpotRet = BTRV_ERR_NONE) And (tmSdf.sSchStatus = "M") And (slGameStatus <> "C") And ((ilCallType = 0) Or (ilCallType = 2))) Or ((ilRet = BTRV_ERR_NONE) And (tmSdf.sSchStatus = "S") And (ilCallType = 1) And (tmSdf.iGameNo <= 0)) Then
            ilGameNo = tmSdf.iGameNo
            '3/8/13: Add date
            gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llCgfAirDate
            llCgfMoAirDate = llCgfAirDate - gWeekDayLong(llCgfAirDate)
            'end 3/8/13
            If tmSdf.sTracer <> "*" Then
                'ilRet = btrGetPosition(hmSdf, lmSdfRecPos)
                If tmSdf.lChfCode > 0 Then
                    If tmCChf.lCode <> tmSdf.lChfCode Then
                        tmChfSrchKey.lCode = tmSdf.lChfCode
                        ilRet = btrGetEqual(hmCHF, tmCChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                    Else
                        ilRet = BTRV_ERR_NONE
                    End If
                Else
                    tmFsfSrchKey0.lCode = tmSdf.lFsfCode
                    ilRet = btrGetEqual(hmFsf, tmCFsf, imFsfRecLen, tmFsfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                End If
                If igDoEvent Then
                    DoEvents
                End If
                If ilRet = BTRV_ERR_NONE Then
                    If tmSdf.lChfCode > 0 Then
                        If (llPChfCode <> tmSdf.lChfCode) Or (ilPLineNo <> tmSdf.iLineNo) Then
                            'ReDim tmPreferredInfo(1 To 1) As PREFERREDINFO
                            ReDim tmPreferredInfo(0 To 0) As PREFERREDINFO
                            tlClfSrchKey.lChfCode = tmCChf.lCode
                            tlClfSrchKey.iLine = tmSdf.iLineNo
                            tlClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
                            tlClfSrchKey.iPropVer = 32000 ' 0 show latest version
                            ilRet = btrGetGreaterOrEqual(hmClf, tmCClf, imClfRecLen, tlClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                            If igDoEvent Then
                                DoEvents
                            End If
                            Do While (ilRet = BTRV_ERR_NONE) And (tmCClf.lChfCode = tmCChf.lCode) And (tmCClf.iLine = tmSdf.iLineNo) And ((tmCClf.sSchStatus <> "M") And (tmCClf.sSchStatus <> "F"))
                                ilRet = btrGetNext(hmClf, tmCClf, imClfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                                If igDoEvent Then
                                    DoEvents
                                End If
                            Loop
                        Else
                            ilRet = BTRV_ERR_NONE
                        End If
                    Else
                        'ReDim tmPreferredInfo(1 To 1) As PREFERREDINFO
                        ReDim tmPreferredInfo(0 To 0) As PREFERREDINFO
                        gMoveFeedToCntr tmCFsf, tmCRdf, tmCChf, tmCClf, tmCCff(), hmFnf, hmPrf
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                    ilOk = False
                    If tmSdf.lChfCode > 0 Then
                        If (ilRet = BTRV_ERR_NONE) And (tmCClf.lChfCode = tmCChf.lCode) And (tmCClf.iLine = tmSdf.iLineNo) And ((tmCClf.sSchStatus = "I") Or (tmCClf.sSchStatus = "F")) Then
                            ilOk = True
                        End If
                    Else
                        ilOk = True
                    End If
                    If ilOk Then
                        imCVefCode = tmSdf.iVefCode 'tmCClf.iVefCode
                        'Get earliest allowed date
                        If igDoEvent Then
                            DoEvents
                        End If
                        If Not mGetVefDates(imCVefCode, imCVpfIndex) Then
                            'ilRet = btrAbortTrans(hmSdf)
                            gReSchSpots = False
                            Exit Function
                        End If
                        If igDoEvent Then
                            DoEvents
                        End If
                        If (ilMakeSSF) And (tmSdf.lChfCode > 0) And (ilGameNo = 0) Then
                            'Make sure SSF Created
                            imCffRecLen = Len(tlTempCff)
                            tlCffSrchKey.lChfCode = tmCChf.lCode
                            tlCffSrchKey.iClfLine = tmCClf.iLine
                            tlCffSrchKey.iCntRevNo = tmCClf.iCntRevNo
                            tlCffSrchKey.iPropVer = tmCClf.iPropVer
                            tlCffSrchKey.iStartDate(0) = 0
                            tlCffSrchKey.iStartDate(1) = 0
                            llLastCffDate = 0
                            ilRet = btrGetGreaterOrEqual(hmCff, tlTempCff, imCffRecLen, tlCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                            Do While (ilRet = BTRV_ERR_NONE) And (tlTempCff.lChfCode = tmCChf.lCode) And (tlTempCff.iClfLine = tmCClf.iLine) And (tlTempCff.iCntRevNo = tmCClf.iCntRevNo) And (tlTempCff.iPropVer = tmCClf.iPropVer)
                                If igDoEvent Then
                                    DoEvents
                                End If
                                gUnpackDateLong tlTempCff.iEndDate(0), tlTempCff.iEndDate(1), llDate
                                If llDate > llLastCffDate Then
                                    llLastCffDate = llDate
                                End If
                                ilRet = btrGetNext(hmCff, tlTempCff, imCffRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                            Loop
                            If igDoEvent Then
                                DoEvents
                            End If

                            slDate = Format$(llLastCffDate, "m/d/yy")
                            slDate = gObtainNextSunday(slDate)
                            llSundayDate = gDateValue(slDate)
                            llLcfLatestDate = gGetLatestLCFDate(hmLcf, "C", imCVefCode)
                            If (llLcfLatestDate > 0) Then
                                llExtendDate = llLcfLatestDate + 1
                            Else
                                llExtendDate = lmEarliestAllowedDate
                            End If
                            For llDate = llExtendDate To llSundayDate Step 1
                                If igDoEvent Then
                                    DoEvents
                                End If
                                slDate = Format$(llDate, "m/d/yy")
                                gPackDate slDate, ilLogDate0, ilLogDate1
                                ilRet = gExtendTFN(hmLcf, hmSsf, hmSdf, hmSmf, "C", imCVefCode, ilLogDate0, ilLogDate1, False)
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If Not ilRet Then
                                    'ilRet = btrAbortTrans(hmSdf)
                                    gReSchSpots = False
                                    Exit Function
                                End If
                            Next llDate
                        End If
                        'Obtain competitive separation time
                        If tgVpf(imCVpfIndex).sSCompType = "T" Then
                            gUnpackLength tgVpf(imCVpfIndex).iSCompLen(0), tgVpf(imCVpfIndex).iSCompLen(1), "3", False, slLength
                            lmCompTime = CLng(gLengthToCurrency(slLength))
                        Else
                            lmCompTime = 0&
                        End If
                        '12-16-04
                        If tmSdf.lChfCode > 0 Then
                            tlRdfSrchKey.iCode = tmCClf.iRdfCode
                            ilRet = btrGetEqual(hmRdf, tmPRdf, imRdfRecLen, tlRdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        Else
                            tmPRdf = tmCRdf
                            ilRet = BTRV_ERR_NONE
                        End If

                        If igDoEvent Then
                            DoEvents
                        End If
                        If ilRet = BTRV_ERR_NONE Then
                            'Determine if new weeks should be added to LCF and SSF
                            llLcfEarliestDate = gGetEarliestLCFDate(hmLcf, "C", imCVefCode)
                            If llLcfEarliestDate > lmEarliestAllowedDate Then
                                lmEarliestAllowedDate = llLcfEarliestDate
                            End If
                            llLcfLatestDate = gGetLatestLCFDate(hmLcf, "C", imCVefCode)
                            'Obtain rate card times as normalized numbers (spot counts)
                            If igDoEvent Then
                                DoEvents
                            End If
                            mNorPCT tmPRdf
                            If igDoEvent Then
                                DoEvents
                            End If
                            'Obtain flight information
                            If tmSdf.lChfCode > 0 Then      '12-16-04
                                mObtainFlights tmCClf, tmPCff(), tmPCgf()
                                If ilGameNo > 0 Then
                                    ilFound = False
                                    ReDim tmPCff(0 To 1) As CFF
                                    For ilCgf = LBound(tmPCgf) To UBound(tmPCgf) - 1 Step 1
                                        If tmPCgf(ilCgf).iGameNo = ilGameNo Then
                                            '3/8/13: Add date test
                                            gUnpackDateLong tmPCgf(ilCgf).iAirDate(0), tmPCgf(ilCgf).iAirDate(1), llCgfAirDate
                                            If llCgfMoAirDate = llCgfAirDate - gWeekDayLong(llCgfAirDate) Then
                                            'End 3/8/13
                                                ilFound = True
                                                If tmPCgf(ilCgf).iGameNo <> tmReSchdCgf(0).iGameNo Then
                                                    tmPCgf(ilCgf).iNoSpots = tmPCgf(ilCgf).iNoSpots + 1
                                                End If
                                                gCgfToCff tmCClf, tmPCgf(ilCgf), tmPCff()
                                                Exit For
                                            End If
                                        End If
                                    Next ilCgf
                                    If Not ilFound Then
                                        For ilCgf = LBound(tmReSchdCgf) To UBound(tmReSchdCgf) - 1 Step 1
                                            If tmReSchdCgf(ilCgf).iGameNo = ilGameNo Then
                                                '3/8/13: add date test
                                                gUnpackDateLong tmReSchdCgf(ilCgf).iAirDate(0), tmReSchdCgf(ilCgf).iAirDate(1), llCgfAirDate
                                                If llCgfMoAirDate = llCgfAirDate - gWeekDayLong(llCgfAirDate) Then
                                                'End 3/8/13
                                                    ilFound = True
                                                    tmPCgf(UBound(tmPCgf)) = tmReSchdCgf(ilCgf)
                                                    ReDim Preserve tmPCgf(LBound(tmPCgf) To UBound(tmPCgf) + 1) As CGF
                                                    gCgfToCff tmCClf, tmPCgf(UBound(tmPCgf) - 1), tmPCff()
                                                    Exit For
                                                End If
                                            End If
                                        Next ilCgf
                                    End If
                                End If
                            Else
                                ReDim tmPCff(0 To 1) As CFF
                                tmPCff(0) = tmCCff(0)
                            End If

                            If igDoEvent Then
                                DoEvents
                            End If
                            If (llPChfCode <> tmSdf.lChfCode) Or (ilPLineNo <> tmSdf.iLineNo) Or (llPFsfCode <> tmSdf.lFsfCode) Then
                                '12-16-04
                                mInitCounts tmPRdf, tmCClf.lChfCode, tmCClf.iLine, tmSdf.lFsfCode, ilGameNo, imPHour(), imPDay(), imPQH(), True
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            If (ilGameNoIndex = -1) Or (ilGameNoIndex = LBound(tmReSchdCgf)) Then
                                ilRet = mMoveSpotOntoLegalDate(llSDFCode, tmPCff())
                            Else
                                ilRet = BTRV_ERR_NONE
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilRet = BTRV_ERR_NONE Then
                                '4/11/11: Test if allowed to schedule across calendar month
                                mCheckXCal
                                llPChfCode = tmSdf.lChfCode
                                ilPLineNo = tmSdf.iLineNo
                                llPFsfCode = tmSdf.lFsfCode
                                imPAdfCodeSLen = 0   'Advertiser code for last valid Separation computation
                                gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                llDate = gDateValue(slDate)
                                gGetLineSchParameters hmSsf, tgSsf(), lgSsfDate(), lgSsfRecPos(), llDate, imCVefCode, tmSdf.iAdfCode, ilGameNo, tmPCff(), tmCClf, tmPRdf, lmPSepLength, lmPStartDateSLen, lmPEndDateSLen, lmPChfCode, imPLineNo, imPAdfCodeSLen, imPVehComp, imPHour(), imPDay(), imPQH(), imPAHour(), imPADay(), imPAQH(), lmPTBStartTime(), lmPTBEndTime(), lmEarliestAllowedDate, imSkip(), tmCChf.sType, tmCChf.iPctTrade, imBkQH, False, imPriceLevel
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If lmPEndDateSLen >= lmEarliestAllowedDate Then
                                    If lmPStartDateSLen < lmEarliestAllowedDate Then
                                        'Advance date to earliest allow date
                                        llDate = lmEarliestAllowedDate
                                        slDate = Format$(llDate, "m/d/yy")
                                    End If
                                    'Obtain conflict records
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    gObtainVcf hmVcf, imCVefCode, llDate, tmVcf0(), tmVcf6(), tmVcf7()
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If (igUsePreferred) And (lgReschIndex < llInitUBoundIndex) And (tmSdf.lChfCode > 0) Then
                                        ilFound = False
                                        For ilTest = LBound(tmPreferredInfo) To UBound(tmPreferredInfo) - 1 Step 1
                                            If (llDate >= tmPreferredInfo(ilTest).lSDate) And (llDate <= tmPreferredInfo(ilTest).lEDate) Then
                                                ilFound = True
                                                Exit For
                                            End If
                                        Next ilTest
                                        If Not ilFound Then
                                            For ilLoop = LBound(tmPCff) To UBound(tmPCff) - 1 Step 1
                                                gUnpackDateLong tmPCff(ilLoop).iStartDate(0), tmPCff(ilLoop).iStartDate(1), llFlightSDate
                                                gUnpackDateLong tmPCff(ilLoop).iEndDate(0), tmPCff(ilLoop).iEndDate(1), llFlightEDate
                                                If (llDate >= llFlightSDate) And (llDate <= llFlightEDate) Then
                                                    ilUpper = UBound(tmPreferredInfo)
                                                    If gPreferredDefined(tmCClf, tmPreferredInfo(ilUpper).iDays(), tmPreferredInfo(ilUpper).lSTime, tmPreferredInfo(ilUpper).lETime) Then
                                                        If (tmPCff(ilLoop).sDyWk <> "D") Then    'Weekly buy
                                                            tmPreferredInfo(ilUpper).iNoPrefSpots = (tmPCff(ilLoop).iSpotsWk * tgSaf(0).iPreferredPct) / 100
                                                        Else
                                                            ilDay = gWeekDayLong(llDate)
                                                            tmPreferredInfo(ilUpper).iNoPrefSpots = (tmPCff(ilLoop).iDay(ilDay) * tgSaf(0).iPreferredPct) / 100
                                                        End If
                                                        If tmPreferredInfo(ilUpper).iNoPrefSpots <= 0 Then
                                                            tmPreferredInfo(ilUpper).iNoPrefSpots = 1
                                                        End If
                                                        If (tmPCff(ilLoop).sDyWk <> "D") Then    'Weekly buy
                                                            tmPreferredInfo(ilUpper).lSDate = llDate
                                                            Do Until gWeekDayLong(tmPreferredInfo(ilUpper).lSDate) = 0
                                                                tmPreferredInfo(ilUpper).lSDate = tmPreferredInfo(ilUpper).lSDate - 1
                                                            Loop
                                                            For ilDay = 6 To 0 Step -1
                                                                If tmPCff(ilLoop).iDay(ilDay) <> 0 Then
                                                                    tmPreferredInfo(ilUpper).lEDate = tmPreferredInfo(ilUpper).lSDate + ilDay
                                                                    Exit For
                                                                End If
                                                            Next ilDay
                                                            If tmPreferredInfo(ilUpper).lSDate < llFlightSDate Then
                                                                tmPreferredInfo(ilUpper).lSDate = llFlightSDate
                                                            End If
                                                        Else
                                                            tmPreferredInfo(ilUpper).lSDate = llDate
                                                            tmPreferredInfo(ilUpper).lEDate = llDate
                                                        End If
                                                        'ReDim Preserve tmPreferredInfo(1 To ilUpper + 1) As PREFERREDINFO
                                                        ReDim Preserve tmPreferredInfo(0 To ilUpper + 1) As PREFERREDINFO
                                                    End If
                                                    Exit For
                                                End If
                                            Next ilLoop
                                        End If
                                    Else
                                        'ReDim tmPreferredInfo(1 To 1) As PREFERREDINFO
                                        ReDim tmPreferredInfo(0 To 0) As PREFERREDINFO
                                    End If
    
                                    If tmCClf.lRafCode > 0 Then
                                        If imRafPass = 0 Then
                                            gBuildStationsFromRAF hmRaf, hmSef, tmCClf.lRafCode, smClfInclExcl, tmStationsClf(), True
                                        End If
                                        lmRafCode = tmCClf.lRafCode
                                    Else
                                        'ReDim tmStationsClf(1 To 1) As INTKEY0
                                        ReDim tmStationsClf(0 To 0) As INTKEY0
                                        imRafPass = 1
                                        lmRafCode = 0
                                    End If
                                    If (igReschNoPasses = 2) And (sgPreemptPass <> "N") Then
                                        'Setup Preferred since coming from unschd
    
                                        slPreemptPass = sgPreemptPass
                                        sgPreemptPass = "N"
                                        mInitSchVar False
                                        If mSchPasses("S", slDate, tmCChf, tmCClf, tmPRdf, ilGameNo, lmPSepLength, lmPTBStartTime(), lmPTBEndTime(), imPAHour(), imPADay(), imPAQH(), imPriceLevel, 0, "YYYYYYY", 0, 86400) Then
                                            sgPreemptPass = slPreemptPass
                                            mInitSchVar False
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            mAdjustCgf ilGameNoIndex
                                            imRafPass = 0
                                            ilGameNoIndex = -1
                                            lgReschIndex = lgReschIndex + 1
                                            'ilRet = btrEndTrans(hmSdf)
                                            mAdjustCounts imPAHour(), imPADay(), imPAQH(), imPHour(), imPDay(), imPQH()
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                        Else
                                            sgPreemptPass = slPreemptPass
                                            mInitSchVar False
                                            If mSchPasses("S", slDate, tmCChf, tmCClf, tmPRdf, ilGameNo, lmPSepLength, lmPTBStartTime(), lmPTBEndTime(), imPAHour(), imPADay(), imPAQH(), imPriceLevel, 0, "YYYYYYY", 0, 86400) Then
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                mAdjustCgf ilGameNoIndex
                                                imRafPass = 0
                                                ilGameNoIndex = -1
                                                lgReschIndex = lgReschIndex + 1
                                                'ilRet = btrEndTrans(hmSdf)
                                                mAdjustCounts imPAHour(), imPADay(), imPAQH(), imPHour(), imPDay(), imPQH()
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                            Else
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If imRafPass = 0 Then
                                                    imRafPass = 1
                                                Else
                                                    If (ilGameNoIndex = -1) Or (ilGameNoIndex >= UBound(tmReSchdCgf) - 1) Then
                                                        If (ilGameNoIndex <> -1) Then
                                                            gCgfToCff tmCClf, tmReSchdCgf(0), tmPCff()
                                                        End If
                                                        ilRet = mMoveSpotOntoLegalDate(llSDFCode, tmPCff())
                                                        If igDoEvent Then
                                                            DoEvents
                                                        End If
                                                        If ilRet <> BTRV_ERR_NONE Then
                                                            'ilRet = btrAbortTrans(hmSdf)
                                                            gReSchSpots = False
                                                            Exit Function
                                                        Else
                                                            'ilRet = btrEndTrans(hmSdf)
                                                        End If
                                                        imRafPass = 0
                                                        ilGameNoIndex = -1
                                                        lgReschIndex = lgReschIndex + 1
                                                    Else
                                                        imRafPass = 0
                                                        ilGameNoIndex = ilGameNoIndex + 1
                                                    End If
                                                End If
                                            End If
                                        End If
                                    Else
                                        If mSchPasses("S", slDate, tmCChf, tmCClf, tmPRdf, ilGameNo, lmPSepLength, lmPTBStartTime(), lmPTBEndTime(), imPAHour(), imPADay(), imPAQH(), imPriceLevel, ilCallType, slCallTypeDays, llCallTypeStartTime, llCallTypeEndTime) Then
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            mAdjustCgf ilGameNoIndex
                                            imRafPass = 0
                                            ilGameNoIndex = -1
                                            lgReschIndex = lgReschIndex + 1
                                            'ilRet = btrEndTrans(hmSdf)
                                            mAdjustCounts imPAHour(), imPADay(), imPAQH(), imPHour(), imPDay(), imPQH()
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                        Else
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If imRafPass = 0 Then
                                                imRafPass = 1
                                            Else
                                                If (ilGameNoIndex = -1) Or (ilGameNoIndex >= UBound(tmReSchdCgf) - 1) Then
                                                    If (ilGameNoIndex <> -1) Then
                                                        gCgfToCff tmCClf, tmReSchdCgf(0), tmPCff()
                                                    End If
                                                    imRafPass = 0
                                                    ilRet = mMoveSpotOntoLegalDate(llSDFCode, tmPCff())
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    If ilRet <> BTRV_ERR_NONE Then
                                                        'ilRet = btrAbortTrans(hmSdf)
                                                        gReSchSpots = False
                                                        Exit Function
                                                    Else
                                                        'ilRet = btrEndTrans(hmSdf)
                                                    End If
                                                    ilGameNoIndex = -1
                                                    lgReschIndex = lgReschIndex + 1
                                                Else
                                                    imRafPass = 0
                                                    ilGameNoIndex = ilGameNoIndex + 1
                                                End If
                                            End If
                                        End If
                                    End If
                                Else
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If (ilGameNoIndex = -1) Or (ilGameNoIndex >= UBound(tmReSchdCgf) - 1) Then
                                        If (ilGameNoIndex <> -1) Then
                                            gCgfToCff tmCClf, tmReSchdCgf(0), tmPCff()
                                        End If
                                        imRafPass = 0
                                        ilRet = mMoveSpotOntoLegalDate(llSDFCode, tmPCff())
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If ilRet <> BTRV_ERR_NONE Then
                                            'ilRet = btrAbortTrans(hmSdf)
                                            gReSchSpots = False
                                            Exit Function
                                        Else
                                            'ilRet = btrEndTrans(hmSdf)
                                        End If
                                        lgReschIndex = lgReschIndex + 1
                                    Else
                                        imRafPass = 0
                                        ilGameNoIndex = ilGameNoIndex + 1
                                    End If
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                            Else
                                imRafPass = 0
                                lgReschIndex = lgReschIndex + 1
                                'ilRet = btrAbortTrans(hmSdf)
                                gReSchSpots = False
                                Exit Function
                            End If
                        Else
                            imRafPass = 0
                            lgReschIndex = lgReschIndex + 1
                            'ilRet = btrAbortTrans(hmSdf)
                            gReSchSpots = False
                            Exit Function
                        End If
                    Else
                        imRafPass = 0
                        lgReschIndex = lgReschIndex + 1
                        'ilRet = btrAbortTrans(hmSdf)
                    End If
                Else
                    imRafPass = 0
                    lgReschIndex = lgReschIndex + 1
                    'ilRet = btrAbortTrans(hmSdf)
                    gReSchSpots = False
                    Exit Function
                End If
            Else
                imRafPass = 1
                lmRafCode = 0
                'ilVefCode = tmSdf.iVefCode  'Booked vehicle is retained with the spot
                tmMtfSrchKey0.lCode = tmSdf.lSmfCode
                ilRet = btrGetEqual(hmMtf, tmMtf, imMtfRecLen, tmMtfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                If ilRet = BTRV_ERR_NONE Then
                    gUnpackTimeLong tmMtf.iToStartTime(0), tmMtf.iToStartTime(1), False, llToSTime
                    gUnpackTimeLong tmMtf.iToEndTime(0), tmMtf.iToEndTime(1), True, llToETime
                    ilToVefCode = tmMtf.iSdfVefCode
                    ilToRdfCode = tmMtf.iToRdfCode
                    llSDFCode = lgReschSdfCode(lgReschIndex)
                    If (igReschNoPasses = 2) And (sgPreemptPass <> "N") Then
                        slPreemptPass = sgPreemptPass
                        sgPreemptPass = "N"
                        If tmSdf.sSpotType = "X" Then
                            ilRet = gMGSchSpots(True, "O", llSDFCode, ilToRdfCode, ilToVefCode, llToSTime, llToETime, tmMtf.iDays())
                        Else
                            ilRet = gMGSchSpots(True, "G", llSDFCode, ilToRdfCode, ilToVefCode, llToSTime, llToETime, tmMtf.iDays())
                        End If
                        sgPreemptPass = slPreemptPass
                        If (Not ilRet) Then
                            If tmSdf.sSpotType = "X" Then
                                ilRet = gMGSchSpots(True, "O", llSDFCode, ilToRdfCode, ilToVefCode, llToSTime, llToETime, tmMtf.iDays())
                            Else
                                ilRet = gMGSchSpots(True, "G", llSDFCode, ilToRdfCode, ilToVefCode, llToSTime, llToETime, tmMtf.iDays())
                            End If
                        End If
                    Else
                        If tmSdf.sSpotType = "X" Then
                            ilRet = gMGSchSpots(True, "O", llSDFCode, ilToRdfCode, ilToVefCode, llToSTime, llToETime, tmMtf.iDays())
                        Else
                            ilRet = gMGSchSpots(True, "G", llSDFCode, ilToRdfCode, ilToVefCode, llToSTime, llToETime, tmMtf.iDays())
                        End If
                    End If
                Else
                    gReSchSpots = False
                    Exit Function
                End If
                lgReschIndex = lgReschIndex + 1
            End If
        Else
            lgReschIndex = lgReschIndex + 1
            If ilSpotRet <> BTRV_ERR_NONE Then
                'ilRet = btrAbortTrans(hmSdf)
                gReSchSpots = False
                Exit Function
            End If
        End If
        If igDoEvent Then
            DoEvents
        End If
    Loop
    gReSchSpots = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:gCntrSch                        *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Schedule specified contract     *
'*                 (new and changed contract)          *
'*                 (called by CntrSch.Frm-cmcSchedule) *
'*                                                     *
'*******************************************************
'Function gSchCntr(lCntrCode As Long, lbcNotSchd As Control, slAdvtCntr As String) As Integer
Function gSchCntr(lCntrCode As Long, lbcNotSchd As Control, slAdvtCntr As String) As Integer
'
'   ilRet = gSchCntr(lCode)
'   Where:
'       lCode (I)- Contract code number
'       ilRet (O)- True=Contract scheduled;
'                  False=Error occurred during scheduling
'
    Dim ilRet As Integer
    Dim tlClf As CLF
    Dim tlClfSrchKey As CLFKEY0
    Dim tlClfExt As CLFEXT
    Dim tlCff As CFF
    Dim tlCffSrchKey As CFFKEY0
    Dim tlRdfSrchKey As INTKEY0
    Dim llNoRec As Long
    Dim ilOffSet As Integer
    Dim ilExtLen As Integer
    Dim llRecPos As Long       'Record location
    Dim ilClfUpperBound As Integer
    Dim ilCffUpperBound As Integer
    Dim ilLoop As Integer
    Dim ilAddLine As Integer
    Dim llLcfEarliestDate As Long
    Dim llLcfLatestDate As Long
    Dim llClfEndDate As Long
    Dim slDate As String
    Dim llDate As Long
    Dim ilLogDate0 As Integer
    Dim ilLogDate1 As Integer
    Dim llSundayDate As Long
    Dim llBypassStartDate As Long
    Dim llBypassEndDate As Long
    Dim slLength As String
    Dim ilSchLine As Integer
    Dim llDeleteDate As Long
    Dim ilVehChgProcessed As Integer
    Dim ilCVsf As Integer
    Dim ilPVsf As Integer
    Dim llPChfRecPos As Long
    Dim llPClfRecPos As Long
    Dim llPCode As Long
    Dim llSvPCode As Long
    'Dim ilPRemoteID As Integer
    'Dim llPAutoCode As Long
    Dim ilCff As Integer
    Dim ilPass As Integer
    Dim ilLRet As Integer
    Dim slMsg As String
    Dim slSchStatus As String
    Dim ilRemoveCopyCalled As Integer  'True if mRemoveCopy called for contract
    Dim ilBeginTran As Integer
    Dim slUserName As String
    Dim llSvClfChfCode As Long
    Dim llTClfChfCode As Long
    Dim ilVef As Integer
    Dim ilCgf As Integer
    '8/4/11: Handle case where games removed
    Dim ilCCgf As Integer
    Dim ilFound As Integer
    Dim ilCSch As Integer
    Dim ilPSch As Integer
    Dim slVefType As String
    'ReDim tmClfExt(1 To 1) As CLFEXT
    ReDim tmClfExt(0 To 0) As CLFEXT
    Dim ilLock As Integer
    '3/8/13: Add date
    Dim llCgfDate As Long
    Dim llCgfMoDate As Long
    '3/17/13: add date
    Dim llGameDate As Long
    '4/11/19
    Dim ilFirstLnToProcess As Integer
    Dim ilAPIResult As Integer 'Megaphone API
    smScheduleException = ""
    sgCntrLineDetail = ""
    bgMegaphoneContract = False
    
    mInitSchVar True
    If igDoEvent Then
        DoEvents
    End If
    If igRnd Then
        Randomize   'Remove this if same results are to be obtained
    End If
    If igDoEvent Then
        DoEvents
    End If
    ilBeginTran = False
    'ilRet = btrBeginTrans(hmChf, 1000)
    'If ilRet <> BTRV_ERR_NONE Then
    '    slMsg = "I/O Error:" & Str$(ilRet) & " Begin Transactions"
    '    GoSub ErrorMsg
    '    Exit Function
    'End If
    ilClfUpperBound = UBound(tmClfExt)
    tmChfSrchKey.lCode = lCntrCode
    ''ilRet = btrGetEqual(hmChf, tmCChf, imChfRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
    'ilRet = btrGetEqual(hmChf, tmCChf, imChfRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_MULT_NOWAIT, SETFORREADONLY)
    'If ilRet = BTRV_ERR_REC_LOCKED Then
    ilRet = btrGetEqual(hmCHF, tmCChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
    'lmLockRecCode = gCreateLockRec(hmRlf, "C", "S", tmCChf.lCntrNo, True, slUserName)
    
    ilLock = 0
    On Error GoTo ErrorLock
    ilLoop = LBound(tgLockCntr)
    If ilLock = 0 Then
        ilLock = 1
        For ilLoop = LBound(tgLockCntr) To UBound(tgLockCntr) - 1 Step 1
            If tgLockCntr(ilLoop).lCntrNo = tmCChf.lCntrNo Then
                lmLockRecCode = tgLockCntr(ilLoop).lLockRecCode
                tgLockCntr(ilLoop).lLockRecCode = 0
                ilLock = 0
                Exit For
            End If
        Next ilLoop
    End If
    If ilLock = 1 Then
        lmLockRecCode = gCreateLockRec(hmRlf, "C", "S", tmCChf.lCntrNo, True, slUserName)
    End If
    If lmLockRecCode = 0 Then
        slMsg = slAdvtCntr & " being Altered by " & slUserName & ", Reschedule Later"
        '6/4/16: Replace GoSub
        'GoSub ErrorMsg
        mErrorMsg slMsg, lbcNotSchd
        gSchCntr = True
        sgCntrSchStatus = "Being Altered by " & slUserName
        bgCntrSchError = True
        Exit Function
    End If
    
    If ilRet <> BTRV_ERR_NONE Then
        If ilRet >= 30000 Then
            ilRet = csiHandleValue(0, 7)
        End If
        slMsg = "I/O Error:" & str$(ilRet) & " Get = CHF"
        '6/4/16: Replace GoSub
        'GoSub ErrorMsg
        mErrorMsg slMsg, lbcNotSchd
        gSchCntr = False
        sgCntrSchStatus = slMsg
        bgCntrSchError = True
        Exit Function
    End If
    If igDoEvent Then
        DoEvents
    End If
    ilRet = btrGetPosition(hmCHF, lmCChfRecPos)
    If ilRet <> BTRV_ERR_NONE Then
        If ilRet >= 30000 Then
            ilRet = csiHandleValue(0, 7)
        End If
        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Position CHF"
        '6/4/16: Replace GoSub
        'GoSub ErrorMsg
        mErrorMsg slMsg, lbcNotSchd
        gSchCntr = False
        sgCntrSchStatus = "CHF: I/O Error:" & str$(ilRet)
        bgCntrSchError = True
        Exit Function
    End If
    
    'Find previous header
    If igDoEvent Then
        DoEvents
    End If
    slSchStatus = "F"
    tmChfSrchKey1.lCntrNo = tmCChf.lCntrNo
    tmChfSrchKey1.iCntRevNo = tmCChf.iCntRevNo - 1
    tmChfSrchKey1.iPropVer = 32000
    ilRet = btrGetGreaterOrEqual(hmCHF, tmPChf, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmPChf.lCntrNo = tmCChf.lCntrNo) And ((tmPChf.sSchStatus <> "F") And (tmPChf.sSchStatus <> "M"))
        If igDoEvent Then
            DoEvents
        End If
        ilRet = btrGetNext(hmCHF, tmPChf, imCHFRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    If (ilRet <> BTRV_ERR_NONE) Or (tmPChf.lCntrNo <> tmCChf.lCntrNo) Or ((tmPChf.sSchStatus <> "F") And (tmPChf.sSchStatus <> "M")) Then
        tmPChf = tmCChf
        tmPChf.lCode = 0    'Indicator that Previous didn't exist
        llPChfRecPos = 0
    Else
        ilRet = btrGetPosition(hmCHF, llPChfRecPos)
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Position CHF"
            '6/4/16: Replace GoSub
            'GoSub ErrorMsg
            mErrorMsg slMsg, lbcNotSchd
            gSchCntr = False
            sgCntrSchStatus = "CHF: I/O Error:" & str$(ilRet)
            bgCntrSchError = True
            Exit Function
        End If
        slSchStatus = tmPChf.sSchStatus
    End If
    
    '------------------------------------------
    'Megaphone API
    If tmCChf.iAdServDlvyStatus <> DeliveryStatus_Pushed Then
        If igMegaphoneAvfCode <> 0 And sgMegaphoneOrganizationID <> "" And sgMegaphoneRootURL <> "" And sgMegaphonePassword <> "" Then
            'Create Vendor Campaign (Contract)
            bgMegaphoneContract = False
            ilAPIResult = mMegaphone_CreateUpdateCampaign(tmCChf, hmPcf)
            Select Case ilAPIResult
                Case FunctionResult_NA
                    sgCntrSchStatus = "Megaphone N/A"
                    
                Case FunctionResult_Success
                    'Create Vendor Campaign Orders (Digital Lines)
                    ilAPIResult = mMegaphone_CreateUpdateCampaignOrders(tmCChf.lCode, tmCChf.lCntrNo, tmCPcf)
                    Select Case ilAPIResult
                        Case FunctionResult_NA
                            sgCntrSchStatus = "Megaphone N/A"
                        
                        Case FunctionResult_Success
                            bgMegaphoneContract = True
                            sgCntrSchStatus = "Success sending to Megaphone: " & tmCChf.lCntrNo
                            sgAPIActivityLog = sgAPIActivityLog & "Success Sending Contract" & vbCrLf
                            mLogAPIMsg sgAPIActivityLog
                            sgAPIActivityLog = ""
                            mUpdateDigitalDlvyStatus tmCChf.lCode, DeliveryStatus_Pushed
                            
                            'Line validation
                            sgCntrSchStatus = "Validating: " & tmCChf.lCntrNo
                            ilAPIResult = mMegaphone_ValidateLines(tmCChf.lCode, tmCChf.lCntrNo, tmCPcf)
                            Select Case ilAPIResult
                                Case FunctionResult_NA
                                Case FunctionResult_Success
                                    sgCntrSchStatus = " - Success validating campaign orders: " & tmCChf.lCntrNo
                                    sgAPIActivityLog = sgAPIActivityLog & "Success validating campaign orders" & vbCrLf
                                Case FunctionResult_Failure
                                    ilLRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
                                    If sgCntrSchStatus = "" Then
                                        sgCntrSchStatus = " ! Megaphone Failed to validate Campaign Orders"
                                    End If
                                    bgCntrSchError = True
                                    gSchCntr = True
                                    mLogAPIMsg sgAPIActivityLog
                                    Exit Function
                            End Select
                            
                        Case FunctionResult_Failure
                            bgMegaphoneContract = True
                            ilLRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
                            If sgCntrSchStatus = "" Then
                                sgCntrSchStatus = "Megaphone Failed to Create/Update Campaign Order"
                            End If
                            bgCntrSchError = True
                            gSchCntr = True
                            mLogAPIMsg sgAPIActivityLog
                            Exit Function
                            
                    End Select
                    
                Case FunctionResult_Failure
                    bgMegaphoneContract = True
                    ilLRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
                    If sgCntrSchStatus = "" Then
                        sgCntrSchStatus = "Megaphone Failed to Create/Update Campaign"
                    End If
                    bgCntrSchError = True
                    gSchCntr = True
                    mLogAPIMsg sgAPIActivityLog
                    Exit Function
            End Select
        Else
            'Megaphone is Disabled or not used
            If igMegaphoneAvfCode > 0 Then
                mLoadPCFRecords tmCChf.lCode, hmPcf
                If mGetContractHasVendorVehicle(igMegaphoneAvfCode, tmCPcf, tmCChf.lCntrNo) Then
                    bgMegaphoneContract = True
                    mLogAPIMsg "Warning: Megaphone is disabled!  Check AdServer Vendor settings."
                    ilRet = MsgBox("Megaphone is disabled and contract " & tmCChf.lCntrNo & " has vehicles configured for Megaphone!" & vbCrLf & "Do you want to Cancel Scheduling?" & vbCrLf & vbCrLf & "- Press YES to cancel Scheduling" & vbCrLf & "- Press NO to Ignore disabled Megaphone and schedule contract without sending to Megaphone (Not recommended)" & vbCrLf, vbCritical + vbYesNo, "Megaphone API Warning")
                    If ilRet = vbYes Then
                        ilLRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
                        sgCntrSchStatus = "Cancelled Scheduling due to Disabled Megaphone warning."
                        bgCntrSchError = True
                        gSchCntr = False 'Cancel the whole scheduing process
                        'mLogAPIMsg "Cancelled " & tmCChf.lCntrNo & " Scheduling due to Megaphone is disabled."
                        Exit Function
                    Else
                        sgAPIActivityLog = sgAPIActivityLog & "WARNING: Contract " & tmCChf.lCntrNo & " was scheduled in Counterpoint despite Megaphone being Disabled!" & vbCrLf
                        mLogAPIMsg sgAPIActivityLog
                        smScheduleException = "Not sent to Megaphone!"
                    End If
                End If
            End If
        End If
    Else
        sgCntrSchStatus = "Contract #" & tmCChf.lCntrNo & ": Already pushed relevant data to Megaphone."
        sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
        mLogAPIMsg sgAPIActivityLog
    End If
    
    sgCntrSchStatus = "Scheduling Order..."
    'ilLRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
    'Exit Function
    
    '------------------------------------------
    If igDoEvent Then
        DoEvents
    End If
    For ilPass = 1 To 2 Step 1
        If igDoEvent Then
            DoEvents
        End If
        btrExtClear hmClf   'Clear any previous extend operation
        If ilPass = 1 Then
            tlClfSrchKey.lChfCode = tmCChf.lCode
        Else
            tlClfSrchKey.lChfCode = tmPChf.lCode
        End If
        tlClfSrchKey.iLine = 0
        tlClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
        tlClfSrchKey.iPropVer = 32000 ' 0 show latest version
        ilRet = btrGetGreaterOrEqual(hmClf, tlClf, imClfRecLen, tlClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_END_OF_FILE Then   'No new lines
            If (ilRet <> BTRV_ERR_NONE) And ((tmCChf.iHdChg = 0) Or (tmPChf.lCode = 0)) Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get >= CLF"
                '6/4/16: Replace GoSub
                'GoSub ErrorMsg
                mErrorMsg slMsg, lbcNotSchd
                sgCntrSchStatus = slMsg
                bgCntrSchError = True
                gSchCntr = False
                Exit Function
            End If
            If igDoEvent Then
                DoEvents
            End If
            If (ilRet = BTRV_ERR_NONE) Then
                'llNoRec = btrRecords(hmClf) \ Len(tlClfExt)'Obtain number of records
                llNoRec = gExtNoRec(Len(tlClfExt)) 'Obtain number of records
                Call btrExtSetBounds(hmClf, llNoRec, -1, "UC", "CLFEXTPK", CLFEXTPK) 'Set extract limits (all records)
                ilOffSet = gFieldOffset("Clf", "ClfChfCode")
                If ilPass = 1 Then
                    ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_INT, ilOffSet, 4, BTRV_EXT_EQUAL, BTRV_EXT_LAST_TERM, tmCChf.lCode, 4)
                    'ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_INT, ilOffset, 4, BTRV_EXT_EQUAL, BTRV_EXT_AND, tmCChf.lCode, 4)
                    'tlCharTypeBuff.sType = "A"  'Old contract lines which requires scheduling
                    'ilOffset = gFieldOffset("Clf", "ClfSchStatus")
                    'ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_STRING, ilOffset, 1, BTRV_EXT_EQUAL, BTRV_EXT_OR, tlCharTypeBuff, 1)
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Add Logical CLF"
                    '    GoSub ErrorMsg
                    '    Exit Function
                    'End If
                    'tlCharTypeBuff.sType = "I"  'interrupted scheduling
                    'ilOffset = gFieldOffset("Clf", "ClfSchStatus")
                    'ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_STRING, ilOffset, 1, BTRV_EXT_EQUAL, BTRV_EXT_OR, tlCharTypeBuff, 1)
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Add Logical CLF"
                    '    GoSub ErrorMsg
                    '    Exit Function
                    'End If
                    'tlCharTypeBuff.sType = "F"  'Fully scheduled contract lines (this only required if header changed)
                    'ilOffset = gFieldOffset("Clf", "ClfSchStatus")
                    'ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_STRING, ilOffset, 1, BTRV_EXT_EQUAL, BTRV_EXT_OR, tlCharTypeBuff, 1)
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Add Logical CLF"
                    '    GoSub ErrorMsg
                    '    Exit Function
                    'End If
                    'tlCharTypeBuff.sType = "N"  'New contract which requires scheduling
                    'ilOffset = gFieldOffset("Clf", "ClfSchStatus")
                    'ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_STRING, ilOffset, 1, BTRV_EXT_EQUAL, BTRV_EXT_LAST_TERM, tlCharTypeBuff, 1)
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Add Logical CLF"
                    '    GoSub ErrorMsg
                    '    Exit Function
                    'End If
                Else
                    ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_INT, ilOffSet, 4, BTRV_EXT_EQUAL, BTRV_EXT_LAST_TERM, tmPChf.lCode, 4)
                    'ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_INT, ilOffset, 4, BTRV_EXT_EQUAL, BTRV_EXT_AND, tmPChf.lCode, 4)
                    'tlCharTypeBuff.sType = slSchStatus      '"F"  'Fully scheduled contract lines (this only required if header changed)
                    'ilOffset = gFieldOffset("Clf", "ClfSchStatus")
                    'ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_STRING, ilOffset, 1, BTRV_EXT_EQUAL, BTRV_EXT_LAST_TERM, tlCharTypeBuff, 1)
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Add Logical CLF"
                    '    GoSub ErrorMsg
                    '    Exit Function
                    'End If
                End If
                ilExtLen = Len(tlClfExt)  'Extract operation record size
                ilOffSet = gFieldOffset("Clf", "ClfChfCode")
                ilRet = btrExtAddField(hmClf, ilOffSet, ilExtLen - 3) 'Extract ChfCode; Line #, Version and vehicle
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Add Field CLF"
                    '6/4/16: Replace GoSub
                    'GoSub ErrorMsg
                    mErrorMsg slMsg, lbcNotSchd
                    sgCntrSchStatus = slMsg
                    bgCntrSchError = True
                    gSchCntr = False
                    Exit Function
                End If
                If igDoEvent Then
                    DoEvents
                End If
                ilOffSet = gFieldOffset("Clf", "ClfSchStatus")
                ilRet = btrExtAddField(hmClf, ilOffSet, 1) 'Extract SchStatus
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Add Field CLF"
                    '6/4/16: Replace GoSub
                    'GoSub ErrorMsg
                    mErrorMsg slMsg, lbcNotSchd
                    gSchCntr = False
                    Exit Function
                End If
                If igDoEvent Then
                    DoEvents
                End If
                ilOffSet = gFieldOffset("Clf", "ClfPropVer")
                ilRet = btrExtAddField(hmClf, ilOffSet, 2) 'Extract Proposal Number
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Add Field CLF"
                    '6/4/16: Replace GoSub
                    'GoSub ErrorMsg
                    mErrorMsg slMsg, lbcNotSchd
                    sgCntrSchStatus = slMsg
                    bgCntrSchError = True
                    gSchCntr = False
                    Exit Function
                End If
                'ilRet = btrExtGetNextExt(hmClf)    'Extract record
                ilRet = btrExtGetNext(hmClf, tlClfExt, ilExtLen, llRecPos)
                If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
                    If igDoEvent Then
                        DoEvents
                    End If
                    If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Ext Get CLF"
                        '6/4/16: Replace GoSub
                        'GoSub ErrorMsg
                        mErrorMsg slMsg, lbcNotSchd
                        sgCntrSchStatus = slMsg
                        bgCntrSchError = True
                        gSchCntr = False
                        Exit Function
                    End If
                    'ilRet = btrExtGetFirst(hmClf, tlClfExt, ilExtLen, llRecPos)
                    Do While ilRet = BTRV_ERR_REJECT_COUNT
                        ilRet = btrExtGetNext(hmClf, tlClfExt, ilExtLen, llRecPos)
                    Loop
                    Do While ilRet = BTRV_ERR_NONE
                        If igDoEvent Then
                            DoEvents
                        End If
                        ilAddLine = False
                        If ilPass = 1 Then
                            If (tlClfExt.sSchStatus = "A") Or (tlClfExt.sSchStatus = "I") Or (tlClfExt.sSchStatus = "F") Or (tlClfExt.sSchStatus = "N") Then
                                ilAddLine = True
                            End If
                        Else
                            If tlClfExt.sSchStatus = slSchStatus Then
                                ilAddLine = True
                            End If
                        End If
                        If ilAddLine Then
                            For ilLoop = LBound(tmClfExt) To UBound(tmClfExt) - 1 Step 1
                                If tmClfExt(ilLoop).iLine = tlClfExt.iLine Then
                                    ilAddLine = False
                                    If tlClfExt.iCntRevNo > tmClfExt(ilLoop).iCntRevNo Then
                                        tmClfExt(ilLoop).iCntRevNo = tlClfExt.iCntRevNo
                                        tmClfExt(ilLoop).iPropVer = tlClfExt.iPropVer
                                        tmClfExt(ilLoop).lChfCode = llRecPos
                                    End If
                                    Exit For
                                End If
                            Next ilLoop
                        End If
                        If ilAddLine Then
                            'If cancel before start- ignore line
                            ilRet = btrGetDirect(hmClf, tmCClf, imClfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                            If ilRet <> BTRV_ERR_NONE Then
                                If ilRet >= 30000 Then
                                    ilRet = csiHandleValue(0, 7)
                                End If
                                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CLF"
                                '6/4/16: Replace GoSub
                                'GoSub ErrorMsg
                                mErrorMsg slMsg, lbcNotSchd
                                sgCntrSchStatus = slMsg
                                bgCntrSchError = True
                                gSchCntr = False
                                Exit Function
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            ilSchLine = True
                            'Test for new and cancelled before start
                            If (tmCClf.sSchStatus = "N") Then
                                'Obtain flight to test if cancelled before start
                                imCffRecLen = Len(tlCff) 'btrRecordLength(hlChf)  'Get and save record length
                                tlCffSrchKey.lChfCode = tmCClf.lChfCode
                                tlCffSrchKey.iClfLine = tmCClf.iLine
                                tlCffSrchKey.iCntRevNo = tmCClf.iCntRevNo
                                tlCffSrchKey.iPropVer = tmCClf.iPropVer
                                tlCffSrchKey.iStartDate(0) = 0
                                tlCffSrchKey.iStartDate(1) = 0
                                ilRet = btrGetGreaterOrEqual(hmCff, tlCff, imCffRecLen, tlCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                If igDoEvent Then
                                    DoEvents
                                End If
                               If (ilRet = BTRV_ERR_NONE) And (tlCff.lChfCode = tmCClf.lChfCode) And (tlCff.iClfLine = tmCClf.iLine) And (tlCff.iCntRevNo = tmCClf.iCntRevNo) And (tlCff.iPropVer = tmCClf.iPropVer) Then
                                    If (tmCClf.sDelete = "Y") Or (tlCff.iEndDate(1) < tlCff.iStartDate(1)) Or ((tlCff.iEndDate(1) = tlCff.iStartDate(1)) And (tlCff.iEndDate(0) < tlCff.iStartDate(0))) Then
                                        Do
                                            ilRet = btrGetDirect(hmClf, tmCClf, imClfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                            If ilRet <> BTRV_ERR_NONE Then
                                                If ilRet >= 30000 Then
                                                    ilRet = csiHandleValue(0, 7)
                                                End If
                                                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CLF"
                                                '6/4/16: Replace GoSub
                                                'GoSub ErrorMsg
                                                mErrorMsg slMsg, lbcNotSchd
                                                sgCntrSchStatus = slMsg
                                                bgCntrSchError = True
                                                gSchCntr = False
                                                Exit Function
                                            End If
                                            'tmSRec = tmCClf
                                            'ilRet = gGetByKeyForUpdate("CLF", hmClf, tmSRec)
                                            'tmCClf = tmSRec
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            'If ilRet <> BTRV_ERR_NONE Then
                                            '    If ilRet >= 30000 Then
                                            '        ilRet = csiHandleValue(0, 7)
                                            '    End If
                                            '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CLF"
                                            '    GoSub ErrorMsg
                                            '    Exit Function
                                            'End If
                                            tmCClf.sSchStatus = "F"
                                            ilRet = btrUpdate(hmClf, tmCClf, imClfRecLen)
                                        Loop While ilRet = BTRV_ERR_CONFLICT
                                        If ilRet <> BTRV_ERR_NONE Then
                                            If ilRet >= 30000 Then
                                                ilRet = csiHandleValue(0, 7)
                                            End If
                                            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Update CLF"
                                            '6/4/16: Replace GoSub
                                            'GoSub ErrorMsg
                                            mErrorMsg slMsg, lbcNotSchd
                                            sgCntrSchStatus = slMsg
                                            bgCntrSchError = True
                                            gSchCntr = False
                                            Exit Function
                                        End If
                                        ilSchLine = False
                                    End If
                                End If
                            End If
                            If ilSchLine Then
                                ilVef = gBinarySearchVef(tmCClf.iVefCode)
                                If ilVef <> -1 Then
                                    slVefType = tgMVef(ilVef).sType
                                Else
                                    slVefType = ""
                                End If
                                If (slVefType <> "R") And (tmCClf.sType <> "O") And (tmCClf.sType <> "A") And (tmCClf.sType <> "E") Then
                                    'If Library not build- bypass scheduling
                                    'Start Vehicle loop
                                    tmVefSrchKey.iCode = tlClfExt.iVefCode
                                    ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If ilRet <> BTRV_ERR_NONE Then
                                        If ilRet >= 30000 Then
                                            ilRet = csiHandleValue(0, 7)
                                        End If
                                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Equal VEF"
                                        '6/4/16: Replace GoSub
                                        'GoSub ErrorMsg
                                        mErrorMsg slMsg, lbcNotSchd
                                        sgCntrSchStatus = slMsg
                                        bgCntrSchError = True
                                        gSchCntr = False
                                        Exit Function
                                    End If
                                    If tmVef.sType = "V" Then
                                        tmVsfSrchKey.lCode = tmVef.lVsfCode
                                        ilRet = btrGetEqual(hmVsf, tmCVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If ilRet <> BTRV_ERR_NONE Then
                                            If ilRet >= 30000 Then
                                                ilRet = csiHandleValue(0, 7)
                                            End If
                                            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Equal VSF"
                                            '6/4/16: Replace GoSub
                                            'GoSub ErrorMsg
                                            mErrorMsg slMsg, lbcNotSchd
                                            sgCntrSchStatus = slMsg
                                            bgCntrSchError = True
                                            gSchCntr = False
                                            Exit Function
                                        End If
                                        'Store the virtual vehicle as the first vehicle
                                        'For ilCVsf = UBound(tmCVsf.iFSCode) To LBound(tmCVsf.iFSCode) + 1 Step -1
                                        '    tmCVsf.iFSCode(ilCVsf) = tmCVsf.iFSCode(ilCVsf - 1)
                                        '    tmCVsf.iNoSpots(ilCVsf) = tmCVsf.iNoSpots(ilCVsf - 1)
                                        'Next ilCVsf
                                        'tmCVsf.iFSCode(LBound(tmCVsf.iFSCode)) = tlClfExt.iVefCode
                                        'tmCVsf.iNoSpots(LBound(tmCVsf.iFSCode)) = 1
                                        ReDim tmCSchVehInfo(0 To 0) As SCHVEHINFO
                                        tmCSchVehInfo(0).iVefCode = tlClfExt.iVefCode
                                        tmCSchVehInfo(0).iVirtSpotAdj = 1
                                        tmCSchVehInfo(0).iGameNo = 0
                                        tmCSchVehInfo(0).iGameIndex = -1
                                        For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
                                            If tmCVsf.iFSCode(ilCVsf) > 0 Then
                                                ReDim Preserve tmCSchVehInfo(0 To UBound(tmCSchVehInfo) + 1) As SCHVEHINFO
                                                tmCSchVehInfo(UBound(tmCSchVehInfo)).iVefCode = tmCVsf.iFSCode(ilCVsf)
                                                tmCSchVehInfo(UBound(tmCSchVehInfo)).iVirtSpotAdj = tmCVsf.iNoSpots(ilCVsf)
                                                tmCSchVehInfo(UBound(tmCSchVehInfo)).iGameNo = 0
                                                tmCSchVehInfo(UBound(tmCSchVehInfo)).iGameIndex = -1
                                            End If
                                        Next ilCVsf

                                    Else
                                        'For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
                                        '    tmCVsf.iFSCode(ilCVsf) = 0
                                        '    tmCVsf.iNoSpots(LBound(tmCVsf.iFSCode)) = 0
                                        'Next ilCVsf
                                        'tmCVsf.iFSCode(LBound(tmCVsf.iFSCode)) = tlClfExt.iVefCode
                                        'tmCVsf.iNoSpots(LBound(tmCVsf.iFSCode)) = 1
                                        ReDim tmCSchVehInfo(0 To 0) As SCHVEHINFO
                                        tmCSchVehInfo(0).iVefCode = tlClfExt.iVefCode
                                        tmCSchVehInfo(0).iVirtSpotAdj = 1
                                        tmCSchVehInfo(0).iGameNo = 0
                                        tmCSchVehInfo(0).iGameIndex = -1
                                    End If
                                    'For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
                                    '    If tmCVsf.iFSCode(ilCVsf) > 0 Then
                                    For ilCSch = 0 To UBound(tmCSchVehInfo) Step 1
                                            llLcfLatestDate = gGetLatestLCFDate(hmLcf, "C", tmCSchVehInfo(ilCSch).iVefCode)    'tmCVsf.iFSCode(ilCVsf))
                                            If llLcfLatestDate <= 0 Then    'Library calendar not created- bypass scheduling
                                                tmVefSrchKey.iCode = tmCSchVehInfo(ilCSch).iVefCode   'tmCVsf.iFSCode(ilCVsf)
                                                ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " Programming Not Defined: " & Trim$(tmVef.sName)
                                                '6/4/16: Replace GoSub
                                                'GoSub ErrorMsg
                                                mErrorMsg slMsg, lbcNotSchd
                                                sgCntrSchStatus = slMsg
                                                bgCntrSchError = True
                                                gSchCntr = False
                                                Exit Function
                                            End If
                                            ''Test if Special and programming exist- Removed 1/22/98
                                            'ilRet = gLCFTFNExist(hmLcf, "O", "C", tmCVsf.iFSCode(ilCVsf))
                                            'If Not ilRet Then
                                            '    Do While gWeekDayLong(llLcfLatestDate) <> 6
                                            '        llLcfLatestDate = llLcfLatestDate + 1
                                            '    Loop
                                            '    gUnpackDateLong tmCClf.iEndDate(0), tmCClf.iEndDate(1), llDate
                                            '    If llDate > llLcfLatestDate Then
                                            '        tmVefSrchKey.iCode = tmCVsf.iFSCode(ilCVsf)
                                            '        ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                            '        slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " Programming Missing after: " & Format$(llLcfLatestDate, "m/d/yy") & " on " & Trim$(tmVef.sName)
                                            '        GoSub ErrorMsg
                                            '        Exit Function
                                            '    End If
                                            'End If
                                    '    End If
                                    'Next ilCVsf
                                    Next ilCSch
                                    'End Vehicle Loop
                                End If
                                tmClfExt(ilClfUpperBound).iLine = tlClfExt.iLine
                                tmClfExt(ilClfUpperBound).iCntRevNo = tlClfExt.iCntRevNo
                                tmClfExt(ilClfUpperBound).iPropVer = tlClfExt.iPropVer
                                tmClfExt(ilClfUpperBound).iVefCode = tlClfExt.iVefCode
                                tmClfExt(ilClfUpperBound).lChfCode = llRecPos
                                tmClfExt(ilClfUpperBound).sSchStatus = tlClfExt.sSchStatus
                                ilClfUpperBound = ilClfUpperBound + 1
                                'ReDim Preserve tmClfExt(1 To ilClfUpperBound) As CLFEXT
                                ReDim Preserve tmClfExt(0 To ilClfUpperBound) As CLFEXT
                            End If
                        End If
                        If igDoEvent Then
                            DoEvents
                        End If
                        ilRet = btrExtGetNext(hmClf, tlClfExt, ilExtLen, llRecPos)
                        Do While ilRet = BTRV_ERR_REJECT_COUNT
                            ilRet = btrExtGetNext(hmClf, tlClfExt, ilExtLen, llRecPos)
                        Loop
                    Loop
                End If
            End If
        End If
        If tmPChf.lCode = 0 Then
            Exit For
        End If
        If igDoEvent Then
            DoEvents
        End If
    Next ilPass
    
    ilFirstLnToProcess = LBound(tmClfExt)
    For ilLoop = LBound(tmClfExt) To UBound(tmClfExt) - 1 Step 1
        If tmClfExt(ilLoop).sSchStatus = "I" Then
            ilFirstLnToProcess = ilLoop
        Else
            Exit For
        End If
    Next ilLoop

    ilRemoveCopyCalled = False
    If UBound(tmClfExt) > LBound(tmClfExt) Then
        'ReDim lmPLnRecPos(1 To UBound(tmClfExt)) As Long
        ReDim lmPLnRecPos(0 To UBound(tmClfExt)) As Long
        'ReDim smLnSchStatus(1 To UBound(tmClfExt)) As String
        ReDim smLnSchStatus(0 To UBound(tmClfExt)) As String
        If Not mVehLock() Then
            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " Unable to Lock Vehicles"
            '6/4/16: Replace GoSub
            'GoSub ErrorMsg
            mErrorMsg slMsg, lbcNotSchd
            sgCntrSchStatus = slMsg
            bgCntrSchError = True
            gSchCntr = False
            Exit Function
        End If
        'Set contract header to scheduling mode
        Do
            ilRet = btrGetDirect(hmCHF, tmCChf, imCHFRecLen, lmCChfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
            If igDoEvent Then
                DoEvents
            End If
            If ilRet <> BTRV_ERR_NONE Then
                '6/4/16: Replace GoSub
                'GoSub ErrorMsg
                mErrorMsg slMsg, lbcNotSchd
                gSchCntr = False
                Exit Function
            End If
            'tmSRec = tmCChf
            'ilRet = gGetByKeyForUpdate("CHF", hmChf, tmSRec)
            'tmCChf = tmSRec
            'If ilRet <> BTRV_ERR_NONE Then
            '    If ilRet >= 30000 Then
            '        ilRet = csiHandleValue(0, 7)
            '    End If
            '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CHF"
            '    GoSub ErrorMsg
            '    Exit Function
            'End If
            tmCChf.sSchStatus = "I"
            ilRet = btrUpdate(hmCHF, tmCChf, imCHFRecLen)
        Loop While ilRet = BTRV_ERR_CONFLICT
        If igDoEvent Then
            DoEvents
        End If
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Update l CHF"
            '6/4/16: Replace GoSub
            'GoSub ErrorMsg
            mErrorMsg slMsg, lbcNotSchd
            sgCntrSchStatus = slMsg
            bgCntrSchError = True
            gSchCntr = False
            Exit Function
        End If
        tmPFsf.lCode = 0
        tmCFsf.lCode = 0
        tmPFsf.lCifCode = 0
        tmCFsf.lCifCode = 0
        'Remove copy assignments and delete CRF if advertiser changed
        If tmPChf.lCode <> 0 Then
            tmCChf.lCode = tmPChf.lCode 'Alter code so spots will be found
        End If
        If Not ilRemoveCopyCalled Then
            ilRet = mRemoveCopy()
            If igDoEvent Then
                DoEvents
            End If
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " in mRemoveCopy"
                '6/4/16: Replace GoSub
                'GoSub ErrorMsg
                mErrorMsg slMsg, lbcNotSchd
                sgCntrSchStatus = slMsg
                bgCntrSchError = True
                gSchCntr = False
                Exit Function
            End If
            ilRemoveCopyCalled = True
        End If
        llSvPCode = tmPChf.lCode
        For ilLoop = LBound(tmClfExt) To UBound(tmClfExt) - 1 Step 1
            'ReDim lmUnshRecPos(1 To 1) As Long
            tmPChf.lCode = llSvPCode  'Reset
            smOrigLnSchStatus = ""
            Do
                llRecPos = tmClfExt(ilLoop).lChfCode    'lChfCode replaced with line record position
                ilRet = btrGetDirect(hmClf, tmCClf, imClfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                If igDoEvent Then
                    DoEvents
                End If
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Changing Status to I"
                    '6/4/16: Replace GoSub
                    'GoSub ErrorMsg
                    mErrorMsg slMsg, lbcNotSchd
                    sgCntrSchStatus = slMsg
                    bgCntrSchError = True
                    gSchCntr = False
                    Exit Function
                End If
                If smOrigLnSchStatus = "" Then
                    smOrigLnSchStatus = tmCClf.sSchStatus
                    If smOrigLnSchStatus = "F" Then 'Header change only requiring sch
                        Exit Do 'Don't change status as its not needed
                    End If
                End If
                'tmSRec = tmCClf
                'ilRet = gGetByKeyForUpdate("CLF", hmClf, tmSRec)
                'tmCClf = tmSRec
                'If igDoEvent Then
                '    DoEvents
                'End If
                'If ilRet <> BTRV_ERR_NONE Then
                '    If ilRet >= 30000 Then
                '        ilRet = csiHandleValue(0, 7)
                '    End If
                '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CHF"
                '    GoSub ErrorMsg
                '    Exit Function
                'End If
                tmCClf.sSchStatus = "I"
                ilRet = btrUpdate(hmClf, tmCClf, imClfRecLen)
            Loop While ilRet = BTRV_ERR_CONFLICT
            If igDoEvent Then
                DoEvents
            End If
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Changing Status to I"
                '6/4/16: Replace GoSub
                'GoSub ErrorMsg
                mErrorMsg slMsg, lbcNotSchd
                sgCntrSchStatus = slMsg
                bgCntrSchError = True
                gSchCntr = False
                Exit Function
            End If
            'Start Loop thru vehicles
            tmVefSrchKey.iCode = tmCClf.iVefCode
            ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
            If igDoEvent Then
                DoEvents
            End If
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Equal VEF"
                '6/4/16: Replace GoSub
                'GoSub ErrorMsg
                mErrorMsg slMsg, lbcNotSchd
                sgCntrSchStatus = slMsg
                bgCntrSchError = True
                gSchCntr = False
                Exit Function
            End If
            mObtainFlights tmCClf, tmCCff(), tmCCgf()
            If tmVef.sType = "V" Then
                tmVsfSrchKey.lCode = tmVef.lVsfCode
                ilRet = btrGetEqual(hmVsf, tmCVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                If igDoEvent Then
                    DoEvents
                End If
               If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Equal VSF"
                    '6/4/16: Replace GoSub
                    'GoSub ErrorMsg
                    mErrorMsg slMsg, lbcNotSchd
                    sgCntrSchStatus = slMsg
                    bgCntrSchError = True
                    gSchCntr = False
                    Exit Function
                End If
                'Store the virtual vehicle as the first vehicle
                'For ilCVsf = UBound(tmCVsf.iFSCode) To LBound(tmCVsf.iFSCode) + 1 Step -1
                '    tmCVsf.iFSCode(ilCVsf) = tmCVsf.iFSCode(ilCVsf - 1)
                '    tmCVsf.iNoSpots(ilCVsf) = tmCVsf.iNoSpots(ilCVsf - 1)
                'Next ilCVsf
                'tmCVsf.iFSCode(LBound(tmCVsf.iFSCode)) = tmCClf.iVefCode
                'tmCVsf.iNoSpots(LBound(tmCVsf.iFSCode)) = 1
                ReDim tmCSchVehInfo(0 To 0) As SCHVEHINFO
                tmCSchVehInfo(0).iVefCode = tmCClf.iVefCode
                tmCSchVehInfo(0).iVirtSpotAdj = 1
                tmCSchVehInfo(0).iGameNo = 0
                tmCSchVehInfo(0).iGameIndex = -1
                For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
                    If tmCVsf.iFSCode(ilCVsf) > 0 Then
                        ReDim Preserve tmCSchVehInfo(0 To UBound(tmCSchVehInfo) + 1) As SCHVEHINFO
                        tmCSchVehInfo(UBound(tmCSchVehInfo)).iVefCode = tmCVsf.iFSCode(ilCVsf)
                        tmCSchVehInfo(UBound(tmCSchVehInfo)).iVirtSpotAdj = tmCVsf.iNoSpots(ilCVsf)
                        tmCSchVehInfo(UBound(tmCSchVehInfo)).iGameNo = 0
                        tmCSchVehInfo(UBound(tmCSchVehInfo)).iGameIndex = -1
                    End If
                Next ilCVsf
            ElseIf tmVef.sType = "G" Then
                ReDim tmCSchVehInfo(0 To 0) As SCHVEHINFO
                'If UBound(tmCCgf) > 1 Then
                If UBound(tmCCgf) > LBound(tmCCgf) Then
                    'For ilCgf = 1 To UBound(tmCCgf) - 1 Step 1
                    For ilCgf = LBound(tmCCgf) To UBound(tmCCgf) - 1 Step 1
                        tmCSchVehInfo(UBound(tmCSchVehInfo)).iVefCode = tmCClf.iVefCode
                        tmCSchVehInfo(UBound(tmCSchVehInfo)).iVirtSpotAdj = 1
                        tmCSchVehInfo(UBound(tmCSchVehInfo)).iGameNo = tmCCgf(ilCgf).iGameNo
                        tmCSchVehInfo(UBound(tmCSchVehInfo)).iGameIndex = ilCgf
                        ReDim Preserve tmCSchVehInfo(0 To UBound(tmCSchVehInfo) + 1) As SCHVEHINFO
                    Next ilCgf
                    ReDim Preserve tmCSchVehInfo(0 To UBound(tmCSchVehInfo) - 1) As SCHVEHINFO
                Else
                    'Line is CBS and no game records exist
                    tmCSchVehInfo(0).iVefCode = tmCClf.iVefCode
                    tmCSchVehInfo(0).iVirtSpotAdj = 1
                    tmCSchVehInfo(0).iGameNo = 0
                    tmCSchVehInfo(0).iGameIndex = -1
                End If
            Else
                'For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
                '    tmCVsf.iFSCode(ilCVsf) = 0
                '    tmCVsf.iNoSpots(ilCVsf) = 0
                'Next ilCVsf
                'tmCVsf.iFSCode(LBound(tmCVsf.iFSCode)) = tmCClf.iVefCode
                'tmCVsf.iNoSpots(LBound(tmCVsf.iFSCode)) = 1
                ReDim tmCSchVehInfo(0 To 0) As SCHVEHINFO
                tmCSchVehInfo(0).iVefCode = tmCClf.iVefCode
                tmCSchVehInfo(0).iVirtSpotAdj = 1
                tmCSchVehInfo(0).iGameNo = 0
                tmCSchVehInfo(0).iGameIndex = -1
            End If
            If igDoEvent Then
                DoEvents
            End If
            tmSvCClf = tmCClf  'Save
            ilVehChgProcessed = False
            For ilCSch = LBound(tmCSchVehInfo) To UBound(tmCSchVehInfo) Step 1
                If igDoEvent Then
                    DoEvents
                End If
                'If tmCVsf.iFSCode(ilCVsf) > 0 Then
                    tmCClf = tmSvCClf  'Restore (reset lChfCode)
                    imCVefCode = tmCSchVehInfo(ilCSch).iVefCode  'tmCVsf.iFSCode(ilCVsf)  'tmCClf.iVefCode
                    imVirtVehSpotAdj = tmCSchVehInfo(ilCSch).iVirtSpotAdj    ' tmCVsf.iNoSpots(ilCVsf)
                    ilVef = gBinarySearchVef(imCVefCode)
                    If ilVef <> -1 Then
                        slVefType = tgMVef(ilVef).sType
                    Else
                        slVefType = ""
                    End If
                    If (slVefType <> "R") And (tmCClf.sType <> "O") And (tmCClf.sType <> "A") And (tmCClf.sType <> "E") Then
                        If Not mGetVefDates(imCVefCode, imCVpfIndex) Then
                            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " Error in mGetVefDates"
                            '6/4/16: Replace GoSub
                            'GoSub ErrorMsg
                            mErrorMsg slMsg, lbcNotSchd
                            sgCntrSchStatus = slMsg
                            bgCntrSchError = True
                            gSchCntr = False
                            Exit Function
                        End If
                        If igDoEvent Then
                            DoEvents
                        End If
                        'Obtain competitive separation time
                        If tgVpf(imCVpfIndex).sSCompType = "T" Then
                            gUnpackLength tgVpf(imCVpfIndex).iSCompLen(0), tgVpf(imCVpfIndex).iSCompLen(1), "3", False, slLength
                            lmCompTime = CLng(gLengthToCurrency(slLength))
                        Else
                            lmCompTime = 0&
                        End If
                    End If
                    tlRdfSrchKey.iCode = tmCClf.iRdfCode
                    ilRet = btrGetEqual(hmRdf, tmCRdf, imRdfRecLen, tlRdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Equal RDF"
                        '6/4/16: Replace GoSub
                        'GoSub ErrorMsg
                        mErrorMsg slMsg, lbcNotSchd
                        sgCntrSchStatus = slMsg
                        bgCntrSchError = True
                        gSchCntr = False
                        Exit Function
                    End If
                    'Obtain rate card times as normalized numbers (spot counts)
                    mNorPCT tmCRdf
                    'Obtain flight information-Move prior to vehicle loop
                    'mObtainFlights tmCClf, tmCCff(), tmCCgf()
                    If tmCSchVehInfo(ilCSch).iGameNo > 0 Then
                        'Make temporary CFF record from Game information
                        gCgfToCff tmCClf, tmCCgf(tmCSchVehInfo(ilCSch).iGameIndex), tmCCff()
                    End If
                    'Obtain the previous scheduled version (version numbers are in descending order)
                    'If smOrigLnSchStatus <> "F" Then 'Header change only requiring sch
                    '    tmPClf.lChfCode = 0 'Flag indicating that previous doesn't exist
                    '    ReDim tmPCff(0 To 0) As CFF
                    '    ilRet = btrGetNext(hmClf, tlClf, imClfRecLen, BTRV_LOCK_NONE)
                    'Else
                    '    tlClf = tmCClf 'Line has not been altered
                    '    ilRet = BTRV_ERR_NONE
                    'End If
                    If (tmPChf.lCode = 0) And (smOrigLnSchStatus <> "F") Then
                        tmPclf.lChfCode = 0 'Flag indicating that previous doesn't exist
                        llPClfRecPos = 0
                        ReDim tmPCff(0 To 0) As CFF
                        'ReDim tmPCgf(1 To 1) As CGF
                        ReDim tmPCgf(0 To 0) As CGF
                    Else
                        If smOrigLnSchStatus <> "F" Then 'If F then, Header change only requiring sch
                            tlClfSrchKey.lChfCode = tmPChf.lCode
                            tlClfSrchKey.iLine = tmCClf.iLine
                            tlClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
                            tlClfSrchKey.iPropVer = 32000 ' 0 show latest version
                            ilRet = btrGetGreaterOrEqual(hmClf, tlClf, imClfRecLen, tlClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                            Do While (ilRet = BTRV_ERR_NONE) And (tlClf.lChfCode = tmPChf.lCode) And (tlClf.iLine = tmCClf.iLine) And (tlClf.sSchStatus <> slSchStatus)  '"F")
                                If igDoEvent Then
                                    DoEvents
                                End If
                                ilRet = btrGetNext(hmClf, tlClf, imClfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                            Loop
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilRet = BTRV_ERR_NONE Then
                                ilRet = btrGetPosition(hmClf, llPClfRecPos)
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Position CLF"
                                    '6/4/16: Replace GoSub
                                    'GoSub ErrorMsg
                                    mErrorMsg slMsg, lbcNotSchd
                                    sgCntrSchStatus = slMsg
                                    bgCntrSchError = True
                                    gSchCntr = False
                                    Exit Function
                                End If
                            End If
                        Else
                            tlClf = tmCClf 'Line has not been altered
                            llPClfRecPos = 0    'The current is the previous- don't change chfcode
                            tmPChf.lCode = tlClf.lChfCode
                            ilRet = BTRV_ERR_NONE
                        End If
                        If igDoEvent Then
                            DoEvents
                        End If
                        If (ilRet = BTRV_ERR_NONE) And (tlClf.lChfCode = tmPChf.lCode) And (tlClf.iLine = tmCClf.iLine) And (tlClf.sSchStatus = slSchStatus) Then  '"F") Then
                            tmPclf = tlClf
                            'Obtain flight information
                            mObtainFlights tmPclf, tmPCff(), tmPCgf()
                            If tmCClf.iRdfCode <> tmPclf.iRdfCode Then
                                tlRdfSrchKey.iCode = tmPclf.iRdfCode
                                ilRet = btrGetEqual(hmRdf, tmPRdf, imRdfRecLen, tlRdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Equal RDF"
                                    '6/4/16: Replace GoSub
                                    'GoSub ErrorMsg
                                    mErrorMsg slMsg, lbcNotSchd
                                    sgCntrSchStatus = slMsg
                                    bgCntrSchError = True
                                    gSchCntr = False
                                    Exit Function
                                End If
                            Else
                                tmPRdf = tmCRdf
                            End If
                            If tmCSchVehInfo(ilCSch).iGameNo > 0 Then
                                '3/8/13: Add date test
                                gUnpackDateLong tmCCgf(tmCSchVehInfo(ilCSch).iGameIndex).iAirDate(0), tmCCgf(tmCSchVehInfo(ilCSch).iGameIndex).iAirDate(1), llCgfDate
                                llCgfMoDate = llCgfDate - gWeekDayLong(llCgfDate)
                                'end 3/8/13
                                ReDim tmPCff(0 To 0) As CFF
                                'For ilCgf = 1 To UBound(tmPCgf) - 1 Step 1
                                For ilCgf = LBound(tmPCgf) To UBound(tmPCgf) - 1 Step 1
                                    If tmCSchVehInfo(ilCSch).iGameNo = tmPCgf(ilCgf).iGameNo Then
                                        '3/8/13: Add Date test because of multi-seasons
                                        gUnpackDateLong tmPCgf(ilCgf).iAirDate(0), tmPCgf(ilCgf).iAirDate(1), llCgfDate
                                        If llCgfMoDate = llCgfDate - gWeekDayLong(llCgfDate) Then
                                        'end 3/8/13
                                            gCgfToCff tmPclf, tmPCgf(ilCgf), tmPCff()
                                            Exit For
                                        End If
                                    End If
                                Next ilCgf
                            End If
                            If llPChfRecPos = 0 Then
                                tmPChf.lCode = 0
                            End If
                        Else
                            tmPclf.lChfCode = 0 'Flag indicating that previous doesn't exist
                            llPClfRecPos = 0
                            ReDim tmPCff(0 To 0) As CFF
                            'ReDim tmPCgf(1 To 1) As CGF
                            ReDim tmPCgf(0 To 0) As CGF
                        End If
                    End If
                    '4'11'19: Bypass previously processed lines
                    If ilLoop >= ilFirstLnToProcess Then
                        'Reset to current line
                        llRecPos = tmClfExt(ilLoop).lChfCode
                        ilRet = btrGetDirect(hmClf, tmCClf, imClfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                        If igDoEvent Then
                            DoEvents
                        End If
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CLF"
                            '6/4/16: Replace GoSub
                            'GoSub ErrorMsg
                            mErrorMsg slMsg, lbcNotSchd
                            sgCntrSchStatus = slMsg
                            bgCntrSchError = True
                            gSchCntr = False
                            Exit Function
                        End If
                        llSvClfChfCode = tmCClf.lChfCode
                        If tmPChf.lCode <> 0 Then
                            tmCClf.lChfCode = tmPChf.lCode 'Alter code so spots will be found
                        End If
                        'Bypass package lines and rep lines
                        If (slVefType <> "R") And (tmCClf.sType <> "O") And (tmCClf.sType <> "A") And (tmCClf.sType <> "E") Then
                            'Determine if new weeks should be added to LCF and SSF
                            ilVef = gBinarySearchVef(imCVefCode)
                            If ilVef <> -1 Then
                                If tgMVef(ilVef).sType <> "G" Then
                                    llLcfEarliestDate = gGetEarliestLCFDate(hmLcf, "C", imCVefCode)
                                    If llLcfEarliestDate > lmEarliestAllowedDate Then
                                        lmEarliestAllowedDate = llLcfEarliestDate
                                    End If
                                    llLcfLatestDate = gGetLatestLCFDate(hmLcf, "C", imCVefCode)
                                    ilCffUpperBound = UBound(tmCCff) - 1
                                    'If ilCffUpperBound <= 0 Then
                                    If ilCffUpperBound < 0 Then
                                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " No Flights Defined"
                                        '6/4/16: Replace GoSub
                                        'GoSub ErrorMsg
                                        mErrorMsg slMsg, lbcNotSchd
                                        sgCntrSchStatus = slMsg
                                        bgCntrSchError = True
                                        gSchCntr = False
                                        Exit Function
                                    End If
                                    gUnpackDate tmCCff(ilCffUpperBound).iEndDate(0), tmCCff(ilCffUpperBound).iEndDate(1), slDate
                                    llClfEndDate = gDateValue(slDate)
                                    If llClfEndDate > llLcfLatestDate Then 'Extend
                                        slDate = Format$(llClfEndDate, "m/d/yy")
                                        slDate = gObtainNextSunday(slDate)
                                        llSundayDate = gDateValue(slDate)
                                        For llDate = llLcfLatestDate + 1 To llSundayDate Step 1
                                            slDate = Format$(llDate, "m/d/yy")
                                            gPackDate slDate, ilLogDate0, ilLogDate1
                                            ilRet = gExtendTFN(hmLcf, hmSsf, hmSdf, hmSmf, "C", imCVefCode, ilLogDate0, ilLogDate1, True)
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If Not ilRet Then
                                                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " Error in Extend TFN"
                                                '6/4/16: Replace GoSub
                                                'GoSub ErrorMsg
                                                mErrorMsg slMsg, lbcNotSchd
                                                sgCntrSchStatus = slMsg
                                                bgCntrSchError = True
                                                gSchCntr = False
                                                Exit Function
                                            End If
                                        Next llDate
                                    End If
                                End If
                            End If
                            If smOrigLnSchStatus <> "F" Then 'Header change only requiring sch
                                '8/4/11: Handle the case where Previous game line has spots but current game line does not
                                'If ((tmPclf.lChfCode <> 0) And (tmPclf.iVefCode <> tmCClf.iVefCode)) Or ((tmPclf.lChfCode <> 0) And (tmPclf.iVefCode = tmCClf.iVefCode) And (tmVef.sType = "G")) Then
                                If ((tmPclf.lChfCode <> 0) And (tmPclf.iVefCode <> tmCClf.iVefCode)) Or ((tmPclf.lChfCode <> 0) And (tmPclf.iVefCode = tmCClf.iVefCode) And (tmVef.sType = "G")) Then
                                    If Not ilVehChgProcessed Then
                                        tmVefSrchKey.iCode = tmPclf.iVefCode
                                        ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If ilRet <> BTRV_ERR_NONE Then
                                            If ilRet >= 30000 Then
                                                ilRet = csiHandleValue(0, 7)
                                            End If
                                            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Equal VEF"
                                            '6/4/16: Replace GoSub
                                            'GoSub ErrorMsg
                                            mErrorMsg slMsg, lbcNotSchd
                                            sgCntrSchStatus = slMsg
                                            bgCntrSchError = True
                                            gSchCntr = False
                                            Exit Function
                                        End If
                                        If tmVef.sType = "V" Then
                                            tmVsfSrchKey.lCode = tmVef.lVsfCode
                                            ilRet = btrGetEqual(hmVsf, tmPVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If ilRet <> BTRV_ERR_NONE Then
                                                If ilRet >= 30000 Then
                                                    ilRet = csiHandleValue(0, 7)
                                                End If
                                                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Equal VSF"
                                                '6/4/16: Replace GoSub
                                                'GoSub ErrorMsg
                                                mErrorMsg slMsg, lbcNotSchd
                                                sgCntrSchStatus = slMsg
                                                bgCntrSchError = True
                                                gSchCntr = False
                                                Exit Function
                                            End If
                                            'Store the virtual vehicle as the first vehicle
                                            'For ilPVsf = UBound(tmPVsf.iFSCode) To LBound(tmPVsf.iFSCode) + 1 Step -1
                                            '    tmPVsf.iFSCode(ilPVsf) = tmPVsf.iFSCode(ilPVsf - 1)
                                            '    tmPVsf.iNoSpots(ilPVsf) = tmPVsf.iNoSpots(ilPVsf - 1)
                                            'Next ilPVsf
                                            'tmPVsf.iFSCode(LBound(tmPVsf.iFSCode)) = tmPclf.iVefCode
                                            'tmPVsf.iNoSpots(LBound(tmPVsf.iFSCode)) = 1
                                            ReDim tmPSchVehInfo(0 To 0) As SCHVEHINFO
                                            tmPSchVehInfo(0).iVefCode = tmPclf.iVefCode
                                            tmPSchVehInfo(0).iVirtSpotAdj = 1
                                            tmPSchVehInfo(0).iGameNo = 0
                                            tmPSchVehInfo(0).iGameIndex = -1
                                            For ilPVsf = LBound(tmPVsf.iFSCode) To UBound(tmPVsf.iFSCode) Step 1
                                                If tmPVsf.iFSCode(ilPVsf) > 0 Then
                                                    ReDim Preserve tmPSchVehInfo(0 To UBound(tmPSchVehInfo) + 1) As SCHVEHINFO
                                                    tmPSchVehInfo(UBound(tmPSchVehInfo)).iVefCode = tmPVsf.iFSCode(ilPVsf)
                                                    tmPSchVehInfo(UBound(tmPSchVehInfo)).iVirtSpotAdj = tmPVsf.iNoSpots(ilPVsf)
                                                    tmPSchVehInfo(UBound(tmPSchVehInfo)).iGameNo = 0
                                                    tmPSchVehInfo(UBound(tmPSchVehInfo)).iGameIndex = -1
                                                End If
                                            Next ilPVsf
                                        ElseIf tmVef.sType = "G" Then
                                            ReDim tmPSchVehInfo(0 To 0) As SCHVEHINFO
                                            '8/4/11: Handle case where game removed
                                            tmPSchVehInfo(UBound(tmPSchVehInfo)).iVefCode = 0
                                            'For ilCgf = 1 To UBound(tmPCgf) - 1 Step 1
                                            For ilCgf = LBound(tmPCgf) To UBound(tmPCgf) - 1 Step 1
                                                '8/4/11:  Handle games that were removed
                                                ilFound = False
                                                If tmPclf.iVefCode = tmCClf.iVefCode Then
                                                    'For ilCCgf = 1 To UBound(tmCCgf) - 1 Step 1
                                                    For ilCCgf = LBound(tmCCgf) To UBound(tmCCgf) - 1 Step 1
                                                        If tmPCgf(ilCgf).iGameNo = tmCCgf(ilCCgf).iGameNo Then
                                                            '3/17/13: Add date test because of seasons
                                                            If (tmPCgf(ilCgf).iAirDate(0) = tmCCgf(ilCCgf).iAirDate(0)) And (tmPCgf(ilCgf).iAirDate(1) = tmCCgf(ilCCgf).iAirDate(1)) Then
                                                                ilFound = True
                                                                Exit For
                                                            End If
                                                        End If
                                                    Next ilCCgf
                                                End If
                                                If Not ilFound Then
                                                    tmPSchVehInfo(UBound(tmPSchVehInfo)).iVefCode = tmPclf.iVefCode
                                                    tmPSchVehInfo(UBound(tmPSchVehInfo)).iVirtSpotAdj = 1
                                                    tmPSchVehInfo(UBound(tmPSchVehInfo)).iGameNo = tmPCgf(ilCgf).iGameNo
                                                    tmPSchVehInfo(UBound(tmPSchVehInfo)).iGameIndex = ilCgf
                                                    ReDim Preserve tmPSchVehInfo(0 To UBound(tmPSchVehInfo) + 1) As SCHVEHINFO
                                                End If
                                            Next ilCgf
                                            '8/4/11: Handle games that were removed
                                            If UBound(tmPSchVehInfo) > LBound(tmPSchVehInfo) Then
                                                ReDim Preserve tmPSchVehInfo(0 To UBound(tmPSchVehInfo) - 1) As SCHVEHINFO
                                            End If
                                        Else
                                            'For ilPVsf = LBound(tmPVsf.iFSCode) To UBound(tmPVsf.iFSCode) Step 1
                                            '    tmPVsf.iFSCode(ilPVsf) = 0
                                            '    tmPVsf.iNoSpots(ilPVsf) = 0
                                            'Next ilPVsf
                                            'tmPVsf.iFSCode(LBound(tmPVsf.iFSCode)) = tmPclf.iVefCode
                                            'tmPVsf.iNoSpots(LBound(tmPVsf.iFSCode)) = 1
                                            ReDim tmPSchVehInfo(0 To 0) As SCHVEHINFO
                                            tmPSchVehInfo(0).iVefCode = tmPclf.iVefCode
                                            tmPSchVehInfo(0).iVirtSpotAdj = 1
                                            tmPSchVehInfo(0).iGameNo = 0
                                            tmPSchVehInfo(0).iGameIndex = -1
                                        End If
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        ''For ilPVsf = LBound(tmPVsf.iFSCode) To UBound(tmPVsf.iFSCode) Step 1
                                        '8/4/11: Handle case were game removed
                                        If tmPSchVehInfo(LBound(tmPSchVehInfo)).iVefCode > 0 Then
                                            For ilPSch = LBound(tmPSchVehInfo) To UBound(tmPSchVehInfo) Step 1
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                'If tmPVsf.iFSCode(ilPVsf) > 0 Then
                                                    imCVefCode = tmPSchVehInfo(ilPSch).iVefCode   'tmPVsf.iFSCode(ilPVsf)
                                                    llDeleteDate = gGetEarliestLCFDate(hmLcf, "C", imCVefCode)
                                                    llLcfLatestDate = gGetLatestLCFDate(hmLcf, "C", imCVefCode)
                                                    If Not mGetVefDates(imCVefCode, imCVpfIndex) Then
                                                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " Error in Get Vef Dates"
                                                        '6/4/16: Replace GoSub
                                                        'GoSub ErrorMsg
                                                        mErrorMsg slMsg, lbcNotSchd
                                                        sgCntrSchStatus = slMsg
                                                        bgCntrSchError = True
                                                        gSchCntr = False
                                                        Exit Function
                                                    End If
                                                    'If llDeleteDate <= 0 Then
                                                        tgSdfSrchKey.iVefCode = imCVefCode
                                                        tgSdfSrchKey.lChfCode = tmCChf.lCode
                                                        tgSdfSrchKey.iLineNo = tmCClf.iLine
                                                        tgSdfSrchKey.lFsfCode = 0
                                                        slDate = Format$("1/1/80", "m/d/yy")
                                                        gPackDate slDate, tgSdfSrchKey.iDate(0), tgSdfSrchKey.iDate(1)
                                                        tgSdfSrchKey.sSchStatus = ""
                                                        tgSdfSrchKey.iTime(0) = 0
                                                        tgSdfSrchKey.iTime(1) = 0
                                                        ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                                        If igDoEvent Then
                                                            DoEvents
                                                        End If
                                                        If (ilRet = BTRV_ERR_NONE) And (tmSdf.iVefCode = imCVefCode) And (tmSdf.lChfCode = tmCChf.lCode) And (tmSdf.iLineNo = tmCClf.iLine) Then
                                                            gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llDate
                                                            If llDate < llDeleteDate Then
                                                                llDeleteDate = llDate
                                                            End If
                                                        End If
                                                    'End If
                                                    'If llLcfLatestDate <= 0 Then
                                                        tgSdfSrchKey.iVefCode = imCVefCode
                                                        tgSdfSrchKey.lChfCode = tmCChf.lCode
                                                        tgSdfSrchKey.iLineNo = tmCClf.iLine
                                                        tgSdfSrchKey.lFsfCode = 0
                                                        slDate = Format$("1/1/2060", "m/d/yy")
                                                        gPackDate slDate, tgSdfSrchKey.iDate(0), tgSdfSrchKey.iDate(1)
                                                        tgSdfSrchKey.sSchStatus = ""
                                                        tgSdfSrchKey.iTime(0) = 0
                                                        tgSdfSrchKey.iTime(1) = 0
                                                        ilRet = btrGetLessOrEqual(hmSdf, tmSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                                        If igDoEvent Then
                                                            DoEvents
                                                        End If
                                                        If (ilRet = BTRV_ERR_NONE) And (tmSdf.iVefCode = imCVefCode) And (tmSdf.lChfCode = tmCChf.lCode) And (tmSdf.iLineNo = tmCClf.iLine) Then
                                                            gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llDate
                                                            If llDate > llLcfLatestDate Then
                                                                llLcfLatestDate = llDate
                                                            End If
                                                        End If
                                                    'End If
                                                    '3/17/13: Pass game date if game
                                                    If tmPSchVehInfo(ilPSch).iGameNo > 0 Then
                                                        gUnpackDateLong tmPCgf(tmPSchVehInfo(ilPSch).iGameIndex).iAirDate(0), tmPCgf(tmPSchVehInfo(ilPSch).iGameIndex).iAirDate(1), llDeleteDate
                                                        llLcfLatestDate = llDeleteDate
                                                    End If
                                                    ilRet = mDeleteSpots(tmCChf.lCode, tmCClf.iLine, 0, tmPSchVehInfo(ilPSch).iGameNo, llDeleteDate, llLcfLatestDate, 32000, True, tmCChf.sCBSOrder)
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    If Not ilRet Then
                                                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " Error in Delete Spots"
                                                        '6/4/16: Replace GoSub
                                                        'GoSub ErrorMsg
                                                        mErrorMsg slMsg, lbcNotSchd
                                                        sgCntrSchStatus = slMsg
                                                        bgCntrSchError = True
                                                        gSchCntr = False
                                                        Exit Function
                                                    End If
                                                'End If
                                            'Next ilPVsf
                                            Next ilPSch
                                        End If
                                        ilVehChgProcessed = True
                                    End If
                                    'Reset vehicle
                                    tmVefSrchKey.iCode = tmCClf.iVefCode
                                    ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                   If ilRet <> BTRV_ERR_NONE Then
                                        If ilRet >= 30000 Then
                                            ilRet = csiHandleValue(0, 7)
                                        End If
                                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Equal VEF"
                                        '6/4/16: Replace GoSub
                                        'GoSub ErrorMsg
                                        mErrorMsg slMsg, lbcNotSchd
                                        sgCntrSchStatus = slMsg
                                        bgCntrSchError = True
                                        gSchCntr = False
                                        Exit Function
                                    End If
                                    imCVefCode = tmCSchVehInfo(ilCSch).iVefCode   'tmCVsf.iFSCode(ilCVsf)  'tmCClf.iVefCode
                                    If Not mGetVefDates(imCVefCode, imCVpfIndex) Then
                                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " Error in Get Vef Dates"
                                        '6/4/16: Replace GoSub
                                        'GoSub ErrorMsg
                                        mErrorMsg slMsg, lbcNotSchd
                                        sgCntrSchStatus = slMsg
                                        bgCntrSchError = True
                                        gSchCntr = False
                                        Exit Function
                                    End If
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    'Set previous as it didn't exist since vehicle changed and all spots removed
                                    '8/4/11: Handle case where game removed
                                    If ((tmPclf.lChfCode <> 0) And (tmPclf.iVefCode <> tmCClf.iVefCode)) Then
                                        tmPclf.lChfCode = 0 'Flag indicating that previous doesn't exist
                                        ReDim tmPCff(0 To 0) As CFF
                                        'ReDim tmPCgf(1 To 1) As CGF
                                        ReDim tmPCgf(0 To 0) As CGF
                                    End If
                                End If
                                ilRet = mBalanceSpots(tmCSchVehInfo(ilCSch).iGameNo)
                                If Not ilRet Then
                                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " Error in Balance Spots"
                                    '6/4/16: Replace GoSub
                                    'GoSub ErrorMsg
                                    mErrorMsg slMsg, lbcNotSchd
                                    sgCntrSchStatus = slMsg
                                    bgCntrSchError = True
                                    gSchCntr = False
                                    Exit Function
                                End If
                            Else
                                'ReDim lgUnschSdfCode(1 To 1) As Long
                                ReDim lgUnschSdfCode(0 To 0) As Long
                                'ReDim tmPreferredInfo(1 To 1) As PREFERREDINFO
                                ReDim tmPreferredInfo(0 To 0) As PREFERREDINFO
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            If tmCClf.lRafCode > 0 Then
                                'Move prior to validatespots
                                'If imRafPass = 0 Then
                                '    gBuildStationsFromRAF hmRaf, hmSef, tmCClf.lRafCode, smClfInclExcl, tmStationsClf()
                                'End If
                                imRafPass = 0
                                lmRafCode = tmCClf.lRafCode
                            Else
                                imRafPass = 1
                                lmRafCode = 0
                            End If
                            If tmCClf.lRafCode > 0 Then
                                If imRafPass = 0 Then
                                    gBuildStationsFromRAF hmRaf, hmSef, tmCClf.lRafCode, smClfInclExcl, tmStationsClf(), True
                                End If
                            Else
                                'ReDim tmStationsClf(1 To 1) As INTKEY0
                                ReDim tmStationsClf(0 To 0) As INTKEY0
                            End If
                            '3/17/13: If game, includ edate
                            If tmCSchVehInfo(ilCSch).iGameNo > 0 Then
                                gUnpackDateLong tmCCgf(tmCSchVehInfo(ilCSch).iGameIndex).iAirDate(0), tmCCgf(tmCSchVehInfo(ilCSch).iGameIndex).iAirDate(1), llGameDate
                            Else
                                llGameDate = 0
                            End If
                            'ilRet = mValidateSpots(tmCSchVehInfo(ilCSch).iGameNo)
                            ilRet = mValidateSpots(tmCSchVehInfo(ilCSch).iGameNo, llGameDate)
                            If Not ilRet Then
                                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " Error in Validate Spots"
                                '6/4/16: Replace GoSub
                                'GoSub ErrorMsg
                                mErrorMsg slMsg, lbcNotSchd
                                sgCntrSchStatus = slMsg
                                bgCntrSchError = True
                                gSchCntr = False
                                Exit Function
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            'Count schedule spots
                            mInitCounts tmCRdf, tmCClf.lChfCode, tmCClf.iLine, 0, tmCSchVehInfo(ilCSch).iGameNo, imCHour(), imCDay(), imCQH(), False
                            imCAdfCodeSLen = 0   'Advertiser code for last valid Separation computation
                            llBypassStartDate = 0
                            llBypassEndDate = 0
                            'Obtain spot to be scheduled
                            lgUnschIndex = LBound(lgUnschSdfCode)
                            Do While lgUnschIndex < UBound(lgUnschSdfCode)
                                'lmSdfRecPos = lgUnschRecPos(lgUnschIndex)    'lChfCode replaced with line record position
                                'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, lmSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                tmSdfSrchKey3.lCode = lgUnschSdfCode(lgUnschIndex)
                                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilRet = BTRV_ERR_NONE Then
                                    gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                    llDate = gDateValue(slDate)
                                    If (llDate < llBypassStartDate) Or (llDate > llBypassEndDate) Then
                                        llTClfChfCode = tmCClf.lChfCode
                                        tmCClf.lChfCode = llSvClfChfCode
                                        gGetLineSchParameters hmSsf, tgSsf(), lgSsfDate(), lgSsfRecPos(), llDate, imCVefCode, tmSdf.iAdfCode, tmCSchVehInfo(ilCSch).iGameNo, tmCCff(), tmCClf, tmCRdf, lmCSepLength, lmCStartDateSLen, lmCEndDateSLen, lmCChfCode, imCLineNo, imCAdfCodeSLen, imCVehComp, imCHour(), imCDay(), imCQH(), imCAHour(), imCADay(), imCAQH(), lmCTBStartTime(), lmCTBEndTime(), lmEarliestAllowedDate, imSkip(), tmCChf.sType, tmCChf.iPctTrade, imBkQH, False, imPriceLevel
                                        tmCClf.lChfCode = llTClfChfCode
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If lmCEndDateSLen >= lmEarliestAllowedDate Then
                                            If lmCStartDateSLen < lmEarliestAllowedDate Then
                                                'Advance date to earliest allow date
                                                llDate = lmEarliestAllowedDate
                                                slDate = Format$(llDate, "m/d/yy")
                                            End If
                                            'Obtain conflict records
                                            gObtainVcf hmVcf, imCVefCode, llDate, tmVcf0(), tmVcf6(), tmVcf7()
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If mSchPasses("S", slDate, tmCChf, tmCClf, tmCRdf, tmCSchVehInfo(ilCSch).iGameNo, lmCSepLength, lmCTBStartTime(), lmCTBEndTime(), imCAHour(), imCADay(), imCAQH(), imPriceLevel, 0, "YYYYYYY", 0, 86400) Then
                                                lgUnschIndex = lgUnschIndex + 1
                                                llBypassStartDate = 0
                                                llBypassEndDate = 0
                                                mAdjustCounts imCAHour(), imCADay(), imCAQH(), imCHour(), imCDay(), imCQH()
                                            Else
                                                If imRafPass = 0 Then
                                                    imRafPass = 1
                                                Else
                                                    If lmRafCode > 0 Then
                                                        imRafPass = 0
                                                    End If
                                                    mCompBypassDates llDate, tmCCff(), llBypassStartDate, llBypassEndDate
                                                    mRetainUnSchdEventSpotByWeek tmCSchVehInfo(ilCSch).iGameNo
                                                    lgUnschIndex = lgUnschIndex + 1
                                                End If
                                            End If
                                        Else
                                            mCompBypassDates llDate, tmCCff(), llBypassStartDate, llBypassEndDate
                                            mRetainUnSchdEventSpotByWeek tmCSchVehInfo(ilCSch).iGameNo
                                            lgUnschIndex = lgUnschIndex + 1
                                        End If
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                    Else
                                        If lmRafCode > 0 Then
                                            imRafPass = 0
                                        End If
                                        mRetainUnSchdEventSpotByWeek tmCSchVehInfo(ilCSch).iGameNo
                                        lgUnschIndex = lgUnschIndex + 1
                                    End If
                                Else
                                    'lgUnschIndex = lgUnschIndex + 1
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct SDF"
                                    '6/4/16: Replace GoSub
                                    'GoSub ErrorMsg
                                    mErrorMsg slMsg, lbcNotSchd
                                    sgCntrSchStatus = slMsg
                                    bgCntrSchError = True
                                    gSchCntr = False
                                    Exit Function
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                            Loop
                        Else
                            'Test if advertiser changed- if so adjust invoice spots for package lines
                        End If
                    End If
                'End If
                mCreateAlert imCVefCode, tmCClf.lChfCode, tmCClf.iLine
            Next ilCSch
            'End Loop on vehicles
            lmPLnRecPos(ilLoop) = llPClfRecPos
            smLnSchStatus(ilLoop) = smOrigLnSchStatus
            If igDoEvent Then
                DoEvents
            End If
        Next ilLoop
        If csiHandleValue(0, 15) > 0 Then
            ilRet = btrBeginTrans(hmCHF, 1000)
        Else
            ilRet = btrBeginTrans(hmCHF, -1000)
        End If
        If igDoEvent Then
            DoEvents
        End If
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            slMsg = "I/O Error:" & str$(ilRet) & " Begin Transactions"
            '6/4/16: Replace GoSub
            'GoSub ErrorMsg
            mErrorMsg slMsg, lbcNotSchd
            sgCntrSchStatus = slMsg
            bgCntrSchError = True
            gSchCntr = False
            Exit Function
        End If
        ilBeginTran = True
        For ilLoop = LBound(tmClfExt) To UBound(tmClfExt) - 1 Step 1
            llPClfRecPos = lmPLnRecPos(ilLoop)
            smOrigLnSchStatus = smLnSchStatus(ilLoop)
            If (llPChfRecPos = 0) Or (llPClfRecPos = 0) Then
                'Previous header or line missing
                If smOrigLnSchStatus <> "F" Then 'If F then, Header change only requiring sch
                    Do
                        If igDoEvent Then
                            DoEvents
                        End If
                        llRecPos = tmClfExt(ilLoop).lChfCode    'lChfCode replaced with line record position
                        ilRet = btrGetDirect(hmClf, tmCClf, imClfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                        If igDoEvent Then
                            DoEvents
                        End If
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CLF"
                            '6/4/16: Replace GoSub
                            'GoSub ErrorMsg
                            mErrorMsg slMsg, lbcNotSchd
                            sgCntrSchStatus = slMsg
                            bgCntrSchError = True
                            gSchCntr = False
                            Exit Function
                        End If
                        'tmSRec = tmCClf
                        'ilRet = gGetByKeyForUpdate("CLF", hmClf, tmSRec)
                        'tmCClf = tmSRec
                        'If igDoEvent Then
                        '    DoEvents
                        'End If
                        'If ilRet <> BTRV_ERR_NONE Then
                        '    If ilRet >= 30000 Then
                        '        ilRet = csiHandleValue(0, 7)
                        '    End If
                        '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CLF"
                        '    GoSub ErrorMsg
                        '    Exit Function
                        'End If
                        tmCClf.sSchStatus = "F"
                        ilRet = btrUpdate(hmClf, tmCClf, imClfRecLen)
                    Loop While ilRet = BTRV_ERR_CONFLICT
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Update CLF"
                        '6/4/16: Replace GoSub
                        'GoSub ErrorMsg
                        mErrorMsg slMsg, lbcNotSchd
                        sgCntrSchStatus = slMsg
                        bgCntrSchError = True
                        gSchCntr = False
                        Exit Function
                    End If
                    If llPChfRecPos <> 0 Then
                        'Swap chfcode values in clf and cff as previous line was not defined
                        Do
                            If igDoEvent Then
                                DoEvents
                            End If
                            llRecPos = tmClfExt(ilLoop).lChfCode    'lChfCode replaced with line record position
                            ilRet = btrGetDirect(hmClf, tmCClf, imClfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilRet <> BTRV_ERR_NONE Then
                                If ilRet >= 30000 Then
                                    ilRet = csiHandleValue(0, 7)
                                End If
                                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CLF"
                                '6/4/16: Replace GoSub
                                'GoSub ErrorMsg
                                mErrorMsg slMsg, lbcNotSchd
                                sgCntrSchStatus = slMsg
                                bgCntrSchError = True
                                gSchCntr = False
                                Exit Function
                            End If
                            'tmSRec = tmCClf
                            'ilRet = gGetByKeyForUpdate("CLF", hmClf, tmSRec)
                            'tmCClf = tmSRec
                            'If igDoEvent Then
                            '    DoEvents
                            'End If
                            'If ilRet <> BTRV_ERR_NONE Then
                            '    If ilRet >= 30000 Then
                            '        ilRet = csiHandleValue(0, 7)
                            '    End If
                            '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CLF"
                            '    GoSub ErrorMsg
                            '    Exit Function
                            'End If
                            ilRet = btrDelete(hmClf)
                        Loop While ilRet = BTRV_ERR_CONFLICT
                        If igDoEvent Then
                            DoEvents
                        End If
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Delete CLF"
                            '6/4/16: Replace GoSub
                            'GoSub ErrorMsg
                            mErrorMsg slMsg, lbcNotSchd
                            sgCntrSchStatus = slMsg
                            bgCntrSchError = True
                            gSchCntr = False
                            Exit Function
                        End If
                        ilRet = btrGetDirect(hmCHF, tmPChf, imCHFRecLen, llPChfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                        If igDoEvent Then
                            DoEvents
                        End If
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CHF"
                            '6/4/16: Replace GoSub
                            'GoSub ErrorMsg
                            mErrorMsg slMsg, lbcNotSchd
                            sgCntrSchStatus = slMsg
                            bgCntrSchError = True
                            gSchCntr = False
                            Exit Function
                        End If
                        'Loop on flights (Cff)
                        ReDim tmCCff(0 To 0) As CFF
                        tlCffSrchKey.lChfCode = tmCClf.lChfCode  'tlChf.lCode
                        tlCffSrchKey.iClfLine = tmCClf.iLine
                        tlCffSrchKey.iCntRevNo = tmCClf.iCntRevNo
                        tlCffSrchKey.iPropVer = tmCClf.iPropVer
                        tlCffSrchKey.iStartDate(0) = 0
                        tlCffSrchKey.iStartDate(1) = 0
                        ilRet = btrGetGreaterOrEqual(hmCff, tlCff, imCffRecLen, tlCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                        Do While (ilRet = BTRV_ERR_NONE) And (tlCff.lChfCode = tmCClf.lChfCode) And (tlCff.iClfLine = tmCClf.iLine) And (tlCff.iCntRevNo = tmCClf.iCntRevNo) And (tlCff.iPropVer = tmCClf.iPropVer)
                            If igDoEvent Then
                                DoEvents
                            End If
                            'tmSRec = tlCff
                            'ilRet = gGetByKeyForUpdate("CFF", hmCff, tmSRec)
                            'tlCff = tmSRec
                            'If igDoEvent Then
                            '    DoEvents
                            'End If
                            'If ilRet <> BTRV_ERR_NONE Then
                            '    If ilRet >= 30000 Then
                            '        ilRet = csiHandleValue(0, 7)
                            '    End If
                            '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CFF"
                            '    GoSub ErrorMsg
                            '    Exit Function
                            'End If
                            ilRet = btrDelete(hmCff)
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilRet <> BTRV_ERR_CONFLICT Then
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Delete CFF"
                                    '6/4/16: Replace GoSub
                                    'GoSub ErrorMsg
                                    mErrorMsg slMsg, lbcNotSchd
                                    sgCntrSchStatus = slMsg
                                    bgCntrSchError = True
                                    gSchCntr = False
                                    Exit Function
                                End If
                                tmCCff(UBound(tmCCff)) = tlCff
                                'ReDim Preserve tmCCff(1 To UBound(tmCCff) + 1) As CFF
                                ReDim Preserve tmCCff(0 To UBound(tmCCff) + 1) As CFF
                            End If
                            tlCffSrchKey.lChfCode = tmCClf.lChfCode  'tlChf.lCode
                            tlCffSrchKey.iClfLine = tmCClf.iLine
                            tlCffSrchKey.iCntRevNo = tmCClf.iCntRevNo
                            tlCffSrchKey.iPropVer = tmCClf.iPropVer
                            tlCffSrchKey.iStartDate(0) = 0
                            tlCffSrchKey.iStartDate(1) = 0
                            ilRet = btrGetGreaterOrEqual(hmCff, tlCff, imCffRecLen, tlCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                            If igDoEvent Then
                                DoEvents
                            End If
                        Loop
                        For ilCff = LBound(tmCCff) To UBound(tmCCff) - 1 Step 1
                            tmCCff(ilCff).lChfCode = tmPChf.lCode
                            tmCCff(ilCff).lCode = 0
                            ilRet = btrInsert(hmCff, tmCCff(ilCff), imCffRecLen, INDEXKEY1)
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilRet <> BTRV_ERR_NONE Then
                                If ilRet >= 30000 Then
                                    ilRet = csiHandleValue(0, 7)
                                End If
                                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Insert CFF"
                                '6/4/16: Replace GoSub
                                'GoSub ErrorMsg
                                mErrorMsg slMsg, lbcNotSchd
                                sgCntrSchStatus = slMsg
                                bgCntrSchError = True
                                gSchCntr = False
                                Exit Function
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                        Next ilCff
                        tmCClf.lChfCode = tmPChf.lCode
                        tmCClf.sSchStatus = "F"
                        ilRet = btrInsert(hmClf, tmCClf, imClfRecLen, INDEXKEY0)
                        If igDoEvent Then
                            DoEvents
                        End If
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Insert CLF"
                            '6/4/16: Replace GoSub
                            'GoSub ErrorMsg
                            mErrorMsg slMsg, lbcNotSchd
                            sgCntrSchStatus = slMsg
                            bgCntrSchError = True
                            gSchCntr = False
                            Exit Function
                        End If
                    End If
                End If
            Else
                'Swap chfcode values in clf and cff
                Do
                    If igDoEvent Then
                        DoEvents
                    End If
                    llRecPos = tmClfExt(ilLoop).lChfCode    'lChfCode replaced with line record position
                    ilRet = btrGetDirect(hmClf, tmCClf, imClfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CLF"
                        '6/4/16: Replace GoSub
                        'GoSub ErrorMsg
                        mErrorMsg slMsg, lbcNotSchd
                        sgCntrSchStatus = slMsg
                        bgCntrSchError = True
                        gSchCntr = False
                        Exit Function
                    End If
                    'tmSRec = tmCClf
                    'ilRet = gGetByKeyForUpdate("CLF", hmClf, tmSRec)
                    'tmCClf = tmSRec
                    'If igDoEvent Then
                    '    DoEvents
                    'End If
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    If ilRet >= 30000 Then
                    '        ilRet = csiHandleValue(0, 7)
                    '    End If
                    '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CLF"
                    '    GoSub ErrorMsg
                    '    Exit Function
                    'End If
                    ilRet = btrDelete(hmClf)
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop While ilRet = BTRV_ERR_CONFLICT
                If igDoEvent Then
                    DoEvents
                End If
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Delete CLF"
                    '6/4/16: Replace GoSub
                    'GoSub ErrorMsg
                    mErrorMsg slMsg, lbcNotSchd
                    sgCntrSchStatus = slMsg
                    bgCntrSchError = True
                    gSchCntr = False
                    Exit Function
                End If
                Do
                    If igDoEvent Then
                        DoEvents
                    End If
                    llRecPos = llPClfRecPos    'lChfCode replaced with line record position
                    ilRet = btrGetDirect(hmClf, tmPclf, imClfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CLF"
                        '6/4/16: Replace GoSub
                        'GoSub ErrorMsg
                        mErrorMsg slMsg, lbcNotSchd
                        sgCntrSchStatus = slMsg
                        bgCntrSchError = True
                        gSchCntr = False
                        Exit Function
                    End If
                    'tmSRec = tmPclf
                    'ilRet = gGetByKeyForUpdate("CLF", hmClf, tmSRec)
                    'tmPclf = tmSRec
                    'If igDoEvent Then
                    '    DoEvents
                    'End If
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    If ilRet >= 30000 Then
                    '        ilRet = csiHandleValue(0, 7)
                    '    End If
                    '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CLF"
                    '    GoSub ErrorMsg
                    '    Exit Function
                    'End If
                    ilRet = btrDelete(hmClf)
                Loop While ilRet = BTRV_ERR_CONFLICT
                If igDoEvent Then
                    DoEvents
                End If
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Delete CLF"
                    '6/4/16: Replace GoSub
                    'GoSub ErrorMsg
                    mErrorMsg slMsg, lbcNotSchd
                    sgCntrSchStatus = slMsg
                    bgCntrSchError = True
                    gSchCntr = False
                    Exit Function
                End If
                'Loop on flights (Cff)
                ReDim tmCCff(0 To 0) As CFF
                tlCffSrchKey.lChfCode = tmCClf.lChfCode  'tlChf.lCode
                tlCffSrchKey.iClfLine = tmCClf.iLine
                tlCffSrchKey.iCntRevNo = tmCClf.iCntRevNo
                tlCffSrchKey.iPropVer = tmCClf.iPropVer
                tlCffSrchKey.iStartDate(0) = 0
                tlCffSrchKey.iStartDate(1) = 0
                ilRet = btrGetGreaterOrEqual(hmCff, tlCff, imCffRecLen, tlCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tlCff.lChfCode = tmCClf.lChfCode) And (tlCff.iClfLine = tmCClf.iLine) And (tlCff.iCntRevNo = tmCClf.iCntRevNo) And (tlCff.iPropVer = tmCClf.iPropVer)
                    If igDoEvent Then
                        DoEvents
                    End If
                    'tmSRec = tlCff
                    'ilRet = gGetByKeyForUpdate("CFF", hmCff, tmSRec)
                    'tlCff = tmSRec
                    'If igDoEvent Then
                    '    DoEvents
                    'End If
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    If ilRet >= 30000 Then
                    '        ilRet = csiHandleValue(0, 7)
                    '    End If
                    '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CFF"
                    '    GoSub ErrorMsg
                    '    Exit Function
                    'End If
                    ilRet = btrDelete(hmCff)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_CONFLICT Then
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Delete CFF"
                            '6/4/16: Replace GoSub
                            'GoSub ErrorMsg
                            mErrorMsg slMsg, lbcNotSchd
                            sgCntrSchStatus = slMsg
                            bgCntrSchError = True
                            gSchCntr = False
                            Exit Function
                        End If
                        tmCCff(UBound(tmCCff)) = tlCff
                        'ReDim Preserve tmCCff(1 To UBound(tmCCff) + 1) As CFF
                        ReDim Preserve tmCCff(0 To UBound(tmCCff) + 1) As CFF
                    End If
                    tlCffSrchKey.lChfCode = tmCClf.lChfCode  'tlChf.lCode
                    tlCffSrchKey.iClfLine = tmCClf.iLine
                    tlCffSrchKey.iCntRevNo = tmCClf.iCntRevNo
                    tlCffSrchKey.iPropVer = tmCClf.iPropVer
                    tlCffSrchKey.iStartDate(0) = 0
                    tlCffSrchKey.iStartDate(1) = 0
                    ilRet = btrGetGreaterOrEqual(hmCff, tlCff, imCffRecLen, tlCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop
                ReDim tmPCff(0 To 0) As CFF
                'ReDim tmPCgf(1 To 1) As CGF
                ReDim tmPCgf(0 To 0) As CGF
                tlCffSrchKey.lChfCode = tmPclf.lChfCode  'tlChf.lCode
                tlCffSrchKey.iClfLine = tmPclf.iLine
                tlCffSrchKey.iCntRevNo = tmPclf.iCntRevNo
                tlCffSrchKey.iPropVer = tmPclf.iPropVer
                tlCffSrchKey.iStartDate(0) = 0
                tlCffSrchKey.iStartDate(1) = 0
                ilRet = btrGetGreaterOrEqual(hmCff, tlCff, imCffRecLen, tlCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tlCff.lChfCode = tmPclf.lChfCode) And (tlCff.iClfLine = tmPclf.iLine) And (tlCff.iCntRevNo = tmPclf.iCntRevNo) And (tlCff.iPropVer = tmPclf.iPropVer)
                    If igDoEvent Then
                        DoEvents
                    End If
                    'tmSRec = tlCff
                    'ilRet = gGetByKeyForUpdate("CFF", hmCff, tmSRec)
                    'tlCff = tmSRec
                    'If igDoEvent Then
                    '    DoEvents
                    'End If
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    If ilRet >= 30000 Then
                    '        ilRet = csiHandleValue(0, 7)
                    '    End If
                    '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CFF"
                    '    GoSub ErrorMsg
                    '    Exit Function
                    'End If
                    ilRet = btrDelete(hmCff)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_CONFLICT Then
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Delete CFF"
                            '6/4/16: Replace GoSub
                            'GoSub ErrorMsg
                            mErrorMsg slMsg, lbcNotSchd
                            sgCntrSchStatus = slMsg
                            bgCntrSchError = True
                            gSchCntr = False
                            Exit Function
                        End If
                        tmPCff(UBound(tmPCff)) = tlCff
                        'ReDim Preserve tmPCff(1 To UBound(tmPCff) + 1) As CFF
                        ReDim Preserve tmPCff(0 To UBound(tmPCff) + 1) As CFF
                        If igDoEvent Then
                            DoEvents
                        End If
                    End If
                    tlCffSrchKey.lChfCode = tmPclf.lChfCode  'tlChf.lCode
                    tlCffSrchKey.iClfLine = tmPclf.iLine
                    tlCffSrchKey.iCntRevNo = tmPclf.iCntRevNo
                    tlCffSrchKey.iPropVer = tmPclf.iPropVer
                    tlCffSrchKey.iStartDate(0) = 0
                    tlCffSrchKey.iStartDate(1) = 0
                    ilRet = btrGetGreaterOrEqual(hmCff, tlCff, imCffRecLen, tlCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    If igDoEvent Then
                        DoEvents
                    End If
               Loop
                For ilCff = LBound(tmPCff) To UBound(tmPCff) - 1 Step 1
                    If igDoEvent Then
                        DoEvents
                    End If
                    tmPCff(ilCff).lChfCode = tmCClf.lChfCode
                    tmPCff(ilCff).lCode = 0
                    ilRet = btrInsert(hmCff, tmPCff(ilCff), imCffRecLen, INDEXKEY1)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Insert CFF"
                        '6/4/16: Replace GoSub
                        'GoSub ErrorMsg
                        mErrorMsg slMsg, lbcNotSchd
                        sgCntrSchStatus = slMsg
                        bgCntrSchError = True
                        gSchCntr = False
                        Exit Function
                    End If
                Next ilCff
                For ilCff = LBound(tmCCff) To UBound(tmCCff) - 1 Step 1
                    If igDoEvent Then
                        DoEvents
                    End If
                    tmCCff(ilCff).lChfCode = tmPclf.lChfCode
                    tmCCff(ilCff).lCode = 0
                    ilRet = btrInsert(hmCff, tmCCff(ilCff), imCffRecLen, INDEXKEY1)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Insert CFF"
                        '6/4/16: Replace GoSub
                        'GoSub ErrorMsg
                        mErrorMsg slMsg, lbcNotSchd
                        sgCntrSchStatus = slMsg
                        bgCntrSchError = True
                        gSchCntr = False
                        Exit Function
                    End If
                Next ilCff
                llPCode = tmPclf.lChfCode
                tmPclf.lChfCode = tmCClf.lChfCode
                ilRet = btrInsert(hmClf, tmPclf, imClfRecLen, INDEXKEY0)
                If igDoEvent Then
                    DoEvents
                End If
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Delete CLF"
                    '6/4/16: Replace GoSub
                    'GoSub ErrorMsg
                    mErrorMsg slMsg, lbcNotSchd
                    sgCntrSchStatus = slMsg
                    bgCntrSchError = True
                    gSchCntr = False
                    Exit Function
                End If
                'tmCClf.lChfCode = tmPChf.lCode
                tmCClf.lChfCode = llPCode
                tmCClf.sSchStatus = "F"
                ilRet = btrInsert(hmClf, tmCClf, imClfRecLen, INDEXKEY0)
                If igDoEvent Then
                    DoEvents
                End If
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Insert CFF"
                    '6/4/16: Replace GoSub
                    'GoSub ErrorMsg
                    mErrorMsg slMsg, lbcNotSchd
                    sgCntrSchStatus = slMsg
                    bgCntrSchError = True
                    gSchCntr = False
                    Exit Function
                End If
            End If
        Next ilLoop
    End If
    'Moved below not lines so that CPM only can be scheduled
    gGetSyncDateTime smSyncDate, smSyncTime
    If llPChfRecPos = 0 Then
        Do
            If igDoEvent Then
                DoEvents
            End If
            ilRet = btrGetDirect(hmCHF, tmCChf, imCHFRecLen, lmCChfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
            If igDoEvent Then
                DoEvents
            End If
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CHF"
                '6/4/16: Replace GoSub
                'GoSub ErrorMsg
                mErrorMsg slMsg, lbcNotSchd
                    sgCntrSchStatus = slMsg
                    bgCntrSchError = True
                gSchCntr = False
                Exit Function
            End If
            ''tmSRec = tmCChf
            ''ilRet = gGetByKeyForUpdate("CHF", hmChf, tmSRec)
            ''tmCChf = tmSRec
            ''If igDoEvent Then
            ''    DoEvents
            ''End If
            ''If ilRet <> BTRV_ERR_NONE Then
            ''    If ilRet >= 30000 Then
            ''        ilRet = csiHandleValue(0, 7)
            ''    End If
            ''    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CHF"
            ''    GoSub ErrorMsg
            ''    Exit Function
            ''End If
            'gPackDate smSyncDate, tmCChf.iSyncDate(0), tmCChf.iSyncDate(1)
            'gPackTime smSyncTime, tmCChf.iSyncTime(0), tmCChf.iSyncTime(1)
            'tmCChf.iSourceID = tgUrf(0).iRemoteUserID
            If tmCChf.sStatus = "G" Then
                tmCChf.sStatus = "H"
            ElseIf tmCChf.sStatus = "N" Then
                tmCChf.sStatus = "O"
            End If
            tmCChf.sSchStatus = "F"
            tmCChf.sDelete = "N"
            tmCChf.iHdChg = 0
            ilRet = btrUpdate(hmCHF, tmCChf, imCHFRecLen)
            If igDoEvent Then
                DoEvents
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If igDoEvent Then
            DoEvents
        End If
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Update CHF"
            '6/4/16: Replace GoSub
            'GoSub ErrorMsg
            mErrorMsg slMsg, lbcNotSchd
            sgCntrSchStatus = slMsg
            bgCntrSchError = True
            gSchCntr = False
            Exit Function
        End If
    Else
        Do
            If igDoEvent Then
                DoEvents
            End If
            ilRet = btrGetDirect(hmCHF, tmCChf, imCHFRecLen, lmCChfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
            If igDoEvent Then
                DoEvents
            End If
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CHF"
                '6/4/16: Replace GoSub
                'GoSub ErrorMsg
                mErrorMsg slMsg, lbcNotSchd
                sgCntrSchStatus = slMsg
                bgCntrSchError = True
                gSchCntr = False
                Exit Function
            End If
            'tmSRec = tmCChf
            'ilRet = gGetByKeyForUpdate("CHF", hmChf, tmSRec)
            'tmCChf = tmSRec
            'If igDoEvent Then
            '    DoEvents
            'End If
            'If ilRet <> BTRV_ERR_NONE Then
            '    If ilRet >= 30000 Then
            '        ilRet = csiHandleValue(0, 7)
            '    End If
            '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CHF"
            '    GoSub ErrorMsg
            '    Exit Function
            'End If
            ilRet = btrDelete(hmCHF)
            If igDoEvent Then
                DoEvents
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If igDoEvent Then
            DoEvents
        End If
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Delete CHF"
            '6/4/16: Replace GoSub
            'GoSub ErrorMsg
            mErrorMsg slMsg, lbcNotSchd
            sgCntrSchStatus = slMsg
            bgCntrSchError = True
            gSchCntr = False
            Exit Function
        End If
'            If tgSpf.sRemoteUsers = "Y" Then
'                tmDsf.lCode = 0
'                tmDsf.sFileName = "CHF"
'                gPackDate smSyncDate, tmDsf.iSyncDate(0), tmDsf.iSyncDate(1)
'                gPackTime smSyncTime, tmDsf.iSyncTime(0), tmDsf.iSyncTime(1)
'                tmDsf.iRemoteID = tmCChf.iRemoteID
'                tmDsf.lAutoCode = tmCChf.lAutoCode
'                tmDsf.iSourceID = tgUrf(0).iRemoteUserID
'                tmDsf.lCntrNo = tmCChf.lCntrNo
'                ilRet = btrInsert(hmDsf, tmDsf, imDsfRecLen, INDEXKEY0)
'                If igDoEvent Then
'                    DoEvents
'                End If
'            End If
        Do
            If igDoEvent Then
                DoEvents
            End If
            ilRet = btrGetDirect(hmCHF, tmPChf, imCHFRecLen, llPChfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CHF"
                '6/4/16: Replace GoSub
                'GoSub ErrorMsg
                mErrorMsg slMsg, lbcNotSchd
                sgCntrSchStatus = slMsg
                bgCntrSchError = True
                gSchCntr = False
                Exit Function
            End If
            'tmSRec = tmPChf
            'ilRet = gGetByKeyForUpdate("CHF", hmChf, tmSRec)
            'tmPChf = tmSRec
            'If igDoEvent Then
            '    DoEvents
            'End If
            'If ilRet <> BTRV_ERR_NONE Then
            '    If ilRet >= 30000 Then
            '        ilRet = csiHandleValue(0, 7)
            '    End If
            '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CHF"
            '    GoSub ErrorMsg
            '    Exit Function
            'End If
            ilRet = btrDelete(hmCHF)
            If igDoEvent Then
                DoEvents
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Delete CHF"
            '6/4/16: Replace GoSub
            'GoSub ErrorMsg
            mErrorMsg slMsg, lbcNotSchd
            sgCntrSchStatus = slMsg
            bgCntrSchError = True
            gSchCntr = False
            Exit Function
        End If
'            If tgSpf.sRemoteUsers = "Y" Then
'                tmDsf.lCode = 0
'                tmDsf.sFileName = "CHF"
'                gPackDate smSyncDate, tmDsf.iSyncDate(0), tmDsf.iSyncDate(1)
'                gPackTime smSyncTime, tmDsf.iSyncTime(0), tmDsf.iSyncTime(1)
'                tmDsf.iRemoteID = tmPChf.iRemoteID
'                tmDsf.lAutoCode = tmPChf.lAutoCode
'                tmDsf.iSourceID = tgUrf(0).iRemoteUserID
'                tmDsf.lCntrNo = tmPChf.lCntrNo
'                ilRet = btrInsert(hmDsf, tmDsf, imDsfRecLen, INDEXKEY0)
'                If igDoEvent Then
'                    DoEvents
'                End If
'            End If
        llPCode = tmPChf.lCode
        'ilPRemoteID = tmPChf.iRemoteID
        'llPAutoCode = tmPChf.lAutoCode
        tmPChf.lCode = tmCChf.lCode
        tmPChf.sDelete = "Y"
        'tmPChf.iRemoteID = tmCChf.iRemoteID
        'tmPChf.lAutoCode = tmCChf.lAutoCode
        'gPackDate smSyncDate, tmPChf.iSyncDate(0), tmPChf.iSyncDate(1)
        'gPackTime smSyncTime, tmPChf.iSyncTime(0), tmPChf.iSyncTime(1)
        'tmPChf.iSourceID = tgUrf(0).iRemoteUserID
        ilRet = btrInsert(hmCHF, tmPChf, imCHFRecLen, INDEXKEY0)
        If igDoEvent Then
            DoEvents
        End If
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Insert CHF"
            '6/4/16: Replace GoSub
            'GoSub ErrorMsg
            mErrorMsg slMsg, lbcNotSchd
            sgCntrSchStatus = slMsg
            bgCntrSchError = True
            gSchCntr = False
            Exit Function
        End If
        tmCChf.lCode = llPCode
        'tmCChf.iRemoteID = ilPRemoteID
        'tmCChf.lAutoCode = llPAutoCode
        'gPackDate smSyncDate, tmCChf.iSyncDate(0), tmCChf.iSyncDate(1)
        'gPackTime smSyncTime, tmCChf.iSyncTime(0), tmCChf.iSyncTime(1)
        'tmCChf.iSourceID = tgUrf(0).iRemoteUserID
        If tmCChf.sStatus = "G" Then
            tmCChf.sStatus = "H"
        ElseIf tmCChf.sStatus = "N" Then
            tmCChf.sStatus = "O"
        End If
        tmCChf.sSchStatus = "F"
        tmCChf.sDelete = "N"
        tmCChf.iHdChg = 0
        ilRet = btrInsert(hmCHF, tmCChf, imCHFRecLen, INDEXKEY0)
        If igDoEvent Then
            DoEvents
        End If
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Insert CHF"
            '6/4/16: Replace GoSub
            'GoSub ErrorMsg
            mErrorMsg slMsg, lbcNotSchd
            sgCntrSchStatus = slMsg
            bgCntrSchError = True
            gSchCntr = False
            Exit Function
        End If
        ilRet = mSwapSbfMsfPcf(hmSbf, hmMsf, hmPcf, tmPChf.lCode, tmCChf.lCode)
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Moving SBF"
            '6/4/16: Replace GoSub
            'GoSub ErrorMsg
            mErrorMsg slMsg, lbcNotSchd
            sgCntrSchStatus = slMsg
            bgCntrSchError = True
            gSchCntr = False
            Exit Function
        End If
    End If
    If ilBeginTran = True Then
        ilRet = btrEndTrans(hmCHF)
    End If
    If igDoEvent Then
        DoEvents
    End If
    ilBeginTran = False
    'Change any previous Order to Delete
    If csiHandleValue(0, 15) > 0 Then
        ilRet = btrBeginTrans(hmCHF, 1000)
    Else
        ilRet = btrBeginTrans(hmCHF, -1000)
    End If
    If ilRet <> BTRV_ERR_NONE Then
        If ilRet >= 30000 Then
            ilRet = csiHandleValue(0, 7)
        End If
        slMsg = "I/O Error:" & str$(ilRet) & " Begin Transactions"
        '6/4/16: Replace GoSub
        'GoSub ErrorMsg
        mErrorMsg slMsg, lbcNotSchd
        sgCntrSchStatus = slMsg
        bgCntrSchError = True
        gSchCntr = False
        Exit Function
    End If
    If igDoEvent Then
        DoEvents
    End If
    ilRet = gAlertClear("A", "C", "S", tmCChf.lCode, 0, "")
    If tmPChf.lCode > 0 Then
        ilRet = gAlertClear("A", "C", "S", tmPChf.lCode, 0, "")
    End If
    ilRet = mSetDeleteFlag(lbcNotSchd)
    If igDoEvent Then
        DoEvents
    End If
    If Not ilRet Then
        ilRet = btrAbortTrans(hmCHF)
        If igDoEvent Then
            DoEvents
        End If
        mVehUnlock
        If igDoEvent Then
            DoEvents
        End If
        'ilLRet = btrUnlock(hmChf, BTRV_UNLOCK_MULTIPLE)
        ilLRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
        If igDoEvent Then
            DoEvents
        End If
       gSchCntr = False
        Exit Function
    End If
    ilRet = btrEndTrans(hmCHF)
    If igDoEvent Then
        DoEvents
    End If
    mVehUnlock
    If igDoEvent Then
        DoEvents
    End If
    'ilLRet = btrUnlock(hmChf, BTRV_UNLOCK_MULTIPLE)
    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
    If igDoEvent Then
        DoEvents
    End If
    If bgMegaphoneContract = True Then
        If smScheduleException = "" Then
            sgCntrSchStatus = "Scheduled: " & smAPIContract
        Else
            sgCntrSchStatus = "Scheduled in Counterpoint: " & smAPIContract & " " & smScheduleException
            mUpdateDigitalDlvyStatus tmCChf.lCode, DeliveryStatus_IssueEncountered
        End If
    Else
        sgCntrSchStatus = "Scheduled"
    End If
    bgCntrSchError = False 'Complete
    gSchCntr = True
    Exit Function
'ErrorMsg:
'    'If ilBeginTran Then
'        ilRet = btrAbortTrans(hmChf)
'    'End If
'    lbcNotSchd.AddItem slMsg
'    mVehUnlock
'    'ilLRet = btrUnlock(hmChf, BTRV_UNLOCK_MULTIPLE)
'    ilLRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
'    gSchCntr = False
'    Return
ErrorLock:
    ilLock = 1
    Resume Next
End Function

Private Sub mAdjustCounts(ilAHour() As Integer, ilADay() As Integer, ilAQH() As Integer, ilTHour() As Integer, ilTDay() As Integer, ilTQH() As Integer)
    Dim ilLoop As Integer
    For ilLoop = LBound(ilAHour) To UBound(ilAHour) Step 1
        If ilAHour(ilLoop) >= 0 Then
            ilTHour(ilLoop) = ilAHour(ilLoop)
        End If
    Next ilLoop
    If igDoEvent Then
        DoEvents
    End If
    For ilLoop = LBound(ilADay) To UBound(ilADay) Step 1
        If ilADay(ilLoop) >= 0 Then
            ilTDay(ilLoop) = ilADay(ilLoop)
        End If
    Next ilLoop
    If igDoEvent Then
        DoEvents
    End If
    For ilLoop = LBound(ilAQH) To UBound(ilAQH) Step 1
        If ilAQH(ilLoop) >= 0 Then
            ilTQH(ilLoop) = ilAQH(ilLoop)
        End If
    Next ilLoop
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mBalanceSpots                   *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Balance spots into SDF          *
'*                                                     *
'*******************************************************
Private Function mBalanceSpots(ilGameNo As Integer) As Integer
    Dim ilCUpperBound As Integer    'Last index into CFF for current version line
    Dim ilPUpperBound As Integer    'Last index into CFF for previou version line
    Dim ilCLoop As Integer          'Loop on current version line
    Dim ilPLoop As Integer          'Loop on previous version line
    Dim slDate As String            'Date as string
    Dim llCStartDate As Long        'Start date of flight for current version line
    Dim llCEndDate As Long          'End date of flight for current version line
    Dim llPStartDate As Long        'Start date of flight for previous version line
    Dim llPEndDate As Long          'End date of flight for previous version line
    Dim llPMonStartDate As Long     'Monday of the week for previous version
    Dim llPSunEndDate As Long       'Sunday of the week for previous version
    Dim llCMonStartDate As Long     'Monday of the week for current version
    Dim llCSunEndDate As Long       'Sunday of the week for current version
    Dim ilWeekExist As Integer      'True= week exist in current and previous
    Dim ilDay As Integer            'Week day
    Dim slMissedDate As String      'Missed date
    Dim llLegalDate As Long
    Dim tlCCff As CFF               'Current version CFF image to eliminate using index
    Dim tlPCff As CFF               'Previous version CFF image to eliminate using index
    Dim ilCurrentCount As Integer   'Current number of spots, used when a line was only partially scheduled
    Dim ilIDay As Integer
    Dim ilRet As Integer
    Dim ilUpper As Integer
    Dim llCLnEndDate As Long
    Dim llPLnEndDate As Long
    Dim llLastAirDate As Long   'Last actual allowed schedule date
    'Compare tmPCff to tmCCff and for each new week add the spots into Sdf
    ilCUpperBound = UBound(tmCCff) - 1
    ilPUpperBound = UBound(tmPCff) - 1
    'ReDim lgUnschSdfCode(1 To 1) As Long
    ReDim lgUnschSdfCode(0 To 0) As Long
    'ReDim tmPreferredInfo(1 To 1) As PREFERREDINFO
    ReDim tmPreferredInfo(0 To 0) As PREFERREDINFO

    gUnpackDateLong tmCClf.iEndDate(0), tmCClf.iEndDate(1), llCLnEndDate
    'Get last Date spot can air, it will be used to determine if spots
    llLastAirDate = llCLnEndDate
    For ilCLoop = LBound(tmCCff) To ilCUpperBound Step 1
        If igDoEvent Then
            DoEvents
        End If
        gUnpackDate tmCCff(ilCLoop).iStartDate(0), tmCCff(ilCLoop).iStartDate(1), slDate
        llCStartDate = gDateValue(slDate)
        gUnpackDate tmCCff(ilCLoop).iEndDate(0), tmCCff(ilCLoop).iEndDate(1), slDate
        llCEndDate = gDateValue(slDate)
        'If cancel before start- bypass test
        If llCEndDate < llCStartDate Then
            Exit For
        End If
        If (llLastAirDate >= llCStartDate) And (llLastAirDate <= llCEndDate) Then
            If (tmCCff(ilCLoop).sDyWk <> "D") Then
                For ilIDay = 6 To 0 Step -1
                    If tmCCff(ilCLoop).iDay(ilIDay) = 0 Then
                        llLastAirDate = llLastAirDate - 1
                    Else
                        Exit For
                    End If
                Next ilIDay
            End If
            Exit For
        End If
    Next ilCLoop

    For ilCLoop = LBound(tmCCff) To ilCUpperBound Step 1
        If igDoEvent Then
            DoEvents
        End If
        gUnpackDate tmCCff(ilCLoop).iStartDate(0), tmCCff(ilCLoop).iStartDate(1), slDate
        llCStartDate = gDateValue(slDate)
        gUnpackDate tmCCff(ilCLoop).iEndDate(0), tmCCff(ilCLoop).iEndDate(1), slDate
        llCEndDate = gDateValue(slDate)
        'If cancel before start- bypass test
        If llCEndDate < llCStartDate Then
            Exit For
        End If

        slDate = Format$(llCStartDate, "m/d/yy")
        slDate = gObtainPrevMonday(slDate)  'First flight start date might be within week- back up to monday
        llCMonStartDate = gDateValue(slDate)
        slDate = gObtainNextSunday(slDate)
        llCSunEndDate = gDateValue(slDate)
        If llCSunEndDate > llCEndDate Then
            llCSunEndDate = llCEndDate
        End If
        Do  'Current line week loop
            If igDoEvent Then
                DoEvents
            End If
            tlCCff = tmCCff(ilCLoop)
            ilWeekExist = False
            For ilPLoop = LBound(tmPCff) To ilPUpperBound Step 1
                If igDoEvent Then
                    DoEvents
                End If
                gUnpackDate tmPCff(ilPLoop).iStartDate(0), tmPCff(ilPLoop).iStartDate(1), slDate
                llPStartDate = gDateValue(slDate)
                gUnpackDate tmPCff(ilPLoop).iEndDate(0), tmPCff(ilPLoop).iEndDate(1), slDate
                llPEndDate = gDateValue(slDate)
                If llPEndDate < llPStartDate Then
                    Exit For
                End If
                slDate = Format$(llPStartDate, "m/d/yy")
                slDate = gObtainPrevMonday(slDate)  'First flight start date might be within week- back up to monday
                llPMonStartDate = gDateValue(slDate)
                slDate = gObtainNextSunday(slDate)
                llPSunEndDate = gDateValue(slDate)
                If llPSunEndDate > llPEndDate Then
                    llPSunEndDate = llPEndDate
                End If
                Do
                    If igDoEvent Then
                        DoEvents
                    End If
                    If (llPMonStartDate = llCMonStartDate) And ((llPSunEndDate <= llCSunEndDate) Or (llCSunEndDate <= llPSunEndDate)) Then
                        ilWeekExist = True
                        tlPCff = tmPCff(ilPLoop)
                        'Compare total number of spots
                        'If ((tlCCff.iSpotsWk <> 0) Or (tlCCff.iXSpotsWk <> 0)) And ((tlPCff.iSpotsWk <> 0) Or (tlPCff.iXSpotsWk <> 0)) Then
                        If ((tlCCff.sDyWk <> "D") And (tlPCff.sDyWk <> "D")) Then
                            'Both weekly
                            If tlCCff.iSpotsWk > tlPCff.iSpotsWk Then
                                'Add the difference
                                For ilDay = 0 To 6 Step 1
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If tlCCff.iDay(ilDay) <> 0 Then
                                        If (llCMonStartDate + ilDay >= llCStartDate) And (llCMonStartDate + ilDay <= llCEndDate) Then
                                            'slMissedDate = Format$(llCMonStartDate + ilDay, "m/d/yy")
                                            slMissedDate = mGetFirstLegalWkDate(hmLcf, "C", imCVefCode, llCMonStartDate + ilDay, tlCCff)
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If (smOrigLnSchStatus = "I") Then
                                                For ilIDay = 6 To 0 Step -1
                                                    If tlCCff.iDay(ilIDay) <> 0 Then
                                                        ilCurrentCount = mCountSpots(tmCChf.lCode, tmPclf.iLine, tmCFsf.lCode, ilGameNo, llCMonStartDate, llCMonStartDate + ilIDay, tlPCff.iSpotsWk)
                                                        If imVirtVehSpotAdj * tlCCff.iSpotsWk > ilCurrentCount Then
                                                            If igDoEvent Then
                                                                DoEvents
                                                            End If
                                                            ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * tlCCff.iSpotsWk - ilCurrentCount, ilGameNo)
                                                            If igDoEvent Then
                                                                DoEvents
                                                            End If
                                                            If Not ilRet Then
                                                                mBalanceSpots = False
                                                                Exit Function
                                                            End If
                                                        End If
                                                        Exit For
                                                    End If
                                                Next ilIDay
                                            Else
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * (tlCCff.iSpotsWk - tlPCff.iSpotsWk), ilGameNo)
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If Not ilRet Then
                                                    mBalanceSpots = False
                                                    Exit Function
                                                End If
                                            End If
                                            Exit For
                                        End If
                                    End If
                                Next ilDay
                            ElseIf tlCCff.iSpotsWk < tlPCff.iSpotsWk Then
                                'Remove spots- from start of week until end of partial week
                                For ilDay = 6 To 0 Step -1
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    'If tlCCff.iDay(ilDay) <> 0 Then
                                    If (tlCCff.iDay(ilDay) <> 0) Or (tlPCff.iDay(ilDay) <> 0) Then
                                        'If llCMonStartDate + ilDay <= llCEndDate Then
                                            If (smOrigLnSchStatus = "I") Then
                                                ilCurrentCount = mCountSpots(tmCChf.lCode, tmPclf.iLine, tmCFsf.lCode, ilGameNo, llCMonStartDate, llCMonStartDate + ilDay, tlPCff.iSpotsWk)
                                                If imVirtVehSpotAdj * tlCCff.iSpotsWk < ilCurrentCount Then
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    ilRet = mDeleteSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate, llCMonStartDate + ilDay, ilCurrentCount - imVirtVehSpotAdj * tlCCff.iSpotsWk, False, tmCChf.sCBSOrder)
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    If Not ilRet Then
                                                        mBalanceSpots = False
                                                        Exit Function
                                                    End If
                                                End If
                                            Else
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                ilRet = mDeleteSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate, llCMonStartDate + ilDay, imVirtVehSpotAdj * (tlPCff.iSpotsWk - tlCCff.iSpotsWk), True, tmCChf.sCBSOrder)
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If Not ilRet Then
                                                    mBalanceSpots = False
                                                    Exit Function
                                                End If
                                            End If
                                        'End If
                                        Exit For
                                    End If
                                Next ilDay
                            ElseIf (tlCCff.iSpotsWk = tlPCff.iSpotsWk) Then
                                If (tmPclf.sSchStatus = "M") Then
                                    'Add the difference
                                    For ilDay = 0 To 6 Step 1
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If tlCCff.iDay(ilDay) <> 0 Then
                                            If (llCMonStartDate + ilDay >= llCStartDate) And (llCMonStartDate + ilDay <= llCEndDate) Then
                                                'slMissedDate = Format$(llCMonStartDate + ilDay, "m/d/yy")
                                                slMissedDate = mGetFirstLegalWkDate(hmLcf, "C", imCVefCode, llCMonStartDate + ilDay, tlCCff)
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                For ilIDay = 6 To 0 Step -1
                                                    If tlCCff.iDay(ilIDay) <> 0 Then
                                                        ilCurrentCount = mCountSpots(tmCChf.lCode, tmPclf.iLine, tmCFsf.lCode, ilGameNo, llCMonStartDate, llCMonStartDate + ilIDay, tlPCff.iSpotsWk)
                                                        If imVirtVehSpotAdj * tlCCff.iSpotsWk > ilCurrentCount Then
                                                            If igDoEvent Then
                                                                DoEvents
                                                            End If
                                                            ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * tlCCff.iSpotsWk - ilCurrentCount, ilGameNo)
                                                            If igDoEvent Then
                                                                DoEvents
                                                            End If
                                                            If Not ilRet Then
                                                                mBalanceSpots = False
                                                                Exit Function
                                                            End If
                                                        ElseIf imVirtVehSpotAdj * tlCCff.iSpotsWk < ilCurrentCount Then
                                                            If igDoEvent Then
                                                                DoEvents
                                                            End If
                                                            ilRet = mDeleteSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate, llCMonStartDate + ilDay, ilCurrentCount - imVirtVehSpotAdj * tlCCff.iSpotsWk, False, tmCChf.sCBSOrder)
                                                            If igDoEvent Then
                                                                DoEvents
                                                            End If
                                                            If Not ilRet Then
                                                                mBalanceSpots = False
                                                                Exit Function
                                                            End If
                                                        End If
                                                        Exit For
                                                    End If
                                                Next ilIDay
                                                Exit For
                                            End If
                                        End If
                                    Next ilDay
                                End If
                            End If
                            For ilDay = 0 To 6 Step 1
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ((tlCCff.iDay(ilDay) <> tlPCff.iDay(ilDay)) And (tlCCff.iDay(ilDay) = 0)) Or (llCMonStartDate + ilDay > llCEndDate) Then
                                    'Remove spots from day (Sdf and Ssf)
                                    'The missed date might be set as illegal, but the code
                                    'below will correct all missed dates
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    ilRet = mPreemptSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, llLastAirDate)
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                   If Not ilRet Then
                                        mBalanceSpots = False
                                        Exit Function
                                    End If
                                End If
                            Next ilDay
                            'Test if any missed defined for illegal date- if so, change to legal dates
                            'This code will also correct any spots preempted above on the wrong date
                            For ilDay = 0 To 6 Step 1
                                If tlCCff.iDay(ilDay) <> 0 Then
                                    llLegalDate = llCMonStartDate + ilDay
                                    If llLegalDate >= lmEarliestAllowedDate Then
                                        Exit For
                                    End If
                                End If
                            Next ilDay
                            llLegalDate = gDateValue(mGetFirstLegalWkDate(hmLcf, "C", imCVefCode, llLegalDate, tlCCff))
                            For ilDay = 0 To 6 Step 1
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ((tlCCff.iDay(ilDay) <> tlPCff.iDay(ilDay)) And (tlCCff.iDay(ilDay) = 0)) Or (llCMonStartDate + ilDay > llCEndDate) Then
                                    'Find missed and change its date
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    ilRet = mMoveMissedToLegalDate(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, llLegalDate)
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If Not ilRet Then
                                        mBalanceSpots = False
                                        Exit Function
                                    End If
                                End If
                            Next ilDay
                            If igDoEvent Then
                                DoEvents
                            End If
                           If tlCCff.iXSpotsWk > tlPCff.iXSpotsWk Then
                                'Add the difference
                                For ilDay = 0 To 6 Step 1
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If (tlCCff.sXDay(ilDay) <> "0") And (tlCCff.sXDay(ilDay) <> " ") Then
                                        If (llCMonStartDate + ilDay >= llCStartDate) And (llCMonStartDate + ilDay <= llCEndDate) Then
                                            'slMissedDate = Format$(llCMonStartDate + ilDay, "m/d/yy")
                                            slMissedDate = mGetFirstLegalWkDate(hmLcf, "C", imCVefCode, llCMonStartDate + ilDay, tlCCff)
                                            If (smOrigLnSchStatus = "I") Then
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                ilCurrentCount = mCountSpots(tmCChf.lCode, tmPclf.iLine, tmCFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCSunEndDate, tlPCff.iXSpotsWk)
                                                If imVirtVehSpotAdj * tlCCff.iSpotsWk > ilCurrentCount Then
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * tlCCff.iXSpotsWk - ilCurrentCount, ilGameNo)
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    If Not ilRet Then
                                                        mBalanceSpots = False
                                                        Exit Function
                                                    End If
                                                End If
                                            Else
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * (tlCCff.iXSpotsWk - tlPCff.iXSpotsWk), ilGameNo)
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If Not ilRet Then
                                                    mBalanceSpots = False
                                                    Exit Function
                                                End If
                                            End If
                                            Exit For
                                        End If
                                    End If
                                Next ilDay
                            ElseIf tlCCff.iXSpotsWk < tlPCff.iXSpotsWk Then
                                'Remove spots- from the start of the partial week to the end of the week
                                For ilDay = 0 To 6 Step 1
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    'If tlCCff.sXDay(ilDay) <> "0" Then
                                    If ((tlCCff.sXDay(ilDay) <> "0") And (tlCCff.sXDay(ilDay) <> " ")) Or ((tlPCff.sXDay(ilDay) <> "0") And (tlPCff.sXDay(ilDay) <> " ")) Then
                                        'If llCMonStartDate + ilDay <= llCEndDate Then
                                            If (smOrigLnSchStatus = "I") Then
                                                'ilCurrentCount = mCountSpots(tmCChf.lCode, tmPClf.iLine, llCMonStartDate + ilDay, llCSunEndDate)
                                                ilCurrentCount = mCountSpots(tmCChf.lCode, tmPclf.iLine, tmCFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + 6, tlPCff.iXSpotsWk)
                                                If imVirtVehSpotAdj * tlCCff.iXSpotsWk < ilCurrentCount Then
                                                    'mDeleteSpots tmCChf.lCode, tmPClf.iLine, llCMonStartDate + ilDay, llCSunEndDate, ilCurrentCount - tlCCff.iXSpotsWk
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    ilRet = mDeleteSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + 6, ilCurrentCount - imVirtVehSpotAdj * tlCCff.iXSpotsWk, False, tmCChf.sCBSOrder)
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    If Not ilRet Then
                                                        mBalanceSpots = False
                                                        Exit Function
                                                    End If
                                                End If
                                            Else
                                                'mDeleteSpots tmCChf.lCode, tmPClf.iLine, llCMonStartDate + ilDay, llCSunEndDate, tlPCff.iXSpotsWk - tlCCff.iXSpotsWk
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                ilRet = mDeleteSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + 6, imVirtVehSpotAdj * (tlPCff.iXSpotsWk - tlCCff.iXSpotsWk), True, tmCChf.sCBSOrder)
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If Not ilRet Then
                                                    mBalanceSpots = False
                                                    Exit Function
                                                End If
                                            End If
                                        'End If
                                        Exit For
                                    End If
                                Next ilDay
                            End If
                            'Test if any spots are on illegal days
                            For ilDay = 0 To 6 Step 1
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ((tlCCff.sXDay(ilDay) <> tlPCff.sXDay(ilDay)) And ((tlCCff.sXDay(ilDay) = "0") Or (tlCCff.sXDay(ilDay) = " "))) Or (llCMonStartDate + ilDay > llCEndDate) Then
                                    'Remove spots from day (Sdf and Ssf)
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    ilRet = mPreemptSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, llLastAirDate)
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If Not ilRet Then
                                        mBalanceSpots = False
                                        Exit Function
                                    End If
                                End If
                            Next ilDay
                            'Test if any missed defined for illegal date- if so, change to legal dates
                            'This code will also correct any spots preempted above on the wrong date
                            For ilDay = 0 To 6 Step 1
                                If (tlCCff.sXDay(ilDay) <> "0") And (tlCCff.sXDay(ilDay) <> " ") Then
                                    llLegalDate = llCMonStartDate + ilDay
                                    If llLegalDate >= lmEarliestAllowedDate Then
                                        Exit For
                                    End If
                                End If
                            Next ilDay
                            llLegalDate = gDateValue(mGetFirstLegalWkDate(hmLcf, "C", imCVefCode, llLegalDate, tlCCff))
                            If igDoEvent Then
                                DoEvents
                            End If
                            For ilDay = 0 To 6 Step 1
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ((tlCCff.sXDay(ilDay) <> tlPCff.sXDay(ilDay)) And ((tlCCff.sXDay(ilDay) = "0") Or (tlCCff.sXDay(ilDay) = " "))) Or (llCMonStartDate + ilDay > llCEndDate) Then
                                    'Fined missed and change its date
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    ilRet = mMoveMissedToLegalDate(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, llLegalDate)
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If Not ilRet Then
                                        mBalanceSpots = False
                                        Exit Function
                                    End If
                                End If
                            Next ilDay
                        ElseIf (tlCCff.sDyWk = "D") And (tlPCff.sDyWk = "D") Then
                            'Both daily
                            For ilDay = 0 To 6 Step 1
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If tlCCff.iDay(ilDay) < tlPCff.iDay(ilDay) Then
                                    'Remove spots from day (Sdf and Ssf)
                                    If (smOrigLnSchStatus = "I") Then
                                        ilCurrentCount = mCountSpots(tmCChf.lCode, tmPclf.iLine, tmCFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, tlPCff.iDay(ilDay))
                                        If imVirtVehSpotAdj * tlCCff.iDay(ilDay) < ilCurrentCount Then
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            '3/14/13
                                            If tlCCff.iDay(ilDay) = 0 Then
                                                ilRet = mDeleteSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, 32000, False, tmCChf.sCBSOrder)
                                            Else
                                                ilRet = mDeleteSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, ilCurrentCount - imVirtVehSpotAdj * tlCCff.iDay(ilDay), False, tmCChf.sCBSOrder)
                                            End If
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If Not ilRet Then
                                                mBalanceSpots = False
                                                Exit Function
                                            End If
                                        End If
                                    Else
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        '3/14/13
                                        If tlCCff.iDay(ilDay) = 0 Then
                                            ilRet = mDeleteSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, 32000, True, tmCChf.sCBSOrder)
                                        Else
                                            ilRet = mDeleteSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, imVirtVehSpotAdj * (tlPCff.iDay(ilDay) - tlCCff.iDay(ilDay)), True, tmCChf.sCBSOrder)
                                        End If
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If Not ilRet Then
                                            mBalanceSpots = False
                                            Exit Function
                                        End If
                                    End If
                                ElseIf tlCCff.iDay(ilDay) > tlPCff.iDay(ilDay) Then
                                    If (llCMonStartDate + ilDay >= llCStartDate) And (llCMonStartDate + ilDay <= llCEndDate) Then
                                        'slMissedDate = Format$(llCMonStartDate + ilDay, "m/d/yy")
                                        slMissedDate = mGetFirstLegalWkDate(hmLcf, "C", imCVefCode, llCMonStartDate + ilDay, tlCCff)
                                        If (smOrigLnSchStatus = "I") Then
                                            ilCurrentCount = mCountSpots(tmCChf.lCode, tmPclf.iLine, tmCFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, tlPCff.iDay(ilDay))
                                            If imVirtVehSpotAdj * tlCCff.iDay(ilDay) > ilCurrentCount Then
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * tlCCff.iDay(ilDay) - ilCurrentCount, ilGameNo)
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If Not ilRet Then
                                                    mBalanceSpots = False
                                                    Exit Function
                                                End If
                                            End If
                                        Else
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * (tlCCff.iDay(ilDay) - tlPCff.iDay(ilDay)), ilGameNo)
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                           If Not ilRet Then
                                                mBalanceSpots = False
                                                Exit Function
                                            End If
                                        End If
                                    End If
                                ElseIf tlCCff.iDay(ilDay) = tlPCff.iDay(ilDay) Then
                                    'Remove spots from day (Sdf and Ssf)
                                    If (tmPclf.sSchStatus = "M") Then
                                        ilCurrentCount = mCountSpots(tmCChf.lCode, tmPclf.iLine, tmCFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, tlPCff.iDay(ilDay))
                                        If imVirtVehSpotAdj * tlCCff.iDay(ilDay) < ilCurrentCount Then
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            ilRet = mDeleteSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, ilCurrentCount - imVirtVehSpotAdj * tlCCff.iDay(ilDay), False, tmCChf.sCBSOrder)
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If Not ilRet Then
                                                mBalanceSpots = False
                                                Exit Function
                                            End If
                                        ElseIf imVirtVehSpotAdj * tlCCff.iDay(ilDay) > ilCurrentCount Then
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * tlCCff.iDay(ilDay) - ilCurrentCount, ilGameNo)
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If Not ilRet Then
                                                mBalanceSpots = False
                                                Exit Function
                                            End If
                                        End If
                                    End If
                                End If
                            Next ilDay
                        Else
                            'One is weekly, one is daily
                            If igDoEvent Then
                                DoEvents
                            End If
                            ilRet = mDeleteSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCMonStartDate, llCSunEndDate, 32000, True, tmCChf.sCBSOrder)
                            If igDoEvent Then
                                DoEvents
                            End If
                            If Not ilRet Then
                                mBalanceSpots = False
                                Exit Function
                            End If
                            ilWeekExist = False
                        End If
                        Exit For    'Week found- stop search
                    End If
                    llPMonStartDate = llPSunEndDate + 1
                    slDate = Format$(llPMonStartDate, "m/d/yy")
                    slDate = gObtainNextSunday(slDate)
                    llPSunEndDate = gDateValue(slDate)
                    If llPSunEndDate > llPEndDate Then
                        llPSunEndDate = llPEndDate
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop While llPMonStartDate <= llPEndDate
                If igDoEvent Then
                    DoEvents
                End If
            Next ilPLoop
            If Not ilWeekExist Then
                If (tlCCff.sDyWk <> "D") Then    'Weekly buy
                    For ilDay = 0 To 6 Step 1
                        If tlCCff.iDay(ilDay) <> 0 Then
                            If (llCMonStartDate + ilDay >= llCStartDate) And (llCMonStartDate + ilDay <= llCEndDate) Then
                                'slMissedDate = Format$(llCMonStartDate + ilDay, "m/d/yy")
                                slMissedDate = mGetFirstLegalWkDate(hmLcf, "C", imCVefCode, llCMonStartDate + ilDay, tlCCff)
                                ilUpper = UBound(tmPreferredInfo)
                                If gPreferredDefined(tmCClf, tmPreferredInfo(ilUpper).iDays(), tmPreferredInfo(ilUpper).lSTime, tmPreferredInfo(ilUpper).lETime) Then
                                    tmPreferredInfo(ilUpper).iNoPrefSpots = (imVirtVehSpotAdj * tlCCff.iSpotsWk * tgSaf(0).iPreferredPct) / 100
                                    If tmPreferredInfo(ilUpper).iNoPrefSpots <= 0 Then
                                        tmPreferredInfo(ilUpper).iNoPrefSpots = 1
                                    End If
                                    tmPreferredInfo(ilUpper).lSDate = gDateValue(slMissedDate)
                                    For ilIDay = 6 To 0 Step -1
                                        If tlCCff.iDay(ilIDay) <> 0 Then
                                            tmPreferredInfo(ilUpper).lEDate = tmPreferredInfo(ilUpper).lSDate + ilIDay
                                            Exit For
                                        End If
                                    Next ilIDay
                                    'ReDim Preserve tmPreferredInfo(1 To ilUpper + 1) As PREFERREDINFO
                                    ReDim Preserve tmPreferredInfo(0 To ilUpper + 1) As PREFERREDINFO
                                End If
                                If (smOrigLnSchStatus = "I") Then
                                    For ilIDay = 6 To 0 Step -1
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If tlCCff.iDay(ilIDay) <> 0 Then
                                            ilCurrentCount = mCountSpots(tmCChf.lCode, tmCClf.iLine, tmCFsf.lCode, ilGameNo, llCMonStartDate, llCMonStartDate + ilIDay, 0)
                                            If imVirtVehSpotAdj * tlCCff.iSpotsWk > ilCurrentCount Then
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * tlCCff.iSpotsWk - ilCurrentCount, ilGameNo)
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If Not ilRet Then
                                                    mBalanceSpots = False
                                                    Exit Function
                                                End If
                                            End If
                                            Exit For
                                        End If
                                    Next ilIDay
                                Else
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * tlCCff.iSpotsWk, ilGameNo)
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If Not ilRet Then
                                        mBalanceSpots = False
                                        Exit Function
                                    End If
                                End If
                                Exit For
                            End If
                        End If
                    If igDoEvent Then
                        DoEvents
                    End If
                    Next ilDay
                    If tlCCff.iXSpotsWk > 0 Then 'Split week
                        For ilDay = 0 To 6 Step 1
                            If igDoEvent Then
                                DoEvents
                            End If
                            If tlCCff.sXDay(ilDay) = "Y" Then
                                If (llCMonStartDate + ilDay >= llCStartDate) And (llCMonStartDate + ilDay <= llCEndDate) Then
                                    'slMissedDate = Format$(llCMonStartDate + ilDay, "m/d/yy")
                                    slMissedDate = mGetFirstLegalWkDate(hmLcf, "C", imCVefCode, llCMonStartDate + ilDay, tlCCff)
                                    If (smOrigLnSchStatus = "I") Then
                                        ilCurrentCount = mCountSpots(tmCChf.lCode, tmCClf.iLine, tmCFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCSunEndDate, 0)
                                        If imVirtVehSpotAdj * tlCCff.iXSpotsWk > ilCurrentCount Then
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * tlCCff.iXSpotsWk - ilCurrentCount, ilGameNo)
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If Not ilRet Then
                                                mBalanceSpots = False
                                                Exit Function
                                            End If
                                        End If
                                    Else
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * tlCCff.iXSpotsWk, ilGameNo)
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If Not ilRet Then
                                            mBalanceSpots = False
                                            Exit Function
                                        End If
                                    End If
                                    Exit For
                                End If
                            End If
                        Next ilDay
                    End If
                Else    'Daily
                    For ilDay = 0 To 6 Step 1
                        If igDoEvent Then
                            DoEvents
                        End If
                        If (llCMonStartDate + ilDay >= llCStartDate) And (llCMonStartDate + ilDay <= llCEndDate) Then
                            'slMissedDate = Format$(llCMonStartDate + ilDay, "m/d/yy")
                            slMissedDate = mGetFirstLegalWkDate(hmLcf, "C", imCVefCode, llCMonStartDate + ilDay, tlCCff)
                            If tlCCff.iDay(ilDay) > 0 Then
                                ilUpper = UBound(tmPreferredInfo)
                                If gPreferredDefined(tmCClf, tmPreferredInfo(ilUpper).iDays(), tmPreferredInfo(ilUpper).lSTime, tmPreferredInfo(ilUpper).lETime) Then
                                    tmPreferredInfo(ilUpper).iNoPrefSpots = (imVirtVehSpotAdj * tlCCff.iDay(ilDay) * tgSaf(0).iPreferredPct) / 100
                                    If tmPreferredInfo(ilUpper).iNoPrefSpots <= 0 Then
                                        tmPreferredInfo(ilUpper).iNoPrefSpots = 1
                                    End If
                                    tmPreferredInfo(ilUpper).lSDate = gDateValue(slMissedDate)
                                    tmPreferredInfo(ilUpper).lEDate = tmPreferredInfo(ilUpper).lSDate
                                    'ReDim Preserve tmPreferredInfo(1 To ilUpper + 1) As PREFERREDINFO
                                    ReDim Preserve tmPreferredInfo(0 To ilUpper + 1) As PREFERREDINFO
                                End If
                            End If
                            If (smOrigLnSchStatus = "I") Then
                                ilCurrentCount = mCountSpots(tmCChf.lCode, tmCClf.iLine, tmCFsf.lCode, ilGameNo, llCMonStartDate + ilDay, llCMonStartDate + ilDay, 0)
                                If ilCurrentCount < imVirtVehSpotAdj * tlCCff.iDay(ilDay) Then
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * tlCCff.iDay(ilDay) - ilCurrentCount, ilGameNo)
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If Not ilRet Then
                                        mBalanceSpots = False
                                        Exit Function
                                    End If
                                End If
                            Else
                                If igDoEvent Then
                                    DoEvents
                                End If
                                ilRet = mMakeUnschSpot(tlCCff, slMissedDate, imVirtVehSpotAdj * tlCCff.iDay(ilDay), ilGameNo)
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If Not ilRet Then
                                    mBalanceSpots = False
                                    Exit Function
                                End If
                            End If
                        End If
                    Next ilDay
                End If
            End If
            llCMonStartDate = llCSunEndDate + 1
            slDate = Format$(llCMonStartDate, "m/d/yy")
            slDate = gObtainNextSunday(slDate)
            llCSunEndDate = gDateValue(slDate)
            If llCSunEndDate > llCEndDate Then
                llCSunEndDate = llCEndDate
            End If
            If igDoEvent Then
                DoEvents
            End If
        Loop While llCMonStartDate <= llCEndDate
        If igDoEvent Then
            DoEvents
        End If
    Next ilCLoop
    For ilPLoop = LBound(tmPCff) To ilPUpperBound Step 1
        If igDoEvent Then
            DoEvents
        End If
        gUnpackDate tmPCff(ilPLoop).iStartDate(0), tmPCff(ilPLoop).iStartDate(1), slDate
        llPStartDate = gDateValue(slDate)
        gUnpackDate tmPCff(ilPLoop).iEndDate(0), tmPCff(ilPLoop).iEndDate(1), slDate
        llPEndDate = gDateValue(slDate)
        If llPEndDate < llPStartDate Then
            Exit For
        End If
        llPMonStartDate = llPStartDate
        slDate = Format$(llPMonStartDate, "m/d/yy")
        slDate = gObtainPrevMonday(slDate)  'First fligt start date might be within week- back up to monday
        llPMonStartDate = gDateValue(slDate)
        slDate = gObtainNextSunday(slDate)
        llPSunEndDate = gDateValue(slDate)
        If llPSunEndDate > llPEndDate Then
            llPSunEndDate = llPEndDate
        End If
        Do
            ilWeekExist = False
            For ilCLoop = LBound(tmCCff) To ilCUpperBound Step 1
                If igDoEvent Then
                    DoEvents
                End If
                gUnpackDate tmCCff(ilCLoop).iStartDate(0), tmCCff(ilCLoop).iStartDate(1), slDate
                llCStartDate = gDateValue(slDate)
                gUnpackDate tmCCff(ilCLoop).iEndDate(0), tmCCff(ilCLoop).iEndDate(1), slDate
                llCEndDate = gDateValue(slDate)
                If llCEndDate < llCStartDate Then
                    Exit For
                End If
                slDate = Format$(llCStartDate, "m/d/yy")
                slDate = gObtainPrevMonday(slDate)  'First fligt start date might be within week- back up to monday
                llCMonStartDate = gDateValue(slDate)
                slDate = gObtainNextSunday(slDate)
                llCSunEndDate = gDateValue(slDate)
                If llCSunEndDate > llCEndDate Then
                    llCSunEndDate = llCEndDate
                End If
                Do
                    If igDoEvent Then
                        DoEvents
                    End If
                    If (llCMonStartDate = llPMonStartDate) And ((llCSunEndDate <= llPSunEndDate) Or (llPSunEndDate <= llCSunEndDate)) Then
                        ilWeekExist = True
                        Exit For
                    End If
                    llCMonStartDate = llCSunEndDate + 1
                    slDate = Format$(llCMonStartDate, "m/d/yy")
                    slDate = gObtainNextSunday(slDate)
                    llCSunEndDate = gDateValue(slDate)
                    If llCSunEndDate > llCEndDate Then
                        llCSunEndDate = llCEndDate
                    End If
                Loop While llCMonStartDate <= llCEndDate
            Next ilCLoop
            If Not ilWeekExist Then
                'Remove all spots from week unless in past
                If igDoEvent Then
                    DoEvents
                End If
                ilRet = mDeleteSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llPMonStartDate, llPSunEndDate, 32000, True, tmCChf.sCBSOrder)
                If igDoEvent Then
                    DoEvents
                End If
                If Not ilRet Then
                    mBalanceSpots = False
                    Exit Function
                End If
            End If
            llPMonStartDate = llPSunEndDate + 1
            slDate = Format$(llPMonStartDate, "m/d/yy")
            slDate = gObtainNextSunday(slDate)
            llPSunEndDate = gDateValue(slDate)
            If llPSunEndDate > llPEndDate Then
                llPSunEndDate = llPEndDate
            End If
            If igDoEvent Then
                DoEvents
            End If
        Loop While llPMonStartDate <= llPEndDate
        If igDoEvent Then
            DoEvents
        End If
    Next ilPLoop
    '8/18/06:  Determine if line terminated.  If so, remove MG and Outsides beyond the new end date
    If tmPclf.lChfCode > 0 Then 'previous
        gUnpackDateLong tmCClf.iEndDate(0), tmCClf.iEndDate(1), llCLnEndDate
        gUnpackDateLong tmPclf.iEndDate(0), tmPclf.iEndDate(1), llPLnEndDate
        If llCLnEndDate < llPLnEndDate Then
            'Reset all MG/Outside beyond llCLnEndDate + 1 back to missed
            llCStartDate = llCLnEndDate + 1
            ilRet = mPreemptMGOutsideSpots(tmCChf.lCode, tmPclf.iLine, tmPFsf.lCode, ilGameNo, llCStartDate)
        End If
    End If
    mBalanceSpots = True
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mBBTest                         *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Test for competitive conflicts  *
'*                     within BB's and room            *
'*                                                     *
'*******************************************************
Private Function mBBTest(ilMnfComp0 As Integer, ilMnfComp1 As Integer, slBB As String, llChfCode As Long, ilLineNo As Integer, ilAvailIndex As Integer) As Integer
'
'   ilRet = mBBTest (ilMnfComp0, ilMnfComp1, slBB, ilAvailIndex, llChfCode, ilLineNo)
'   Where:
'       ilMnfComp0(I)- Contract header Competitive code # 1
'       ilMnfComp1(I)- Contract header Comptitive code # 2
'       slBB(I)- Billboard test
'       llChfCode(I)- Contract header code
'       ilLineNo(I)- Line number
'       llFsfCode(I)- Feed code
'       ilAvailIndex(I)- Index into tgSsf for avail to be processed
'       ilRet(O)- True = No conflicts; False= Conflicts
'
'       tmSdf contains the spot record to be checked
'       imDayIndex contains the day to be checked ( start at 0)
'       tgSsf contains the days events
    Dim ilLoop As Integer
    Dim ilIndex As Integer
    Dim ilUnits As Integer
    Dim ilPass As Integer
    Dim ilPassMax As Integer
    If (slBB = "N") Or (Trim$(slBB) = "") Or (llChfCode <= 0) Then
        mBBTest = True
        Exit Function
    End If
    'Using gCreateBBSpot, BB spots created during Log Generation
    mBBTest = True
    Exit Function
    If slBB = "B" Then
        ilPassMax = 2
    Else
        ilPassMax = 1
    End If
    For ilPass = 1 To ilPassMax Step 1
        If ilPass = 1 Then
            If (slBB = "O") Or (slBB = "B") Then
                gFindBBAvail tgSsf(imDayIndex), ilAvailIndex, "O", ilLoop
            Else
                gFindBBAvail tgSsf(imDayIndex), ilAvailIndex, "C", ilLoop
            End If
        Else
            gFindBBAvail tgSsf(imDayIndex), ilAvailIndex, "C", ilLoop
        End If
        If ilLoop <> -1 Then
            tmAvailTest = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilLoop)
            'Test for room
            ilUnits = tmAvailTest.iAvInfo And &H1F
            If ilUnits > 0 Then
                If tmAvailTest.iNoSpotsThis + 1 > ilUnits Then
                    mBBTest = False
                    Exit Function
                End If
            End If
            If tmAvailTest.iLen > 0 Then
                If (tmAvailTest.iNoSpotsThis + 1) * tgVpf(imCVpfIndex).iSBBLen > tmAvailTest.iLen Then
                    mBBTest = False
                    Exit Function
                End If
            End If
            'Test for competitive conflicts
            For ilIndex = ilLoop + 1 To tmAvailTest.iNoSpotsThis Step 1
                LSet tmBBSpotTest = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                If (tmBBSpotTest.lChfCode <> llChfCode) Or (tmBBSpotTest.iLineNo <> ilLineNo) Then
                    If (ilMnfComp0 <> 0) And ((ilMnfComp0 = tmBBSpotTest.iMnfComp(0)) Or (ilMnfComp0 = tmBBSpotTest.iMnfComp(1))) Then
                        mBBTest = False
                        Exit Function
                    ElseIf (ilMnfComp1 <> 0) And ((ilMnfComp1 = tmBBSpotTest.iMnfComp(0)) Or (ilMnfComp1 = tmBBSpotTest.iMnfComp(1))) Then
                        mBBTest = False
                        Exit Function
                    End If
                End If
            Next ilIndex
        Else
            'Test if BB can be created- do later
            mBBTest = False
            Exit Function
        End If
    Next ilPass
    mBBTest = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mBookIntoAvailTest              *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Test if spot can be booked into *
'*                     avail and if so, book spot      *
'*                                                     *
'*******************************************************
Private Function mBookIntoAvailTest(ilSchMode As Integer, ilLen As Integer, llSepLength As Long, ilMnfComp0 As Integer, ilMnfComp1 As Integer, slBB As String, llChfCode As Long, ilLineNo As Integer, ilBkAvailIndex As Integer, slInOut As String, slPreempt As String, il1stPosition As Integer, slSoloAvail As String, ilPriceLevel As Integer) As Integer
'
'   ilRet = mBookIntoAvailTest (ilSchMode, ilLen, llSepLength, ilMnfComp0, ilMnfComp1, llChfCode, ilLineNo, ilBkAvailIndex)
'   Where:
'       ilSchMode(I)- Schedule mode (0=Insert; 1=Move; 2=Compact; 3=Preempt)
'       ilLen(I) - Spot length
'       llSepLength(I)- advertiser separation length (in seconds)
'       ilMnfComp0(I)- Contract header Competitive code # 1
'       ilMnfComp1(I)- Contract header Comptitive code # 2
'       slBB(I)- billboard type
'       llChfCode(I)- Contract header code
'       ilLineNo(I)- Line number
'       ilBkAvailIndex(O)- Avail to book spot into if ilRet is True
'       ilRet(O)- True = spot booked; False= Spot not booked
'
'       imAvailSubRec contains the avail indicies within Ssf to test
'       tmSdf contains the spot record to be checked
'       imDayIndex contains the day to be checked
'       tgSsf contains the days events
'       imBkQH rank
'
    Dim ilLoop As Integer
    Dim ilIndex As Integer
    Dim ilAvailOk As Integer
    Dim ilUnits As Integer
    Dim ilLenSold As Integer
    Dim ilTUnits As Integer
    Dim ilSpot1stPosition As Integer
    Dim ilNoSecSpot As Integer
    Dim ilSecTUnits As Integer
    Dim ilTestPreempt As Integer
    Dim tlSpot As CSPOTSS

    Select Case ilSchMode
        Case 0  'Insert mode (only avails with room are included within imAvailSubRec)
                'If buying 1stposition, then only avails without a  spot aslo buying first position are within imAvailSubRec
                'If buying Solo, then only avails matching length and without spots are within imAvailSubRec
            For ilLoop = LBound(imAvailSubRec) To UBound(imAvailSubRec) Step 1
                If igDoEvent Then
                    DoEvents
                End If
                ilAvailOk = True
               LSet tmAvail = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + imAvailSubRec(ilLoop))
                If imRafPass = 0 Then
                    ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                Else
                    ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                End If
                If igDoEvent Then
                    DoEvents
                End If
                If ilAvailOk Then
                    If imRafPass = 0 Then
                        ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                    Else
                        ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilAvailOk Then
                        ilAvailOk = mBBTest(ilMnfComp0, ilMnfComp1, slBB, llChfCode, ilLineNo, imAvailSubRec(ilLoop))
                        If ilAvailOk Then
                            ilBkAvailIndex = imAvailSubRec(ilLoop)
                            mBookIntoAvailTest = True
                            Exit Function
                        End If
                    End If
                End If
            Next ilLoop
        Case 1  'Move mode
        Case 2  'Compact mode
        Case 3  'Pre-empt mode
            'For region buys, allow preempt mode only during second pass (book anyplace)
            'In first pass looking for primary to link with
            If imRafPass = 0 Then
                mBookIntoAvailTest = False
                Exit Function
            End If
            'Test if room exist- if so then don't preempt any spots
            'If insufficient room, then preempt one spot to make room
            'If buying 1st Position, then avails with or without buying first position are included
            'If buying Solo, then avail length match spot length and only one spot in avail to be in imAvailSubRec
            For ilLoop = LBound(imAvailSubRec) To UBound(imAvailSubRec) Step 1
                If igDoEvent Then
                    DoEvents
                End If
                ilAvailOk = True
               LSet tmAvail = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + imAvailSubRec(ilLoop))

                If slSoloAvail = "Y" Then
                    If (tmAvail.iNoSpotsThis = 1) And (ilLen = tmAvail.iLen) Then
                        ilIndex = imAvailSubRec(ilLoop) + 1
                       LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                        'If (tmSpot.iRank > imBkQH) And (tmSpot.iRank <> RESERVATION) And ((tmSpot.iRecType And SSPREEMPTIBLE) = SSPREEMPTIBLE) And ((tmAvail.iAvInfo And SSLOCKSPOT) <> SSLOCKSPOT) Then
                        'ReDim tgSpotMove(1 To 1) As SPOTMOVE
                        ReDim tgSpotMove(0 To 0) As SPOTMOVE
                        If igDoEvent Then
                            DoEvents
                        End If
                        If gPreemptible(3, tgSpotMove(), tmAvail, tmSpot, imBkQH, slInOut, slPreempt, ilPriceLevel) Then
                            'ReDim tgSpotMove(1 To 2) As SPOTMOVE
                            ReDim tgSpotMove(0 To 1) As SPOTMOVE
                            If igDoEvent Then
                                DoEvents
                            End If
                            'tgSpotMove(1).iSpotIndex = ilIndex
                            'tgSpotMove(1).lSpotSsfRecPos = lgSsfRecPos(imDayIndex)
                            'tgSpotMove(1).lSdfCode = tmSpot.lSdfCode
                            tgSpotMove(0).iSpotIndex = ilIndex
                            tgSpotMove(0).lSpotSsfRecPos = lgSsfRecPos(imDayIndex)
                            tgSpotMove(0).lSdfCode = tmSpot.lSdfCode
                            If imRafPass = 0 Then
                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                            Else
                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilAvailOk Then
                                If imRafPass = 0 Then
                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                                Else
                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilAvailOk Then
                                    ilAvailOk = mBBTest(ilMnfComp0, ilMnfComp1, slBB, llChfCode, ilLineNo, imAvailSubRec(ilLoop))
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If ilAvailOk Then
                                        ilBkAvailIndex = imAvailSubRec(ilLoop)
                                        mBookIntoAvailTest = True
                                        Exit Function
                                    End If
                                End If
                            End If
                            'ReDim tgSpotMove(1 To 1) As SPOTMOVE
                            ReDim tgSpotMove(0 To 0) As SPOTMOVE
                        End If
                        If igDoEvent Then
                            DoEvents
                        End If
                    End If
                Else
                    If (tgVpf(imCVpfIndex).sSSellOut = "T") Then
                       ilUnits = ilLen \ 30
                       If ilUnits <= 0 Then
                           ilUnits = 1
                       End If
                    Else
                       ilUnits = 1
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                    If tmAvail.iNoSpotsThis >= 1 Then
                       LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + imAvailSubRec(ilLoop) + 1)
                        '3/22/10
                        'If (tmSpot.iPosLen And SS1STPOSITION) = SS1STPOSITION Then
                        If (tmSpot.lBkInfo And SS1STPOSITION) = SS1STPOSITION Then
                            ilSpot1stPosition = 1
                        Else
                            ilSpot1stPosition = -1  'use -1 instead of zero so the test against il1stPosition will work
                        End If
                    Else
                        ilSpot1stPosition = -1
                    End If
                    'to get the avail into imAvailSubRec it had to defined with enough
                    'units and time
                    ilLenSold = 0
                    ilNoSecSpot = 0
                    ilSecTUnits = 0
                    For ilIndex = imAvailSubRec(ilLoop) + 1 To imAvailSubRec(ilLoop) + tmAvail.iNoSpotsThis Step 1
                        If igDoEvent Then
                            DoEvents
                        End If
                       LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                        If (tmSpot.iRecType And SSSPLITSEC) <> SSSPLITSEC Then
                            ilLenSold = ilLenSold + (tmSpot.iPosLen And &HFFF)
                        Else
                            ilNoSecSpot = ilNoSecSpot + 1
                            If (tgVpf(imCVpfIndex).sSSellOut = "T") Then
                                If ((tmSpot.iPosLen And &HFFF) \ 30) <= 0 Then
                                    ilSecTUnits = ilSecTUnits + 1
                                Else
                                    ilSecTUnits = ilSecTUnits + (tmSpot.iPosLen And &HFFF) \ 30
                                End If
                            Else
                                ilSecTUnits = ilSecTUnits + 1
                            End If
                        End If
                    Next ilIndex
                    If (tgVpf(imCVpfIndex).sSSellOut = "B") Or (tgVpf(imCVpfIndex).sSSellOut = "U") Then
'                        ilLenSold = 0
'                        For ilIndex = imAvailSubRec(ilLoop) + 1 To imAvailSubRec(ilLoop) + tmAvail.iNoSpotsThis Step 1
'                            If igDoEvent Then
'                                DoEvents
'                            End If
'                           LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
'                            ilLenSold = ilLenSold + (tmSpot.iPosLen And &HFFF)
'                        Next ilIndex
                        If igDoEvent Then
                            DoEvents
                        End If
                        If (ilLen <= (tmAvail.iLen - ilLenSold)) And (1 <= (tmAvail.iAvInfo And &H1F) - tmAvail.iNoSpotsThis + ilNoSecSpot) And (ilSpot1stPosition <> il1stPosition) Then
                            If imRafPass = 0 Then
                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                            Else
                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilAvailOk Then
                                If imRafPass = 0 Then
                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                                Else
                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilAvailOk Then
                                    ilAvailOk = mBBTest(ilMnfComp0, ilMnfComp1, slBB, llChfCode, ilLineNo, imAvailSubRec(ilLoop))
                                    If ilAvailOk Then
                                        ilBkAvailIndex = imAvailSubRec(ilLoop)
                                        mBookIntoAvailTest = True
                                        Exit Function
                                    End If
                                End If
                            End If
                        Else    'Insuffient room- test if spot can be preempted
                            For ilIndex = imAvailSubRec(ilLoop) + 1 To imAvailSubRec(ilLoop) + tmAvail.iNoSpotsThis Step 1
                                If igDoEvent Then
                                    DoEvents
                                End If
                               LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                                'If (tmSpot.iRank > imBkQH) And (tmSpot.iRank <> RESERVATION) And ((tmSpot.iRecType And SSPREEMPTIBLE) = SSPREEMPTIBLE) And ((tmAvail.iAvInfo And SSLOCKSPOT) <> SSLOCKSPOT) Then
                                'ReDim tgSpotMove(1 To 1) As SPOTMOVE
                                ReDim tgSpotMove(0 To 0) As SPOTMOVE
                                If igDoEvent Then
                                    DoEvents
                                End If
                                'Disallow preempting if this is a secondary spot or this is a primary with secondary
                                ilTestPreempt = True
                                If (tmSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                                    ilTestPreempt = False
                                ElseIf ((tmSpot.iRecType And SSSPLITPRI) = SSSPLITPRI) Then
                                    If ilIndex + 1 <= imAvailSubRec(ilLoop) + tmAvail.iNoSpotsThis Then
                                       LSet tlSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex + 1)
                                        If (tlSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                                            ilTestPreempt = False
                                        End If
                                    End If
                                End If
                                If ilTestPreempt Then
                                    If gPreemptible(3, tgSpotMove(), tmAvail, tmSpot, imBkQH, slInOut, slPreempt, ilPriceLevel) Then
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If ilLen <= (tmAvail.iLen - ilLenSold + (tmSpot.iPosLen And &HFFF)) Then
                                            'ReDim tgSpotMove(1 To 2) As SPOTMOVE
                                            ReDim tgSpotMove(0 To 1) As SPOTMOVE
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            'tgSpotMove(1).iSpotIndex = ilIndex
                                            'tgSpotMove(1).lSpotSsfRecPos = lgSsfRecPos(imDayIndex)
                                            'tgSpotMove(1).lSdfCode = tmSpot.lSdfCode
                                            tgSpotMove(0).iSpotIndex = ilIndex
                                            tgSpotMove(0).lSpotSsfRecPos = lgSsfRecPos(imDayIndex)
                                            tgSpotMove(0).lSdfCode = tmSpot.lSdfCode
                                            If imRafPass = 0 Then
                                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                                            Else
                                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                                            End If
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If ilAvailOk Then
                                                If imRafPass = 0 Then
                                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                                                Else
                                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                                                End If
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If ilAvailOk Then
                                                    ilAvailOk = mBBTest(ilMnfComp0, ilMnfComp1, slBB, llChfCode, ilLineNo, imAvailSubRec(ilLoop))
                                                    If ilAvailOk Then
                                                        ilBkAvailIndex = imAvailSubRec(ilLoop)
                                                        mBookIntoAvailTest = True
                                                        Exit Function
                                                    End If
                                                End If
                                            End If
                                            'ReDim tgSpotMove(1 To 1) As SPOTMOVE
                                            ReDim tgSpotMove(0 To 0) As SPOTMOVE
                                        End If
                                    End If
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If il1stPosition = 1 Then
                                    Exit For
                                End If
                            Next ilIndex
                        End If
                    ElseIf tgVpf(imCVpfIndex).sSSellOut = "M" Then
'                        ilLenSold = 0
'                        For ilIndex = imAvailSubRec(ilLoop) + 1 To imAvailSubRec(ilLoop) + tmAvail.iNoSpotsThis Step 1
'                            If igDoEvent Then
'                                DoEvents
'                            End If
'                           LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
'                            ilLenSold = ilLenSold + (tmSpot.iPosLen And &HFFF)
'                        Next ilIndex
                        If igDoEvent Then
                            DoEvents
                        End If
                        If (ilLen = (tmAvail.iLen - ilLenSold)) And (1 = (tmAvail.iAvInfo And &H1F) - tmAvail.iNoSpotsThis + ilNoSecSpot) And (ilSpot1stPosition <> il1stPosition) Then
                            If imRafPass = 0 Then
                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                            Else
                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilAvailOk Then
                                If imRafPass = 0 Then
                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                                Else
                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilAvailOk Then
                                    ilAvailOk = mBBTest(ilMnfComp0, ilMnfComp1, slBB, llChfCode, ilLineNo, imAvailSubRec(ilLoop))
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If ilAvailOk Then
                                        ilBkAvailIndex = imAvailSubRec(ilLoop)
                                        mBookIntoAvailTest = True
                                        Exit Function
                                    End If
                                End If
                            End If
                        Else    'Insuffient room- test if spot can be preempted
                            For ilIndex = imAvailSubRec(ilLoop) + 1 To imAvailSubRec(ilLoop) + tmAvail.iNoSpotsThis Step 1
                                If igDoEvent Then
                                    DoEvents
                                End If
                               LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                                'If (tmSpot.iRank > imBkQH) And (tmSpot.iRank <> RESERVATION) And ((tmSpot.iRecType And SSPREEMPTIBLE) = SSPREEMPTIBLE) And ((tmAvail.iAvInfo And SSLOCKSPOT) <> SSLOCKSPOT) Then
                                'ReDim tgSpotMove(1 To 1) As SPOTMOVE
                                ReDim tgSpotMove(0 To 0) As SPOTMOVE
                                If igDoEvent Then
                                    DoEvents
                                End If
                                ilTestPreempt = True
                                If (tmSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                                    ilTestPreempt = False
                                ElseIf ((tmSpot.iRecType And SSSPLITPRI) = SSSPLITPRI) Then
                                    If ilIndex + 1 <= imAvailSubRec(ilLoop) + tmAvail.iNoSpotsThis Then
                                       LSet tlSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex + 1)
                                        If (tlSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                                            ilTestPreempt = False
                                        End If
                                    End If
                                End If
                                If ilTestPreempt Then
                                    If gPreemptible(3, tgSpotMove(), tmAvail, tmSpot, imBkQH, slInOut, slPreempt, ilPriceLevel) Then
                                        If ilLen = (tmAvail.iLen - ilLenSold + (tmSpot.iPosLen And &HFFF)) Then
                                            'ReDim tgSpotMove(1 To 2) As SPOTMOVE
                                            ReDim tgSpotMove(0 To 1) As SPOTMOVE
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            'tgSpotMove(1).iSpotIndex = ilIndex
                                            'tgSpotMove(1).lSpotSsfRecPos = lgSsfRecPos(imDayIndex)
                                            'tgSpotMove(1).lSdfCode = tmSpot.lSdfCode
                                            tgSpotMove(0).iSpotIndex = ilIndex
                                            tgSpotMove(0).lSpotSsfRecPos = lgSsfRecPos(imDayIndex)
                                            tgSpotMove(0).lSdfCode = tmSpot.lSdfCode
                                            If imRafPass = 0 Then
                                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                                            Else
                                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                                            End If
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If ilAvailOk Then
                                                If imRafPass = 0 Then
                                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                                                Else
                                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                                                End If
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If ilAvailOk Then
                                                    ilAvailOk = mBBTest(ilMnfComp0, ilMnfComp1, slBB, llChfCode, ilLineNo, imAvailSubRec(ilLoop))
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    If ilAvailOk Then
                                                        ilBkAvailIndex = imAvailSubRec(ilLoop)
                                                        mBookIntoAvailTest = True
                                                        Exit Function
                                                    End If
                                                End If
                                            End If
                                            'ReDim tgSpotMove(1 To 1) As SPOTMOVE
                                            ReDim tgSpotMove(0 To 0) As SPOTMOVE
                                        End If
                                    End If
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If il1stPosition = 1 Then
                                    Exit For
                                End If
                            Next ilIndex
                        End If
                    Else    'T
                        If (tgVpf(imCVpfIndex).sSSellOut = "T") Then
                            For ilIndex = imAvailSubRec(ilLoop) + 1 To imAvailSubRec(ilLoop) + tmAvail.iNoSpotsThis Step 1
                                If igDoEvent Then
                                    DoEvents
                                End If
                               LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                                If ((tmSpot.iPosLen And &HFFF) \ 30) <= 0 Then
                                    ilTUnits = ilTUnits + 1
                                Else
                                    ilTUnits = ilTUnits + (tmSpot.iPosLen And &HFFF) \ 30
                                End If
                            Next ilIndex
                        Else
                            ilTUnits = tmAvail.iNoSpotsThis
                        End If
                        ilTUnits = ilTUnits - ilSecTUnits
                        If igDoEvent Then
                            DoEvents
                        End If
                        If (ilUnits <= (tmAvail.iAvInfo And &H1F) - ilTUnits) And (ilSpot1stPosition <> il1stPosition) Then
                            If imRafPass = 0 Then
                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                            Else
                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilAvailOk Then
                                If imRafPass = 0 Then
                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                                Else
                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilAvailOk Then
                                    ilAvailOk = mBBTest(ilMnfComp0, ilMnfComp1, slBB, llChfCode, ilLineNo, imAvailSubRec(ilLoop))
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If ilAvailOk Then
                                        ilBkAvailIndex = imAvailSubRec(ilLoop)
                                        mBookIntoAvailTest = True
                                        Exit Function
                                    End If
                                End If
                            End If
                        Else    'Insufficient room
                            For ilIndex = imAvailSubRec(ilLoop) + 1 To imAvailSubRec(ilLoop) + tmAvail.iNoSpotsThis Step 1
                                If igDoEvent Then
                                    DoEvents
                                End If
                               LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                                'If (tmSpot.iRank > imBkQH) And (tmSpot.iRank <> RESERVATION) And ((tmSpot.iRecType And SSPREEMPTIBLE) = SSPREEMPTIBLE) And ((tmAvail.iAvInfo And SSLOCKSPOT) <> SSLOCKSPOT) Then
                                'ReDim tgSpotMove(1 To 1) As SPOTMOVE
                                ReDim tgSpotMove(0 To 0) As SPOTMOVE
                                If igDoEvent Then
                                    DoEvents
                                End If
                                ilTestPreempt = True
                                If (tmSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                                    ilTestPreempt = False
                                ElseIf ((tmSpot.iRecType And SSSPLITPRI) = SSSPLITPRI) Then
                                    If ilIndex + 1 <= imAvailSubRec(ilLoop) + tmAvail.iNoSpotsThis Then
                                       LSet tlSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex + 1)
                                        If (tlSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                                            ilTestPreempt = False
                                        End If
                                    End If
                                End If
                                If ilTestPreempt Then
                                    If gPreemptible(3, tgSpotMove(), tmAvail, tmSpot, imBkQH, slInOut, slPreempt, ilPriceLevel) Then
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If (tgVpf(imCVpfIndex).sSSellOut = "T") Then
                                            ilTUnits = (tmSpot.iPosLen And &HFFF) \ 30
                                            If ilTUnits <= 0 Then
                                                ilTUnits = 1
                                            End If
                                        Else
                                            ilTUnits = 1
                                        End If
                                        If ilUnits <= (tmAvail.iAvInfo And &H1F) - tmAvail.iNoSpotsThis + ilTUnits Then
                                            'ReDim tgSpotMove(1 To 2) As SPOTMOVE
                                            ReDim tgSpotMove(0 To 1) As SPOTMOVE
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            'tgSpotMove(1).iSpotIndex = ilIndex
                                            'tgSpotMove(1).lSpotSsfRecPos = lgSsfRecPos(imDayIndex)
                                            'tgSpotMove(1).lSdfCode = tmSpot.lSdfCode
                                            tgSpotMove(0).iSpotIndex = ilIndex
                                            tgSpotMove(0).lSpotSsfRecPos = lgSsfRecPos(imDayIndex)
                                            tgSpotMove(0).lSdfCode = tmSpot.lSdfCode
                                            If imRafPass = 0 Then
                                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                                            Else
                                                ilAvailOk = gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, llSepLength, imAvailSubRec(ilLoop), tmSdf.iAdfCode, ilMnfComp0, ilMnfComp1, ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                                            End If
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If ilAvailOk Then
                                                If imRafPass = 0 Then
                                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, False)
                                                Else
                                                    ilAvailOk = gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), imCVpfIndex, ilLen, ilMnfComp0, ilMnfComp1, imAvailSubRec(ilLoop), tmVcf0(), tmVcf6(), tmVcf7(), ilSchMode, imBkQH, slInOut, slPreempt, ilPriceLevel, True)
                                                End If
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If ilAvailOk Then
                                                    ilAvailOk = mBBTest(ilMnfComp0, ilMnfComp1, slBB, llChfCode, ilLineNo, imAvailSubRec(ilLoop))
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    If ilAvailOk Then
                                                        ilBkAvailIndex = imAvailSubRec(ilLoop)
                                                        mBookIntoAvailTest = True
                                                        Exit Function
                                                    End If
                                                End If
                                            End If
                                            'ReDim tgSpotMove(1 To 1) As SPOTMOVE
                                            ReDim tgSpotMove(0 To 0) As SPOTMOVE
                                        End If
                                    End If
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If il1stPosition = 1 Then
                                    Exit For
                                End If
                            Next ilIndex
                        End If
                    End If
                End If
                If igDoEvent Then
                    DoEvents
                End If
           Next ilLoop
    End Select
    mBookIntoAvailTest = False
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mBookSpot                       *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Add spot to Ssf and change its  *
'*                     status                          *
'*                                                     *
'*******************************************************
Function mBookSpot(slSchStatus As String, ilAvailIndex As Integer, tlChf As CHF, tlClf As CLF, tlRdf As RDF, ilGameNo As Integer, ilAHour() As Integer, ilADay() As Integer, ilAQH() As Integer, ilCallType As Integer) As Integer
    Dim ilLoop As Integer
    Dim tlSdf As SDF
    Dim llSdfRecPos As Long
    Dim ilRet As Integer
    Dim ilIndex As Integer
    Dim llDate As Long
    Dim ilDayIndex As Integer
    Dim slXSpotType As String
    Dim slOrigSchStatus As String
    Dim ilPos As Integer
    Dim ilStationCount As Integer
    Dim ilReplacePrimary As Integer
    Dim ilSplitSecOk As Integer
    Dim ilSecCount As Integer
    Dim ilSpot As Integer
    Dim ilPriLen As Integer
    Dim ilLenOk As Integer
    '2/21/11: Replace GetDirect with GetEqual
    Dim llSDFCode As Long

    If igDoEvent Then
        DoEvents
    End If
    If csiHandleValue(0, 15) > 0 Then
        ilRet = btrBeginTrans(hmCHF, 1000)
    Else
        ilRet = btrBeginTrans(hmCHF, -1000)
    End If
    If igDoEvent Then
        DoEvents
    End If
    If ilRet <> BTRV_ERR_NONE Then
        mBookSpot = False
        Exit Function 'Exit without booking spot
    End If
    'If UBound(tgSpotMove) > 1 Then  'Preempt spot (and adjust ilAvailIndex if required)
    If UBound(tgSpotMove) > LBound(tgSpotMove) Then  'Preempt spot (and adjust ilAvailIndex if required)
        'For ilLoop = 1 To UBound(tgSpotMove) - 1 Step 1
        For ilLoop = LBound(tgSpotMove) To UBound(tgSpotMove) - 1 Step 1
            If igDoEvent Then
                DoEvents
            End If
            '2/21/11: Replace GetDiect with GetEqual
            llSDFCode = tgSpotMove(ilLoop).lSdfCode
            tmSdfSrchKey3.lCode = llSDFCode
            ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If igDoEvent Then
                DoEvents
            End If
            If ilRet <> BTRV_ERR_NONE Then
                ilRet = btrAbortTrans(hmCHF)
                mBookSpot = False
                Exit Function 'Exit without booking spot
            End If
            ilRet = btrGetPosition(hmSdf, llSdfRecPos)
            If igDoEvent Then
                DoEvents
            End If
            If ilRet <> BTRV_ERR_NONE Then
                ilRet = btrAbortTrans(hmCHF)
                mBookSpot = False
                Exit Function 'Exit without booking spot
            End If
            'Tracer read the spot into memory
            ilRet = gMakeTracer(hmSdf, tlSdf, 0, hmStf, lmLastLogDate, "M", "C", tlSdf.iRotNo, hmGsf)
            If igDoEvent Then
                DoEvents
            End If
            If Not ilRet Then
                ilRet = btrAbortTrans(hmCHF)
                mBookSpot = False
                Exit Function 'Exit without booking spot
            End If
            '2/21/11: Replace GetDirect with GetEqual
            'ilRet = btrGetDirect(hmSdf, tlSdf, imSdfRecLen, llSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
            tmSdfSrchKey3.lCode = llSDFCode
            ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If igDoEvent Then
                DoEvents
            End If
            If ilRet <> BTRV_ERR_NONE Then
                ilRet = btrAbortTrans(hmCHF)
                mBookSpot = False
                Exit Function 'Exit without booking spot
            End If
            'gChgSchSpot requires the spot be in memory and hmSdf pointing to it as the current record
            gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llDate
            ilDayIndex = gWeekDayLong(llDate)    'mVefCompConflictTest require this variable
            If igDoEvent Then
                DoEvents
            End If
            slOrigSchStatus = tlSdf.sSchStatus
            slXSpotType = tlSdf.sSpotType
            If Not gChgSchSpot("M", hmSdf, tlSdf, hmSmf, ilGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf) Then
                ilRet = btrAbortTrans(hmCHF)
                mBookSpot = False
                Exit Function
            End If
            If igDoEvent Then
                DoEvents
            End If
            If ilCallType = 1 Then
                Exit For
            End If
            If slXSpotType = "X" Then
                If ((tmSmf.lMtfCode <> 0) And (lgMtfNoRecs <> 0)) And ((slOrigSchStatus = "G") Or (slOrigSchStatus = "O")) Then
                    slXSpotType = ""
                End If
            Else
                slXSpotType = ""
            End If
            If slXSpotType = "X" Then
                If lgNoBonusRemoved < 100000 Then
                    lgNoBonusRemoved = lgNoBonusRemoved + 1
                End If
            End If
            'If (tlSdf.sSpotType <> "T") And (tlSdf.sSpotType <> "Q") And (tlSdf.sSpotType <> "S") And (tlSdf.sSpotType <> "M") And (slXSpotType <> "X") Then
            If (tlSdf.sSpotType <> "T") And (tlSdf.sSpotType <> "Q") And (tlSdf.sSpotType <> "S") And (tlSdf.sSpotType <> "M") And (slXSpotType <> "X") Or ((tlSdf.sSpotType = "M") And (tgSpf.sSchdPromo = "Y")) Or ((tlSdf.sSpotType = "S") And (tgSpf.sSchdPSA = "Y")) Or ((tlSdf.sSpotType = "T") And (tgSpf.sSchdRemnant = "Y")) Then
                lgReschSdfCode(UBound(lgReschSdfCode)) = tlSdf.lCode
                ReDim Preserve lgReschSdfCode(LBound(lgReschSdfCode) To UBound(lgReschSdfCode) + 1) As Long
            End If
            If igDoEvent Then
                DoEvents
            End If
            'Adjust index to avail
            If (ilAvailIndex > tgSpotMove(ilLoop).iSpotIndex) And (tgSpotMove(ilLoop).lSpotSsfRecPos = lgSsfRecPos(ilDayIndex)) Then
                ilAvailIndex = ilAvailIndex - 1
            End If
            For ilIndex = ilLoop + 1 To UBound(tgSpotMove) - 1 Step 1
                If igDoEvent Then
                    DoEvents
                End If
                If (tgSpotMove(ilIndex).iSpotIndex > tgSpotMove(ilLoop).iSpotIndex) And (tgSpotMove(ilIndex).lSpotSsfRecPos = lgSsfRecPos(ilDayIndex)) Then
                    tgSpotMove(ilIndex).iSpotIndex = tgSpotMove(ilIndex).iSpotIndex - 1
                End If
            Next ilIndex
            If igDoEvent Then
                DoEvents
            End If
        Next ilLoop
        'ReDim tgSpotMove(1 To 1) As SPOTMOVE
        ReDim tgSpotMove(0 To 0) As SPOTMOVE
        If igDoEvent Then
            DoEvents
        End If
    End If
    'Ssf read by direct read in gBookSpot, tmSdf must contain spot to be booked
    tmSmf.lChfCode = 0
    If igDoEvent Then
        DoEvents
    End If
    ilPos = 0
    ilReplacePrimary = False
    If imRafPass = 0 Then
        'Determine which primary this partial buy can be linked with
        imSsfRecLen = Len(tgSsf(imDayIndex))
        ilRet = gSSFGetDirect(hmSsf, tgSsf(imDayIndex), imSsfRecLen, lgSsfRecPos(imDayIndex), INDEXKEY0, BTRV_LOCK_NONE)
       LSet tmAvail = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilAvailIndex)
        For ilLoop = ilAvailIndex + 1 To ilAvailIndex + tmAvail.iNoSpotsThis Step 1
           LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilLoop)
            '10/6/08:  Remove lengt test
            'If ((tmSpot.iRecType And SSSPLITPRI) = SSSPLITPRI) And (tmSdf.iLen = (tmSpot.iPosLen And &HFFF)) Then
            ilLenOk = True
            ilPriLen = tmSpot.iPosLen And &HFFF
            If (Asc(tgSpf.sUsingFeatures7) And REGIONMIXLEN) <> REGIONMIXLEN Then
                If tmSdf.iLen <> ilPriLen Then
                    ilLenOk = False
                End If
            End If
            If ((tmSpot.iRecType And SSSPLITPRI) = SSSPLITPRI) And (ilLenOk) Then
                If Not gSplitNetworkStationConflicts(hmRaf, hmSef, hmSdf, hmClf, tmSpot.lSdfCode, tmStationsClf(), smClfInclExcl, ilStationCount) Then
                    ilSplitSecOk = True
                    For ilSpot = ilLoop + 1 To ilAvailIndex + tmAvail.iNoSpotsThis Step 1
                       LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilSpot)
                        If (tmSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                            If gSplitNetworkStationConflicts(hmRaf, hmSef, hmSdf, hmClf, tmSpot.lSdfCode, tmStationsClf(), smClfInclExcl, ilSecCount) Then
                                ilSplitSecOk = False
                            End If
                        Else
                            Exit For
                        End If
                    Next ilSpot
                    If ilSplitSecOk Then
                        If ilPriLen = tmSdf.iLen Then
                            If ilStationCount < UBound(tmStationsClf) - 1 Then
                                ilPos = ilLoop - ilAvailIndex
                                ilReplacePrimary = True
                            Else
                                ilPos = ilLoop - ilAvailIndex + 1
                            End If
                        ElseIf ilPriLen > tmSdf.iLen Then
                            ilPos = ilLoop - ilAvailIndex + 1
                        Else
                            ilPos = ilLoop - ilAvailIndex
                            ilReplacePrimary = True
                        End If
                        Exit For
                    End If
                End If
            End If
        Next ilLoop
        If ilPos = 0 Then
            ilRet = btrAbortTrans(hmCHF)
            mBookSpot = False
            Exit Function 'Exit without booking spot
        End If
    End If
    ilRet = gBookSpot(slSchStatus, hmSdf, tmSdf, 0, imBkQH, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), ilAvailIndex, ilPos, tlChf, tlClf, tlRdf, imCVpfIndex, hmSmf, tmSmf, hmClf, hmCrf, imPriceLevel, ilReplacePrimary, hmSxf, hmGsf)
    If igDoEvent Then
        DoEvents
    End If
    If Not ilRet Then
        ilRet = btrAbortTrans(hmCHF)
        mBookSpot = False
        Exit Function
    End If
    ilRet = btrEndTrans(hmCHF)
    If igDoEvent Then
        DoEvents
    End If
    '7/20/12: Log spot booked between todays date and Last log date into the spot tracking file (stf)
    ilRet = gMakeTracer(hmSdf, tmSdf, 0, hmStf, lmLastLogDate, "A", "C", tmSdf.iRotNo, hmGsf)
    gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), lgSsfDate(imDayIndex)
    ilAHour(imHourIndex) = ilAHour(imHourIndex) + 1
    'ilADay(imDayIndex + 1) = ilADay(imDayIndex + 1) + 1
    ilADay(imDayIndex) = ilADay(imDayIndex) + 1
    ilAQH(imQHIndex) = ilAQH(imQHIndex) + 1
    mBookSpot = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mCheckSchDay                    *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Check day Sdf scheduled on to   *
'*                                                     *
'*******************************************************
'Private Function mCheckSchDay(tlSdf As SDF, tlClf As CLF) As Integer
Private Function mCheckSchDay(tlSdf As SDF, tlTempCff As CFF) As Integer
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilRet                                                                                 *
'******************************************************************************************

'
'   ilRet = mCheckSchDay()
'   Where:
'       ilRet(O)- True if spot on valid day; False if spot on invalid day
'       tlSdf(I)-Spot to be checked
'
    Dim llSchDate As Long
    Dim tlSmf As SMF
    'Dim tlCffSrchKey As CFFKEY0
    'Dim tlTempCff As CFF
    Dim llSDate As Long
    Dim llEDate As Long
    Dim ilDay As Integer
    If tlSdf.lChfCode <= 0 Then
        mCheckSchDay = True
        Exit Function
    End If
    If (tlSdf.sSchStatus = "O") Or (tlSdf.sSchStatus = "G") Then
        If Not gFindSmf(tlSdf, hmSmf, tlSmf) Then
            mCheckSchDay = False
            Exit Function
        End If
        gUnpackDateLong tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), llSchDate
    Else
        gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSchDate
    End If
    ilDay = gWeekDayLong(llSchDate)
    ''Obtain flight and check day
    'tlCffSrchKey.lChfCode = tlSdf.lChfCode
    'tlCffSrchKey.iClfLine = tlClf.iLine
    'tlCffSrchKey.iCntRevNo = tlClf.iCntRevNo
    'tlCffSrchKey.iPropVer = tlClf.iPropVer
    'tlCffSrchKey.iStartDate(0) = 0
    'tlCffSrchKey.iStartDate(1) = 0
    'ilRet = btrGetGreaterOrEqual(hmCff, tlTempCff, imCffRecLen, tlCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    'Do While (ilRet = BTRV_ERR_NONE) And (tlTempCff.lChfCode = tlSdf.lChfCode) And (tlTempCff.iClfLine = tlClf.iLine) And (tlTempCff.iCntRevNo = tlClf.iCntRevNo) And (tlTempCff.iPropVer = tlClf.iPropVer)
        If igDoEvent Then
            DoEvents
        End If
        gUnpackDateLong tlTempCff.iStartDate(0), tlTempCff.iStartDate(1), llSDate
        gUnpackDateLong tlTempCff.iEndDate(0), tlTempCff.iEndDate(1), llEDate
        If (llSchDate >= llSDate) And (llSchDate <= llEDate) Then
            If (tlTempCff.sDyWk <> "D") Then  'Weekly
                If (tlTempCff.iDay(ilDay) = 1) Or (tlTempCff.sXDay(ilDay) = "Y") Then
                    mCheckSchDay = True
                Else
                    mCheckSchDay = False
                End If
            Else
                If (tlTempCff.iDay(ilDay) > 0) Then
                    mCheckSchDay = True
                Else
                    mCheckSchDay = False
                End If
            End If
            Exit Function
        'Add 1/4/08 as can't check day if wrong flight is being checked
        Else
            mCheckSchDay = True
            Exit Function
        End If
    '    ilRet = btrGetNext(hmCff, tlTempCff, imCffRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    'Loop
    mCheckSchDay = False
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mChgUpdSchSdfSsf                *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Test and update Sdf and Ssf     *
'*                     for fields changed within the   *
'*                     contract header and line        *
'*                                                     *
'*******************************************************
Private Function mChgUpdSchSdfSsf(ilUpdateAdvtLenOnly As Integer, ilVefCode As Integer, ilGameNo As Integer, ilChkSplitNetwork As Integer)
'
'   ilSpotStatus = mChgUpdSchSdfSsf(ilUpdateAdvtLenOnly, ilVefCode, ilGameNo)
'   Where:
'       ilUpdateAdvtLenOnly(I)- True =Update only for Advt and length changes; False=Check all fields
'                           Note: True is used when fixing fields in Ssf and Sdf
'       ilSpotStatus(O)- 0=Leave; 1=Update; 2=Preempt (set to missed-tmSpot does not require updating as it is removed)
'                        -1=Extra deleted; -2=Error
'
'       tmSdf- Spot record
'       imDayIndex- Day index of spot
'
    Dim ilLoop As Integer
    Dim ilRet As Integer
    Dim ilRet1 As Integer
    Dim ilSpotStatus As Integer
    Dim ilMoveLoop As Integer
    Dim ilSpotIndex As Integer
    Dim slDate As String
    Dim llDate As Long
    Dim slTime As String
    Dim llStartTime As Long
    Dim llEndTime As Long
    Dim llSpotTime As Long
    Dim ilHourIndex As Integer
    Dim llSepLength As Long         'Advertiser separation length
    Dim ilLenSold As Integer        'Avail spot length sold
    Dim ilSrchIndex As Integer
    Dim ilTimeIndex As Integer
    Dim ilTimeOk As Integer
    Dim ilHour As Integer
    Dim ilMin As Integer
    Dim ilAvailHour As Integer
    Dim ilTime0 As Integer
    Dim ilTime1 As Integer
    Dim ilAdvtChg As Integer
    Dim ilLenChg As Integer
    Dim ilVpfIndex As Integer
    Dim slXSpotType As String
    Dim slOrigSchStatus As String
    Dim ilSpotFound As Integer
    Dim tlSdfExtra As SDF
    Dim tlSpot As CSPOTSS
    Dim ilTest As Integer
    Dim ilBack As Integer
    Dim ilStationCount As Integer
    '2/21/11: Replace GetDirect with GetEqual
    Dim llSDFCode As Long

    llSDFCode = tmSdf.lCode
    ilVpfIndex = gVpfFindIndex(ilVefCode)
    'ilHourIndex = tmSdf.iTime(1) \ 256 + 1  'Obtain hour (0 to 23)
    ilHourIndex = tmSdf.iTime(1) \ 256  'Obtain hour (0 to 23)
    gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
    llDate = gDateValue(slDate)
    ilSpotStatus = 0
    ilAdvtChg = False
    ilLenChg = False
    ilSpotFound = False
    Do  'Loop until Ssf updated
        If igDoEvent Then
            DoEvents
        End If
        ilSpotStatus = 0
        'Find matching spot and remove
        ilLoop = 1
        Do While ilLoop <= tgSsf(imDayIndex).iCount
            If igDoEvent Then
                DoEvents
            End If
           LSet tmAvail = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilLoop)
            If (tmAvail.iRecType = 2) Or ((tgSpf.sSchdPromo = "Y") And (tmAvail.iRecType = 9)) Or ((tgSpf.sSchdPSA = "Y") And (tmAvail.iRecType = 8)) Then  'Contract Avail subrecord
                If (tmAvail.iTime(0) = tmSdf.iTime(0)) And (tmAvail.iTime(1) = tmSdf.iTime(1)) Or ilUpdateAdvtLenOnly Then
                    'Matching avail found- look for spot
                    For ilSpotIndex = ilLoop + 1 To ilLoop + tmAvail.iNoSpotsThis Step 1
                        If igDoEvent Then
                            DoEvents
                        End If
                       LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilSpotIndex)
                        If tmSdf.lCode = tmSpot.lSdfCode Then
                            ilSpotFound = True
                            'If (tmSdf.sSpotType <> "A") And ((tmCChf.sType = "C") Or (tmCChf.sType = "V")) Then
                            If (tmSdf.sSpotType <> "A") And ((tmCChf.sType = "C") Or (tmCChf.sType = "V") Or ((tmCChf.sType = "M") And (tgSpf.sSchdPromo = "Y")) Or ((tmCChf.sType = "S") And (tgSpf.sSchdPSA = "Y")) Or ((tmCChf.sType = "T") And (tgSpf.sSchdRemnant = "Y"))) Then
                                If tmSdf.sSpotType <> "X" Then
                                    ilSpotStatus = 1
                                    tmSdf.sSpotType = "A"
                                End If
                            End If
                            'Test for Advertiser changed
                            gUnpackTime tmSdf.iTime(0), tmSdf.iTime(1), "A", "1", slTime
                            llSpotTime = CLng(gTimeToCurrency(slTime, False))
                            'Move here so that imPriceLevel is set
                            gGetLineSchParameters hmSsf, tgSsf(), lgSsfDate(), lgSsfRecPos(), llDate, ilVefCode, tmCChf.iAdfCode, ilGameNo, tmCCff(), tmCClf, tmCRdf, lmCSepLength, lmCStartDateSLen, lmCEndDateSLen, lmCChfCode, imCLineNo, imCAdfCodeSLen, imCVehComp, imCHour(), imCDay(), imCQH(), imCAHour(), imCADay(), imCAQH(), lmCTBStartTime(), lmCTBEndTime(), lmEarliestAllowedDate, imSkip(), tmCChf.sType, tmCChf.iPctTrade, imBkQH, False, imPriceLevel
                            If igDoEvent Then
                                DoEvents
                            End If
                            If tmCChf.iAdfCode <> tmSdf.iAdfCode Then
                                ilAdvtChg = True
                                If (Not ilUpdateAdvtLenOnly) And (tmSdf.sSpotType <> "X") Then
                                    'tgSpotMove(1).iSpotIndex = ilSpotIndex
                                    'tgSpotMove(1).lSpotSsfRecPos = lgSsfRecPos(imDayIndex)
                                    'tgSpotMove(1).lSdfCode = tmSdf.lCode
                                    tgSpotMove(0).iSpotIndex = ilSpotIndex
                                    tgSpotMove(0).lSpotSsfRecPos = lgSsfRecPos(imDayIndex)
                                    tgSpotMove(0).lSdfCode = tmSdf.lCode
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    'Move above so that price level is set
                                    'gGetLineSchParameters hmSsf, tgSsf(), lgSsfDate(), lgSsfRecPos(), llDate, ilVefCode, tmCChf.iAdfCode, tmCCff(), tmCClf, tmCRdf, lmCSepLength, lmCStartDateSLen, lmCEndDateSLen, lmCChfCode, imCLineNo, imCAdfCodeSLen, imCVehComp, imCHour(), imCDay(), imCQH(), imCAHour(), imCADay(), imCAQH(), lmCTBStartTime(), lmCTBEndTime(), lmEarliestAllowedDate, imSkip(), tmCChf.sType, tmCChf.iPctTrade, imBkQH, False, imPriceLevel
                                    'If igDoEvent Then
                                    '    DoEvents
                                    'End If
                                    'mGetLineSchParameters might have changed which Ssf is in memory
                                    ilTime0 = 0
                                    'ilTime1 = (ilHourIndex - 1) * 256
                                    ilTime1 = (ilHourIndex) * 256
                                    gUnpackTime ilTime0, ilTime1, "A", "1", slTime
                                    ilRet = gObtainSsfForDateOrGame(ilVefCode, llDate, slTime, ilGameNo, hmSsf, tgSsf(imDayIndex), lgSsfDate(imDayIndex), lgSsfRecPos(imDayIndex))
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If ((tmAvail.iAvInfo And SSLOCK) = SSLOCK) Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                        'Ignore advertiser conflict test 2/3/03
                                        If ilSpotStatus < 2 Then
                                            ilSpotStatus = 1
                                        End If
                                    Else
                                        If imRafPass = 0 Then
                                            If gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), ilVpfIndex, llSepLength, ilLoop, tmCChf.iAdfCode, tmCChf.iMnfComp(0), tmCChf.iMnfComp(1), 0, 0, "I", "N", imPriceLevel, False) Then
                                                If ilSpotStatus < 2 Then
                                                    ilSpotStatus = 1
                                                End If
                                            Else
                                                ilSpotStatus = 2
                                            End If
                                        Else
                                            If gAdvtTest(hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), ilVpfIndex, llSepLength, ilLoop, tmCChf.iAdfCode, tmCChf.iMnfComp(0), tmCChf.iMnfComp(1), 0, 0, "I", "N", imPriceLevel, True) Then
                                                If ilSpotStatus < 2 Then
                                                    ilSpotStatus = 1
                                                End If
                                            Else
                                                ilSpotStatus = 2
                                            End If
                                        End If
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                    End If
                                Else
                                    ilSpotStatus = 1
                                End If
                                tmSdf.iAdfCode = tmCChf.iAdfCode
                                tmSpot.iAdfCode = tmCChf.iAdfCode
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            'Test for competitive change
                            If (ilSpotStatus <> 2) And (Not ilUpdateAdvtLenOnly) Then
                                If (tmCChf.iMnfComp(0) <> tmSpot.iMnfComp(0)) Or (tmCChf.iMnfComp(1) <> tmSpot.iMnfComp(1)) Then
                                    'If competitives remove- test is not required
                                    If (tmSdf.sSpotType <> "X") Then
                                        'If competitives remove- test is not required
                                        'tgSpotMove(1).iSpotIndex = ilSpotIndex
                                        'tgSpotMove(1).lSpotSsfRecPos = lgSsfRecPos(imDayIndex)
                                        'tgSpotMove(1).lSdfCode = tmSdf.lCode
                                        tgSpotMove(0).iSpotIndex = ilSpotIndex
                                        tgSpotMove(0).lSpotSsfRecPos = lgSsfRecPos(imDayIndex)
                                        tgSpotMove(0).lSdfCode = tmSdf.lCode
                                        If (tmCChf.iMnfComp(0) <> tmSpot.iMnfComp(0)) And (tmCChf.iMnfComp(0) <> 0) Then
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If ((tmAvail.iAvInfo And SSLOCK) = SSLOCK) Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                                'Ignore exclusion conflict test 2/3/03
                                                If ilSpotStatus < 2 Then
                                                    ilSpotStatus = 1
                                                End If
                                            Else
                                                If imRafPass = 0 Then
                                                    If gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), ilVpfIndex, tmCClf.iLen, tmCChf.iMnfComp(0), tmCChf.iMnfComp(1), ilLoop, tmVcf0(), tmVcf6(), tmVcf7(), 0, 0, "I", "N", imPriceLevel, False) Then
                                                        If ilSpotStatus < 2 Then
                                                            ilSpotStatus = 1
                                                        End If
                                                    Else
                                                        ilSpotStatus = 2
                                                    End If
                                                Else
                                                    If gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), ilVpfIndex, tmCClf.iLen, tmCChf.iMnfComp(0), tmCChf.iMnfComp(1), ilLoop, tmVcf0(), tmVcf6(), tmVcf7(), 0, 0, "I", "N", imPriceLevel, True) Then
                                                        If ilSpotStatus < 2 Then
                                                            ilSpotStatus = 1
                                                        End If
                                                    Else
                                                        ilSpotStatus = 2
                                                    End If
                                                End If
                                            End If
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                        ElseIf (tmCChf.iMnfComp(1) <> tmSpot.iMnfComp(1)) And (tmCChf.iMnfComp(1) <> 0) Then
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If ((tmAvail.iAvInfo And SSLOCK) = SSLOCK) Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                                'Ignore exclusion conflict test 2/3/03
                                            Else
                                                If imRafPass = 0 Then
                                                    If gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), ilVpfIndex, tmCClf.iLen, tmCChf.iMnfComp(0), tmCChf.iMnfComp(1), ilLoop, tmVcf0(), tmVcf6(), tmVcf7(), 0, 0, "I", "N", imPriceLevel, False) Then
                                                        If ilSpotStatus < 2 Then
                                                            ilSpotStatus = 1
                                                        End If
                                                    Else
                                                        ilSpotStatus = 2
                                                    End If
                                                Else
                                                    If gCompetitiveTest(lmCompTime, hmSsf, tgSsf(imDayIndex), lgSsfRecPos(imDayIndex), tgSpotMove(), ilVpfIndex, tmCClf.iLen, tmCChf.iMnfComp(0), tmCChf.iMnfComp(1), ilLoop, tmVcf0(), tmVcf6(), tmVcf7(), 0, 0, "I", "N", imPriceLevel, True) Then
                                                        If ilSpotStatus < 2 Then
                                                            ilSpotStatus = 1
                                                        End If
                                                    Else
                                                        ilSpotStatus = 2
                                                    End If
                                                End If
                                            End If
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                        Else
                                            If ilSpotStatus < 2 Then
                                                ilSpotStatus = 1
                                            End If
                                        End If
                                    Else
                                        If ilSpotStatus < 2 Then
                                            ilSpotStatus = 1
                                        End If
                                    End If
                                    tmSpot.iMnfComp(0) = tmCChf.iMnfComp(0)
                                    tmSpot.iMnfComp(1) = tmCChf.iMnfComp(1)
                                End If
                            End If
                            If ((tmAvail.iAvInfo And SSLOCK) = SSLOCK) Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                'Ignore exclusion conflict test 2/3/03
                            Else
                                'Test for exclusion chnage
                                If (ilSpotStatus <> 2) And (Not ilUpdateAdvtLenOnly) And (tmSdf.sSpotType <> "X") Then
                                    If (tmCChf.iMnfExcl(0) <> tmPChf.iMnfExcl(0)) Or (tmCChf.iMnfExcl(1) <> tmPChf.iMnfExcl(1)) Then
                                        If (tmCChf.iMnfExcl(0) <> tmPChf.iMnfExcl(0)) And (tmCChf.iMnfExcl(0) <> 0) Then
                                            'Search back to program and check exclusions
                                            For ilSrchIndex = ilLoop - 1 To 1 Step -1
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                LSet tmProgTest = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilSrchIndex)
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If tmProgTest.iRecType = 1 Then
                                                    If (tmProgTest.iMnfExcl(0) <> 0) And (tmCChf.iMnfExcl(0) <> 0) Then
                                                        If (tmProgTest.iMnfExcl(0) = tmCChf.iMnfExcl(0)) Then
                                                            ilSpotStatus = 2
                                                            Exit For
                                                        End If
                                                    End If
                                                    If (tmProgTest.iMnfExcl(0) <> 0) And (tmCChf.iMnfExcl(1) <> 0) Then
                                                        If (tmProgTest.iMnfExcl(0) = tmCChf.iMnfExcl(1)) Then
                                                            ilSpotStatus = 2
                                                            Exit For
                                                        End If
                                                    End If
                                                    If (tmProgTest.iMnfExcl(1) <> 0) And (tmCChf.iMnfExcl(0) <> 0) Then
                                                        If (tmProgTest.iMnfExcl(1) = tmCChf.iMnfExcl(0)) Then
                                                            ilSpotStatus = 2
                                                            Exit For
                                                        End If
                                                    End If
                                                    If (tmProgTest.iMnfExcl(1) <> 0) And (tmCChf.iMnfExcl(1) <> 0) Then
                                                        If (tmProgTest.iMnfExcl(1) = tmCChf.iMnfExcl(1)) Then
                                                            ilSpotStatus = 2
                                                            Exit For
                                                        End If
                                                    End If
                                                    Exit For
                                                End If
                                            Next ilSrchIndex
                                        ElseIf (tmCChf.iMnfExcl(1) <> tmPChf.iMnfExcl(1)) And (tmCChf.iMnfExcl(1) <> 0) Then
                                            'Search back to program and check exclusions
                                            For ilSrchIndex = ilLoop - 1 To 1 Step -1
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                LSet tmProgTest = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilSrchIndex)
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If tmProgTest.iRecType = 1 Then
                                                    If (tmProgTest.iMnfExcl(0) <> 0) And (tmCChf.iMnfExcl(0) <> 0) Then
                                                        If (tmProgTest.iMnfExcl(0) = tmCChf.iMnfExcl(0)) Then
                                                            ilSpotStatus = 2
                                                            Exit For
                                                        End If
                                                    End If
                                                    If (tmProgTest.iMnfExcl(0) <> 0) And (tmCChf.iMnfExcl(1) <> 0) Then
                                                        If (tmProgTest.iMnfExcl(0) = tmCChf.iMnfExcl(1)) Then
                                                            ilSpotStatus = 2
                                                            Exit For
                                                        End If
                                                    End If
                                                    If (tmProgTest.iMnfExcl(1) <> 0) And (tmCChf.iMnfExcl(0) <> 0) Then
                                                        If (tmProgTest.iMnfExcl(1) = tmCChf.iMnfExcl(0)) Then
                                                            ilSpotStatus = 2
                                                            Exit For
                                                        End If
                                                    End If
                                                    If (tmProgTest.iMnfExcl(1) <> 0) And (tmCChf.iMnfExcl(1) <> 0) Then
                                                        If (tmProgTest.iMnfExcl(1) = tmCChf.iMnfExcl(1)) Then
                                                            ilSpotStatus = 2
                                                            Exit For
                                                        End If
                                                    End If
                                                    Exit For
                                                End If
                                            Next ilSrchIndex
                                        End If
                                    End If
                                End If
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            'Test for spot length change
                            If tmCClf.iLen <> tmPclf.iLen Then
                                If ((tmSpot.iRecType And SSSPLITPRI) = SSSPLITPRI) Then
                                    If ilLoop < tgSsf(imDayIndex).iCount Then
                                       LSet tlSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilLoop + 1)
                                        If (tlSpot.iRecType And &H1F) >= 10 Then
                                            If ((tmSpot.iRecType And SSSPLITSEC) = SSSPLITSEC) Then
                                                ilSpotStatus = 2
                                            End If
                                        End If
                                    End If
                                ElseIf ((tmSpot.iRecType And SSSPLITSEC) = SSSPLITSEC) Then
                                    ilSpotStatus = 2
                                End If
                            End If
                            If tmCClf.iLen < tmPclf.iLen Then
                                ilLenChg = True
                                If tgVpf(ilVpfIndex).sSSellOut = "M" Then   'Matching Units
                                    ilSpotStatus = 2
                                Else
                                    If ilSpotStatus < 2 Then
                                        ilSpotStatus = 1
                                    End If
                                End If
                                tmSdf.iLen = tmCClf.iLen
                                tmSpot.iPosLen = (tmSpot.iPosLen And &H7000) Or tmCClf.iLen
                            ElseIf tmCClf.iLen > tmPclf.iLen Then
                                ilLenChg = True
                                'Determine if room exist
                                If tgVpf(ilVpfIndex).sSSellOut = "T" Then
                                ElseIf (tgVpf(ilVpfIndex).sSSellOut = "B") Or (tgVpf(ilVpfIndex).sSSellOut = "U") Then
                                    ilLenSold = 0
                                    For ilSrchIndex = ilLoop + 1 To ilLoop + tmAvail.iNoSpotsThis Step 1
                                        LSet tmSpotTest = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilSrchIndex)
                                        If (tmSpot.iRecType And SSSPLITSEC) <> SSSPLITSEC Then
                                            ilLenSold = ilLenSold + (tmSpotTest.iPosLen And &HFFF)
                                        End If
                                    Next ilSrchIndex
                                    ilLenSold = ilLenSold - tmPclf.iLen
                                    If tmCClf.iLen > tmAvail.iLen - ilLenSold Then
                                        ilSpotStatus = 2
                                    Else
                                        If ilSpotStatus < 2 Then
                                            ilSpotStatus = 1
                                        End If
                                    End If
                                ElseIf tgVpf(ilVpfIndex).sSSellOut = "M" Then   'Matching Units
                                    ilSpotStatus = 2
                                Else
                                    If ilSpotStatus < 2 Then
                                        ilSpotStatus = 1
                                    End If
                                End If
                                tmSdf.iLen = tmCClf.iLen
                                tmSpot.iPosLen = (tmSpot.iPosLen And &H7000) Or tmCClf.iLen
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            'Test for Rdf change
                            If (ilSpotStatus <> 2) And (Not ilUpdateAdvtLenOnly) And (tmSdf.sSpotType <> "X") Then
                                If tmCClf.iRdfCode <> tmPclf.iRdfCode Then
                                    'Library buys change
                                    If (tmCRdf.iLtfCode(0) <> 0) Or (tmCRdf.iLtfCode(1) <> 0) Or (tmCRdf.iLtfCode(2) <> 0) Then
                                        If (tmCRdf.iLtfCode(0) <> tmAvail.iLtfCode) And (tmCRdf.iLtfCode(1) <> tmAvail.iLtfCode) And (tmCRdf.iLtfCode(2) <> tmAvail.iLtfCode) Then
                                            tmSpot.iRecType = tmSpot.iRecType Or SSLIBBUY
                                            If ((tmAvail.iAvInfo And SSLOCK) = SSLOCK) Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                                'Ignore rdf change test 2/3/03
                                                If ilSpotStatus < 2 Then
                                                    ilSpotStatus = 1
                                                End If
                                            Else
                                                ilSpotStatus = 2
                                            End If
                                        End If
                                    Else    'Time buy
                                        ilTimeOk = False
                                        If ((tmCClf.iStartTime(0) = 1) And (tmCClf.iStartTime(1) = 0)) Or (tgVpf(ilVpfIndex).sGMedium = "S") Then
                                            For ilTimeIndex = UBound(tmCRdf.iStartTime, 2) To LBound(tmCRdf.iStartTime, 2) Step -1
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If (tmCRdf.iStartTime(0, ilTimeIndex) <> 1) Or (tmCRdf.iStartTime(1, ilTimeIndex) <> 0) Then
                                                    gUnpackTime tmCRdf.iStartTime(0, ilTimeIndex), tmCRdf.iStartTime(1, ilTimeIndex), "A", "1", slTime
                                                    llStartTime = CLng(gTimeToCurrency(slTime, False))
                                                    gUnpackTime tmCRdf.iEndTime(0, ilTimeIndex), tmCRdf.iEndTime(1, ilTimeIndex), "A", "1", slTime
                                                    llEndTime = CLng(gTimeToCurrency(slTime, True))
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    If (llSpotTime >= llStartTime) And (llSpotTime < llEndTime) Then
                                                        ilTimeOk = True
                                                        'Adjust time allowed within book hour
                                                        ilAvailHour = tmAvail.iTime(1) \ 256
                                                        ilHour = tmCRdf.iStartTime(1, ilTimeIndex) \ 256
                                                        ilMin = tmCRdf.iStartTime(1, ilTimeIndex) And &HFF
                                                        If ilHour = ilAvailHour Then
                                                            tmSpot.lBkInfo = (tmSpot.lBkInfo And (Not &H7E0000)) Or (CLng(ilMin) * SHIFT17)
                                                        End If
                                                        ilHour = tmCRdf.iEndTime(1, ilTimeIndex) \ 256
                                                        ilMin = tmCRdf.iEndTime(1, ilTimeIndex) And &HFF
                                                        If (ilHour = 0) And (ilMin = 0) Then
                                                            ilHour = 23
                                                            ilMin = 59
                                                        End If
                                                        If ilHour = ilAvailHour Then
                                                            tmSpot.lBkInfo = (tmSpot.lBkInfo And (Not &H1F800000)) Or (CLng(ilMin) * SHIFT23)
                                                        Else
                                                            tmSpot.lBkInfo = (tmSpot.lBkInfo And (Not &H1F800000)) Or (60& * SHIFT23)
                                                        End If
                                                        Exit For
                                                    End If
                                                End If
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                            Next ilTimeIndex
                                        Else
                                            gUnpackTime tmCClf.iStartTime(0), tmCClf.iStartTime(1), "A", "1", slTime
                                            llStartTime = CLng(gTimeToCurrency(slTime, False))
                                            gUnpackTime tmCClf.iEndTime(0), tmCClf.iEndTime(1), "A", "1", slTime
                                            llEndTime = CLng(gTimeToCurrency(slTime, True))
                                            If llStartTime = llEndTime Then
                                                llEndTime = llStartTime + 1
                                            End If
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If (llSpotTime >= llStartTime) And (llSpotTime < llEndTime) Then
                                                ilTimeOk = True
                                                'Adjust time allowed with book hour
                                                ilAvailHour = tmAvail.iTime(1) \ 256
                                                ilHour = tmCClf.iStartTime(1) \ 256
                                                ilMin = tmCClf.iStartTime(1) And &HFF
                                                If ilHour = ilAvailHour Then
                                                    tmSpot.lBkInfo = (tmSpot.lBkInfo And (Not &H7E0000)) Or (CLng(ilMin) * SHIFT17)
                                                End If
                                                ilHour = tmCClf.iEndTime(1) \ 256
                                                ilMin = tmCClf.iEndTime(1) And &HFF
                                                If (ilHour = 0) And (ilMin = 0) Then
                                                    ilHour = 23
                                                    ilMin = 59
                                                End If
                                                If ilHour = ilAvailHour Then
                                                    tmSpot.lBkInfo = (tmSpot.lBkInfo And (Not &H1F800000)) Or (CLng(ilMin) * SHIFT23)
                                                Else
                                                    tmSpot.lBkInfo = (tmSpot.lBkInfo And (Not &H1F800000)) Or (60& * SHIFT23)
                                                End If
                                            End If
                                        End If
                                        If ((tmAvail.iAvInfo And SSLOCK) = SSLOCK) Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                            'Ignore rdf change test 2/3/03
                                            If Not ilTimeOk Then
                                                If ilSpotStatus < 2 Then
                                                    ilSpotStatus = 1
                                                End If
                                            End If
                                        Else
                                            If Not ilTimeOk Then
                                                ilSpotStatus = 2
                                            End If
                                        End If
                                        tmSpot.iRecType = tmSpot.iRecType And (Not SSLIBBUY)
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                    End If
                                    If ((tmAvail.iAvInfo And SSLOCK) = SSLOCK) Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                        'Ignore rdf change test 2/3/03
                                    Else
                                        'Avail include/exclude change
                                        If (tmCRdf.sInOut = "I") And (tmPRdf.sInOut = "I") Then
                                            If (tmCRdf.ianfCode <> tmPRdf.ianfCode) Then
                                                ilSpotStatus = 2
                                            End If
                                        End If
                                        If (tmCRdf.sInOut = "O") And (tmPRdf.sInOut = "O") Then
                                            If (tmCRdf.ianfCode <> tmPRdf.ianfCode) Then
                                                If tmAvail.ianfCode = tmCRdf.ianfCode Then
                                                    ilSpotStatus = 2
                                                End If
                                            End If
                                        End If
                                    End If
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If tmCRdf.sInOut <> tmPRdf.sInOut Then
                                        If tmCRdf.sInOut = "I" Then
                                            tmSpot.iRecType = tmSpot.iRecType And (Not SSEXAVAILBUY)
                                            tmSpot.iRecType = tmSpot.iRecType Or SSAVAILBUY
                                            If tmAvail.ianfCode <> tmCRdf.ianfCode Then
                                                If ((tmAvail.iAvInfo And SSLOCK) = SSLOCK) Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                                    'Ignore rdf change test 2/3/03
                                                    If ilSpotStatus < 2 Then
                                                        ilSpotStatus = 1
                                                    End If
                                                Else
                                                    ilSpotStatus = 2
                                                End If
                                            End If
                                        ElseIf tmCRdf.sInOut = "O" Then
                                            tmSpot.iRecType = tmSpot.iRecType And (Not SSAVAILBUY)
                                            tmSpot.iRecType = tmSpot.iRecType Or SSEXAVAILBUY
                                            If tmAvail.ianfCode = tmCRdf.ianfCode Then
                                                If ((tmAvail.iAvInfo And SSLOCK) = SSLOCK) Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                                    'Ignore rdf change test 2/3/03
                                                    If ilSpotStatus < 2 Then
                                                        ilSpotStatus = 1
                                                    End If
                                                Else
                                                    ilSpotStatus = 2
                                                End If
                                            End If
                                        Else
                                            tmSpot.iRecType = tmSpot.iRecType And (Not SSAVAILBUY)
                                            tmSpot.iRecType = tmSpot.iRecType And (Not SSEXAVAILBUY)
                                            If ilSpotStatus < 2 Then
                                                ilSpotStatus = 1
                                            End If
                                        End If
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                    End If
                                End If
                            End If
                            'Test for Override time change
                            If (ilSpotStatus <> 2) And (Not ilUpdateAdvtLenOnly) And (tmSdf.sSpotType <> "X") Then
                                If (tmCRdf.iLtfCode(0) = 0) And (tmCRdf.iLtfCode(1) = 0) And (tmCRdf.iLtfCode(2) = 0) Then
                                    'Check of time of spot is Ok incase user removed time overrides or added or changed overrides
                                    ilTimeOk = False
                                    If ((tmCClf.iStartTime(0) = 1) And (tmCClf.iStartTime(1) = 0)) Or (tgVpf(ilVpfIndex).sGMedium = "S") Then
                                        For ilTimeIndex = UBound(tmCRdf.iStartTime, 2) To LBound(tmCRdf.iStartTime, 2) Step -1
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If (tmCRdf.iStartTime(0, ilTimeIndex) <> 1) Or (tmCRdf.iStartTime(1, ilTimeIndex) <> 0) Then
                                                gUnpackTime tmCRdf.iStartTime(0, ilTimeIndex), tmCRdf.iStartTime(1, ilTimeIndex), "A", "1", slTime
                                                llStartTime = CLng(gTimeToCurrency(slTime, False))
                                                gUnpackTime tmCRdf.iEndTime(0, ilTimeIndex), tmCRdf.iEndTime(1, ilTimeIndex), "A", "1", slTime
                                                llEndTime = CLng(gTimeToCurrency(slTime, True))
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If (llSpotTime >= llStartTime) And (llSpotTime < llEndTime) Then
                                                    ilTimeOk = True
                                                    'Adjust time allowed within book hour
                                                    ilAvailHour = tmAvail.iTime(1) \ 256
                                                    ilHour = tmCRdf.iStartTime(1, ilTimeIndex) \ 256
                                                    ilMin = tmCRdf.iStartTime(1, ilTimeIndex) And &HFF
                                                    If ilHour = ilAvailHour Then
                                                        tmSpot.lBkInfo = (tmSpot.lBkInfo And (Not &H7E0000)) Or (CLng(ilMin) * SHIFT17)
                                                    End If
                                                    ilHour = tmCRdf.iEndTime(1, ilTimeIndex) \ 256
                                                    ilMin = tmCRdf.iEndTime(1, ilTimeIndex) And &HFF
                                                    If (ilHour = 0) And (ilMin = 0) Then
                                                        ilHour = 23
                                                        ilMin = 59
                                                    End If
                                                    If ilHour = ilAvailHour Then
                                                        tmSpot.lBkInfo = (tmSpot.lBkInfo And (Not &H1F800000)) Or (CLng(ilMin) * SHIFT23)
                                                    Else
                                                        tmSpot.lBkInfo = (tmSpot.lBkInfo And (Not &H1F800000)) Or (60& * SHIFT23)
                                                    End If
                                                    Exit For
                                                End If
                                            End If
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                        Next ilTimeIndex
                                    Else
                                        'Test override time and if not matching, test spot
                                        If (tmCClf.iStartTime(0) <> tmPclf.iStartTime(0)) Or (tmCClf.iStartTime(1) <> tmPclf.iStartTime(1)) Or (tmCClf.iEndTime(0) <> tmPclf.iEndTime(0)) Or (tmCClf.iEndTime(1) <> tmPclf.iEndTime(1)) Then
                                            gUnpackTime tmCClf.iStartTime(0), tmCClf.iStartTime(1), "A", "1", slTime
                                            llStartTime = CLng(gTimeToCurrency(slTime, False))
                                            gUnpackTime tmCClf.iEndTime(0), tmCClf.iEndTime(1), "A", "1", slTime
                                            llEndTime = CLng(gTimeToCurrency(slTime, True))
                                            If llStartTime = llEndTime Then
                                                llEndTime = llStartTime + 1
                                            End If
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If (llSpotTime >= llStartTime) And (llSpotTime < llEndTime) Then
                                                ilTimeOk = True
                                                'Adjust the allow times within the hour
                                                ilAvailHour = tmAvail.iTime(1) \ 256
                                                ilHour = tmCClf.iStartTime(1) \ 256
                                                ilMin = tmCClf.iStartTime(1) And &HFF
                                                If ilHour = ilAvailHour Then
                                                    tmSpot.lBkInfo = (tmSpot.lBkInfo And (Not &H7E0000)) Or (CLng(ilMin) * SHIFT17)
                                                End If
                                                ilHour = tmCClf.iEndTime(1) \ 256
                                                ilMin = tmCClf.iEndTime(1) And &HFF
                                                If (ilHour = 0) And (ilMin = 0) Then
                                                    ilHour = 23
                                                    ilMin = 59
                                                End If
                                                If ilHour = ilAvailHour Then
                                                    tmSpot.lBkInfo = (tmSpot.lBkInfo And (Not &H1F800000)) Or (CLng(ilMin) * SHIFT23)
                                                Else
                                                    tmSpot.lBkInfo = (tmSpot.lBkInfo And (Not &H1F800000)) Or (60& * SHIFT23)
                                                End If
                                            End If
                                        Else
                                            ilTimeOk = True
                                        End If
                                    End If
                                    If ((tmAvail.iAvInfo And SSLOCK) = SSLOCK) Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                        'Ignore rdf change test 2/3/03
                                        If Not ilTimeOk Then
                                            If ilSpotStatus < 2 Then
                                                ilSpotStatus = 1
                                            End If
                                        End If
                                    Else
                                        If Not ilTimeOk Then
                                            ilSpotStatus = 2
                                        End If
                                    End If
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                End If
                            End If
                            'Test for Billboard change
                            If (ilSpotStatus <> 2) And (Not ilUpdateAdvtLenOnly) Then
                            End If
                            'Test for Unique (extra) change
                            If (ilSpotStatus <> 2) And (Not ilUpdateAdvtLenOnly) Then
                            End If
                            'Test for Break # change
                            If (ilSpotStatus <> 2) And (Not ilUpdateAdvtLenOnly) Then
                            End If
                            'Test for Position # change
                            If (ilSpotStatus <> 2) And (Not ilUpdateAdvtLenOnly) And (tmSdf.sSpotType <> "X") Then
                                If (tmCClf.iPosition = 1) And (tmPclf.iPosition <> 1) Then
                                    If tmSdf.sSchStatus = "S" Then
                                        If ilSpotIndex <> ilLoop + 1 Then
                                            ilSpotStatus = 2
                                        End If
                                    End If
                                End If
                            End If
                            'Test for solo avail change
                            If (ilSpotStatus <> 2) And (Not ilUpdateAdvtLenOnly) And (tmSdf.sSpotType <> "X") Then
                                If (tmCClf.sSoloAvail = "Y") And (tmPclf.sSoloAvail <> "Y") Then
                                    If tmSdf.sSchStatus = "S" Then
                                        If (tmAvail.iNoSpotsThis > 1) Or (tmCClf.iLen <> tmAvail.iLen) Then
                                            ilSpotStatus = 2
                                        End If
                                    End If
                                End If
                            End If
                            'Test for Preempt change
                            If (ilSpotStatus <> 2) And (Not ilUpdateAdvtLenOnly) And (tmSdf.sSpotType <> "X") Then
                                If tmCClf.sPreempt <> tmPclf.sPreempt Then
                                    If ilSpotStatus < 2 Then
                                        ilSpotStatus = 1
                                    End If
                                    If tmCClf.sPreempt = "P" Then
                                        tmSpot.iRecType = tmSpot.iRecType Or SSPREEMPTIBLE
                                    Else
                                        tmSpot.iRecType = tmSpot.iRecType And (Not SSPREEMPTIBLE)
                                    End If
                                End If
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            'Check if removing or adding regions- either way, reschedule spot
                            'If removing, then secondary will become primary.  If adding, it might combine with previous schedule partial split buy
                            If ilChkSplitNetwork Then
                                If ((tmCClf.lRafCode = 0) And (tmPclf.lRafCode > 0)) Or ((tmCClf.lRafCode > 0) And (tmPclf.lRafCode = 0)) Then
                                    ilSpotStatus = 2
                                End If
                            End If
                            'Test if partial changed
                            If (ilSpotStatus <> 2) And (ilChkSplitNetwork) Then
                                If ((tmSpot.iRecType And SSSPLITPRI) = SSSPLITPRI) Then
                                    For ilTest = ilSpotIndex + 1 To ilLoop + tmAvail.iNoSpotsThis Step 1
                                       LSet tlSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilTest)
                                        If ((tlSpot.iRecType And SSSPLITSEC) <> SSSPLITSEC) Then
                                            Exit For
                                        End If
                                        If gSplitNetworkStationConflicts(hmRaf, hmSef, hmSdf, hmClf, tlSpot.lSdfCode, tmStationsClf(), smClfInclExcl, ilStationCount) Then
                                            ilSpotStatus = 2
                                            Exit For
                                        End If
                                    Next ilTest
                                Else
                                    'Find Primary
                                    For ilBack = ilSpotIndex - 1 To ilLoop + 1 Step -1
                                       LSet tlSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilBack)
                                        If ((tlSpot.iRecType And SSSPLITPRI) = SSSPLITPRI) Then
                                            For ilTest = ilBack To ilLoop + tmAvail.iNoSpotsThis Step 1
                                                If ilTest <> ilSpotIndex Then
                                                   LSet tlSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilTest)
                                                    If ilTest <> ilBack Then
                                                        If ((tlSpot.iRecType And SSSPLITSEC) <> SSSPLITSEC) Then
                                                            Exit For
                                                        End If
                                                    End If
                                                    If gSplitNetworkStationConflicts(hmRaf, hmSef, hmSdf, hmClf, tlSpot.lSdfCode, tmStationsClf(), smClfInclExcl, ilStationCount) Then
                                                        ilSpotStatus = 2
                                                        Exit For
                                                    End If
                                                End If
                                            Next ilTest
                                            Exit For
                                        End If
                                    Next ilBack
                                End If
                            End If
                            'Test for Priority change
                            If (ilSpotStatus <> 2) And (Not ilUpdateAdvtLenOnly) And (tmSdf.sSpotType <> "X") Then
                                If (tmCClf.iPriority <> tmPclf.iPriority) And (tmSdf.sSchStatus = "S") Then
                                    If ilSpotStatus < 2 Then
                                        ilSpotStatus = 1
                                    End If
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    gGetLineSchParameters hmSsf, tgSsf(), lgSsfDate(), lgSsfRecPos(), llDate, ilVefCode, tmCChf.iAdfCode, ilGameNo, tmCCff(), tmCClf, tmCRdf, lmCSepLength, lmCStartDateSLen, lmCEndDateSLen, lmCChfCode, imCLineNo, imCAdfCodeSLen, imCVehComp, imCHour(), imCDay(), imCQH(), imCAHour(), imCADay(), imCAQH(), lmCTBStartTime(), lmCTBEndTime(), lmEarliestAllowedDate, imSkip(), tmCChf.sType, tmCChf.iPctTrade, imBkQH, False, imPriceLevel
                                    'mGetLineSchParameters might have changed which Ssf is in memory
                                    ilTime0 = 0
                                    'ilTime1 = (ilHourIndex - 1) * 256
                                    ilTime1 = (ilHourIndex) * 256
                                    gUnpackTime ilTime0, ilTime1, "A", "1", slTime
                                    ilRet = gObtainSsfForDateOrGame(ilVefCode, llDate, slTime, ilGameNo, hmSsf, tgSsf(imDayIndex), lgSsfDate(imDayIndex), lgSsfRecPos(imDayIndex))
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    tmSpot.iRank = (imPriceLevel * SHIFT11) + imBkQH '(tmSpot.iRank And PRICELEVELMASK) + imBkQH
                                End If
                            End If
                            If ilSpotStatus = 1 Then
                                'Update spot
                                LSet tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilSpotIndex) = tmSpot
                            ElseIf ilSpotStatus = 2 Then
                                'Move all event up, change count and update
                                'tmSdf.sSchStatus = "M"
                                tmAvail.iNoSpotsThis = tmAvail.iNoSpotsThis - 1
                                tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilLoop) = tmAvail
                                If igDoEvent Then
                                    DoEvents
                                End If
                                For ilMoveLoop = ilSpotIndex To tgSsf(imDayIndex).iCount - 1 Step 1
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If ilMoveLoop = ilSpotIndex Then
                                       LSet tlSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilMoveLoop)
                                        If (tlSpot.iRecType And SSSPLITPRI) = SSSPLITPRI Then
                                           LSet tlSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilMoveLoop + 1)
                                            If (tlSpot.iRecType And &H1F) >= 10 Then
                                                If (tlSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                                                    tlSpot.iRecType = tlSpot.iRecType And (Not SSSPLITSEC)
                                                    tlSpot.iRecType = tlSpot.iRecType Or SSSPLITPRI
                                                    LSet tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilMoveLoop + 1) = tlSpot
                                                End If
                                            End If
                                        End If
                                    End If
                                    tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilMoveLoop) = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilMoveLoop + 1)
                                Next ilMoveLoop
                                'BB, bookends, donuts,... not hamdled
                                tgSsf(imDayIndex).iCount = tgSsf(imDayIndex).iCount - 1
                            End If
                            Exit Do
                        End If
                        If igDoEvent Then
                            DoEvents
                        End If
                    Next ilSpotIndex
                    If (Not ilUpdateAdvtLenOnly) Or ilSpotFound Then
                        Exit Do
                    End If
                    ilLoop = ilLoop + 1
                Else
                    ilLoop = ilLoop + 1
                End If
            Else
                ilLoop = ilLoop + 1
            End If
            If igDoEvent Then
                DoEvents
            End If
        Loop
        If ilSpotStatus > 0 Then
            If igDoEvent Then
                DoEvents
            End If
            If csiHandleValue(0, 15) > 0 Then
                ilRet1 = btrBeginTrans(hmCHF, 1000)
            Else
                ilRet1 = btrBeginTrans(hmCHF, -1000)
            End If
            If ilRet1 <> BTRV_ERR_NONE Then
                mChgUpdSchSdfSsf = -2
                Exit Function
            End If
            If igDoEvent Then
                DoEvents
            End If
            'Reposition so update is OK- read SSf into non-work area
            imSsfRecLen = Len(tgSsf(imDayIndex))
            ilRet1 = gSSFGetDirect(hmSsf, tmSsf, imSsfRecLen, lgSsfRecPos(imDayIndex), INDEXKEY0, BTRV_LOCK_NONE)
            If igDoEvent Then
                DoEvents
            End If
            If ilRet1 <> BTRV_ERR_NONE Then
                ilRet1 = btrAbortTrans(hmCHF)
                mChgUpdSchSdfSsf = -2
                Exit Function
            End If
            ilRet1 = gGetByKeyForUpdateSSF(hmSsf, tmSsf)
            If ilRet1 <> BTRV_ERR_NONE Then
                ilRet1 = btrAbortTrans(hmCHF)
                mChgUpdSchSdfSsf = -2
                Exit Function
            End If
            If igDoEvent Then
                DoEvents
            End If
            imSsfRecLen = igSSFBaseLen + tgSsf(imDayIndex).iCount * Len(tmProg)
            ilRet = gSSFUpdate(hmSsf, tgSsf(imDayIndex), imSsfRecLen)
        Else
            ilRet = BTRV_ERR_NONE
        End If
        If ilRet = BTRV_ERR_CONFLICT Then
            If igDoEvent Then
                DoEvents
            End If
            ilRet1 = btrAbortTrans(hmCHF)
            imSsfRecLen = Len(tgSsf(imDayIndex))
            ilRet1 = gSSFGetDirect(hmSsf, tgSsf(imDayIndex), imSsfRecLen, lgSsfRecPos(imDayIndex), INDEXKEY0, BTRV_LOCK_NONE)
            If igDoEvent Then
                DoEvents
            End If
            If ilRet1 <> BTRV_ERR_NONE Then
                'ilRet1 = btrAbortTrans(hmChf)
                mChgUpdSchSdfSsf = -2
                Exit Function
            End If
            '2/21/11: Replace GetDirect with GetEqual
            'ilRet1 = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, lmSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
            tmSdfSrchKey3.lCode = llSDFCode
            ilRet1 = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If igDoEvent Then
                DoEvents
            End If
            If ilRet1 <> BTRV_ERR_NONE Then
                'ilRet1 = btrAbortTrans(hmChf)
                mChgUpdSchSdfSsf = -2
                Exit Function
            End If
        End If
        If igDoEvent Then
            DoEvents
        End If
    Loop While ilRet = BTRV_ERR_CONFLICT
    If igDoEvent Then
        DoEvents
    End If
    If ilRet <> BTRV_ERR_NONE Then
        ilRet1 = btrAbortTrans(hmCHF)
        mChgUpdSchSdfSsf = -2
        Exit Function
    End If
    If ilSpotStatus > 0 Then
        tlSdfExtra = tmSdf
        'Make tracer first from original sdf (tlSdfExtra is a working area for gMakeTracer)
        If ilSpotStatus = 2 Then
            'Set tracer if date between Now+1 And Last Log Date
            If igDoEvent Then
                DoEvents
            End If
            ilRet = gMakeTracer(hmSdf, tlSdfExtra, 0, hmStf, lmLastLogDate, "M", "C", tlSdfExtra.iRotNo, hmGsf)
            If igDoEvent Then
                DoEvents
            End If
            If Not ilRet Then
                ilRet1 = btrAbortTrans(hmCHF)
                mChgUpdSchSdfSsf = -2
                Exit Function
            End If
            If igDoEvent Then
                DoEvents
            End If
            slXSpotType = tmSdf.sSpotType
            slOrigSchStatus = tmSdf.sSchStatus
            ilRet = gRemoveSmf(hmSmf, tmSmf, tmSdf, hmSxf)  'resets missed date and vehicle
            If igDoEvent Then
                DoEvents
            End If
            If Not ilRet Then
                ilRet1 = btrAbortTrans(hmCHF)
                mChgUpdSchSdfSsf = -2
                Exit Function
            End If
            If slXSpotType = "X" Then
                If ((tmSmf.lMtfCode <> 0) And (lgMtfNoRecs <> 0)) And ((slOrigSchStatus = "G") Or (slOrigSchStatus = "O")) Then
                    slXSpotType = ""
                End If
            Else
                slXSpotType = ""
            End If
            If slXSpotType <> "X" Then
                tmSdf.sSchStatus = "M"
                'lgUnschRecPos(UBound(lgUnschRecPos)) = lmSdfRecPos
                'ReDim Preserve lgUnschRecPos(1 To UBound(lgUnschRecPos) + 1) As Long
                lgUnschSdfCode(UBound(lgUnschSdfCode)) = tmSdf.lCode
                'ReDim Preserve lgUnschSdfCode(1 To UBound(lgUnschSdfCode) + 1) As Long
                ReDim Preserve lgUnschSdfCode(LBound(lgUnschSdfCode) To UBound(lgUnschSdfCode) + 1) As Long
            Else
                Do
                    If igDoEvent Then
                        DoEvents
                    End If
                    '2/21/11: Replace GetDirect with GetEqual
                    'ilRet1 = btrGetDirect(hmSdf, tlSdfExtra, imSdfRecLen, lmSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSdfSrchKey3.lCode = llSDFCode
                    ilRet1 = btrGetEqual(hmSdf, tlSdfExtra, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet1 <> BTRV_ERR_NONE Then
                        ilRet1 = btrAbortTrans(hmCHF)
                        mChgUpdSchSdfSsf = -2
                        Exit Function
                    End If
                    'tmSRec = tlSdfExtra
                    'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
                    'If igDoEvent Then
                    '    DoEvents
                    'End If
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    ilRet1 = btrAbortTrans(hmChf)
                    '    mChgUpdSchSdfSsf = -2
                    '    Exit Function
                    'End If
                    'tlSdfExtra = tmSRec
                    ilRet = btrDelete(hmSdf)
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop While ilRet = BTRV_ERR_CONFLICT
                ilRet1 = btrEndTrans(hmCHF)
                mChgUpdSchSdfSsf = -1
                Exit Function
            End If
        ElseIf ilSpotStatus = 1 Then
            'If ilAdvtChg Or ilLenChg Then
            If ilLenChg Then
                If igDoEvent Then
                    DoEvents
                End If
                ilRet = gMakeTracer(hmSdf, tlSdfExtra, 0, hmStf, lmLastLogDate, "M", "C", tlSdfExtra.iRotNo, hmGsf)
                If igDoEvent Then
                    DoEvents
                End If
                If Not ilRet Then
                    ilRet1 = btrAbortTrans(hmCHF)
                    mChgUpdSchSdfSsf = -2
                    Exit Function
                End If
            End If
        End If
        Do
            If igDoEvent Then
                DoEvents
            End If
            '2/21/11: Replace GetDirect with GetEqual
            'ilRet1 = btrGetDirect(hmSdf, tlSdfExtra, imSdfRecLen, lmSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
            tmSdfSrchKey3.lCode = llSDFCode
            ilRet1 = btrGetEqual(hmSdf, tlSdfExtra, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If igDoEvent Then
                DoEvents
            End If
            If ilRet1 <> BTRV_ERR_NONE Then
                ilRet1 = btrAbortTrans(hmCHF)
                mChgUpdSchSdfSsf = -2
                Exit Function
            End If
            'tmSRec = tlSdfExtra
            'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
            'If igDoEvent Then
            '    DoEvents
            'End If
            'If ilRet <> BTRV_ERR_NONE Then
            '    ilRet1 = btrAbortTrans(hmChf)
            '    mChgUpdSchSdfSsf = -2
            '    Exit Function
            'End If
            'tlSdfExtra = tmSRec
            ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
            If igDoEvent Then
                DoEvents
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If ilSpotStatus = 1 Then
            'If ilAdvtChg Or ilLenChg Then
            If ilLenChg Then
                If igDoEvent Then
                    DoEvents
                End If
                ilRet = gMakeTracer(hmSdf, tmSdf, 0, hmStf, lmLastLogDate, "A", "C", tmSdf.iRotNo, hmGsf)
                If igDoEvent Then
                    DoEvents
                End If
                If Not ilRet Then
                    ilRet1 = btrAbortTrans(hmCHF)
                    mChgUpdSchSdfSsf = -2
                    Exit Function
                End If
            End If
            '2/21/11: Replace GetDirect with GetEqual, test for ilSpotStatus = 1 in mValidateSpots
            'Reset position for GetNext
            'ilRet1 = btrGetDirect(hmSdf, tlSdfExtra, imSdfRecLen, lmSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
            If igDoEvent Then
                DoEvents
            End If
        End If
        If igDoEvent Then
            DoEvents
        End If
        ilRet1 = btrEndTrans(hmCHF)
    End If
    If igDoEvent Then
        DoEvents
    End If
    mChgUpdSchSdfSsf = ilSpotStatus
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mCompBypassDates                *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Compute the dates that encompass*
'*                     the specified date.  These dates*
'*                     will be used to bypass other    *
'*                     spots on these days             *
'*                                                     *
'*******************************************************
Sub mCompBypassDates(llDate As Long, tlCff() As CFF, llBypassStartDate As Long, llBypassEndDate As Long)
    Dim ilUpperBound As Integer
    Dim ilLoop As Integer
    Dim ilIndex As Integer
    Dim slDate As String
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim ilDay As Integer
    Dim ilLastDay As Integer
    Dim ilFirstDay As Integer
    ilUpperBound = UBound(tlCff) - 1
    For ilLoop = LBound(tlCff) To ilUpperBound Step 1
        If igDoEvent Then
            DoEvents
        End If
        gUnpackDate tlCff(ilLoop).iStartDate(0), tlCff(ilLoop).iStartDate(1), slDate
        llStartDate = gDateValue(slDate)
        gUnpackDate tlCff(ilLoop).iEndDate(0), tlCff(ilLoop).iEndDate(1), slDate
        llEndDate = gDateValue(slDate)
        If (llDate >= llStartDate) And (llDate <= llEndDate) Then
            If (tlCff(ilLoop).sDyWk <> "D") Then  'Weekly
                ilDay = gWeekDayLong(llDate)
                ilLastDay = -1
                ilFirstDay = -1
                For ilIndex = 0 To 6 Step 1
                    If tlCff(ilLoop).iDay(ilIndex) > 0 Then
                        If ilFirstDay = -1 Then
                            ilFirstDay = ilIndex
                        End If
                        ilLastDay = ilIndex
                    End If
                Next ilIndex
                If (ilDay >= ilFirstDay) And (ilDay <= ilLastDay) Then
                    llBypassStartDate = llDate
                    Do Until gWeekDayLong(llBypassStartDate) = 0
                        llBypassStartDate = llBypassStartDate - 1
                    Loop
                    llBypassEndDate = llDate
                    Do Until gWeekDayLong(llBypassEndDate) = ilLastDay
                        llBypassEndDate = llBypassEndDate + 1
                    Loop
                Else
                    llBypassStartDate = llDate
                    Do Until gWeekDayLong(llBypassStartDate) = ilLastDay + 1
                        llBypassStartDate = llBypassStartDate - 1
                    Loop
                    llBypassEndDate = llDate
                    Do Until gWeekDayLong(llBypassEndDate) = 6
                        llBypassEndDate = llBypassEndDate + 1
                    Loop
                End If
            Else
                llBypassStartDate = llDate
                llBypassEndDate = llDate
            End If
            Exit Sub
        End If
    Next ilLoop
    llBypassStartDate = 0
    llBypassEndDate = 0
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mCountSpots                     *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Count spots                     *
'*                                                     *
'*******************************************************
Private Function mCountSpots(llChfCode As Long, ilLineNo As Integer, llFsfCode As Long, ilGameNo As Integer, llFromDate As Long, llToDate As Long, ilPCount As Integer) As Integer
'
'   ilCount = mCountSpots(llChfCode, ilLineNo, ilGameNo, llFromDate, llToDate)
'   Where:
'       llChfCode(I)- Contract code number
'       ilLineNo(I)- Contract line number
'       llFromDate(I)- Start date for the removal of spots
'       ilGameNo(I)- Game Number
'       llToDate(I)- end date for the removal of spots
'       ilPCount(I)- Previous number of spots for line, use this count only if M for N MG
'       ilCount(O)- Number of spots found
'   Note: Ignore extra bonus spots in count
'
    Dim ilRet As Integer
    Dim slDate As String
    Dim llDate As Long
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim tlSdf As SDF
    Dim ilCount As Integer
    Dim ilDate0 As Integer
    Dim ilDate1 As Integer
    llStartDate = llFromDate
    llEndDate = llToDate
    ilCount = 0
    For llDate = llStartDate To llEndDate Step 1
        If igDoEvent Then
            DoEvents
        End If
        tgSdfSrchKey.iVefCode = imCVefCode
        tgSdfSrchKey.lChfCode = llChfCode
        tgSdfSrchKey.iLineNo = ilLineNo
        tgSdfSrchKey.lFsfCode = llFsfCode
        slDate = Format$(llDate, "m/d/yy")
        gPackDate slDate, ilDate0, ilDate1
        tgSdfSrchKey.iDate(0) = ilDate0
        tgSdfSrchKey.iDate(1) = ilDate1
        tgSdfSrchKey.sSchStatus = " "
        tgSdfSrchKey.iTime(0) = 0
        tgSdfSrchKey.iTime(1) = 0
        ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        Do While (ilRet = BTRV_ERR_NONE) And (tlSdf.iVefCode = imCVefCode) And (tlSdf.lChfCode = llChfCode) And (tlSdf.iLineNo = ilLineNo) And (tlSdf.lFsfCode = llFsfCode)
            If igDoEvent Then
                DoEvents
            End If
            If (tlSdf.iDate(0) <> ilDate0) Or (tlSdf.iDate(1) <> ilDate1) Then
                Exit Do
            End If
            If (tlSdf.sSchStatus = "M") And (tlSdf.sTracer = "*") And (tlSdf.sSpotType <> "X") Then
                mCountSpots = ilPCount
                Exit Function
            End If
            If tlSdf.iGameNo = ilGameNo Then
                If (tlSdf.sSpotType <> "X") And (tlSdf.sSpotType <> "O") And (tlSdf.sSpotType <> "C") Then
                    If (tlSdf.sSchStatus <> "O") And (tlSdf.sSchStatus <> "G") Then    'Add these in later by testing missing date
                        ilCount = ilCount + 1
                    End If
                End If
            End If
            ilRet = btrGetNext(hmSdf, tlSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        Loop
    Next llDate
    If igDoEvent Then
        DoEvents
    End If
    'Check for spots moved to other vehicles
    tmSmfSrchKey.lChfCode = llChfCode
    tmSmfSrchKey.iLineNo = ilLineNo
    tmSmfSrchKey.lFsfCode = llFsfCode
    slDate = Format$("1/1/90", "m/d/yy")
    gPackDate slDate, ilDate0, ilDate1
    tmSmfSrchKey.iMissedDate(0) = ilDate0
    tmSmfSrchKey.iMissedDate(1) = ilDate1
    ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = llChfCode) And (tmSmf.iLineNo = ilLineNo) And (tmSmf.lFsfCode = llFsfCode)
        If igDoEvent Then
            DoEvents
        End If
        If (tmSmf.lMtfCode <> 0) And (lgMtfNoRecs <> 0) Then
            mCountSpots = ilPCount
            Exit Function
        End If
        gUnpackDateLong tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), llDate
        If (llDate >= llStartDate) And (llDate <= llEndDate) And (tmSmf.iOrigSchVef = imCVefCode) And (tmSmf.iGameNo = ilGameNo) Then
            tmSdfSrchKey3.lCode = tmSmf.lSdfCode
            ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If igDoEvent Then
                DoEvents
            End If
            If tlSdf.sSpotType <> "X" Then
                If (tlSdf.sSchStatus = "O") Or (tlSdf.sSchStatus = "G") Then    'Add these in later by testing missing date
                    ilCount = ilCount + 1
                End If
            End If
        End If
        ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    Loop
    mCountSpots = ilCount
End Function

'****************************************************************
'*
'*      Procedure Name:mDeleteASpot
'*
'*             Created:4/21/94       By:D. LeVine
'*            Modified:              By:
'*
'*            Comments:Remove a spot from Sdf and Ssf
'*
'*      11-30-04 Change access to smf to key2 instead of key0
'*                  for speed
'***************************************************************
Private Function mDeleteASpot(llSDFCode As Long) As Integer
'
'   mDeleteASpot
'   Where:
'       tlSdf(I) - spot to be deleted
'
'
    Dim ilRet As Integer
    Dim ilCRet As Integer
    Dim slDate As String
    Dim ilDate0 As Integer
    Dim ilDate1 As Integer
    Dim llDate As Long
    Dim ilDayIndex As Integer
    Dim llSmfRecPos As Long
    Dim slPass As String
    Dim ilVpfIndex As Integer
    Dim llEarliestAllowedDate As Long
    Dim tlSdf As SDF
    Dim llLockRecCode As Long
    Dim slUserName As String

    If igDoEvent Then
        DoEvents
    End If
    '2/21/11: Replace GetDirect with GetEqual
    'ilRet = btrGetDirect(hmSdf, tlSdf, imSdfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
    tmSdfSrchKey3.lCode = llSDFCode
    ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If igDoEvent Then
        DoEvents
    End If
    If ilRet <> BTRV_ERR_NONE Then
        mDeleteASpot = False
        Exit Function
    End If
    If tlSdf.sBill = "Y" Then
        mDeleteASpot = True
        Exit Function
    End If
    ilVpfIndex = gVpfFindIndex(tlSdf.iVefCode)
    llEarliestAllowedDate = lmEarliestAllowedDate   'Largest of (todays Date + 1 Or Last Log Date + 1)
    If ilVpfIndex <> -1 Then
        If tgVpf(ilVpfIndex).sMoveLLD = "Y" Then
            llDate = gDateValue(Format$(gNow(), "m/d/yy")) + 1
            If llDate < llEarliestAllowedDate Then
                llEarliestAllowedDate = llDate
            End If
        End If
    End If
    gUnpackDate tlSdf.iDate(0), tlSdf.iDate(1), slDate
    llDate = gDateValue(slDate)
    ilDayIndex = gWeekDayLong(llDate)
    imSmfRecLen = Len(tmSmf)
    imSdfRecLen = Len(tlSdf)
    slPass = tlSdf.sSchStatus
    If igDoEvent Then
        DoEvents
    End If
    'C=Cancelled; M=Missed; H=Hidden
    If (slPass = "C") Or (slPass = "M") Or (slPass = "H") Then
        Do
            If igDoEvent Then
                DoEvents
            End If
            'tmSRec = tlSdf
            'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
            'tlSdf = tmSRec
            'If igDoEvent Then
            '    DoEvents
            'End If
            'If ilRet <> BTRV_ERR_NONE Then
            '    mDeleteASpot = False
            '    Exit Function
            'End If
            ilRet = btrDelete(hmSdf)
            If ilRet = BTRV_ERR_CONFLICT Then
                '2/21/11: Replace GetDirect with GetEqual
                'ilRet = btrGetDirect(hmSdf, tlSdf, imSdfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                tmSdfSrchKey3.lCode = llSDFCode
                ilCRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If igDoEvent Then
            DoEvents
        End If
        If ilRet <> BTRV_ERR_NONE Then
            mDeleteASpot = False
            Exit Function
        End If
    ElseIf (slPass = "U") Or (slPass = "R") Then
        'Find matching Sdf
        '11-30-04 access smf by key2 instead of key0 for speed
        'tmSmfSrchKey.lChfCode = tlSdf.lChfCode
        'tmSmfSrchKey.iLineNo = tlSdf.iLineNo
        'tmSmfSrchKey.lFsfCode = tlSdf.lFsfCode
        slDate = Format$("1/1/90", "m/d/yy")
        gPackDate slDate, ilDate0, ilDate1
        'tmSmfSrchKey.iMissedDate(0) = ilDate0
        'tmSmfSrchKey.iMissedDate(1) = ilDate1
        'ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        tmSmfSrchKey2.lCode = tlSdf.lCode
        ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation

        Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tlSdf.lChfCode) And (tmSmf.iLineNo = tlSdf.iLineNo) And (tmSmf.lFsfCode = tlSdf.lFsfCode)
            If igDoEvent Then
                DoEvents
            End If
            If (tmSmf.sSchStatus = "U") Or (tmSmf.sSchStatus = "R") Then
                If tlSdf.lCode = tmSmf.lSdfCode Then
                    ilRet = btrGetPosition(hmSmf, llSmfRecPos)
                    Do
                        If igDoEvent Then
                            DoEvents
                        End If
                        'tmSRec = tmSmf
                        'ilRet = gGetByKeyForUpdate("SMF", hmSmf, tmSRec)
                        'tmSmf = tmSRec
                        'If igDoEvent Then
                        '    DoEvents
                        'End If
                        'If ilRet <> BTRV_ERR_NONE Then
                        '    mDeleteASpot = False
                        '    Exit Function
                        'End If
                        ilRet = btrDelete(hmSmf)
                        If ilRet = BTRV_ERR_CONFLICT Then
                            ilCRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, llSmfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                        End If
                    Loop While ilRet = BTRV_ERR_CONFLICT
                    If ilRet <> BTRV_ERR_NONE Then
                        mDeleteASpot = False
                        Exit Function
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                    '2/21/11: Replace GetDirect with GetEqual
                    'ilRet = btrGetPosition(hmSdf, llRecPos)
                    llSDFCode = tlSdf.lCode
                    Do
                        If igDoEvent Then
                            DoEvents
                        End If
                        'tmSRec = tlSdf
                        'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
                        'tlSdf = tmSRec
                        'If igDoEvent Then
                        '    DoEvents
                        'End If
                        'If ilRet <> BTRV_ERR_NONE Then
                        '    mDeleteASpot = False
                        '    Exit Function
                        'End If
                        ilRet = btrDelete(hmSdf)
                        If ilRet = BTRV_ERR_CONFLICT Then
                            '2/21/11: Replace GetDirect with GetEqual
                            'ilRet = btrGetDirect(hmSdf, tlSdf, imSdfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                            tmSdfSrchKey3.lCode = llSDFCode
                            ilCRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        End If
                    Loop While ilRet = BTRV_ERR_CONFLICT
                    If ilRet <> BTRV_ERR_NONE Then
                        mDeleteASpot = False
                        Exit Function
                    End If
                    mDeleteASpot = True
                    Exit Function
                End If
            End If
            If igDoEvent Then
                DoEvents
            End If
            ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        Loop
    ElseIf (slPass = "O") Or (slPass = "G") Then
        If llDate < llEarliestAllowedDate Then
            mDeleteASpot = True
            Exit Function
        End If
        If tlSdf.iGameNo <= 0 Then
            llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + llDate, True, slUserName)
        Else
            llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + tlSdf.iGameNo, True, slUserName)
        End If
        If llLockRecCode <= 0 Then
            mDeleteASpot = True
            Exit Function
        End If
        '11-30-04 access smf by key2 instead of key0 for speed
        'Find matching Sdf
        'tmSmfSrchKey.lChfCode = tlSdf.lChfCode
        'tmSmfSrchKey.iLineNo = tlSdf.iLineNo
        'tmSmfSrchKey.lFsfCode = tlSdf.lFsfCode
        slDate = Format$("1/1/90", "m/d/yy")
        gPackDate slDate, ilDate0, ilDate1
        'tmSmfSrchKey.iMissedDate(0) = ilDate0
        'tmSmfSrchKey.iMissedDate(1) = ilDate1
        'ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        tmSmfSrchKey2.lCode = tlSdf.lCode
        ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation

        Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tlSdf.lChfCode) And (tmSmf.iLineNo = tlSdf.iLineNo) And (tmSmf.lFsfCode = tlSdf.lFsfCode)
            If igDoEvent Then
                DoEvents
            End If
            If (tmSmf.sSchStatus = "O") Or (tmSmf.sSchStatus = "G") Then
                If tlSdf.lCode = tmSmf.lSdfCode Then
                    If csiHandleValue(0, 15) > 0 Then
                        ilRet = btrBeginTrans(hmCHF, 1000)
                    Else
                        ilRet = btrBeginTrans(hmCHF, -1000)
                    End If
                    If ilRet <> BTRV_ERR_NONE Then
                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                        mDeleteASpot = False
                        Exit Function
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                    ilRet = gMakeTracer(hmSdf, tlSdf, 0, hmStf, lmLastLogDate, "C", "C", tlSdf.iRotNo, hmGsf)
                    If Not ilRet Then
                        ilRet = btrAbortTrans(hmCHF)
                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                        mDeleteASpot = False
                        Exit Function
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                    ilRet = gChgSchSpot("D", hmSdf, tlSdf, hmSmf, tlSdf.iGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If Not ilRet Then
                        ilRet = btrAbortTrans(hmCHF)
                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                        mDeleteASpot = False
                        Exit Function
                    End If
                    ilRet = btrEndTrans(hmCHF)
                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                    mDeleteASpot = True
                    Exit Function
                End If
            End If
            If igDoEvent Then
                DoEvents
            End If
            ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        Loop
        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
    Else
        'Remove scheduled spots
        If llDate < llEarliestAllowedDate Then
            mDeleteASpot = True
            Exit Function
        End If
        If igDoEvent Then
            DoEvents
        End If
        If tlSdf.iGameNo <= 0 Then
            llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + llDate, True, slUserName)
        Else
            llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + tlSdf.iGameNo, True, slUserName)
        End If
        If llLockRecCode <= 0 Then
            mDeleteASpot = True
            Exit Function
        End If
        If csiHandleValue(0, 15) > 0 Then
            ilRet = btrBeginTrans(hmCHF, 1000)
        Else
            ilRet = btrBeginTrans(hmCHF, -1000)
        End If
        If ilRet <> BTRV_ERR_NONE Then
            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
            mDeleteASpot = False
            Exit Function
        End If
        If igDoEvent Then
            DoEvents
        End If
        ilRet = gMakeTracer(hmSdf, tlSdf, 0, hmStf, lmLastLogDate, "C", "C", tlSdf.iRotNo, hmGsf)
        If igDoEvent Then
            DoEvents
        End If
        If Not ilRet Then
            ilRet = btrAbortTrans(hmCHF)
            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
            mDeleteASpot = False
            Exit Function
        End If
        If igDoEvent Then
            DoEvents
        End If
        ilRet = gChgSchSpot("D", hmSdf, tlSdf, hmSmf, tlSdf.iGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf)
        If igDoEvent Then
            DoEvents
        End If
        If Not ilRet Then
            ilRet = btrAbortTrans(hmCHF)
            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
            mDeleteASpot = False
            Exit Function
        End If
        ilRet = btrEndTrans(hmCHF)
        If igDoEvent Then
            DoEvents
        End If
        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
        mDeleteASpot = True
        Exit Function
    End If
    mDeleteASpot = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mDeleteSpots                    *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Remove spot from Sdf and Ssf    *
'*                     Leave Extra Bonus as not counted*
'*                     as an spot                      *
'*                                                     *
'*******************************************************
Private Function mDeleteSpots(llChfCode As Long, ilLineNo As Integer, llFsfCode As Long, ilGameNo As Integer, llFromDate As Long, llToDate As Long, ilNoSpotsToRemove As Integer, ilDeleteExtra As Integer, slCBSOrder As String) As Integer
'
'   mDeleteSpots llChfCode, ilLineNo, llFsfCode, ilGameNo, llFromDate, llToDate, ilNoSpotsToRemove, ilDeleteExtra
'   Where:
'       llChfCode(I)- Contract code number
'       ilLineNo(I)- Contract line number
'       llFsfCode(I)- Feed code number
'       ilGameNo(I)- Game Number
'       llFromDate(I)- Start date for the removal of spots
'       llToDate(I)- end date for the removal of spots
'       ilNoSpotsToRemove(I)- Number of spots to be removed
'       ilDeleteExtra(I)- True=Include Removal of extra spots also; False =Bypass extra (leave)
'
'       imCVefCode(I)- Vehicle for which spots are to be removed
'       lmEarliestAllowedDate(I)- Earliest allowed schedule date (removal date)
'   Note: Remove missed spots prior to removing scheduled spots
'
    Dim ilRet As Integer
    Dim ilCRet As Integer
    Dim slDate As String
    Dim ilDate0 As Integer
    Dim ilDate1 As Integer
    Dim llDate As Long
    Dim ilDayIndex As Integer
    Dim slTime As String
    Dim ilFound As Integer
    '2/21/11: Replace GetDirect with GetEqual
    'Dim llSdfRecPos As Long
    Dim llSDFCode As Long
    Dim llSmfRecPos As Long
    Dim ilPass As Integer
    Dim slPass As String
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim slActualDate As String
    Dim llEarliestAllowedDate As Long
    Dim llSDFDate As Long
    Dim ilDelete As Integer
    Dim ilOrigSchVef As Integer
    Dim ilVpfIndex As Integer
    Dim tlSdf As SDF
    Dim llLockRecCode As Long
    Dim slUserName As String
    Dim ilSchGameNo As Integer
    '3/14/13
    Dim slChgType As String
    Dim llLLD As Long
    Dim llMonNowDate As Long
    Dim llFillTestDate As Long
    Dim slPassChgType As String
    Dim ilVpf As Integer
    Dim llTestDate As Long
    Dim llSdfLLD As Long
    '12/29/14: Handle fill
    Dim ilFillSourceVefCode As Integer

    'If spots can be moved between Now and LLD then allow spots to be removed from SSf
    ilVpfIndex = gVpfFindIndex(imCVefCode)
    llEarliestAllowedDate = lmEarliestAllowedDate   'Largest of (Todays Date + 1 Or Last Log Date + 1)
    If ilVpfIndex <> -1 Then
        If tgVpf(ilVpfIndex).sMoveLLD = "Y" Then
            llDate = gDateValue(Format$(gNow(), "m/d/yy")) + 1
            If llDate < llEarliestAllowedDate Then
                llEarliestAllowedDate = llDate
            End If
        End If
    End If
    
    '3/14/13:  Allow spots to be removed
    'Basic rules if week between last billed date and Last Log date and all spots should be removed
    '  set all spots as Fills between last billed +1 to and including Last Log date
    '  retain all previously created Fills
    '  delete all spots not scheduled (Cancelled, Hidden or Missed)
    slChgType = "D"
    If (ilNoSpotsToRemove >= 32000) And (Asc(tgSpf.sUsingFeatures10) And REPLACEDELWKWITHFILLS) = REPLACEDELWKWITHFILLS Then
        llMonNowDate = gDateValue(gObtainPrevMonday(Format$(gNow(), "m/d/yy")))
        If ilVpfIndex <> -1 Then
            gUnpackDateLong tgVpf(ilVpfIndex).iLLD(0), tgVpf(ilVpfIndex).iLLD(1), llLLD
        Else
            llLLD = 0
        End If
        If llLLD > llMonNowDate + 6 Then
            llFillTestDate = llLLD
        Else
            llFillTestDate = llMonNowDate + 6
        End If
        If (llToDate <= llFillTestDate) Then
            slChgType = "F"
        End If
    End If
    
    'Remove cancelled spots first
    imSmfRecLen = Len(tmSmf)
    llStartDate = llFromDate
    llEndDate = llToDate
    '3/14/13
    'If ilDeleteExtra Then
    If (ilDeleteExtra) And (slChgType <> "F") Then
        For ilPass = 0 To 1 Step 1
            If igDoEvent Then
                DoEvents
            End If
            If ilPass = 0 Then
                slPass = "O"
            Else
                slPass = "G"
            End If
            For llDate = llEndDate To llStartDate Step -1
                If igDoEvent Then
                    DoEvents
                End If
                'Allow Removing of unbilled spots in past- added 9/27/95
                'Contract can only be altered in past if user is allowed and
                'unbilled spots exist in week
                'If llDate < llEarliestAllowedDate Then
                '    Exit For
                'End If
                tmSmfSrchKey.lChfCode = llChfCode
                tmSmfSrchKey.iLineNo = ilLineNo
                tmSmfSrchKey.lFsfCode = llFsfCode
                slDate = Format$(llDate, "m/d/yy")
                gPackDate slDate, ilDate0, ilDate1
                tmSmfSrchKey.iMissedDate(0) = ilDate0
                tmSmfSrchKey.iMissedDate(1) = ilDate1
                ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = llChfCode) And (tmSmf.iLineNo = ilLineNo) And (tmSmf.lFsfCode = llFsfCode)
                    If igDoEvent Then
                        DoEvents
                    End If
                    ilFound = False
                    If (tmSmf.iMissedDate(0) <> ilDate0) Or (tmSmf.iMissedDate(1) <> ilDate1) Then
                        Exit Do
                    End If
                    gUnpackDate tmSmf.iActualDate(0), tmSmf.iActualDate(1), slActualDate
                    If (tmSmf.sSchStatus = slPass) And (gDateValue(slActualDate) >= llEarliestAllowedDate) And (tmSmf.iOrigSchVef = imCVefCode) And (tmSmf.iGameNo = ilGameNo) Then

                        'Find associated spot
                        'ilDayIndex = gWeekDayLong(llDate)

                        ilOrigSchVef = tmSmf.iOrigSchVef
                        '2/21/11: Replace GetDirect with GetEqual
                        llSDFCode = tmSmf.lSdfCode
                        tmSdfSrchKey3.lCode = llSDFCode
                        ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If igDoEvent Then
                            DoEvents
                        End If
                        If (ilRet = BTRV_ERR_NONE) Then
                            ilDelete = True
                            If tlSdf.sSpotType <> "X" Then
                                ilDelete = False
                            Else
                                '5/20/15: Remove fills between todays date and LLD if removing all spots
                                If (ilNoSpotsToRemove < 32000) Then
                                    gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSDFDate
                                    ilVpf = gBinarySearchVpf(tlSdf.iVefCode)
                                    If ilVpf <> -1 Then
                                        gUnpackDateLong tgVpf(ilVpf).iLLD(0), tgVpf(ilVpf).iLLD(1), llSdfLLD
                                        If llSDFDate <= llSdfLLD Then
                                            ilDelete = False
                                        End If
                                    End If
                                End If
                            End If
                            'Don't delete M for N MG's (these for removed via Undo Import Operstion)
                            If (tmSmf.lMtfCode > 0) And (lgMtfNoRecs > 0) Then
                                ilDelete = False
                            End If
                            If (ilDelete) And (tlSdf.sBill <> "Y") Then
                                'gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSdfDate
                                If tlSdf.iGameNo <= 0 Then
                                    llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + llSDFDate, True, slUserName)
                                Else
                                    llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + tlSdf.iGameNo, True, slUserName)
                                End If
                                If llLockRecCode <= 0 Then
                                    ilDelete = False
                                End If
                            End If
                            If (ilDelete) And (tlSdf.sBill <> "Y") Then
                                ''ilRet = btrGetPosition(hmSdf, llSdfRecPos)
                                ''If ilRet <> BTRV_ERR_NONE Then
                                ''    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                ''    mDeleteSpots = False
                                ''    Exit Function
                                ''End If
                                'gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSdfDate
                                ilDayIndex = gWeekDayLong(llSDFDate)
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If csiHandleValue(0, 15) > 0 Then
                                    ilRet = btrBeginTrans(hmCHF, 1000)
                                Else
                                    ilRet = btrBeginTrans(hmCHF, -1000)
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilRet <> BTRV_ERR_NONE Then
                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    mDeleteSpots = False
                                    Exit Function
                                End If
                                ilRet = gMakeTracer(hmSdf, tlSdf, 0, hmStf, lmLastLogDate, "C", "C", tlSdf.iRotNo, hmGsf)
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If Not ilRet Then
                                    ilRet = btrAbortTrans(hmCHF)
                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    mDeleteSpots = False
                                    Exit Function
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                ilSchGameNo = tlSdf.iGameNo
                                If gChgSchSpot("D", hmSdf, tlSdf, hmSmf, ilSchGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf) Then
                                    ilRet = btrEndTrans(hmCHF)
                                    gUnpackTime tlSdf.iTime(0), tlSdf.iTime(1), "A", "1", slTime
                                    ilRet = gObtainSsfForDateOrGame(imCVefCode, llSDFDate, slTime, ilSchGameNo, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex))
                                    ilFound = True
                                Else
                                    ilRet = btrAbortTrans(hmCHF)
                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    mDeleteSpots = False
                                    Exit Function
                                End If
                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                If igDoEvent Then
                                    DoEvents
                                End If
                            End If
                        End If
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilFound Then
                        tmSmfSrchKey.lChfCode = llChfCode
                        tmSmfSrchKey.iLineNo = ilLineNo
                        tmSmfSrchKey.lFsfCode = llFsfCode
                        slDate = Format$(llDate, "m/d/yy")
                        gPackDate slDate, ilDate0, ilDate1
                        tmSmfSrchKey.iMissedDate(0) = ilDate0
                        tmSmfSrchKey.iMissedDate(1) = ilDate1
                        ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    Else
                        ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop
            Next llDate
        Next ilPass
        slPass = "S"
        For llDate = llEndDate To llStartDate Step -1
            If igDoEvent Then
                DoEvents
            End If
            'Allow Removing of unbilled spots in past- added 9/27/95
            'Contract can only be altered in past if user is allowed and
            'unbilled spots exist in week
            'If llDate < llEarliestAllowedDate Then
            '    Exit For
            'End If
            ilDayIndex = gWeekDayLong(llDate)
            tgSdfSrchKey.iVefCode = imCVefCode
            tgSdfSrchKey.lChfCode = llChfCode
            tgSdfSrchKey.iLineNo = ilLineNo
            tgSdfSrchKey.lFsfCode = llFsfCode
            slDate = Format$(llDate, "m/d/yy")
            gPackDate slDate, ilDate0, ilDate1
            tgSdfSrchKey.iDate(0) = ilDate0
            tgSdfSrchKey.iDate(1) = ilDate1
            tgSdfSrchKey.sSchStatus = slPass
            tgSdfSrchKey.iTime(0) = 0
            tgSdfSrchKey.iTime(1) = 0
            ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
            Do While (ilRet = BTRV_ERR_NONE) And (tlSdf.iVefCode = imCVefCode) And (tlSdf.lChfCode = llChfCode) And (tlSdf.iLineNo = ilLineNo) And (tlSdf.lFsfCode = llFsfCode)
                If igDoEvent Then
                    DoEvents
                End If
                ilFound = False
                If (tlSdf.iDate(0) <> ilDate0) Or (tlSdf.iDate(1) <> ilDate1) Then
                    Exit Do
                End If
                If tlSdf.sSchStatus <> slPass Then
                    Exit Do
                End If
                If tlSdf.iGameNo = ilGameNo Then
                    ilDelete = True
                    If tlSdf.sSpotType <> "X" Then
                        ilDelete = False
                    Else
                        gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSDFDate
                        ilVpf = gBinarySearchVpf(tlSdf.iVefCode)
                        If ilVpf <> -1 Then
                            gUnpackDateLong tgVpf(ilVpf).iLLD(0), tgVpf(ilVpf).iLLD(1), llSdfLLD
                            If llSDFDate <= llSdfLLD Then
                                ilDelete = False
                            End If
                        End If
                    End If
                    If (ilDelete) And (tlSdf.sBill <> "Y") Then
                        'gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSdfDate
                        If tlSdf.iGameNo <= 0 Then
                            llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + llSDFDate, True, slUserName)
                        Else
                            llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + tlSdf.iGameNo, True, slUserName)
                        End If
                        If llLockRecCode <= 0 Then
                            ilDelete = False
                        End If
                    End If
                    If (ilDelete) And (tlSdf.sBill <> "Y") Then
                        If igDoEvent Then
                            DoEvents
                        End If
                        '2/21/11: Replace GetDirect with GetEqual
                        'ilRet = btrGetPosition(hmSdf, llSdfRecPos)
                        'If ilRet <> BTRV_ERR_NONE Then
                        '    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                        '    mDeleteSpots = False
                        '    Exit Function
                        'End If
                        llSDFCode = tlSdf.lCode
                        If igDoEvent Then
                            DoEvents
                        End If
                        If csiHandleValue(0, 15) > 0 Then
                            ilRet = btrBeginTrans(hmCHF, 1000)
                        Else
                            ilRet = btrBeginTrans(hmCHF, -1000)
                        End If
                        If ilRet <> BTRV_ERR_NONE Then
                            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                            mDeleteSpots = False
                            Exit Function
                        End If
                        If igDoEvent Then
                            DoEvents
                        End If
                        ilRet = gMakeTracer(hmSdf, tlSdf, 0, hmStf, lmLastLogDate, "C", "C", tlSdf.iRotNo, hmGsf)
                        If igDoEvent Then
                            DoEvents
                        End If
                        If Not ilRet Then
                            ilRet = btrAbortTrans(hmCHF)
                            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                            mDeleteSpots = False
                            Exit Function
                        End If
                        If igDoEvent Then
                            DoEvents
                        End If
                        ilSchGameNo = tlSdf.iGameNo
                        If gChgSchSpot("D", hmSdf, tlSdf, hmSmf, ilSchGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf) Then
                            ilRet = btrEndTrans(hmCHF)
                            ilFound = True
                        Else
                            ilRet = btrAbortTrans(hmCHF)
                            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                            mDeleteSpots = False
                            Exit Function
                        End If
                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                        If igDoEvent Then
                            DoEvents
                        End If
                    End If
                End If
                If ilFound Then
                    tgSdfSrchKey.iVefCode = imCVefCode
                    tgSdfSrchKey.lChfCode = llChfCode
                    tgSdfSrchKey.iLineNo = ilLineNo
                    tgSdfSrchKey.lFsfCode = llFsfCode
                    slDate = Format$(llDate, "m/d/yy")
                    gPackDate slDate, ilDate0, ilDate1
                    tgSdfSrchKey.iDate(0) = ilDate0
                    tgSdfSrchKey.iDate(1) = ilDate1
                    tgSdfSrchKey.sSchStatus = slPass
                    tgSdfSrchKey.iTime(0) = 0
                    tgSdfSrchKey.iTime(1) = 0
                    ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Else
                    ilRet = btrGetNext(hmSdf, tlSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                End If
                If igDoEvent Then
                    DoEvents
                End If
            Loop
        Next llDate
    End If
    If ilNoSpotsToRemove <= 0 Then
        mDeleteSpots = True
        Exit Function
    End If
    For ilPass = 0 To 7 Step 1
        If igDoEvent Then
            DoEvents
        End If
        Select Case ilPass
            Case 0
                slPass = "H"    'Remove hidden
            Case 1
                slPass = "C"    'Remove cancel
            Case 2
                slPass = "M"    'Missed
            Case 3
                slPass = "U"    'Unsch MG
            Case 4
                slPass = "R"    'Ready MG
            Case 5
                slPass = "O"    'Outside limits
            Case 6
                slPass = "G"    'MG
            Case 7
                slPass = "S"    'Scheduled
        End Select
        If (slPass = "C") Or (slPass = "M") Or (slPass = "H") Then
            For llDate = llEndDate To llStartDate Step -1
                If igDoEvent Then
                    DoEvents
                End If
                'If llDate < llEarliestAllowedDate Then
                '    Exit For
                'End If
                tgSdfSrchKey.iVefCode = imCVefCode
                tgSdfSrchKey.lChfCode = llChfCode
                tgSdfSrchKey.iLineNo = ilLineNo
                tgSdfSrchKey.lFsfCode = llFsfCode
                slDate = Format$(llDate, "m/d/yy")
                gPackDate slDate, ilDate0, ilDate1
                tgSdfSrchKey.iDate(0) = ilDate0
                tgSdfSrchKey.iDate(1) = ilDate1
                tgSdfSrchKey.sSchStatus = slPass
                tgSdfSrchKey.iTime(0) = 0
                tgSdfSrchKey.iTime(1) = 0
                ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tlSdf.iVefCode = imCVefCode) And (tlSdf.lChfCode = llChfCode) And (tlSdf.iLineNo = ilLineNo) And (tlSdf.lFsfCode = llFsfCode)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If (tlSdf.iDate(0) <> ilDate0) Or (tlSdf.iDate(1) <> ilDate1) Then
                        Exit Do
                    End If
                    If tlSdf.sSchStatus <> slPass Then
                        Exit Do
                    End If
                    ilFound = False
                    If tlSdf.iGameNo = ilGameNo Then
                        ilDelete = True
                        If (tlSdf.sTracer = "*") And (slCBSOrder <> "C") Then
                            ilDelete = False
                        End If
                        If (ilDelete) And (tlSdf.sBill <> "Y") Then
                            '2/21/11: Replace GetDirect with GetEqual
                            'ilRet = btrGetPosition(hmSdf, llSdfRecPos)
                            'If ilRet <> BTRV_ERR_NONE Then
                            '    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                            '    mDeleteSpots = False
                            '    Exit Function
                            'End If
                            llSDFCode = tlSdf.lCode
                            Do
                                If igDoEvent Then
                                    DoEvents
                                End If
                                'tmSRec = tlSdf
                                'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
                                'If igDoEvent Then
                                '    DoEvents
                                'End If
                                'tlSdf = tmSRec
                                ilRet = btrDelete(hmSdf)
                                If ilRet = BTRV_ERR_CONFLICT Then
                                    '2/21/11: Replace GetDirect with GetEqual
                                    'ilCRet = btrGetDirect(hmSdf, tlSdf, imSdfRecLen, llSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                    tmSdfSrchKey3.lCode = llSDFCode
                                    ilCRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                End If
                            Loop While ilRet = BTRV_ERR_CONFLICT
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilRet <> BTRV_ERR_NONE Then
                                mDeleteSpots = False
                                Exit Function
                            End If
                            ilNoSpotsToRemove = ilNoSpotsToRemove - 1
                            If ilNoSpotsToRemove <= 0 Then
                                mDeleteSpots = True
                                Exit Function
                            End If
                            ilFound = True
                        End If
                    End If
                    'ilRet = btrGetNext(hmSdf, tlSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                    If ilFound Then
                        tgSdfSrchKey.iVefCode = imCVefCode
                        tgSdfSrchKey.lChfCode = llChfCode
                        tgSdfSrchKey.iLineNo = ilLineNo
                        tgSdfSrchKey.lFsfCode = llFsfCode
                        slDate = Format$(llDate, "m/d/yy")
                        gPackDate slDate, ilDate0, ilDate1
                        tgSdfSrchKey.iDate(0) = ilDate0
                        tgSdfSrchKey.iDate(1) = ilDate1
                        tgSdfSrchKey.sSchStatus = slPass
                        tgSdfSrchKey.iTime(0) = 0
                        tgSdfSrchKey.iTime(1) = 0
                        ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    Else
                        ilRet = btrGetNext(hmSdf, tlSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop
            Next llDate
        ElseIf (slPass = "U") Or (slPass = "R") Then
            For llDate = llEndDate To llStartDate Step -1
                'If llDate < llEarliestAllowedDate Then
                '    Exit For
                'End If
                tmSmfSrchKey.lChfCode = llChfCode
                tmSmfSrchKey.iLineNo = ilLineNo
                tmSmfSrchKey.lFsfCode = llFsfCode
                slDate = Format$(llDate, "m/d/yy")
                gPackDate slDate, ilDate0, ilDate1
                tmSmfSrchKey.iMissedDate(0) = ilDate0
                tmSmfSrchKey.iMissedDate(1) = ilDate1
                ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = llChfCode) And (tmSmf.iLineNo = ilLineNo) And (tmSmf.lFsfCode = llFsfCode)
                    If igDoEvent Then
                        DoEvents
                    End If
                    ilFound = False
                    If (tmSmf.iMissedDate(0) <> ilDate0) Or (tmSmf.iMissedDate(1) <> ilDate1) Then
                        Exit Do
                    End If
                    If (tmSmf.sSchStatus = slPass) Then
                        'Find associated spot
                        'ilDayIndex = gWeekDayLong(llDate)
                        'tgSdfSrchKey.iVefCode = imCVefCode
                        'tgSdfSrchKey.lChfCode = llChfCode
                        'tgSdfSrchKey.iLineNo = ilLineNo
                        'slDate = Format$(llDate, "m/d/yy")
                        'gPackDate slDate, ilDate0, ilDate1
                        'tgSdfSrchKey.iDate(0) = tmSmf.iActualDate(0)
                        'tgSdfSrchKey.iDate(1) = tmSmf.iActualDate(1)
                        'tgSdfSrchKey.sSchStatus = slPass
                        'tgSdfSrchKey.iTime(0) = tmSmf.iActualTime(0)
                        'tgSdfSrchKey.iTime(1) = tmSmf.iActualTime(1)
                        'ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                        ilOrigSchVef = tmSmf.iOrigSchVef
                        tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                        ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If igDoEvent Then
                            DoEvents
                        End If
                        If (ilRet = BTRV_ERR_NONE) And (tlSdf.iGameNo = ilGameNo) Then
                            'If tlSdf.sBill <> "Y" Then
                            ilDelete = True
                            If (tlSdf.sTracer = "*") And (slCBSOrder <> "C") Then
                                ilDelete = False
                            End If
                            If (ilDelete) And (tlSdf.sBill <> "Y") Then
                                ilRet = btrGetPosition(hmSmf, llSmfRecPos)
                                Do
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    'tmSRec = tmSmf
                                    'ilRet = gGetByKeyForUpdate("SMF", hmSmf, tmSRec)
                                    'tmSmf = tmSRec
                                    'If igDoEvent Then
                                    '    DoEvents
                                    'End If
                                    ilRet = btrDelete(hmSmf)
                                    If ilRet = BTRV_ERR_CONFLICT Then
                                        ilCRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, llSmfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                    End If
                                Loop While ilRet = BTRV_ERR_CONFLICT
                                If ilRet <> BTRV_ERR_NONE Then
                                    mDeleteSpots = False
                                    Exit Function
                                End If
                                '2/21/11: Replace GetDirect with GetEqual
                                'ilRet = btrGetPosition(hmSdf, llSdfRecPos)
                                llSDFCode = tlSdf.lCode
                                Do
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    'tmSRec = tlSdf
                                    'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
                                    'tlSdf = tmSRec
                                    'If igDoEvent Then
                                    '    DoEvents
                                    'End If
                                    ilRet = btrDelete(hmSdf)
                                    If ilRet = BTRV_ERR_CONFLICT Then
                                        '2/21/11: Replace GetDirect with GetEqual
                                        'ilCRet = btrGetDirect(hmSdf, tlSdf, imSdfRecLen, llSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                        tmSdfSrchKey3.lCode = llSDFCode
                                        ilCRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                    End If
                                Loop While ilRet = BTRV_ERR_CONFLICT
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilRet <> BTRV_ERR_NONE Then
                                    mDeleteSpots = False
                                    Exit Function
                                End If
                                ilNoSpotsToRemove = ilNoSpotsToRemove - 1
                                If ilNoSpotsToRemove <= 0 Then
                                    mDeleteSpots = True
                                    Exit Function
                                End If
                            End If
                        End If
                    End If
                    If ilFound Then
                        tmSmfSrchKey.lChfCode = llChfCode
                        tmSmfSrchKey.iLineNo = ilLineNo
                        tmSmfSrchKey.lFsfCode = llFsfCode
                        slDate = Format$(llDate, "m/d/yy")
                        gPackDate slDate, ilDate0, ilDate1
                        tmSmfSrchKey.iMissedDate(0) = ilDate0
                        tmSmfSrchKey.iMissedDate(1) = ilDate1
                        ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    Else
                        ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop
            Next llDate
        ElseIf (slPass = "O") Or (slPass = "G") Then
            For llDate = llEndDate To llStartDate Step -1
                'Allow Removing of unbilled spots in past- added 9/27/95
                'Contract can only be altered in past if user is allowed and
                'unbilled spots exist in week
                'If llDate < llEarliestAllowedDate Then
                '    Exit For
                'End If
                tmSmfSrchKey.lChfCode = llChfCode
                tmSmfSrchKey.iLineNo = ilLineNo
                tmSmfSrchKey.lFsfCode = llFsfCode
                slDate = Format$(llDate, "m/d/yy")
                gPackDate slDate, ilDate0, ilDate1
                tmSmfSrchKey.iMissedDate(0) = ilDate0
                tmSmfSrchKey.iMissedDate(1) = ilDate1
                ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = llChfCode) And (tmSmf.iLineNo = ilLineNo) And (tmSmf.lFsfCode = llFsfCode)
                    If igDoEvent Then
                        DoEvents
                    End If
                    ilFound = False
                    If (tmSmf.iMissedDate(0) <> ilDate0) Or (tmSmf.iMissedDate(1) <> ilDate1) Then
                        Exit Do
                    End If
                    gUnpackDate tmSmf.iActualDate(0), tmSmf.iActualDate(1), slActualDate
                    '3/14/13
                    'If (tmSmf.sSchStatus = slPass) And (gDateValue(slActualDate) >= llEarliestAllowedDate) And (tmSmf.iOrigSchVef = imCVefCode) And (tmSmf.iGameNo = ilGameNo) Then
                    If (tmSmf.sSchStatus = slPass) And ((gDateValue(slActualDate) >= llEarliestAllowedDate) Or (slChgType = "F")) And (tmSmf.iOrigSchVef = imCVefCode) And (tmSmf.iGameNo = ilGameNo) Then
                        'Find associated spot
                        'ilDayIndex = gWeekDayLong(llDate)

                        ilOrigSchVef = tmSmf.iOrigSchVef
                        tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                        ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If igDoEvent Then
                            DoEvents
                        End If
                        If (ilRet = BTRV_ERR_NONE) Then
                            ilDelete = True
                            If (tlSdf.sSpotType = "X") Or (tlSdf.sSpotType = "O") Or (tlSdf.sSpotType = "C") Then
                                ilDelete = False
                            End If
                            If (tmSmf.lMtfCode > 0) And (lgMtfNoRecs > 0) Then
                                ilDelete = False
                            End If
                            If (ilDelete) And (tlSdf.sBill <> "Y") Then
                                gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSDFDate
                                If tlSdf.iGameNo <= 0 Then
                                    llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + llSDFDate, True, slUserName)
                                Else
                                    llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + tlSdf.iGameNo, True, slUserName)
                                End If
                                If llLockRecCode <= 0 Then
                                    ilDelete = False
                                End If
                            End If
                            If (ilDelete) And (tlSdf.sBill <> "Y") Then
                                'ilRet = btrGetPosition(hmSdf, llSdfRecPos)
                                'If ilRet <> BTRV_ERR_NONE Then
                                '    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                '    mDeleteSpots = False
                                '    Exit Function
                                'End If
                                gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSDFDate
                                ilDayIndex = gWeekDayLong(llSDFDate)
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If csiHandleValue(0, 15) > 0 Then
                                    ilRet = btrBeginTrans(hmCHF, 1000)
                                Else
                                    ilRet = btrBeginTrans(hmCHF, -1000)
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilRet <> BTRV_ERR_NONE Then
                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    mDeleteSpots = False
                                    Exit Function
                                End If
                                ilRet = gMakeTracer(hmSdf, tlSdf, 0, hmStf, lmLastLogDate, "C", "C", tlSdf.iRotNo, hmGsf)
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If Not ilRet Then
                                    ilRet = btrAbortTrans(hmCHF)
                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    mDeleteSpots = False
                                    Exit Function
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                ilSchGameNo = tlSdf.iGameNo
                                '3/14/13
                                slPassChgType = slChgType
                                llTestDate = llFillTestDate
                                If tmSmf.iOrigSchVef <> tlSdf.iVefCode Then
                                    ilVpf = gBinarySearchVpf(tlSdf.iVefCode)
                                    If ilVpf <> -1 Then
                                        gUnpackDateLong tgVpf(ilVpf).iLLD(0), tgVpf(ilVpf).iLLD(1), llLLD
                                    Else
                                        llLLD = 0
                                    End If
                                    If llLLD > llMonNowDate + 6 Then
                                        llTestDate = llLLD
                                    Else
                                        llTestDate = llMonNowDate + 6
                                    End If
                                    If (llToDate <= llTestDate) Then
                                        slPassChgType = "F"
                                    Else
                                        slPassChgType = "D"
                                    End If
                                End If
                                If slPassChgType = "F" Then
                                    If llSDFDate > llTestDate Then
                                        slPassChgType = "D"
                                    End If
                                Else
                                    If (ilNoSpotsToRemove >= 32000) And (Asc(tgSpf.sUsingFeatures10) And REPLACEDELWKWITHFILLS) = REPLACEDELWKWITHFILLS Then
                                        If llSDFDate <= llTestDate Then
                                            slPassChgType = "F"
                                        End If
                                    End If
                                End If
                                'If gChgSchSpot("D", hmSdf, tlSdf, hmSmf, ilSchGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmGsf, hmGhf) Then
                                If gChgSchSpot(slPassChgType, hmSdf, tlSdf, hmSmf, ilSchGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf) Then
                                    ilRet = btrEndTrans(hmCHF)
                                    gUnpackTime tlSdf.iTime(0), tlSdf.iTime(1), "A", "1", slTime
                                    ilRet = gObtainSsfForDateOrGame(imCVefCode, llSDFDate, slTime, ilSchGameNo, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex))
                                    ilFound = True
                                    ilNoSpotsToRemove = ilNoSpotsToRemove - 1
                                    If ilNoSpotsToRemove <= 0 Then
                                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                        mDeleteSpots = True
                                        Exit Function
                                    End If
                                Else
                                    ilRet = btrAbortTrans(hmCHF)
                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    mDeleteSpots = False
                                    Exit Function
                                End If
                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                If igDoEvent Then
                                    DoEvents
                                End If
                            End If
                        Else
                            mDeleteSpots = False
                            Exit Function
                        End If
                    End If
                    '3/14/13
                    'If ilFound Then
                    If (ilFound) Then
                        tmSmfSrchKey.lChfCode = llChfCode
                        tmSmfSrchKey.iLineNo = ilLineNo
                        tmSmfSrchKey.lFsfCode = llFsfCode
                        slDate = Format$(llDate, "m/d/yy")
                        gPackDate slDate, ilDate0, ilDate1
                        tmSmfSrchKey.iMissedDate(0) = ilDate0
                        tmSmfSrchKey.iMissedDate(1) = ilDate1
                        ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    Else
                        ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop
                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
            Next llDate
        Else
            'Remove scheduled spots
            For llDate = llEndDate To llStartDate Step -1
                If igDoEvent Then
                    DoEvents
                End If
                'Allow Removing of unbilled spots in past- added 9/27/95
                'Contract can only be altered in past if user is allowed and
                'unbilled spots exist in week
                'If llDate < llEarliestAllowedDate Then
                '    Exit For
                'End If
                ilDayIndex = gWeekDayLong(llDate)
                tgSdfSrchKey.iVefCode = imCVefCode
                tgSdfSrchKey.lChfCode = llChfCode
                tgSdfSrchKey.iLineNo = ilLineNo
                tgSdfSrchKey.lFsfCode = llFsfCode
                slDate = Format$(llDate, "m/d/yy")
                gPackDate slDate, ilDate0, ilDate1
                tgSdfSrchKey.iDate(0) = ilDate0
                tgSdfSrchKey.iDate(1) = ilDate1
                tgSdfSrchKey.sSchStatus = slPass
                tgSdfSrchKey.iTime(0) = 0
                tgSdfSrchKey.iTime(1) = 0
                ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tlSdf.iVefCode = imCVefCode) And (tlSdf.lChfCode = llChfCode) And (tlSdf.iLineNo = ilLineNo) And (tlSdf.lFsfCode = llFsfCode)
                    If igDoEvent Then
                        DoEvents
                    End If
                    ilFound = False
                    If (tlSdf.iDate(0) <> ilDate0) Or (tlSdf.iDate(1) <> ilDate1) Then
                        Exit Do
                    End If
                    If tlSdf.sSchStatus <> slPass Then
                        Exit Do
                    End If
                    If tlSdf.iGameNo = ilGameNo Then
                        ilDelete = True
                        If (tlSdf.sSpotType = "X") Or (tlSdf.sSpotType = "O") Or (tlSdf.sSpotType = "C") Then
                            ilDelete = False
                        End If
                        'MAI/Sirius: Added 10/4 Added Record Lock
                        If (ilDelete) And (tlSdf.sBill <> "Y") Then
                            gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSDFDate
                            If tlSdf.iGameNo <= 0 Then
                                llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + llSDFDate, True, slUserName)
                            Else
                                llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + tlSdf.iGameNo, True, slUserName)
                            End If
                            If llLockRecCode <= 0 Then
                                ilDelete = False
                            End If
                        End If
                        If (ilDelete) And (tlSdf.sBill <> "Y") Then
                            If igDoEvent Then
                                DoEvents
                            End If
                            'ilRet = btrGetPosition(hmSdf, llSdfRecPos)
                            'If ilRet <> BTRV_ERR_NONE Then
                            '    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                            '    mDeleteSpots = False
                            '    Exit Function
                            'End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            If csiHandleValue(0, 15) > 0 Then
                                ilRet = btrBeginTrans(hmCHF, 1000)
                            Else
                                ilRet = btrBeginTrans(hmCHF, -1000)
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilRet <> BTRV_ERR_NONE Then
                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                mDeleteSpots = False
                                Exit Function
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            ilRet = gMakeTracer(hmSdf, tlSdf, 0, hmStf, lmLastLogDate, "C", "C", tlSdf.iRotNo, hmGsf)
                            If igDoEvent Then
                                DoEvents
                            End If
                            If Not ilRet Then
                                ilRet = btrAbortTrans(hmCHF)
                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                mDeleteSpots = False
                                Exit Function
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            ilSchGameNo = tlSdf.iGameNo
                            '3/14/13
                            slPassChgType = slChgType
                            If slPassChgType = "F" Then
                                If llSDFDate > llFillTestDate Then
                                    slPassChgType = "D"
                                End If
                            End If
                            'If gChgSchSpot("D", hmSdf, tlSdf, hmSmf, ilSchGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmGsf, hmGhf) Then
                            '12/29/14: Handle vehicle code change
                            If (slPassChgType = "F") And (tmCClf.iVefCode <> tmPclf.iVefCode) Then
                                ilFillSourceVefCode = tmCClf.iVefCode
                            Else
                                ilFillSourceVefCode = 0
                            End If
                            If gChgSchSpot(slPassChgType, hmSdf, tlSdf, hmSmf, ilSchGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf, ilFillSourceVefCode) Then
                                ilRet = btrEndTrans(hmCHF)
                                ilFound = True
                                ilNoSpotsToRemove = ilNoSpotsToRemove - 1
                                If ilNoSpotsToRemove <= 0 Then
                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    mDeleteSpots = True
                                    Exit Function
                                End If
                            Else
                                ilRet = btrAbortTrans(hmCHF)
                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                mDeleteSpots = False
                                Exit Function
                            End If
                            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                            If igDoEvent Then
                                DoEvents
                            End If
                        End If
                    End If
                    '3/14/13
                    'If ilFound Then
                    If (ilFound) Then
                        tgSdfSrchKey.iVefCode = imCVefCode
                        tgSdfSrchKey.lChfCode = llChfCode
                        tgSdfSrchKey.iLineNo = ilLineNo
                        tgSdfSrchKey.lFsfCode = llFsfCode
                        slDate = Format$(llDate, "m/d/yy")
                        gPackDate slDate, ilDate0, ilDate1
                        tgSdfSrchKey.iDate(0) = ilDate0
                        tgSdfSrchKey.iDate(1) = ilDate1
                        tgSdfSrchKey.sSchStatus = slPass
                        tgSdfSrchKey.iTime(0) = 0
                        tgSdfSrchKey.iTime(1) = 0
                        ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    Else
                        ilRet = btrGetNext(hmSdf, tlSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop
            Next llDate
        End If
    Next ilPass
    mDeleteSpots = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetAvails                      *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Obtain avails to be checked     *
'*                                                     *
'*******************************************************
Private Sub mGetAvails(ilSchMode As Integer, tlClf As CLF, tlRdf As RDF, llStartTimes() As Long, llEndTimes() As Long, ilMnfExcl0 As Integer, ilMnfExcl1 As Integer, slChfType As String, iltmPreferredInfoIndex As Integer, ilCallType As Integer, slCallTypeDays As String, llCallTypeStartTime As Long, llCallTypeEndTime As Long)
'
'   mGetAvails ilSchMode, tlClf, tlRdf, llStartTime, llEndTime
'   Where:
'       ilSchMode(I)- Schedule mode (0=Insert; 1=Move; 2=Compact; 3=Preempt)
'       tlClf(I)- Line being scheduled
'       tlRdf(I)- Rate card program of the line being scheduled
'       llStartTime(I)- Allowed start times if time buy
'                       If multi times defined in the rate card with percentages, then
'                       this array will only contain the one being check
'       llEndTime(I)- Allowed end time if time buy
'       ilMnfExcl0(I)- Program exclusions
'       ilMnfExcl1(I)- Program exclusions
'
'       imAvailSubRec contains the avail indicies within Ssf to be checked
'       imDayIndex contains the day to get the avail for
'       tgSsf contains the days events (programs; avails; spots)
'

    Dim ilLoop As Integer
    Dim ilStartTime As Integer  'Hour and minutes
    Dim ilEndTime As Integer    'Hour and minutes
    Dim ilAvailOk As Integer
    Dim ilUnits As Integer
    Dim ilLenSold As Integer
    Dim ilTUnits As Integer
    Dim ilIndex As Integer
    Dim ilCompact As Integer
    Dim llAvailTime As Long
    Dim ilUpperBound As Integer
    Dim llExclEndTime As Long
    Dim slExclEndTime As String
    Dim ilAnyAvails As Integer
    Dim ilCheckDay As Integer
    Dim ilCheckPrefTime As Integer
    Dim ilPriFound As Integer
    Dim ilPriLen As Integer
    Dim ilSpot As Integer
    Dim ilLenOk As Integer
    Dim ilSecFound As Integer
    Dim ilStationCount As Integer
    'ReDim ilAvails(1 To 25) As Integer
    ReDim ilAvails(0 To 24) As Integer
    'ilUpperBound = 1
    ilUpperBound = 0
    'ilStartTime = (imHourIndex - 1) * 256 + (imQHIndex - 1) * 15    'in packed format
    ilStartTime = (imHourIndex) * 256 + (imQHIndex) * 15    'in packed format
    ilEndTime = ilStartTime + 15    'in packed format
    llExclEndTime = 0
    ilAnyAvails = False
    ilLoop = 1
    If iltmPreferredInfoIndex <> -1 Then
        If (tmPreferredInfo(iltmPreferredInfoIndex).iDays(imDayIndex) = 0) Or (tmPreferredInfo(iltmPreferredInfoIndex).iDays(imDayIndex) = -1) Then
            ilCheckDay = True
        Else
            ilCheckDay = False
        End If
    Else
        ilCheckDay = True
    End If
    If ilCheckDay Then
        Do While (ilLoop <= tgSsf(imDayIndex).iCount) And (tgSsf(imDayIndex).iCount < UBound(tgSsf(imDayIndex).tPas))
            If igDoEvent Then
                DoEvents
            End If
           LSet tmAvail = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilLoop)
            If (tmAvail.iRecType = 2) Or (tmAvail.iRecType = 8) Or (tmAvail.iRecType = 9) Then 'Book into Contract Avail subrecord only
                'Test time
                ilAvailOk = True
                If tmAvail.iTime(1) >= ilEndTime Then
                    If tgSsf(imDayIndex).iType <= 0 Then
                        Exit Do
                    End If
                    ilAvailOk = False
                End If
                If (tmAvail.iTime(1) < ilStartTime) Then
                    ilAvailOk = False
                End If
                If tmAvail.iRecType = 2 Then
                    If (slChfType = "M") Then
                        If ((Asc(tgSpf.sUsingFeatures3) And PROMOINTOCONTRACTAVAILS) <> PROMOINTOCONTRACTAVAILS) Then
                            ilAvailOk = False
                        End If
                    End If
                    If (slChfType = "S") Then
                        If ((Asc(tgSpf.sUsingFeatures3) And PSAINTOCONTRACTAVAILS) <> PSAINTOCONTRACTAVAILS) Then
                            ilAvailOk = False
                        End If
                    End If
                ElseIf tmAvail.iRecType = 9 Then
                    If slChfType <> "M" Then
                        ilAvailOk = False
                    End If
                ElseIf tmAvail.iRecType = 8 Then
                    If slChfType <> "S" Then
                        ilAvailOk = False
                    End If
                Else
                    ilAvailOk = False
                End If
                If ilAvailOk Then
                    ilAnyAvails = True
                End If
                'Test if closed avail
                If (ilAvailOk) And ((tmAvail.iAvInfo And SSLOCK) = SSLOCK) Then
                    ilAvailOk = False
                End If
                If ilAvailOk Then
                    If tlRdf.sInOut = "I" Then
                        If (tmAvail.ianfCode <> tlRdf.ianfCode) Then
                            ilAvailOk = False
                        End If
                    ElseIf tlRdf.sInOut = "O" Then
                        If (tmAvail.ianfCode = tlRdf.ianfCode) Then
                            ilAvailOk = False
                        End If
                    Else    'Book into any avail which allows sustaining spots
                        If (tmAvail.iAvInfo And SSSUSTAINING) <> SSSUSTAINING Then
                            ilAvailOk = False
                        End If
                        'Check if spot allowed into avail
                        If (ilAvailOk) And (tgSpf.sSystemType = "R") Then
                            If ((tmAvail.iAvInfo And SSLOCALONLY) = SSLOCALONLY) Or ((tmAvail.iAvInfo And SSFEEDONLY) = SSFEEDONLY) Then
                                If tlClf.lChfCode > 0 Then  'Local
                                    'Only allowed is Local Only or Both
                                    If (tmAvail.iAvInfo And SSLOCALONLY) <> SSLOCALONLY Then
                                        ilAvailOk = False
                                    End If
                                Else
                                    'Only allowed if Both (Local and Feed)
                                    'If (tmAvail.iAvInfo And SSFEEDONLY) <> SSFEEDONLY Then
                                        ilAvailOk = False
                                    'End If
                                End If
                            End If
                        End If
                    End If
                End If
                If igDoEvent Then
                    DoEvents
                End If
                If ilAvailOk Then
                    If tlClf.sSoloAvail = "Y" Then
                        ilUnits = 1
                        If tlClf.iLen <> tmAvail.iLen Then
                            ilAvailOk = False
                        End If
                    Else
                        If (tgVpf(imCVpfIndex).sSSellOut = "T") Then
                            ilUnits = tlClf.iLen \ 30
                            If ilUnits <= 0 Then
                                ilUnits = 1
                            End If
                        Else
                            ilUnits = 1
                        End If
                    End If
                    If ilAvailOk Then
                        If ilSchMode = 0 Then   'Insert
                            If imRafPass = 0 Then
                                'See if the spot can be linked with other spots
                                ilPriFound = False
                                For ilIndex = ilLoop + 1 To ilLoop + tmAvail.iNoSpotsThis Step 1
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                   LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                                    '10/6/08:  Remove the Matching spot lengt test
                                    'If ((tmSpot.iRecType And SSSPLITPRI) = SSSPLITPRI) And (tlClf.iLen = (tmSpot.iPosLen And &HFFF)) Then
                                    ilLenOk = True
                                    If (Asc(tgSpf.sUsingFeatures7) And REGIONMIXLEN) <> REGIONMIXLEN Then
                                        If tlClf.iLen <> (tmSpot.iPosLen And &HFFF) Then
                                            ilLenOk = False
                                        End If
                                    End If
                                    If ((tmSpot.iRecType And SSSPLITPRI) = SSSPLITPRI) And (ilLenOk) Then
                                        ilPriFound = True
                                        ilPriLen = tmSpot.iPosLen And &HFFF
                                        If gSplitNetworkStationConflicts(hmRaf, hmSef, hmSdf, hmClf, tmSpot.lSdfCode, tmStationsClf(), smClfInclExcl, ilStationCount) Then
                                            ilPriFound = False
                                        End If
                                        'Now check secondary
                                        If ilPriFound Then
                                            For ilSpot = ilIndex + 1 To ilLoop + tmAvail.iNoSpotsThis Step 1
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                               LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilSpot)
                                                If (tmSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                                                    If gSplitNetworkStationConflicts(hmRaf, hmSef, hmSdf, hmClf, tmSpot.lSdfCode, tmStationsClf(), smClfInclExcl, ilStationCount) Then
                                                        ilPriFound = False
                                                    End If
                                                Else
                                                    Exit For
                                                End If
                                            Next ilSpot
                                        End If
                                        If ilPriFound Then
                                            Exit For
                                        End If
                                    End If
                                Next ilIndex
                                If Not ilPriFound Then
                                    ilAvailOk = False
                                End If
                                If tlClf.sSoloAvail = "Y" Then
                                    If tmAvail.iNoSpotsThis > 1 Then
                                        'This will be handled in Pre-empt mode
                                        ilAvailOk = False
                                    End If
                                End If
                                If (tlClf.iLen > ilPriLen) Then
                                    'Check if enough room exist for spot
                                    ilLenSold = 0
                                    For ilIndex = ilLoop + 1 To ilLoop + tmAvail.iNoSpotsThis Step 1
                                       LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                                        If (tmSpot.iRecType And SSSPLITSEC) <> SSSPLITSEC Then
                                            ilLenSold = ilLenSold + tmSpot.iPosLen And &HFFF
                                        End If
                                    Next ilIndex
                                    If (tmAvail.iLen - ilLenSold) < (tlClf.iLen - ilPriLen) Then
                                        ilAvailOk = False
                                    End If
                                End If
                            Else
                                If tlClf.sSoloAvail = "Y" Then
                                    If tmAvail.iNoSpotsThis <> 0 Then
                                        'This will be handled in Pre-empt mode
                                        ilAvailOk = False
                                    End If
                                Else
                                    If (tgVpf(imCVpfIndex).sSSellOut = "T") Then
                                        For ilIndex = ilLoop + 1 To ilLoop + tmAvail.iNoSpotsThis Step 1
                                           LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                                            If (tmSpot.iRecType And SSSPLITSEC) <> SSSPLITSEC Then
                                                If ((tmSpot.iPosLen And &HFFF) \ 30) <= 0 Then
                                                    ilTUnits = ilTUnits + 1
                                                Else
                                                    ilTUnits = ilTUnits + (tmSpot.iPosLen And &HFFF) \ 30
                                                End If
                                            End If
                                        Next ilIndex
                                    Else
                                        ilTUnits = tmAvail.iNoSpotsThis
                                    End If
                                    If ilUnits > (tmAvail.iAvInfo And &H1F) - ilTUnits Then
                                        ilAvailOk = False
                                    Else    'Test time
                                        If (tgVpf(imCVpfIndex).sSSellOut = "B") Or (tgVpf(imCVpfIndex).sSSellOut = "U") Then
                                            ilLenSold = 0
                                            For ilIndex = ilLoop + 1 To ilLoop + tmAvail.iNoSpotsThis Step 1
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                               LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                                                If (tmSpot.iRecType And SSSPLITSEC) <> SSSPLITSEC Then
                                                    ilLenSold = ilLenSold + (tmSpot.iPosLen And &HFFF)
                                                End If
                                            Next ilIndex
                                            If tlClf.iLen > (tmAvail.iLen - ilLenSold) Then
                                                ilAvailOk = False
                                            End If
                                        ElseIf tgVpf(imCVpfIndex).sSSellOut = "M" Then
                                            ilLenSold = 0
                                            For ilIndex = ilLoop + 1 To ilLoop + tmAvail.iNoSpotsThis Step 1
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                               LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                                                If (tmSpot.iRecType And SSSPLITSEC) <> SSSPLITSEC Then
                                                    ilLenSold = ilLenSold + (tmSpot.iPosLen And &HFFF)
                                                End If
                                            Next ilIndex
                                            If tlClf.iLen <> (tmAvail.iLen - ilLenSold) Then
                                                ilAvailOk = False
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        Else    'Move, Competitive or Pre-empt
                            If (tmAvail.iAvInfo And SSLOCKSPOT) = SSLOCKSPOT Then
                                ilAvailOk = False
                            Else
                                If ilUnits > (tmAvail.iAvInfo And &H1F) Then
                                    ilAvailOk = False
                                Else    'Test time
                                    If tlClf.sSoloAvail = "Y" Then   'Solo Avail
                                        If tmAvail.iNoSpotsThis > 1 Then
                                            'Only allow one spot to be pre-empted at this time
                                            ilAvailOk = False
                                        End If
                                    Else
                                        If (tgVpf(imCVpfIndex).sSSellOut = "B") Or (tgVpf(imCVpfIndex).sSSellOut = "U") Then
                                            If tlClf.iLen > tmAvail.iLen Then
                                                ilAvailOk = False
                                            End If
                                        ElseIf tgVpf(imCVpfIndex).sSSellOut = "M" Then
                                            If tlClf.iLen <> tmAvail.iLen Then
                                                ilAvailOk = False
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                            If ilAvailOk And lmRafCode > 0 Then
                                ilAvailOk = False
                                If imRafPass = 0 Then
                                    'For ilIndex = ilLoop + 1 To ilLoop + tmAvail.iNoSpotsThis Step 1
                                    '    ilPriFound = False
                                    '    ilSecFound = False
                                    '    If igDoEvent Then
                                    '        DoEvents
                                    '    End If
                                    '   LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                                    '    If ((tmSpot.iRecType And SSSPLITPRI) = SSSPLITPRI) Then
                                    '        ilPriFound = True
                                    '        For ilSpot = ilIndex + 1 To tmAvail.iNoSpotsThis Step 1
                                    '            If igDoEvent Then
                                    '                DoEvents
                                    '            End If
                                    '           LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                                    '            If (tmSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                                    '                ilSecFound = True
                                    '            End If
                                    '            Exit For
                                    '        Next ilSpot
                                    '    End If
                                    '    If (ilPriFound) And (Not ilSecFound) Then
                                    '        ilAvailOk = True
                                    '        Exit For
                                    '    End If
                                    'Next ilIndex
                                Else
                                    For ilIndex = ilLoop + 1 To ilLoop + tmAvail.iNoSpotsThis Step 1
                                        ilPriFound = False
                                        ilSecFound = False
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                       LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilIndex)
                                        If ((tmSpot.iRecType And SSSPLITPRI) = SSSPLITPRI) Then
                                            ilPriFound = True
                                            For ilSpot = ilIndex + 1 To tmAvail.iNoSpotsThis Step 1
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                               LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilSpot)
                                                If (tmSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                                                    ilSecFound = True
                                                End If
                                                Exit For
                                            Next ilSpot
                                        End If
                                        If (Not ilPriFound) Then
                                            ilAvailOk = True
                                            Exit For
                                        End If
                                    Next ilIndex
                                End If
                            End If
                        End If
                    End If
                End If
                If igDoEvent Then
                    DoEvents
                End If
                If ilAvailOk Then
                    If (tlClf.iPosition = 1) And (tmAvail.iNoSpotsThis > 0) Then
                       LSet tmSpot = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilLoop + 1)
                        '3/22/10
                        'If (tmSpot.iPosLen And SS1STPOSITION) = SS1STPOSITION Then
                        If (tmSpot.lBkInfo And SS1STPOSITION) = SS1STPOSITION Then
                            If ilSchMode <> 3 Then
                                ilAvailOk = False
                            End If
                        End If
                    End If
                End If
                If ilAvailOk Then   'Test if avail within actual scheduling times
                    If (tlRdf.iLtfCode(0) <> 0) Or (tlRdf.iLtfCode(1) <> 0) Or (tlRdf.iLtfCode(2) <> 0) Then
                        If (tlRdf.iLtfCode(0) <> tmAvail.iLtfCode) And (tlRdf.iLtfCode(1) <> tmAvail.iLtfCode) And (tlRdf.iLtfCode(2) <> tmAvail.iLtfCode) Then
                            ilAvailOk = False
                        End If
                    Else
                        ilAvailOk = False
                        llAvailTime = (tmAvail.iTime(1) \ 256) * 3600& + (tmAvail.iTime(1) And &HFF) * 60& + (tmAvail.iTime(0) \ 256)
                        ilCheckPrefTime = False
                        If (iltmPreferredInfoIndex <> -1) Then
                            If (tmPreferredInfo(iltmPreferredInfoIndex).lETime <> -1) Then
                                ilCheckPrefTime = True
                            End If
                        End If

                        If ilCheckPrefTime Then
                            If (llAvailTime >= tmPreferredInfo(iltmPreferredInfoIndex).lSTime) And (llAvailTime < tmPreferredInfo(iltmPreferredInfoIndex).lETime) Then
                                ilAvailOk = True
                            End If
                        Else
                            For ilIndex = LBound(llStartTimes) To UBound(llStartTimes) Step 1
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If llStartTimes(ilIndex) > -1 Then
                                    'If (llAvailTime >= llStartTimes(ilIndex)) And (llAvailTime <= llEndTimes(ilIndex)) Then
                                    'Exclude end time i.e. 7:06am to 7:10am means 7:06am to 7:09:59am
                                    If (llAvailTime >= llStartTimes(ilIndex)) And (llAvailTime < llEndTimes(ilIndex)) Then
                                        ilAvailOk = True
                                        Exit For
                                    End If
                                End If
                            Next ilIndex
                        End If
                    End If
                End If
                If igDoEvent Then
                    DoEvents
                End If
                If ilAvailOk And (llExclEndTime > 0) Then
                    llAvailTime = (tmAvail.iTime(1) \ 256) * 3600& + (tmAvail.iTime(1) And &HFF) * 60& + (tmAvail.iTime(0) \ 256)
                    If llAvailTime < llExclEndTime Then
                        ilAvailOk = False
                    Else
                        llExclEndTime = 0
                    End If
                End If
                If (ilCallType = 1) And (ilAvailOk) Then
                    llAvailTime = (tmAvail.iTime(1) \ 256) * 3600& + (tmAvail.iTime(1) And &HFF) * 60& + (tmAvail.iTime(0) \ 256)
                    If (llAvailTime < llCallTypeStartTime) Or (llAvailTime >= llCallTypeEndTime) Then
                        ilAvailOk = False
                    End If
                End If
                'Bypass those avails that the Pre-empted spot was removed from
                If (ilCallType = 2) And (ilAvailOk) Then
                    llAvailTime = (tmAvail.iTime(1) \ 256) * 3600& + (tmAvail.iTime(1) And &HFF) * 60& + (tmAvail.iTime(0) \ 256)
                    If (llAvailTime >= llCallTypeStartTime) And (llAvailTime < llCallTypeEndTime) Then
                        If Mid$(slCallTypeDays, imDayIndex + 1, 1) = "Y" Then
                            ilAvailOk = False
                        End If
                    End If
                End If
                If ilAvailOk Then
                    If ilUpperBound > UBound(ilAvails) Then
                        'ReDim Preserve ilAvails(1 To UBound(ilAvails) + 10) As Integer
                        ReDim Preserve ilAvails(0 To UBound(ilAvails) + 10) As Integer
                    End If
                    ilAvails(ilUpperBound) = ilLoop
                    ilUpperBound = ilUpperBound + 1
                End If
                ilLoop = ilLoop + tmAvail.iNoSpotsThis + 1
            ElseIf tmAvail.iRecType = 1 Then 'Program subrecord
                'Test for program exclusions
                If igDoEvent Then
                    DoEvents
                End If
               LSet tmProg = tgSsf(imDayIndex).tPas(ADJSSFPASBZ + ilLoop)
                If tmProg.iStartTime(1) >= ilEndTime Then
                    If tgSsf(imDayIndex).iType <= 0 Then
                        Exit Do
                    End If
                Else
                    If (ilMnfExcl0 <> 0) And ((ilMnfExcl0 = tmProg.iMnfExcl(0)) Or (ilMnfExcl0 = tmProg.iMnfExcl(1))) Then
                        gUnpackTime tmProg.iEndTime(0), tmProg.iEndTime(1), "A", "1", slExclEndTime
                        llExclEndTime = CLng(gTimeToCurrency(slExclEndTime, True))
                    ElseIf (ilMnfExcl1 <> 0) And ((ilMnfExcl1 = tmProg.iMnfExcl(0)) Or (ilMnfExcl1 = tmProg.iMnfExcl(1))) Then
                        gUnpackTime tmProg.iEndTime(0), tmProg.iEndTime(1), "A", "1", slExclEndTime
                        llExclEndTime = CLng(gTimeToCurrency(slExclEndTime, True))
                    End If
                End If
                ilLoop = ilLoop + 1
            Else
                ilLoop = ilLoop + 1
            End If
            If igDoEvent Then
                DoEvents
            End If
        Loop
    End If
    If igDoEvent Then
        DoEvents
    End If
    If (Not ilAnyAvails) And (iltmPreferredInfoIndex = -1) Then
        imSkip(imHourIndex, imQHIndex, imDayIndex) = -1
    End If
    'If any avail shuffle
    ilUpperBound = ilUpperBound - 1
    'If ilUpperBound <= 0 Then
    If ilUpperBound < 0 Then
        'ReDim imAvailSubRec(1 To 1) As Integer
        'imAvailSubRec(1) = -1
        ReDim imAvailSubRec(0 To 0) As Integer
        imAvailSubRec(0) = -1
        Exit Sub
    End If
    'ReDim imAvailSubRec(1 To ilUpperBound) As Integer
    ReDim imAvailSubRec(0 To ilUpperBound) As Integer
    If igDoEvent Then
        DoEvents
    End If
    'ilLoop = 1
    ilLoop = LBound(imAvailSubRec)
    Do
        If igDoEvent Then
            DoEvents
        End If
        'If ilUpperBound > 1 Then
        If ilUpperBound > 0 Then
            'ilIndex = Int(ilUpperBound * Rnd + 1)
            ilIndex = Int((ilUpperBound + 1) * Rnd)
        Else
            'ilIndex = 1
            ilIndex = 0
        End If
        imAvailSubRec(ilLoop) = ilAvails(ilIndex)
        ilLoop = ilLoop + 1
        For ilCompact = ilIndex + 1 To ilUpperBound Step 1
            If igDoEvent Then
                DoEvents
            End If
            ilAvails(ilCompact - 1) = ilAvails(ilCompact)
        Next ilCompact
        ilUpperBound = ilUpperBound - 1
    'Loop While ilUpperBound > 0
    Loop While ilUpperBound >= 0
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetFirstLegalWkDate            *
'*                                                     *
'*             Created:5/18/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Determine if LCF date exist     *
'*                                                     *
'*******************************************************
Function mGetFirstLegalWkDate(hlLcf As Integer, sLCP As String, ilVefCode As Integer, llStartTestDate As Long, tlCff As CFF) As String
'
'   slDate = mGetFirstLegalDate( hlLcf, slCP, ilVefCode, llStartTestDate, tlCff)
'   Where:
'       hlLcf (I) - Library calendar handle
'       slCP (I) - C=Current; P= Pending
'       ilVefCode (I) - Vehicle code
'       llStartTestDate (I) - Date to be tested
'       tlCff(I)- Flight record
'
'       slDate(I)- First Legal Date
'
    Dim tlLcf As LCF                'LCF record image
    Dim tlLcfSrchKey As LCFKEY0     'LCF key record image
    Dim ilLcfRecLen As Integer         'LCF record length
    Dim ilRet As Integer
    Dim slDate As String
    Dim ilLogDate0 As Integer
    Dim ilLogDate1 As Integer
    Dim llTestDate As Long
    Dim ilDay As Integer
    Dim ilDayOk As Integer
    '2/20/11:  Handle legal dates prior to specified date
    Dim ilIncDec As Integer

'    slDate = Format$(llStartTestDate, "m/d/yy")
'    mGetFirstLegalWkDate = slDate
'    If tlCff.sDyWk = "D" Then
'        Exit Function
'    End If
'    llTestDate = llStartTestDate
'    Do
'        If igDoEvent Then
'            DoEvents
'        End If
'        ilDayOk = False
'        ilDay = gWeekDayLong(llTestDate)
'        If (tlCff.iDay(ilDay) <> 0) Or ((tlCff.sXDay(ilDay) <> "0") And (tlCff.sXDay(ilDay) <> " ")) Then
'            ilDayOk = True
'        End If
'        If ilDayOk Then
'            slDate = Format$(llTestDate, "m/d/yy")
'            gPackDate slDate, ilLogDate0, ilLogDate1
'            ilLcfRecLen = Len(tlLcf)
'            tlLcfSrchKey.iType = 0
'            tlLcfSrchKey.sStatus = sLCP 'P or C
'            tlLcfSrchKey.iVefCode = ilVefCode
'            tlLcfSrchKey.iLogDate(0) = ilLogDate0
'            tlLcfSrchKey.iLogDate(1) = ilLogDate1
'            tlLcfSrchKey.iSeqNo = 1
'            ilRet = btrGetEqual(hlLcf, tlLcf, ilLcfRecLen, tlLcfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'            If igDoEvent Then
'                DoEvents
'            End If
'            If ilRet = BTRV_ERR_NONE Then
'                'Day image exist- don't extend
'                mGetFirstLegalWkDate = slDate
'                Exit Function
'            End If
'        End If
'        If ilDay = 6 Then
'            Exit Function
'        End If
'        llTestDate = llTestDate + 1
'        If igDoEvent Then
'            DoEvents
'        End If
'    Loop While ilDay < 6

    slDate = Format$(llStartTestDate, "m/d/yy")
    mGetFirstLegalWkDate = slDate
    If tlCff.sDyWk = "D" Then
        Exit Function
    End If
    ilIncDec = 1
    llTestDate = llStartTestDate
    Do
        If igDoEvent Then
            DoEvents
        End If
        ilDayOk = False
        ilDay = gWeekDayLong(llTestDate)
        If (tlCff.iDay(ilDay) <> 0) Or ((tlCff.sXDay(ilDay) <> "0") And (tlCff.sXDay(ilDay) <> " ")) Then
            ilDayOk = True
        End If
        If ilDayOk Then
            slDate = Format$(llTestDate, "m/d/yy")
            gPackDate slDate, ilLogDate0, ilLogDate1
            ilLcfRecLen = Len(tlLcf)
            tlLcfSrchKey.iType = 0
            tlLcfSrchKey.sStatus = sLCP 'P or C
            tlLcfSrchKey.iVefCode = ilVefCode
            tlLcfSrchKey.iLogDate(0) = ilLogDate0
            tlLcfSrchKey.iLogDate(1) = ilLogDate1
            tlLcfSrchKey.iSeqNo = 1
            ilRet = btrGetEqual(hlLcf, tlLcf, ilLcfRecLen, tlLcfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If igDoEvent Then
                DoEvents
            End If
            If ilRet = BTRV_ERR_NONE Then
                'Day image exist- don't extend
                mGetFirstLegalWkDate = slDate
                Exit Function
            End If
        End If
        If (ilDay = 0) And (ilIncDec = -1) Then
            Exit Do
        End If
        If (ilDay = 6) And (ilIncDec = 1) Then
            ilIncDec = -1
        End If
        llTestDate = llTestDate + ilIncDec
        If igDoEvent Then
            DoEvents
        End If
    Loop While (ilDay >= 0) And (ilDay <= 6)
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetLegalTimes                  *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Get Legal times                 *
'*                                                     *
'*******************************************************
Private Sub mGetLegalTimes(slDate As String, ilGameNo As Integer, llStartTime() As Long, llEndTime() As Long)
    Dim ilSsfInMem As Integer
    Dim ilRet As Integer
    Dim llRecPos As Long
    Dim llDate As Long
    Dim ilDay As Integer
    Dim ilRPRet As Integer
    Dim ilTimeIndex As Integer
    Dim slTime As String
    Dim ilLoop As Integer
    Dim ilVpfIndex As Integer
    Dim slGMedium As String
    Dim ilTime As Integer

    For ilLoop = LBound(llStartTime) To UBound(llStartTime) Step 1
        llStartTime(ilLoop) = -1
        llEndTime(ilLoop) = -1
    Next ilLoop
    ilTime = LBound(llStartTime)
    llDate = gDateValue(slDate)
    ilDay = gWeekDayLong(llDate)
    llStartTime(ilTime) = 0 'Set to Midnight
    llEndTime(ilTime) = 86399
    ilVpfIndex = gVpfFindIndex(imCVefCode)
    If ilVpfIndex >= 0 Then
        slGMedium = tgVpf(ilVpfIndex).sGMedium
    Else
        slGMedium = ""
    End If
    If (tmCRdf.iLtfCode(0) <> 0) Or (tmCRdf.iLtfCode(1) <> 0) Or (tmCRdf.iLtfCode(2) <> 0) Then
        'Read Ssf for date- test for library
        ilSsfInMem = False
        If (lgSsfDate(ilDay) = llDate) Then
            '11/24/12
            'If (tgSsf(ilDay).iType = 0) And (tgSsf(ilDay).iVefCode = imCVefCode) And (tgSsf(ilDay).iStartTime(0) = 0) And (tgSsf(ilDay).iStartTime(1) = 0) Then
            If (tgSsf(ilDay).iType = ilGameNo) And (tgSsf(ilDay).iVefCode = imCVefCode) And (tgSsf(ilDay).iStartTime(0) = 0) And (tgSsf(ilDay).iStartTime(1) = 0) Then
                ilSsfInMem = True
                ilRet = BTRV_ERR_NONE
                llRecPos = lgSsfRecPos(ilDay)
            End If
        End If
        If Not ilSsfInMem Then
            imSsfRecLen = Len(tgSsf(ilDay)) 'Max size of variable length record
            '11/24/12
            'tgSsfSrchKey.iType = 0 'slType
            tgSsfSrchKey.iType = ilGameNo 'slType
            tgSsfSrchKey.iVefCode = imCVefCode
            tgSsfSrchKey.iDate(0) = tmSdf.iDate(0)
            tgSsfSrchKey.iDate(1) = tmSdf.iDate(1)
            tgSsfSrchKey.iStartTime(0) = 0
            tgSsfSrchKey.iStartTime(1) = 0
            ilRet = gSSFGetGreaterOrEqual(hmSsf, tgSsf(ilDay), imSsfRecLen, tgSsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get last current record to obtain date
            ilRPRet = gSSFGetPosition(hmSsf, llRecPos)
        End If
        If igDoEvent Then
            DoEvents
        End If
        'Do While (ilRet = BTRV_ERR_NONE) And (tgSsf(ilDay).iType = 0) And (tgSsf(ilDay).iVefCode = imCVefCode) And (tgSsf(ilDay).iDate(0) = tmSdf.iDate(0)) And (tgSsf(ilDay).iDate(1) = tmSdf.iDate(1))
        Do While (ilRet = BTRV_ERR_NONE) And (tgSsf(ilDay).iType = ilGameNo) And (tgSsf(ilDay).iVefCode = imCVefCode) And (tgSsf(ilDay).iDate(0) = tmSdf.iDate(0)) And (tgSsf(ilDay).iDate(1) = tmSdf.iDate(1))
            If igDoEvent Then
                DoEvents
            End If
            lgSsfDate(ilDay) = llDate
            lgSsfRecPos(ilDay) = llRecPos
            For ilLoop = 1 To tgSsf(ilDay).iCount Step 1
                If igDoEvent Then
                    DoEvents
                End If
               LSet tmProg = tgSsf(ilDay).tPas(ADJSSFPASBZ + ilLoop)
                If tmProg.iRecType = 1 Then 'Program subrecord
                    If (tmProg.iLtfCode = tmCRdf.iLtfCode(0)) Or (tmProg.iLtfCode = tmCRdf.iLtfCode(1)) Or (tmProg.iLtfCode = tmCRdf.iLtfCode(2)) Then
                        gUnpackTime tmProg.iStartTime(0), tmProg.iStartTime(1), "A", "1", slTime
                        llStartTime(ilTime) = CLng(gTimeToCurrency(slTime, False))
                        gUnpackTime tmProg.iEndTime(0), tmProg.iEndTime(1), "A", "1", slTime
                        llEndTime(ilTime) = CLng(gTimeToCurrency(slTime, True))
                        If llStartTime(ilTime) <> llEndTime(ilTime) Then
                            llEndTime(ilTime) = llEndTime(ilTime) - 1
                        End If
                        ilTime = ilTime + 1
                        Exit Do
                    End If
                End If
            Next ilLoop
            'If (tgSsf(ilDay).iNextTime(0) = 1) And (tgSsf(ilDay).iNextTime(1) = 0) Then
                Exit Do
            'Else
            '    imSsfRecLen = Len(tgSsf(ilDay)) 'Max size of variable length record
            '    ilRet = gSSFGetNext(hmSsf, tgSsf(ilDay), imSsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            '    ilRPRet = gSSFGetPosition(hmSsf, llRecPos)
            'End If
            If igDoEvent Then
                DoEvents
            End If
        Loop
    Else    'Time buy- check if override times defined (if so, use them as bump times)
        If ((tmCClf.iStartTime(0) = 1) And (tmCClf.iStartTime(1) = 0)) Or (slGMedium = "S") Then
            For ilTimeIndex = UBound(tmCRdf.iStartTime, 2) To LBound(tmCRdf.iStartTime, 2) Step -1
                If igDoEvent Then
                    DoEvents
                End If
                If (tmCRdf.iStartTime(0, ilTimeIndex) <> 1) Or (tmCRdf.iStartTime(1, ilTimeIndex) <> 0) Then
                    gUnpackTime tmCRdf.iStartTime(0, ilTimeIndex), tmCRdf.iStartTime(1, ilTimeIndex), "A", "1", slTime
                    llStartTime(ilTime) = CLng(gTimeToCurrency(slTime, False))
                    gUnpackTime tmCRdf.iEndTime(0, ilTimeIndex), tmCRdf.iEndTime(1, ilTimeIndex), "A", "1", slTime
                    llEndTime(ilTime) = CLng(gTimeToCurrency(slTime, True))
                    If llEndTime(ilTime) < llStartTime(ilTime) Then
                        llStartTime(ilTime + 1) = 0
                        llEndTime(ilTime + 1) = llEndTime(ilTime) - 1
                        llEndTime(ilTime) = 86399
                        ilTime = ilTime + 1
                    Else
                        If llStartTime(ilTime) <> llEndTime(ilTime) Then
                            llEndTime(ilTime) = llEndTime(ilTime) - 1
                        End If
                    End If
                    ilTime = ilTime + 1
                    If ilTime >= UBound(llStartTime) - 1 Then
                        Exit For
                    End If
                End If
            Next ilTimeIndex
        Else
            gUnpackTime tmCClf.iStartTime(0), tmCClf.iStartTime(1), "A", "1", slTime
            llStartTime(ilTime) = CLng(gTimeToCurrency(slTime, False))
            gUnpackTime tmCClf.iEndTime(0), tmCClf.iEndTime(1), "A", "1", slTime
            llEndTime(ilTime) = CLng(gTimeToCurrency(slTime, True))
            If llEndTime(ilTime) < llStartTime(ilTime) Then
                llStartTime(ilTime + 1) = 0
                llEndTime(ilTime + 1) = llEndTime(ilTime) - 1
                llEndTime(ilTime) = 86399
            Else
                If llStartTime(ilTime) <> llEndTime(ilTime) Then
                    llEndTime(ilTime) = llEndTime(ilTime) - 1
                End If
            End If
        End If
    End If
    If igDoEvent Then
        DoEvents
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetVefDates                    *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Get earliest allowed schedule   *
'*                     date and last log date          *
'*                                                     *
'*******************************************************
Function mGetVefDates(ilVefCode As Integer, ilVpfIndex As Integer) As Integer
    Dim ilVeh As Integer
    Dim slDate As String
    ilVpfIndex = -1
    'For ilVeh = 0 To UBound(tgVpf) Step 1
        If igDoEvent Then
            DoEvents
        End If
    '    If ilVefCode = tgVpf(ilVeh).iVefKCode Then 'If virtual vehicle, then latest log determined
        ilVeh = gBinarySearchVpfPlus(ilVefCode)
        If ilVeh <> -1 Then
            ilVpfIndex = ilVeh
    '        Exit For
        End If
    'Next ilVeh
    If ilVpfIndex = -1 Then
        mGetVefDates = False
        Exit Function
    End If
    slDate = Format$(gNow(), "m/d/yy")
    lmEarliestAllowedDate = gDateValue(slDate) + 1
    If (tgVpf(ilVpfIndex).iLLD(0) <> 0) Or (tgVpf(ilVpfIndex).iLLD(1) <> 0) Then
        gUnpackDate tgVpf(ilVpfIndex).iLLD(0), tgVpf(ilVpfIndex).iLLD(1), slDate
        If slDate <> "" Then
            lmLastLogDate = gDateValue(slDate)
        Else
            lmLastLogDate = 0
        End If
        If igSetEarliestDateAsToday <> 2 Then
            If gDateValue(slDate) >= lmEarliestAllowedDate Then
                lmEarliestAllowedDate = gDateValue(slDate) + 1
            End If
        End If
    Else
        lmLastLogDate = 0
    End If
    If igDoEvent Then
        DoEvents
    End If
    mGetVefDates = True
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mInitCounts                     *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Initialize count buckets        *
'*                                                     *
'*******************************************************
Private Sub mInitCounts(tlRdf As RDF, llChfCode As Long, ilLineNo As Integer, llFsfCode As Long, ilGameNo As Integer, ilHour() As Integer, ilDay() As Integer, ilQH() As Integer, ilSetCounts As Integer)
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilStartHr                     ilEndHr                       ilMin                     *
'*  ilHr                          ilIndex                                                 *
'******************************************************************************************

    Dim ilLoop As Integer
    Dim llNoRec As Long         'Number of records in Rvf
    Dim llRecPos As Long
    Dim tlSdfExt As SDFSCHEXT
    Dim ilExtRecLen As Integer     'Record length
    Dim ilRet As Integer
    Dim ilOffSet As Integer
    Dim slDate As String
    Dim ilDayIndex As Integer
    Dim ilHourIndex As Integer
    Dim ilQHIndex As Integer
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
    Dim tlIntTypeBuff As POPINTEGERTYPE   'Type field record
    Dim tlLongTypeBuff As POPLCODE   'Type field record
    Dim tlSdf As SDF
    For ilLoop = LBound(ilHour) To UBound(ilHour) Step 1
        ilHour(ilLoop) = 0
    Next ilLoop
    If igDoEvent Then
        DoEvents
    End If
    For ilLoop = LBound(ilDay) To UBound(ilDay) Step 1
        ilDay(ilLoop) = 0
    Next ilLoop
    If igDoEvent Then
        DoEvents
    End If
    For ilLoop = LBound(ilQH) To UBound(ilQH) Step 1
        ilQH(ilLoop) = 0
    Next ilLoop
    If igDoEvent Then
        DoEvents
    End If
    ''Adjust hour counts if negative percent daypart
    '8/14/06: fmRdfPct not used any longer.  It needed to be the opposite of this
    '         fmRdfPct was ok with mMake UnschSpot but is not right here
    'If imAnyZeroPct Then
    '    For ilIndex = UBound(tlRdf.iStartTime, 2) To LBound(tlRdf.iStartTime, 2) Step -1
    '        If igDoEvent Then
    '            DoEvents
    '        End If
    '        If (tlRdf.iStartTime(0, ilIndex) <> 1) Or (tlRdf.iStartTime(1, ilIndex) <> 0) Then
    '            ilStartHr = tlRdf.iStartTime(1, ilIndex) \ 256 + LBound(ilHour)
    '            ilEndHr = tlRdf.iEndTime(1, ilIndex) \ 256 + LBound(ilHour)
    '            If ilEndHr = LBound(ilHour) Then
    '                ilEndHr = UBound(ilHour)
    '            End If
    '            ilMin = tlRdf.iEndTime(1, ilIndex) And &HFF 'Obtain Minutes
    '            If ilMin = 0 Then
    '                For ilHr = ilStartHr To ilEndHr - 1 Step 1
    '                    ilHour(ilHr) = fmRdfPct(ilIndex)
    '                Next ilHr
    '            Else
    '                For ilHr = ilStartHr To ilEndHr Step 1
    '                    ilHour(ilHr) = fmRdfPct(ilIndex)
    '                Next ilHr
    '            End If
    '        End If
    '    Next ilIndex
    'End If
    If igDoEvent Then
        DoEvents
    End If
    If Not ilSetCounts Then
        Exit Sub
    End If
    tgSdfSrchKey.iVefCode = imCVefCode
    tgSdfSrchKey.lChfCode = llChfCode
    tgSdfSrchKey.iLineNo = ilLineNo
    tgSdfSrchKey.lFsfCode = llFsfCode
    tgSdfSrchKey.iDate(0) = 0
    tgSdfSrchKey.iDate(1) = 0
    tgSdfSrchKey.sSchStatus = "S"
    tgSdfSrchKey.iTime(0) = 0
    tgSdfSrchKey.iTime(1) = 0
    btrExtClear hmSdf   'Clear any previous extend operation
    ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    If igDoEvent Then
        DoEvents
    End If
    If ilRet = BTRV_ERR_END_OF_FILE Then
        Exit Sub
    End If
    If (tlSdf.iVefCode <> imCVefCode) Or (tlSdf.lChfCode <> llChfCode) Or (tlSdf.iLineNo <> ilLineNo) Or (tlSdf.lFsfCode <> llFsfCode) Then
        Exit Sub
    End If
    If ilRet <> BTRV_ERR_NONE Then
        Exit Sub
    End If
    llNoRec = 30000 \ Len(tlSdfExt) 'btrRecords(hmSdf) 'Obtain number of records
    Call btrExtSetBounds(hmSdf, llNoRec, -1, "UC", "SDFSCHEXTPK", SDFSCHEXTPK) 'Set extract limits (all records)
    tlIntTypeBuff.iType = imCVefCode
    ilOffSet = gFieldOffset("Sdf", "SdfVefCode")
    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_INT, ilOffSet, 2, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlIntTypeBuff, 2)
    tlLongTypeBuff.lCode = llChfCode
    ilOffSet = gFieldOffset("Sdf", "SdfChfCode")
    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_INT, ilOffSet, 4, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlLongTypeBuff, 4)
    tlIntTypeBuff.iType = ilLineNo
    ilOffSet = gFieldOffset("Sdf", "SdfLineNo")
    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_INT, ilOffSet, 2, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlIntTypeBuff, 2)
    tlLongTypeBuff.lCode = llFsfCode
    ilOffSet = gFieldOffset("Sdf", "SdfFsfCode")
    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_INT, ilOffSet, 4, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlLongTypeBuff, 4)
    tlIntTypeBuff.iType = ilGameNo
    ilOffSet = gFieldOffset("Sdf", "SdfGameNo")
    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_INT, ilOffSet, 2, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlIntTypeBuff, 2)
    tlCharTypeBuff.sType = "S"
    ilOffSet = gFieldOffset("Sdf", "SdfSchStatus")
    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_LAST_TERM, tlCharTypeBuff, 1)
    ilOffSet = gFieldOffset("Sdf", "SdfDate")
    ilExtRecLen = Len(tlSdfExt)
    ilRet = btrExtAddField(hmSdf, ilOffSet, ilExtRecLen - 1) 'Extract agency and advertiser fields (first two fields)
    ilOffSet = gFieldOffset("Sdf", "SdfSpotType")
    ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract agency and advertiser fields (first two fields)
    'ilRet = btrExtGetNextExt(hmSdf)    'Extract record
    ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtRecLen, llRecPos)
    If igDoEvent Then
        DoEvents
    End If
    If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
        If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
            Exit Sub
        End If
        'ilRet = btrExtGetFirst(hmSdf, tlSdfExt, ilExtRecLen, llRecPos)
        Do While ilRet = BTRV_ERR_REJECT_COUNT
            ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtRecLen, llRecPos)
        Loop
        Do While ilRet = BTRV_ERR_NONE
            If igDoEvent Then
                DoEvents
            End If
            If (tlSdfExt.sSpotType <> "X") And (tlSdfExt.sSpotType <> "O") And (tlSdfExt.sSpotType <> "C") Then
                'Convert date/time into indicies and increment counts
                gUnpackDate tlSdfExt.iDate(0), tlSdfExt.iDate(1), slDate
                'ilDayIndex = gWeekDayStr(slDate) + 1
                ilDayIndex = gWeekDayStr(slDate)
                ilDay(ilDayIndex) = ilDay(ilDayIndex) + 1
                'ilQHIndex = ((tlSdfExt.iTime(1) And &HFF) \ 15) + 1 'Obtain Minutes (0 to 59)
                ilQHIndex = ((tlSdfExt.iTime(1) And &HFF) \ 15)  'Obtain Minutes (0 to 59)
                ilQH(ilQHIndex) = ilQH(ilQHIndex) + 1
                'ilHourIndex = (tlSdfExt.iTime(1) \ 256) + 1  'Obtain hour (0 to 23)
                ilHourIndex = (tlSdfExt.iTime(1) \ 256)  'Obtain hour (0 to 23)
                ilHour(ilHourIndex) = ilHour(ilHourIndex) + 1
            End If
            ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtRecLen, llRecPos)
            Do While ilRet = BTRV_ERR_REJECT_COUNT
                ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtRecLen, llRecPos)
            Loop
        Loop
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mInitSchVar                     *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Set schedule variables          *
'*                                                     *
'*******************************************************
Private Sub mInitSchVar(ilInitVcf As Integer)
'    igRnd = True
'    sgMajor = "H"
'    sgMiddle = "D"
'    sgMinor = "Q"
'    igCyclePattern = 1
'    sgInsertPass = "A"
'    sgMovePass = "A"
'    sgCompPass = "A"
'    sgPreemptPass = "A"
    If ilInitVcf Then
        ReDim tmVcf0(0 To 0) As VCF
        ReDim tmVcf6(0 To 0) As VCF
        ReDim tmVcf7(0 To 0) As VCF
    End If
    'imACount = 0
    'imBCount = 0
    'imCCount = 0
    'imDCount = 0
    'imECount = 0
    imACount = -1
    imBCount = -1
    imCCount = -1
    imDCount = -1
    imECount = -1
    Select Case sgInsertPass
        Case "A"
            imACount = imACount + 1
            imAMode(imACount) = 0
        Case "B"
            imBCount = imBCount + 1
            imBMode(imBCount) = 0
        Case "C"
            imCCount = imCCount + 1
            imCMode(imCCount) = 0
        Case "D"
            imDCount = imDCount + 1
            imDMode(imDCount) = 0
        Case "E"
            imECount = imECount + 1
            imEMode(imECount) = 0
    End Select
    Select Case sgMovePass
        Case "A"
            imACount = imACount + 1
            imAMode(imACount) = 1
        Case "B"
            imBCount = imBCount + 1
            imBMode(imBCount) = 1
        Case "C"
            imCCount = imCCount + 1
            imCMode(imCCount) = 1
        Case "D"
            imDCount = imDCount + 1
            imDMode(imDCount) = 1
        Case "E"
            imECount = imECount + 1
            imEMode(imECount) = 1
    End Select
    Select Case sgCompPass
        Case "A"
            imACount = imACount + 1
            imAMode(imACount) = 2
        Case "B"
            imBCount = imBCount + 1
            imBMode(imBCount) = 2
        Case "C"
            imCCount = imCCount + 1
            imCMode(imCCount) = 2
        Case "D"
            imDCount = imDCount + 1
            imDMode(imDCount) = 2
        Case "E"
            imECount = imECount + 1
            imEMode(imECount) = 2
    End Select
    Select Case sgPreemptPass
        Case "A"
            imACount = imACount + 1
            imAMode(imACount) = 3
        Case "B"
            imBCount = imBCount + 1
            imBMode(imBCount) = 3
        Case "C"
            imCCount = imCCount + 1
            imCMode(imCCount) = 3
        Case "D"
            imDCount = imDCount + 1
            imDMode(imDCount) = 3
        Case "E"
            imECount = imECount + 1
            imEMode(imECount) = 3
    End Select
    'ReDim tgSpotMove(1 To 1) As SPOTMOVE
    ReDim tgSpotMove(0 To 0) As SPOTMOVE
    lgMtfNoRecs = btrRecords(hmMtf)
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mMakeUnschSpot                  *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Create a Sdf records for each   *
'*                     spot to be scheduled and save   *
'*                     the record location so the spot *
'*                     can be scheduled                *
'*                                                     *
'*            Note: Similar code is in spot function   *
'*                                                     *
'*******************************************************
Private Function mMakeUnschSpot(tlCff As CFF, slMissedDate As String, ilNoSpotsToCreate As Integer, ilGameNo As Integer) As Integer
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  slDisparity                   slTest                        ilNoMatches               *
'*  ilMatchIndex                  ilMatch                                                 *
'******************************************************************************************

'
'   mMakeUnschSpot slMisseddate, ilNoSpotsToCreate
'   Where:
'       slMissedDate(I)- Date to create spot for
'       ilNoSpotsToCreate(I)- Number of spots to be created on the missed date
'                             (Note: all weekly buys spots are created on the first legal
'                                    date if the week to give as much time as required to
'                                    schedule them)
'
    Dim llDate As Long
    Dim ilDay As Integer
    Dim ilSsfInMem As Integer
    Dim llSpotRecPos As Long
    Dim ilSpotNo As Integer
    Dim ilLoop As Integer
    Dim ilTimeAdded As Integer
    Dim ilRet As Integer
    Dim llRecPos As Long
    Dim ilRPRet As Integer
    Dim ilVpfIndex As Integer
    Dim slGMedium As String
    If igDoEvent Then
        DoEvents
    End If
    If ilNoSpotsToCreate <= 0 Then
        mMakeUnschSpot = True
        Exit Function
    End If
    If tgSpf.sCBumpPast <> "Y" Then
        If gDateValue(slMissedDate) <= gDateValue(Format$(gNow(), "m/d/yy")) Then
            mMakeUnschSpot = True
            Exit Function
        End If
    End If
    mRemoveResvSpots tlCff, slMissedDate, ilNoSpotsToCreate, ilGameNo
    If igDoEvent Then
        DoEvents
    End If
    ilVpfIndex = gVpfFindIndex(imCVefCode)
    If ilVpfIndex >= 0 Then
        slGMedium = tgVpf(ilVpfIndex).sGMedium
    Else
        slGMedium = ""
    End If
    For ilSpotNo = 1 To ilNoSpotsToCreate Step 1
        If igDoEvent Then
            DoEvents
        End If
        tmSdf.lCode = 0
        tmSdf.iVefCode = imCVefCode      'Vehicle Code (combos not allowed)
        tmSdf.lChfCode = tmCChf.lCode    'Contract code
        tmSdf.iLineNo = tmCClf.iLine    'Line number
        tmSdf.lFsfCode = tmCFsf.lCode
        tmSdf.iAdfCode = tmCChf.iAdfCode 'Advertiser code number
        gPackDate slMissedDate, tmSdf.iDate(0), tmSdf.iDate(1)
        llDate = gDateValue(slMissedDate)
        ilDay = gWeekDayLong(llDate)
        If (tmCRdf.iLtfCode(0) <> 0) Or (tmCRdf.iLtfCode(1) <> 0) Or (tmCRdf.iLtfCode(2) <> 0) Then
            ilTimeAdded = False
            'Read Ssf for date- test for library
            ilSsfInMem = False
            If (lgSsfDate(ilDay) = llDate) Then
                If (tgSsf(ilDay).iType = ilGameNo) And (tgSsf(ilDay).iVefCode = imCVefCode) And (tgSsf(ilDay).iStartTime(0) = 0) And (tgSsf(ilDay).iStartTime(1) = 0) Then
                    ilSsfInMem = True
                    ilRet = BTRV_ERR_NONE
                    llRecPos = lgSsfRecPos(ilDay)
                End If
            End If
            If Not ilSsfInMem Then
                imSsfRecLen = Len(tgSsf(ilDay)) 'Max size of variable length record
                If ilGameNo = 0 Then
                    tgSsfSrchKey.iType = 0 'slType
                    tgSsfSrchKey.iVefCode = imCVefCode
                    tgSsfSrchKey.iDate(0) = tmSdf.iDate(0)
                    tgSsfSrchKey.iDate(1) = tmSdf.iDate(1)
                    tgSsfSrchKey.iStartTime(0) = 0
                    tgSsfSrchKey.iStartTime(1) = 0
                    ilRet = gSSFGetGreaterOrEqual(hmSsf, tgSsf(ilDay), imSsfRecLen, tgSsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get last current record to obtain date
                Else
                    'tgSsfSrchKey1.iVefCode = imCVefCode
                    'tgSsfSrchKey1.iType = ilGameNo
                    'ilRet = gSSFGetEqualKey1(hmSsf, tgSsf(ilDay), imSsfRecLen, tgSsfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORWRITE)    'Get last current record to obtain date
                    tgSsfSrchKey2.iVefCode = imCVefCode
                    tgSsfSrchKey2.iDate(0) = tmSdf.iDate(0)
                    tgSsfSrchKey2.iDate(1) = tmSdf.iDate(1)
                    ilRet = gSSFGetEqualKey2(hmSsf, tgSsf(ilDay), imSsfRecLen, tgSsfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORWRITE)    'Get last current record to obtain date
                    Do While (ilRet = BTRV_ERR_NONE) And (tgSsf(ilDay).iVefCode = imCVefCode)
                        If (tgSsf(ilDay).iDate(0) = tmSdf.iDate(0)) And (tgSsf(ilDay).iDate(1) = tmSdf.iDate(1)) Then
                            If tgSsf(ilDay).iType = ilGameNo Then
                                Exit Do
                            End If
                        End If
                        ilRet = gSSFGetNext(hmSsf, tgSsf(ilDay), imSsfRecLen, BTRV_LOCK_NONE, SETFORWRITE)
                    Loop
                End If
                If igDoEvent Then
                    DoEvents
                End If
                ilRPRet = gSSFGetPosition(hmSsf, llRecPos)
                If igDoEvent Then
                    DoEvents
                End If
                If ilRPRet <> BTRV_ERR_NONE Then
                    mMakeUnschSpot = False
                    Exit Function
                End If
            End If
            Do While (ilRet = BTRV_ERR_NONE) And (tgSsf(ilDay).iType = ilGameNo) And (tgSsf(ilDay).iVefCode = imCVefCode) And (tgSsf(ilDay).iDate(0) = tmSdf.iDate(0)) And (tgSsf(ilDay).iDate(1) = tmSdf.iDate(1))
                lgSsfDate(ilDay) = llDate
                lgSsfRecPos(ilDay) = llRecPos
                For ilLoop = 1 To tgSsf(ilDay).iCount Step 1
                    If igDoEvent Then
                        DoEvents
                    End If
                   LSet tmProg = tgSsf(ilDay).tPas(ADJSSFPASBZ + ilLoop)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If tmProg.iRecType = 1 Then 'Program subrecord
                        If (tmProg.iLtfCode = tmCRdf.iLtfCode(0)) Or (tmProg.iLtfCode = tmCRdf.iLtfCode(1)) Or (tmProg.iLtfCode = tmCRdf.iLtfCode(2)) Then
                            tmSdf.iTime(0) = tmProg.iStartTime(0)
                            tmSdf.iTime(1) = tmProg.iStartTime(1)
                            ilTimeAdded = True
                            Exit Do
                        End If
                    End If
                Next ilLoop
                'If (tgSsf(ilDay).iNextTime(0) = 1) And (tgSsf(ilDay).iNextTime(1) = 0) Then
                    Exit Do
                'Else
                '    imSsfRecLen = Len(tgSsf(ilDay)) 'Max size of variable length record
                '    ilRet = gSSFGetNext(hmSsf, tgSsf(ilDay), imSsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                '    If igDoEvent Then
                '        DoEvents
                '    End If
                '    ilRPRet = gSSFGetPosition(hmSsf, llRecPos)
                '    If igDoEvent Then
                '        DoEvents
                '    End If
                '    If ilRPRet <> BTRV_ERR_NONE Then
                '        mMakeUnschSpot = False
                '        Exit Function
                '    End If
                'End If
            Loop
            If Not ilTimeAdded Then 'Library missing on day set time to 12m
                tmSdf.iTime(0) = 0
                tmSdf.iTime(1) = 0
            End If
        Else    'Time buy- check if override times defined (if so, use them as bump times)
            If ((tmCClf.iStartTime(0) = 1) And (tmCClf.iStartTime(1) = 0)) Or (slGMedium = "S") Then
                '8/14/06:  Un-necessary as the missed time is not used as the first hour to book into any longer
                ''Find greatest disparity value
                'slDisparity = 0!
                'ilNoMatches = 0
                'Do
                '    If igDoEvent Then
                '        DoEvents
                '    End If
                '    For ilLoop = LBound(tmCRdf.iStartTime, 2) To UBound(tmCRdf.iStartTime, 2) Step 1
                '        If igDoEvent Then
                '            DoEvents
                '        End If
                '        If (tmCRdf.iStartTime(0, ilLoop) <> 1) Or (tmCRdf.iStartTime(1, ilLoop) <> 0) Then
                '            If imRdfCnt(ilLoop) < fmRdfPct(ilLoop) Then
                '                slTest = fmRdfPct(ilLoop) - imRdfCnt(ilLoop)
                '                If (slDisparity - 0.01! <= slTest) And (slDisparity + 0.01! >= slTest) Then 'Match
                '                    ilNoMatches = ilNoMatches + 1
                '                    ilMatch(ilNoMatches) = ilLoop
                '                ElseIf slTest > slDisparity Then
                '                    slDisparity = fmRdfPct(ilLoop) - imRdfCnt(ilLoop)
                '                    ilNoMatches = 1
                '                    ilMatch(ilNoMatches) = ilLoop
                '                End If
                '            End If
                '        End If
                '    Next ilLoop
                '    If ilNoMatches = 0 Then 'Double count
                '        For ilLoop = LBound(tmCRdf.iStartTime, 2) To UBound(tmCRdf.iStartTime, 2) Step 1
                '            If igDoEvent Then
                '                DoEvents
                '            End If
                '            If (tmCRdf.iStartTime(0, ilLoop) <> 1) Or (tmCRdf.iStartTime(1, ilLoop) <> 0) Then
                '                If fmRdfPct(ilLoop) > 0! Then
                '                    fmRdfPct(ilLoop) = fmRdfPct(ilLoop) + fmRdfPctBase(ilLoop)
                '                End If
                '            End If
                '        Next ilLoop
                '    End If
                'Loop While ilNoMatches = 0
                'If ilNoMatches > 1 Then
                '    ilMatchIndex = Int(ilNoMatches * Rnd + 1)
                'Else
                '    ilMatchIndex = 1
                'End If
                'tmSdf.iTime(0) = tmCRdf.iStartTime(0, ilMatch(ilMatchIndex))
                'tmSdf.iTime(1) = tmCRdf.iStartTime(1, ilMatch(ilMatchIndex))
                'imRdfCnt(ilMatch(ilMatchIndex)) = imRdfCnt(ilMatch(ilMatchIndex)) + 1
                For ilLoop = LBound(tmCRdf.iStartTime, 2) To UBound(tmCRdf.iStartTime, 2) Step 1
                    If igDoEvent Then
                        DoEvents
                    End If
                    If (tmCRdf.iStartTime(0, ilLoop) <> 1) Or (tmCRdf.iStartTime(1, ilLoop) <> 0) Then
                        tmSdf.iTime(0) = tmCRdf.iStartTime(0, ilLoop)
                        tmSdf.iTime(1) = tmCRdf.iStartTime(1, ilLoop)
                        'If tmCRdf.sWkDays(ilLoop, ilDay + 1) = "Y" Then
                        If tmCRdf.sWkDays(ilLoop, ilDay) = "Y" Then
                            Exit For
                        End If
                    End If
                Next ilLoop
            Else
                tmSdf.iTime(0) = tmCClf.iStartTime(0)
                tmSdf.iTime(1) = tmCClf.iStartTime(1)
            End If
        End If
        If igDoEvent Then
            DoEvents
        End If
        tmSdf.sSchStatus = "M"    'S=Scheduled, M=Missed,
                                    'G=Makegood, A=on alternate log but not MG, B=on alternate Log and MG,
                                    'C=Cancelled, H=Hidden
        tmSdf.iMnfMissed = igDefaultMnfMissed   'Missed reason
        tmSdf.sTracer = " "   'M=Mouse move, N=On demand & mouse moved, C=Created in post log,
                                'N=N/A, D=on Demand & created in post log
        tmSdf.sAffChg = " "   'T=Time change, C=Copy change, B=Time and copy changed, blank=no change
        tmSdf.iRotNo = 0
        If (tmCFsf.lCode <= 0) Or (tmCFsf.lCifCode <= 0) Then
            tmSdf.sPtType = "0"    'Not assigned
            tmSdf.lCopyCode = 0        'Copy inventory code
            tmSdf.iRotNo = 0
        Else
            tmSdf.sPtType = "1"
            tmSdf.lCopyCode = tmCFsf.lCifCode       'Copy inventory code
        End If
        tmSdf.iLen = tmCClf.iLen         'Spot length
        tmSdf.sPriceType = "L" 'Use line pricetmCClf.sPriceType 'T=True; N=No Charge; B=Bonus; S=Spinoff; R=Recapturable; A=Audience Deficiency Unit (adu)
        tmSdf.sSpotType = "A" 'tmCClf.sBB       'Spot type: N=N/A (regular spot); O=Open BB; C=Close BB; F=Floater BB;
                                'M=Commercial Promo(create avails if not found); P=Pledge spot;
                                'D=Donut; B=Bookend; S=PSA; R=Promo;
        tmSdf.sBill = "N"       'Not Billed
        tmSdf.lSmfCode = 0
        tmSdf.iUrfCode = tgUrf(0).iCode      'Last user who modified spot
        tmSdf.iGameNo = ilGameNo
        tmSdf.sXCrossMidnight = "N"
        tmSdf.sWasMG = "N"
        tmSdf.sFromWorkArea = "N"
        tmSdf.sUnused = ""
        ilRet = btrInsert(hmSdf, tmSdf, imSdfRecLen, INDEXKEY3)
        If igDoEvent Then
            DoEvents
        End If
        If ilRet <> BTRV_ERR_NONE Then
            mMakeUnschSpot = False
            Exit Function
        End If
        ilRet = btrGetPosition(hmSdf, llSpotRecPos)
        If igDoEvent Then
            DoEvents
        End If
        If ilRet <> BTRV_ERR_NONE Then
            mMakeUnschSpot = False
            Exit Function
        End If
        'lgUnschRecPos(UBound(lgUnschRecPos)) = llSpotRecPos
        'ReDim Preserve lgUnschRecPos(1 To UBound(lgUnschRecPos) + 1) As Long
        lgUnschSdfCode(UBound(lgUnschSdfCode)) = tmSdf.lCode
        'ReDim Preserve lgUnschSdfCode(1 To UBound(lgUnschSdfCode) + 1) As Long
        ReDim Preserve lgUnschSdfCode(LBound(lgUnschSdfCode) To UBound(lgUnschSdfCode) + 1) As Long
        If igDoEvent Then
            DoEvents
        End If
    Next ilSpotNo
    mMakeUnschSpot = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mMoveMissedToLegalDate          *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Move missed spot to valid date  *
'*                                                     *
'*******************************************************
Private Function mMoveMissedToLegalDate(llChfCode As Long, ilLineNo As Integer, llFsfCode As Long, ilGameNo As Integer, llFromDate As Long, llToDate As Long, llNewDate As Long) As Integer
'
'   mMoveMissedToLegalDate llChfCode, ilLineNo, llFromDate, llToDate, llNewDate
'   Where:
'       llChfCode(I)- Contract code number
'       ilLineNo(I)- Contract line number
'       llFsfCode(I)- Feed code
'       llFromDate(I)- Start date for the removal of spots
'       llToDate(I)- end date for the removal of spots
'       llNewDate(I)- Legal date for spot
'
    Dim ilRet As Integer
    Dim ilRet1 As Integer
    Dim slDate As String
    Dim llDate As Long
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim tlSdf As SDF
    Dim ilDate0 As Integer
    Dim ilDate1 As Integer
    Dim ilNewDate0 As Integer
    Dim ilNewDate1 As Integer
    '2/21/11: Replace getDirect with GetEqual
    'Dim llSdfRecPos As Long
    Dim llSDFCode As Long
    Dim ilSpotUpdated As Integer

    slDate = Format$(llNewDate, "m/d/yy")
    gPackDate slDate, ilNewDate0, ilNewDate1
    llStartDate = llFromDate
    llEndDate = llToDate
    For llDate = llStartDate To llEndDate Step 1
        If igDoEvent Then
            DoEvents
        End If
        tgSdfSrchKey.iVefCode = imCVefCode
        tgSdfSrchKey.lChfCode = llChfCode
        tgSdfSrchKey.iLineNo = ilLineNo
        tgSdfSrchKey.lFsfCode = llFsfCode
        slDate = Format$(llDate, "m/d/yy")
        gPackDate slDate, ilDate0, ilDate1
        If (ilDate0 <> ilNewDate0) Or (ilDate1 <> ilNewDate1) Then
            tgSdfSrchKey.iDate(0) = ilDate0
            tgSdfSrchKey.iDate(1) = ilDate1
            tgSdfSrchKey.sSchStatus = " "
            tgSdfSrchKey.iTime(0) = 0
            tgSdfSrchKey.iTime(1) = 0
            ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
            Do While (ilRet = BTRV_ERR_NONE) And (tlSdf.iVefCode = imCVefCode) And (tlSdf.lChfCode = llChfCode) And (tlSdf.iLineNo = ilLineNo) And (tlSdf.lFsfCode = llFsfCode)
                If igDoEvent Then
                    DoEvents
                End If
                ilSpotUpdated = False
                If (tlSdf.iDate(0) <> ilDate0) Or (tlSdf.iDate(1) <> ilDate1) Then
                    Exit Do
                End If
                If (tlSdf.sSchStatus <> "S") And (tlSdf.sSchStatus <> "G") And (tlSdf.sSchStatus <> "O") And (tlSdf.iGameNo = ilGameNo) Then
                    ilSpotUpdated = True
                    '2/21/11: Replace GetDirect with GetEqual
                    'ilRet = btrGetPosition(hmSdf, llSdfRecPos)
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    mMoveMissedToLegalDate = False
                    '    Exit Function
                    'End If
                    llSDFCode = tlSdf.lCode
                    Do
                        If igDoEvent Then
                            DoEvents
                        End If
                        'tmSRec = tlSdf
                        'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
                        'tlSdf = tmSRec
                        'If igDoEvent Then
                        '    DoEvents
                        'End If
                        'If ilRet <> BTRV_ERR_NONE Then
                        '    mMoveMissedToLegalDate = False
                        '    Exit Function
                        'End If
                        tlSdf.iDate(0) = ilNewDate0
                        tlSdf.iDate(1) = ilNewDate1
                        tlSdf.sXCrossMidnight = "N"
                        ilRet = btrUpdate(hmSdf, tlSdf, imSdfRecLen)
                        If igDoEvent Then
                            DoEvents
                        End If
                        If ilRet = BTRV_ERR_CONFLICT Then
                            '2/21/11: Replace GetDirect with GetEqual
                            'ilRet1 = btrGetDirect(hmSdf, tlSdf, imSdfRecLen, llSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                            tmSdfSrchKey3.lCode = llSDFCode
                            ilRet1 = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)    'Get first record as starting point of extend operation
                            If igDoEvent Then
                                DoEvents
                            End If
                            If (tlSdf.sSchStatus = "S") Or (tlSdf.sSchStatus = "G") Or (tlSdf.sSchStatus = "O") Then
                                ilRet = BTRV_ERR_NONE
                                Exit Do
                            End If
                            If ilRet1 <> BTRV_ERR_NONE Then
                                mMoveMissedToLegalDate = False
                                Exit Function
                            End If
                        End If
                    Loop While ilRet = BTRV_ERR_CONFLICT
                    If ilRet <> BTRV_ERR_NONE Then
                        mMoveMissedToLegalDate = False
                        Exit Function
                    End If
                End If
                If ilSpotUpdated Then
                    'This is required since date is part of key
                    tgSdfSrchKey.iVefCode = imCVefCode
                    tgSdfSrchKey.lChfCode = llChfCode
                    tgSdfSrchKey.iLineNo = ilLineNo
                    tgSdfSrchKey.lFsfCode = llFsfCode
                    tgSdfSrchKey.iDate(0) = ilDate0
                    tgSdfSrchKey.iDate(1) = ilDate1
                    tgSdfSrchKey.sSchStatus = " "
                    tgSdfSrchKey.iTime(0) = 0
                    tgSdfSrchKey.iTime(1) = 0
                    ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Else
                    ilRet = btrGetNext(hmSdf, tlSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                End If
                If igDoEvent Then
                    DoEvents
                End If
            Loop
        End If
    Next llDate
    mMoveMissedToLegalDate = True
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mSwapSbf                        *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Move SBF to Current Chf         *
'*                                                     *
'*******************************************************
Private Function mSwapSbfMsfPcf(hlSbf As Integer, hlMsf As Integer, hlPcf As Integer, llFromChfCode As Long, llToChfCode As Long) As Integer
    Dim ilRet As Integer
    Dim ilUpper As Integer
    Dim ilLoop As Integer

    'Get SBF records to be moved
    ReDim tmCSbf(0 To 0) As SBF
    ilUpper = 0
    imSbfRecLen = Len(tmSbf)
    tmSbfSrchKey0.lChfCode = llFromChfCode
    tmSbfSrchKey0.iDate(0) = 0
    tmSbfSrchKey0.iDate(1) = 0
    tmSbfSrchKey0.sTranType = " "
    ilRet = btrGetGreaterOrEqual(hlSbf, tmCSbf(ilUpper), imSbfRecLen, tmSbfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmCSbf(ilUpper).lChfCode = llFromChfCode)
        If (tmCSbf(ilUpper).sTranType = "I") Or (tmCSbf(ilUpper).sTranType = "F") Then
            ilUpper = ilUpper + 1
            ReDim Preserve tmCSbf(0 To ilUpper) As SBF
        End If
        If igDoEvent Then
            DoEvents
        End If
        ilRet = btrGetNext(hlSbf, tmCSbf(ilUpper), imSbfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    ReDim tmPSbf(0 To 0) As SBF
    ilUpper = 0
    tmSbfSrchKey0.lChfCode = llToChfCode
    tmSbfSrchKey0.iDate(0) = 0
    tmSbfSrchKey0.iDate(1) = 0
    tmSbfSrchKey0.sTranType = " "
    ilRet = btrGetGreaterOrEqual(hlSbf, tmPSbf(ilUpper), imSbfRecLen, tmSbfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmPSbf(ilUpper).lChfCode = llToChfCode)
        If (tmPSbf(ilUpper).sTranType = "I") Or (tmPSbf(ilUpper).sTranType = "F") Then
            ilUpper = ilUpper + 1
            ReDim Preserve tmPSbf(0 To ilUpper) As SBF
        End If
        If igDoEvent Then
            DoEvents
        End If
        ilRet = btrGetNext(hlSbf, tmPSbf(ilUpper), imSbfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    'Delete records from SBF
    For ilLoop = LBound(tmCSbf) To UBound(tmCSbf) - 1 Step 1
        Do
            tmSbfSrchKey1.lCode = tmCSbf(ilLoop).lCode
            ilRet = btrGetEqual(hlSbf, tmSbf, imSbfRecLen, tmSbfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                mSwapSbfMsfPcf = ilRet
                Exit Function
            End If
            ilRet = btrDelete(hlSbf)
            If igDoEvent Then
                DoEvents
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If ilRet <> BTRV_ERR_NONE Then
            mSwapSbfMsfPcf = ilRet
            Exit Function
        End If
    Next ilLoop
    'Delete records from SBF
    For ilLoop = LBound(tmPSbf) To UBound(tmPSbf) - 1 Step 1
        Do
            tmSbfSrchKey1.lCode = tmPSbf(ilLoop).lCode
            ilRet = btrGetEqual(hlSbf, tmSbf, imSbfRecLen, tmSbfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                mSwapSbfMsfPcf = ilRet
                Exit Function
            End If
            ilRet = btrDelete(hlSbf)
            If igDoEvent Then
                DoEvents
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If ilRet <> BTRV_ERR_NONE Then
            mSwapSbfMsfPcf = ilRet
            Exit Function
        End If
    Next ilLoop
    'Restore the records
    For ilLoop = LBound(tmCSbf) To UBound(tmCSbf) - 1 Step 1
        tmCSbf(ilLoop).lChfCode = llToChfCode
        ilRet = btrInsert(hlSbf, tmCSbf(ilLoop), imSbfRecLen, INDEXKEY0)
        If ilRet <> BTRV_ERR_NONE Then
            mSwapSbfMsfPcf = ilRet
            Exit Function
        End If
        If igDoEvent Then
            DoEvents
        End If
    Next ilLoop
    For ilLoop = LBound(tmPSbf) To UBound(tmPSbf) - 1 Step 1
        tmPSbf(ilLoop).lChfCode = llFromChfCode
        ilRet = btrInsert(hlSbf, tmPSbf(ilLoop), imSbfRecLen, INDEXKEY0)
        If ilRet <> BTRV_ERR_NONE Then
            mSwapSbfMsfPcf = ilRet
            Exit Function
        End If
        If igDoEvent Then
            DoEvents
        End If
    Next ilLoop

    'Get MSF records to be moved
    ReDim tmCMsf(0 To 0) As MSF
    ilUpper = 0
    imMsfRecLen = Len(tmMsf)
    tmMsfSrchKey2.lChfCode = llFromChfCode
    ilRet = btrGetGreaterOrEqual(hlMsf, tmCMsf(ilUpper), imMsfRecLen, tmMsfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmCMsf(ilUpper).lChfCode = llFromChfCode)
        ilUpper = ilUpper + 1
        ReDim Preserve tmCMsf(0 To ilUpper) As MSF
        If igDoEvent Then
            DoEvents
        End If
        ilRet = btrGetNext(hlMsf, tmCMsf(ilUpper), imMsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    ReDim tmPMsf(0 To 0) As MSF
    ilUpper = 0
    tmMsfSrchKey2.lChfCode = llToChfCode
    ilRet = btrGetGreaterOrEqual(hlMsf, tmPMsf(ilUpper), imMsfRecLen, tmMsfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmPMsf(ilUpper).lChfCode = llToChfCode)
        ilUpper = ilUpper + 1
        ReDim Preserve tmPMsf(0 To ilUpper) As MSF
        If igDoEvent Then
            DoEvents
        End If
        ilRet = btrGetNext(hlMsf, tmPMsf(ilUpper), imMsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    'Delete records from Msf
    For ilLoop = LBound(tmCMsf) To UBound(tmCMsf) - 1 Step 1
        Do
            tmMsfSrchKey0.lCode = tmCMsf(ilLoop).lCode
            ilRet = btrGetEqual(hlMsf, tmMsf, imMsfRecLen, tmMsfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                mSwapSbfMsfPcf = ilRet
                Exit Function
            End If
            ilRet = btrDelete(hlMsf)
            If igDoEvent Then
                DoEvents
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If ilRet <> BTRV_ERR_NONE Then
            mSwapSbfMsfPcf = ilRet
            Exit Function
        End If
    Next ilLoop
    'Delete records from Msf
    For ilLoop = LBound(tmPMsf) To UBound(tmPMsf) - 1 Step 1
        Do
            tmMsfSrchKey0.lCode = tmPMsf(ilLoop).lCode
            ilRet = btrGetEqual(hlMsf, tmMsf, imMsfRecLen, tmMsfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                mSwapSbfMsfPcf = ilRet
                Exit Function
            End If
            ilRet = btrDelete(hlMsf)
            If igDoEvent Then
                DoEvents
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If ilRet <> BTRV_ERR_NONE Then
            mSwapSbfMsfPcf = ilRet
            Exit Function
        End If
    Next ilLoop
    'Restore the records
    For ilLoop = LBound(tmCMsf) To UBound(tmCMsf) - 1 Step 1
        tmCMsf(ilLoop).lChfCode = llToChfCode
        ilRet = btrInsert(hlMsf, tmCMsf(ilLoop), imMsfRecLen, INDEXKEY0)
        If ilRet <> BTRV_ERR_NONE Then
            mSwapSbfMsfPcf = ilRet
            Exit Function
        End If
        If igDoEvent Then
            DoEvents
        End If
    Next ilLoop
    For ilLoop = LBound(tmPMsf) To UBound(tmPMsf) - 1 Step 1
        tmPMsf(ilLoop).lChfCode = llFromChfCode
        ilRet = btrInsert(hlMsf, tmPMsf(ilLoop), imMsfRecLen, INDEXKEY0)
        If ilRet <> BTRV_ERR_NONE Then
            mSwapSbfMsfPcf = ilRet
            Exit Function
        End If
        If igDoEvent Then
            DoEvents
        End If
    Next ilLoop

    'Get PCF records to be moved
    ReDim tmCPcf(0 To 0) As PCF
    ilUpper = 0
    imPcfRecLen = Len(tmPcf)
    tmPcfSrchKey2.lChfCode = llFromChfCode
    tmPcfSrchKey2.iVefCode = 0
    ilRet = btrGetGreaterOrEqual(hlPcf, tmCPcf(ilUpper), imPcfRecLen, tmPcfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmCPcf(ilUpper).lChfCode = llFromChfCode)
        ilUpper = ilUpper + 1
        ReDim Preserve tmCPcf(0 To ilUpper) As PCF
        If igDoEvent Then
            DoEvents
        End If
        ilRet = btrGetNext(hlPcf, tmCPcf(ilUpper), imPcfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    ReDim tmPPcf(0 To 0) As PCF
    ilUpper = 0
    tmPcfSrchKey2.lChfCode = llToChfCode
    tmPcfSrchKey2.iVefCode = 0
    ilRet = btrGetGreaterOrEqual(hlPcf, tmPPcf(ilUpper), imPcfRecLen, tmPcfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmPPcf(ilUpper).lChfCode = llToChfCode)
        ilUpper = ilUpper + 1
        ReDim Preserve tmPPcf(0 To ilUpper) As PCF
        If igDoEvent Then
            DoEvents
        End If
        ilRet = btrGetNext(hlPcf, tmPPcf(ilUpper), imPcfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    'Delete records from Pcf
    For ilLoop = LBound(tmCPcf) To UBound(tmCPcf) - 1 Step 1
        Do
            tmPcfSrchKey0.lCode = tmCPcf(ilLoop).lCode
            ilRet = btrGetEqual(hlPcf, tmPcf, imPcfRecLen, tmPcfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                mSwapSbfMsfPcf = ilRet
                Exit Function
            End If
            ilRet = btrDelete(hlPcf)
            If igDoEvent Then
                DoEvents
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If ilRet <> BTRV_ERR_NONE Then
            mSwapSbfMsfPcf = ilRet
            Exit Function
        End If
    Next ilLoop
    'Delete records from Pcf
    For ilLoop = LBound(tmPPcf) To UBound(tmPPcf) - 1 Step 1
        Do
            tmPcfSrchKey0.lCode = tmPPcf(ilLoop).lCode
            ilRet = btrGetEqual(hlPcf, tmPcf, imPcfRecLen, tmPcfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                mSwapSbfMsfPcf = ilRet
                Exit Function
            End If
            ilRet = btrDelete(hlPcf)
            If igDoEvent Then
                DoEvents
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If ilRet <> BTRV_ERR_NONE Then
            mSwapSbfMsfPcf = ilRet
            Exit Function
        End If
    Next ilLoop
    'Restore the records
    For ilLoop = LBound(tmCPcf) To UBound(tmCPcf) - 1 Step 1
        tmCPcf(ilLoop).lChfCode = llToChfCode
        ilRet = btrInsert(hlPcf, tmCPcf(ilLoop), imPcfRecLen, INDEXKEY0)
        If ilRet <> BTRV_ERR_NONE Then
            mSwapSbfMsfPcf = ilRet
            Exit Function
        End If
        If igDoEvent Then
            DoEvents
        End If
    Next ilLoop
    For ilLoop = LBound(tmPPcf) To UBound(tmPPcf) - 1 Step 1
        tmPPcf(ilLoop).lChfCode = llFromChfCode
        ilRet = btrInsert(hlPcf, tmPPcf(ilLoop), imPcfRecLen, INDEXKEY0)
        If ilRet <> BTRV_ERR_NONE Then
            mSwapSbfMsfPcf = ilRet
            Exit Function
        End If
        If igDoEvent Then
            DoEvents
        End If
    Next ilLoop

    Erase tmCSbf
    Erase tmPSbf
    Erase tmCMsf
    Erase tmPMsf
    Erase tmCPcf
    Erase tmPPcf

    mSwapSbfMsfPcf = BTRV_ERR_NONE
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mMoveSortValues                 *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Move sorted values into working *
'*                     array                           *
'*                                                     *
'*******************************************************
Function mMoveSortValues(ilGet As Integer, ilValue As Integer, ilCounts() As Integer, ilFromIndex() As Integer, ilToIndex() As Integer) As Integer
'   ilRet = mMoveSortValues(ilGet, ilValue, ilCounts(), ilFromIndex(), ilToIndex())
'   Where:
'       ilGet(I)- 0=Get next value; 1= Get next set; 2= Get all Values
'       ilValue(I/O)- Previous value obtained (for ilGet = 0 this is last index obtained,
'                   ilGet = 1 this is last value obtained)
'       ilCounts(I)- Counts
'       ilFromIndex(I)- From indicies into ilCounts sorted order
'       ilToIndex(I)- Result indicies (ilFromIndex values moved accounting to ilGet)
'       ilRet(O)- True=Values obtained; False= No more values
'
    Dim ilLoop As Integer
    Dim ilFound As Integer
    Dim ilSmallestValue As Integer
    Dim ilCount As Integer
    mMoveSortValues = True
    If ilGet = 0 Then   'Move next value
        If ilValue + 1 > UBound(ilFromIndex) Then
            mMoveSortValues = False
            If ilValue = 0 Then
                Exit Function
            End If
            ilValue = 0
        End If
        'ReDim ilToIndex(1 To 1) As Integer
        'ilValue = ilValue + 1
        'ilToIndex(1) = ilFromIndex(ilValue)
        ReDim ilToIndex(0 To 0) As Integer
        ilValue = ilValue + 1
        ilToIndex(0) = ilFromIndex(ilValue)
        Exit Function
    ElseIf ilGet = 1 Then   'Move next set
        ilFound = False
        ilSmallestValue = 32000
        ilFound = False
        Do
            If igDoEvent Then
                DoEvents
            End If
            For ilLoop = LBound(ilFromIndex) To UBound(ilFromIndex) Step 1
                If igDoEvent Then
                    DoEvents
                End If
                If (ilCounts(ilFromIndex(ilLoop)) > ilValue) And (ilCounts(ilFromIndex(ilLoop)) < ilSmallestValue) Then
                    ilSmallestValue = ilCounts(ilFromIndex(ilLoop))
                    ilFound = True
                    'Dick- removed on 4/3/01, this would cause some hours/days/quarter hours to be bypassed
                    'looking for values above 2 and we have the following:
                    '  index ilCount
                    '    1     6
                    '    2     3
                    '    3     2
                    'then index 2 would be bypassed
                    'Exit For
                End If
            Next ilLoop
            If Not ilFound Then
                mMoveSortValues = False
                If ilValue = -1 Then
                    Exit Function
                End If
                ilValue = -1
            End If
        Loop While Not ilFound
        ilValue = ilSmallestValue
        'ilCount = 0
        ilCount = -1
        For ilLoop = LBound(ilFromIndex) To UBound(ilFromIndex) Step 1
            If igDoEvent Then
                DoEvents
            End If
            If ilCounts(ilFromIndex(ilLoop)) = ilValue Then
                ilCount = ilCount + 1
            End If
        Next ilLoop
        'ReDim ilToIndex(1 To ilCount) As Integer
        ReDim ilToIndex(0 To ilCount) As Integer
        If igDoEvent Then
            DoEvents
        End If
        'ilCount = 0
        ilCount = -1
        For ilLoop = LBound(ilFromIndex) To UBound(ilFromIndex) Step 1
            If igDoEvent Then
                DoEvents
            End If
            If ilCounts(ilFromIndex(ilLoop)) = ilValue Then
                ilCount = ilCount + 1
                ilToIndex(ilCount) = ilFromIndex(ilLoop)
            End If
        Next ilLoop
        Exit Function
    Else    'Move all values
        If igDoEvent Then
            DoEvents
        End If
        'ReDim ilToIndex(1 To UBound(ilFromIndex)) As Integer
        ReDim ilToIndex(0 To UBound(ilFromIndex)) As Integer
        If igDoEvent Then
            DoEvents
        End If
        'HMemCpy ilToIndex(1), ilFromIndex(1), Len(ilLoop) * UBound(ilFromIndex)
        HMemCpy ilToIndex(0), ilFromIndex(0), Len(ilLoop) * (UBound(ilFromIndex) + 1)
        If igDoEvent Then
            DoEvents
        End If
        mMoveSortValues = False
        Exit Function
    End If
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mMoveSpotOntoLegalDate          *
'*                                                     *
'*             Created:5/18/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Move a Missed Spot to legal date*
'*                                                     *
'*******************************************************
Function mMoveSpotOntoLegalDate(llSDFCode As Long, tlCff() As CFF) As Integer
'
'   Where:
'       llSdfRecPos(I)- Sdf Record Position
'       tlCff (I)- flights in date order
'
'
    Dim llDate As Long
    Dim slMissedDate As String
    Dim slDate As String
    Dim ilCff As Integer
    Dim llCffStartDate As Long
    Dim llCffEndDate As Long
    Dim ilRet As Integer
    Dim ilCRet As Integer
    '2/21/11: Replace GetDirect with GetEqual
    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, llSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
    tmSdfSrchKey3.lCode = llSDFCode
    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If igDoEvent Then
        DoEvents
    End If
    If ilRet <> BTRV_ERR_NONE Then
        mMoveSpotOntoLegalDate = ilRet
        Exit Function
    End If
    If (tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "O") Or (tmSdf.sSchStatus = "G") Then
        mMoveSpotOntoLegalDate = BTRV_ERR_NONE
        Exit Function
    End If
    gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
    llDate = gDateValue(slDate)
    ilCff = LBound(tlCff)
    Do While ilCff < UBound(tlCff)
        If igDoEvent Then
            DoEvents
        End If
        gUnpackDateLong tlCff(ilCff).iStartDate(0), tlCff(ilCff).iStartDate(1), llCffStartDate
        gUnpackDateLong tlCff(ilCff).iEndDate(0), tlCff(ilCff).iEndDate(1), llCffEndDate
        If (llDate >= llCffStartDate) And (llDate <= llCffEndDate) Then
            slMissedDate = mGetFirstLegalWkDate(hmLcf, "C", tmSdf.iVefCode, llDate, tlCff(ilCff))
            If igDoEvent Then
                DoEvents
            End If
            If gDateValue(slMissedDate) = llDate Then
                mMoveSpotOntoLegalDate = BTRV_ERR_NONE
                Exit Function
            End If
            Do
                If igDoEvent Then
                    DoEvents
                End If
                'tmSRec = tmSdf
                'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
                'tmSdf = tmSRec
                'If igDoEvent Then
                '    DoEvents
                'End If
                'If ilRet <> BTRV_ERR_NONE Then
                '    mMoveSpotOntoLegalDate = ilRet
                '    Exit Function
                'End If
                gPackDate slMissedDate, tmSdf.iDate(0), tmSdf.iDate(1)
                tmSdf.sXCrossMidnight = "N"
                'Leave setting as currently set, just adjusting date
                'tmSdf.sWasMG = "N"
                'tmSdf.sFromWorkArea = "N"
                ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
                If igDoEvent Then
                    DoEvents
                End If
                If ilRet = BTRV_ERR_CONFLICT Then
                    '2/21/11: Replace GetDirect with GetEqual
                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, llSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSdfSrchKey3.lCode = llSDFCode
                    ilCRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilCRet <> BTRV_ERR_NONE Then
                        mMoveSpotOntoLegalDate = ilCRet
                        Exit Function
                    End If
                    If (tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "O") Or (tmSdf.sSchStatus = "G") Then
                        mMoveSpotOntoLegalDate = BTRV_ERR_NONE
                        Exit Function
                    End If
                End If
            Loop While ilRet = BTRV_ERR_CONFLICT
            If igDoEvent Then
                DoEvents
            End If
            If ilRet <> BTRV_ERR_NONE Then
                mMoveSpotOntoLegalDate = ilRet
                Exit Function
            End If
            mMoveSpotOntoLegalDate = BTRV_ERR_NONE
            Exit Function
        End If
        ilCff = ilCff + 1
        If igDoEvent Then
            DoEvents
        End If
    Loop
    mMoveSpotOntoLegalDate = BTRV_ERR_NONE
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mNorPct                         *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Convert Time spot percents to   *
'*                     normalized values (divide by    *
'*                     smallest percent value)         *
'*                                                     *
'*******************************************************
Private Sub mNorPCT(tlRdf As RDF)
    Dim ilIndex As Integer
    Dim flSmallestPct As Single
    Dim ilAnyPct As Integer 'Any non-zero percents defined
    Dim slStr As String
    Dim ilCount As Integer
    Dim ilCount1 As Integer
    Dim ilAdjIndex As Integer
    
    imAnyZeroPct = False
    ilAdjIndex = 0
    If LBound(tlRdf.iStartTime, 2) = 1 Then
        ilAdjIndex = 1
    End If
    For ilIndex = LBound(tlRdf.iStartTime, 2) To UBound(tlRdf.iStartTime, 2) Step 1
        If igDoEvent Then
            DoEvents
        End If
        imRdfCnt(ilIndex - ilAdjIndex) = 0
        fmRdfPct(ilIndex - ilAdjIndex) = -1!
    Next ilIndex
    '8/14/06
    'The Normailize Count was used to obtain initial missed times so that when scheduling it would
    'first book into missed hour.  That feature was removed some time ago
    'The routine is not necessary any more
    Exit Sub
    If (tlRdf.iLtfCode(0) <> 0) Or (tlRdf.iLtfCode(1) <> 0) Or (tlRdf.iLtfCode(2) <> 0) Then
        'Library times used- not rate card times
        Exit Sub
    End If
    ilAnyPct = False
    flSmallestPct = 100000! 'large number
    For ilIndex = LBound(tlRdf.iStartTime, 2) To UBound(tlRdf.iStartTime, 2) Step 1
        If igDoEvent Then
            DoEvents
        End If
        imRdfCnt(ilIndex - ilAdjIndex) = 0
        fmRdfPct(ilIndex - ilAdjIndex) = -1!
        If (tlRdf.iStartTime(0, ilIndex) <> 1) Or (tlRdf.iStartTime(1, ilIndex) <> 0) Then
            'gPDNToStr tlRdf.sSpotPct(ilIndex), 2, slStr
            If tlRdf.iSpotPct(ilIndex) <= 0 Then
                imAnyZeroPct = True
            Else
                slStr = gIntToStrDec(tlRdf.iSpotPct(ilIndex), 2)
                fmRdfPct(ilIndex - ilAdjIndex) = Val(slStr)
                If fmRdfPct(ilIndex - ilAdjIndex) > 0! Then
                    ilAnyPct = True
                    If fmRdfPct(ilIndex - ilAdjIndex) < flSmallestPct Then
                        flSmallestPct = fmRdfPct(ilIndex - ilAdjIndex)
                    End If
                End If
            End If
        End If
    Next ilIndex
    If imAnyZeroPct Then
        ilCount = 0
        For ilIndex = LBound(tlRdf.iStartTime, 2) To UBound(tlRdf.iStartTime, 2) Step 1
            If igDoEvent Then
                DoEvents
            End If
            If (tlRdf.iStartTime(0, ilIndex) <> 1) Or (tlRdf.iStartTime(1, ilIndex) <> 0) Then
                ilCount = ilCount + 1
            End If
        Next ilIndex
        If ilCount > 1 Then
            ilCount1 = 0
            For ilIndex = LBound(tlRdf.iStartTime, 2) To UBound(tlRdf.iStartTime, 2) Step 1
                If igDoEvent Then
                    DoEvents
                End If
                If (tlRdf.iStartTime(0, ilIndex) <> 1) Or (tlRdf.iStartTime(1, ilIndex) <> 0) Then
                    fmRdfPct(ilIndex - ilAdjIndex) = ilCount1 * 32000! / ilCount + 1!
                    ilCount1 = ilCount1 + 1
                End If
            Next ilIndex
        Else
            'fmRdfPct(LBound(fmRdfPct)) = 1!
            'imAnyZeroPct = False
            For ilIndex = LBound(tlRdf.iStartTime, 2) To UBound(tlRdf.iStartTime, 2) Step 1
                If igDoEvent Then
                    DoEvents
                End If
                If (tlRdf.iStartTime(0, ilIndex) <> 1) Or (tlRdf.iStartTime(1, ilIndex) <> 0) Then
                    fmRdfPct(ilIndex - ilAdjIndex) = 1!
                    imAnyZeroPct = False
                    Exit For
                End If
            Next ilIndex
        End If
    Else
        If ilAnyPct Then
            For ilIndex = LBound(fmRdfPct) To UBound(fmRdfPct) Step 1
                If igDoEvent Then
                    DoEvents
                End If
                If fmRdfPct(ilIndex) > 0! Then
                    fmRdfPct(ilIndex) = fmRdfPct(ilIndex) / flSmallestPct
                End If
            Next ilIndex
        Else
            For ilIndex = LBound(fmRdfPct) To UBound(fmRdfPct) Step 1
                If igDoEvent Then
                    DoEvents
                End If
                If fmRdfPct(ilIndex) >= 0! Then
                    fmRdfPct(ilIndex) = 1!
                End If
            Next ilIndex
        End If
    End If
    For ilIndex = LBound(fmRdfPct) To UBound(fmRdfPct) Step 1
        If igDoEvent Then
            DoEvents
        End If
        fmRdfPctBase(ilIndex) = fmRdfPct(ilIndex)
    Next ilIndex
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mObtainFlights                  *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Obtain flight information       *
'*                                                     *
'*******************************************************
Private Sub mObtainFlights(tlClf As CLF, tlCff() As CFF, tlCgf() As CGF)
'
'   mObtainFlights tlClf, tlCff
'   Where:
'       tlClf(I)- Line record to obtain flights for
'       tlCff (O)- flights in date order
'
    Dim ilCffUpperBound As Integer
    Dim tlCffSrchKey As CFFKEY0
    Dim tlTempCff As CFF
    Dim ilRet As Integer
    Dim ilCgfUpper As Integer
    Dim ilVef As Integer
    ReDim tlCff(0 To 0) As CFF
    'ReDim tlCgf(1 To 1) As CGF
    ReDim tlCgf(0 To 0) As CGF
    ilCgfUpper = UBound(tlCgf)
    If igDoEvent Then
        DoEvents
    End If
    If tlClf.lChfCode <= 0 Then
        Exit Sub
    End If
    imCffRecLen = Len(tlCff(0)) 'btrRecordLength(hlChf)  'Get and save record length
    'ilCffUpperBound = 1
    ilCffUpperBound = LBound(tlCff)
    tlCffSrchKey.lChfCode = tlClf.lChfCode  'tlChf.lCode
    tlCffSrchKey.iClfLine = tlClf.iLine
    tlCffSrchKey.iCntRevNo = tlClf.iCntRevNo
    tlCffSrchKey.iPropVer = tlClf.iPropVer
    tlCffSrchKey.iStartDate(0) = 0
    tlCffSrchKey.iStartDate(1) = 0
    ilRet = btrGetGreaterOrEqual(hmCff, tlTempCff, imCffRecLen, tlCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tlTempCff.lChfCode = tlClf.lChfCode) And (tlTempCff.iClfLine = tlClf.iLine) And (tlTempCff.iCntRevNo = tlClf.iCntRevNo) And (tlTempCff.iPropVer = tlClf.iPropVer)
        If igDoEvent Then
            DoEvents
        End If
'        If (tlTempCff.sDelete <> "Y") Then
            tlCff(ilCffUpperBound) = tlTempCff
            ilCffUpperBound = ilCffUpperBound + 1
            'ReDim Preserve tlCff(1 To ilCffUpperBound) As CFF
            ReDim Preserve tlCff(0 To ilCffUpperBound) As CFF
'        End If
        If igDoEvent Then
            DoEvents
        End If
        ilRet = btrGetNext(hmCff, tlTempCff, imCffRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    ilVef = gBinarySearchVef(tlClf.iVefCode)
    If ilVef <> -1 Then
        If tgMVef(ilVef).sType = "G" Then
            'imCgfRecLen = Len(tlCgf(1))
            imCgfRecLen = Len(tlCgf(0))
            tmCgfSrchKey1.lClfCode = tlClf.lCode
            ilRet = btrGetEqual(hmCgf, tlCgf(ilCgfUpper), imCgfRecLen, tmCgfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            Do While (ilRet = BTRV_ERR_NONE) And (tlCgf(ilCgfUpper).lClfCode = tlClf.lCode)
                ilCgfUpper = ilCgfUpper + 1
                'ReDim Preserve tlCgf(1 To ilCgfUpper) As CGF
                ReDim Preserve tlCgf(0 To ilCgfUpper) As CGF
                ilRet = btrGetNext(hmCgf, tlCgf(ilCgfUpper), imCgfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
        End If
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mPreemptSpots                   *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Preempt spot from Ssf           *
'*                     Remove Extra Spots              *
'*                                                     *
'*******************************************************
Private Function mPreemptSpots(llChfCode As Long, ilLineNo As Integer, llFsfCode As Long, ilGameNo As Integer, llFromDate As Long, llToDate As Long, llLastAirDate As Long) As Integer
'
'   mPreemptSpots llChfCode, ilLineNo, llFromDate, llToDate
'   Where:
'       llChfCode(I)- Contract code number
'       ilLineNo(I)- Contract line number
'       llFsfCode(I)- Feed code
'       llFromDate(I)- Start date for the removal of spots
'       llToDate(I)- end date for the removal of spots
'       ilNoSpotsToRemove(I)- Number of spots to be removed
'
'       llEarliestAllowedDate(I)- Earliest allowed schedule date (removal date)
'
'
    Dim ilRet As Integer
    Dim slDate As String
    Dim ilDate0 As Integer
    Dim ilDate1 As Integer
    Dim llDate As Long
    Dim ilDayIndex As Integer
    Dim ilFound As Integer
    Dim llSdfRecPos As Long
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim ilPass As Integer
    Dim slPass As String
    Dim slActualDate As String
    Dim slTime As String
    Dim llSDFDate As Long
    Dim ilOrigSchVef As Integer
    Dim llEarliestAllowedDate As Long
    Dim ilVpfIndex As Integer
    Dim llNowDate As Long
    Dim tlSdf As SDF
    Dim llLockRecCode As Long
    Dim slUserName As String
    Dim llMoNowDate As Long
    Dim llMoLnEndDate As Long
    Dim slChgType As String

    imSmfRecLen = Len(tmSmf)
    llStartDate = llFromDate
    llEndDate = llToDate
    ilVpfIndex = gVpfFindIndex(imCVefCode)
    llEarliestAllowedDate = lmEarliestAllowedDate
    llNowDate = gDateValue(Format$(gNow(), "m/d/yy"))
    If ilVpfIndex <> -1 Then
        If tgVpf(ilVpfIndex).sMoveLLD = "Y" Then
            llDate = llNowDate + 1
            If llDate < llEarliestAllowedDate Then
                llEarliestAllowedDate = llDate
            End If
        End If
    End If
    '6/27/06:  Handle end date set within current week and spots exist.  If so, set to cancel not missed
    llMoNowDate = llNowDate
    Do While gWeekDayLong(llMoNowDate) <> 0
        llMoNowDate = llMoNowDate - 1
    Loop
    llMoLnEndDate = llLastAirDate
    Do While gWeekDayLong(llMoLnEndDate) <> 0
        llMoLnEndDate = llMoLnEndDate - 1
    Loop
    slChgType = "M"
    If (llMoNowDate = llMoLnEndDate) Then
        If ((Asc(tgSpf.sUsingFeatures4) And ALLOWMOVEONTODAY) = ALLOWMOVEONTODAY) Then
            If llLastAirDate < llNowDate Then
                slChgType = "C"
            End If
        Else
            If llLastAirDate <= llNowDate Then
                slChgType = "C"
            End If
        End If
    End If
    'Prempt scheduled spots
    For ilPass = 0 To 2 Step 1
        If igDoEvent Then
            DoEvents
        End If
        Select Case ilPass
            Case 0
                slPass = "O"    'Outside limits
            Case 1
                slPass = "G"    'MG
            Case 2
                slPass = "S"    'Scheduled
        End Select
        If (slPass = "O") Or (slPass = "G") Then
            For llDate = llEndDate To llStartDate Step -1
                If llDate < llEarliestAllowedDate Then
                    Exit For
                End If
                tmSmfSrchKey.lChfCode = llChfCode
                tmSmfSrchKey.iLineNo = ilLineNo
                tmSmfSrchKey.lFsfCode = llFsfCode
                slDate = Format$(llDate, "m/d/yy")
                gPackDate slDate, ilDate0, ilDate1
                tmSmfSrchKey.iMissedDate(0) = ilDate0
                tmSmfSrchKey.iMissedDate(1) = ilDate1
                ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = llChfCode) And (tmSmf.iLineNo = ilLineNo) And (tmSmf.lFsfCode = llFsfCode)
                    If igDoEvent Then
                        DoEvents
                    End If
                    ilFound = False
                    If (tmSmf.iMissedDate(0) <> ilDate0) Or (tmSmf.iMissedDate(1) <> ilDate1) Then
                        Exit Do
                    End If
                    gUnpackDate tmSmf.iActualDate(0), tmSmf.iActualDate(1), slActualDate
                    If (tmSmf.sSchStatus = slPass) And (gDateValue(slActualDate) >= llEarliestAllowedDate) And (tmSmf.iOrigSchVef = imCVefCode) Then
                        'Find associated spot
                        tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                        ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If igDoEvent Then
                            DoEvents
                        End If
                        'ilDayIndex = gWeekDayLong(llDate)
                        If (ilRet = BTRV_ERR_NONE) Then
                            If (tlSdf.sSpotType <> "O") And (tlSdf.sSpotType <> "C") And (tlSdf.iGameNo = ilGameNo) Then
                                gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSDFDate
                                If tlSdf.iGameNo <= 0 Then
                                    llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + llSDFDate, True, slUserName)
                                Else
                                    llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + tlSdf.iGameNo, True, slUserName)
                                End If
                                If llLockRecCode > 0 Then
                                    ilOrigSchVef = tmSmf.iOrigSchVef
                                    ilRet = btrGetPosition(hmSdf, llSdfRecPos)
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If ilRet <> BTRV_ERR_NONE Then
                                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                        mPreemptSpots = False
                                        Exit Function
                                    End If
                                    gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSDFDate
                                    ilDayIndex = gWeekDayLong(llSDFDate)
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If csiHandleValue(0, 15) > 0 Then
                                        ilRet = btrBeginTrans(hmCHF, 1000)
                                    Else
                                        ilRet = btrBeginTrans(hmCHF, -1000)
                                    End If
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If ilRet <> BTRV_ERR_NONE Then
                                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                        mPreemptSpots = False
                                        Exit Function
                                    End If
                                    If tlSdf.sSpotType <> "X" Then
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If gChgSchSpot(slChgType, hmSdf, tlSdf, hmSmf, ilGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf) Then
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            ilRet = btrEndTrans(hmCHF)
                                            If ilOrigSchVef <> imCVefCode Then
                                                gUnpackTime tlSdf.iTime(0), tlSdf.iTime(1), "A", "1", slTime
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                ilRet = gObtainSsfForDateOrGame(imCVefCode, llSDFDate, slTime, ilGameNo, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex))
                                                If igDoEvent Then
                                                    DoEvents
                                                End If
                                                If Not ilRet Then
                                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                                    mPreemptSpots = False
                                                    Exit Function
                                                End If
                                            End If
                                            ilFound = True
                                            If slChgType = "M" Then
                                                'lgUnschRecPos(UBound(lgUnschRecPos)) = llSdfRecPos
                                                'ReDim Preserve lgUnschRecPos(1 To UBound(lgUnschRecPos) + 1) As Long
                                                lgUnschSdfCode(UBound(lgUnschSdfCode)) = tlSdf.lCode
                                                'ReDim Preserve lgUnschSdfCode(1 To UBound(lgUnschSdfCode) + 1) As Long
                                                ReDim Preserve lgUnschSdfCode(LBound(lgUnschSdfCode) To UBound(lgUnschSdfCode) + 1) As Long
                                            End If
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                        Else
                                            ilRet = btrAbortTrans(hmCHF)
                                            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                            mPreemptSpots = False
                                            Exit Function
                                        End If
                                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    Else
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If gChgSchSpot("D", hmSdf, tlSdf, hmSmf, ilGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf) Then
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            ilRet = btrEndTrans(hmCHF)
                                            If ilOrigSchVef <> imCVefCode Then
                                                gUnpackTime tlSdf.iTime(0), tlSdf.iTime(1), "A", "1", slTime
                                                ilRet = gObtainSsfForDateOrGame(imCVefCode, llSDFDate, slTime, ilGameNo, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex))
                                                If Not ilRet Then
                                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                                    mPreemptSpots = False
                                                    Exit Function
                                                End If
                                            End If
                                            ilFound = True
                                        Else
                                            ilRet = btrAbortTrans(hmCHF)
                                            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                            mPreemptSpots = False
                                            Exit Function
                                        End If
                                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    End If
                                End If
                            End If
                        Else
                            mPreemptSpots = False
                            Exit Function
                        End If
                    End If
                    If ilFound Then
                        tmSmfSrchKey.lChfCode = llChfCode
                        tmSmfSrchKey.iLineNo = ilLineNo
                        tmSmfSrchKey.lFsfCode = llFsfCode
                        slDate = Format$(llDate, "m/d/yy")
                        gPackDate slDate, ilDate0, ilDate1
                        tmSmfSrchKey.iMissedDate(0) = ilDate0
                        tmSmfSrchKey.iMissedDate(1) = ilDate1
                        ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    Else
                        ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop
            Next llDate
        Else
            For llDate = llEndDate To llStartDate Step -1
                If igDoEvent Then
                    DoEvents
                End If
                If llDate < llEarliestAllowedDate Then
                    Exit For
                End If
                ilDayIndex = gWeekDayLong(llDate)
                tgSdfSrchKey.iVefCode = imCVefCode
                tgSdfSrchKey.lChfCode = llChfCode
                tgSdfSrchKey.iLineNo = ilLineNo
                tgSdfSrchKey.lFsfCode = llFsfCode
                slDate = Format$(llDate, "m/d/yy")
                gPackDate slDate, ilDate0, ilDate1
                tgSdfSrchKey.iDate(0) = ilDate0
                tgSdfSrchKey.iDate(1) = ilDate1
                tgSdfSrchKey.sSchStatus = slPass
                tgSdfSrchKey.iTime(0) = 0
                tgSdfSrchKey.iTime(1) = 0
                ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tlSdf.iVefCode = imCVefCode) And (tlSdf.lChfCode = llChfCode) And (tlSdf.iLineNo = ilLineNo) And (tlSdf.lFsfCode = llFsfCode)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If (tlSdf.iDate(0) <> ilDate0) Or (tlSdf.iDate(1) <> ilDate1) Then
                        Exit Do
                    End If
                    If tlSdf.sSchStatus <> slPass Then
                        Exit Do
                    End If
                    ilFound = False
                    If (tlSdf.sSpotType <> "O") And (tlSdf.sSpotType <> "C") And (tlSdf.iGameNo = ilGameNo) Then
                        gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSDFDate
                        If tlSdf.iGameNo <= 0 Then
                            llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + llSDFDate, True, slUserName)
                        Else
                            llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + tlSdf.iGameNo, True, slUserName)
                        End If
                        If llLockRecCode > 0 Then
                            ilRet = btrGetPosition(hmSdf, llSdfRecPos)
                            If ilRet <> BTRV_ERR_NONE Then
                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                mPreemptSpots = False
                                Exit Function
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            If csiHandleValue(0, 15) > 0 Then
                                ilRet = btrBeginTrans(hmCHF, 1000)
                            Else
                                ilRet = btrBeginTrans(hmCHF, -1000)
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilRet <> BTRV_ERR_NONE Then
                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                mPreemptSpots = False
                                Exit Function
                            End If
                            If tlSdf.sSpotType <> "X" Then
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If gChgSchSpot(slChgType, hmSdf, tlSdf, hmSmf, ilGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf) Then
                                    ilRet = btrEndTrans(hmCHF)
                                    ilFound = True
                                    If slChgType = "M" Then
                                        'lgUnschRecPos(UBound(lgUnschRecPos)) = llSdfRecPos
                                        'ReDim Preserve lgUnschRecPos(1 To UBound(lgUnschRecPos) + 1) As Long
                                        lgUnschSdfCode(UBound(lgUnschSdfCode)) = tlSdf.lCode
                                        'ReDim Preserve lgUnschSdfCode(1 To UBound(lgUnschSdfCode) + 1) As Long
                                        ReDim Preserve lgUnschSdfCode(LBound(lgUnschSdfCode) To UBound(lgUnschSdfCode) + 1) As Long
                                    End If
                                Else
                                    ilRet = btrAbortTrans(hmCHF)
                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    mPreemptSpots = False
                                    Exit Function
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                            Else
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If gChgSchSpot("D", hmSdf, tlSdf, hmSmf, ilGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf) Then
                                    ilRet = btrEndTrans(hmCHF)
                                    ilFound = True
                                Else
                                    ilRet = btrAbortTrans(hmCHF)
                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    mPreemptSpots = False
                                    Exit Function
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                            End If
                        End If
                    End If
                    If ilFound Then
                        tgSdfSrchKey.iVefCode = imCVefCode
                        tgSdfSrchKey.lChfCode = llChfCode
                        tgSdfSrchKey.iLineNo = ilLineNo
                        tgSdfSrchKey.lFsfCode = llFsfCode
                        slDate = Format$(llDate, "m/d/yy")
                        gPackDate slDate, ilDate0, ilDate1
                        tgSdfSrchKey.iDate(0) = ilDate0
                        tgSdfSrchKey.iDate(1) = ilDate1
                        tgSdfSrchKey.sSchStatus = "S"
                        tgSdfSrchKey.iTime(0) = 0
                        tgSdfSrchKey.iTime(1) = 0
                        ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    Else
                        ilRet = btrGetNext(hmSdf, tlSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop
            Next llDate
        End If
    Next ilPass
    mPreemptSpots = True
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mRemove Copy                    *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Remove spot assignments and     *
'*                     delete rotation if advertiser   *
'*                     changed                         *
'*                                                     *
'*******************************************************
Function mRemoveCopy() As Integer
    Dim ilRet As Integer
    Dim ilCRet As Integer
    Dim ilExtLen As Integer
    Dim llNoRec As Long
    Dim ilOffSet As Integer
    Dim llSmfRecPos As Long
    Dim llRecPos As Long
    Dim ilLoop As Integer
    Dim tlLTypeBuff As POPLCODE   'Type field record
    'Time zone Copy inventory record information
    Dim hlTzf As Integer        'Time zone Copy inventory file handle
    Dim tlTzfSrchKey As LONGKEY0 'TZF key record image
    Dim ilTzfRecLen As Integer  'TZF record length
    Dim tlTzf As TZF            'TZF record image
    Dim ilUpper As Integer
    ReDim lmClearSdfCode(0 To 0) As Long
    ilUpper = 0
    If (tmCChf.iHdChg And &H1) = 0 Then   'Advertiser not changed
        mRemoveCopy = BTRV_ERR_NONE
        Exit Function
    End If
    imCrfRecLen = Len(tmCrf) 'btrRecordLength(hmCrf)  'Get and save record length
    If igDoEvent Then
        DoEvents
    End If
    hlTzf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hlTzf, "", sgDBPath & "Tzf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mRemoveCopy = ilRet
        Exit Function
    End If
    If igDoEvent Then
        DoEvents
    End If
    ilTzfRecLen = Len(tlTzf) 'btrRecordLength(hmCrf)  'Get and save record length
    If tmPChf.lCode <> 0 Then
        tmCrfSrchKey1.sRotType = "A"
        tmCrfSrchKey1.iEtfCode = 0
        tmCrfSrchKey1.iEnfCode = 0
        tmCrfSrchKey1.iAdfCode = tmPChf.iAdfCode
        tmCrfSrchKey1.lChfCode = tmPChf.lCode
        tmCrfSrchKey1.lFsfCode = tmPFsf.lCode
        tmCrfSrchKey1.iVefCode = 0  'tmSdf.iVefCode
        tmCrfSrchKey1.iRotNo = 32000
        ilRet = btrGetGreaterOrEqual(hmCrf, tmCrf, imCrfRecLen, tmCrfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get last current record to obtain date
        Do While (ilRet = BTRV_ERR_NONE) And (tmCrf.sRotType = "A") And (tmCrf.iEtfCode = 0) And (tmCrf.iEnfCode = 0) And (tmCrf.iAdfCode = tmPChf.iAdfCode) And (tmCrf.lChfCode = tmPChf.lCode) And (tmCrf.lFsfCode = tmPFsf.lCode)
            If igDoEvent Then
                DoEvents
            End If
            ilRet = btrGetPosition(hmCrf, llRecPos)
            If (ilRet <> BTRV_ERR_NONE) Then
                mRemoveCopy = ilRet
                ilRet = btrClose(hlTzf)
                btrDestroy hlTzf
                Exit Function
            End If
            Do
                If igDoEvent Then
                    DoEvents
                End If
                'tmSRec = tmCrf
                'ilRet = gGetByKeyForUpdate("CRF", hmCrf, tmSRec)
                'tmCrf = tmSRec
                'If igDoEvent Then
                '    DoEvents
                'End If
                'If (ilRet <> BTRV_ERR_NONE) Then
                '    mRemoveCopy = ilRet
                '    ilRet = btrClose(hlTzf)
                '    btrDestroy hlTzf
                '    Exit Function
                'End If
                ilRet = btrDelete(hmCrf)
                If ilRet = BTRV_ERR_CONFLICT Then
                    If igDoEvent Then
                        DoEvents
                    End If
                    ilCRet = btrGetDirect(hmCrf, tmCrf, imCrfRecLen, llRecPos, INDEXKEY1, BTRV_LOCK_NONE)
                End If
                If igDoEvent Then
                    DoEvents
                End If
            Loop While ilRet = BTRV_ERR_CONFLICT
            If igDoEvent Then
                DoEvents
            End If
            If (ilRet <> BTRV_ERR_NONE) Then
                mRemoveCopy = ilRet
                ilRet = btrClose(hlTzf)
                btrDestroy hlTzf
                Exit Function
            End If
            'ilRet = btrGetNext(hmCrf, tmCrf, imCrfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            tmCrfSrchKey1.sRotType = "A"
            tmCrfSrchKey1.iEtfCode = 0
            tmCrfSrchKey1.iEnfCode = 0
            tmCrfSrchKey1.iAdfCode = tmPChf.iAdfCode
            tmCrfSrchKey1.lChfCode = tmPChf.lCode
            tmCrfSrchKey1.lFsfCode = tmPFsf.lCode
            tmCrfSrchKey1.iVefCode = 0  'tmSdf.iVefCode
            tmCrfSrchKey1.iRotNo = 32000
            ilRet = btrGetGreaterOrEqual(hmCrf, tmCrf, imCrfRecLen, tmCrfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get last current record to obtain date
            If igDoEvent Then
                DoEvents
            End If
        Loop
    End If
    ilExtLen = Len(tmSdf)   'Extract operation record size
    llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlSdf) 'Obtain number of records
    btrExtClear hmSdf   'Clear any previous extend operation
'    tmSdfSrchKey0.iVefCode = 1
'    tmSdfSrchKey0.lChfCode = tmCChf.lCode
'    tmSdfSrchKey0.iLineNo = 0
'    tmSdfSrchKey0.lFsfCode = tmCFsf.lCode
'    tmSdfSrchKey0.iDate(0) = 0
'    tmSdfSrchKey0.iDate(1) = 0
'    tmSdfSrchKey0.sSchStatus = " "
'    tmSdfSrchKey0.iTime(0) = 0
'    tmSdfSrchKey0.iTime(1) = 0
'    ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    If tmCChf.lCode > 0 Then
        tmSdfSrchKey5.lCode = tmCChf.lCode
        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey5, INDEXKEY5, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
    Else
        tmSdfSrchKey0.iVefCode = 1
        tmSdfSrchKey0.lChfCode = tmCChf.lCode
        tmSdfSrchKey0.iLineNo = 0
        tmSdfSrchKey0.lFsfCode = tmCFsf.lCode
        tmSdfSrchKey0.iDate(0) = 0
        tmSdfSrchKey0.iDate(1) = 0
        tmSdfSrchKey0.sSchStatus = " "
        tmSdfSrchKey0.iTime(0) = 0
        tmSdfSrchKey0.iTime(1) = 0
        ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    End If
    If igDoEvent Then
        DoEvents
    End If
    If (ilRet = BTRV_ERR_END_OF_FILE) Or (ilRet = BTRV_ERR_KEY_NOT_FOUND) Then
        mRemoveCopy = BTRV_ERR_NONE
        ilRet = btrClose(hlTzf)
        btrDestroy hlTzf
        Exit Function
    End If
    If ilRet <> BTRV_ERR_NONE Then
        mRemoveCopy = ilRet
        ilRet = btrClose(hlTzf)
        btrDestroy hlTzf
        Exit Function
    End If
    Call btrExtSetBounds(hmSdf, llNoRec, -1, "UC", "SDF", "") 'Set extract limits (all records)
    tlLTypeBuff.lCode = tmCChf.lCode
    ilOffSet = gFieldOffset("Sdf", "SdfChfCode")
    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_INT, ilOffSet, 4, BTRV_EXT_EQUAL, BTRV_EXT_LAST_TERM, tlLTypeBuff, 4)
    ilOffSet = 0
    ilRet = btrExtAddField(hmSdf, ilOffSet, Len(tmSdf))  'Extract iCode field
    If igDoEvent Then
        DoEvents
    End If
    If ilRet <> BTRV_ERR_NONE Then
        mRemoveCopy = ilRet
        ilRet = btrClose(hlTzf)
        btrDestroy hlTzf
        Exit Function
    End If
    ilRet = btrExtGetNext(hmSdf, tmSdf, ilExtLen, llRecPos)
    If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
        If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
            mRemoveCopy = ilRet
            ilRet = btrClose(hlTzf)
            btrDestroy hlTzf
            Exit Function
        End If
        If igDoEvent Then
            DoEvents
        End If
        ilExtLen = Len(tmSdf)   'Extract operation record size
        'ilRet = btrExtGetFirst(hlSdf, tlSdfExt(ilUpper), ilExtLen, llRecPos)
        Do While ilRet = BTRV_ERR_REJECT_COUNT
            ilRet = btrExtGetNext(hmSdf, tmSdf, ilExtLen, llRecPos)
        Loop
        Do While ilRet = BTRV_ERR_NONE
            If igDoEvent Then
                DoEvents
            End If
            'Test if copy assigned
            If (tmSdf.sPtType = "1") Or (tmSdf.sPtType = "2") Or (tmSdf.sPtType = "3") Then
                If tmCChf.iAdfCode <> tmSdf.iAdfCode Then
                    '2/21/11: Replace GetDirect with GetEqual
                    lmClearSdfCode(ilUpper) = tmSdf.lCode
                    ilUpper = ilUpper + 1
                    ReDim Preserve lmClearSdfCode(0 To ilUpper) As Long
                End If
            End If
            If igDoEvent Then
                DoEvents
            End If
            ilRet = btrExtGetNext(hmSdf, tmSdf, ilExtLen, llRecPos)
            Do While ilRet = BTRV_ERR_REJECT_COUNT
                ilRet = btrExtGetNext(hmSdf, tmSdf, ilExtLen, llRecPos)
            Loop
        Loop
    End If
    If igDoEvent Then
        DoEvents
    End If
    If csiHandleValue(0, 15) > 0 Then
        ilRet = btrBeginTrans(hmCHF, 1000)
    Else
        ilRet = btrBeginTrans(hmCHF, -1000)
    End If
    If igDoEvent Then
        DoEvents
    End If
    If (ilRet <> BTRV_ERR_NONE) Then
        mRemoveCopy = ilRet
        ilRet = btrAbortTrans(hmCHF)
        ilRet = btrClose(hlTzf)
        btrDestroy hlTzf
        Exit Function
    End If
    For ilLoop = 0 To UBound(lmClearSdfCode) - 1 Step 1
        If igDoEvent Then
            DoEvents
        End If
        '2/21/11: Replace GetDirect with GetEqual
        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, lmClearSdf(ilLoop), INDEXKEY0, BTRV_LOCK_NONE)
        tmSdfSrchKey3.lCode = lmClearSdfCode(ilLoop)
        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If (ilRet <> BTRV_ERR_NONE) Then
            mRemoveCopy = ilRet
            ilRet = btrAbortTrans(hmCHF)
            ilRet = btrClose(hlTzf)
            btrDestroy hlTzf
            Exit Function
        End If
        'Remove copy assignment
        If tmSdf.sPtType = "3" Then 'Time zone
            Do
                If igDoEvent Then
                    DoEvents
                End If
                tlTzfSrchKey.lCode = tmSdf.lCopyCode
                ilRet = btrGetEqual(hlTzf, tlTzf, ilTzfRecLen, tlTzfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                ilRet = btrDelete(hlTzf)
            Loop While ilRet = BTRV_ERR_CONFLICT
            If igDoEvent Then
                DoEvents
            End If
            If (ilRet <> BTRV_ERR_NONE) Then
                mRemoveCopy = ilRet
                ilRet = btrAbortTrans(hmCHF)
                ilRet = btrClose(hlTzf)
                btrDestroy hlTzf
                Exit Function
            End If
        End If
        If (tmSdf.sSchStatus = "O") Or (tmSdf.sSchStatus = "G") Then
            If igDoEvent Then
                DoEvents
            End If
            If gFindSmf(tmSdf, hmSmf, tmSmf) Then
                If igDoEvent Then
                    DoEvents
                End If
                ilRet = btrGetPosition(hmSmf, llSmfRecPos)
                If (ilRet <> BTRV_ERR_NONE) Then
                    mRemoveCopy = ilRet
                    ilRet = btrAbortTrans(hmCHF)
                    ilRet = btrClose(hlTzf)
                    btrDestroy hlTzf
                    Exit Function
                End If
                Do
                    If igDoEvent Then
                        DoEvents
                    End If
                    'tmSRec = tmSmf
                    'ilRet = gGetByKeyForUpdate("SMF", hmSmf, tmSRec)
                    'If igDoEvent Then
                    '    DoEvents
                    'End If
                    'tmSmf = tmSRec
                    'If (ilRet <> BTRV_ERR_NONE) Then
                    '    mRemoveCopy = ilRet
                    '    ilRet = btrAbortTrans(hmChf)
                    '    ilRet = btrClose(hlTzf)
                    '    btrDestroy hlTzf
                    '    Exit Function
                    'End If
                    tmSmf.sPtType = "0"
                    tmSmf.iRotNo = 0
                    tmSmf.lCopyCode = 0
                    ilRet = btrUpdate(hmSmf, tmSmf, imSmfRecLen)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet = BTRV_ERR_CONFLICT Then
                        ilCRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, llSmfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    End If
                Loop While ilRet = BTRV_ERR_CONFLICT
                If igDoEvent Then
                    DoEvents
                End If
                If (ilRet <> BTRV_ERR_NONE) Then
                    mRemoveCopy = ilRet
                    ilRet = btrAbortTrans(hmCHF)
                    ilRet = btrClose(hlTzf)
                    btrDestroy hlTzf
                    Exit Function
                End If
            End If
        End If
        Do
            If igDoEvent Then
                DoEvents
            End If
            'tmSRec = tmSdf
            'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
            'tmSdf = tmSRec
            'If igDoEvent Then
            '    DoEvents
            'End If
            'If (ilRet <> BTRV_ERR_NONE) Then
            '    mRemoveCopy = ilRet
            '    ilRet = btrAbortTrans(hmChf)
            '    ilRet = btrClose(hlTzf)
            '    btrDestroy hlTzf
            '    Exit Function
            'End If
            tmSdf.iRotNo = 0
            tmSdf.sPtType = "0"
            tmSdf.lCopyCode = 0
            'If (tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
            '    tmSdf.iMnfMissed = 0
            'End If
            ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
            If igDoEvent Then
                DoEvents
            End If
            If ilRet = BTRV_ERR_CONFLICT Then
                '2/21/11: Replace GetDirect with GetEqual
                'ilCRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, lmClearSdf(ilLoop), INDEXKEY0, BTRV_LOCK_NONE)
                tmSdfSrchKey3.lCode = lmClearSdfCode(ilLoop)
                ilCRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If igDoEvent Then
            DoEvents
        End If
        If (ilRet <> BTRV_ERR_NONE) Then
            mRemoveCopy = ilRet
            ilRet = btrAbortTrans(hmCHF)
            ilRet = btrClose(hlTzf)
            btrDestroy hlTzf
            Exit Function
        End If
    Next ilLoop
    If igDoEvent Then
        DoEvents
    End If
    ilRet = btrEndTrans(hmCHF)
    ilRet = btrClose(hlTzf)
    btrDestroy hlTzf
    If igDoEvent Then
        DoEvents
    End If
    mRemoveCopy = BTRV_ERR_NONE
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mRemoveResvSpots                *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Remove resevation spots from    *
'*                     ssf and set sdf status to hidden*
'*                     the record location so the spot *
'*                                                     *
'*******************************************************
Sub mRemoveResvSpots(tlCff As CFF, slWkDate As String, ilNoSpotsToCreate As Integer, ilGameNo As Integer)
    Dim slDate As String
    Dim llDate As Long
    Dim ilDay As Integer
    Dim ilEvt As Integer
    Dim ilRet As Integer
    Dim ilCRet As Integer
    Dim ilNoSpots As Integer
    Dim ilSpot As Integer
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim ilType As Integer
    Dim ilLogDate0 As Integer
    Dim ilLogDate1 As Integer
    Dim llSsfDate As Long
    Dim llSsfRecPos As Long
    '2/21/11: Replace GetDirect with GetEqual
    'Dim llSdfRecPos As Long
    Dim tlSdf As SDF
    Dim llLockRecCode As Long
    Dim slUserName As String
    Dim llSDFCode As Long

    If ilNoSpotsToCreate <= 0 Then
        Exit Sub
    End If
    If tmCChf.lCode <= 0 Then
        Exit Sub
    End If
    If (tmCChf.sResvNew <> "R") Or (tmCChf.lChfCode <= 0) Then
        Exit Sub
    End If
    If tlCff.sDyWk = "D" Then
        llStartDate = gDateValue(slWkDate)
        llEndDate = llStartDate
    Else
        For ilDay = 0 To 6 Step 1
            If (tlCff.iDay(ilDay) <> 0) Or ((tlCff.sXDay(ilDay) <> "0") And (tlCff.sXDay(ilDay) <> " ")) Then
                llStartDate = gDateValue(gObtainPrevMonday(slWkDate)) + ilDay
                Exit For
            End If
        Next ilDay
        For ilDay = 6 To 0 Step -1
            If (tlCff.iDay(ilDay) <> 0) Or ((tlCff.sXDay(ilDay) <> "0") And (tlCff.sXDay(ilDay) <> " ")) Then
                llEndDate = gDateValue(gObtainPrevMonday(slWkDate)) + ilDay
                Exit For
            End If
        Next ilDay
    End If
    ilNoSpots = ilNoSpotsToCreate
    ilType = ilGameNo
    'If contract references a reservation contract remove by setting the spots to Hidden
    For llDate = llStartDate To llEndDate Step 1
        If igDoEvent Then
            DoEvents
        End If
        'ilDay = gWeekDayLong(llDate)
        'ilRet = gObtainSsfForDateOrGame(imCVefCode, llDate, "12M", hmSsf, tmSsf, lgSsfDate(ilDay), lgSsfRecPos(ilDay))
        If ilType <= 0 Then
            llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * imCVefCode + llDate, True, slUserName)
        Else
            llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * imCVefCode + ilType, True, slUserName)
        End If
        If llLockRecCode > 0 Then
            slDate = Format$(llDate, "m/d/yy")
            imSsfRecLen = Len(tmSsf) 'Max size of variable length record
            gPackDate slDate, ilLogDate0, ilLogDate1
            tmSsfSrchKey.iType = ilType
            tmSsfSrchKey.iVefCode = imCVefCode
            tmSsfSrchKey.iDate(0) = ilLogDate0
            tmSsfSrchKey.iDate(1) = ilLogDate1
            tmSsfSrchKey.iStartTime(0) = 0
            tmSsfSrchKey.iStartTime(1) = 0
            ilRet = gSSFGetEqual(hmSsf, tmSsf, imSsfRecLen, tmSsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
            Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.iType = ilType) And (tmSsf.iVefCode = imCVefCode) And (tmSsf.iDate(0) = ilLogDate0) And (tmSsf.iDate(1) = ilLogDate1)
                If igDoEvent Then
                    DoEvents
                End If
                ilEvt = 1
                Do While ilEvt <= tmSsf.iCount
                    If igDoEvent Then
                        DoEvents
                    End If
                   LSet tmAvail = tmSsf.tPas(ADJSSFPASBZ + ilEvt)
                    If (tmAvail.iRecType >= 2) And (tmAvail.iRecType <= 9) Then 'Avail
                        For ilSpot = 1 To tmAvail.iNoSpotsThis Step 1
                            If igDoEvent Then
                                DoEvents
                            End If
                            ilEvt = ilEvt + 1
                           LSet tmSpot = tmSsf.tPas(ADJSSFPASBZ + ilEvt)
                            If igDoEvent Then
                                DoEvents
                            End If
                            If (tmSpot.iRank And RANKMASK) = RESERVATIONRANK Then
                                tmSdfSrchKey3.lCode = tmSpot.lSdfCode
                                ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilRet = BTRV_ERR_NONE Then
                                    If tmCChf.lChfCode = tlSdf.lChfCode Then
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If mResvTimesOk(tlSdf, True, ilGameNo) Then
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If csiHandleValue(0, 15) > 0 Then
                                                ilRet = btrBeginTrans(hmCHF, 1000)
                                            Else
                                                ilRet = btrBeginTrans(hmCHF, -1000)
                                            End If
                                            If ilRet <> BTRV_ERR_NONE Then
                                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                                Exit Sub
                                            End If
                                            llSsfDate = 0   'Force read
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            If gChgSchSpot("H", hmSdf, tlSdf, hmSmf, ilGameNo, tmSmf, hmSsf, tmSsf, llSsfDate, llSsfRecPos, hmSxf, hmGsf, hmGhf) Then
                                                ilRet = btrEndTrans(hmCHF)
                                                ilNoSpots = ilNoSpots - 1
                                                If ilNoSpots <= 0 Then
                                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                                    Exit Sub
                                                End If
                                                'ilRet = gObtainSsfForDateOrGame(imCVefCode, llDate, "12M", hmSsf, tmSsf, lgSsfDate(ilDay), lgSsfRecPos(ilDay))
                                                imSsfRecLen = Len(tmSsf)
                                                ilRet = gSSFGetDirect(hmSsf, tmSsf, imSsfRecLen, llSsfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                ilEvt = 0
                                                Exit For
                                            Else
                                                ilRet = btrAbortTrans(hmCHF)
                                            End If
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        Next ilSpot
                    End If
                    ilEvt = ilEvt + 1
                Loop
                imSsfRecLen = Len(tmSsf) 'Max size of variable length record
                If igDoEvent Then
                    DoEvents
                End If
                ilRet = gSSFGetNext(hmSsf, tmSsf, imSsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
        End If
    Next llDate
    If ilNoSpots <= 0 Then
        Exit Sub
    End If
    If igDoEvent Then
        DoEvents
    End If
    'Remove from missed Last
    tmChfSrchKey.lCode = tmCChf.lChfCode
    ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
    If ilRet = BTRV_ERR_NONE Then
        If igDoEvent Then
            DoEvents
        End If
        tmSdfSrchKey2.iVefCode = imCVefCode
        tmSdfSrchKey2.sSchStatus = "M"
        tmSdfSrchKey2.iAdfCode = tmChf.iAdfCode
        slDate = Format$(llStartDate, "m/d/yy")
        gPackDate slDate, tmSdfSrchKey2.iDate(0), tmSdfSrchKey2.iDate(1)
        tmSdfSrchKey2.iTime(0) = 0
        tmSdfSrchKey2.iTime(1) = 0
        ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get last current record to obtain date
        Do While (ilRet = BTRV_ERR_NONE) And (tlSdf.iVefCode = imCVefCode) And (tlSdf.sSchStatus = "M") And (tlSdf.iAdfCode = tmChf.iAdfCode)
            If igDoEvent Then
                DoEvents
            End If
            gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llDate
            If llDate > llEndDate Then
                Exit Do
            End If
            If (tlSdf.lChfCode = tmCChf.lChfCode) And (tlSdf.iGameNo = ilGameNo) Then
                If igDoEvent Then
                    DoEvents
                End If
                If mResvTimesOk(tlSdf, False, ilGameNo) Then
                    '2/21/11: Replace GetDirect with GetEqual
                    'ilRet = btrGetPosition(hmSdf, llSdfRecPos)
                    llSDFCode = tlSdf.lCode
                    Do
                        If igDoEvent Then
                            DoEvents
                        End If
                        'tmSRec = tlSdf
                        'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
                        'tlSdf = tmSRec
                        'If igDoEvent Then
                        '    DoEvents
                        'End If
                        If tlSdf.sSchStatus <> "M" Then
                            ilRet = BTRV_ERR_CONFLICT
                            Exit Do
                        End If
                        tlSdf.sSchStatus = "H"
                        ilRet = btrUpdate(hmSdf, tlSdf, imSdfRecLen)
                        If igDoEvent Then
                            DoEvents
                        End If
                        If ilRet = BTRV_ERR_CONFLICT Then
                            '2/21/11: Replace GetDirect with GetEqual
                            'ilCRet = btrGetDirect(hmSdf, tlSdf, imSdfRecLen, llSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                            tmSdfSrchKey3.lCode = llSDFCode
                            ilCRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                            If tlSdf.sSchStatus <> "M" Then
                                Exit Do
                            End If
                        End If
                    Loop While ilRet = BTRV_ERR_CONFLICT
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet = BTRV_ERR_NONE Then
                        ilNoSpots = ilNoSpots - 1
                        If ilNoSpots <= 0 Then
                            Exit Sub
                        End If
                    End If
                    tmSdfSrchKey2.iVefCode = imCVefCode
                    tmSdfSrchKey2.sSchStatus = "M"
                    tmSdfSrchKey2.iAdfCode = tmChf.iAdfCode
                    slDate = Format$(llStartDate, "m/d/yy")
                    gPackDate slDate, tmSdfSrchKey2.iDate(0), tmSdfSrchKey2.iDate(1)
                    tmSdfSrchKey2.iTime(0) = 0
                    tmSdfSrchKey2.iTime(1) = 0
                    ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get last current record to obtain date
                Else
                    ilRet = btrGetNext(hmSdf, tlSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                End If
            Else
                ilRet = btrGetNext(hmSdf, tlSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            End If
            If igDoEvent Then
                DoEvents
            End If
        Loop
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mResvTimesOk                    *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Get Legal times                 *
'*                                                     *
'*******************************************************
Private Function mResvTimesOk(tlSdf As SDF, ilSsfIn As Integer, ilGameNo As Integer) As Integer
    Dim ilRet As Integer
    Dim slDate As String
    Dim llDate As Long
    Dim ilTimeIndex As Integer
    Dim slTime As String
    Dim ilLoop As Integer
    Dim ilTest As Integer
    Dim llStartTime As Long
    Dim llEndTime As Long
    Dim ilPass As Integer
    Dim ilCount As Integer
    Dim ilVpfIndex As Integer
    Dim ilType As Integer
    Dim slGMedium As String
    Dim tlClf As CLF
    Dim tlRdf As RDF
    Dim tlLnRdf As RDF
    Dim tlClfSrchKey As CLFKEY0
    Dim tlRdfSrchKey As INTKEY0


    mResvTimesOk = False
    For ilLoop = LBound(lmCResvStartTime) To UBound(lmCResvStartTime) Step 1
        lmCResvStartTime(ilLoop) = -1
        lmCResvEndTime(ilLoop) = -1
    Next ilLoop
    If tlSdf.lChfCode <= 0 Then
        mResvTimesOk = False
        Exit Function
    End If
    'ilCount = 0
    ilCount = -1
    gUnpackDate tlSdf.iDate(0), tlSdf.iDate(1), slDate
    tlClfSrchKey.lChfCode = tlSdf.lChfCode
    tlClfSrchKey.iLine = tlSdf.iLineNo
    tlClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
    tlClfSrchKey.iPropVer = 32000 ' Plug with very high number
    ilRet = btrGetGreaterOrEqual(hmClf, tlClf, imClfRecLen, tlClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)
    Do While (ilRet = BTRV_ERR_NONE) And (tlClf.lChfCode = tlSdf.lChfCode) And (tlClf.iLine = tlSdf.iLineNo) And (tlClf.sSchStatus <> "F") And (tlClf.sSchStatus <> "M")
        If igDoEvent Then
            DoEvents
        End If
        ilRet = btrGetNext(hmClf, tlClf, imClfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    If (ilRet = BTRV_ERR_NONE) And (tlClf.lChfCode = tlSdf.lChfCode) And (tlClf.iLine = tlSdf.iLineNo) Then
        If igDoEvent Then
            DoEvents
        End If
        If tmCClf.iRdfCode = tlClf.iRdfCode Then
            mResvTimesOk = True
            Exit Function
        End If
        ilVpfIndex = gVpfFindIndex(imCVpfIndex)
        If ilVpfIndex >= 0 Then
            slGMedium = tgVpf(ilVpfIndex).sGMedium
        Else
            slGMedium = ""
        End If
        ilType = ilGameNo
        llDate = gDateValue(slDate)
        For ilPass = 0 To 1 Step 1
            If igDoEvent Then
                DoEvents
            End If
            If ilPass = 0 Then
                tlRdfSrchKey.iCode = tmCClf.iRdfCode
            Else
                tlRdfSrchKey.iCode = tlClf.iRdfCode  ' Daypart File Code
            End If
            ilRet = btrGetEqual(hmRdf, tlLnRdf, imRdfRecLen, tlRdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
            If igDoEvent Then
                DoEvents
            End If
            If ilRet = BTRV_ERR_NONE Then
                gXMidRdfToRdf "", tlLnRdf, tlRdf
                llDate = gDateValue(slDate)
                llStartTime = 0 'Set to Midnight
                llEndTime = 86400
                If (tlRdf.iLtfCode(0) <> 0) Or (tlRdf.iLtfCode(1) <> 0) Or (tlRdf.iLtfCode(2) <> 0) Then
                    'Read Ssf for date- test for library
                    If Not ilSsfIn Then
                        imSsfRecLen = Len(tmSsf) 'Max size of variable length record
                        tgSsfSrchKey.iType = ilType 'slType
                        tgSsfSrchKey.iVefCode = imCVefCode
                        tgSsfSrchKey.iDate(0) = tmSdf.iDate(0)
                        tgSsfSrchKey.iDate(1) = tmSdf.iDate(1)
                        tgSsfSrchKey.iStartTime(0) = 0
                        tgSsfSrchKey.iStartTime(1) = 0
                        ilRet = gSSFGetGreaterOrEqual(hmSsf, tmSsf, imSsfRecLen, tgSsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get last current record to obtain date
                    Else
                        ilRet = BTRV_ERR_NONE
                    End If
                    Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.iType = ilType) And (tmSsf.iVefCode = imCVefCode) And (tmSsf.iDate(0) = tmSdf.iDate(0)) And (tmSsf.iDate(1) = tmSdf.iDate(1))
                        If igDoEvent Then
                            DoEvents
                        End If
                        For ilLoop = 1 To tmSsf.iCount Step 1
                            If igDoEvent Then
                                DoEvents
                            End If
                           LSet tmProg = tmSsf.tPas(ADJSSFPASBZ + ilLoop)
                            If tmProg.iRecType = 1 Then 'Program subrecord
                                If (tmProg.iLtfCode = tlRdf.iLtfCode(0)) Or (tmProg.iLtfCode = tlRdf.iLtfCode(1)) Or (tmProg.iLtfCode = tlRdf.iLtfCode(2)) Then
                                    gUnpackTime tmProg.iStartTime(0), tmProg.iStartTime(1), "A", "1", slTime
                                    llStartTime = CLng(gTimeToCurrency(slTime, False))
                                    gUnpackTime tmProg.iEndTime(0), tmProg.iEndTime(1), "A", "1", slTime
                                    llEndTime = CLng(gTimeToCurrency(slTime, True))
                                    If ilPass = 0 Then
                                        ilCount = ilCount + 1
                                        lmCResvStartTime(ilCount) = llStartTime
                                        lmCResvEndTime(ilCount) = llEndTime
                                    Else
                                        For ilTest = LBound(lmCResvStartTime) To UBound(lmCResvStartTime) Step 1
                                            If lmCTBStartTime(ilTest) <> -1 Then
                                                If (llStartTime <= lmCResvStartTime(ilTest)) And (llEndTime >= lmCResvEndTime(ilTest)) Then
                                                    mResvTimesOk = True
                                                    Exit Function
                                                End If
                                            End If
                                        Next ilTest
                                    End If
                                End If
                            End If
                        Next ilLoop
                        'If (tmSsf.iNextTime(0) = 1) And (tmSsf.iNextTime(1) = 0) Then
                            Exit Do
                        'Else
                        '    If Not ilSsfIn Then
                        '        imSsfRecLen = Len(tmSsf) 'Max size of variable length record
                        '        ilRet = gSSFGetNext(hmSsf, tmSsf, imSsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                        '    Else
                        '        Exit Do
                        '    End If
                        'End If
                        If igDoEvent Then
                            DoEvents
                        End If
                    Loop
                    If igDoEvent Then
                        DoEvents
                    End If
                Else    'Time buy- check if override times defined (if so, use them as bump times)
                    If ((tmCClf.iStartTime(0) = 1) And (tmCClf.iStartTime(1) = 0)) Or (slGMedium = "S") Then
                        For ilTimeIndex = UBound(tmCRdf.iStartTime, 2) To LBound(tmCRdf.iStartTime, 2) Step -1
                            If (tmCRdf.iStartTime(0, ilTimeIndex) <> 1) Or (tmCRdf.iStartTime(1, ilTimeIndex) <> 0) Then
                                gUnpackTime tmCRdf.iStartTime(0, ilTimeIndex), tmCRdf.iStartTime(1, ilTimeIndex), "A", "1", slTime
                                llStartTime = CLng(gTimeToCurrency(slTime, False))
                                gUnpackTime tmCRdf.iEndTime(0, ilTimeIndex), tmCRdf.iEndTime(1, ilTimeIndex), "A", "1", slTime
                                llEndTime = CLng(gTimeToCurrency(slTime, True))
                                If ilPass = 0 Then
                                    ilCount = ilCount + 1
                                    lmCResvStartTime(ilCount) = llStartTime
                                    lmCResvEndTime(ilCount) = llEndTime
                                Else
                                    For ilTest = LBound(lmCResvStartTime) To UBound(lmCResvStartTime) Step 1
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If lmCTBStartTime(ilTest) <> -1 Then
                                            If (llStartTime <= lmCResvStartTime(ilTest)) And (llEndTime >= lmCResvEndTime(ilTest)) Then
                                                mResvTimesOk = True
                                                Exit Function
                                            End If
                                        End If
                                    Next ilTest
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                End If
                            End If
                        Next ilTimeIndex
                    Else
                        gUnpackTime tmCClf.iStartTime(0), tmCClf.iStartTime(1), "A", "1", slTime
                        llStartTime = CLng(gTimeToCurrency(slTime, False))
                        gUnpackTime tmCClf.iEndTime(0), tmCClf.iEndTime(1), "A", "1", slTime
                        llEndTime = CLng(gTimeToCurrency(slTime, True))
                        If llStartTime = llEndTime Then
                            llEndTime = llStartTime + 1
                        End If
                        If ilPass = 0 Then
                            ilCount = ilCount + 1
                            lmCResvStartTime(ilCount) = llStartTime
                            lmCResvEndTime(ilCount) = llEndTime
                        Else
                            For ilTest = LBound(lmCResvStartTime) To UBound(lmCResvStartTime) Step 1
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If lmCTBStartTime(ilTest) <> -1 Then
                                    If (llStartTime <= lmCResvStartTime(ilTest)) And (llEndTime >= lmCResvEndTime(ilTest)) Then
                                        mResvTimesOk = True
                                        Exit Function
                                    End If
                                End If
                            Next ilTest
                            If igDoEvent Then
                                DoEvents
                            End If
                        End If
                    End If
                End If
            End If
        Next ilPass
    End If
    mResvTimesOk = False
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mSchPasses                      *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Loop thru passes for scheduling *
'*                     a spot                          *
'*                                                     *
'*******************************************************
Function mSchPasses(slSchStatus As String, slWkDate As String, tlChf As CHF, tlClf As CLF, tlRdf As RDF, ilGameNo As Integer, llSepLength As Long, llTBStartTimes() As Long, llTBEndTimes() As Long, ilAHour() As Integer, ilADay() As Integer, ilAQH() As Integer, ilPriceLevel As Integer, ilCallType As Integer, slCallTypeDays As String, llCallTypeStartTime As Long, llCallTypeEndTime As Long) As Integer
'
'   ilSch = mSchPasses(slSchStatus, slWkDate, tlChf, tlClf, tlRdf, ilGameNo, llSepLength, llStartTimes(), llEndTimes(), ilAHour(), ilADay(), ilAQH())
'   Where:
'       slSchStatus(I)- "S" standard; "G" makegood; "O" outside limits
'       slWkDate(I)- Week date
'       tlChf(I)- Contract header
'       tlClf(I)- Line being scheduled
'       tlRdf(I)- Rate card program/time of line being scheduled
'       ilGameNo(I)- Game number
'       llSpeLength(I)- Advertiser separation time (in seconds)
'       ilAHour(I)- Count for the hours (invalid hours set to -1)
'       ilADay(I)- Count for the days (invalid days set to -1)
'       ilAQH(I)- Count for quarter hours
'       ilSch(O)- True=Spot scheduled; False=Spot not scheduled
'
    Dim ilSchMode As Integer    '0=Insert mode; 1=Move mode; 2= Competitive compact; 3=Preempt
    Dim slDate As String        'Date as a string
    Dim ilMajorValue As Integer
    Dim ilMiddleValue As Integer
    Dim ilMinorValue As Integer
    Dim ilMajorGet As Integer   '0=Next value; 1=next matching set of values
    Dim ilMiddleGet As Integer  '0=Next value; 1 and greater=next matching set of values
    Dim ilMinorGet As Integer   '0=Next value; 1 and greater=next matching set of values, 2=Get all values
    Dim ilRetMajor As Integer
    Dim ilRetMiddle As Integer
    Dim ilRetMinor As Integer
    Dim ilLoopMajor As Integer
    Dim ilLoopMiddle As Integer
    Dim ilLoopMinor As Integer
    Dim ilCycleTest As Integer      '0=A test; 1=B test; 2=C Test; 3=D Test; 4=E Test
    Dim ilACycle As Integer 'Each iternation
    Dim ilBCycle As Integer 'Each time minor sort changes value
    Dim ilCCycle As Integer 'Each time minor sort cycles thru all values
    Dim ilDCycle As Integer 'Each time middle sort cycles thru all values
    Dim ilECycle As Integer 'Each time major sort cycles thru all values
    Dim ilRet As Integer
    Dim ilAvailIndex As Integer
    'Dim ilDayIndex As Integer
    Dim slTime As String
    Dim ilTime0 As Integer      'Pack date
    Dim ilTime1 As Integer      'Pack date
    Dim llLockRecCode As Long
    Dim slUserName As String
    Dim ilSPass As Integer
    Dim ilEPass As Integer
    Dim ilPass As Integer
    Dim ilLoop As Integer
    Dim iltmPreferredInfoIndex As Integer
    Dim llDate As Long
    Dim ilVff As Integer
    Dim ilSaf As Integer

    'Sort and randomized based on sgSortRnd---- all unused values removed, if sorted, the values will be in ascending order
    'Sort; Randomize- N=No sorting; No randomizing
    '                 R=No sorting; randomize all counts
    '                 S=Sorting counts lowest to highest; No randomizing of matched counts
    '                 B=Sorting counts lowest to highest; Randomize matching counts
    'ilSHour, ilSDay and ilSQH contain the indicies into ilHour, ilDay, ilQH respectively
    If igDoEvent Then
        DoEvents
    End If
    If PeekArray(tgVff).Ptr = 0 Then
        ilRet = gVffRead()
    End If
    '7/14/15: Import Invoice spots should only be scheduled into missed
    For ilVff = LBound(tgVff) To UBound(tgVff) Step 1
        If tgVff(ilVff).iVefCode = tlClf.iVefCode Then
            If tgVff(ilVff).sPostLogSource = "S" Then
                ilCycleTest = 0
                mSchPasses = False
                Exit Function
            End If
            Exit For
        End If
    Next ilVff
    If mGetGameStatus(tmSdf) = "C" Then
        ilCycleTest = 0
        mSchPasses = False
        Exit Function
    End If
    If igDoEvent Then
        DoEvents
    End If
    mSortArray sgSortRndHour, ilAHour(), imSHour()
    If igDoEvent Then
        DoEvents
    End If
    'If imSHour(1) = -1 Then 'No hours to book into
    If imSHour(0) = -1 Then 'No hours to book into
        ilCycleTest = 0
        mSchPasses = False
        Exit Function
    End If
    If igDoEvent Then
        DoEvents
    End If
    mSortArray sgSortRndDay, ilADay(), imSDay()
    If igDoEvent Then
        DoEvents
    End If
    'If imSDay(1) = -1 Then  'No days to book into
    If imSDay(0) = -1 Then  'No days to book into
        ilCycleTest = 0
        mSchPasses = False
        Exit Function
    End If
    If igDoEvent Then
        DoEvents
    End If
    mSortArray sgSortRndQH, ilAQH(), imSQH()
    If igDoEvent Then
        DoEvents
    End If
    'If imSQH(1) = -1 Then   'No Quarter hours to book into
    If imSQH(0) = -1 Then   'No Quarter hours to book into
        ilCycleTest = 0
        mSchPasses = False
        Exit Function
    End If
      
    sgVehPreemptRule = "N"
    If sgApplyVehPreemptRule = "Y" Then 'Only Y when scheduling Orders
        ilSaf = gBinarySearchSaf(tlClf.iVefCode)
        If ilSaf <> -1 Then
            If (Asc(tgSaf(ilSaf).sFeatures1) And SUPPRESSPREEMPTION) = SUPPRESSPREEMPTION Then
                sgVehPreemptRule = "Y"  'Checked in gPreemptible
            End If
        End If
    End If
    'Set cycle parameters for major, middle and minor
    If igCyclePattern = 1 Then
        ilMajorGet = 1
        ilMajorValue = -1
        ilMiddleGet = 1
        ilMiddleValue = -1
        ilMinorGet = 1
        ilMinorValue = -1
    Else
        ilMajorGet = 0
        ilMajorValue = 0
        ilMiddleGet = 0
        ilMiddleValue = 0
        ilMinorGet = 1  'Set to 1 instead of 3 to handle "B" cycle test
        ilMinorValue = -1
    End If
    If sgMajor = "H" Then   'Hour
        ilRetMajor = mMoveSortValues(ilMajorGet, ilMajorValue, ilAHour(), imSHour(), imMajor())
    ElseIf sgMajor = "D" Then   'Day
        ilRetMajor = mMoveSortValues(ilMajorGet, ilMajorValue, ilADay(), imSDay(), imMajor())
    Else    'Quarter hour
        ilRetMajor = mMoveSortValues(ilMajorGet, ilMajorValue, ilAQH(), imSQH(), imMajor())
    End If
    If igDoEvent Then
        DoEvents
    End If
    If sgMiddle = "H" Then  'Hour
        ilRetMiddle = mMoveSortValues(ilMiddleGet, ilMiddleValue, ilAHour(), imSHour(), imMiddle())
    ElseIf sgMiddle = "D" Then   'Day
        ilRetMiddle = mMoveSortValues(ilMiddleGet, ilMiddleValue, ilADay(), imSDay(), imMiddle())
    Else    'Quarter hour
        ilRetMiddle = mMoveSortValues(ilMiddleGet, ilMiddleValue, ilAQH(), imSQH(), imMiddle())
    End If
    If igDoEvent Then
        DoEvents
    End If
    If sgMinor = "H" Then   'Hour
        ilRetMinor = mMoveSortValues(ilMinorGet, ilMinorValue, ilAHour(), imSHour(), imMinor())
    ElseIf sgMinor = "D" Then   'Day
        ilRetMinor = mMoveSortValues(ilMinorGet, ilMinorValue, ilADay(), imSDay(), imMinor())
    Else    'Quarter hour
        ilRetMinor = mMoveSortValues(ilMinorGet, ilMinorValue, ilAQH(), imSQH(), imMinor())
    End If
    If igDoEvent Then
        DoEvents
    End If
    ilSPass = 2
    ilEPass = 2
    iltmPreferredInfoIndex = -1
    If UBound(tmPreferredInfo) > 1 Then
        llDate = gDateValue(slWkDate)
        For ilLoop = LBound(tmPreferredInfo) To UBound(tmPreferredInfo) - 1 Step 1
            If (llDate >= tmPreferredInfo(ilLoop).lSDate) And (llDate <= tmPreferredInfo(ilLoop).lEDate) Then
                If tmPreferredInfo(ilLoop).iNoPrefSpots > 0 Then
                    ilSPass = 1
                    iltmPreferredInfoIndex = ilLoop
                End If
                Exit For
            End If
        Next ilLoop
    End If
    For ilPass = ilSPass To ilEPass Step 1
        ilSchMode = 0   'Insert mode
        ilCycleTest = 0 'A cycle test (each iteration)
        'ilECycle = -1
        ilECycle = -2
        slDate = gObtainPrevMonday(slWkDate)
        lmMondayDate = gDateValue(slDate)
        Do  'E cycle count (Major loop)
            Do  'Major loop
                'ilDCycle = -1
                ilDCycle = -2
                Do  'D cycle count (Middle loop)
                    Do  'Middle loop
                        'ilCCycle = -1
                        ilCCycle = -2
                        Do  'C cycle count (Minor loop)
                            Do 'Minor
                                'ilBCycle = -1    'Count change within minor
                                ilBCycle = -2    'Count change within minor
                                Do  'B level count
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    Select Case ilCycleTest
                                        Case 1  'B cycle test
                                            ilSchMode = imBMode(ilBCycle + 1)
                                        Case 2  'C cycle test (minor loop)
                                            ilSchMode = imCMode(ilCCycle + 1)
                                        Case 3  'D cycle test (middle loop)
                                            ilSchMode = imDMode(ilDCycle + 1)
                                        Case 4  'E cycle test (major loop)
                                            ilSchMode = imEMode(ilECycle + 1)
                                    End Select
                                    'Pattern 1: Major will loop the number of times that the same count exist
                                    'Pattern 2: Major will loop only once (1 time)
                                    For ilLoopMajor = LBound(imMajor) To UBound(imMajor) Step 1
                                        'Pattern 1: Middle will loop the number of times that the same count exist
                                        'Pattern 2: Middle will loop only once (1 time)
                                        For ilLoopMiddle = LBound(imMiddle) To UBound(imMiddle) Step 1
                                            'Pattern 1: Minor will loop the number of times that the same count exist
                                            'Pattern 2: Minor will loop thru all values
                                            For ilLoopMinor = LBound(imMinor) To UBound(imMinor) Step 1
                                                'ilACycle = 1
                                                ilACycle = 0
                                                Do
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    If ilCycleTest = 0 Then
                                                        ilSchMode = imAMode(ilACycle)
                                                    ElseIf ilCycleTest = 1 Then
                                                        ilACycle = imACount
                                                    Else
                                                        ilACycle = imACount 'to avoid A test when doing B thru E
                                                        ilBCycle = imBCount
                                                    End If
                                                    mSetHDQIndex ilLoopMajor, ilLoopMiddle, ilLoopMinor
                                                    If igDoEvent Then
                                                        DoEvents
                                                    End If
                                                    If lmMondayDate + imDayIndex < lmEarliestAllowedDate Then
                                                        imSkip(imHourIndex, imQHIndex, imDayIndex) = -1
                                                    End If
                                                    If ilCallType = 1 Then
                                                        If Mid(slCallTypeDays, imDayIndex + 1, 1) = "N" Then
                                                            imSkip(imHourIndex, imQHIndex, imDayIndex) = -1
                                                        End If
                                                    End If
                                                    If imSkip(imHourIndex, imQHIndex, imDayIndex) = -1 Then
                                                        ilACycle = imACount
                                                    Else
                                                        ilTime0 = 0
                                                        'ilTime1 = (imHourIndex - 1) * 256
                                                        ilTime1 = (imHourIndex) * 256
                                                        gUnpackTime ilTime0, ilTime1, "A", "1", slTime
                                                        If igDoEvent Then
                                                            DoEvents
                                                        End If
                                                        If ilGameNo <= 0 Then
                                                            llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * imCVefCode + lmMondayDate + imDayIndex, True, slUserName)
                                                        Else
                                                            llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * imCVefCode + ilGameNo, True, slUserName)
                                                        End If
                                                        If llLockRecCode > 0 Then
                                                            If gObtainSsfForDateOrGame(imCVefCode, lmMondayDate + imDayIndex, slTime, ilGameNo, hmSsf, tgSsf(imDayIndex), lgSsfDate(imDayIndex), lgSsfRecPos(imDayIndex)) Then
                                                                If igDoEvent Then
                                                                    DoEvents
                                                                End If
                                                                'Point where to schedule spot
                                                                mGetAvails ilSchMode, tlClf, tlRdf, llTBStartTimes(), llTBEndTimes(), tlChf.iMnfExcl(0), tlChf.iMnfExcl(1), tlChf.sType, iltmPreferredInfoIndex, ilCallType, slCallTypeDays, llCallTypeStartTime, llCallTypeEndTime
                                                                If igDoEvent Then
                                                                    DoEvents
                                                                End If
                                                                'If imAvailSubRec(1) <> -1 Then  'Test if any avails found
                                                                If imAvailSubRec(LBound(imAvailSubRec)) <> -1 Then  'Test if any avails found
                                                                    If mBookIntoAvailTest(ilSchMode, tlClf.iLen, llSepLength, tlChf.iMnfComp(0), tlChf.iMnfComp(1), tlClf.sBB, tlChf.lCode, tlClf.iLine, ilAvailIndex, tlRdf.sInOut, tlClf.sPreempt, tlClf.iPosition, tlClf.sSoloAvail, ilPriceLevel) Then
                                                                        If igDoEvent Then
                                                                            DoEvents
                                                                        End If
                                                                        If ilCallType = 1 Then
                                                                            'ReDim tgSpotMove(1 To 2) As SPOTMOVE
                                                                            ReDim tgSpotMove(0 To 1) As SPOTMOVE
                                                                            'tgSpotMove(1).lSdfCode = tmSdf.lCode
                                                                            tgSpotMove(0).lSdfCode = tmSdf.lCode
                                                                        End If
                                                                        ilRet = mBookSpot(slSchStatus, ilAvailIndex, tlChf, tlClf, tlRdf, ilGameNo, ilAHour(), ilADay(), ilAQH(), ilCallType)
                                                                        mSchPasses = ilRet
                                                                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                                                        If ilPass = 1 Then
                                                                            tmPreferredInfo(iltmPreferredInfoIndex).iNoPrefSpots = tmPreferredInfo(iltmPreferredInfoIndex).iNoPrefSpots - 1
                                                                        End If
                                                                        Exit Function
                                                                    End If
                                                                End If
                                                            End If
                                                            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                                        End If
                                                    End If
                                                    'Cycle to next test at "A"
                                                    ilACycle = ilACycle + 1
                                                Loop While ilACycle <= imACount
                                            Next ilLoopMinor
                                        Next ilLoopMiddle
                                    Next ilLoopMajor
                                    ilBCycle = ilBCycle + 1
                                    If ilCycleTest <= 1 Then
                                        ilCycleTest = 1
                                    End If
                                Loop While ilBCycle < imBCount
                                If ilCycleTest <= 1 Then
                                    ilCycleTest = 0
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If sgMinor = "H" Then
                                    ilRetMinor = mMoveSortValues(ilMinorGet, ilMinorValue, ilAHour(), imSHour(), imMinor())
                                ElseIf sgMinor = "D" Then
                                    ilRetMinor = mMoveSortValues(ilMinorGet, ilMinorValue, ilADay(), imSDay(), imMinor())
                                Else
                                    ilRetMinor = mMoveSortValues(ilMinorGet, ilMinorValue, ilAQH(), imSQH(), imMinor())
                                End If
                                If igDoEvent Then
                                    DoEvents
                                End If
                            Loop While ilRetMinor
                            ilCCycle = ilCCycle + 1
                            If ilCycleTest <= 2 Then
                                ilCycleTest = 2   'Do the C level test (Minor)
                            End If
                        Loop While ilCCycle < imCCount
                        If ilCycleTest <= 2 Then
                            ilCycleTest = 0
                        End If
                        If igDoEvent Then
                            DoEvents
                        End If
                        If sgMiddle = "H" Then
                            ilRetMiddle = mMoveSortValues(ilMiddleGet, ilMiddleValue, ilAHour(), imSHour(), imMiddle())
                        ElseIf sgMiddle = "D" Then
                            ilRetMiddle = mMoveSortValues(ilMiddleGet, ilMiddleValue, ilADay(), imSDay(), imMiddle())
                        Else
                            ilRetMiddle = mMoveSortValues(ilMiddleGet, ilMiddleValue, ilAQH(), imSQH(), imMiddle())
                        End If
                        If igDoEvent Then
                            DoEvents
                        End If
                    Loop While ilRetMiddle
                    ilDCycle = ilDCycle + 1
                    If ilCycleTest <= 3 Then
                        ilCycleTest = 3   'Do the D level cycle test (Middle)
                    End If
                Loop While ilDCycle < imDCount
                If ilCycleTest <= 3 Then
                    ilCycleTest = 0
                End If
                If igDoEvent Then
                    DoEvents
                End If
                If sgMajor = "H" Then
                    ilRetMajor = mMoveSortValues(ilMajorGet, ilMajorValue, ilAHour(), imSHour(), imMajor())
                ElseIf sgMajor = "D" Then
                    ilRetMajor = mMoveSortValues(ilMajorGet, ilMajorValue, ilADay(), imSDay(), imMajor())
                Else
                    ilRetMajor = mMoveSortValues(ilMajorGet, ilMajorValue, ilAQH(), imSQH(), imMajor())
                End If
                If igDoEvent Then
                    DoEvents
                End If
            Loop While ilRetMajor
            ilECycle = ilECycle + 1
            If ilCycleTest <= 4 Then
                ilCycleTest = 4   'Do the E level cycle test (major)
            End If
        Loop While ilECycle < imECount
        If ilPass = 1 Then
            tmPreferredInfo(iltmPreferredInfoIndex).iNoPrefSpots = 0
            iltmPreferredInfoIndex = -1
        End If
    Next ilPass
    ilCycleTest = 0
    mSchPasses = False
End Function

Function mSetDeleteFlag(lbcNotSchd As Control) As Integer
    Dim ilLoop As Integer
    Dim ilRet As Integer
    Dim ilCRet As Integer
    Dim ilClf As Integer
    Dim ilCff As Integer
    Dim slMsg As String
    Dim llChfRecPos As Long
    Dim tlClf As CLF
    Dim tlCff As CFF
    'Change any previous Order to Delete
    If tmPChf.lCode <= 0 Then        '7-26-05 chg from tgchfschd to tmPChf
        mSetDeleteFlag = True
        Exit Function
    End If
    ilRet = gObtainCntr(hmCHF, hmClf, hmCff, tmCChf.lCode, True, tgChfSchd, tgClfSchd(), tgCffSchd())
    If igDoEvent Then
        DoEvents
    End If
    'ilRet = gObtainCntr(hmChf, hmClf, hmCff, tgChfSchd.lCode, False, tmChf, tgClfSchd(), tgCffSchd())
    If ilRet Then
        For ilClf = LBound(tgClfSchd) To UBound(tgClfSchd) - 1 Step 1
            ilRet = btrGetDirect(hmClf, tlClf, imClfRecLen, tgClfSchd(ilClf).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
            If igDoEvent Then
                DoEvents
            End If
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CLF"
                '6/4/16: Removed GoSub
                'GoSub mSetDeleteFlagErrorMsg
                lbcNotSchd.AddItem slMsg
                mSetDeleteFlag = False
                Exit Function
            End If
            tmChfSrchKey.lCode = tlClf.lChfCode
            ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)
            If igDoEvent Then
                DoEvents
            End If
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Get Direct CLF"
                '6/4/16: Removed GoSub
                'GoSub mSetDeleteFlagErrorMsg
                lbcNotSchd.AddItem slMsg
                mSetDeleteFlag = False
                Exit Function
            End If
            If (tmChf.lCode <> tgChfSchd.lCode) And ((tmChf.sStatus = "H") Or (tmChf.sStatus = "O")) Then
                If tmChf.sDelete <> "Y" Then
                    Do
                        If igDoEvent Then
                            DoEvents
                        End If
                        tmChf.sDelete = "Y"
                        'gPackDate smSyncDate, tmChf.iSyncDate(0), tmChf.iSyncDate(1)
                        'gPackTime smSyncTime, tmChf.iSyncTime(0), tmChf.iSyncTime(1)
                        'tmChf.iSourceID = tgUrf(0).iRemoteUserID
                        ilRet = btrUpdate(hmCHF, tmChf, imCHFRecLen)
                        If igDoEvent Then
                            DoEvents
                        End If
                        If ilRet = BTRV_ERR_CONFLICT Then
                            tmChfSrchKey.lCode = tlClf.lChfCode
                            ilCRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)
                            If ilCRet <> BTRV_ERR_NONE Then
                                If ilCRet >= 30000 Then
                                    ilCRet = csiHandleValue(0, 7)
                                End If
                                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilCRet) & " Set Delete CHF"
                                '6/4/16: Removed GoSub
                                'GoSub mSetDeleteFlagErrorMsg
                                lbcNotSchd.AddItem slMsg
                                mSetDeleteFlag = False
                                Exit Function
                            End If
                        End If
                    Loop While ilRet = BTRV_ERR_CONFLICT
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Set Delete CHF"
                        '6/4/16: Removed GoSub
                        'GoSub mSetDeleteFlagErrorMsg
                        lbcNotSchd.AddItem slMsg
                        mSetDeleteFlag = False
                        Exit Function
                    End If
                End If
                'Check if line is replaced- if so, then set line as delete
                If tlClf.sDelete <> "Y" Then
                    For ilLoop = LBound(tgClfSchd) To UBound(tgClfSchd) - 1 Step 1
                        If (tgClfSchd(ilLoop).ClfRec.iLine = tlClf.iLine) And (tgClfSchd(ilLoop).ClfRec.iCntRevNo >= tlClf.iCntRevNo) Then
                            ilCff = tgClfSchd(ilClf).iFirstCff
                            Do While ilCff <> -1
                                If igDoEvent Then
                                    DoEvents
                                End If
                                ilRet = btrGetDirect(hmCff, tlCff, imCffRecLen, tgCffSchd(ilCff).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Set Delete CFF"
                                    '6/4/16: Removed GoSub
                                    'GoSub mSetDeleteFlagErrorMsg
                                    lbcNotSchd.AddItem slMsg
                                    mSetDeleteFlag = False
                                    Exit Function
                                End If
                                Do
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    'tmSRec = tlCff
                                    'ilRet = gGetByKeyForUpdate("CFF", hmCff, tmSRec)
                                    'tlCff = tmSRec
                                    'If igDoEvent Then
                                    '    DoEvents
                                    'End If
                                    'If ilRet <> BTRV_ERR_NONE Then
                                    '    If ilRet >= 30000 Then
                                    '        ilRet = csiHandleValue(0, 7)
                                    '    End If
                                    '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CFF"
                                    '    GoSub mSetDeleteFlagErrorMsg
                                    '    Exit Function
                                    'End If
                                    tlCff.sDelete = "Y"
                                    ilRet = btrUpdate(hmCff, tlCff, imCffRecLen)
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If ilRet = BTRV_ERR_CONFLICT Then
                                        ilCRet = btrGetDirect(hmCff, tlCff, imCffRecLen, tgCffSchd(ilCff).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                        If ilCRet <> BTRV_ERR_NONE Then
                                            If ilCRet >= 30000 Then
                                                ilCRet = csiHandleValue(0, 7)
                                            End If
                                            slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilCRet) & " Set Delete CFF"
                                            '6/4/16: Removed GoSub
                                            'GoSub mSetDeleteFlagErrorMsg
                                            lbcNotSchd.AddItem slMsg
                                            mSetDeleteFlag = False
                                            Exit Function
                                        End If
                                    End If
                                Loop While ilRet = BTRV_ERR_CONFLICT
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Set Delete CFF"
                                    '6/4/16: Removed GoSub
                                    'GoSub mSetDeleteFlagErrorMsg
                                    lbcNotSchd.AddItem slMsg
                                    mSetDeleteFlag = False
                                    Exit Function
                                End If
                                ilCff = tgCffSchd(ilCff).iNextCff
                            Loop
                            ilRet = btrGetDirect(hmClf, tlClf, imClfRecLen, tgClfSchd(ilClf).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilRet <> BTRV_ERR_NONE Then
                                If ilRet >= 30000 Then
                                    ilRet = csiHandleValue(0, 7)
                                End If
                                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Set Delete CLF"
                                '6/4/16: Removed GoSub
                                'GoSub mSetDeleteFlagErrorMsg
                                lbcNotSchd.AddItem slMsg
                                mSetDeleteFlag = False
                                Exit Function
                            End If
                            Do
                                If igDoEvent Then
                                    DoEvents
                                End If
                                'tmSRec = tlClf
                                'ilRet = gGetByKeyForUpdate("CLF", hmClf, tmSRec)
                                'tlClf = tmSRec
                                'If igDoEvent Then
                                '    DoEvents
                                'End If
                                'If ilRet <> BTRV_ERR_NONE Then
                                '    If ilRet >= 30000 Then
                                 '       ilRet = csiHandleValue(0, 7)
                                '    End If
                                '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CLF"
                                '    GoSub mSetDeleteFlagErrorMsg
                                '    Exit Function
                                'End If
                                tlClf.sDelete = "Y"
                                ilRet = btrUpdate(hmClf, tlClf, imClfRecLen)
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilRet = BTRV_ERR_CONFLICT Then
                                    ilCRet = btrGetDirect(hmClf, tlClf, imClfRecLen, tgClfSchd(ilClf).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                    If ilCRet <> BTRV_ERR_NONE Then
                                        If ilCRet >= 30000 Then
                                            ilCRet = csiHandleValue(0, 7)
                                        End If
                                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilCRet) & " Set Delete CLF"
                                        '6/4/16: Removed GoSub
                                        'GoSub mSetDeleteFlagErrorMsg
                                        lbcNotSchd.AddItem slMsg
                                        mSetDeleteFlag = False
                                        Exit Function
                                    End If
                                End If
                            Loop While ilRet = BTRV_ERR_CONFLICT
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilRet <> BTRV_ERR_NONE Then
                                If ilRet >= 30000 Then
                                    ilRet = csiHandleValue(0, 7)
                                End If
                                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Set Delete CLF"
                                '6/4/16: Removed GoSub
                                'GoSub mSetDeleteFlagErrorMsg
                                lbcNotSchd.AddItem slMsg
                                mSetDeleteFlag = False
                                Exit Function
                            End If
                            Exit For
                        End If
                    Next ilLoop
                End If
            End If
        Next ilClf
        'Loop thru contracts and set any contract to delete (header without lines (cause when line added to schedule header, the line moves to schedule header)
        tmChfSrchKey1.lCntrNo = tgChfSchd.lCntrNo
        tmChfSrchKey1.iCntRevNo = tgChfSchd.iCntRevNo - 1
        tmChfSrchKey1.iPropVer = 32000
        ilRet = btrGetGreaterOrEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        Do While (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tgChfSchd.lCntrNo)
            If igDoEvent Then
                DoEvents
            End If
            If (tmChf.lCode <> tgChfSchd.lCode) And ((tmChf.sStatus = "H") Or (tmChf.sStatus = "O")) Then
                If tmChf.sDelete <> "Y" Then
                    ilRet = btrGetPosition(hmCHF, llChfRecPos)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Set Delete CHF"
                        '6/4/16: Removed GoSub
                        'GoSub mSetDeleteFlagErrorMsg
                        lbcNotSchd.AddItem slMsg
                        mSetDeleteFlag = False
                        Exit Function
                    End If
                    Do
                        If igDoEvent Then
                            DoEvents
                        End If
                        'tmSRec = tmChf
                        'ilRet = gGetByKeyForUpdate("CHF", hmChf, tmSRec)
                        'tmChf = tmSRec
                        'If igDoEvent Then
                        '    DoEvents
                        'End If
                        'If ilRet <> BTRV_ERR_NONE Then
                        '    If ilRet >= 30000 Then
                        '        ilRet = csiHandleValue(0, 7)
                        '    End If
                        '    slMsg = Trim$(Str$(tmCChf.lCntrNo)) & " I/O Error:" & Str$(ilRet) & " Get by Key CLF"
                        '    GoSub mSetDeleteFlagErrorMsg
                        '    Exit Function
                        'End If
                        tmChf.sDelete = "Y"
                        'gPackDate smSyncDate, tmChf.iSyncDate(0), tmChf.iSyncDate(1)
                        'gPackTime smSyncTime, tmChf.iSyncTime(0), tmChf.iSyncTime(1)
                        'tmChf.iSourceID = tgUrf(0).iRemoteUserID
                        ilRet = btrUpdate(hmCHF, tmChf, imCHFRecLen)
                        If igDoEvent Then
                            DoEvents
                        End If
                        If ilRet = BTRV_ERR_CONFLICT Then
                            ilCRet = btrGetDirect(hmCHF, tmChf, imCHFRecLen, llChfRecPos, INDEXKEY1, BTRV_LOCK_NONE)
                            If ilCRet <> BTRV_ERR_NONE Then
                                If ilCRet >= 30000 Then
                                    ilCRet = csiHandleValue(0, 7)
                                End If
                                slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilCRet) & " Set Delete CHF"
                                '6/4/16: Removed GoSub
                                'GoSub mSetDeleteFlagErrorMsg
                                lbcNotSchd.AddItem slMsg
                                mSetDeleteFlag = False
                                Exit Function
                            End If
                        End If
                    Loop While ilRet = BTRV_ERR_CONFLICT
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilRet) & " Set Delete CHF"
                        '6/4/16: Removed GoSub
                        'GoSub mSetDeleteFlagErrorMsg
                        lbcNotSchd.AddItem slMsg
                        mSetDeleteFlag = False
                        Exit Function
                    End If
                    ilCRet = btrGetDirect(hmCHF, tmChf, imCHFRecLen, llChfRecPos, INDEXKEY1, BTRV_LOCK_NONE)
                    If ilCRet <> BTRV_ERR_NONE Then
                        If ilCRet >= 30000 Then
                            ilCRet = csiHandleValue(0, 7)
                        End If
                        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " I/O Error:" & str$(ilCRet) & " Set Delete CHF"
                        '6/4/16: Removed GoSub
                        'GoSub mSetDeleteFlagErrorMsg
                        lbcNotSchd.AddItem slMsg
                        mSetDeleteFlag = False
                        Exit Function
                    End If
                End If
            End If
            ilRet = btrGetNext(hmCHF, tmChf, imCHFRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        Loop
    Else
        If igBtrError >= 30000 Then
            igBtrError = csiHandleValue(0, 7)
        End If
        slMsg = Trim$(str$(tmCChf.lCntrNo)) & " Error in gObtainChf (I/O Error:" & str$(igBtrError) & ")"
        '6/4/16: Removed GoSub
        'GoSub mSetDeleteFlagErrorMsg
        lbcNotSchd.AddItem slMsg
        mSetDeleteFlag = False
        Exit Function
    End If
    mSetDeleteFlag = True
    Exit Function
'mSetDeleteFlagErrorMsg:
'    lbcNotSchd.AddItem slMsg
'    mSetDeleteFlag = False
'    Return
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mSetHDQIndex                    *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Set imHourIndex, imDayIndex and *
'*                         imQHIndex                   *
'*                                                     *
'*******************************************************
Sub mSetHDQIndex(ilLoopMajor As Integer, ilLoopMiddle As Integer, ilLoopMinor As Integer)
    If sgMajor = "H" Then   'Hour
        imHourIndex = imMajor(ilLoopMajor)
    ElseIf sgMajor = "D" Then   'Day
        'imDayIndex = imMajor(ilLoopMajor) - 1
        imDayIndex = imMajor(ilLoopMajor)
    Else    'Quarter hour
        imQHIndex = imMajor(ilLoopMajor)
    End If
    If sgMiddle = "H" Then  'Hour
        imHourIndex = imMiddle(ilLoopMiddle)
    ElseIf sgMiddle = "D" Then   'Day
        'imDayIndex = imMiddle(ilLoopMiddle) - 1
        imDayIndex = imMiddle(ilLoopMiddle)
    Else    'Quarter hour
        imQHIndex = imMiddle(ilLoopMiddle)
    End If
    If sgMinor = "H" Then   'Hour
        imHourIndex = imMinor(ilLoopMinor)
    ElseIf sgMinor = "D" Then   'Day
        'imDayIndex = imMinor(ilLoopMinor) - 1
        imDayIndex = imMinor(ilLoopMinor)
    Else    'Quarter hour
        imQHIndex = imMinor(ilLoopMinor)
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mSortArray                      *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Order array in ascending order  *
'*                     with equal values insert in     *
'*                     random order                    *
'*                                                     *
'*******************************************************
Private Sub mSortArray(slSortRnd As String, ilInArray() As Integer, ilOutArray() As Integer)
'
'   mSortArray slSort, ilInArray, ilOutArray
'   Where:
'       slSort(I)- N=No sorting; No randomizing
'                  R=No sorting; randomize all counts
'                  S=Sorting counts lowest to highest; No randomizing of matched counts
'                  B=Sorting counts lowest to highest; Randomize matching counts
'       ilInArray(I)- The array to be sorted (any entry as -1 will be ignored)
'       ilOutArray(I)- The array of indices into ilInArray so ilInArray is sorted
'
    Dim ilNextValue As Integer
    Dim ilLoop As Integer
    Dim ilCount As Integer  'Number of values stored into ilOutArray
    Dim ilNoMatches As Integer  'Number of values that are the same
    Dim ilMatchIndex As Integer
    Dim ilLowestValue As Integer
    Dim ilCompact As Integer
    Dim ilDone As Integer   'Flag indicating if sort completed
    Dim ilRnd As Integer    'Set to true for slSort = "R" or "B"
    'ReDim ilMatch(1 To UBound(ilInArray)) As Integer
    'ReDim ilOutArray(1 To UBound(ilInArray)) As Integer
    ReDim ilMatch(0 To UBound(ilInArray)) As Integer
    ReDim ilOutArray(0 To UBound(ilInArray)) As Integer

    If (slSortRnd = "N") Or (slSortRnd = "S") Then
        ilRnd = False
    Else
        ilRnd = True
    End If
    ilNextValue = -1
    'ilCount = 0
    ilCount = -1
    ilDone = False
    Do
        If igDoEvent Then
            DoEvents
        End If
        If (slSortRnd = "N") Then
            For ilLoop = LBound(ilInArray) To UBound(ilInArray) Step 1
                If ilInArray(ilLoop) >= 0 Then
                    ilCount = ilCount + 1
                    ilOutArray(ilCount) = ilInArray(ilLoop)
                End If
            Next ilLoop
            ilNoMatches = 0
            ilDone = True
        ElseIf (slSortRnd = "R") Then
            'ilNoMatches = 0
            ilNoMatches = -1
            For ilLoop = LBound(ilInArray) To UBound(ilInArray) Step 1
                If ilInArray(ilLoop) >= 0 Then
                    ilNoMatches = ilNoMatches + 1
                    ilMatch(ilNoMatches) = ilInArray(ilLoop)
                End If
            Next ilLoop
            ilDone = True
        Else
            'ilNoMatches = 0
            ilNoMatches = -1
            ilLowestValue = 32000
            For ilLoop = LBound(ilInArray) To UBound(ilInArray) Step 1
                If ilInArray(ilLoop) <> -1 Then
                    If (ilInArray(ilLoop) = ilLowestValue) Then
                        ilNoMatches = ilNoMatches + 1
                        ilMatch(ilNoMatches) = ilLoop
                    ElseIf (ilInArray(ilLoop) < ilLowestValue) And (ilInArray(ilLoop) > ilNextValue) Then
                        'ilNoMatches = 1
                        ilNoMatches = 0
                        ilMatch(ilNoMatches) = ilLoop
                        ilLowestValue = ilInArray(ilLoop)
                    End If
                End If
            Next ilLoop
        End If
        If igDoEvent Then
            DoEvents
        End If
        'If ilNoMatches > 0 Then
        If ilNoMatches >= 0 Then
            Do
                If igDoEvent Then
                    DoEvents
                End If
                'If (ilNoMatches > 1) And (ilRnd) Then
                '    ilMatchIndex = Int(ilNoMatches * Rnd + 1)
                'Else
                '    ilMatchIndex = 1
                'End If
                If (ilNoMatches > 0) And (ilRnd) Then
                    ilMatchIndex = Int((ilNoMatches + 1) * Rnd)
                Else
                    ilMatchIndex = 0
                End If
                ilCount = ilCount + 1
                ilOutArray(ilCount) = ilMatch(ilMatchIndex)
                ilNextValue = ilInArray(ilMatch(ilMatchIndex))
                For ilCompact = ilMatchIndex + 1 To ilNoMatches Step 1
                    ilMatch(ilCompact - 1) = ilMatch(ilCompact)
                Next ilCompact
                ilNoMatches = ilNoMatches - 1
            'Loop While ilNoMatches > 0
            Loop While ilNoMatches >= 0
        Else
            ilDone = True
        End If
    Loop While Not ilDone
    If igDoEvent Then
        DoEvents
    End If
    'If ilCount > 0 Then
    '    ReDim Preserve ilOutArray(1 To ilCount) As Integer
    'Else
    '    ReDim ilOutArray(1 To 1) As Integer
    '    ilOutArray(1) = -1
    'End If
    If ilCount >= 0 Then
        ReDim Preserve ilOutArray(0 To ilCount) As Integer
    Else
        ReDim ilOutArray(0 To 0) As Integer
        ilOutArray(0) = -1
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mValidateSpots                  *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Preempt spot from Ssf if        *
'*                     invalid- day and number of spots*
'*                     checked by mBalanceSpots        *
'*                     Invalid spots will be preempted *
'*                                                     *
'*******************************************************
'3/17/13: Add date
'Private Function mValidateSpots(ilGameNo As Integer) As Integer
Private Function mValidateSpots(ilGameNo As Integer, llGameDate As Long) As Integer
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilPLoop                       ilFound                                                 *
'******************************************************************************************

'
'   mValidateSpots ilGameNo
'   Where:
'       ilGameNo(I)- Game Number
'       llGameDate(I)- Game date
'       tlChf(I)- Contract header
'       tlClf(I)- Contract line
'       tlRdf(I)- Rate card program/time
'       llSepLength(I)- Advertiser separation length in seconds
'       Fields altered
'       Bit  Meaning
'       0    Advertiser changed (update records and check for conflicts)
'       1    Competitive 1 (update records and check for conflicts)
'       2    Competitive 2 (update records and check for conflicts)
'       3    Exclusion 1 (update records and check if allowed)
'       4    Exclusion 2 (update records and check if allowed)
'       5    BB
'       6    Extra
'       7    Break # (added)
'       8    Position # (changed)
'       9    Length (update records and check if room for spot)
'       10   Time (check if time valid for spot)
'
'       lmEarliestAllowedDate(I)- Earliest allowed schedule date (removal date)
'
'
    Dim ilRet As Integer
    Dim ilRet1 As Integer
    Dim slDate As String
    Dim ilDate0 As Integer
    Dim ilDate1 As Integer
    Dim llDate As Long
    Dim ilTime0 As Integer
    Dim ilTime1 As Integer
    Dim slTime As String
    Dim slCTime As String
    Dim slPTime As String
    Dim llCTime As Long
    Dim llPTime As Long
    Dim ilHourIndex As Integer
    Dim ilSpotStatus As Integer     '0=Leave; 1=Update; 2=Preempt; -1=Delete X type spot
    Dim ilTestReq As Integer        'True=Field changed requiring Sdf and Ssf to be updated
    Dim ilChgAllSpots As Integer    'True=All spots require changing (advert or len or BB altered)
    Dim ilPassNo As Integer
    Dim ilPassStartNo As Integer
    Dim ilPassEndNo As Integer
    'Dim llStartTime(1 To 7) As Long
    Dim llStartTime(0 To 6) As Long
    'Dim llEndTime(1 To 7) As Long
    Dim llEndTime(0 To 6) As Long
    Dim ilTimeFound As Integer
    Dim ilLoop As Integer
    Dim llSpotTime As Long
    Dim ilCheckTime As Integer  'Used to check time of a missed spot or a spot set to missed
    Dim llPSTime As Long
    Dim llPETime As Long
    Dim llCSTime As Long
    Dim llCETime As Long
    Dim llEarliestAllowedDate As Long
    Dim llNowDate As Long
    Dim slPass As String
    Dim ilPass As Integer
    Dim ilBypass As Integer
    Dim ilVpfIndex As Integer
    Dim llLockRecCode As Long
    Dim slUserName As String
    Dim ilChkSplitNetwork As Integer
    Dim ilCLoop As Integer
    Dim slPInclExcl As String
    Dim llSDFCode As Long
    Dim ilSpot As Integer
    Dim blSpotFound As Boolean
    ReDim llSpotProcessed(0 To 0) As Long
    'ReDim tlPStations(1 To 1) As INTKEY0
    ReDim tlPStations(0 To 0) As INTKEY0
    'Determine if validation test required
    ilTestReq = False
    ilChgAllSpots = False
    If tmPclf.lChfCode = 0 Then 'No previous
        mValidateSpots = True
        Exit Function
    End If
    ilVpfIndex = gVpfFindIndex(imCVefCode)
    llEarliestAllowedDate = lmEarliestAllowedDate
    llNowDate = gDateValue(Format$(gNow(), "m/d/yy"))
    If ilVpfIndex <> -1 Then
        If tgVpf(ilVpfIndex).sMoveLLD = "Y" Then
            llDate = llNowDate + 1
            If llDate < llEarliestAllowedDate Then
                llEarliestAllowedDate = llDate
            End If
        End If
    Else
        mValidateSpots = False
        Exit Function
    End If
    If (tmCChf.iHdChg And &H1F) <> 0 Then   'Advert, Competitive or exclusions changed
        ilTestReq = True
        If (tmCChf.iHdChg And &H1) <> 0 Then
            ilChgAllSpots = True
        End If
    End If
    If (tmCChf.iHdChg And HDSCHSTATUSMCHG) <> 0 Then   'Type changed
        ilTestReq = True
        ilChgAllSpots = True
    End If
    If Not ilChgAllSpots Then
        If tmCClf.iLen <> tmPclf.iLen Then
            ilTestReq = True
            ilChgAllSpots = True
        End If
        If tmCClf.iRdfCode <> tmPclf.iRdfCode Then
            ilTestReq = True
        End If
        If (tgVpf(ilVpfIndex).sGMedium <> "S") Then
            If (tmCClf.iStartTime(0) <> tmPclf.iStartTime(0)) Or (tmCClf.iStartTime(1) <> tmPclf.iStartTime(1)) Then
                'Test if test expanded
                If (tmCClf.iStartTime(0) = 1) And (tmCClf.iStartTime(1) = 0) Then
                    ilTestReq = True
                ElseIf (tmPclf.iStartTime(0) = 1) And (tmPclf.iStartTime(1) = 0) Then
                    ilTestReq = True
                Else
                    gUnpackTime tmCClf.iStartTime(0), tmCClf.iStartTime(1), "A", "1", slCTime
                    llCTime = CLng(gTimeToCurrency(slCTime, False))
                    gUnpackTime tmPclf.iStartTime(0), tmPclf.iStartTime(1), "A", "1", slPTime
                    llPTime = CLng(gTimeToCurrency(slPTime, False))
                    If llPTime < llCTime Then
                        ilTestReq = True
                    End If
                End If
            End If
        End If
        If igDoEvent Then
            DoEvents
        End If
        If (tmCClf.iEndTime(0) <> tmPclf.iEndTime(0)) Or (tmCClf.iEndTime(1) <> tmPclf.iEndTime(1)) Then
            'Test if test expanded
            If (tmCClf.iEndTime(0) = 1) And (tmCClf.iEndTime(1) = 0) Then
                ilTestReq = True
            ElseIf (tmPclf.iEndTime(0) = 1) And (tmPclf.iEndTime(1) = 0) Then
                ilTestReq = True
            Else
                gUnpackTimeLong tmPclf.iStartTime(0), tmPclf.iStartTime(1), False, llPSTime
                gUnpackTimeLong tmPclf.iEndTime(0), tmPclf.iEndTime(1), True, llPETime
                gUnpackTimeLong tmCClf.iStartTime(0), tmCClf.iStartTime(1), False, llCSTime
                gUnpackTimeLong tmCClf.iEndTime(0), tmCClf.iEndTime(1), True, llCETime
                If llPETime < llPSTime Then
                    If llCETime < llCSTime Then
                        If llPETime > llCETime Then
                            ilTestReq = True
                        End If
                    Else
                        ilTestReq = True
                    End If
                Else
                    If llCETime > llCSTime Then
                        If llPETime > llCETime Then
                            ilTestReq = True
                        End If
                    End If
                End If
            End If
        End If
        If igDoEvent Then
            DoEvents
        End If
        If tmCClf.sBB <> tmPclf.sBB Then
            ilTestReq = True
        End If
        If tmCClf.sExtra <> tmPclf.sExtra Then
            ilTestReq = True
        End If
        If tmCClf.iBreak <> tmPclf.iBreak Then
            ilTestReq = True
        End If
        If (tmCClf.iPosition = 1) And (tmPclf.iPosition <> 1) Then
            ilTestReq = True
        End If
        If (tmCClf.sSoloAvail = "Y") And (tmPclf.sSoloAvail <> "Y") Then
            ilTestReq = True
        End If
        If tmCClf.sPreempt <> tmPclf.sPreempt Then
            ilTestReq = True
        End If
        If tmCClf.iPriority <> tmPclf.iPriority Then
            ilTestReq = True
        End If
    End If
    ilChkSplitNetwork = False
    If tmCClf.lRafCode <> tmPclf.lRafCode Then
        ilTestReq = True
        ilChkSplitNetwork = True
    Else
        'gBuildStationsFromRAF hmRaf, hmSef, tmCClf.lRafCode, slCInclExcl, tlCStations()
        gBuildStationsFromRAF hmRaf, hmSef, tmPclf.lRafCode, slPInclExcl, tlPStations(), True
        If smClfInclExcl <> slPInclExcl Then
            ilTestReq = True
            ilChkSplitNetwork = True
        Else
            'Compare station list
            For ilCLoop = LBound(tmStationsClf) To UBound(tmStationsClf) - 1 Step 1
                ilRet = mBinarySearchStations(tmStationsClf(ilCLoop).iCode, tlPStations())
                If ilRet = -1 Then
                    ilTestReq = True
                    ilChkSplitNetwork = True
                    Exit For
                End If
            Next ilCLoop
        End If
    End If
    If Not ilTestReq Then
        mValidateSpots = True
        Exit Function
    End If
    If ilChgAllSpots Then
        ilPassStartNo = 0
        ilPassEndNo = 0
        If (tmCClf.iLen <> tmPclf.iLen) Or ((tmCChf.iHdChg And &H1) <> 0) Then
            ilPassEndNo = 1 'Process spots prior to earliest date
        End If
    Else
        ilPassStartNo = 0 '1  changed to 0 to fix missed spots
        ilPassEndNo = 0 '3
    End If
    'Prempt scheduled spots
    'ReDim tgSpotMove(1 To 2) As SPOTMOVE
    ReDim tgSpotMove(0 To 1) As SPOTMOVE
    For ilPass = 0 To 2 Step 1
        If igDoEvent Then
            DoEvents
        End If
        Select Case ilPass
            Case 0
                slPass = "O"    'Outside limits
            Case 1
                slPass = "G"    'MG
            Case 2
                slPass = " "    'Scheduled
        End Select
        For ilPassNo = ilPassStartNo To ilPassEndNo Step 1
            If igDoEvent Then
                DoEvents
            End If
            llDate = llEarliestAllowedDate
            If (slPass = "O") Or (slPass = "G") Then
                tmSmfSrchKey.lChfCode = tmCChf.lCode
                tmSmfSrchKey.iLineNo = tmCClf.iLine
                tmSmfSrchKey.lFsfCode = tmCFsf.lCode
                slDate = Format$(llDate, "m/d/yy")
                If ilPassNo = 0 Then
                    gPackDate slDate, ilDate0, ilDate1
                Else
                    ilDate0 = 0
                    ilDate1 = 0
                End If
                tmSmfSrchKey.iMissedDate(0) = ilDate0
                tmSmfSrchKey.iMissedDate(1) = ilDate1
                ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tmCChf.lCode) And (tmSmf.iLineNo = tmCClf.iLine) And (tmSmf.lFsfCode = tmCFsf.lCode)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If (tmSmf.iOrigSchVef = imCVefCode) And (tmSmf.sSchStatus = slPass) Then
                        '2/21/11: Replace GetDirect with GetEqual
                        llSDFCode = tmSmf.lSdfCode
                        tmSdfSrchKey3.lCode = llSDFCode
                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If igDoEvent Then
                            DoEvents
                        End If
                        If ilRet = BTRV_ERR_NONE Then
                            ilBypass = False
                            '3/17/13: add game date test
                            If tmSmf.iGameNo > 0 Then
                                gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                If gDateValue(slDate) <> llGameDate Then
                                    ilBypass = True
                                End If
                            End If
                            If tmSdf.iGameNo <> ilGameNo Then
                                ilBypass = True
                            Else
                                If ilPassNo = 1 Then
                                    'gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                    gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                    If gDateValue(slDate) >= llEarliestAllowedDate Then
                                        ilBypass = True
                                    End If
                                End If
                            End If
                            If Not ilBypass Then
                                '2/21/11: Replaced GetDirect with GetEqual
                                'ilRet = btrGetPosition(hmSdf, lmSdfRecPos)
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilRet <> BTRV_ERR_NONE Then
                                    mValidateSpots = False
                                    Exit Function
                                End If
                                ilSpotStatus = 0
                                ilCheckTime = False
                                'ilHourIndex = tmSdf.iTime(1) \ 256 + 1  'Obtain hour (0 to 23)
                                ilHourIndex = tmSdf.iTime(1) \ 256  'Obtain hour (0 to 23)
                                gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                llDate = gDateValue(slDate) 'Start search from the date
                                imDayIndex = gWeekDayLong(llDate)    'mVefCompConflictTest require this variable
                                ilTime0 = 0
                                'ilTime1 = (ilHourIndex - 1) * 256
                                ilTime1 = (ilHourIndex) * 256
                                gUnpackTime ilTime0, ilTime1, "A", "1", slTime
                                'If gObtainSsfForDateOrGame(imCVefCode, llDate, slTime, hmSsf, tgSsf(imDayIndex), lgSsfDate(imDayIndex), lgSsfRecPos(imDayIndex)) Then
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilGameNo <= 0 Then
                                    llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tmSdf.iVefCode + llDate, True, slUserName)
                                Else
                                    llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tmSdf.iVefCode + ilGameNo, True, slUserName)
                                End If
                                If llLockRecCode > 0 Then
                                    If gObtainSsfForDateOrGame(tmSdf.iVefCode, llDate, slTime, ilGameNo, hmSsf, tgSsf(imDayIndex), lgSsfDate(imDayIndex), lgSsfRecPos(imDayIndex)) Then
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If ilPassNo = 0 Then
                                            ilSpotStatus = mChgUpdSchSdfSsf(False, tmSdf.iVefCode, ilGameNo, ilChkSplitNetwork)  ', ilVpfIndex)  'Process all changes
                                        Else
                                            ilSpotStatus = mChgUpdSchSdfSsf(True, tmSdf.iVefCode, ilGameNo, ilChkSplitNetwork) ', ilVpfIndex)   'Only process Advt and Len changes
                                        End If
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If ilSpotStatus = -2 Then
                                            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                            mValidateSpots = False
                                            Exit Function
                                        End If
                                        If ilSpotStatus = 2 Then    'Check time
                                            ilCheckTime = True
                                            'Set tracer if date between Now+1 And Last Log Date
                                            'gMakeTracer is in mChgUpdSchSdfSsf, not required here
                                            'gMakeTracer hmSdf, tmSdf, lmSdfRecPos, hmStf, lmLastLogDate, "M", "C"
                                        End If
                                    Else
                                        'mValidateSpots = False
                                        'Exit Function
                                    End If
                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    If ilCheckTime Then
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        '2/21/11: Replace GetDirect with GetEqual
                                        'ilRet = btrGetPosition(hmSdf, lmSdfRecPos)
                                        'If ilRet <> BTRV_ERR_NONE Then
                                        '    mValidateSpots = False
                                        '    Exit Function
                                        'End If
                                        gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                        mGetLegalTimes slDate, ilGameNo, llStartTime(), llEndTime()
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        gUnpackTime tmSdf.iTime(0), tmSdf.iTime(1), "A", "1", slTime
                                        llSpotTime = CLng(gTimeToCurrency(slTime, False))
                                        Do
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                            'tmSRec = tmSdf
                                            'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
                                            'tmSdf = tmSRec
                                            'If igDoEvent Then
                                            '    DoEvents
                                            'End If
                                            'If ilRet <> BTRV_ERR_NONE Then
                                            '    mValidateSpots = False
                                            '    Exit Function
                                            'End If
                                            tmSdf.iAdfCode = tmCChf.iAdfCode
                                            tmSdf.iLen = tmCClf.iLen
                                            'If ((tmCChf.sType = "C") Or (tmCChf.sType = "V")) And (tmSdf.sSpotType <> "X") Then
                                            If ((tmCChf.sType = "C") Or (tmCChf.sType = "V") Or ((tmCChf.sType = "M") And (tgSpf.sSchdPromo = "Y")) Or ((tmCChf.sType = "S") And (tgSpf.sSchdPSA = "Y")) Or ((tmCChf.sType = "T") And (tgSpf.sSchdRemnant = "Y"))) And (tmSdf.sSpotType <> "X") Then
                                                tmSdf.sSpotType = "A"
                                            End If
                                            'If (llSpotTime < llStarttime) Then
                                            '    slTime = gCurrencyToTime(CCur(llStarttime))
                                            '    gPackTime slTime, tmSdf.iTime(0), tmSdf.iTime(1)
                                            '    ilSpotStatus = 2    'Force key read
                                            'End If
                                            'If (llSpotTime > llEndTime) Then
                                            '    slTime = gCurrencyToTime(CCur(llStarttime))
                                            '    gPackTime slTime, tmSdf.iTime(0), tmSdf.iTime(1)
                                            '    ilSpotStatus = 2    'Force key read
                                            'End If
                                            ilTimeFound = False
                                            For ilLoop = LBound(llStartTime) To UBound(llStartTime) Step 1
                                                If (llSpotTime >= llStartTime(ilLoop)) And (llSpotTime <= llEndTime(ilLoop)) Then
                                                    ilTimeFound = True
                                                    Exit For
                                                End If
                                            Next ilLoop
                                            If Not ilTimeFound Then
                                                slTime = gCurrencyToTime(CCur(llStartTime(LBound(llStartTime))))
                                                gPackTime slTime, tmSdf.iTime(0), tmSdf.iTime(1)
                                                ilSpotStatus = 2    'Force key read
                                            End If
                                            'Fix missed time if outside limits
                                            ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
                                            If igDoEvent Then
                                                DoEvents
                                            End If
                                           If ilRet = BTRV_ERR_CONFLICT Then
                                                '2/21/11: Replace GetDirect with GetEqual
                                                'ilRet1 = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, lmSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSdfSrchKey3.lCode = llSDFCode
                                                ilRet1 = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                If (tmSdf.sSchStatus = "O") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "S") Then
                                                    ilRet = BTRV_ERR_NONE
                                                    Exit Do
                                                End If
                                                If ilRet1 <> BTRV_ERR_NONE Then
                                                    mValidateSpots = False
                                                    Exit Function
                                                End If
                                            End If
                                        Loop While ilRet = BTRV_ERR_CONFLICT
                                        If igDoEvent Then
                                            DoEvents
                                        End If
                                        If ilRet <> BTRV_ERR_NONE Then
                                            mValidateSpots = False
                                            Exit Function
                                        End If
                                    End If
                                End If
                            End If
                        Else
                            mValidateSpots = False
                            Exit Function
                        End If
                    End If
                    ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop
            Else
                tgSdfSrchKey.iVefCode = imCVefCode
                tgSdfSrchKey.lChfCode = tmCChf.lCode
                tgSdfSrchKey.iLineNo = tmCClf.iLine
                tgSdfSrchKey.lFsfCode = tmCFsf.lCode
                slDate = Format$(llDate, "m/d/yy")
                If ilPassNo = 0 Then
                    gPackDate slDate, ilDate0, ilDate1
                Else
                    ilDate0 = 0
                    ilDate1 = 0
                End If
                tgSdfSrchKey.iDate(0) = ilDate0
                tgSdfSrchKey.iDate(1) = ilDate1
                'Select Case ilPassNo
                '    Case 0
                        tgSdfSrchKey.sSchStatus = " "   'All spots
                '    Case 1
                '        tgSdfSrchKey.sSchStatus = "O"   'Outside spots
                '    Case 2
                '        tgSdfSrchKey.sSchStatus = "G"   'MG scheduled spots
                '    Case 3
                '        tgSdfSrchKey.sSchStatus = "S"   'Scheduled spots
                'End Select
                tgSdfSrchKey.iTime(0) = 0
                tgSdfSrchKey.iTime(1) = 0
                ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tmSdf.iVefCode = imCVefCode) And (tmSdf.lChfCode = tmCChf.lCode) And (tmSdf.iLineNo = tmCClf.iLine) And (tmSdf.lFsfCode = tmCFsf.lCode)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilPassNo = 1 Then
                        gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                        If gDateValue(slDate) >= llEarliestAllowedDate Then
                            Exit Do
                        End If
                    End If
                    'Select Case ilPass
                    '    Case 0  'All spots
                        'Case 1  'Scheduled spots
                        '    If tmSdf.sSchStatus <> "O" Then
                        '        Exit Do
                        '    End If
                        'Case 2  'MG scheduled spots
                        '    If tmSdf.sSchStatus <> "G" Then
                        '        Exit Do
                        '    End If
                        'Case 3  'Scheduled spots
                        '    If tmSdf.sSchStatus <> "S" Then
                        '        Exit Do
                        '    End If
                    'End Select
                    '2/21/11: Replace GetDirect with GetEqual
                    'ilRet = btrGetPosition(hmSdf, lmSdfRecPos)
                    llSDFCode = tmSdf.lCode
                    ilSpotStatus = 0
                    ilCheckTime = False
                    blSpotFound = False
                    For ilSpot = 0 To UBound(llSpotProcessed) - 1 Step 1
                        If tmSdf.lCode = llSpotProcessed(ilSpot) Then
                            blSpotFound = True
                            Exit For
                        End If
                    Next ilSpot
                    '3/17/13: Add date test
                    If tmSdf.iGameNo > 0 Then
                        gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                        If gDateValue(slDate) <> llGameDate Then
                            blSpotFound = True  'Bypass spot
                        End If
                    End If
                    'If (tmSdf.sSchStatus = "O") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "S") Then
                    If (Not blSpotFound) And (tmSdf.sSchStatus <> "O") And (tmSdf.sSchStatus <> "G") And (tmSdf.sSpotType <> "O") And (tmSdf.sSpotType <> "C") And (tmSdf.iGameNo = ilGameNo) Then
                        llSpotProcessed(UBound(llSpotProcessed)) = tmSdf.lCode
                        ReDim Preserve llSpotProcessed(0 To UBound(llSpotProcessed) + 1) As Long
                        If (tmSdf.sSchStatus = "S") Then
                            'ilHourIndex = tmSdf.iTime(1) \ 256 + 1  'Obtain hour (0 to 23)
                            ilHourIndex = tmSdf.iTime(1) \ 256   'Obtain hour (0 to 23)
                            gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                            llDate = gDateValue(slDate) 'Start search from the date
                            imDayIndex = gWeekDayLong(llDate)    'mVefCompConflictTest require this variable
                            ilTime0 = 0
                            'ilTime1 = (ilHourIndex - 1) * 256
                            ilTime1 = (ilHourIndex) * 256
                            gUnpackTime ilTime0, ilTime1, "A", "1", slTime
                            If igDoEvent Then
                                DoEvents
                            End If
                            If ilGameNo <= 0 Then
                                llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * imCVefCode + llDate, True, slUserName)
                            Else
                                llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * imCVefCode + ilGameNo, True, slUserName)
                            End If
                            If llLockRecCode > 0 Then
                                If gObtainSsfForDateOrGame(imCVefCode, llDate, slTime, ilGameNo, hmSsf, tgSsf(imDayIndex), lgSsfDate(imDayIndex), lgSsfRecPos(imDayIndex)) Then
                                    If igDoEvent Then
                                        DoEvents
                                    End If
                                    If ilPassNo = 0 Then
                                        ilSpotStatus = mChgUpdSchSdfSsf(False, imCVefCode, ilGameNo, ilChkSplitNetwork) 'ilVpfIndex)  'Process all changes
                                    Else
                                        ilSpotStatus = mChgUpdSchSdfSsf(True, imCVefCode, ilGameNo, ilChkSplitNetwork) 'ilVpfIndex)   'Only process Advt and Len changes
                                    End If
                                    If ilSpotStatus = -2 Then
                                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                        mValidateSpots = False
                                        Exit Function
                                    End If
                                    If ilSpotStatus = 2 Then    'Check time
                                        ilCheckTime = True
                                        'Set tracer if date between Now+1 And Last Log Date
                                        'gMakeTracer is in mChgUpdSchSdfssf, not required here
                                        'gMakeTracer hmSdf, tmSdf, lmSdfRecPos, hmStf, lmLastLogDate, "M", "C"
                                    End If
                                End If
                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                            End If
                        Else
                            ilCheckTime = True
                            gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                            llDate = gDateValue(slDate)
                            If (tmSdf.iAdfCode <> tmCChf.iAdfCode) Or (tmSdf.iLen <> tmCClf.iLen) Then
                                ilSpotStatus = 2    'Force to be key read
                            End If
                        End If
                        If igDoEvent Then
                            DoEvents
                        End If
                        If ilCheckTime Then
                            '2/21/11: Replace GetDirect with GetEqual
                            'ilRet = btrGetPosition(hmSdf, lmSdfRecPos)
                            'If ilRet <> BTRV_ERR_NONE Then
                            '    mValidateSpots = False
                            '    Exit Function
                            'End If
                            gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                            If igDoEvent Then
                                DoEvents
                            End If
                            mGetLegalTimes slDate, ilGameNo, llStartTime(), llEndTime()
                            gUnpackTime tmSdf.iTime(0), tmSdf.iTime(1), "A", "1", slTime
                            llSpotTime = CLng(gTimeToCurrency(slTime, False))
                            Do
                                If igDoEvent Then
                                    DoEvents
                                End If
                                'tmSRec = tmSdf
                                'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
                                'tmSdf = tmSRec
                                'If igDoEvent Then
                                '    DoEvents
                                'End If
                                tmSdf.iAdfCode = tmCChf.iAdfCode
                                tmSdf.iLen = tmCClf.iLen
                                If ((tmCChf.sType = "C") Or (tmCChf.sType = "V") Or ((tmCChf.sType = "M") And (tgSpf.sSchdPromo = "Y")) Or ((tmCChf.sType = "S") And (tgSpf.sSchdPSA = "Y")) Or ((tmCChf.sType = "T") And (tgSpf.sSchdRemnant = "Y"))) And (tmSdf.sSpotType <> "X") Then
                                    tmSdf.sSpotType = "A"
                                End If
                                'If (llSpotTime < llStartTime) Then
                                '    slTime = gCurrencyToTime(CCur(llStartTime))
                                '    gPackTime slTime, tmSdf.iTime(0), tmSdf.iTime(1)
                                '    ilSpotStatus = 2    'Force key read
                                'End If
                                'If (llSpotTime > llEndTime) Then
                                '    slTime = gCurrencyToTime(CCur(llStartTime))
                                '    gPackTime slTime, tmSdf.iTime(0), tmSdf.iTime(1)
                                '    ilSpotStatus = 2    'Force key read
                                'End If
                                ilTimeFound = False
                                For ilLoop = LBound(llStartTime) To UBound(llStartTime) Step 1
                                    If (llSpotTime >= llStartTime(ilLoop)) And (llSpotTime <= llEndTime(ilLoop)) Then
                                        ilTimeFound = True
                                        Exit For
                                    End If
                                Next ilLoop
                                If Not ilTimeFound Then
                                    slTime = gCurrencyToTime(CCur(llStartTime(LBound(llStartTime))))
                                    gPackTime slTime, tmSdf.iTime(0), tmSdf.iTime(1)
                                    ilSpotStatus = 2    'Force key read
                                End If
                                'Fix missed time if outside limits
                                If tmSdf.sSchStatus = "M" Then
                                    tmSdf.sXCrossMidnight = "N"
                                End If
                                'tmSdf.sWasMG = "N"
                                'tmSdf.sFromWorkArea = "N"
                                ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
                                If igDoEvent Then
                                    DoEvents
                                End If
                                If ilRet = BTRV_ERR_CONFLICT Then
                                    '2/21/11: Replace GetDirect with GetEqual
                                    'ilRet1 = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, lmSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                    tmSdfSrchKey3.lCode = llSDFCode
                                    ilRet1 = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                                    If (tmSdf.sSchStatus = "O") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "S") Then
                                        ilRet = BTRV_ERR_NONE
                                        Exit Do
                                    End If
                                    If ilRet1 <> BTRV_ERR_NONE Then
                                        mValidateSpots = False
                                        Exit Function
                                    End If
                                End If
                            Loop While ilRet = BTRV_ERR_CONFLICT
                            If ilRet <> BTRV_ERR_NONE Then
                                mValidateSpots = False
                                Exit Function
                            End If
                            '2/21/11: Replace GetDirect with GetEqual
                            ''Reposition for GetNext if ilSpotStatus = 0 or 1
                            'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, lmSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                            'If igDoEvent Then
                            '    DoEvents
                            'End If
                            'If ilRet <> BTRV_ERR_NONE Then
                            '    mValidateSpots = False
                            '    Exit Function
                            'End If
                        End If
                    End If
                    '2/21/11: Replace GetDirect with GetEqual
                    'If (ilSpotStatus = 2) Or (ilSpotStatus = -1) Then
                    If (ilSpotStatus > 0) Or (ilSpotStatus = -1) Or (ilCheckTime) Then
                        tgSdfSrchKey.iVefCode = imCVefCode
                        tgSdfSrchKey.lChfCode = tmCChf.lCode
                        tgSdfSrchKey.iLineNo = tmCClf.iLine
                        tgSdfSrchKey.lFsfCode = tmCFsf.lCode
                        slDate = Format$(llDate, "m/d/yy")
                        gPackDate slDate, ilDate0, ilDate1
                        tgSdfSrchKey.iDate(0) = ilDate0
                        tgSdfSrchKey.iDate(1) = ilDate1
                        'Select Case ilPass
                        '    Case 0
                                tgSdfSrchKey.sSchStatus = " "   'All spots
                        '    Case 1
                        '        tgSdfSrchKey.sSchStatus = "O"   'Outside spots
                        '    Case 2
                        '        tgSdfSrchKey.sSchStatus = "G"   'MG scheduled spots
                        '    Case 3
                        '        tgSdfSrchKey.sSchStatus = "S"   'Scheduled spots
                        'End Select
                        tgSdfSrchKey.iTime(0) = 0   'tmSdf.iTime(0)
                        tgSdfSrchKey.iTime(1) = 0   'tmSdf.iTime(1)
                        ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    Else
                        ilRet = btrGetNext(hmSdf, tmSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                Loop
            End If
        Next ilPassNo
    Next ilPass
    'If length changed or advertiser, then change spots in the past
    'If (tmCClf.iLen <> tmPClf.iLen) Or ((tmCChf.iHdChg And &H1) <> 0) Then
    '    tgSdfSrchKey.iVefCode = imCVefCode
    '    tgSdfSrchKey.lChfCode = tmCChf.lCode
    '    tgSdfSrchKey.iLineNo = tmCClf.iLine
    '    tgSdfSrchKey.iDate(0) = 0
    '    tgSdfSrchKey.iDate(1) = 0
    '    tgSdfSrchKey.sSchStatus = " "   'All spots
    '    tgSdfSrchKey.iTime(0) = 0
    '    tgSdfSrchKey.iTime(1) = 0
    '    ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    '    Do While (ilRet = BTRV_ERR_NONE) And (tmSdf.iVefCode = imCVefCode) And (tmSdf.lChfCode = tmCChf.lCode) And (tmSdf.iLineNo = tmCClf.iLine)
    '        gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
    '        If gDateValue(slDate) >= llEarliestAllowedDate Then
    '            Exit Do
    '        End If
    '        ilRet = btrGetPosition(hmSdf, lmSdfRecPos)
    '        Do
    '            tmSdf.iAdfCode = tmCChf.iAdfCode
    '            tmSdf.iLen = tmCClf.iLen
    '            ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
    '            If ilRet = BTRV_ERR_CONFLICT Then
    '                ilRet1 = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, lmSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
    '            End If
    '        Loop While ilRet = BTRV_ERR_CONFLICT
    '        ilRet = btrGetNext(hmSdf, tmSdf, imSdfRecLen, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    '    Loop
    'End If
    'ReDim tgSpotMove(1 To 1) As SPOTMOVE
    ReDim tgSpotMove(0 To 0) As SPOTMOVE
    mValidateSpots = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mVehLock                        *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Lock Vehicles to avoid conflicts*
'*                     with spots                      *
'*                                                     *
'*******************************************************
Function mVehLock() As Integer
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilLoop                        ilFound                       ilTest                    *
'*  llRecPos                      ilRet                         ilCVsf                    *
'*  tlClf                                                                                 *
'******************************************************************************************

    ReDim tmVehLock(0 To 0) As Integer  'Vehicles locked when scheduling contract
'    For ilLoop = LBound(tmClfExt) To UBound(tmClfExt) - 1 Step 1
'        If igDoEvent Then
'            DoEvents
'        End If
'        llRecPos = tmClfExt(ilLoop).lChfCode    'lChfCode replaced with line record position
'        ilRet = btrGetDirect(hmClf, tlClf, imClfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
'        If igDoEvent Then
'            DoEvents
'        End If
'        If ilRet <> BTRV_ERR_NONE Then
'            mVehLock = False
'            Exit Function
'        End If
'        tmVefSrchKey.iCode = tlClf.iVefCode
'        ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
'        If igDoEvent Then
'            DoEvents
'        End If
'        If ilRet <> BTRV_ERR_NONE Then
'            mVehLock = False
'            Exit Function
'        End If
'        If tmVef.sType <> "P" Then  'Bypass package vehicle
'            If tmVef.sType = "V" Then
'                tmVsfSrchKey.lCode = tmVef.lVsfCode
'                ilRet = btrGetEqual(hmVsf, tmCVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
'                If igDoEvent Then
'                    DoEvents
'                End If
'                If ilRet <> BTRV_ERR_NONE Then
'                    mVehLock = False
'                    Exit Function
'                End If
'                For ilCVsf = UBound(tmCVsf.iFSCode) To LBound(tmCVsf.iFSCode) + 1 Step -1
'                    tmCVsf.iFSCode(ilCVsf - 1) = tmCVsf.iFSCode(ilCVsf - 1)
'                    tmCVsf.iNoSpots(ilCVsf - 1) = tmCVsf.iNoSpots(ilCVsf - 1)
'                Next ilCVsf
'            Else
'                For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
'                    tmCVsf.iFSCode(ilCVsf) = 0
'                    tmCVsf.iNoSpots(ilCVsf) = 0
'                Next ilCVsf
'                tmCVsf.iFSCode(LBound(tmCVsf.iFSCode)) = tlClf.iVefCode
'                tmCVsf.iNoSpots(LBound(tmCVsf.iFSCode)) = 1
'            End If
'            For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
'                If tmCVsf.iFSCode(ilCVsf) > 0 Then
'                    ilFound = False
'                    For ilTest = LBound(tmVehLock) To UBound(tmVehLock) - 1 Step 1
'                        If tmVehLock(ilTest) = tmCVsf.iFSCode(ilCVsf) Then
'                            ilFound = True
'                            Exit For
'                        End If
'                    Next ilTest
'                    If Not ilFound Then
'                        'Do
'                            tmVefSrchKey.iCode = tmCVsf.iFSCode(ilCVsf)
'                            'ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
'                            ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_MULT_NOWAIT, SETFORWRITE)   'Get first record as starting point of extend operation
'                            If igDoEvent Then
'                                DoEvents
'                            End If
'                            If ilRet <> BTRV_ERR_NONE Then
'                                mVehUnlock
'                                mVehLock = False
'                                Exit Function
'                            End If
'                            'If tmVef.sSpotLock = "Y" Then
'                            '    mVehUnlock
'                            '    mVehLock = False
'                            '    Exit Function
'                            'Else
'                            '    tmVef.sSpotLock = "Y"
'                            '    ilRet = btrUpdate(hmVef, tmVef, imVefRecLen)
'                            'End If
'                        'Loop While ilRet = BTRV_ERR_CONFLICT
'                        'If ilRet <> BTRV_ERR_NONE Then
'                        '    mVehUnlock
'                        '    mVehLock = False
'                        '    Exit Function
'                        'End If
'                        tmVehLock(UBound(tmVehLock)) = tmVef.iCode
'                        ReDim Preserve tmVehLock(0 To UBound(tmVehLock) + 1) As Integer 'Vehicles locked when scheduling contract
'                        If igDoEvent Then
'                            DoEvents
'                        End If
'                    End If
'                End If
'            Next ilCVsf
'        End If
'    Next ilLoop
    mVehLock = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mVehUnlock                      *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Unlock Vehicles                 *
'*                                                     *
'*******************************************************
Sub mVehUnlock()
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilRet                                                                                 *
'******************************************************************************************

'    'Ignore I/O errors
'    'For ilLoop = LBound(tmVehLock) To UBound(tmVehLock) - 1 Step 1
'    '    Do
'    '        tmVefSrchKey.iCode = tmVehLock(ilLoop)
'    '        ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
'    '        If ilRet = BTRV_ERR_NONE Then
'    '            tmVef.sSpotLock = " "
'    '            ilRet = btrUpdate(hmVef, tmVef, imVefRecLen)
'    '        End If
'    '    Loop While ilRet = BTRV_ERR_CONFLICT
'    'Next ilLoop
'    ilRet = btrUnlock(hmVef, BTRV_UNLOCK_MULTIPLE)
    ReDim tmVehLock(0 To 0) As Integer  'Vehicles locked when scheduling contract
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mMoveFeedToCntr                 *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Move Feed to Contract           *
'*                                                     *
'*******************************************************
Public Sub gMoveFeedToCntr(tlFsf As FSF, tlRdf As RDF, tlChf As CHF, tlClf As CLF, tlCff() As CFF, hlFnf As Integer, hlPrf As Integer)
    Dim ilLoop As Integer
    Dim ilRet As Integer
    Dim ilDay As Integer
    Dim slSTime As String
    Dim slETime As String
    Dim llCffDate As Long
    Dim llSTime As Long
    Dim llETime As Long

    tlChf.lCode = 0
    tlChf.iAdfCode = tlFsf.iAdfCode
    tlChf.iAgfCode = 0
    tlChf.iMnfComp(0) = tlFsf.iMnfComp1
    tlChf.iMnfComp(1) = tlFsf.iMnfComp2
    tlChf.iMnfExcl(0) = 0
    tlChf.iMnfExcl(1) = 0
    tlChf.sType = ""
    tlChf.iPctTrade = 0
    tlChf.lChfCode = 0
    tlChf.lCxfCode = 0
    tlChf.iStartDate(0) = tlFsf.iStartDate(0)
    tlChf.iStartDate(1) = tlFsf.iStartDate(1)
    tlChf.iSlfCode(0) = 0
    tlChf.lSifCode = 0
    tlChf.sProduct = ""     'should get the product from fsf
    imPrfRecLen = Len(tmPrf)
    tmPrfSrchKey0.lCode = tlFsf.lPrfCode
    ilRet = btrGetEqual(hlPrf, tmPrf, imPrfRecLen, tmPrfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If (ilRet = BTRV_ERR_NONE) Then
        tlChf.sProduct = tmPrf.sName
    End If

    tlClf.sExtra = ""
    tlClf.lChfCode = 0
    tlClf.iLine = 0
    tlClf.iLen = tlFsf.iLen
    tlClf.sType = "S"
    tlClf.iEntryDate(0) = tlFsf.iEnterDate(0)
    tlClf.iEntryDate(1) = tlFsf.iEnterDate(1)
    tlClf.sBB = "N"
    tlClf.iStartTime(0) = 1
    tlClf.iStartTime(1) = 0
    tlClf.iVefCode = tmCFsf.iVefCode
    tlClf.iPriority = 1
    tlClf.lCxfCode = 0
    tlClf.iCntRevNo = 0
    tlClf.iPropVer = 0
    tlClf.iBBCloseLen = 0
    tlClf.iBBOpenLen = 0
    tlClf.iPosition = 0
    For ilDay = 0 To 6 Step 1
        tlClf.sPrefDays(ilDay) = ""
    Next ilDay
    gPackTime "", tlClf.iPrefStartTime(0), tlClf.iPrefStartTime(1)
    gPackTime "", tlClf.iPrefEndTime(0), tlClf.iPrefEndTime(1)
    tlClf.sOV2DefinedBits = Chr(&H0)
    tlClf.iPctAllocation = 0
    tlClf.lAcquisitionCost = 0
    tlClf.sSoloAvail = ""
    tlClf.lRafCode = 0

    ReDim tlCff(0 To 1) As CFF
    tlCff(0).lChfCode = 0
    tlCff(0).iClfLine = 0
    tlCff(0).iCntRevNo = 0
    tlCff(0).iPropVer = 0
    tlCff(0).iStartDate(0) = tlFsf.iStartDate(0)
    tlCff(0).iStartDate(1) = tlFsf.iStartDate(1)
    If tlFsf.sSchStatus = "D" Then
        gUnpackDateLong tlCff(0).iStartDate(0), tlCff(0).iStartDate(1), llCffDate
        llCffDate = llCffDate - 1
        gPackDateLong llCffDate, tlCff(0).iEndDate(0), tlCff(0).iEndDate(1)
    Else
        tlCff(0).iEndDate(0) = tlFsf.iEndDate(0)
        tlCff(0).iEndDate(1) = tlFsf.iEndDate(1)
    End If
    tlCff(0).sDyWk = tlFsf.sDyWk
    If tlFsf.sDyWk <> "D" Then
        tlCff(0).iSpotsWk = tlFsf.iNoSpots
        tlCff(0).iXSpotsWk = 0
        For ilDay = 0 To 6 Step 1
            If tlFsf.iDays(ilDay) <> 0 Then
                tlCff(0).iDay(ilDay) = 1
            Else
                tlCff(0).iDay(ilDay) = 0
            End If
            tlCff(0).sXDay(ilDay) = "0"
        Next ilDay
    Else
        tlCff(0).iSpotsWk = 0
        tlCff(0).iXSpotsWk = 0
        For ilDay = 0 To 6 Step 1
            tlCff(0).iDay(ilDay) = tlFsf.iDays(ilDay)
            tlCff(0).sXDay(ilDay) = "0"
        Next ilDay
    End If
    tlCff(0).sDelete = "N"

    tlRdf.iLtfCode(0) = 0
    tlRdf.iLtfCode(1) = 0
    tlRdf.iLtfCode(2) = 0
    For ilLoop = LBound(tlRdf.iStartTime, 2) To UBound(tlRdf.iStartTime, 2) Step 1
        tlRdf.iSpotPct(ilLoop) = 0
        If ilLoop <> UBound(tlRdf.iStartTime, 2) Then
            tlRdf.iStartTime(0, ilLoop) = 1
            tlRdf.iStartTime(1, ilLoop) = 0
        Else
            gUnpackTimeLong tlFsf.iStartTime(0), tlFsf.iStartTime(1), False, llSTime
            gUnpackTimeLong tlFsf.iEndTime(0), tlFsf.iEndTime(1), True, llETime
            If llETime = llSTime Then
                tlRdf.iStartTime(0, ilLoop) = tlFsf.iStartTime(0)
                tlRdf.iStartTime(1, ilLoop) = tlFsf.iStartTime(1)
                llETime = llETime + 1
                gPackTimeLong llETime, tlRdf.iEndTime(0, ilLoop), tlRdf.iEndTime(1, ilLoop)
            Else
                tlRdf.iStartTime(0, ilLoop) = tlFsf.iStartTime(0)
                tlRdf.iStartTime(1, ilLoop) = tlFsf.iStartTime(1)
                tlRdf.iEndTime(0, ilLoop) = tlFsf.iEndTime(0)
                tlRdf.iEndTime(1, ilLoop) = tlFsf.iEndTime(1)
            End If
            For ilDay = 0 To 6 Step 1
                If tlCff(0).iDay(ilDay) > 0 Then
                    'tlRdf.sWkDays(ilLoop, ilDay + 1) = "Y"
                    tlRdf.sWkDays(ilLoop, ilDay) = "Y"
                Else
                    'tlRdf.sWkDays(ilLoop, ilDay + 1) = "N"
                    tlRdf.sWkDays(ilLoop, ilDay) = "N"
                End If
            Next ilDay
            gUnpackTime tlFsf.iStartTime(0), tlFsf.iStartTime(1), "A", "1", slSTime
            gUnpackTime tlFsf.iEndTime(0), tlFsf.iEndTime(1), "A", "1", slETime
            tlRdf.sName = " " 'slSTime & "-" & slETime
        End If
    Next ilLoop
    tlRdf.sInOut = "N" 'Ignore In/Out rules
    tlRdf.ianfCode = 0
    'Try to book into avail first, then try into local
    imFnfRecLen = Len(tmFnf)
    tmFnfSrchKey0.iCode = tlFsf.iFnfCode
    ilRet = btrGetEqual(hlFnf, tmFnf, imFnfRecLen, tmFnfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If (ilRet = BTRV_ERR_NONE) Then
        If tmFnf.ianfCode > 0 Then
            tlRdf.sInOut = "I"
            tlRdf.ianfCode = tmFnf.ianfCode
        End If
    End If
End Sub

Private Sub mGetFeedSpots()
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Labels (Marked)                                                                  *
'*  mGetFeedSpotsErr                                                                      *
'******************************************************************************************

    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
    Dim ilExtLen As Integer
    Dim llRecPos As Long        'Record location
    Dim ilRet As Integer
    Dim llNoRec As Long         'Number of records in Sof
    Dim ilUpper As Integer
    Dim ilOffSet As Integer
    ReDim lmFsfCode(0 To 0) As Long

    btrExtClear hmFsf   'Clear any previous extend operation
    ilExtLen = Len(tmCFsf)  'Extract operation record size
    imFsfRecLen = Len(tmCFsf)
    ilRet = btrGetFirst(hmFsf, tmCFsf, imFsfRecLen, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)
    If ilRet = BTRV_ERR_KEY_NOT_FOUND Then
        ilRet = BTRV_ERR_END_OF_FILE
    Else
        If ilRet <> BTRV_ERR_NONE Then
            Exit Sub
        End If
    End If
    If ilRet <> BTRV_ERR_END_OF_FILE Then
        llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlAdf) 'Obtain number of records
        Call btrExtSetBounds(hmFsf, llNoRec, -1, "UC", "FSF", "") '"EG") 'Set extract limits (all records)
        ilOffSet = gFieldOffset("FSF", "FSFSCHSTATUS") 'GetOffSetForInt(tmCFsf, tmCFsf.iSlfCode)
        tlCharTypeBuff.sType = "F"
        ilRet = btrExtAddLogicConst(hmFsf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_LAST_TERM, tlCharTypeBuff, 1)
'        On Error GoTo mGetFeedSpotsErr
'        gBtrvErrorMsg ilRet, "mGetFeedSpots (btrExtAddLogicConst):" & "Fsf.Btr", FeedSpot
'        On Error GoTo 0
        If ilRet <> BTRV_ERR_NONE Then
            Exit Sub
        End If
        ilOffSet = 0
        ilRet = btrExtAddField(hmFsf, ilOffSet, ilExtLen)  'Extract First Name field
        'ilRet = btrExtGetNextExt(hmRpf)    'Extract record
        ilRet = btrExtGetNext(hmFsf, tmCFsf, ilExtLen, llRecPos)
        If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
'            On Error GoTo mGetFeedSpotsErr
'            gBtrvErrorMsg ilRet, "mGetFeedSpots (btrExtGetNextExt):" & "Fsf.Btr", FeedSpot
'            On Error GoTo 0
            If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                Exit Sub
            End If
            'ilRet = btrExtGetFirst(hmRpf, tlRpfExt, ilExtLen, llRecPos)
            ilExtLen = Len(tmCFsf)  'Extract operation record size
            Do While ilRet = BTRV_ERR_REJECT_COUNT
                ilRet = btrExtGetNext(hmFsf, tmCFsf, ilExtLen, llRecPos)
            Loop
            Do While ilRet = BTRV_ERR_NONE
                ilUpper = UBound(lmFsfCode)
                lmFsfCode(ilUpper) = tmCFsf.lCode
                ReDim Preserve lmFsfCode(0 To ilUpper + 1) As Long
                ilExtLen = Len(tmCFsf)  'Extract operation record size
                ilRet = btrExtGetNext(hmFsf, tmCFsf, ilExtLen, llRecPos)
                Do While ilRet = BTRV_ERR_REJECT_COUNT
                    ilRet = btrExtGetNext(hmFsf, tmCFsf, ilExtLen, llRecPos)
                Loop
            Loop
        End If
    End If
    Exit Sub
mGetFeedSpotsErr: 'VBC NR
    On Error GoTo 0
    Exit Sub
End Sub

Private Sub mAdjFeedCopy()
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim ilFound As Integer
    Dim slDate As String
    Dim ilDate0 As Integer
    Dim ilDate1 As Integer
    Dim llEarliestAllowedDate As Long
    Dim llDate As Long
    Dim llNowDate As Long
    Dim tlSdf As SDF
    ReDim llSDFCode(0 To 0) As Long

    llEarliestAllowedDate = lmEarliestAllowedDate
    llNowDate = gDateValue(Format$(gNow(), "m/d/yy"))
    llDate = llNowDate + 1
    If llDate < llEarliestAllowedDate Then
        llEarliestAllowedDate = llDate
    End If
    tgSdfSrchKey.iVefCode = imCVefCode
    tgSdfSrchKey.lChfCode = tmCChf.lCode
    tgSdfSrchKey.iLineNo = tmPclf.iLine
    tgSdfSrchKey.lFsfCode = tmCFsf.lCode
    slDate = Format$(llEarliestAllowedDate, "m/d/yy")
    gPackDate slDate, ilDate0, ilDate1
    tgSdfSrchKey.iDate(0) = ilDate0
    tgSdfSrchKey.iDate(1) = ilDate1
    tgSdfSrchKey.sSchStatus = " "
    tgSdfSrchKey.iTime(0) = 0
    tgSdfSrchKey.iTime(1) = 0
    ilRet = btrGetGreaterOrEqual(hmSdf, tlSdf, imSdfRecLen, tgSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tlSdf.iVefCode = imCVefCode) And (tlSdf.lChfCode = tmCChf.lCode) And (tlSdf.iLineNo = tmPclf.iLine) And (tlSdf.lFsfCode = tmCFsf.lCode)
        If igDoEvent Then
            DoEvents
        End If
        llSDFCode(UBound(llSDFCode)) = tlSdf.lCode
        ReDim Preserve llSDFCode(0 To UBound(llSDFCode) + 1) As Long
        ilRet = btrGetNext(hmSdf, tlSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    tmSmfSrchKey.lChfCode = tmCChf.lCode
    tmSmfSrchKey.iLineNo = tmPclf.iLine
    tmSmfSrchKey.lFsfCode = tmCFsf.lCode
    slDate = Format$("1/1/90", "m/d/yy")
    gPackDate slDate, ilDate0, ilDate1
    tmSmfSrchKey.iMissedDate(0) = ilDate0
    tmSmfSrchKey.iMissedDate(1) = ilDate1
    ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tmCChf.lCode) And (tmSmf.iLineNo = tmPclf.iLine) And (tmSmf.lFsfCode = tmCFsf.lCode)
        If igDoEvent Then
            DoEvents
        End If
        ilFound = False
        For ilLoop = 0 To UBound(llSDFCode) - 1 Step 1
            If llSDFCode(ilLoop) = tmSmf.lSdfCode Then
                ilFound = True
                Exit For
            End If
        Next ilLoop
        If Not ilFound Then
            llSDFCode(UBound(llSDFCode)) = tmSmf.lSdfCode
            ReDim Preserve llSDFCode(0 To UBound(llSDFCode) + 1) As Long
        End If

        ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    Loop
    For ilLoop = 0 To UBound(llSDFCode) - 1 Step 1
        Do
            tmSdfSrchKey3.lCode = llSDFCode(ilLoop)
            ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
            If igDoEvent Then
                DoEvents
            End If
            If ilRet = BTRV_ERR_NONE Then
                If tmCFsf.lCifCode = 0 Then
                    tlSdf.sPtType = "0"
                    tlSdf.lCopyCode = 0
                    tlSdf.iRotNo = 0
                Else
                    tlSdf.sPtType = "1"
                    tlSdf.lCopyCode = tmCFsf.lCifCode
                End If
            Else
                Exit Do
            End If
            gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llDate
            If llDate > llEarliestAllowedDate Then
                ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
            Else
                ilRet = BTRV_ERR_NONE
            End If
            If igDoEvent Then
                DoEvents
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
    Next ilLoop
    Erase llSDFCode
End Sub

Public Function gPreferredDefined(tlClf As CLF, ilDays() As Integer, llSTime As Long, llETime As Long) As Integer
    Dim ilDay As Integer
    Dim ilPreferredDays As Integer

    gPreferredDefined = False
    If tgSaf(0).iPreferredPct <= 0 Then
        Exit Function
    End If
    ilPreferredDays = True
    For ilDay = 0 To 6 Step 1
        ilDays(ilDay) = -1
        If Trim$(tlClf.sPrefDays(ilDay)) = "" Then
            ilPreferredDays = False
        End If
    Next ilDay
    If ilPreferredDays Then
        gPreferredDefined = True
        For ilDay = 0 To 6 Step 1
            If Trim$(tlClf.sPrefDays(ilDay)) = "Y" Then
                ilDays(ilDay) = 0
            Else
                ilDays(ilDay) = 1
            End If
        Next ilDay
    End If
    gUnpackTimeLong tlClf.iPrefStartTime(0), tlClf.iPrefStartTime(1), False, llSTime
    gUnpackTimeLong tlClf.iPrefEndTime(0), tlClf.iPrefEndTime(1), True, llETime
    If (llSTime <> -1) And (llETime <> -1) Then
        gPreferredDefined = True
    End If
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:gCgfToCff                       *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Create CFF from CGF image       *
'*                                                     *
'*******************************************************
Public Sub gCgfToCff(tlClf As CLF, tlCgf As CGF, tlCff() As CFF)
    Dim ilDay As Integer
    Dim llDate As Long


    ReDim tlCff(0 To 1) As CFF
    tlCff(0).lChfCode = tlClf.lChfCode
    tlCff(0).iClfLine = tlClf.iLine
    tlCff(0).iCntRevNo = tlClf.iCntRevNo
    tlCff(0).iPropVer = tlClf.iPropVer
    tlCff(0).iStartDate(0) = tlCgf.iAirDate(0)
    tlCff(0).iStartDate(1) = tlCgf.iAirDate(1)
    tlCff(0).iEndDate(0) = tlCff(0).iStartDate(0)
    tlCff(0).iEndDate(1) = tlCff(0).iStartDate(1)
    tlCff(0).sDyWk = "D"
    tlCff(0).iSpotsWk = 0
    tlCff(0).iXSpotsWk = 0
    For ilDay = 0 To 6 Step 1
        tlCff(0).iDay(ilDay) = 0
        tlCff(0).sXDay(ilDay) = "0"
    Next ilDay
    'UnpackDateLong tlCff(0).iStartDate(0), tlCff(0).iStartDate(1), llDate
    gUnpackDateLong tlCgf.iAirDate(0), tlCgf.iAirDate(1), llDate
    ilDay = gWeekDayLong(llDate)
    tlCff(0).iDay(ilDay) = tlCgf.iNoSpots
    tlCff(0).sDelete = "N"
End Sub

Public Sub gBuildStationsFromRAF(hlRaf As Integer, hlSef As Integer, llRafCode As Long, slInclExcl As String, tlStationsClf() As INTKEY0, ilMapExlcToIncl As Integer)
    Dim ilRet As Integer
    Dim ilShtt As Integer
    Dim ilLoop As Integer
    Dim ilFound As Integer
    'ReDim tltempstations(1 To 1) As INTKEY0
    ReDim tltempstations(0 To 0) As INTKEY0

    'ReDim tlStationsClf(1 To 1) As INTKEY0
    ReDim tlStationsClf(0 To 0) As INTKEY0
    If llRafCode <= 0 Then
        Exit Sub
    End If
    If ((Asc(tgSpf.sUsingFeatures2) And SPLITNETWORKS) <> SPLITNETWORKS) Then
        Exit Sub
    End If
    imRafRecLen = Len(tmRaf)
    tmRafSrchKey.lCode = llRafCode
    ilRet = btrGetEqual(hlRaf, tmRaf, imRafRecLen, tmRafSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
    slInclExcl = tmRaf.sInclExcl
    imSefRecLen = Len(tmSef)
    tmSefSrchKey1.lRafCode = tmRaf.lCode
    tmSefSrchKey1.iSeqNo = 0
    ilRet = btrGetGreaterOrEqual(hlSef, tmSef, imSefRecLen, tmSefSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)
    Do While (ilRet = BTRV_ERR_NONE) And (tmSef.lRafCode = tmRaf.lCode)
        Select Case tmRaf.sCategory
            Case "M"    'market
                ilRet = mBuildStationsByIntSort(tgMktSort(), tmSef.iIntCode, tltempstations())
            'Case "O"    'Owner
            '    ilRet = mBuildStationsByIntSort(tgOwnerSort(), tmSef.iIntCode, tlTempStations())
            'Case "Z"    'Zip Code
            '    ilRet = mBuildStationsByStrSort(tgZipSort(), tmSef.sName, tlTempStations())
            Case "N"    'State
                ilRet = mBuildStationsByStrSort(tgStateSort(), tmSef.sName, tltempstations())
            Case "F"    'Format
                ilRet = mBuildStationsByIntSort(tgFmtSort(), tmSef.iIntCode, tltempstations())
            Case "T"    'Time zone
                ilRet = mBuildStationsByIntSort(tgTztSort(), tmSef.iIntCode, tltempstations())
            Case "S"    'Station
                tltempstations(UBound(tltempstations)).iCode = tmSef.iIntCode
                'ReDim Preserve tltempstations(1 To UBound(tltempstations) + 1) As INTKEY0
                ReDim Preserve tltempstations(0 To UBound(tltempstations) + 1) As INTKEY0
        End Select
        ilRet = btrGetNext(hlSef, tmSef, imSefRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    If (slInclExcl = "I") Or ((slInclExcl = "E") And (Not ilMapExlcToIncl)) Then
        'ReDim tlStationsClf(1 To UBound(tltempstations)) As INTKEY0
        ReDim tlStationsClf(0 To UBound(tltempstations)) As INTKEY0
        For ilLoop = LBound(tltempstations) To UBound(tltempstations) - 1 Step 1
            tlStationsClf(ilLoop).iCode = tltempstations(ilLoop).iCode
        Next ilLoop
    Else
        For ilShtt = LBound(tgStations) To UBound(tgStations) - 1 Step 1
            ilFound = False
            For ilLoop = LBound(tltempstations) To UBound(tltempstations) - 1 Step 1
                If tgStations(ilShtt).iCode = tltempstations(ilLoop).iCode Then
                    ilFound = True
                    Exit For
                End If
            Next ilLoop
            If Not ilFound Then
                tlStationsClf(UBound(tlStationsClf)).iCode = tgStations(ilShtt).iCode
                'ReDim Preserve tlStationsClf(1 To UBound(tlStationsClf) + 1) As INTKEY0
                ReDim Preserve tlStationsClf(LBound(tlStationsClf) To UBound(tlStationsClf) + 1) As INTKEY0
            End If
        Next ilShtt
    End If
    'If UBound(tlStationsClf) - 1 > 1 Then
    '    ArraySortTyp fnAV(tlStationsClf(), 1), UBound(tlStationsClf) - 1, 0, LenB(tlStationsClf(1)), 0, -1, 0
    If UBound(tlStationsClf) > 1 Then
        ArraySortTyp fnAV(tlStationsClf(), 0), UBound(tlStationsClf), 0, LenB(tlStationsClf(0)), 0, -1, 0
    End If
    Erase tltempstations
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:gBinarySearchSlf                *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Obtain Advt index into tgCommAdf*
'*                                                     *
'*******************************************************
Private Function mBuildStationsByIntSort(tlSort() As REGIONINTSORT, ilCode As Integer, tlStationsClf() As INTKEY0) As Integer
    Dim ilMin As Integer
    Dim ilMax As Integer
    Dim ilMiddle As Integer
    Dim ilresult As Integer
    Dim ilLoop As Integer

    ilresult = -1
    ilMin = LBound(tlSort)
    ilMax = UBound(tlSort) - 1
    Do While ilMin <= ilMax
        ilMiddle = (ilMin + ilMax) \ 2
        If ilCode = tlSort(ilMiddle).iIntCode Then
            'found the match
            ilresult = ilMiddle
            Exit Do
        ElseIf ilCode < tlSort(ilMiddle).iIntCode Then
            ilMax = ilMiddle - 1
        Else
            'search the right half
            ilMin = ilMiddle + 1
        End If
    Loop
    If ilresult <> -1 Then
        For ilLoop = ilresult To UBound(tlSort) - 1 Step 1
            If tlSort(ilLoop).iIntCode = ilCode Then
                tlStationsClf(UBound(tlStationsClf)).iCode = tlSort(ilLoop).iShttCode
                'ReDim Preserve tlStationsClf(1 To UBound(tlStationsClf) + 1) As INTKEY0
                ReDim Preserve tlStationsClf(LBound(tlStationsClf) To UBound(tlStationsClf) + 1) As INTKEY0
            Else
                Exit For
            End If
        Next ilLoop
        For ilLoop = ilresult - 1 To LBound(tlSort) Step -1
            If tlSort(ilLoop).iIntCode = ilCode Then
                tlStationsClf(UBound(tlStationsClf)).iCode = tlSort(ilLoop).iShttCode
                ReDim Preserve tlStationsClf(LBound(tlStationsClf) To UBound(tlStationsClf) + 1) As INTKEY0
            Else
                Exit For
            End If
        Next ilLoop
        mBuildStationsByIntSort = True
    Else
        mBuildStationsByIntSort = False
    End If
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:gBinarySearchSlf                *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Obtain Advt index into tgCommAdf*
'*                                                     *
'*******************************************************
Private Function mBuildStationsByStrSort(tlSort() As REGIONSTRSORT, slInCode As String, tlStationsClf() As INTKEY0) As Integer
    Dim ilMin As Integer
    Dim ilMax As Integer
    Dim ilMiddle As Integer
    Dim slCode As String
    Dim ilresult As Integer
    Dim ilLoop As Integer

    slCode = Trim$(slInCode)
    ilresult = -1
    ilMin = LBound(tlSort)
    ilMax = UBound(tlSort) - 1
    Do While ilMin <= ilMax
        ilMiddle = (ilMin + ilMax) \ 2
        If StrComp(slCode, Trim$(tlSort(ilMiddle).sStr), vbTextCompare) = 0 Then
            'found the match
            ilresult = ilMiddle
            Exit Do
        ElseIf StrComp(slCode, Trim$(tlSort(ilMiddle).sStr), vbTextCompare) > 0 Then
            ilMax = ilMiddle - 1
        Else
            'search the right half
            ilMin = ilMiddle + 1
        End If
    Loop
    If ilresult <> -1 Then
        For ilLoop = ilresult To UBound(tlSort) - 1 Step 1
            If StrComp(slCode, Trim$(tlSort(ilLoop).sStr), vbTextCompare) = 0 Then
                tlStationsClf(UBound(tlStationsClf)).iCode = tlSort(ilLoop).iShttCode
                ReDim Preserve tlStationsClf(LBound(tlStationsClf) To UBound(tlStationsClf) + 1) As INTKEY0
            Else
                Exit For
            End If
        Next ilLoop
        For ilLoop = ilresult - 1 To LBound(tlSort) Step -1
            If StrComp(slCode, Trim$(tlSort(ilLoop).sStr), vbTextCompare) = 0 Then
                tlStationsClf(UBound(tlStationsClf)).iCode = tlSort(ilLoop).iShttCode
                ReDim Preserve tlStationsClf(LBound(tlStationsClf) To UBound(tlStationsClf) + 1) As INTKEY0
            Else
                Exit For
            End If
        Next ilLoop
        mBuildStationsByStrSort = True
    Else
        mBuildStationsByStrSort = False
    End If
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:gBinarySearchSlf                *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Obtain Advt index into tgCommAdf*
'*                                                     *
'*******************************************************
Private Function mBinarySearchStations(ilCode As Integer, tlStationsClf() As INTKEY0) As Integer
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilLoop                                                                                *
'******************************************************************************************

    Dim ilMin As Integer
    Dim ilMax As Integer
    Dim ilMiddle As Integer

    ilMin = LBound(tlStationsClf)
    ilMax = UBound(tlStationsClf) - 1
    Do While ilMin <= ilMax
        ilMiddle = (ilMin + ilMax) \ 2
        If ilCode = tlStationsClf(ilMiddle).iCode Then
            'found the match
            mBinarySearchStations = ilMiddle
            Exit Function
        ElseIf ilCode < tlStationsClf(ilMiddle).iCode Then
            ilMax = ilMiddle - 1
        Else
            'search the right half
            ilMin = ilMiddle + 1
        End If
    Loop
    mBinarySearchStations = -1
End Function

Public Function gSplitNetworkStationConflicts(hlRaf As Integer, hlSef As Integer, hlSdf As Integer, hlClf As Integer, llSDFCode As Long, tlStationsClf() As INTKEY0, slClfInclExcl As String, ilStationCount As Integer) As Integer
    Dim tlSdf As SDF
    Dim ilRet As Integer
    Dim ilClf As Integer
    Dim ilTest As Integer
    Dim tlClfSrchKey As CLFKEY0
    Dim tlRafClf As CLF
    Dim slInclExcl As String

    'Get stations and see if in conflict
    gSplitNetworkStationConflicts = False
    If ((Asc(tgSpf.sUsingFeatures2) And SPLITNETWORKS) <> SPLITNETWORKS) Then
        Exit Function
    End If
    imSdfRecLen = Len(tlSdf)
    tmSdfSrchKey3.lCode = llSDFCode
    ilRet = btrGetEqual(hlSdf, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If igDoEvent Then
        DoEvents
    End If
    'Get Line to obtain raf
    imClfRecLen = Len(tlRafClf)
    tlClfSrchKey.lChfCode = tlSdf.lChfCode
    tlClfSrchKey.iLine = tlSdf.iLineNo
    tlClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
    tlClfSrchKey.iPropVer = 32000 ' Plug with very high number
    ilRet = btrGetGreaterOrEqual(hlClf, tlRafClf, imClfRecLen, tlClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)
    Do While (ilRet = BTRV_ERR_NONE) And (tlRafClf.lChfCode = tlSdf.lChfCode) And (tlRafClf.iLine = tlSdf.iLineNo) And (tlRafClf.sSchStatus <> "F") And (tlRafClf.sSchStatus <> "M") And (tlRafClf.sSchStatus <> "M")
        If igDoEvent Then
            DoEvents
        End If
        ilRet = btrGetNext(hlClf, tlRafClf, imClfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    If (ilRet = BTRV_ERR_NONE) And (tlRafClf.lChfCode = tlSdf.lChfCode) And (tlRafClf.iLine = tlSdf.iLineNo) Then
        'ilRet = mCheckForMatchingStation(hlRaf, hlSef, tlRafClf.lRafCode, tlStationsClf(), slInclExcl, ilStationCount)
        'If slInclExcl = "E" Then
        '    ilStationCount = UBound(tgStations) - ilStationCount - 1
        'End If
        'If (slClfInclExcl = slInclExcl) And (ilRet) Then
        '    gSplitNetworkStationConflicts = True
        'ElseIf (slClfInclExcl <> slInclExcl) And (Not ilRet) Then
        '    gSplitNetworkStationConflicts = True
        'End If
        'ReDim tlStationsTest(1 To 1) As INTKEY0
        ReDim tlStationsTest(0 To 0) As INTKEY0
        gBuildStationsFromRAF hlRaf, hlSef, tlRafClf.lRafCode, slInclExcl, tlStationsTest(), True
        ilStationCount = UBound(tlStationsTest) - 1
        For ilClf = LBound(tlStationsClf) To UBound(tlStationsClf) - 1 Step 1
            For ilTest = LBound(tlStationsTest) To UBound(tlStationsTest) - 1 Step 1
                If tlStationsClf(ilClf).iCode = tlStationsTest(ilTest).iCode Then
                    gSplitNetworkStationConflicts = True
                    Exit Function
                End If
            Next ilTest
        Next ilClf
    End If
End Function

Private Function mGetGameStatus(tlSdf As SDF) As String
    Dim ilRet As Integer
    mGetGameStatus = ""
    If (tlSdf.iGameNo > 0) And (tlSdf.lChfCode > 0) Then
        tmGsfSrchKey3.iVefCode = tlSdf.iVefCode
        tmGsfSrchKey3.iGameNo = tlSdf.iGameNo
        ilRet = btrGetEqual(hmGsf, tmGsf, imGsfRecLen, tmGsfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)
        Do While (ilRet = BTRV_ERR_NONE) And (tmGsf.iVefCode = tlSdf.iVefCode) And (tmGsf.iGameNo = tlSdf.iGameNo)
            If (tmGsf.iAirDate(0) = tmSdf.iDate(0)) And (tmGsf.iAirDate(1) = tmSdf.iDate(1)) Then
                Exit Do
            End If
            ilRet = btrGetNext(hmGsf, tmGsf, imGsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
        Loop
        If (ilRet = BTRV_ERR_NONE) And (tmGsf.iVefCode = tlSdf.iVefCode) And (tmGsf.iGameNo = tlSdf.iGameNo) Then
            mGetGameStatus = tmGsf.sGameStatus
        End If
    End If
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mPreemptMGOutsideSpots          *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Preempt spot from Ssf           *
'*                     Remove Extra Spots              *
'*                                                     *
'*******************************************************
Private Function mPreemptMGOutsideSpots(llChfCode As Long, ilLineNo As Integer, llFsfCode As Long, ilGameNo As Integer, llFromDate As Long) As Integer
'
'   mPreemptMGOutsideSpots llChfCode, ilLineNo, llFromDate, llToDate
'   Where:
'       llChfCode(I)- Contract code number
'       ilLineNo(I)- Contract line number
'       llFsfCode(I)- Feed code
'       llFromDate(I)- Start date for the removal of spots
'
'
    Dim ilRet As Integer
    Dim llDate As Long
    Dim ilDayIndex As Integer
    Dim ilFound As Integer
    Dim llSdfRecPos As Long
    Dim llStartDate As Long
    Dim slTime As String
    Dim llSDFDate As Long
    Dim llEarliestAllowedDate As Long
    Dim ilVpfIndex As Integer
    Dim llNowDate As Long
    Dim tlSdf As SDF
    Dim llLockRecCode As Long
    Dim slUserName As String
    Dim slChgType As String
    '3/14/13
    Dim llLLD As Long
    Dim llMonNowDate As Long
    Dim llFillTestDate As Long

    If llChfCode <= 0 Then
        mPreemptMGOutsideSpots = True
        Exit Function
    End If
    ilVpfIndex = gVpfFindIndex(imCVefCode)
    llEarliestAllowedDate = lmEarliestAllowedDate
    llNowDate = gDateValue(Format$(gNow(), "m/d/yy"))
    If ilVpfIndex <> -1 Then
        If tgVpf(ilVpfIndex).sMoveLLD = "Y" Then
            llDate = llNowDate + 1
            If llDate < llEarliestAllowedDate Then
                llEarliestAllowedDate = llDate
            End If
        End If
    End If
    '3/14/13:  Allow spots to be removed
    If (Asc(tgSpf.sUsingFeatures10) And REPLACEDELWKWITHFILLS) = REPLACEDELWKWITHFILLS Then
        llMonNowDate = gDateValue(gObtainPrevMonday(Format$(gNow(), "m/d/yy")))
        If ilVpfIndex <> -1 Then
            gUnpackDateLong tgVpf(ilVpfIndex).iLLD(0), tgVpf(ilVpfIndex).iLLD(1), llLLD
        Else
            llLLD = 0
        End If
        If llLLD > llMonNowDate + 6 Then
            llFillTestDate = llLLD
        Else
            llFillTestDate = llMonNowDate + 6
        End If
    End If
    llStartDate = llFromDate
    'If llEarliestAllowedDate > llStartDate Then
    '    llStartDate = llEarliestAllowedDate
    'End If
    slChgType = "M"
    'Prempt scheduled spots
    tmSdfSrchKey5.lCode = llChfCode
    ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey5, INDEXKEY5, BTRV_LOCK_NONE, SETFORWRITE)  'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tlSdf.lChfCode = llChfCode)
        If igDoEvent Then
            DoEvents
        End If
        ilFound = False
        gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llSDFDate
        If (tlSdf.iLineNo = ilLineNo) And (tlSdf.iGameNo = ilGameNo) And (llSDFDate >= llStartDate) Then
            If (tlSdf.sSpotType <> "O") And (tlSdf.sSpotType <> "C") Then
                If tlSdf.iGameNo <= 0 Then
                    llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + llSDFDate, True, slUserName)
                Else
                    llLockRecCode = gCreateLockRec(hmRlf, "S", "C", 65536 * tlSdf.iVefCode + tlSdf.iGameNo, True, slUserName)
                End If
                If llLockRecCode > 0 Then
                    ilRet = btrGetPosition(hmSdf, llSdfRecPos)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_NONE Then
                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                        mPreemptMGOutsideSpots = False
                        Exit Function
                    End If
                    ilDayIndex = gWeekDayLong(llSDFDate)
                    If igDoEvent Then
                        DoEvents
                    End If
                    If csiHandleValue(0, 15) > 0 Then
                        ilRet = btrBeginTrans(hmCHF, 1000)
                    Else
                        ilRet = btrBeginTrans(hmCHF, -1000)
                    End If
                    If igDoEvent Then
                        DoEvents
                    End If
                    If ilRet <> BTRV_ERR_NONE Then
                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                        mPreemptMGOutsideSpots = False
                        Exit Function
                    End If
                    If tlSdf.sSpotType <> "X" Then
                        If igDoEvent Then
                            DoEvents
                        End If
                        If gChgSchSpot(slChgType, hmSdf, tlSdf, hmSmf, ilGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf) Then
                            If igDoEvent Then
                                DoEvents
                            End If
                            ilRet = btrEndTrans(hmCHF)
                            gUnpackTime tlSdf.iTime(0), tlSdf.iTime(1), "A", "1", slTime
                            If igDoEvent Then
                                DoEvents
                            End If
                            ilRet = gObtainSsfForDateOrGame(imCVefCode, llSDFDate, slTime, ilGameNo, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex))
                            If igDoEvent Then
                                DoEvents
                            End If
                            If Not ilRet Then
                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                mPreemptMGOutsideSpots = False
                                Exit Function
                            End If
                            ilFound = True
                            If slChgType = "M" Then
                                'lgUnschRecPos(UBound(lgUnschRecPos)) = llSdfRecPos
                                'ReDim Preserve lgUnschRecPos(1 To UBound(lgUnschRecPos) + 1) As Long
                                lgUnschSdfCode(UBound(lgUnschSdfCode)) = tlSdf.lCode
                                'ReDim Preserve lgUnschSdfCode(1 To UBound(lgUnschSdfCode) + 1) As Long
                                ReDim Preserve lgUnschSdfCode(LBound(lgUnschSdfCode) To UBound(lgUnschSdfCode) + 1) As Long
                            End If
                            If igDoEvent Then
                                DoEvents
                            End If
                        Else
                            ilRet = btrAbortTrans(hmCHF)
                            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                            mPreemptMGOutsideSpots = False
                            Exit Function
                        End If
                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                    Else
                        If igDoEvent Then
                            DoEvents
                        End If
                        '3/14/13
                        If llSDFDate > llFillTestDate Then
                            If gChgSchSpot("D", hmSdf, tlSdf, hmSmf, ilGameNo, tmSmf, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex), hmSxf, hmGsf, hmGhf) Then
                                If igDoEvent Then
                                    DoEvents
                                End If
                                ilRet = btrEndTrans(hmCHF)
                                gUnpackTime tlSdf.iTime(0), tlSdf.iTime(1), "A", "1", slTime
                                ilRet = gObtainSsfForDateOrGame(imCVefCode, llSDFDate, slTime, ilGameNo, hmSsf, tgSsf(ilDayIndex), lgSsfDate(ilDayIndex), lgSsfRecPos(ilDayIndex))
                                If Not ilRet Then
                                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                    mPreemptMGOutsideSpots = False
                                    Exit Function
                                End If
                                ilFound = True
                            Else
                                ilRet = btrAbortTrans(hmCHF)
                                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                                mPreemptMGOutsideSpots = False
                                Exit Function
                            End If
                        End If
                        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, llLockRecCode)
                    End If
                End If
            End If
        End If
        If ilFound Then
            tmSdfSrchKey5.lCode = llChfCode
            ilRet = btrGetEqual(hmSdf, tlSdf, imSdfRecLen, tmSdfSrchKey5, INDEXKEY5, BTRV_LOCK_NONE, SETFORWRITE)  'Get first record as starting point of extend operation
        Else
            ilRet = btrGetNext(hmSdf, tlSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
        End If
        If igDoEvent Then
            DoEvents
        End If
    Loop
    mPreemptMGOutsideSpots = True
End Function

Public Sub gBuildStationsFromRAFByCallLetters(hlRaf As Integer, hlSef As Integer, hlVlf As Integer, hlAtt As Integer, llRafCode As Long, slStartDate As String, ilLnVefCode() As Integer, slInclExcl As String, tlStations() As REGIONSTATIONINFO, ilMapExlcToIncl As Integer)
    Dim ilRet As Integer
    Dim ilShtt As Integer
    Dim ilMkt As Integer
    Dim ilLoop As Integer
    Dim llStartDate As Long
    Dim llDropDate As Long
    Dim llOffAir As Long
    Dim ilVpf As Integer
    Dim ilVef As Integer
    Dim ilAVef As Integer
    Dim tlVef As VEF
    ReDim ilAVefCode(0 To 0) As Integer
    ReDim ilVefCode(0 To 0) As Integer
    'ReDim tltempstations(1 To 1) As INTKEY0
    ReDim tltempstations(0 To 0) As INTKEY0

    'ReDim tlStations(1 To 1) As REGIONSTATIONINFO
    ReDim tlStations(0 To 0) As REGIONSTATIONINFO
    If llRafCode <= 0 Then
        Exit Sub
    End If
    If ((Asc(tgSpf.sUsingFeatures2) And SPLITNETWORKS) <> SPLITNETWORKS) Then
        Exit Sub
    End If
    ilRet = gObtainStations()
    ilRet = gObtainMarkets()
    llStartDate = gDateValue(slStartDate)
    imAttRecLen = Len(tmAtt)
    For ilLoop = LBound(ilLnVefCode) To UBound(ilLnVefCode) - 1 Step 1
        ilVef = gBinarySearchVef(ilLnVefCode(ilLoop))
        If ilVef <> -1 Then
            If tgMVef(ilVef).sType = "S" Then
                '5/11/11: Allow Selling to be set to No
                'tlVef = tgMVef(ilVef)
                'gBuildLinkArray hlVlf, tlVef, slStartDate, ilAVefCode()
                'For ilAVef = 0 To UBound(ilAVefCode) - 1 Step 1
                '    ilVpf = gBinarySearchVpf(ilAVefCode(ilAVef))
                '    If ilVpf <> -1 Then
                '        If tgVpf(ilVpf).sAllowSplitCopy = "Y" Then
                '            ilVefCode(UBound(ilVefCode)) = ilAVefCode(ilAVef)
                '            ReDim Preserve ilVefCode(0 To UBound(ilVefCode) + 1) As Integer
                '        End If
                '    End If
                'Next ilAVef
                ilVpf = gBinarySearchVpf(tgMVef(ilVef).iCode)
                If ilVpf <> -1 Then
                    If tgVpf(ilVpf).sAllowSplitCopy = "Y" Then
                        tlVef = tgMVef(ilVef)
                        gBuildLinkArray hlVlf, tlVef, slStartDate, ilAVefCode()
                        For ilAVef = 0 To UBound(ilAVefCode) - 1 Step 1
                            ilVpf = gBinarySearchVpf(ilAVefCode(ilAVef))
                            If ilVpf <> -1 Then
                                If tgVpf(ilVpf).sAllowSplitCopy = "Y" Then
                                    ilVefCode(UBound(ilVefCode)) = ilAVefCode(ilAVef)
                                    ReDim Preserve ilVefCode(0 To UBound(ilVefCode) + 1) As Integer
                                End If
                            End If
                        Next ilAVef
                    End If
                End If
            ElseIf tgMVef(ilVef).sType <> "P" Then
                ilVpf = gBinarySearchVpf(ilLnVefCode(ilLoop))
                If ilVpf <> -1 Then
                    If tgVpf(ilVpf).sAllowSplitCopy = "Y" Then
                        ilVefCode(UBound(ilVefCode)) = ilLnVefCode(ilLoop)
                        ReDim Preserve ilVefCode(0 To UBound(ilVefCode) + 1) As Integer
                    End If
                End If
            End If
        End If
    Next ilLoop
    gBuildStationsFromRAF hlRaf, hlSef, llRafCode, slInclExcl, tltempstations(), ilMapExlcToIncl
    'ReDim tlStations(1 To 1) As REGIONSTATIONINFO
    ReDim tlStations(0 To 0) As REGIONSTATIONINFO
    For ilLoop = LBound(tltempstations) To UBound(tltempstations) - 1 Step 1
        For ilShtt = LBound(tgStations) To UBound(tgStations) - 1 Step 1
            If tltempstations(ilLoop).iCode = tgStations(ilShtt).iCode Then
                'Only include stations that have agreements for ordered lines
                tmAttSrchKey2.iCode = tgStations(ilShtt).iCode
                ilRet = btrGetEqual(hlAtt, tmAtt, imAttRecLen, tmAttSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)
                Do While (ilRet = BTRV_ERR_NONE) And (tmAtt.iShfCode = tgStations(ilShtt).iCode)
                    For ilVef = LBound(ilVefCode) To UBound(ilVefCode) - 1 Step 1
                        If tmAtt.iVefCode = ilVefCode(ilVef) Then
                            gUnpackDateLong tmAtt.iDropDate(0), tmAtt.iDropDate(1), llDropDate
                            gUnpackDateLong tmAtt.iOffAir(0), tmAtt.iOffAir(1), llOffAir
                            If (llStartDate <= llDropDate) Or (llStartDate <= llOffAir) Then
                                tlStations(UBound(tlStations)).sKey = tgStations(ilShtt).sCallLetters
                                tlStations(UBound(tlStations)).iShttCode = tltempstations(ilLoop).iCode
                                tlStations(UBound(tlStations)).sCallLetters = tgStations(ilShtt).sCallLetters
                                tlStations(UBound(tlStations)).iMktCode = tgStations(ilShtt).iMktCode
                                For ilMkt = LBound(tgMarkets) To UBound(tgMarkets) - 1 Step 1
                                    If tgMarkets(ilMkt).iCode = tgStations(ilShtt).iMktCode Then
                                        tlStations(UBound(tlStations)).sMarket = tgMarkets(ilMkt).sName
                                        Exit For
                                    End If
                                Next ilMkt
                                'ReDim Preserve tlStations(1 To UBound(tlStations) + 1) As REGIONSTATIONINFO
                                ReDim Preserve tlStations(0 To UBound(tlStations) + 1) As REGIONSTATIONINFO
                                Exit Do
                            End If
                        End If
                    Next ilVef
                    ilRet = btrGetNext(hlAtt, tmAtt, imAttRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop
                Exit For
            End If
        Next ilShtt
    Next ilLoop
    'If UBound(tlStations) - 1 > 1 Then
    '    ArraySortTyp fnAV(tlStations(), 1), UBound(tlStations) - 1, 0, LenB(tlStations(1)), 0, LenB(tlStations(1).sKey), 0
    If UBound(tlStations) > 1 Then
        ArraySortTyp fnAV(tlStations(), 0), UBound(tlStations), 0, LenB(tlStations(0)), 0, LenB(tlStations(0).sKey), 0
    End If
    Erase tltempstations
    Erase ilVefCode
    Erase ilAVefCode
End Sub

Private Sub mCheckXCal()
    Dim llDate As Long
    Dim llSDFDate As Long
    Dim llMoDate As Long
    Dim llSuDate As Long
    Dim ilCff As Integer
    Dim llCffStartDate As Long
    Dim llCffEndDate As Long
    
    If tgSaf(0).sReSchdXCal = "N" Then
        gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llSDFDate
        llMoDate = llSDFDate
        Do Until gWeekDayLong(llMoDate) = 0
            llMoDate = llMoDate - 1
        Loop
        llSuDate = llMoDate + 6
        If month(llMoDate) <> month(llSuDate) Then
            ilCff = LBound(tmPCff)
            Do While ilCff < UBound(tmPCff)
                If igDoEvent Then
                    DoEvents
                End If
                gUnpackDateLong tmPCff(ilCff).iStartDate(0), tmPCff(ilCff).iStartDate(1), llCffStartDate
                gUnpackDateLong tmPCff(ilCff).iEndDate(0), tmPCff(ilCff).iEndDate(1), llCffEndDate
                If (llSDFDate >= llCffStartDate) And (llSDFDate <= llCffEndDate) Then
                    If tmPCff(ilCff).sDyWk <> "D" Then
                        If month(llSDFDate) = month(llMoDate) Then
                            For llDate = llMoDate To llSuDate Step 1
                                If month(llDate) = month(llSuDate) Then
                                    tmPCff(ilCff).iDay(gWeekDayLong(llDate)) = 0
                                End If
                            Next llDate
                        Else
                            For llDate = llMoDate To llSuDate Step 1
                                If month(llDate) = month(llMoDate) Then
                                    tmPCff(ilCff).iDay(gWeekDayLong(llDate)) = 0
                                End If
                            Next llDate
                        End If
                    End If
                    Exit Sub
                End If
                ilCff = ilCff + 1
                If igDoEvent Then
                    DoEvents
                End If
            Loop
        End If
    End If
End Sub

Public Sub gRemoveLockCntr()
    Dim hlRlf As Integer
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim llLockRecCode As Long
    Dim ilLock As Integer
    
    ilLock = 0
    On Error GoTo ErrorLock
    ilLoop = LBound(tgLockCntr)
    If ilLock <> 0 Then
        Exit Sub
    End If
    
    hlRlf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hlRlf, "", sgDBPath & "Rlf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        
    If ilRet = BTRV_ERR_NONE Then
        For ilLoop = LBound(tgLockCntr) To UBound(tgLockCntr) - 1 Step 1
            llLockRecCode = tgLockCntr(ilLoop).lLockRecCode
            If llLockRecCode > 0 Then
                ilRet = gDeleteLockRec_ByRlfCode(hlRlf, llLockRecCode)
            End If
        Next ilLoop
    End If
    ilRet = btrClose(hlRlf)
    ReDim tgLockCntr(0 To 0) As LOCKCNTR
    btrDestroy hlRlf
    Exit Sub
ErrorLock:
    ilLock = 1
    Resume Next
End Sub

Private Sub mRetainUnSchdEventSpotByWeek(ilGameNo As Integer)
    If tmCClf.sSportsByWeek <> "W" Then
        Exit Sub
    End If
    If ilGameNo <= 0 Then
        Exit Sub
    End If
    lgReschSdfCode(UBound(lgReschSdfCode)) = tmSdf.lCode
    'ReDim Preserve lgReschSdfCode(1 To UBound(lgReschSdfCode) + 1) As Long
    ReDim Preserve lgReschSdfCode(LBound(lgReschSdfCode) To UBound(lgReschSdfCode) + 1) As Long
End Sub

Private Sub mAdjustCgf(ilGameNoIndex As Integer)
    Dim tlCgf As CGF
    Dim ilRet As Integer
    Dim llCgfAirDate As Long
    Dim llCgfMoAirDate As Long
    
    If ilGameNoIndex < 0 Then
        Exit Sub
    End If
    '3/8/13: Add date test
    gUnpackDateLong tmReSchdCgf(0).iAirDate(0), tmReSchdCgf(0).iAirDate(1), llCgfAirDate
    llCgfMoAirDate = llCgfAirDate - gWeekDayLong(llCgfAirDate)
    'end 3/8/13
    If tmReSchdCgf(ilGameNoIndex).iGameNo = tmReSchdCgf(0).iGameNo Then
        '3/8/13: Add date test
        gUnpackDateLong tmReSchdCgf(ilGameNoIndex).iAirDate(0), tmReSchdCgf(ilGameNoIndex).iAirDate(1), llCgfAirDate
        If llCgfMoAirDate = llCgfAirDate - gWeekDayLong(llCgfAirDate) Then
            Exit Sub
        End If
    End If
    imCgfRecLen = Len(tlCgf)
    tmCgfSrchKey1.lClfCode = tmReSchdCgf(ilGameNoIndex).lClfCode
    ilRet = btrGetEqual(hmCgf, tlCgf, imCgfRecLen, tmCgfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tlCgf.lClfCode = tmReSchdCgf(ilGameNoIndex).lClfCode)
        If tlCgf.iGameNo = tmReSchdCgf(0).iGameNo Then
            '3/8/13: Add date test
            gUnpackDateLong tlCgf.iAirDate(0), tlCgf.iAirDate(1), llCgfAirDate
            If llCgfMoAirDate = llCgfAirDate - gWeekDayLong(llCgfAirDate) Then
                tlCgf.iNoSpots = tlCgf.iNoSpots - 1
                If tlCgf.iNoSpots > 0 Then
                    ilRet = btrUpdate(hmCgf, tlCgf, imCgfRecLen)
                Else
                    ilRet = btrDelete(hmCgf)
                End If
                Exit Do
            End If
        End If
        ilRet = btrGetNext(hmCgf, tlCgf, imCgfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    '3/8/13: Add date test
    gUnpackDateLong tmReSchdCgf(ilGameNoIndex).iAirDate(0), tmReSchdCgf(ilGameNoIndex).iAirDate(1), llCgfAirDate
    llCgfMoAirDate = llCgfAirDate - gWeekDayLong(llCgfAirDate)
    'ERnd 3/8/13
    tmCgfSrchKey1.lClfCode = tmReSchdCgf(ilGameNoIndex).lClfCode
    ilRet = btrGetEqual(hmCgf, tlCgf, imCgfRecLen, tmCgfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tlCgf.lClfCode = tmReSchdCgf(ilGameNoIndex).lClfCode)
        If tlCgf.iGameNo = tmReSchdCgf(ilGameNoIndex).iGameNo Then
            '3/8/13: Add date test
            gUnpackDateLong tlCgf.iAirDate(0), tlCgf.iAirDate(1), llCgfAirDate
            If llCgfMoAirDate = llCgfAirDate - gWeekDayLong(llCgfAirDate) Then
                tlCgf.iNoSpots = tlCgf.iNoSpots + 1
                ilRet = btrUpdate(hmCgf, tlCgf, imCgfRecLen)
                Exit Sub
            End If
        End If
        ilRet = btrGetNext(hmCgf, tlCgf, imCgfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    tlCgf = tmReSchdCgf(ilGameNoIndex)
    tlCgf.lCode = 0
    tlCgf.sUnused = ""
    ilRet = btrInsert(hmCgf, tlCgf, imCgfRecLen, INDEXKEY0)
End Sub

Private Sub mCreateAlert(ilVefCode As Integer, llChfCode As Long, ilLineNo As Integer)
    Dim llMoNowDate As Long
    Dim ilRet As Integer
    Dim llDate As Long
    Dim llSdfMoDate As Long
    
    llMoNowDate = gDateValue(gNow())
    If llMoNowDate >= lmEarliestAllowedDate Then
        Exit Sub
    End If
    Do While gWeekDayLong(llMoNowDate) <> 0
        llMoNowDate = llMoNowDate - 1
    Loop
    tmSdfSrchKey0.iVefCode = ilVefCode
    tmSdfSrchKey0.lChfCode = llChfCode
    tmSdfSrchKey0.iLineNo = ilLineNo
    tmSdfSrchKey0.lFsfCode = 0
    gPackDateLong llMoNowDate, tmSdfSrchKey0.iDate(0), tmSdfSrchKey0.iDate(1)
    tmSdfSrchKey0.sSchStatus = "M"
    gPackTime "12AM", tmSdfSrchKey0.iTime(0), tmSdfSrchKey0.iTime(1)
    ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmSdf.iVefCode = ilVefCode) And (tmSdf.lChfCode = llChfCode) And (tmSdf.iLineNo = ilLineNo)
        If tmSdf.sSchStatus = "M" Then
            If Not gIsImportInvoicedSpots(tmSdf.iVefCode) Then
                gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llDate
                If llDate < lmEarliestAllowedDate Then
                    llSdfMoDate = llDate
                    Do While gWeekDayLong(llSdfMoDate) <> 0
                        llSdfMoDate = llSdfMoDate - 1
                    Loop
                    ilRet = gAlertAdd("L", "M", 0, ilVefCode, Format(llSdfMoDate, "m/d/yy"))
                End If
            End If
        End If
        If llDate >= lmEarliestAllowedDate Then
            Exit Sub
        End If
        ilRet = btrGetNext(hmSdf, tmSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
End Sub

Private Function mObtainCount(ilClf As Integer, ilCff As Integer, ilGameNo As Integer, ilTotalDeleted As Integer, ilRemoveNo As Integer, llChkStartDate As Long, llChkEndDate As Long, ilCffSpots As Integer, ilTotalAdded As Integer, tlCff As CFF, ilCheckType As Integer, slMissedDate As String) As Integer
    Dim llSdfIndex As Long
    Dim ilMforNFound As Integer
    Dim ilOrigGameNo As Integer
    Dim ilVefFound As Integer
    Dim ilSmfFound As Integer
    Dim ilCVsf As Integer
    Dim ilRet As Integer
    Dim ilSdfSpots As Integer
    Dim ilVefCode As Integer
    Dim slSdfDate As String
    'Dim llStartTime(1 To 7) As Long
    Dim llStartTime(0 To 6) As Long
    'Dim llEndTime(1 To 7) As Long
    Dim llEndTime(0 To 6) As Long
    Dim ilTimeFound As Integer
    Dim ilLoop As Integer
    Dim llOkDate As Long
    Dim slMissedOkDate As String
    Dim slSdfTime As String
    Dim llSDFTime As Long
    
    'Scan scheduled spots- checking if from this date span
    'Remove any spot within wrong vehicle
    mObtainCount = True
    ilMforNFound = False
    For llSdfIndex = LBound(tmSdfExt) To UBound(tmSdfExt) - 1 Step 1
        ilOrigGameNo = tmSdfExt(llSdfIndex).iGameNo
        If (tmSdfExt(llSdfIndex).sSchStatus = "O") Or (tmSdfExt(llSdfIndex).sSchStatus = "G") Then
            '2/21/11: Replace GetDirect with GetEqual
            'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
            tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
            ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If gFindSmf(tmSdf, hmSmf, tmSmf) Then
                If (tmSmf.lMtfCode > 0) And (lgMtfNoRecs > 0) Then
                    tmSdfExt(llSdfIndex).iLineNo = -1
                    ilMforNFound = True
                End If
                ilOrigGameNo = tmSmf.iGameNo
            End If
        End If
        If (tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine) And (ilOrigGameNo = ilGameNo) Then
            ilVefFound = False
            For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
                If tmCVsf.iFSCode(ilCVsf) > 0 Then
                    If tmSdfExt(llSdfIndex).iVefCode = tmCVsf.iFSCode(ilCVsf) Then
                        ilVefFound = True
                        Exit For
                    End If
                End If
            Next ilCVsf
            If Not ilVefFound Then
                If (tmSdfExt(llSdfIndex).sSchStatus = "O") Or (tmSdfExt(llSdfIndex).sSchStatus = "G") Then
                    '2/21/11: Replace GetDirect with GetEqual
                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If gFindSmf(tmSdf, hmSmf, tmSmf) Then
                        For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
                            If tmCVsf.iFSCode(ilCVsf) > 0 Then
                                If tmSmf.iOrigSchVef = tmCVsf.iFSCode(ilCVsf) Then
                                    ilVefFound = True
                                    Exit For
                                End If
                            End If
                        Next ilCVsf
                    End If
                End If
                If Not ilVefFound Then
                    imCVefCode = tmSdfExt(llSdfIndex).iVefCode
                    If Not mGetVefDates(imCVefCode, imCVpfIndex) Then
                        'gCntrSchdSpotChkUnSchd = False
                        mObtainCount = False
                        Erase tmSdfExtSort
                        Erase tmSdfExt
                        Exit Function
                    End If
                    'Remove spot
                    ilRet = mDeleteASpot(tmSdfExt(llSdfIndex).lCode)
                    If Not ilRet Then
                        'gCntrSchdSpotChkUnSchd = False
                        mObtainCount = False
                        Erase tmSdfExtSort
                        Erase tmSdfExt
                        Exit Function
                    End If
                    '2/21/11: Replace GetDirect with GetEqual
                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        ilTotalDeleted = ilTotalDeleted + 1
                        tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
                    End If
                Else
                    'Check Day
                    '2/21/11: Replace GetDirect with GetEqual
                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    'If Not mCheckSchDay(tmSdf, tmCClf) Then
                    If Not mCheckSchDay(tmSdf, tlCff) Then
                        ilRet = mDeleteASpot(tmSdfExt(llSdfIndex).lCode)
                        If Not ilRet Then
                            'gCntrSchdSpotChkUnSchd = False
                            mObtainCount = False
                            Erase tmSdfExtSort
                            Erase tmSdfExt
                            Exit Function
                        End If
                        '2/21/11: Replace GetDirect with GetEqual
                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                        tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If ilRet <> BTRV_ERR_NONE Then
                            ilTotalDeleted = ilTotalDeleted + 1
                            tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
                        End If
                    End If
                End If
            End If
        End If
    Next llSdfIndex
    'Check spots within correct vehicles
    For ilCVsf = LBound(tmCVsf.iFSCode) To UBound(tmCVsf.iFSCode) Step 1
        If tmCVsf.iFSCode(ilCVsf) > 0 Then
            imCVefCode = tmCVsf.iFSCode(ilCVsf)
            If Not mGetVefDates(imCVefCode, imCVpfIndex) Then
                'gCntrSchdSpotChkUnSchd = False
                mObtainCount = False
                Erase tmSdfExtSort
                Erase tmSdfExt
                Exit Function
            End If
            ilSdfSpots = 0
            For llSdfIndex = LBound(tmSdfExt) To UBound(tmSdfExt) - 1 Step 1
                ilVefCode = tmSdfExt(llSdfIndex).iVefCode
                ilOrigGameNo = tmSdfExt(llSdfIndex).iGameNo
                'If (tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine) And (tmSdfExt(llSdfIndex).iGameNo = ilGameNo) Then
                If (tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine) Then
                    If (tmSdfExt(llSdfIndex).sSchStatus = "O") Or (tmSdfExt(llSdfIndex).sSchStatus = "G") Then
                        '2/21/11: Replace GetDirect with GetEqual
                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                        tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If gFindSmf(tmSdf, hmSmf, tmSmf) Then
                            ilOrigGameNo = tmSmf.iGameNo
                            If ilOrigGameNo = ilGameNo Then
                                ilVefCode = tmSmf.iOrigSchVef
                            End If
                        End If
                    End If
                End If
                'If (tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine) And (ilVefCode = tmCVsf.iFSCode(ilCVsf)) And (tmSdfExt(llSdfIndex).iGameNo = ilGameNo) Then
                If (tmSdfExt(llSdfIndex).iLineNo = tgClfSpot(ilClf).ClfRec.iLine) And (ilVefCode = tmCVsf.iFSCode(ilCVsf)) And (ilOrigGameNo = ilGameNo) Then
                    If tmSdfExt(llSdfIndex).iLen <> tgClfSpot(ilClf).ClfRec.iLen Then
                        'Remove spot
                        ilRet = mDeleteASpot(tmSdfExt(llSdfIndex).lCode)
                        If Not ilRet Then
                            'gCntrSchdSpotChkUnSchd = False
                            mObtainCount = False
                            Erase tmSdfExtSort
                            Erase tmSdfExt
                            Exit Function
                        End If
                        '2/21/11: Replace GetDirect with GetEqual
                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                        tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If ilRet <> BTRV_ERR_NONE Then
                            ilTotalDeleted = ilTotalDeleted + 1
                            tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
                        End If
                    'ElseIf (ilCheckType) And (tmSdfExt(ilSdfIndex).sSpotType <> tmCChf.sType) And ((tmSdfExt(ilSdfIndex).sSpotType = "M") Or (tmSdfExt(ilSdfIndex).sSpotType = "S") Or (tmSdfExt(ilSdfIndex).sSpotType = "T") Or (tmSdfExt(ilSdfIndex).sSpotType = "Q") Or (tmCChf.sType = "M") Or (tmCChf.sType = "S") Or (tmCChf.sType = "T") Or (tmCChf.sType = "Q")) Then
                    'ElseIf (ilCheckType) And (tmSdfExt(ilSdfIndex).sSpotType <> tmCChf.sType) And ((tmSdfExt(ilSdfIndex).sSpotType = "M") Or (tmSdfExt(ilSdfIndex).sSpotType = "S") Or (tmSdfExt(ilSdfIndex).sSpotType = "T") Or (tmSdfExt(ilSdfIndex).sSpotType = "Q") Or ((tmCChf.sType = "M") And (tgSpf.sSchdPromo <> "Y")) Or ((tmCChf.sType = "S") And (tgSpf.sSchdPSA <> "Y")) Or ((tmCChf.sType = "T") And (tgSpf.sSchdRemnant <> "Y")) Or (tmCChf.sType = "Q")) Then
                    ElseIf (ilCheckType) And (tmSdfExt(llSdfIndex).sSpotType <> tmCChf.sType) And (((tmSdfExt(llSdfIndex).sSpotType = "M") And (tgSpf.sSchdPromo <> "Y")) Or ((tmSdfExt(llSdfIndex).sSpotType = "S") And (tgSpf.sSchdPSA <> "Y")) Or ((tmSdfExt(llSdfIndex).sSpotType = "T") And (tgSpf.sSchdRemnant <> "Y")) Or (tmSdfExt(llSdfIndex).sSpotType = "Q") Or ((tmCChf.sType = "M") And (tgSpf.sSchdPromo <> "Y")) Or ((tmCChf.sType = "S") And (tgSpf.sSchdPSA <> "Y")) Or ((tmCChf.sType = "T") And (tgSpf.sSchdRemnant <> "Y")) Or (tmCChf.sType = "Q")) Then
                        'Remove spot
                        ilRet = mDeleteASpot(tmSdfExt(llSdfIndex).lCode)
                        If Not ilRet Then
                            'gCntrSchdSpotChkUnSchd = False
                            mObtainCount = False
                            Erase tmSdfExtSort
                            Erase tmSdfExt
                            Exit Function
                        End If
                        '2/21/11: Replace GetDirect with GetEqual
                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                        tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If ilRet <> BTRV_ERR_NONE Then
                            ilTotalDeleted = ilTotalDeleted + 1
                            tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
                        End If
                    ElseIf (tmSdfExt(llSdfIndex).sSchStatus = "O") Or (tmSdfExt(llSdfIndex).sSchStatus = "G") Then
                        'Obtain original dates
                        ilSmfFound = False
                        '2/21/11: Replace GetDirect with GetEqual
                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                        tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If ilRet <> BTRV_ERR_NONE Then
                            'gCntrSchdSpotChkUnSchd = False
                            mObtainCount = False
                            Erase tmSdfExtSort
                            Erase tmSdfExt
                            Exit Function
                        End If
                        If gFindSmf(tmSdf, hmSmf, tmSmf) Then
                            ilSmfFound = True
                            gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slSdfDate
                            If (gDateValue(slSdfDate) >= llChkStartDate) And (gDateValue(slSdfDate) <= llChkEndDate) Then
                                If tmSdfExt(llSdfIndex).sSpotType <> "X" Then
                                    ilSdfSpots = ilSdfSpots + 1
                                End If
                                tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
                            End If
                        End If
                    Else
                        gUnpackDate tmSdfExt(llSdfIndex).iDate(0), tmSdfExt(llSdfIndex).iDate(1), slSdfDate
                        If (gDateValue(slSdfDate) >= llChkStartDate) And (gDateValue(slSdfDate) <= llChkEndDate) Then
                            If tmSdfExt(llSdfIndex).sSpotType <> "X" Then
                                ilSdfSpots = ilSdfSpots + 1
                            End If
                            tmSdfExt(llSdfIndex).iLineNo = -1   'Spot not counted again
                            If (tmSmf.sSchStatus <> "O") And (tmSmf.sSchStatus <> "G") And (tmSmf.sSchStatus <> "S") Then
                                'If missed spot, check its time
                                mGetLegalTimes slSdfDate, ilGameNo, llStartTime(), llEndTime()
                                gUnpackTime tmSdfExt(llSdfIndex).iTime(0), tmSdfExt(llSdfIndex).iTime(1), "A", "1", slSdfTime
                                llSDFTime = CLng(gTimeToCurrency(slSdfTime, False))
                                'If (llSdfTime < llStartTime) Or (llSdfTime > llEndTime) Then
                                ilTimeFound = False
                                For ilLoop = LBound(llStartTime) To UBound(llStartTime) Step 1
                                    If (llSDFTime >= llStartTime(ilLoop)) And (llSDFTime <= llEndTime(ilLoop)) Then
                                        ilTimeFound = True
                                        Exit For
                                    End If
                                Next ilLoop
                                If Not ilTimeFound Then
                                    Do
                                        '2/21/11: Replace GetDirect with GetEqual
                                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tmSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                        tmSdfSrchKey3.lCode = tmSdfExt(llSdfIndex).lCode
                                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                        If ilRet <> BTRV_ERR_NONE Then
                                            'gCntrSchdSpotChkUnSchd = False
                                            mObtainCount = False
                                            Erase tmSdfExtSort
                                            Erase tmSdfExt
                                            Exit Function
                                        End If
                                        'tmSRec = tmSdf
                                        'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmSRec)
                                        'tmSdf = tmSRec
                                        'If ilRet <> BTRV_ERR_NONE Then
                                        '    gCntrSchdSpotChkUnSchd = False
                                        '    Erase tmSdfExtSort
                                        '    Erase tmSdfExt
                                        '    Exit Function
                                        'End If
                                        slSdfTime = gCurrencyToTime(CCur(llStartTime(LBound(llStartTime))))
                                        gPackTime slSdfTime, tmSdf.iTime(0), tmSdf.iTime(1)
                                        tmSdf.sXCrossMidnight = "N"
                                        'Leave setting as currently set, just updating time
                                        'tmSdf.sWasMG = "N"
                                        'tmSdf.sFromWorkArea = "N"
                                        ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
                                    Loop While ilRet = BTRV_ERR_CONFLICT
                                    If ilRet <> BTRV_ERR_NONE Then
                                        'gCntrSchdSpotChkUnSchd = False
                                        mObtainCount = False
                                        Erase tmSdfExtSort
                                        Erase tmSdfExt
                                        Exit Function
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            Next llSdfIndex
            If Not ilMforNFound Then
                If tmCVsf.iNoSpots(ilCVsf) * ilCffSpots < ilSdfSpots Then
                    'Remove spots
                    ilRemoveNo = ilSdfSpots - tmCVsf.iNoSpots(ilCVsf) * ilCffSpots
                    ilRet = mDeleteSpots(tgClfSpot(ilClf).ClfRec.lChfCode, tgClfSpot(ilClf).ClfRec.iLine, 0, ilGameNo, llChkStartDate, llChkEndDate, ilRemoveNo, False, tmCChf.sCBSOrder)
                    If Not ilRet Then
                        'gCntrSchdSpotChkUnSchd = False
                        mObtainCount = False
                        Erase tmSdfExtSort
                        Erase tmSdfExt
                        Exit Function
                    End If
                    ilTotalDeleted = ilTotalDeleted + ilSdfSpots - tmCVsf.iNoSpots(ilCVsf) * ilCffSpots - ilRemoveNo
                ElseIf tmCVsf.iNoSpots(ilCVsf) * ilCffSpots > ilSdfSpots Then
                    'Add spots
                    If slMissedDate <> "" Then
                        'If (tmCChf.sType <> "T") And (tmCChf.sType <> "Q") And (tmCChf.sType <> "S") And (tmCChf.sType <> "M") Then
                        If ((tmCChf.sType <> "T") And (tmCChf.sType <> "Q") And (tmCChf.sType <> "S") And (tmCChf.sType <> "M")) Or ((tgSpf.sSchdPromo = "Y") And (tmCChf.sType = "M")) Or ((tgSpf.sSchdPSA = "Y") And (tmCChf.sType = "S")) Or ((tgSpf.sSchdRemnant = "Y") And (tmCChf.sType = "T")) Then
                            ilTotalAdded = ilTotalAdded + tmCVsf.iNoSpots(ilCVsf) * ilCffSpots - ilSdfSpots
                            llOkDate = gDateValue(slMissedDate)
                            slMissedOkDate = mGetFirstLegalWkDate(hmLcf, "C", imCVefCode, llOkDate, tgCffSpot(ilCff).CffRec)
                            ilRet = mMakeUnschSpot(tgCffSpot(ilCff).CffRec, slMissedOkDate, tmCVsf.iNoSpots(ilCVsf) * ilCffSpots - ilSdfSpots, ilGameNo)
                            If Not ilRet Then
                                'gCntrSchdSpotChkUnSchd = False
                                mObtainCount = False
                                Erase tmSdfExtSort
                                Erase tmSdfExt
                                Exit Function
                            End If
                        End If
                    End If
                End If
            End If
        End If
    Next ilCVsf
End Function

Sub mErrorMsg(slMsg As String, Optional lbcNotSchd As Control)
    Dim ilRet As Integer
    Dim ilLRet As Integer
    Dim ilFound As Integer
    Dim ilLoop As Integer
    ilFound = False
    
    'If ilBeginTran Then
        ilRet = btrAbortTrans(hmCHF)
    'End If
    If Not lbcNotSchd Is Nothing Then
        For ilLoop = 0 To lbcNotSchd.ListCount - 1
            If lbcNotSchd.List(ilLoop) = slMsg Then
                ilFound = True
                Exit For
            End If
        Next ilLoop
        If ilFound = False Then
            lbcNotSchd.AddItem slMsg
        End If
    End If
    mVehUnlock
    'ilLRet = btrUnlock(hmChf, BTRV_UNLOCK_MULTIPLE)
    ilLRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
    
    If ilFound = False Then
        If InStr(1, sgAPIActivityLog, slMsg) <= 0 Then
            sgAPIActivityLog = sgAPIActivityLog & slMsg & vbCrLf
        End If
    End If
End Sub

'--------------------------------------------------------------------------------
' Procedure  :       mGetMegaphoneAvfInfo
' Description:       Get Megaphone's AVF Code, OrganizationID and URL
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:42:01
' Parameters :
'--------------------------------------------------------------------------------
Sub mGetMegaphoneAvfInfo()
    Dim slSQLQuery As String
    Dim rst_Temp As ADODB.Recordset
    igMegaphoneAvfCode = 0
    sgMegaphoneOrganizationID = ""
    sgMegaphonePassword = ""
        
    'slSQLQuery = "SELECT avfCode, avfOrganizationID, avfVendorURL, avfVendorUserName, avfVendorPassword, avfGMTOffset FROM avf_AdVendor WHERE avfName = 'Megaphone' and avfStatus <> 'D'"
    slSQLQuery = "SELECT avfCode, avfOrganizationID, avfVendorURL, avfVendorUserName, avfVendorPassword, avfTimezone FROM avf_AdVendor WHERE avfName = 'Megaphone' and avfStatus <> 'D'"
    Set rst_Temp = gSQLSelectCall(slSQLQuery)
    If Not rst_Temp.EOF Then
        igMegaphoneAvfCode = rst_Temp!avfCode
        sgMegaphoneOrganizationID = Trim(rst_Temp!avfOrganizationID)
        sgMegaphoneRootURL = Trim(rst_Temp!avfVendorURL)
        sgMegaphonePassword = Trim(rst_Temp!avfVendorPassword)
        sgMegaphoneTimezone = rst_Temp!avfTimeZone
    End If
End Sub

'--------------------------------------------------------------------------------
' Procedure  :       mMegaphone_CreateUpdateCampaign
' Description:       Send Create or Update Campaign (Contract Header) command to Megaphone API
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:41:38
' Parameters :       tlChf (CHF)
'                    hlPcf (Integer)
'--------------------------------------------------------------------------------
Function mMegaphone_CreateUpdateCampaign(tlChf As CHF, hlPcf As Integer) As Integer
    Dim slMegaphoneAdfCode As String
    Dim llContractTotal As Long
    Dim slBody As String
    Dim slUrl As String
    Dim slCampaignID As String
    Dim slResponse As String
    Dim slString As String
    Dim slString2 As String
    Dim slString3 As String
    Dim slAdfName As String
    Dim ilAdf As Integer
    ReDim tmHttpRequestHeaders(0 To 0) As HttpRequestHeader
    ReDim tmCPcf(0 To 0) As PCF
    'this should happen before the spots (if any) have been scheduled.
    smAPIContract = ""
    
    'Check if contract has digital lines
    sgCntrSchStatus = "Checking for Digital lines..."
    DoEvents
    
    mLoadPCFRecords tlChf.lCode, hlPcf
    If UBound(tmCPcf) = 0 Then
        'No digital Lines
        mUpdateDigitalDlvyStatus tlChf.lCode, DeliveryStatus_NA
        mMegaphone_CreateUpdateCampaign = FunctionResult_NA
        Exit Function
    End If
    
    'Check to ensure at least one digital line has a vehicle that has a Megaphone ID
    sgCntrSchStatus = "Checking Contract for API Vendor..."
    DoEvents
    If mGetContractHasVendorVehicle(igMegaphoneAvfCode, tmCPcf, tlChf.lCntrNo) Then
        'sgAPIActivityLog = sgAPIActivityLog & "Contract has vehicles assigned to Megaphone" & vbCrLf
        sgCntrSchStatus = "Checking Contract is valid for API ..."
        DoEvents
        'Rejection scenarios: If the Product/Title is blank, as this is a required Megaphone field for campaign entry.
        If Trim(tlChf.sProduct) = "" Then
            mUpdateDigitalDlvyStatus tlChf.lCode, DeliveryStatus_IssueEncountered
            sgCntrSchStatus = "Contract Missing Product: " & tlChf.lCntrNo
            bgCntrSchError = True
            sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
            mMegaphone_CreateUpdateCampaign = FunctionResult_Failure
            Exit Function
        End If
        
        'Rejection scenarios: When the advertiserID in Counterpoint is not set or it is set but cannot be matched to an advertiserID in Megaphone.
        'Get Megaphone Advertiser ID
        slMegaphoneAdfCode = mGetVendorAdvertiserID(igMegaphoneAvfCode, tlChf.iAdfCode)
        If slMegaphoneAdfCode = "" Then
            'Get Advertiser name
            ilAdf = gBinarySearchAdf(tlChf.iAdfCode)
            slAdfName = ""
            If ilAdf <> -1 Then
                slAdfName = Trim(tgCommAdf(ilAdf).sName)
            End If
            mUpdateDigitalDlvyStatus tlChf.lCode, DeliveryStatus_IssueEncountered
            sgCntrSchStatus = "Missing Vendor Advertiser ID: " & slAdfName
            bgCntrSchError = True
            sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
            mMegaphone_CreateUpdateCampaign = FunctionResult_Failure
            Exit Function
        End If
    Else
        'No vendor vehicles
        mUpdateDigitalDlvyStatus tlChf.lCode, DeliveryStatus_NA
        mMegaphone_CreateUpdateCampaign = FunctionResult_NA
        Exit Function
    End If
    
    sgCntrSchStatus = "Calculating Vendor Total..."
    DoEvents
    
    'Use the total digital line cost for totalBudgetCents and USD for the currency value.
    llContractTotal = mGetVendorLineTotal(igMegaphoneAvfCode, tmCPcf)
    
    'Get Contract Campaign ID
    sgCntrSchStatus = "Checking for exiting Vendor Contract ID: " & tlChf.lCntrNo
    DoEvents
    slCampaignID = mGetVendorContractID(igMegaphoneAvfCode, tlChf.lCntrNo)
    
    'Prepare URL
    sgCntrSchStatus = "Contacting Megaphone API..."
    DoEvents
    If slCampaignID = "" Then
        sgAPIActivityLog = sgAPIActivityLog & "Has no exiting Vendor Contract ID: " & tlChf.lCntrNo & " (New Contract to Megaphone)" & vbCrLf
        'Create if contract has no Megaphone Campaign ID
        If right(sgMegaphoneRootURL, 1) = "/" Then
            slUrl = sgMegaphoneRootURL & "organizations/" & sgMegaphoneOrganizationID & "/campaigns"
        Else
            slUrl = sgMegaphoneRootURL & "/organizations/" & sgMegaphoneOrganizationID & "/campaigns"
        End If
    Else
        'Update if contract has a Megaphone Campaign ID
        sgAPIActivityLog = sgAPIActivityLog & "Has exiting Vendor Contract ID: " & slCampaignID & " (Existing Contract in Megaphone)" & vbCrLf
        If right(sgMegaphoneRootURL, 1) = "/" Then
            slUrl = sgMegaphoneRootURL & "organizations/" & sgMegaphoneOrganizationID & "/campaigns/" & slCampaignID
        Else
            slUrl = sgMegaphoneRootURL & "/organizations/" & sgMegaphoneOrganizationID & "/campaigns/" & slCampaignID
        End If
    End If
    
    'Prepare Body
    slBody = "{"
    'TTP 11027 - append Counterpoint contract number to campaign title (product)
    slBody = slBody & """title"":""" & Trim(Replace(tlChf.sProduct, """", "\""")) & " - " & Trim(str(tlChf.lCntrNo)) & ""","
    slBody = slBody & """advertiserId"":""" & slMegaphoneAdfCode & ""","
    slBody = slBody & """totalBudgetCents"":" & llContractTotal & ","
    slBody = slBody & """totalBudgetCurrency"":""USD"""
    slBody = slBody & "}"
    
    'When receiving a successful response when adding a new Campaign, use the returned Campaign ID as the Megaphone Campaign ID. The campaign ID is in the form of a UUID.
    If slCampaignID = "" Then
        'New Campaign (Contract)
        sgAPIActivityLog = sgAPIActivityLog & "Sending API POST (Create Campaign)..." & vbCrLf
        sgAPIActivityLog = sgAPIActivityLog & " - URL: " & slUrl & vbCrLf
        sgAPIActivityLog = sgAPIActivityLog & " - Body: " & slBody & vbCrLf
        
        'User Token
        tmHttpRequestHeaders(0).sKey = "Authorization"
        tmHttpRequestHeaders(0).sValue = "Bearer " & sgMegaphonePassword
        
        'Send Request
        slResponse = mSendToAPI(slUrl, "POST", slBody, tmHttpRequestHeaders, "Creating Megaphone Contract Header...")
        bgApiDelay = 1000 'Must wait 1 second before next API call
        sgAPIActivityLog = sgAPIActivityLog & " - Response: " & slResponse & vbCrLf
        
        If Mid(slResponse, 1, 5) = "Error" Then
            bgCntrSchError = True
            mMegaphone_CreateUpdateCampaign = FunctionResult_Failure
            Exit Function
        End If
        
        'Get the CampaignID from the Response (Vendor Contract ID)
        slCampaignID = mGetJSONValue(slResponse, "ID")
        sgAPIActivityLog = sgAPIActivityLog & " * Response Vendor Contract ID: " & IIF(slCampaignID = "", "{None}", slCampaignID) & vbCrLf
        smAPIContract = slCampaignID
        
        If slCampaignID <> "" Then
            'Add CampaignID to VCC_Vendor_Cntr
            mAddVCCVendorCntr igMegaphoneAvfCode, tlChf.lCntrNo, slCampaignID
        Else
            sgCntrSchStatus = "Failed to get CampaignID from response: " & tlChf.lCntrNo
            bgCntrSchError = True
            sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
            mMegaphone_CreateUpdateCampaign = FunctionResult_Failure
            Exit Function
        End If
    Else
        'Update Campaign (Contract)
        sgAPIActivityLog = sgAPIActivityLog & "Sending API PUT (Update Campaign)..." & vbCrLf
        sgAPIActivityLog = sgAPIActivityLog & " - URL:" & slUrl & vbCrLf
        sgAPIActivityLog = sgAPIActivityLog & " - Body: " & slBody & vbCrLf
        
        'User Token
        tmHttpRequestHeaders(0).sKey = "Authorization"
        tmHttpRequestHeaders(0).sValue = "Bearer " & sgMegaphonePassword
        
        'Send Request
        slResponse = mSendToAPI(slUrl, "PUT", slBody, tmHttpRequestHeaders, "Updating Megaphone Contract Header...")
        bgApiDelay = 1000 'Must wait 1 second before next API call
        sgAPIActivityLog = sgAPIActivityLog & " - Response: " & slResponse & vbCrLf
        
        If Mid(slResponse, 1, 5) = "Error" Then
            bgCntrSchError = True
            mMegaphone_CreateUpdateCampaign = FunctionResult_Failure
            Exit Function
        End If
        
        slString = mGetJSONValue(slResponse, "ID")
        sgAPIActivityLog = sgAPIActivityLog & " * Response Vendor Contract ID: " & IIF(slCampaignID = "", "{None}", slCampaignID) & vbCrLf
        
        If slString <> "" Then
            ''Rejection scenarios: We got a CampaignID back, make sure it matches existing Vendor Contract ID
            If slString <> slCampaignID Then
                sgCntrSchStatus = "CampaignID mismatch; Expected: " & slCampaignID & ", got:" & slString
                sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
                bgCntrSchError = True
                mMegaphone_CreateUpdateCampaign = FunctionResult_Failure
                Exit Function
            End If
            smAPIContract = slString
        Else
            sgCntrSchStatus = "Failed to get Vendor Contract ID: " & tlChf.lCntrNo
            bgCntrSchError = True
            sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
            mMegaphone_CreateUpdateCampaign = FunctionResult_Failure
            Exit Function
        End If
    End If
    
    'Rejection scenarios: When the advertiserID in Counterpoint is not set or it is set but cannot be matched to an advertiserID in Megaphone.
    slString = mGetJSONSection(slResponse, "advertiser")
    If slString <> "" Then
        slString = mGetJSONValue(slString, "id", 1)
        slString2 = mGetJSONValue(slString, "id", 2)
        slString3 = mGetJSONValue(slString, "id", 3)
        If slString2 <> "" Then slString = slString & "," & slString2
        If slString3 <> "" Then slString = slString & "," & slString3
        sgAPIActivityLog = sgAPIActivityLog & " * Response Vendor Advertiser ID: " & IIF(slString = "", "{None}", slString) & vbCrLf
        
        If slString = "" Then
            sgCntrSchStatus = "AdvertiserID not found in Megaphone Response: " & tlChf.lCntrNo
            bgCntrSchError = True
            sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
            mMegaphone_CreateUpdateCampaign = FunctionResult_Failure
            Exit Function
        Else
            If slString <> slMegaphoneAdfCode Then
                bgCntrSchError = True
                sgCntrSchStatus = "AdvertiserID mismatch; Expected: " & slMegaphoneAdfCode & ", got:" & slString
                sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
                mMegaphone_CreateUpdateCampaign = FunctionResult_Failure
                mUpdateDigitalDlvyStatus tlChf.lCode, DeliveryStatus_IssueEncountered
                Exit Function
            End If
        End If
    Else
        sgCntrSchStatus = "Advertiser section not found in Megaphone Response: " & tlChf.lCntrNo
        bgCntrSchError = True
        sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
        mMegaphone_CreateUpdateCampaign = FunctionResult_Failure
        Exit Function
    End If
    
    'Rejection scenarios: If the Megaphone Campaign ID saved with the contract header in Counterpoint cannot be matched to a campaign ID in Megaphone. (N/A, CampaignID is not returned)
    'Rejection scenarios: If the OrganiziationID cannot be matched to the value in Megaphone: (N/A, OrganiziationID is not returned)
    
    mUpdateDigitalDlvyStatus tlChf.lCode, DeliveryStatus_Partial
    
    sgCntrSchStatus = "Sent Megaphone Contract Header..."
    DoEvents
    mMegaphone_CreateUpdateCampaign = FunctionResult_Success
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mMegaphone_CreateUpdateCampaignOrders
' Description:       Send Create or Update Campaign Order (Digital Line) command to Megaphone API
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:40:53
' Parameters :       llChfCode (Long)
'                    llCntrNo (Long)
'                    tlPcf() (PCF)
'--------------------------------------------------------------------------------
Function mMegaphone_CreateUpdateCampaignOrders(llChfCode As Long, llCntrNo As Long, tlPcf() As PCF) As Integer
    Dim slBody As String
    Dim slUrl As String
    Dim slCampaignID As String
    Dim slResponse As String
    Dim slString As String
    Dim slString2 As String
    Dim slString3 As String
    Dim slTargetsString As String
    ReDim tmHttpRequestHeaders(0 To 0) As HttpRequestHeader
    Dim ilLoop As Integer
    Dim slVendorVefID As String
    Dim slPosition As String
    Dim slPriority As String
    Dim slStart As String
    Dim slEnd As String
    Dim llDate As Long
    Dim slDate As String
    Dim slExtVendorLineID As String
    Dim slExtVendorLineID2 As String
    Dim slVefName As String
    Dim ilVef As Integer
    Dim slTitle As String
    Dim ilRdfNameIndex As Integer
    Dim ilInteger As Integer
    Dim slLineAction As String
    Dim slPriceType As String
    
    'the digital lines will attempt to be pushed first, if that fails, the contract scheduling process will be stopped so that the problem can be resolved, then the contract scheduling can be attempted again.
    slCampaignID = mGetVendorContractID(igMegaphoneAvfCode, llCntrNo)
    If Trim(slCampaignID) = "" Then
        sgCntrSchStatus = "Failed to get Vendor ContractID: " & Trim(str(llCntrNo))
        bgCntrSchError = True
        sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
        mUpdateDigitalDlvyStatus llChfCode, DeliveryStatus_IssueEncountered
        mMegaphone_CreateUpdateCampaignOrders = FunctionResult_Failure
        Exit Function
    End If
    
    'Process contract digital lines
    sgCntrSchStatus = "Sending Campaign Orders (lines) to Megaphone..."
    sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
    For ilLoop = 0 To UBound(tmCPcf) - 1
        slLineAction = ""
        
        'Get vehicle name
        slVefName = ""
        ilVef = gBinarySearchVef(tmCPcf(ilLoop).iVefCode)
        If ilVef <> -1 Then
            slVefName = Trim(tgMVef(ilVef).sName)
        End If
        
        'Dont send if already pushed or if this line is a Package vehicle
        If tmCPcf(ilLoop).iAdServDlvyStatus <> DeliveryStatus_Pushed And tmCPcf(ilLoop).sType <> "P" Then
            slVendorVefID = ""
            gUnpackDateLong tmCPcf(ilLoop).iStartDate(0), tmCPcf(ilLoop).iStartDate(1), llDate
            slStart = Format(llDate, "yyyy-MM-dd")
            gUnpackDateLong tmCPcf(ilLoop).iEndDate(0), tmCPcf(ilLoop).iEndDate(1), llDate
            slEnd = Format(llDate, "yyyy-MM-dd")
            
            'Check if line is CBS or Deleted
            If DateValue(slStart) > DateValue(slEnd) Or tmCPcf(ilLoop).sDelete = "Y" Then
                'Delete Line in Megaphone
                If mMegaphone_DeleteCampaignOrder(slCampaignID, llCntrNo, tmCPcf(ilLoop)) = FunctionResult_Failure Then
                    sgCntrSchStatus = "Failed to Delete Line: " & tmCPcf(ilLoop).iPodCPMID & " - " & slVefName
                    bgCntrSchError = True
                    mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID, DeliveryStatus_IssueEncountered
                    sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
                    mMegaphone_CreateUpdateCampaignOrders = FunctionResult_Failure
                    mUpdateDigitalDlvyStatus llChfCode, DeliveryStatus_IssueEncountered
                    If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                    sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilLoop).iPodCPMID & "-" & slVefName & ":Issue Encountered"
                    Exit Function
                Else
                    'Successfully Deleted
                    mAddPCFVendorInfo 0, tmCPcf(ilLoop).lCode, "", DeliveryStatus_Pushed
                    slLineAction = "Deleted"
                End If
            Else
                'Send Line to Megaphone?  check if the vehicle is a Megaphone vehicle
                If mGetVefHasVendor(igMegaphoneAvfCode, tmCPcf(ilLoop).iVefCode) Then
                    'Vehicle set to Megaphone Vendor
                    slVendorVefID = mGetVendorVefID(igMegaphoneAvfCode, tmCPcf(ilLoop).iVefCode)
                    If slVendorVefID = "" Then
                        'Not a Megaphone vehicle
                        'Check if Line Used to have a Megaphone vehicle...
                        slExtVendorLineID = Trim(mGetExistingVendorLineID(igMegaphoneAvfCode, llCntrNo, tmCPcf(ilLoop).iPodCPMID))
                        If slExtVendorLineID <> "" Then
                            'Delete Line in Megaphone
                            If mMegaphone_DeleteCampaignOrder(slCampaignID, llCntrNo, tmCPcf(ilLoop)) = FunctionResult_Failure Then
                                sgCntrSchStatus = "Failed to Delete Line: " & tmCPcf(ilLoop).iPodCPMID & " - " & slVefName
                                bgCntrSchError = True
                                mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID, DeliveryStatus_IssueEncountered
                                sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
                                mMegaphone_CreateUpdateCampaignOrders = FunctionResult_Failure
                                mUpdateDigitalDlvyStatus llChfCode, DeliveryStatus_IssueEncountered
                                If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                                sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilLoop).iPodCPMID & "-" & slVefName & ":Issue Encountered"
                                Exit Function
                            Else
                                'Successfully Deleted
                                mAddPCFVendorInfo 0, tmCPcf(ilLoop).lCode, "", DeliveryStatus_Pushed
                                slLineAction = "Deleted"
                            End If
                        Else
                            'vehicle is set to Megaphone Vendor, Vehicle has no External ID, and Line has no External Line ID
                            'mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID, DeliveryStatus_NA
                            sgCntrSchStatus = "Missing vehicle's External Vendor ID: " & tmCPcf(ilLoop).iPodCPMID & " - " & slVefName
                            bgCntrSchError = True
                            mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID, DeliveryStatus_IssueEncountered
                            sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
                            mMegaphone_CreateUpdateCampaignOrders = FunctionResult_Failure
                            mUpdateDigitalDlvyStatus llChfCode, DeliveryStatus_IssueEncountered
                            If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                            sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilLoop).iPodCPMID & "-" & slVefName & ":Issue Encountered"
                            Exit Function
                        End If
                    Else
                        'Else External Vehicle ID exists
                    End If
                Else
                    'Vehicle NOT set to Megaphone Vendor
                    mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID, DeliveryStatus_NA
                
                    'Check if Line Used to have a Megaphone vehicle...
                    slExtVendorLineID = Trim(mGetExistingVendorLineID(igMegaphoneAvfCode, llCntrNo, tmCPcf(ilLoop).iPodCPMID))
                    If slExtVendorLineID <> "" Then
                        'Delete Line in Megaphone
                        If mMegaphone_DeleteCampaignOrder(slCampaignID, llCntrNo, tmCPcf(ilLoop)) = FunctionResult_Failure Then
                            sgCntrSchStatus = "Failed to Delete Line: " & tmCPcf(ilLoop).iPodCPMID & " - " & slVefName
                            bgCntrSchError = True
                            mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID, DeliveryStatus_IssueEncountered
                            sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
                            mMegaphone_CreateUpdateCampaignOrders = FunctionResult_Failure
                            mUpdateDigitalDlvyStatus llChfCode, DeliveryStatus_IssueEncountered
                            If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                            sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilLoop).iPodCPMID & "-" & slVefName & ":Issue Encountered"
                            Exit Function
                        Else
                            'Successfully Deleted
                            mAddPCFVendorInfo 0, tmCPcf(ilLoop).lCode, "", DeliveryStatus_Pushed
                            slLineAction = "Deleted"
                        End If
                    End If
                End If
                If slVendorVefID <> "" Then
                    'get Position, Priority, Start & End Date
                    sgAPIActivityLog = sgAPIActivityLog & "Sending Line: " & tmCPcf(ilLoop).iPodCPMID & ", " & slVefName & vbCrLf
                    
                    '-----------------------------
                    'title
                    ilRdfNameIndex = gBinarySearchRdf(tmCPcf(ilLoop).iRdfCode)
                    slTitle = tmCPcf(ilLoop).iPodCPMID & "-" & Replace(slVefName, """", "\""") & " / " & Trim(Replace(tgMRdf(ilRdfNameIndex).sName, """", "\"""))
                    
                    '-----------------------------
                    'Position
                    slPosition = ""
                    If tmCPcf(ilLoop).iPositionMnfCode <> 0 Then
                        slPosition = Trim(gStripChr0(mGetMnfName(tmCPcf(ilLoop).iPositionMnfCode)))
                    End If
                    If slPosition = "" Then slPosition = "0"
                    
                    '-----------------------------
                    'Priority
                    slPriority = Trim(str(tmCPcf(ilLoop).iPriority))
                    If slPriority = "0" Then slPriority = ""
                    
                    '-----------------------------
                    'Start Date
                    gUnpackDateLong tmCPcf(ilLoop).iStartDate(0), tmCPcf(ilLoop).iStartDate(1), llDate
                    slDate = Format(llDate, "MM/dd/yyyy 00:00:00")
                    
                    'Timezone Adjust (Start); E=Eastern, C=Central, M=Mountain, P=Pacific, A=Alaska, H=Hawaiian (Default to E)
                    ilInteger = mGetTimezoneOffset(sgMegaphoneTimezone)
                    
                    'DST Adjust (End)
                    If (tgSpfx.iIntFeature And INT_HONORDST) = INT_HONORDST Then
                        If mDaylightSavingsTime(slDate) Then
                            ilInteger = ilInteger - 1
                        End If
                    End If
                    
                    'Adjusted Start Time
                    slDate = DateAdd("h", ilInteger, slDate)
                    slStart = Format(slDate, "yyyy-MM-ddThh:mm:ss.000Z")
                    sgAPIActivityLog = sgAPIActivityLog & " - Offsetting Start Time by " & ilInteger & " hours:" & slStart & vbCrLf
                    
                    '-----------------------------
                    'End Date
                    gUnpackDateLong tmCPcf(ilLoop).iEndDate(0), tmCPcf(ilLoop).iEndDate(1), llDate
                    slDate = Format(llDate, "yyyy-MM-dd 23:59:59")
                    
                    'Timezone Adjust (End)
                    ilInteger = mGetTimezoneOffset(sgMegaphoneTimezone)
                    
                    'DST Adjust (End)
                    If (tgSpfx.iIntFeature And INT_HONORDST) = INT_HONORDST Then
                        If mDaylightSavingsTime(slDate) Then
                            ilInteger = ilInteger - 1
                        End If
                    End If
                    
                    'Adjusted End Time
                    slDate = DateAdd("h", ilInteger, slDate)
                    slEnd = Format(slDate, "yyyy-MM-ddThh:mm:ss.000Z")
                    sgAPIActivityLog = sgAPIActivityLog & " - Offsetting End Time by " & ilInteger & " hours:" & slEnd & vbCrLf
                                    
                    'Price Type
                    slPriceType = ""
                    If tmCPcf(ilLoop).sPriceType = "C" Then slPriceType = "cpm"
                    If tmCPcf(ilLoop).sPriceType = "F" Then slPriceType = "flat"
                    
                    '-----------------------------
                    'Make Http Body
                    slBody = "{"
                    'For Campaign Orders (line items), the only required field is Targets. There are three types of Targets: Podcast, Episode, and Tags. Only one is required. For this initial release, only Podcast (vehicle) targeting will be supported. The other types of targeting may be added later.
                    slBody = slBody & """targets"":["
                    slBody = slBody & "{"
                    slBody = slBody & """id"":""" & slVendorVefID & """, "
                    slBody = slBody & """type"":""podcast"""
                    slBody = slBody & "}"
                    slBody = slBody & "],"
                    
                    'there are some additional line fields that exist in Counterpoint and that should be used: Position, Priority, Line start date, Line End date, Impression Goal, Impression Cap
                    If slTitle <> "" Then slBody = slBody & """title"":""" & slTitle & ""","
                    If slPosition <> "" Then slBody = slBody & """position"":" & slPosition & ","
                    If slPriority <> "" Then slBody = slBody & """priority"":" & slPriority & ","
                    slBody = slBody & """startAt"":""" & slStart & ""","
                    slBody = slBody & """endAt"":""" & slEnd & ""","
                    
                    slBody = slBody & """revenueCurrency"":""USD"","
                    
                    If slPriceType <> "" Then slBody = slBody & """priceType"":""" & slPriceType & ""","
                    If slPriceType = "cpm" Then
                        slBody = slBody & """revenueCents"":" & tmCPcf(ilLoop).lPodCPM & ","
                    Else
                        slBody = slBody & """revenueCents"":" & tmCPcf(ilLoop).lTotalCost & ","
                    End If
                    
                    slBody = slBody & """impressionsGoal"":" & Trim(str(tmCPcf(ilLoop).lImpressionGoal)) & ","
                    slBody = slBody & """impressionsCap"":" & Trim(str(tmCPcf(ilLoop).lImpressionCap))
                    
                    slBody = slBody & "}"
                    
                    '-----------------------------
                    'Get existing Vendor Line Id
                    slExtVendorLineID = Trim(mGetExistingVendorLineID(igMegaphoneAvfCode, llCntrNo, tmCPcf(ilLoop).iPodCPMID))
                    If slExtVendorLineID = "" Then
                        'Create
                        If right(sgMegaphoneRootURL, 1) = "/" Then
                            slUrl = sgMegaphoneRootURL & "organizations/" & sgMegaphoneOrganizationID & "/campaigns/" & slCampaignID & "/orders"
                        Else
                            slUrl = sgMegaphoneRootURL & "/organizations/" & sgMegaphoneOrganizationID & "/campaigns/" & slCampaignID & "/orders"
                        End If
                        
                        'Create
                        sgAPIActivityLog = sgAPIActivityLog & "Sending API POST (Create Campaign Order)..." & vbCrLf
                        sgAPIActivityLog = sgAPIActivityLog & " - URL: " & slUrl & vbCrLf
                        sgAPIActivityLog = sgAPIActivityLog & " - Body: " & slBody & vbCrLf
                
                        'User Token
                        tmHttpRequestHeaders(0).sKey = "Authorization"
                        tmHttpRequestHeaders(0).sValue = "Bearer " & sgMegaphonePassword
                        
                        'Send Request
                        slResponse = mSendToAPI(slUrl, "POST", slBody, tmHttpRequestHeaders, "Sending Megaphone Line: " & tmCPcf(ilLoop).iPodCPMID)
                        bgApiDelay = 1000 'Must wait 1 second before next API call
                        sgAPIActivityLog = sgAPIActivityLog & " - Response: " & slResponse & vbCrLf
                        
                        If Mid(slResponse, 1, 5) = "Error" Then
                            bgCntrSchError = True
                            mMegaphone_CreateUpdateCampaignOrders = FunctionResult_Failure
                            mUpdateDigitalDlvyStatus llChfCode, DeliveryStatus_IssueEncountered
                            slLineAction = "Issue Encountered"
                            Exit Function
                        End If
    
                        'Get the VendorLineID from the Response
                        slExtVendorLineID2 = mGetJSONValue(slResponse, "id")
                        sgAPIActivityLog = sgAPIActivityLog & " * Response Vendor Line ID: " & IIF(slExtVendorLineID2 = "", "{None}", slExtVendorLineID2) & vbCrLf
                        
                        If slExtVendorLineID2 <> "" Then
                            'Add CampaignID to VCC_Vendor_Cntr
                            mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID2, DeliveryStatus_Pushed
                            sgCntrSchStatus = "Success sending Line: " & tmCPcf(ilLoop).iPodCPMID
                            'Add the vendor Info to the loaded list of Lines
                            tmCPcf(ilLoop).sExtVendorLineID = slExtVendorLineID2
                            tmCPcf(ilLoop).iAvfCode = igMegaphoneAvfCode
                            tmCPcf(ilLoop).iAdServDlvyStatus = DeliveryStatus_Pushed
                            DoEvents
                        Else
                            sgCntrSchStatus = "Failed to get ExtLineID: " & llCntrNo & " , Line: " & tmCPcf(ilLoop).iPodCPMID
                            sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
                            bgCntrSchError = True
                            mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID2, DeliveryStatus_IssueEncountered
                            mMegaphone_CreateUpdateCampaignOrders = FunctionResult_Failure
                            mUpdateDigitalDlvyStatus llChfCode, DeliveryStatus_IssueEncountered
                            If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                            sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilLoop).iPodCPMID & "-" & slVefName & ":Issue Encountered"
                            Exit Function
                        End If
                        
                        slLineAction = "Added"
                    Else
                        'Update
                        If right(sgMegaphoneRootURL, 1) = "/" Then
                            slUrl = sgMegaphoneRootURL & "organizations/" & sgMegaphoneOrganizationID & "/campaigns/" & slCampaignID & "/orders/" & slExtVendorLineID
                        Else
                            slUrl = sgMegaphoneRootURL & "/organizations/" & sgMegaphoneOrganizationID & "/campaigns/" & slCampaignID & "/orders/" & slExtVendorLineID
                        End If

                        'Update
                        sgAPIActivityLog = sgAPIActivityLog & "Sending API POST (Update Campaign Order)..." & vbCrLf
                        sgAPIActivityLog = sgAPIActivityLog & " - URL: " & slUrl & vbCrLf
                        sgAPIActivityLog = sgAPIActivityLog & " - Body: " & slBody & vbCrLf

                        'User Token
                        tmHttpRequestHeaders(0).sKey = "Authorization"
                        tmHttpRequestHeaders(0).sValue = "Bearer " & sgMegaphonePassword

                        'Send Request
                        slResponse = mSendToAPI(slUrl, "PUT", slBody, tmHttpRequestHeaders, "Updating Megaphone Contract Line...")
                        bgApiDelay = 1000 'Must wait 1 second before next API call
                        sgAPIActivityLog = sgAPIActivityLog & " - Response: " & slResponse & vbCrLf
                        
                        If Mid(slResponse, 1, 5) = "Error" Then
                            bgCntrSchError = True
                            mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID, DeliveryStatus_IssueEncountered
                            mMegaphone_CreateUpdateCampaignOrders = FunctionResult_Failure
                            mUpdateDigitalDlvyStatus llChfCode, DeliveryStatus_IssueEncountered
                            If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                            sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilLoop).iPodCPMID & "-" & slVefName & ":Issue Encountered"
                            Exit Function
                        End If

                        'Get the VendorLineID from the Response
                        slExtVendorLineID2 = mGetJSONValue(slResponse, "id")
                        sgAPIActivityLog = sgAPIActivityLog & " * Response Vendor Line ID: " & IIF(slExtVendorLineID2 = "", "{None}", slExtVendorLineID2) & vbCrLf

                        'Rejection scenarios: If the MegaphonePodcastID in Counterpoint cannot be matched to a value in Megaphone.
                        If slExtVendorLineID <> slExtVendorLineID2 Then
                            sgCntrSchStatus = "MegaphonePodcastID in Counterpoint cannot be matched!: " & llCntrNo & " , Line: " & tmCPcf(ilLoop).iPodCPMID
                            mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID, DeliveryStatus_IssueEncountered
                            bgCntrSchError = True
                            sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
                            mMegaphone_CreateUpdateCampaignOrders = FunctionResult_Failure
                            mUpdateDigitalDlvyStatus llChfCode, DeliveryStatus_IssueEncountered
                            If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                            sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilLoop).iPodCPMID & "-" & slVefName & ":Issue Encountered"
                            Exit Function
                        End If

                        mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID, DeliveryStatus_Pushed
                        'Add the vendor Info to the loaded list of Lines
                        tmCPcf(ilLoop).sExtVendorLineID = slExtVendorLineID2
                        tmCPcf(ilLoop).iAvfCode = igMegaphoneAvfCode
                        tmCPcf(ilLoop).iAdServDlvyStatus = DeliveryStatus_Pushed
                        slLineAction = "Updated"
                    End If

                    'Rejection scenarios: If the CampaignID in Counterpoint does not match a record in Megaphone.
                    slString = mGetJSONValue(slResponse, "campaignId")
                    sgAPIActivityLog = sgAPIActivityLog & " * Response Vendor Contract ID: " & IIF(slString = "", "{None}", slString) & vbCrLf
                    If slString <> slCampaignID Then
                        bgCntrSchError = True
                        sgCntrSchStatus = "CampaignID mismatch; Expected: " & slCampaignID & ", got:" & slString
                        sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
                        mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID, DeliveryStatus_IssueEncountered
                        mMegaphone_CreateUpdateCampaignOrders = FunctionResult_Failure
                        mUpdateDigitalDlvyStatus llChfCode, DeliveryStatus_IssueEncountered
                        If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                        sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilLoop).iPodCPMID & "-" & slVefName & ":Issue Encountered"
                        Exit Function
                    End If

                    'Rejection scenarios: If the OrganiziationID in Counterpoint does not match a record in Megaphone: (N/A OrganiziationID is not returned)

                    'Rejection scenarios: If there is no targeting defined for the line item.
                    slTargetsString = mGetJSONSection(slResponse, "targets")
                    slString = mGetJSONValue(slTargetsString, "type", 1)
                    slString2 = mGetJSONValue(slTargetsString, "type", 2)
                    slString3 = mGetJSONValue(slTargetsString, "type", 3)
                    If slString2 <> "" Then slString = slString & "," & slString2
                    If slString3 <> "" Then slString = slString & "," & slString3
                    sgAPIActivityLog = sgAPIActivityLog & " * Response Targets/Type: " & IIF(slString = "", "{None}", slString) & vbCrLf
                    If slString = "" Then
                        sgCntrSchStatus = "No targeting defined for the line item: " & llCntrNo & " , Line: " & tmCPcf(ilLoop).iPodCPMID
                        bgCntrSchError = True
                        sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
                        mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilLoop).lCode, slExtVendorLineID, DeliveryStatus_IssueEncountered
                        mMegaphone_CreateUpdateCampaignOrders = FunctionResult_Failure
                        mUpdateDigitalDlvyStatus llChfCode, DeliveryStatus_IssueEncountered
                        If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                        sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilLoop).iPodCPMID & "-" & slVefName & ":Issue Encountered"
                        Exit Function
                    End If
                End If 'has a Vendor Vehicle ID
            End If 'check if CBS
        Else
            If tmCPcf(ilLoop).sType <> "P" Then
                'Already Pushed, no need to send again
                sgAPIActivityLog = sgAPIActivityLog & "Line #" & tmCPcf(ilLoop).iPodCPMID & ": Already pushed relevant data to Megaphone." & vbCrLf
                'slLineAction = "Already pushed"
            End If
        End If 'Check if DeliveryStatus_Pushed
        
        If slLineAction <> "" Then
            If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
            sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilLoop).iPodCPMID & "-" & slVefName & ":" & slLineAction
        End If
    Next ilLoop
    
    mMegaphone_CreateUpdateCampaignOrders = FunctionResult_Success
    sgCntrSchStatus = "Sent Megaphone Campaign Orders (lines)..."
    DoEvents
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mMegaphone_ValidateLines
' Description:       returns number of hours to add to GMT
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       4/5/2024-10:30:20
' Parameters :
'--------------------------------------------------------------------------------
Function mMegaphone_ValidateLines(llChfCode As Long, llCntrNo As Long, tlPcf() As PCF) As Integer
    Dim slBody As String
    Dim slUrl As String
    Dim slCampaignID As String
    Dim slResponse As String
    ReDim tmHttpRequestHeaders(0 To 0) As HttpRequestHeader
    Dim ilLoop As Integer
    Dim ilLoop2 As Integer
    Dim slOrders() As String
    Dim slString As String
    Dim slExtVendorLineID As String
    Dim ilFound As Integer
    Dim slTitle As String
    Dim llimpressionsCap As Long
    Dim llimpressionsGoal As Long
    Dim llrevenueCents As Long
    Dim slrevenueCurrency As String
    Dim slflightTimezone As String
    Dim slstartAt As String
    Dim slendAt As String
    Dim ilpriority As Integer
    Dim ilPosition As Integer
    Dim slCampaignID2 As String
    Dim slPriceType As String
    Dim ilRet As Integer
    Dim ilFound2 As Integer
    Dim ilPcfIndex As Integer
    
    'https://cms.megaphone.fm/api/organizations/54410c80-e6e8-11ee-9d2d-7bc016b5f335/campaigns/05d4a094-f2d6-11ee-a2e9-efa9b5be4b5a/orders
    slCampaignID = mGetVendorContractID(igMegaphoneAvfCode, llCntrNo)
    
    If right(sgMegaphoneRootURL, 1) = "/" Then
        slUrl = sgMegaphoneRootURL & "organizations/" & sgMegaphoneOrganizationID & "/campaigns/" & slCampaignID & "/orders"
    Else
        slUrl = sgMegaphoneRootURL & "/organizations/" & sgMegaphoneOrganizationID & "/campaigns/" & slCampaignID & "/orders"
    End If
    
    'Validate
    sgAPIActivityLog = sgAPIActivityLog & "Validating Order Lines:" & llCntrNo & vbCrLf
    sgAPIActivityLog = sgAPIActivityLog & " - Sending API GET (Get Campaign Orders)..." & vbCrLf
    sgAPIActivityLog = sgAPIActivityLog & " - URL: " & slUrl & vbCrLf
    
    'User Token
    tmHttpRequestHeaders(0).sKey = "Authorization"
    tmHttpRequestHeaders(0).sValue = "Bearer " & sgMegaphonePassword
    
    'Send Request
    slResponse = mSendToAPI(slUrl, "GET", slBody, tmHttpRequestHeaders, "Getting Megaphone Lines")
    bgApiDelay = 1000 'Must wait 1 second before next API call
    'sgAPIActivityLog = sgAPIActivityLog & " - Response: " & slResponse & vbCrLf
    
    slOrders = Split(slResponse, "},{")
    For ilLoop = 0 To UBound(slOrders)
        'remove sections that may contain an "id"
        'Remove geotargets section
        slString = mGetJSONSection(slOrders(ilLoop), "geotargets")
        slOrders(ilLoop) = Replace(slOrders(ilLoop), slString, "")
        'Remove geoexclusions section
        slString = mGetJSONSection(slOrders(ilLoop), "geoexclusions")
        slOrders(ilLoop) = Replace(slOrders(ilLoop), slString, "")
        'Remove geonameIdInclusions section
        slString = mGetJSONSection(slOrders(ilLoop), "geonameIdInclusions")
        slOrders(ilLoop) = Replace(slOrders(ilLoop), slString, "")
        'Remove geonameIdExclusions section
        slString = mGetJSONSection(slOrders(ilLoop), "geonameIdExclusions")
        slOrders(ilLoop) = Replace(slOrders(ilLoop), slString, "")
        'Remove trackingUrls section
        slString = mGetJSONSection(slOrders(ilLoop), "trackingUrls")
        slOrders(ilLoop) = Replace(slOrders(ilLoop), slString, "")
        'Remove deviceTargets section
        slString = mGetJSONSection(slOrders(ilLoop), "deviceTargets")
        slOrders(ilLoop) = Replace(slOrders(ilLoop), slString, "")
        'Remove targets section
        slString = mGetJSONSection(slOrders(ilLoop), "targets")
        slOrders(ilLoop) = Replace(slOrders(ilLoop), slString, "")
        
        'Look for this line in tmCPcf with matching igMegaphoneAvfCode & lineID
        slExtVendorLineID = mGetJSONValue(slOrders(ilLoop), "id")
        slTitle = mGetJSONValue(slOrders(ilLoop), "title") 'Should contain Line#
        llimpressionsCap = Val(mGetJSONValue(slOrders(ilLoop), "impressionsCap"))
        llimpressionsGoal = Val(mGetJSONValue(slOrders(ilLoop), "impressionsGoal"))
        llrevenueCents = Val(mGetJSONValue(slOrders(ilLoop), "revenueCents"))
        slrevenueCurrency = mGetJSONValue(slOrders(ilLoop), "revenueCurrency") 'S/B USD
        slflightTimezone = mGetJSONValue(slOrders(ilLoop), "flightTimezone")
        slstartAt = mGetJSONValue(slOrders(ilLoop), "startAt")
        slendAt = mGetJSONValue(slOrders(ilLoop), "endAt")
        ilpriority = Val(mGetJSONValue(slOrders(ilLoop), "priority"))
        ilPosition = Val(mGetJSONValue(slOrders(ilLoop), "position"))
        slCampaignID2 = mGetJSONValue(slOrders(ilLoop), "campaignId")
        slPriceType = mGetJSONValue(slOrders(ilLoop), "priceType") 'S/B cpm or flat
        
        'Look for this line in pcf
        ilPcfIndex = -1
        ilFound = False
        For ilLoop2 = 0 To UBound(tmCPcf) - 1
            If tmCPcf(ilLoop2).iAvfCode = igMegaphoneAvfCode Then
                If mGetExistingVendorLineID(igMegaphoneAvfCode, llCntrNo, tmCPcf(ilLoop2).iPodCPMID) = slExtVendorLineID Then
                    ilPcfIndex = ilLoop2
                    ilFound = True
                    Exit For
                End If
            End If
        Next ilLoop2
        
        If ilFound = False Then
            'Megaphone Campaign Order ID does not match a Line in Counterpoint!
            Debug.Print "Campaign ID:" & slExtVendorLineID & " not found in Counterpoint!"
            sgAPIActivityLog = sgAPIActivityLog & " ! Validation found campaign Order (" & slCampaignID2 & ") that doesn't match counterpoint: '" & slTitle & "' for $" & Format(llrevenueCents / 100, "0.00") & ", starting:" & slstartAt & ", Ending:" & slendAt & vbCrLf
            ilRet = mMegaphone_DeleteCampaignOrderByExtID(slCampaignID, slExtVendorLineID)
            Select Case ilRet
                Case FunctionResult_NA
                Case FunctionResult_Success
                    If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                    sgCntrLineDetail = sgCntrLineDetail & slExtVendorLineID & ":Mismatch line Deleted"
                Case FunctionResult_Failure
                    If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                    sgCntrLineDetail = sgCntrLineDetail & slExtVendorLineID & ":Delete Failed"
                    mMegaphone_ValidateLines = FunctionResult_Failure
                    Exit Function
            End Select
        Else
            'Megaphone Campaign Order ID Matches a Line in Counterpoint
            ilFound2 = False
            If tmCPcf(ilPcfIndex).iAvfCode <> igMegaphoneAvfCode Then
                sgAPIActivityLog = sgAPIActivityLog & " ! Validation found [Mismatch AVF Code] on campaign Order (" & slCampaignID2 & "): '" & slTitle & "' for $" & Format(llrevenueCents / 100, "0.00") & ", starting:" & slstartAt & ", Ending:" & slendAt & vbCrLf
                ilFound2 = True
            End If
            If tmCPcf(ilPcfIndex).iPriority <> ilpriority Then
                sgAPIActivityLog = sgAPIActivityLog & " ! Validation found [Mismatch Priority] on campaign Order (" & slCampaignID2 & "): '" & slTitle & "' for $" & Format(llrevenueCents / 100, "0.00") & ", starting:" & slstartAt & ", Ending:" & slendAt & vbCrLf
                ilFound2 = True
            End If
            If tmCPcf(ilPcfIndex).sPriceType <> IIF(slPriceType = "cpm", "C", "F") Then
                sgAPIActivityLog = sgAPIActivityLog & " ! Validation found [Mismatch PriceType] on campaign Order (" & slCampaignID2 & "): '" & slTitle & "' for $" & Format(llrevenueCents / 100, "0.00") & ", starting:" & slstartAt & ", Ending:" & slendAt & vbCrLf
                ilFound2 = True
            End If
            If slrevenueCurrency <> "USD" Then
                sgAPIActivityLog = sgAPIActivityLog & " ! Validation found [Mismatch Currency] on campaign Order (" & slCampaignID2 & "): '" & slTitle & "' for $" & Format(llrevenueCents / 100, "0.00") & ", starting:" & slstartAt & ", Ending:" & slendAt & vbCrLf
                ilFound2 = True
            End If
            If slPriceType = "cpm" And tmCPcf(ilPcfIndex).lPodCPM <> llrevenueCents Then
                sgAPIActivityLog = sgAPIActivityLog & " ! Validation found [Mismatch CPM Rate] on campaign Order (" & slCampaignID2 & "): '" & slTitle & "' for $" & Format(llrevenueCents / 100, "0.00") & ", starting:" & slstartAt & ", Ending:" & slendAt & vbCrLf
                ilFound2 = True
            End If
            If slPriceType = "flat" And tmCPcf(ilPcfIndex).lTotalCost <> llrevenueCents Then
                sgAPIActivityLog = sgAPIActivityLog & " ! Validation found [Mismatch Flat Revenue] on campaign Order (" & slCampaignID2 & "): '" & slTitle & "' for $" & Format(llrevenueCents / 100, "0.00") & ", starting:" & slstartAt & ", Ending:" & slendAt & vbCrLf
                ilFound2 = True
            End If
            If tmCPcf(ilPcfIndex).lImpressionCap <> llimpressionsCap Then
                sgAPIActivityLog = sgAPIActivityLog & " ! Validation found [Mismatch Impression Cap] on campaign Order (" & slCampaignID2 & "): '" & slTitle & "' for $" & Format(llrevenueCents / 100, "0.00") & ", starting:" & slstartAt & ", Ending:" & slendAt & vbCrLf
                ilFound2 = True
            End If
            If tmCPcf(ilPcfIndex).lImpressionGoal <> llimpressionsGoal Then
                sgAPIActivityLog = sgAPIActivityLog & " ! Validation found [Mismatch Impression Goal] on campaign Order (" & slCampaignID2 & "): '" & slTitle & "' for $" & Format(llrevenueCents / 100, "0.00") & ", starting:" & slstartAt & ", Ending:" & slendAt & vbCrLf
                ilFound2 = True
            End If
            If ilFound2 = True Then
                mAddPCFVendorInfo igMegaphoneAvfCode, tmCPcf(ilPcfIndex).lCode, slExtVendorLineID, DeliveryStatus_IssueEncountered
                tmCPcf(ilPcfIndex).iAdServDlvyStatus = DeliveryStatus_IssueEncountered
                
                If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilPcfIndex).iPodCPMID & ":Mismatch Detected"
                'Try to fix the line in Megaphone
                ilRet = mMegaphone_CreateUpdateCampaignOrders(llChfCode, llCntrNo, tmCPcf)
                Select Case ilRet
                    Case FunctionResult_NA
                    Case FunctionResult_Success
                        If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                        sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilPcfIndex).iPodCPMID & ":Resent"
                    Case FunctionResult_Failure
                        If sgCntrLineDetail <> "" Then sgCntrLineDetail = sgCntrLineDetail & ", "
                        sgCntrLineDetail = sgCntrLineDetail & tmCPcf(ilPcfIndex).iPodCPMID & ":Resend Failed"
                        mMegaphone_ValidateLines = FunctionResult_Failure
                        Exit Function
                End Select
                Exit Function
            End If
        End If
    Next ilLoop
    mMegaphone_ValidateLines = FunctionResult_Success
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mMegaphone_DeleteCampaignOrder
' Description:       Send's Delete Campaign Order (Digitial Line) command to Megaphone's API
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:37:40
' Parameters :       slCampaignID (String)
'                    llCntrNo (Long)
'                    tlPcf (PCF)
'--------------------------------------------------------------------------------
Function mMegaphone_DeleteCampaignOrder(slCampaignID As String, llCntrNo As Long, tlPcf As PCF) As Integer
    Dim slBody As String
    Dim slUrl As String
    Dim slResponse As String
    Dim slString As String
    ReDim tmHttpRequestHeaders(0 To 0) As HttpRequestHeader
    Dim ilLoop As Integer
    Dim slVendorVefID As String
    Dim slPosition As String
    Dim slPriority As String
    Dim slStart As String
    Dim slEnd As String
    Dim llDate As Long
    Dim slExtVendorLineID As String
    
    'Delete digital line...
    sgCntrSchStatus = "Deleting Campaign Order (line) in Megaphone..."
    sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
    sgAPIActivityLog = sgAPIActivityLog & "Deleting Line:" & tmCPcf(ilLoop).iPodCPMID & vbCrLf
    
    gUnpackDateLong tmCPcf(ilLoop).iStartDate(0), tmCPcf(ilLoop).iStartDate(1), llDate
    slStart = Format(llDate, "yyyy-MM-dd")
    gUnpackDateLong tmCPcf(ilLoop).iEndDate(0), tmCPcf(ilLoop).iEndDate(1), llDate
    slEnd = Format(llDate, "yyyy-MM-dd")

    'Get this order's external ContractID
    If Trim(slCampaignID) = "" Then
        sgCntrSchStatus = "Failed to get Vendor ContractID: " & Trim(str(llCntrNo))
        bgCntrSchError = True
        sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
        mMegaphone_DeleteCampaignOrder = FunctionResult_Failure
        Exit Function
    End If
    
    'check if this line has (or once had) a Megaphone Campaign ID
    slExtVendorLineID = mGetExistingVendorLineID(igMegaphoneAvfCode, llCntrNo, tlPcf.iPodCPMID)
    If slExtVendorLineID = "" Then
        'If this line hasnt been sent to Megaphone, no point in deleting it
        mMegaphone_DeleteCampaignOrder = FunctionResult_NA
        Exit Function
    End If
    
    'Prepare URL
    If right(sgMegaphoneRootURL, 1) = "/" Then
        slUrl = sgMegaphoneRootURL & "organizations/" & sgMegaphoneOrganizationID & "/campaigns/" & slCampaignID & "/orders/" & slExtVendorLineID
    Else
        slUrl = sgMegaphoneRootURL & "/organizations/" & sgMegaphoneOrganizationID & "/campaigns/" & slCampaignID & "/orders/" & slExtVendorLineID
    End If

    'Send Delete command
    sgAPIActivityLog = sgAPIActivityLog & "Sending API DELETE (Delete Campaign Order)..." & vbCrLf
    sgAPIActivityLog = sgAPIActivityLog & " - URL:" & slUrl & vbCrLf
    
    'User Token
    tmHttpRequestHeaders(0).sKey = "Authorization"
    tmHttpRequestHeaders(0).sValue = "Bearer " & sgMegaphonePassword
    
    'Send Request
    slResponse = mSendToAPI(slUrl, "DELETE", slBody, tmHttpRequestHeaders, "Deleting Megaphone Contract Line...")
    bgApiDelay = 1000 'Must wait 1 second before next API call
    sgAPIActivityLog = sgAPIActivityLog & " - Response: " & slResponse & vbCrLf
    
    If Mid(slResponse, 1, 5) = "Error" Then
        bgCntrSchError = True
        mMegaphone_DeleteCampaignOrder = FunctionResult_Failure
        Exit Function
    End If
    
    'Rejection scenarios: Did not receive 'Success' result
    If InStr(1, slResponse, "success") <= 0 Then
        sgCntrSchStatus = "Delete Did not receive 'Success' result: " & llCntrNo & " , Line: " & tmCPcf(ilLoop).iPodCPMID
        bgCntrSchError = True
        sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
        mMegaphone_DeleteCampaignOrder = FunctionResult_Failure
        Exit Function
    End If
    
    'Clear the vendor ID from the line
    mClearExistingVendorLineID igMegaphoneAvfCode, llCntrNo, tlPcf.iPodCPMID
    mMegaphone_DeleteCampaignOrder = FunctionResult_Success
    sgCntrSchStatus = "Deleted Megaphone Campaign Order (line)..."
    bgMegaphoneContract = True
    DoEvents
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mMegaphone_DeleteCampaignOrderByExtID
' Description:       Send's Delete Campaign Order (Digitial Line) command to Megaphone's API
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:37:40
' Parameters :       slCampaignID (String)
'                    slExtVendorLineID (String)
'--------------------------------------------------------------------------------
Function mMegaphone_DeleteCampaignOrderByExtID(slCampaignID As String, slExtVendorLineID As String) As Integer
    Dim slBody As String
    Dim slUrl As String
    Dim slResponse As String
    Dim slString As String
    ReDim tmHttpRequestHeaders(0 To 0) As HttpRequestHeader
    Dim ilLoop As Integer
    Dim slVendorVefID As String
    Dim slPosition As String
    Dim slPriority As String
    Dim slStart As String
    Dim slEnd As String
    Dim llDate As Long
    Dim slExtVendorLineID2 As String
    
    'Delete digital line...
    sgCntrSchStatus = "Deleting Campaign Order (line) in Megaphone..."
    
    'Prepare URL
    If right(sgMegaphoneRootURL, 1) = "/" Then
        slUrl = sgMegaphoneRootURL & "organizations/" & sgMegaphoneOrganizationID & "/campaigns/" & slCampaignID & "/orders/" & slExtVendorLineID
    Else
        slUrl = sgMegaphoneRootURL & "/organizations/" & sgMegaphoneOrganizationID & "/campaigns/" & slCampaignID & "/orders/" & slExtVendorLineID
    End If

    'Send Delete command
    sgAPIActivityLog = sgAPIActivityLog & "Sending API DELETE (Delete Campaign Order)..." & vbCrLf
    sgAPIActivityLog = sgAPIActivityLog & " - URL:" & slUrl & vbCrLf
    
    'User Token
    tmHttpRequestHeaders(0).sKey = "Authorization"
    tmHttpRequestHeaders(0).sValue = "Bearer " & sgMegaphonePassword
    
    'Send Request
    slResponse = mSendToAPI(slUrl, "DELETE", slBody, tmHttpRequestHeaders, "Deleting Megaphone Campaign Order ...")
    bgApiDelay = 1000 'Must wait 1 second before next API call
    sgAPIActivityLog = sgAPIActivityLog & " - Response: " & slResponse & vbCrLf
    
    If Mid(slResponse, 1, 5) = "Error" Then
        bgCntrSchError = True
        mMegaphone_DeleteCampaignOrderByExtID = FunctionResult_Failure
        Exit Function
    End If
    
    'Rejection scenarios: Did not receive 'Success' result
    If InStr(1, slResponse, "success") <= 0 Then
        sgCntrSchStatus = "Delete Did not receive 'Success' result for Campaign: " & slCampaignID & " , Campaign Order: " & slExtVendorLineID
        bgCntrSchError = True
        sgAPIActivityLog = sgAPIActivityLog & sgCntrSchStatus & vbCrLf
        mMegaphone_DeleteCampaignOrderByExtID = FunctionResult_Failure
        Exit Function
    End If
    
    mMegaphone_DeleteCampaignOrderByExtID = FunctionResult_Success
    sgCntrSchStatus = "Deleted Megaphone Campaign Order (line)..."
    DoEvents
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mGetExistingVendorLineID
' Description:       Loads the External Vendor's Line ID for the specified Vendor, Contract and Digital Line
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:33:59
' Parameters :       ilVendorAvfCode (Integer)
'                    llCntrNo (Long)
'                    ilLine (Integer) - if ommitted, this function can be used to determine if Any line has a External Vendor's Line ID for the specified Vendor
'--------------------------------------------------------------------------------
Function mGetExistingVendorLineID(ilVendorAvfCode As Integer, llCntrNo As Long, Optional ilLine As Integer = 0) As String
    Dim slSQLQuery As String
    Dim rst_Temp As ADODB.Recordset
    slSQLQuery = "SELECT TOP 1 pcfExtVendorLineID"
    slSQLQuery = slSQLQuery & " FROM pcf_Pod_CPM_Cntr"
    slSQLQuery = slSQLQuery & " WHERE"
    If ilLine <> 0 Then
        slSQLQuery = slSQLQuery & " pcfPodCPMID = " & ilLine & " AND"
    End If
    slSQLQuery = slSQLQuery & " pcfAvfCode = " & ilVendorAvfCode & " AND"
    slSQLQuery = slSQLQuery & " pcfExtVendorLineID <> '' AND"
    slSQLQuery = slSQLQuery & " pcfChfCode IN ( SELECT chfCode FROM CHF_Contract_Header WHERE chfCntrNo = " & llCntrNo & " )"
    Set rst_Temp = gSQLSelectCall(slSQLQuery)
    If Not rst_Temp.EOF Then
        mGetExistingVendorLineID = Trim(rst_Temp!pcfExtVendorLineID)
    End If
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mClearExistingVendorLineID
' Description:       Clears Vendor Line ID for a specified Vendor Code, Contract # and Digital Line
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:19:37
' Parameters :       ilVendorAvfCode (Integer)
'                    llCntrNo (Long)
'                    ilLine (Integer)
'--------------------------------------------------------------------------------
Sub mClearExistingVendorLineID(ilVendorAvfCode As Integer, llCntrNo As Long, ilLine As Integer)
    Dim slSQLQuery As String
    Dim llRet As Integer
    slSQLQuery = "UPDATE pcf_Pod_CPM_Cntr "
    slSQLQuery = slSQLQuery & " SET pcfExtVendorLineID = ''"
    slSQLQuery = slSQLQuery & " WHERE"
    slSQLQuery = slSQLQuery & " pcfPodCPMID = " & ilLine & " AND"
    slSQLQuery = slSQLQuery & " pcfAvfCode = " & ilVendorAvfCode & " AND"
    slSQLQuery = slSQLQuery & " pcfExtVendorLineID <> '' AND"
    slSQLQuery = slSQLQuery & " pcfChfCode IN ( SELECT chfCode FROM CHF_Contract_Header WHERE chfCntrNo = " & llCntrNo & " )"
    llRet = gSQLWaitNoMsgBox(slSQLQuery, False)
End Sub

'--------------------------------------------------------------------------------
' Procedure  :       mGetJSONSection
' Description:       Generic JSON parsing, get a JSON "Section" for the provided section name
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:12:53
' Parameters :       slJSONString (String)
'                    slSectionName (String)
'--------------------------------------------------------------------------------
Function mGetJSONSection(slJSONString As String, slSectionName As String) As String
    'JSON section must be a simple JSON array:
    '{"id":"d2119b38-e86a-11ee-8e39-4333f2701e48","externalId":null,"createdAt":"2024-03-22T16:39:58.352Z","updatedAt":"2024-03-22T16:40:05.559Z","title":"Car batteries","organizationId":"54410c80-e6e8-11ee-9d2d-7bc016b5f335","totalRevenueCents":0,"totalRevenueCurrency":"USD","totalBudgetCents":4000,"totalBudgetCurrency":"USD","durationInSeconds":604799,"copyNeeded":true,"advertiserId":"30f6e87a-e6f8-11ee-a82d-2bf4ca479a2b","advertiser":{"id":"30f6e87a-e6f8-11ee-a82d-2bf4ca479a2b","name":"AC Delco","agency":{"id":"30c96864-e6f8-11ee-a82d-830dbd1fa04e","name":"Test Agency 1"}},"bookingSource":null}
    'Example: mGetJSONSection JSON, "targets"; returns:  {"id":"30c96864-e6f8-11ee-a82d-830dbd1fa04e","name":"Test Agency 1"}}
    On Error Resume Next
    
    Dim ilStart As Integer
    Dim ilStart2 As Integer
    Dim ilEnd As Integer
    'if we are looking for 'targets' then look for '"targets":'
    ilStart = InStr(1, slJSONString, """" & slSectionName & """:")
    If ilStart > 0 Then
        ilStart2 = InStr(ilStart, slJSONString, "[")
    End If
    If ilStart2 = 0 Then
        ilStart2 = InStr(ilStart, slJSONString, "{")
    End If
    If ilStart2 = 0 Then Exit Function
    ilEnd = InStr(ilStart, slJSONString, "]")
    If ilEnd = 0 Then
        ilEnd = InStr(ilStart, slJSONString, "}")
    End If
    If ilEnd = 0 Then
        Exit Function
    End If

    mGetJSONSection = Mid(slJSONString, ilStart2, ilEnd - ilStart2 + 1)
    On Error GoTo 0
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mGetJSONValue
' Description:       Generic JSON parsing, get a value for a provided key, optionally get the nth matching item
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:11:53
' Parameters :       slJSONString (String)
'                    slKey (String)
'                    ilIndex (Integer = 1)
'--------------------------------------------------------------------------------
Function mGetJSONValue(slJSONString As String, slKey As String, Optional ilIndex As Integer = 1) As String
    'JSON string must be a simple JSON String:
    '{"id":"d2119b38-e86a-11ee-8e39-4333f2701e48","externalId":null,"createdAt":"2024-03-22T16:39:58.352Z","updatedAt":"2024-03-22T16:40:05.559Z","title":"Car batteries","organizationId":"54410c80-e6e8-11ee-9d2d-7bc016b5f335","totalRevenueCents":0,"totalRevenueCurrency":"USD","totalBudgetCents":4000,"totalBudgetCurrency":"USD","durationInSeconds":604799,"copyNeeded":true,"advertiserId":"30f6e87a-e6f8-11ee-a82d-2bf4ca479a2b","advertiser":{"id":"30f6e87a-e6f8-11ee-a82d-2bf4ca479a2b","name":"AC Delco","agency":{"id":"30c96864-e6f8-11ee-a82d-830dbd1fa04e","name":"Test Agency 1"}},"bookingSource":null}
    'mGetJSONValue JSON, "id"; returns: d2119b38-e86a-11ee-8e39-4333f2701e48
    
    'Example Using ilIndex to find the nth Item
    '"advertiser":{"id":"30f6e87a-e6f8-11ee-a82d-2bf4ca479a2b","name":"AC Delco","agency":{"id":"30c96864-e6f8-11ee-a82d-830dbd1fa04e","name":"Test Agency 1"}}
    'mGetJSONValue JSON, "id", 2; returns: 30c96864-e6f8-11ee-a82d-830dbd1fa04e
    
    Dim ilLoop As Integer
    Dim slParts() As String
    Dim slValuePair() As String
    Dim slvalue As String
    Dim ilFoundCount As Integer
    On Error Resume Next
    
    'split JSON by Carrage returns
    slParts = Split(slJSONString, ",")
    'Look through each Line of the JSON String
    For ilLoop = 0 To UBound(slParts) - 1
        If InStr(1, slParts(ilLoop), """" & slKey & """:") > 0 Then
            'SPLIT JSON by the ":" (Value can't contain a Colon!)
            slValuePair = Split(slParts(ilLoop), ":")
            'Get the Value part and clean it up
            slvalue = Trim(slValuePair(1))
            slvalue = Replace(slvalue, """,", "")
            slvalue = Replace(slvalue, """", "")
            slvalue = Replace(slvalue, "[", "")
            slvalue = Replace(slvalue, "]", "")
            slvalue = Replace(slvalue, "{", "")
            slvalue = Replace(slvalue, "}", "")
            slvalue = Trim(slvalue)
            If Mid(slvalue, 1, 1) = """" Then slvalue = Mid(slvalue, 2)
            ilFoundCount = ilFoundCount + 1
            If ilFoundCount >= ilIndex Then
                mGetJSONValue = slvalue
                Exit For
            End If
        End If
    Next ilLoop
    On Error GoTo 0
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mAddVCCVendorCntr
' Description:       Writes a Vendors External Contract ID to the VCC_Vendor_Ctr table
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:10:50
' Parameters :       ilVendorAvfCode (Integer)
'                    llCntrNo (Long)
'                    slExternalCntrID (String)
'--------------------------------------------------------------------------------
Sub mAddVCCVendorCntr(ilVendorAvfCode As Integer, llCntrNo As Long, slExternalCntrID As String)
    Dim slSQLQuery As String
    Dim llRet As Long
    'Make sure a record doens't already exist
    slSQLQuery = "DELETE FROM VCC_Vendor_Ctr WHERE vccAvfCode = " & ilVendorAvfCode & " AND vccCntrNo = " & llCntrNo
    llRet = gSQLWaitNoMsgBox(slSQLQuery, False)
    
    'Insert VCC record
    slSQLQuery = "INSERT INTO VCC_Vendor_Ctr (vccAvfCode,vccCntrNo,vccExternalID) VALUES (" & ilVendorAvfCode & "," & llCntrNo & ",'" & slExternalCntrID & "')"
    llRet = gSQLWaitNoMsgBox(slSQLQuery, False)
End Sub

'--------------------------------------------------------------------------------
' Procedure  :       mAddPCFVendorInfo
' Description:       Writes an External Vendor's Line ID & Vendor ID to the PCF Table (Digital Lines)
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:09:30
' Parameters :       ilVendorAvfCode (Integer)
'                    lPcfCode (Long)
'                    slExtVendorLineID (String)
'--------------------------------------------------------------------------------
'DeliveryStatus_NA = 0
'DeliveryStatus_NotPushed = 1
'DeliveryStatus_Pushed = 2
'DeliveryStatus_Partial = 3
'DeliveryStatus_IssueEncountered = 4
'DeliveryStatus_RequiresRepush = 5
Sub mAddPCFVendorInfo(ilVendorAvfCode As Integer, lPcfCode As Long, slExtVendorLineID As String, ilAdServDlvyStatus)
    Dim slSQLQuery As String
    Dim llRet As Long
    If ilAdServDlvyStatus = 0 Then
        'TTP 11026 - Megaphone API: contract with digital lines with mix of Megaphone lines and non-Megaphone lines fail to schedule
        'ilVendorAvfCode = 0
        'slExtVendorLineID = ""
        slSQLQuery = "UPDATE pcf_Pod_CPM_Cntr SET pcfAvfCode=0, pcfExtVendorLineID='', pcfAdServDlvyStatus = " & ilAdServDlvyStatus & " WHERE pcfCode = " & lPcfCode
    Else
        slSQLQuery = "UPDATE pcf_Pod_CPM_Cntr SET pcfAvfCode=" & ilVendorAvfCode & ", pcfExtVendorLineID='" & slExtVendorLineID & "', pcfAdServDlvyStatus = " & ilAdServDlvyStatus & " WHERE pcfCode = " & lPcfCode
    End If
    'slSQLQuery = "UPDATE pcf_Pod_CPM_Cntr SET pcfAvfCode=" & ilVendorAvfCode & ", pcfExtVendorLineID='" & slExtVendorLineID & "', pcfAdServDlvyStatus = " & ilAdServDlvyStatus & " WHERE pcfCode = " & lPcfCode
    llRet = gSQLWaitNoMsgBox(slSQLQuery, False)
End Sub

'--------------------------------------------------------------------------------
' Procedure  :       mLoadPCFRecords
' Description:       Load PCF (Digital Lines) into an Array (tmCPcf) for the specified Contract Code
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:08:22
' Parameters :       llChfCode (Long)
'                    hlPcf (Integer)
'--------------------------------------------------------------------------------
Function mLoadPCFRecords(llChfCode As Long, hlPcf As Integer) As Boolean
    Dim ilUpper As Long
    Dim ilRet As Integer
    If llChfCode = 0 Then Exit Function
    'Get PCF records into array tmCPcf
    ReDim tmCPcf(0 To 0) As PCF
    ilUpper = 0
    imPcfRecLen = Len(tmPcf)
    tmPcfSrchKey2.lChfCode = llChfCode
    tmPcfSrchKey2.iVefCode = 0
    ilRet = btrGetGreaterOrEqual(hlPcf, tmCPcf(ilUpper), imPcfRecLen, tmPcfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmCPcf(ilUpper).lChfCode = llChfCode)
        ilUpper = ilUpper + 1
        ReDim Preserve tmCPcf(0 To ilUpper) As PCF
        If igDoEvent Then
            DoEvents
        End If
        ilRet = btrGetNext(hlPcf, tmCPcf(ilUpper), imPcfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    mLoadPCFRecords = True
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mGetVendorAdvertiserID
' Description:       Loads the External Vendor's Advertiser ID for the specified Vendor and Counterpoint Advertiser
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:07:38
' Parameters :       ilVendorAvfCode (Integer)
'                    ilAdfCode (Integer)
'--------------------------------------------------------------------------------
Function mGetVendorAdvertiserID(ilVendorAvfCode As Integer, ilAdfCode As Integer) As String
    Dim slSQLQuery As String
    Dim rst_Temp As ADODB.Recordset
    slSQLQuery = "Select vacExternalID from VAC_Vendor_Adf where vacAvfCode = " & ilVendorAvfCode & " and vacAdfCode = " & ilAdfCode
    Set rst_Temp = gSQLSelectCall(slSQLQuery)
    If Not rst_Temp.EOF Then
        mGetVendorAdvertiserID = Trim(rst_Temp!vacExternalID)
    End If
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mGetVendorContractID
' Description:       Loads the External Vendor's Contract ID for the specified Vendor and Counterpoint Contract
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:07:02
' Parameters :       ilVendorAvfCode (Integer)
'                    llCntrNo (Long)
'--------------------------------------------------------------------------------
Function mGetVendorContractID(ilVendorAvfCode As Integer, llCntrNo As Long) As String
    Dim slSQLQuery As String
    Dim rst_Temp As ADODB.Recordset
    slSQLQuery = "Select vccExternalID from VCC_Vendor_Ctr where vccAvfCode = " & ilVendorAvfCode & " and vccCntrNo = " & llCntrNo
    Set rst_Temp = gSQLSelectCall(slSQLQuery)
    If Not rst_Temp.EOF Then
        mGetVendorContractID = Trim(rst_Temp!vccExternalID)
    End If
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mGetContractHasVendorVehicle
' Description:       Determine if at least one Digital line contains a vehicle configured to use a specified Vendor
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:05:35
' Parameters :       ilVendorAvfCode (Integer)
'                    tmCPcf() (PCF)
'--------------------------------------------------------------------------------
Function mGetContractHasVendorVehicle(ilVendorAvfCode As Integer, tmCPcf() As PCF, llCntrNo As Long) As Boolean
    Dim ilLoop As Integer
    Dim ilVff As Integer
    If ilVendorAvfCode = 0 Then Exit Function
    'Look through each digital line on Contract
    For ilLoop = 0 To UBound(tmCPcf) - 1 'Fix per Jason Teams: 4/26/24 - 2:47pm
        'Look for matching Vehicle in VFF
        For ilVff = LBound(tgVff) To UBound(tgVff) Step 1
            If tgVff(ilVff).iVefCode = tmCPcf(ilLoop).iVefCode Then
                'Check if VFF Avf Code = Vendor's Code
                If tgVff(ilVff).iAvfCode = ilVendorAvfCode Then
                    mGetContractHasVendorVehicle = True
                    Exit For
                End If
                Exit For
            End If
        Next ilVff
        If mGetContractHasVendorVehicle = True Then Exit For
    Next ilLoop
    'Also Check the PCF records has/had a external vendor line ID which would indicate this Contract USED to be a Vendor contract, but is no longer
    If mGetContractHasVendorVehicle = False Then
        If mGetExistingVendorLineID(ilVendorAvfCode, llCntrNo, 0) <> "" Then
            mGetContractHasVendorVehicle = True
        End If
    End If
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mGetVendorLineTotal
' Description:       Get's the total gross for the Digital lines that have vehicles using the specified Vendor
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:05:01
' Parameters :       ilVendorAvfCode (Integer)
'                    tmCPcf() (PCF)
'--------------------------------------------------------------------------------
Function mGetVendorLineTotal(ilVendorAvfCode As Integer, tmCPcf() As PCF) As Long
    Dim ilLoop As Integer
    Dim llTotal As Long
    For ilLoop = 0 To UBound(tmCPcf) - 1
        'If Trim(mGetVendorVefID(ilVendorAvfCode, tmCPcf(ilLoop).iVefCode)) <> "" Then
        If mGetVefHasVendor(ilVendorAvfCode, tmCPcf(ilLoop).iVefCode) Then
            llTotal = llTotal + tmCPcf(ilLoop).lTotalCost
        End If
    Next ilLoop
    mGetVendorLineTotal = llTotal
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mGetVefHasVendor
' Description:       Returns True if the provided Vehicle is setup to use a specified Vendor
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:03:46
' Parameters :       ilVendorAvfCode (Integer)
'                    ilVefCode (Integer)
'--------------------------------------------------------------------------------
Function mGetVefHasVendor(ilVendorAvfCode As Integer, ilVefCode As Integer) As Boolean
    Dim ilVff As Integer
    For ilVff = LBound(tgVff) To UBound(tgVff) Step 1
        If tgVff(ilVff).iVefCode = ilVefCode Then
            If tgVff(ilVff).iAvfCode = ilVendorAvfCode Then
                mGetVefHasVendor = True
                Exit Function
            End If
            Exit For
        End If
    Next ilVff
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mGetVendorVefID
' Description:       Loads the External Vehicle ID for the specified Vendor and Vehicle
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:02:56
' Parameters :       ilVendorAvfCode (Integer)
'                    ilVefCode (Integer)
'--------------------------------------------------------------------------------
Function mGetVendorVefID(ilVendorAvfCode As Integer, ilVefCode As Integer) As String
    Dim slSQLQuery As String
    Dim rst_Temp As ADODB.Recordset
    slSQLQuery = "Select vvcExternalID from VVC_Vendor_Vef WHERE vvcAvfCode = " & ilVendorAvfCode & " AND vvcVefCode = " & ilVefCode
    Set rst_Temp = gSQLSelectCall(slSQLQuery)
    If Not rst_Temp.EOF Then
        mGetVendorVefID = Trim(rst_Temp!vvcExternalID)
    End If
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mUpdateDigitalDlvyStatus
' Description:       Updates the chfAdServDlvyStatus for the specified chfCode
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:02:16
' Parameters :       llChfCode (Long)
'                    ilDeliveryStatus (Integer)
' contract header field Digital Delivery Status for tracking the status of the contract push to the API. The three values will be:
' DeliveryStatus_NA (0): there are no digital lines on the contract, therefore this field is not applicable to this contract revision
' DeliveryStatus_NotPushed (1): the contract revision has not been pushed to the API
' DeliveryStatus_Pushed (2): the contract revision has been successfully pushed to the API
' DeliveryStatus_Partial (3):
' DeliveryStatus_IssueEncountered (4): an issue was encountered during the push to the API and it was not completely successful. For example, a contract could have two lines, one for a vehicle with a valid MegaphonePodcastID, which was accepted, and one with an invalid MegaphonePodcastID, which was rejected (show in red on contract dashboard)
' DeliveryStatus_RequiresRepush (5): it was pushed, but has been changed and now must be repushed
'--------------------------------------------------------------------------------
Sub mUpdateDigitalDlvyStatus(llChfCode As Long, ilDeliveryStatus As Integer)
    Dim slSQLQuery As String
    Dim llRet As Integer
    slSQLQuery = "UPDATE CHF_Contract_Header SET chfAdServDlvyStatus = " & ilDeliveryStatus & " Where chfCode = " & llChfCode
    llRet = gSQLWaitNoMsgBox(slSQLQuery, False)
End Sub

'--------------------------------------------------------------------------------
' Procedure  :       mSendToAPI
' Description:       Sends http request to specified URL
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:01:26
' Parameters :       slUrl (String)
'                    slAction (String)
'                    slBody (String)
'                    tlRequestHeaders() (HttpRequestHeader)
'                    slProcessStatus (String = "")
'--------------------------------------------------------------------------------
Function mSendToAPI(slUrl As String, slAction As String, slBody As String, tlRequestHeaders() As HttpRequestHeader, Optional slProcessStatus As String = "") As String
    Dim xhttp As New WinHttp.WinHttpRequest
    Dim slResponse As String
    Dim slResponseStatus As String
    Dim slResponseStatusText As String
    Dim ilLoop As Integer
    Dim ilLoop2 As Integer
    
    If bgApiDelay > 0 Then
        sgCntrSchStatus = "Waiting for Megaphone..."
        Do While bgApiDelay > 0
            DoEvents
        Loop
    End If
    
    If slProcessStatus = "" Then slProcessStatus = "Sending " & slAction & " request to API..."
    sgCntrSchStatus = slProcessStatus
    DoEvents
    
    'Try again, why not
    For ilLoop = 1 To 5
        On Error Resume Next
        If ilLoop = 5 Then On Error GoTo APIError
        slResponse = ""
        err = 0
        
        'Open xHttp connection
        xhttp.setTimeouts 15000, 15000, 15000, 15000
        Call xhttp.Open(slAction, slUrl, True)
        
        'Set request headers
        xhttp.setRequestHeader "Content-Type", "application/json"
        For ilLoop2 = 0 To UBound(tlRequestHeaders)
            If tlRequestHeaders(ilLoop2).sKey <> "" Then
                xhttp.setRequestHeader tlRequestHeaders(ilLoop2).sKey, tlRequestHeaders(ilLoop2).sValue
            End If
        Next ilLoop2
        
        'Send request
        xhttp.Send slBody
        xhttp.waitForResponse
        
        'Get response
        'Try getting reponse for up to 10 seconds
        For ilLoop2 = 0 To 100
            err = 0
            slResponse = ""
            slResponse = xhttp.responseText
            If slResponse <> "" And err = 0 Then Exit For
            Sleep 100
        Next ilLoop2
        
        slResponseStatusText = xhttp.StatusText
        slResponseStatus = xhttp.Status
        If err <> 0 Then
            sgAPIActivityLog = sgAPIActivityLog & " ! [Attempt:" & ilLoop & " failed] Send to API encountered error: " & err & " - " & Error(err) & vbCrLf
            If err = -2147483638 Then
                sgCntrSchStatus = "Waiting to retry Megaphone" & String(ilLoop, ".")
                bgApiDelay = 700
                Do While bgApiDelay > 0
                    DoEvents
                Loop
            Else
                sgCntrSchStatus = "Waiting to retry Megaphone (Error:" & err & "-" & Error(err) & ")" & String(ilLoop, ".")
                bgApiDelay = 700
                Do While bgApiDelay > 0
                    DoEvents
                Loop
            End If
        Else
            If Left(Trim(str(xhttp.Status)), 1) = "2" Then
                'Success
                Exit For
            Else
                sgAPIActivityLog = sgAPIActivityLog & " ! [Attempt:" & ilLoop & " failed] Send to API received HTTP error: " & slResponseStatus & " - " & slResponseStatusText & "; " & slResponse & vbCrLf
                sgCntrSchStatus = "Waiting to retry Megaphone (Http Error:" & slResponseStatus & " - " & slResponseStatusText & "; " & slResponse & ")" & String(ilLoop, ".")
                bgApiDelay = 700
                Do While bgApiDelay > 0
                    DoEvents
                Loop
            End If
        End If
    Next ilLoop
    
    If err <> 0 Then
        sgCntrSchStatus = "Failed to contact Megaphone (Error:" & err & "-" & Error(err) & ")" & String(ilLoop, ".")
        bgApiDelay = 700
        Do While bgApiDelay > 0
            DoEvents
        Loop
    End If
    
    If Left(Trim(str(xhttp.Status)), 1) <> "2" Then
        If InStr(1, slResponse, "<!DOCTYPE html>") > 0 Then
            slResponse = mConvertHTMLtoText(slResponse)
        End If
        If slResponse = "" Then slResponse = slResponseStatusText
        slResponse = Replace(slResponse, vbCrLf, ", ")
        slResponse = "Error:" & slResponse
        sgCntrSchStatus = "Failed to contact Megaphone (Http Error:" & slResponseStatus & " - " & slResponseStatusText & "; " & slResponse & ")" & String(ilLoop, ".")
    End If
    
    'Debug.Print slResponseStatus & ":" & slResponseStatusText & vbCrLf & slResponse
    mSendToAPI = slResponse
    On Error GoTo 0
    Exit Function
    
APIError:
    mSendToAPI = "Error sending to API:" & err & " - " & Error(err)
    Debug.Print mSendToAPI
    sgCntrSchStatus = mSendToAPI
    On Error GoTo 0
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mGetMNFName
' Description:       Get's the MNFName for a specified mnfCode
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:00:52
' Parameters :       iMnfItem (Integer)
'--------------------------------------------------------------------------------
Function mGetMnfName(iMnfItem As Integer) As String
    Dim ilRet As Integer
    tmMnfSrchKey.iCode = iMnfItem
    ilRet = btrGetEqual(hmMnf, tmMnf, imMnfRecLen, tmMnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
    gLogBtrError ilRet, "mGetMNFName: btrGetEqualMnf"
    mGetMnfName = Trim$(tmMnf.sName)
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mLogAPIMsg
' Description:       Writes message to log file "ScheduleAPI.Txt"
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/8/2024-10:00:20
' Parameters :       slString (String)
'--------------------------------------------------------------------------------
Sub mLogAPIMsg(slString As String)
    Dim hlMsg As Integer
    Dim slToFile As String
    Dim ilRet As Integer
    If sgAPIActivityLog = "" Then Exit Sub
    'On Error GoTo mGenTextFileErr:
    slToFile = sgDBPath & "Messages\ScheduleAPI.Txt"
    'hlMsg = FreeFile
    'Open slToFile For Append As hlMsg
    ilRet = gFileOpen(slToFile, "Append", hlMsg)
    If ilRet <> 0 Then
        MsgBox "Unable to Open " & slToFile & " Error #" & str(err.Number)
        Close #hlMsg
        Exit Sub
    End If
    Print #hlMsg, slString
    Close #hlMsg
End Sub

'--------------------------------------------------------------------------------
' Procedure  :       mConvertHTMLtoText
' Description:       Strips HTML and returns only the text part.  Multi lines are converted to a single comma-separated line
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/25/2024-10:00:20
' Parameters :       slHtml (String)
'--------------------------------------------------------------------------------
Function mConvertHTMLtoText(slHtml As String) As String
    If slHtml <> "" Then Exit Function
    Dim OutputText As String
    Dim slString() As String
    Dim ilLoop As Integer
    Dim oDoc As HTMLDocument
    Set oDoc = New HTMLDocument
    
    oDoc.Body.innerHTML = slHtml
    OutputText = ""
    slString = Split(oDoc.Body.innerText, vbCrLf)
    For ilLoop = 0 To UBound(slString)
        If Trim(slString(ilLoop)) <> "" Then
            If OutputText <> "" Then OutputText = OutputText & ","
            OutputText = OutputText & Trim(slString(ilLoop))
        End If
    Next ilLoop
    mConvertHTMLtoText = OutputText
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mDaylightSavingsTime
' Description:       returns True is provided DateTime string is in Daylight savings time
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       3/25/2024-10:30:20
' Parameters :       slDateTime (String)
'--------------------------------------------------------------------------------
Function mDaylightSavingsTime(slDateTime As String) As Boolean
    Dim slStartDate As String
    Dim slEndDate As String
    Dim ilDay As Integer
    Dim slDate As String

    'Start: 2nd sunday of march at 2:00 am
    slStartDate = "3/01/" & DatePart("yyyy", slDateTime)
    ilDay = DatePart("w", slStartDate)
    If ilDay <> 1 Then
        slStartDate = gObtainNextSunday(slStartDate)
    End If
    slStartDate = DateAdd("ww", 1, slStartDate)
    slStartDate = slStartDate & " 02:00:00AM"

    'End: 1st sunday in November at 2:00 am
    slEndDate = "11/01/" & DatePart("yyyy", slDateTime)
    ilDay = DatePart("w", slEndDate)
    If ilDay <> 1 Then
        slEndDate = gObtainNextSunday(slEndDate)
    End If
    slEndDate = slEndDate & " 02:00:00AM"

    'Check if provided DateTime string is between DST start and DST end
    If DateDiff("n", slStartDate, slDateTime) >= 0 Then
        If DateDiff("n", slEndDate, slDateTime) < 0 Then
            mDaylightSavingsTime = True
        End If
    End If
End Function

'--------------------------------------------------------------------------------
' Procedure  :       mGetTimezoneOffset
' Description:       returns number of hours to add to GMT
' Created by :       J. White
' Machine    :       CSI-FM
' Date-Time  :       4/4/2024-10:30:20
' Parameters :       slDateTime (String)
'--------------------------------------------------------------------------------
Function mGetTimezoneOffset(slTimeZone As String) As Integer
    Dim ilInteger As Integer
    Select Case slTimeZone
        Case "C" 'Central; UTC-06:00
            ilInteger = 6
        Case "M" 'Mountain; UTC-07:00
            ilInteger = 7
        Case "P" 'Pacific; UTC-08:00
            ilInteger = 8
        Case "A" 'Alaska; UTC-10:00
            ilInteger = 10
        Case "H" 'Hawaiian; UTC-10:00
            ilInteger = 10
        Case Else ' Eastern; UTC-05:00
            ilInteger = 5
    End Select
    mGetTimezoneOffset = ilInteger
End Function
