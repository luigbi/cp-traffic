Attribute VB_Name = "RPTCRCT"
' Copyright 1993 Counterpoint Software, Inc. All rights reserved.
' Proprietary Software, Do not copy
'
' File Name: RptCRct.Bas
'
' Release: 1.0
'
' Description:
'   This file contains the Report Get Data for Crystal screen code
Option Explicit
Option Compare Text

Const MAXWEEKSFOR2YRS = 105
Dim imMaxQtrs As Integer                '4-12-19 Default to 8 quarters to process, but change for each contract to speed up processing
Dim imATTExist As Integer       '9-24-03 if affiliate system used
Dim imHidden As Integer         'include hidden spots
Dim imCancel As Integer         'include cancelled spots
Dim imMiss As Integer           'include missed spots
Dim imRcf As Integer            '6-4-04 avails report, rate card index selected
Dim imUsingBarters As Integer
Dim imShowNetNet As Integer             '10-28-08 insertion orders - show net net
Dim imShowNTRBillSummary As Integer     '1-28-10 option to show NTR billing summary on the air time billing summary
Dim lmMatchingCnts() As Long            'stored contr numbers to process
Dim imDnfCodes() As Integer
Dim imAirWks(0 To MAXWEEKSFOR2YRS) As Integer       '11-14-11 account for 14 week qtr. Indedx zero ignored
                                      'from the contract is gathered, then build unique airing weeks
Dim imProcessFlag() As Integer        'flag to indicate what to do with the line: what processing mods (differences)
                                      'all of history is built, but should not be shown.  Also, all current lines
                                      'must be examined for the overall flight weeks.  0=ignore line altogether,
                                      '1=previous revision (use for differences), 2=current line but not on
                                      'same revision as header, don't show, 3=curent line (no previous revisions),
                                      'show on BR, 4 = current line same as header revision (show on BR)
Dim tlChfAdvtExt() As CHFADVTEXT
Dim tlMMnf() As MNF                    'array of MNF records for specific type
Dim tmPifKey() As PIFKEY          'array of vehicle codes and start/end indices pointing to the participant percentages
                                        'i.e Vehicle XYZ has 2 sales sources, each with 3 participants.  That will be a total of
                                        '6 entries.  Vehicle XYZ points to lo index equal to 1, and a hi index equal to 6; the
                                        'next vehicle will be a lo index of 7, etc.
Dim tmPifPct() As PIFPCT          'all vehicles and all percentages from PIF

Dim tmCntAllYear() As ALLPIFPCTYEAR      'all participant % for all vehicles for a contract for 12 months (1 or more vehicles each could have
                                         '1 or more participants
Dim tmOneVehAllYear() As ALLPIFPCTYEAR       'ss mnf code, mnfgroup, 1 year percentages for 1 vehicle (1 or more participants)
Dim tmOnePartAllYear As ONEPARTYEAR      'ss mnf code, mnfgroup, 1 years percentages for 1 participant

'The following arrays are built by the schedule line for as many weeks as there are in the order
Dim imWeeksPerQtr(0 To 8) As Integer           '11-11-11. Index zero ignored

Dim lmWklyspots() As Long          'array of spots by week for one sched line, reqd for research results
Dim lmWklyRates() As Long             'array of rates by week for one sch line, reqd for research results
Dim lmAvgAud() As Long                'array of avg aud by week for one sch line, reqd for research
Dim lmPopEst() As Long                'array of popestimates by week
Dim lmPop() As Long                   'array of population by vehicle
Dim lmPopPkg() As Long                '11-24-04 retain separate population for the package vehicles because user has same
                                      'hidden vehicle as pkg vehicle reference
Dim lmPopPkgByLine() As Long          '11-11-05 population by pkg line (i.e. whenmore than 1 pkg vehicle exists for 2 packages )
Dim tmLRch() As RESEARCHINFO          'research data for current revision of order by unique sch line, rate & daypart
Dim tmVCost() As Long
Dim tmVRtg() As Integer
Dim tmVGrimp() As Long
Dim tmVGRP() As Long
Dim tmVehQtrList() As VEHQTRLIST        'list of vehicles and their quarterly cpp, cpms, grimps and grps (max 2 years , 8 qtrs)
Dim tmPkVCost() As Long
Dim tmPkVRtg() As Integer
Dim tmPkVGrimp() As Long
Dim tmPkVGRP() As Long
Dim tmPkLnCost() As Long
Dim tmPkLnGrimp() As Long
Dim tmPkLnGRP() As Long
Dim tmWkCntGrps() As WEEKLYGRPS         '2-18-00
Dim tmWkCntVGrps() As WEEKLYGRPS        '2-18-00
Dim tmWkHiddenVGrps() As WEEKLYGRPS     '2-20-00
Dim tmWkPkgVGrps() As WEEKLYGRPS        '2-20-00
Dim imSelectedVehicles() As Integer '11-17-08 chg to module definition: selected vehicle codes for Insrtion orders (make search faster , avoid parsing every time)
Dim imAllVehicles As Integer        '11-17-08 chg to module definition
'Billed & Booked, Slsp projection, and Sales Comparison variables
Dim imInclZero                          '4-26-13 include $0 contracts on B & B
Dim lmSingleCntr As Long                'selective contract #
Dim smGrossOrNet As String              'G = gross, N = net
Dim imAdvt As Integer                  'true if advt option
Dim imSlsp As Integer                   'true if slsp option
Dim imVehicle As Integer                'true if vehicle option
Dim imOwner As Integer                  'true if owner option
Dim imAgency As Integer
Dim imVehSub As Integer                 'slsp option with sub-totals by vehicle
Dim imProdProt As Integer
Dim imBusCat As Integer
Dim imVehGroup As Integer
Dim imMajorSet As Integer               'major vehicle group selection
Dim imMinorSet As Integer               'minor vehicle group selection
Dim imPrimSort As Integer             'primary sort selection for Sales Comparison
Dim imSubSort As Integer              'minor sort selection for Sales Comparison
Dim imTrikIfOwner As Integer            '8-4-00 set to true if vehicle with participant split option
Dim lmProject(0 To 13) As Long          'projection $. Index zero ignored
Dim lmAcquisition(0 To 13) As Long      'acquisition $ to be adjusted (subtracted) from contracts. Index zero ignored
Dim lmAcquisitionNet(0 To 13) As Long   'Index zero ignored
Dim smAirOrder As String * 1         'Site Pref: inv all contracts as aired or ordered (A or O)
Dim tmAdjust() As ADJUSTLIST         'list of MGs $ and vehicles moved to
Dim tmSBFAdjust() As ADJUSTLIST
Dim imUpperAdjust As Integer         'running count of count of MGs built per contract
'Detail TieOut report arrays - these arrays may be by vehicle or office
Dim tmTieOut() As TIEOUT                  'array of all buckets for plans, orders, etc for 13 periods each
                                        'build by vehicle or office
'These are the records to be built for one office or vehicle  after all the CTF records have been processed
Dim lPctPlanOrders(0 To 17) As Long     'Pct to Plan: months 1-12, total year, plus 4 qtrs. Index zero ignored
Dim lNeed(0 To 17) As Long              'Need: months 1-12, total all twelve months, plus 4 qtrly totals. Index zero ignored
Dim lPctPlanNew(0 To 17) As Long        'Pct new Bus to Plan: months 1-12, total all twelve months, plus 4 qtrly totals. Index zero ignored
Dim lLYPctPlan(0 To 17) As Long         'Last Year Pct to Plan: months 1-12, total all twelve months, plus 4 qtrly totals. Index zero ignored
Dim lOOBSplit(0 To 17) As Long          'OOB Split: months 1-12, total all twelve months, plus 4 qtrly totals. Index zero ignored
Dim lPctSplit(0 To 17) As Long          'Pct Split to Plan: months 1-12, total all twelve months, plus 4 qtrly totals. Index zero ignored
Dim igTieOutUpper As Integer
'end of TieOut arrays
Dim tmLnr() As LNR              'arry of unique line & rates for BR
Dim tmJsr() As JSR
Dim hmJsr As Integer            'Spot Projection file handle
Dim tmJsrSrchKey As JSRKEY0           'JSR record image
Dim imJsrRecLen As Integer        'JSR record length
Dim hmSdf As Integer            'Spot detail file handle
Dim tmSdfSrchKey As SDFKEY0            'SDF record image (key 3)
Dim tmSdfSrchKey1 As SDFKEY1            'SDF record image (key 1)
Dim tmSdfSrchKey2 As SDFKEY2            'SDF record image (key 2)
Dim tmSdfSrchKey4 As SDFKEY4
Dim imSdfRecLen As Integer        'SDF record length
Dim tmSdf As SDF
Dim tmSdfInfo() As SDFSORTBYLINE
Dim tmSpotTypes As SPOTTYPES     'spot types to include
Dim tmSdfSrchKey3 As LONGKEY0     'SDF record image (SDF code as keyfield)
Dim hmSmf As Integer            'MG and outside Times file handle
Dim tmSmf As SMF                'RPF record image
Dim tmSmfSrchKey As SMFKEY0            'SMF record image
Dim tmSmfSrchKey1 As LONGKEY0           'SMF key1
Dim tmSmfSrchKey4 As SMFKEY4
Dim imSmfRecLen As Integer        'RPF record length
Dim hmCHF As Integer            'Contract header file handle
Dim hmTChf As Integer           'secondary contr header handle, so get next is not destroyed
Dim tmChfSrchKey As LONGKEY0            'CHF record image
Dim tmChfSrchKey1 As CHFKEY1            'CHF record image
Dim imCHFRecLen As Integer        'CHF record length
Dim tmChf As CHF
Dim tmTChf As CHF
Dim tmPChf As CHF                  'CHF - previous version header (for Differences BR)
Dim hmClf As Integer            'Contract line file handle
Dim tmClfSrchKey As CLFKEY0     'CLF record image
Dim imClfRecLen As Integer        'CLF record length
Dim tmClf As CLF
Dim tmPclf() As CLFLIST             'CLF previous version lines (for differences BR)
Dim tmCClf() As CLFLIST             'CLF current version lines (for differences BR)
Dim hmCff As Integer            'Contract flight file handle
Dim imCffRecLen As Integer      'CFF record length
Dim tmCff As CFF
Dim lmActPrice As Long          'actual spot price from cff, or the acquisition cost if Insrtion Order
Dim tmCCff() As CFFLIST         'CFF current version lines (for differences BR)
Dim tmPCff() As CFFLIST         'CFF previous version lines (for differences BR)

'10-20-05   sports files
Dim tmCgf As CGF
Dim imCgfRecLen As Integer
Dim hmCgf As Integer
Dim tmCgfSrchKey1 As CGFKEY1
Dim tmGsf As GSF
Dim imGsfRecLen As Integer
Dim hmGsf As Integer
Dim tmGsfSrchKey3 As GSFKEY3    'vehicle, then game #

Dim hmAdf As Integer            'Advertisr file handle
Dim imAdfRecLen As Integer      'ADF record length
Dim tmAdfSrchKey As INTKEY0     'ADF key image
Dim tmAdf As ADF
Dim hmAgf As Integer            'Agency file handle
Dim imAgfRecLen As Integer      'AGF record length
Dim tmAgfSrchKey As INTKEY0     'AGF key image
Dim tmAgf As AGF
Dim hmSof As Integer            'Office file handle
Dim imSofRecLen As Integer      'SOF record length
Dim tmSofSrchKey As INTKEY0     'SoF key image
Dim tmSof As SOF
Dim hmSlf As Integer            'Salesperson file handle
Dim imSlfRecLen As Integer      'SLF record length
Dim tmSlfSrchKey As INTKEY0     'SLF key image
Dim tmSlf As SLF
Dim hmUrf As Integer            'User file handle
Dim imUrfRecLen As Integer      'URF record length
Dim tmUrf As URF
Dim hmRdf As Integer            'Dayparts file handle
Dim imRdfRecLen As Integer      'RD record length
Dim tmRdfSrchKey As INTKEY0     'RDF key image
Dim tmRdf As RDF
Dim tmAvRdf() As RDF            'array of dayparts
Dim tmRifSorts() As RIF         'array of Rate Card items to obtain sort fields & whether to use Base or show on Rept
Dim hmDnf As Integer            'Demo file handle
Dim imDnfRecLen As Integer      'DNF record length
Dim tmDnfSrchKey As INTKEY0     'DNF key image
Dim tmDnf As DNF
Dim hmMnf As Integer            'Multiname file handle
Dim imMnfRecLen As Integer      'MNF record length
Dim tmMnfSrchKey As INTKEY0
Dim tmMnf As MNF
Dim tmMnfList() As MNFLIST        'array of mnf codes for Missed reasons and billing rules

Dim hmVbf As Integer            'Vehicle barter file handle
Dim imVBfRecLen As Integer      'VBF record length
Dim tmVbfSrchKey1 As VBFKEY1
Dim tmVbf As VBF

Dim hmCxf As Integer            'Comment file handle
Dim imCxfRecLen As Integer      'CXF record length
Dim tmCxfSrchKey As LONGKEY0    'CXF key record image
Dim tmCxf As CXF
Dim hmCbf As Integer            'Contract BR file handle
Dim imCbfRecLen As Integer      'CBF record length
Dim tmCbf As CBF
Dim tmZeroCbf As CBF

'4-23-13 File to hold the string of book names for a pkg on the contract summary (with research info), as well as the split network list shown on the detail page
'Split Network data matches on chfcode and time gen
'Package book names will match on chfcode, date/time gen, and seq = -1
Dim hmTxr As Integer            'Text string file handle
Dim tmTxr As TXR
Dim imTxrRecLen As Integer

Dim hmVef As Integer            'Vehicle file handle
Dim tmVef As VEF                'VEF record image
Dim tmVefSrchKey As INTKEY0            'VEF record image
Dim imVefRecLen As Integer        'VEF record length
Dim hmVsf As Integer            'Virtual Vehicle file handle
Dim tmVsf As VSF                'VSF record image
Dim imVsfRecLen As Integer        'VSF record length
Dim lmSProjDates(0 To 13) As Long   'Start Dates of spot projection dates. Index zero ignored
Dim lmEProjDates(0 To 13) As Long   'End dates of spot projection dates. Index zero ignored
Dim imAdfCode() As Integer
Dim imSelSlfCode() As Integer
Dim imSelAgfCode() As Integer       '4-08-08
Dim lmChfCode() As Long
Dim hmSsf As Integer            'Spot Summary file handle
Dim tmSsf As SSF                'SSF record image
Dim tmSsfSrchKey As SSFKEY0      'SSF key record image
Dim tmSsfSrchKey2 As SSFKEY2      'SSF key record image
Dim imSsfRecLen As Integer
Dim tmProg As PROGRAMSS
Dim tmAvail As AVAILSS
Dim tmSpot As CSPOTSS
'7-19-04 new field in ANF indicating if avail allows only Nework, local or both types of spots
Dim hmAnf As Integer            'Avail name file handle
Dim tmAnf As ANF                'ANF record image
Dim tmAnfTable() As ANF
Dim tmAnfSrchKey As INTKEY0            'ANF record image
Dim imAnfRecLen As Integer        'ANF record length

Dim tmRcf As RCF
Dim hmRcf As Integer            'Rate Card file handle
Dim tmMRif() As RIF
Dim tmMRDF() As RDF
Dim tmGrf As GRF
Dim hmGrf As Integer
Dim imGrfRecLen As Integer        'GPF record length
Dim tmBvf As BVF                  'Budgets by office & vehicle
Dim hmBvf As Integer
Dim tmBvfSrchKey As BVFKEY0       'Gen date and time
Dim imBvfRecLen As Integer        'BVF record length
'Quarterly Avails
Dim hmAvr As Integer            'Quarterly Avails file handle
Dim tmAvr() As AVR                'AVR record image
Dim tmAvrSrchKey As AVRKEY0            'AVR record image
Dim imAvrRecLen As Integer        'AVR record length
Dim lmSAvailsDates(0 To 13) As Long   'Start Dates of avail week. Index zero ignored
Dim lmEAvailsDates(0 To 13) As Long   'End dates of avail week. Index zero ignored
Dim smBucketType As String 'I=Inventory; A=Avail; S=Sold
Dim imMissed As Integer 'True = Include Missed
Dim imStandard As Integer
Dim imRemnant As Integer    'True=Include Remnant
Dim imReserv As Integer  'true = include reservations
Dim imDR As Integer     'True =Include Direct Response
Dim imPI As Integer     'True=Include per Inquiry
Dim imPSA As Integer    'True=Include PSA
Dim imPromo As Integer  'True=Include Promo
Dim imXtra As Integer   'true = include xtra bonus spots
Dim imNC As Integer     'true = include NC spots
Dim imHold As Integer   'true = include hold contracts
Dim imTrade As Integer  'true = include trade contracts
Dim imAirTime As Integer '11-25-02 true = include air time (vs NTR)
Dim imNTR As Integer    '11-25-02 true = include NTR
Dim imHardCost As Integer   '3-21-05 includee hard cost
Dim imOrder As Integer  'true = include Complete order contracts
Dim imOrphan As Integer 'true = use orphan category
Dim imLocked As Integer '3-13-03 true if include locked avails
Dim imLocal As Integer  '7-20-04 Include local vs network (feed)
Dim imFeed As Integer   '7-20-04 Include network (vs local)
Dim imAdjustAcquisition As Integer      '6-8-06
Dim imUseAcquisitionCost As Integer     'for billed & Booked, use acq. cost instead of gross or net from
                                        'receivables or spot rate from sch line
Dim imInclPolit As Integer             '10-2-06 include politicals for B & B / sales Comparison
Dim imInclNonPolit As Integer           '10-2-06 incl non-politicals for B & B/Sales comparison
Dim imInclAdj As Integer
'Log Calendar
Dim hmLcf As Integer            'Log Calendar file handle
Dim tmLcf As LCF                'LCF record image
Dim imLcfRecLen As Integer        'LCF record length
'  Media code File
'  Rating Book File
Dim hmDrf As Integer        'Rating book file handle
Dim tmDrf As DRF            'DRF record image
Dim imDrfRecLen As Integer  'DRF record length
'  Demo Plus  File
Dim hmDpf As Integer        'Demo Plus file handle
Dim tmDpf As DPF            'DPF record image
Dim imDpfRecLen As Integer  'DPF record length
'  Research Estimates
Dim hmDef As Integer
'  Receivables File
Dim hmRvf As Integer        'receivables file handle
Dim tmRvf As RVF            'RVF record image
Dim imRvfRecLen As Integer  'RVF record length

Dim hmPhf As Integer        'receivables file handle

Dim hmScf As Integer            'Slsp comm file handle
Dim tmScf As SCF                'SCF record image
Dim imScfRecLen As Integer        'SCF record length

Dim hmSbf As Integer        'SBF file handle
Dim tmSbf As SBF            'SBF record image
Dim tmSbfSrchKey As LONGKEY0 'SBF key record image
Dim imSbfRecLen As Integer  'SBF record length

'7-20-04    Network (feed)
Dim hmFsf As Integer        'SFF file handle
Dim tmFsf As FSF            'FSF record image
Dim tmFSFSrchKey As LONGKEY0 'FSF key record image
Dim imFsfRecLen As Integer  'FSF record length

'6-19-07 files for contract print to show list of split networks
Dim hmRaf As Integer        'RAF file handle
Dim hmSef As Integer        'SEF file handle
Dim hmShf As Integer        'SHTT file handle
Dim hmMkt As Integer        'MKT file handle
Dim hmVLF As Integer        'VLF file handle
Dim hmAtt As Integer        'ATT file handle

'12-11-20  Podcast cpm file
Dim hmPcf As Integer            'cpm podcast handle
Dim tmPcf() As PCF
Dim tmPcf2() As PCF         'All PCF records for all versions of the contract
Dim imPcfRecLen As Integer    'PCF record length
Dim hmThf As Integer            'cpm Pod Target header handle
Dim tmThf As PCF              'Thf record image
Dim imThRecLen As Integer    'Thf record length
Dim hmTif As Integer            'cpm pod Targe items handle
Dim tmTif As PCF              'Tif record image
Dim imTifRecLen As Integer    'Tif record length

Dim tmCPM_IDs() As CPM_BR         '12-16-20 podcast line IDs data for BR
Dim tmCPMSummary() As CPM_BR        '12-16-20 podcast vehicle summary data for BR

Dim tlSofList() As SOFLIST    'list of selling office codes and sales sourcecodes
'4-20-00 Buffers for Billed & Booked by Commissions
Dim lgNetDollars(0 To 18) As Long   'Index zero ignored
Dim lgCommDollars(0 To 18) As Long  'Index zero ignored
Dim dg12MonthTotal As Double            '2-28-08
Dim lgGrsDollars(0 To 18) As Long       '2-26-01. Index zero ignored
Dim dg12MonthAcquisition As Double      '2-28-08

Dim lmSlfSplit() As Long           '9-30-02 make 4 tables common: slsp slsp share %
Dim imSlfCode() As Integer
Dim imslfcomm() As Integer             'slsp under comm %
Dim imslfremnant() As Integer          'slsp under remnant %
Dim lmSlfSplitRev() As Long           '1-31-04 Rev % split for B & B Sales comm. if 0% and Slsp comm % in chf is non zero, calc
Dim lmSlfDiffComm As Long             '2-2-04
Dim lmPacingDate As Long                '11-21-05 Effective Pacing date for billed & booked option
Dim imDiffExceeds104Wks As Integer      '3-9-06 flag to indicate over 104 weeks on differences only version
Dim imHiddenOverride As Integer         '3-10-06 hidden overrides ignored for research
Dim tmTranTypes As TRANTYPES            '12-29-06
Dim imUseCodes() As Integer             'codes to include or exclude (for agy, advt, vehicle, etc)
Dim imUsevefcodes() As Integer        'array of vehicle codes to include/exclude
Dim imInclVefCodes As Integer               'flag to incl or exclude vehicle codes
Dim imUseAdfCodes() As Integer        'array of advt codes to include/exclude
Dim imInclAdfCodes As Integer               'flag to incl or exclude advt codes
Dim imUseAgfCodes() As Integer        'array of agy codes to include/exclude
Dim imInclAgfCodes As Integer               'flag to incl or exclude agy codes
Dim imUseCatCodes() As Integer        'array of bus category codes to include/exclude
Dim imInclCatCodes As Integer               'flag to incl or exclude bus category codes
Dim imUseProdCodes() As Integer        'array of prod prot codes to include/exclude
Dim imInclProdCodes As Integer               'flag to incl or exclude prod prot codes
Dim imUseSlfCodes() As Integer        'array of slsp codes to include/exclude
Type SPOTSBYLINEINX                 'for B & B by spots.  looks at array of spots for 1 contract that is sorted by line, then date
                                    'this contains the starting/ending index for each line for more efficiency to avoid rereading flights
    iLine As Integer
    lLoInx As Long
    lHiInx As Long
End Type

Type PKGVEHICLEFORSURVEYLIST            '12-19-13  this is only for the summary version to show book names (from hidden) for package vehicle
    iPkgVefCode As Integer              'pkg vehicle code (one entry per unique vehicle code)
    iHiddenDnfCode As Integer           'demo book code (one entry per unique vehicle code & book)
End Type

'7-16-08 ntr/hard cost
Dim tmMnfNtr() As MNF
Const NOT_SELECTED = 0
'10/27/14: 1 or 2 place rating
Dim sm1or2PlaceRating As String
Dim bmShowAudIfPodcast As Boolean           '4-18-18 option to show Aud % for Podcast vehicles on BR
Dim bmShowACT1Codes As Boolean
Dim smSnapshot As String * 1
Dim lmEmfCode As Long
Dim smResponseDate As String
Dim bmUseAcq As Boolean         'flag to use acq costs for differences (vs regular spot rates)
Dim imAcqLoInx As Integer
Dim imAcqHiInx As Integer
Dim imAcqCommPct As Integer
Dim tmAcqPctByPeriod() As ACQPctByPeriod
'11-14-11 account for 14 week qtr
Dim lmSpotsByWk() As Long  'array of 105 weeks (2 yrs) containing spot counts for unique spot rate
                                                'each one of these 104 week arrays correspond to one tmLnr entry
Dim lmratesbywk() As Long  'array of 105 weeks (2 yrs) containing spot rates per week
                                                'each one of these 104 week arrays correspond to one tmLnr entry
Dim tmQGRP() As Long
Dim tmQCPP() As Long
Dim tmQCPM() As Long
Dim tmQGrimp() As Long
Dim tmPodcast_Info() As PODCAST_INFO
Dim igDoe As Integer
Const LBONE = 1

Sub mBobSbfAdjustForInstall(tlSbf() As SBF, llStdStartDates() As Long, ilFirstProjInx As Integer, llStartAdjust As Long, llEndAdjust As Long, ilHowManyPer As Integer, ilListIndex As Integer, tlMnf() As MNF)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  ilIsItHardCost                                                                        *
    '******************************************************************************************
    Dim slDate As String
    Dim llDate As Long
    Dim ilMonthInx As Integer
    Dim ilFoundMonth As Integer
    Dim ilFoundVef As Integer
    Dim ilTemp As Integer
    'TTP 10855 - prevent overflow due to too many NTR items
    'Dim ilSBFLoop As Integer
    Dim llSBFLoop As Long
    Dim ilFoundOption As Integer

    For llSBFLoop = LBound(tlSbf) To UBound(tlSbf) - 1
        tmSbf = tlSbf(llSBFLoop)
        gUnpackDate tmSbf.iDate(0), tmSbf.iDate(1), slDate
        llDate = gDateValue(slDate)
        If llDate > llEndAdjust Then
            Exit Sub
        End If
        'SBF is OK with dates, adjust the $

        'determine if hard cost to be included for Billed & Booked; other reports dont have option or is
        'interspersed with non hard cost
        ilFoundOption = True                'default to include the NTR if no options exist and its not B & B or Recap report
        If (ilListIndex = CNT_BOB Or ilListIndex = CNT_BOBRECAP) And (igRptCallType = CONTRACTSJOB) Then
            If tlSbf(llSBFLoop).sTranType <> "F" Then            'installment
                ilFoundOption = False
            End If
        End If

        If ilFoundOption Then
            ilFoundMonth = False
            For ilMonthInx = ilFirstProjInx To ilHowManyPer Step 1         'loop thru months to find the match
                If llDate >= llStdStartDates(ilMonthInx) And llDate < llStdStartDates(ilMonthInx + 1) Then
                    ilFoundMonth = True
                    Exit For
                End If
            Next ilMonthInx

            ilFoundVef = False
            'setup vehicle that spot was moved to
            For ilTemp = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1 Step 1
                If tmSBFAdjust(ilTemp).iVefCode = tlSbf(llSBFLoop).iBillVefCode Then
                    ilFoundVef = True
                    Exit For
                End If
            Next ilTemp
            If Not (ilFoundVef) Then
                ilTemp = UBound(tmSBFAdjust)
                tmSBFAdjust(ilTemp).iVefCode = tlSbf(llSBFLoop).iBillVefCode
                'Installments from SBF need to set the agy Commission flag since its not coming from the SBF record,
                'but from the contract header
                tmSBFAdjust(ilTemp).iSlsCommPct = 0                         '4-25-08
                If tgChfCT.iAgfCode > 0 Then
                    tmSBFAdjust(ilTemp).sAgyComm = "Y"   '4-25-08
                Else
                    tmSBFAdjust(ilTemp).sAgyComm = "N"
                End If
                tmSBFAdjust(ilTemp).iIsItHardCost = False                   '4-25-08
                tmSBFAdjust(ilTemp).iMnfItem = 0                           '4-25-08
                
                If ilFoundMonth Then
                    tmSBFAdjust(ilTemp).lProject(ilMonthInx) = tmSBFAdjust(ilTemp).lProject(ilMonthInx) + tlSbf(llSBFLoop).lGross
                    tmSBFAdjust(ilTemp).lAcquisitionCost(ilMonthInx) = tmSBFAdjust(ilTemp).lAcquisitionCost(ilMonthInx) + (tlSbf(llSBFLoop).lAcquisitionCost)
                End If
                ReDim Preserve tmSBFAdjust(0 To UBound(tmSBFAdjust) + 1) As ADJUSTLIST
            Else
                If ilFoundMonth Then
                    tmSBFAdjust(ilTemp).lProject(ilMonthInx) = tmSBFAdjust(ilTemp).lProject(ilMonthInx) + tlSbf(llSBFLoop).lGross
                    tmSBFAdjust(ilTemp).lAcquisitionCost(ilMonthInx) = tmSBFAdjust(ilTemp).lAcquisitionCost(ilMonthInx) + (tlSbf(llSBFLoop).lAcquisitionCost)
                End If
            End If
        End If

    Next llSBFLoop
    Exit Sub
End Sub

'           mWriteJSRProj - write Spot Business Recordprepass record.
'           Calculate the net amount if requested
'           <input> slGrossOrNet : G = gross, N = Net
Public Sub mWriteJSRProj(slGrossNet As String, ilNumberPeriods As Integer)
    Dim ilNonZero As Integer
    Dim ilRec As Integer
    Dim illoop As Integer
    Dim tlCJsr As JSR
    Dim tlTJsr As JSR
    Dim slAmount As String
    Dim ilGrossNet As Integer
    Dim slTPct As String
    Dim ilTPct As Integer
    Dim slCPct As String
    Dim ilCPct As Integer
    Dim llNumberPeriods As Long
    Dim llAmount As Long
    Dim llCAmount As Long
    Dim ilRet As Integer
    Dim ilTradeGrossNet As Integer

    For ilRec = 0 To UBound(tmJsr) - 1 Step 1
        ilNonZero = False
        For illoop = LBound(tmJsr(ilRec).lSchDollars) To UBound(tmJsr(ilRec).lSchDollars) Step 1
            slAmount = gLongToStrDec(tmJsr(ilRec).lSchDollars(illoop), 2)
            If gCompNumberStr(slAmount, ".00") <> 0 Then
                ilNonZero = True
                Exit For
            End If
            slAmount = gLongToStrDec(tmJsr(ilRec).lMGODollars(illoop), 2)
            If gCompNumberStr(slAmount, ".00") <> 0 Then
                ilNonZero = True
                Exit For
            End If
            slAmount = gLongToStrDec(tmJsr(ilRec).lMCHDollars(illoop), 2)
            If gCompNumberStr(slAmount, ".00") <> 0 Then
                ilNonZero = True
                Exit For
            End If
        Next illoop
        If ilNonZero Then
            'Check Pct- If not 0 or 100 generate two records
            If slGrossNet = "G" Then
                ilGrossNet = 100
            Else
                If tmJsr(ilRec).iAgfCode = 0 Then          'direct
                    ilGrossNet = 100                'no commission
                Else
                    ilGrossNet = 85         'default to commissionable if no agency found
                    'see what the agency comm is defined as
                    tmAgfSrchKey.iCode = tmJsr(ilRec).iAgfCode
                    ilRet = btrGetEqual(hmAgf, tmAgf, Len(tmAgf), tmAgfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'get matching agy recd
                    If ilRet = BTRV_ERR_NONE Then
                        ilGrossNet = (10000 - tmAgf.iComm) / 100
                    End If          'ilret = btrv_err_none

                End If
            End If
            slTPct = gIntToStrDec(tmJsr(ilRec).iCorTPct, 0)
            If Val(slTPct) = 0 Then 'All Cash
                'For ilLoop = 1 To 13 Step 1
                For illoop = LBound(tmJsr(ilRec).lSchDollars) To UBound(tmJsr(ilRec).lSchDollars) Step 1
                    tmJsr(ilRec).lSchDollars(illoop) = tmJsr(ilRec).lSchDollars(illoop) '1-18-06/ 100
                    tmJsr(ilRec).lMGODollars(illoop) = tmJsr(ilRec).lMGODollars(illoop) '1-18-06/ 100
                    tmJsr(ilRec).lMCHDollars(illoop) = tmJsr(ilRec).lMCHDollars(illoop) '1-18-96/ 100
                    'add if mg $, missed/cancel/hidden $ with scheduled.  Take the net from that field if Net requested.
                    'Zero the MG and missed/cancel/hidden $ so crystal doesnt readd them.  (This is so Crystal doesnt need to be changed)
                    'If need to reinstate to Show MG, Missed/hidden/cancel lines in report, take out code that zeroes MG and missed buckets
                    '8-29-19 comm % not calculating properly when not in whole numbers, it is being truncated (i.e. 2.5% is truncated to 2%)
'                    tmJsr(ilRec).lSchDollars(ilLoop) = CLng(((tmJsr(ilRec).lSchDollars(ilLoop) + tmJsr(ilRec).lMGODollars(ilLoop) + tmJsr(ilRec).lMCHDollars(ilLoop)) / 100) * ilGrossNet)
                    tmJsr(ilRec).lSchDollars(illoop) = gGetGrossOrNetFromRate((tmJsr(ilRec).lSchDollars(illoop) + tmJsr(ilRec).lMGODollars(illoop) + tmJsr(ilRec).lMCHDollars(illoop)), slGrossNet, tmJsr(ilRec).iAgfCode)
                    tmJsr(ilRec).lMGODollars(illoop) = 0        'zero so Crystal wont add it into scheduled totals
                    tmJsr(ilRec).lMCHDollars(illoop) = 0
                Next illoop
                tmJsr(ilRec).sCorTFlag = "C"
                'tmJsr(ilRec).iMajorVGrp = ilMajorVGrp   '6-28-07 this was updated in mFilterProjData
                'dont write out record if the columns that are printing dont have any values
                llNumberPeriods = 0
                For illoop = LBound(tmJsr(ilRec).lSchDollars) To UBound(tmJsr(ilRec).lSchDollars) Step 1
                    If illoop + 1 <= ilNumberPeriods Then
                        llNumberPeriods = llNumberPeriods + tmJsr(ilRec).lSchDollars(illoop)
                    Else
                        tmJsr(ilRec).lSchDollars(illoop) = 0 'zero the columns not printed
                    End If
                Next illoop
                If llNumberPeriods <> 0 Then
                    ilRet = btrInsert(hmJsr, tmJsr(ilRec), imJsrRecLen, INDEXKEY0)
                End If
            ElseIf Val(slTPct) = 100 Then   'All trade
                If slGrossNet = "G" Then        'gross
                    ilGrossNet = 100
                Else                            'net
                    If tmJsr(ilRec).sAgyCTrade = "N" Then          'trade commissionable?
                        ilGrossNet = 100                        'no commission
                    Else
                        ilGrossNet = 85         'default to commissionable if no agency found

                        If tmJsr(ilRec).iAgfCode = 0 Then          'direct
                            ilGrossNet = 100                'no commission
                        Else
                            'see what the agency comm is defined as
                            If tmAgf.iCode = tmJsr(ilRec).iAgfCode Then  'same agy as what is already in memory?  if so, dont reread
                                 ilGrossNet = (10000 - tmAgf.iComm) / 100
                            Else
                                tmAgfSrchKey.iCode = tmJsr(ilRec).iAgfCode
                                ilRet = btrGetEqual(hmAgf, tmAgf, Len(tmAgf), tmAgfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'get matching agy recd
                                If ilRet = BTRV_ERR_NONE Then
                                    ilGrossNet = (10000 - tmAgf.iComm) / 100
                                End If          'ilret = btrv_err_none
                            End If
                        End If
                    End If
                End If

                For illoop = LBound(tmJsr(ilRec).lSchDollars) To UBound(tmJsr(ilRec).lSchDollars) Step 1
                    tmJsr(ilRec).lSchDollars(illoop) = tmJsr(ilRec).lSchDollars(illoop) '1-18-06/ 100
                    tmJsr(ilRec).lMGODollars(illoop) = tmJsr(ilRec).lMGODollars(illoop) '1-18-06/ 100
                    tmJsr(ilRec).lMCHDollars(illoop) = tmJsr(ilRec).lMCHDollars(illoop) '1-18-06/ 100
                    '8-29-19 comm % not calculating properly when not in whole numbers, it is being truncated (i.e. 2.5% is truncated to 2%)
'                    tmJsr(ilRec).lSchDollars(ilLoop) = CLng(((tmJsr(ilRec).lSchDollars(ilLoop) + tmJsr(ilRec).lMGODollars(ilLoop) + tmJsr(ilRec).lMCHDollars(ilLoop)) / 100) * ilGrossNet)
                    tmJsr(ilRec).lSchDollars(illoop) = gGetGrossOrNetFromRate((tmJsr(ilRec).lSchDollars(illoop) + tmJsr(ilRec).lMGODollars(illoop) + tmJsr(ilRec).lMCHDollars(illoop)), slGrossNet, tmJsr(ilRec).iAgfCode)
                    tmJsr(ilRec).lMGODollars(illoop) = 0        'zero so Crystal wont add it into scheduled totals
                    tmJsr(ilRec).lMCHDollars(illoop) = 0
                Next illoop
                tmJsr(ilRec).sCorTFlag = "T"
                'dont write out record if the columns that are printing dont have any values
                llNumberPeriods = 0
                'For ilLoop = 1 To 13 Step 1
                For illoop = LBound(tmJsr(ilRec).lSchDollars) To UBound(tmJsr(ilRec).lSchDollars) Step 1
                    'If ilLoop <= ilNumberPeriods Then
                    If illoop + 1 <= ilNumberPeriods Then
                        llNumberPeriods = llNumberPeriods + tmJsr(ilRec).lSchDollars(illoop)
                    Else
                        tmJsr(ilRec).lSchDollars(illoop) = 0 'zero the columns not printed
                    End If
                Next illoop
                If llNumberPeriods <> 0 Then
                    ilRet = btrInsert(hmJsr, tmJsr(ilRec), imJsrRecLen, INDEXKEY0)
                End If
            Else                                'split cash/trade contract
                'Split into two buckets- one cash, one trade
                'trade portion of cash/trade split (see if commissionable)
                If slGrossNet = "G" Then
                    ilTradeGrossNet = 100
                Else
                    If tmJsr(ilRec).sAgyCTrade = "N" Then          'trade split portion commissionable?
                        ilTradeGrossNet = 100                'no commission
                    Else
                        ilTradeGrossNet = 85

                        If tmJsr(ilRec).iAgfCode = 0 Then          'direct
                            ilGrossNet = 100                'no commission
                        Else
                            'see if trade portion is commissionable based on agency
                            'see what the agency comm is defined as
                            If tmAgf.iCode = tmJsr(ilRec).iAgfCode Then  'same agy as what is already in memory?  if so, dont reread
                                 ilGrossNet = (10000 - tmAgf.iComm) / 100
                            Else
                                tmAgfSrchKey.iCode = tmJsr(ilRec).iAgfCode
                                ilRet = btrGetEqual(hmAgf, tmAgf, Len(tmAgf), tmAgfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'get matching agy recd
                                If ilRet = BTRV_ERR_NONE Then
                                    ilGrossNet = (10000 - tmAgf.iComm) / 100
                                End If          'ilret = btrv_err_none
                            End If
                        End If
                    End If
                End If
                tlCJsr = tmJsr(ilRec)
                tlCJsr.sCorTFlag = "c"
                tlTJsr = tmJsr(ilRec)
                tlTJsr.sCorTFlag = "t"
                slCPct = gSubStr("100", slTPct)
                ilCPct = Val(slCPct)                '1-18-06
                tlCJsr.iCorTPct = gStrDecToInt(slCPct, 0)
                tlTJsr.iCorTPct = gStrDecToInt(slTPct, 0)
                ilTPct = Val(slTPct)                '1-18-06

                For illoop = LBound(tmJsr(ilRec).lSchDollars) To UBound(tmJsr(ilRec).lSchDollars) Step 1
                    llAmount = tmJsr(ilRec).lSchDollars(illoop)
                    llCAmount = (llAmount * ilCPct) / 100
                    tlCJsr.lSchDollars(illoop) = llCAmount                  'cash portion
                    tlTJsr.lSchDollars(illoop) = llAmount - llCAmount       'trade portion

                    llAmount = tmJsr(ilRec).lMGODollars(illoop)
                    llCAmount = (llAmount * ilCPct) / 100
                    tlCJsr.lMGODollars(illoop) = llCAmount                  'cash portion
                    tlTJsr.lMGODollars(illoop) = llAmount - llCAmount      'trade portion

                    llAmount = tmJsr(ilRec).lMCHDollars(illoop)
                    llCAmount = (llAmount * ilCPct) / 100
                    tlCJsr.lMCHDollars(illoop) = llCAmount                  'cash portion
                    tlTJsr.lMCHDollars(illoop) = llAmount - llCAmount       'trade portion
                    '8-29-19 comm % not calculating properly when not in whole numbers, it is being truncated (i.e. 2.5% is truncated to 2%)
'                    tlCJsr.lSchDollars(ilLoop) = CLng(((tlCJsr.lSchDollars(ilLoop) + tlCJsr.lMGODollars(ilLoop) + tlCJsr.lMCHDollars(ilLoop)) / 100) * ilGrossNet)
                    tlCJsr.lSchDollars(illoop) = gGetGrossOrNetFromRate((tlCJsr.lSchDollars(illoop) + tlCJsr.lMGODollars(illoop) + tlCJsr.lMCHDollars(illoop)), slGrossNet, tmJsr(ilRec).iAgfCode)
                    tlTJsr.lSchDollars(illoop) = gGetGrossOrNetFromRate((tlTJsr.lSchDollars(illoop) + tlTJsr.lMGODollars(illoop) + tlTJsr.lMCHDollars(illoop)), slGrossNet, tmJsr(ilRec).iAgfCode)
                    tlCJsr.lMGODollars(illoop) = 0        'zero so Crystal wont add it into scheduled totals
                    tlCJsr.lMCHDollars(illoop) = 0

                    tlTJsr.lMGODollars(illoop) = 0        'zero so Crystal wont add it into scheduled totals
                    tlTJsr.lMCHDollars(illoop) = 0
                Next illoop
                'dont write out record if the columns that are printing dont have any values
                llNumberPeriods = 0
                For illoop = LBound(tmJsr(ilRec).lSchDollars) To UBound(tmJsr(ilRec).lSchDollars) Step 1
                    If illoop + 1 <= ilNumberPeriods Then
                        llNumberPeriods = llNumberPeriods + tmJsr(ilRec).lSchDollars(illoop)
                    Else
                        tmJsr(ilRec).lSchDollars(illoop) = 0 'zero the columns not printed
                    End If
                Next illoop
                If llNumberPeriods <> 0 Then
                    ilRet = btrInsert(hmJsr, tlCJsr, imJsrRecLen, INDEXKEY0)
                End If
                
                'dont write out record if the columns that are printing dont have any values
                llNumberPeriods = 0
                'For ilLoop = 1 To 13 Step 1
                For illoop = LBound(tmJsr(ilRec).lSchDollars) To UBound(tmJsr(ilRec).lSchDollars) Step 1
                    If illoop + 1 <= ilNumberPeriods Then
                        llNumberPeriods = llNumberPeriods + tmJsr(ilRec).lSchDollars(illoop)
                    Else
                        tmJsr(ilRec).lSchDollars(illoop) = 0 'zero the columns not printed
                    End If
                Next illoop
                If llNumberPeriods <> 0 Then
                    ilRet = btrInsert(hmJsr, tlTJsr, imJsrRecLen, INDEXKEY0)
                End If
            End If
        End If
    Next ilRec
End Sub

'           mFilterProjData - test contract fields to determine if contract (spot
'           or NTR data should be included.  Keep Air Time and NTR data separate because
'           NTR could be non-commissionable when the air time is commissionable
'           <input> ilVefCode = vehicle code to process
'                   ilFilter - 1= advertiser, 2 = contract, 3 = salesperson selectivity
'                   slSpotOrNTR : A = Air Time, N = NTR
'                   slNTRComm - 4-6-15 add flag for NTR indicating commissionable or not.  Need to separate them out
'           <output> ilIndex = retd index into the array to accumulate$
'           <return> true  - valid entry
'                   false - ignore the spot or NTR
Public Function mFilterProjData(ilVefCode As Integer, ilfilter As Integer, slSpotOrNTR As String, ilIndex As Integer, Optional slNTRComm As String = "Y") As Integer
    Dim ilOk As Integer
    Dim illoop As Integer
    Dim ilFound As Integer
    Dim ilMajorVGrp As Integer
    Dim ilRet As Integer
    Dim ilIsItHardCost As Integer

    ilOk = True                 'assume its a valid record
    If slSpotOrNTR = "N" Then           'NTR, ignore the NTR entries associated with deleted headers.
                                        'for spots, use the header as the spot retrieved is scheduled
        If tmChf.sDelete = "Y" Then
            ilOk = False
        End If
        'determine hardcost selectivity vs regular NTR
        ilIsItHardCost = gIsItHardCost(tmSbf.iMnfItem, tlMMnf())
        If ilIsItHardCost Then              'hard cost item
            If Not imHardCost Then
                ilOk = False
            End If
        Else                                'normal NTR
            If Not imNTR Then
                ilOk = False
            End If
        End If
    End If

    If tmChf.iPctTrade = 100 And Not imTrade Then       'only exclude trade if 100%
        ilOk = False
    End If
    If mCheckAdvPolitical(tmChf.iAdfCode) Then          'its a political, include this contract?
         If Not imInclPolit Then
            ilOk = False
        End If
    Else                                                'not a political advt, include this contract?
         If Not imInclNonPolit Then
            ilOk = False
        End If
    End If
    If (tmChf.sType = "S") Or (tmChf.sType = "M") Then
        ilOk = False
    ElseIf (tmChf.sStatus = "H" And Not imHold) Then        'exclude holds
        ilOk = False
    ElseIf (tmChf.sStatus = "O" And Not imOrder) Then        'exclude orders
        ilOk = False
    ElseIf (tmChf.sStatus = "W" Or tmChf.sStatus = "I" Or tmChf.sStatus = "D" Or tmChf.sStatus = "C") Then
        ilOk = False
    ElseIf (tmChf.sType = "C" And Not imStandard) Then        'exclude standard
        ilOk = False
    ElseIf (tmChf.sType = "V" And Not imReserv) Then        'exclude reservations
        ilOk = False
    ElseIf (tmChf.sType = "T" And Not imRemnant) Then        'exclude remnant
        ilOk = False
    ElseIf (tmChf.sType = "R" And Not imDR) Then              'exclude Direct Response
        ilOk = False
    ElseIf (tmChf.sType = "Q" And Not imPI) Then        'exclude Per inquiry
        ilOk = False
    ElseIf (tmChf.sType = "S" And Not imPSA) Then        'exclude PSA
        ilOk = False
    ElseIf (tmChf.sType = "M" And Not imPromo) Then        'exclude Promo
        ilOk = False
    End If                       'must be at least Hold or Order

    If (lmSingleCntr <> 0 And lmSingleCntr <> tmChf.lCntrNo) Then
        ilOk = False
    End If

    If ilOk Then
        If ilfilter = 1 Then    'Advertiser
            ilOk = False
            For illoop = 0 To UBound(imAdfCode) - 1 Step 1
                If imAdfCode(illoop) = tmChf.iAdfCode Then
                    ilOk = True
                    Exit For
                End If
            Next illoop
        ElseIf ilfilter = 2 Then    'Contract
            ilOk = False
            For illoop = 0 To UBound(lmChfCode) - 1 Step 1
                If lmChfCode(illoop) = tmChf.lCode Then
                    ilOk = True
                    Exit For
                End If
            Next illoop
        ElseIf ilfilter = 3 Then    'Salesperson
            ilOk = False
            For illoop = 0 To UBound(imSelSlfCode) - 1 Step 1
                If imSelSlfCode(illoop) = tmChf.iSlfCode(0) Then
                    ilOk = True
                    Exit For
                End If
            Next illoop

        ElseIf ilfilter = 4 Then         'agency
            ilOk = False
            If RptSelCt!ckcAll.Value = vbChecked Then           'all
                ilOk = True
            Else
                For illoop = 0 To UBound(imSelAgfCode) - 1 Step 1
                    If tmChf.iAgfCode = 0 Then              'direct
                        If imSelAgfCode(illoop) = -tmChf.iAdfCode Then
                            ilOk = True
                            Exit For
                        End If
                    Else            'normal agency
                        If imSelAgfCode(illoop) = tmChf.iAgfCode Then
                            ilOk = True
                            Exit For
                        End If
                    End If
                Next illoop
            End If
        End If
    End If

    If ilOk Then
        For illoop = 0 To UBound(tmJsr) - 1 Step 1
            'keep air time separate from NTR of the same contract
            If slSpotOrNTR = "N" Then
                If tmJsr(illoop).lCntrNo = tmChf.lCntrNo And tmJsr(illoop).sProjType = slSpotOrNTR And ilVefCode = tmJsr(illoop).iVefCode And tmJsr(illoop).sComm = slNTRComm Then
                    ilFound = True
                    ilIndex = illoop
                    Exit For
                End If
            Else
                'every contract or adjustment should have a slsp and advt reference
                If tmJsr(illoop).lCntrNo = tmChf.lCntrNo And tmJsr(illoop).sProjType = slSpotOrNTR And tmJsr(illoop).iSlfCode = tmChf.iSlfCode(0) And tmJsr(illoop).iAdfCode = tmChf.iAdfCode And tmJsr(illoop).iAgfCode = tmChf.iAgfCode Then
                    ilFound = True
                    ilIndex = illoop
                    Exit For
                End If
            End If
        Next illoop
        If Not ilFound Then
            ilIndex = UBound(tmJsr)
            ReDim Preserve tmJsr(0 To ilIndex + 1) As JSR
            tmJsr(ilIndex).iGenDate(0) = igNowDate(0)
            tmJsr(ilIndex).iGenDate(1) = igNowDate(1)
            gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
            tmJsr(ilIndex).lGenTime = lgNowTime
            tmJsr(ilIndex).iPdStartDate(0) = igPdStartDate(0)
            tmJsr(ilIndex).iPdStartDate(1) = igPdStartDate(1)
            tmJsr(ilIndex).sPdType = sgPdType
            tmJsr(ilIndex).lCntrNo = tmChf.lCntrNo
            tmJsr(ilIndex).lCntrCode = tmChf.lCode                  '1/23/98 so crystal (6 versions) dont need to be changed
            tmJsr(ilIndex).sAgyCTrade = tmChf.sAgyCTrade            '1/26/98 so that net calc done in prepass (not crystal)
            tmJsr(ilIndex).iAgfCode = tmChf.iAgfCode                '1/26/98 so that prepass knows if commissionable or not
            tmJsr(ilIndex).iAdfCode = tmChf.iAdfCode
            tmJsr(ilIndex).iSlfCode = tmChf.iSlfCode(0)
            tmJsr(ilIndex).iVefCode = ilVefCode   '.iVefCode
            tmJsr(ilIndex).iCorTPct = tmChf.iPctTrade
            tmJsr(ilIndex).sCorTFlag = " "
            tmJsr(ilIndex).sProjType = slSpotOrNTR
            If slSpotOrNTR = "A" Then         'Air Time
                If tmChf.iAgfCode = 0 Then          'no agency, direct (no agy comm)
                    tmJsr(ilIndex).sComm = "N"
                Else
                    tmJsr(ilIndex).sComm = "Y"
                End If
            Else
                If tmChf.iAgfCode = 0 Then          'no agency, direct (no comm)
                    tmJsr(ilIndex).sComm = "N"
                Else                                'has agy comm, detrmine if commissionable based on the NTR item
                    tmJsr(ilIndex).sComm = tmSbf.sAgyComm
                End If
            End If
            gGetVehGrpSets ilVefCode, imMinorSet, imMajorSet, ilRet, ilMajorVGrp   'ilret = minor sort code(unused), ilMajorVehGrp = major sort code
            tmJsr(ilIndex).iMajorVGrp = ilMajorVGrp

            'For ilLoop = 1 To 13 Step 1
            For illoop = LBound(tmJsr(ilIndex).lSchDollars) To UBound(tmJsr(ilIndex).lSchDollars) Step 1
                tmJsr(ilIndex).lSchDollars(illoop) = 0
                tmJsr(ilIndex).lMGODollars(illoop) = 0
                tmJsr(ilIndex).lMCHDollars(illoop) = 0
            Next illoop
        End If
    End If
    mFilterProjData = ilOk
End Function

'                   mSetCostType - set up bit string in ilCostType for
'                   the types of spots to include
'                   Used in spots by ADvt and Spots by Date & Time
'                   Include: Charged, 0.00, ADU, Bonus, Extra, Fill
'                   No Charge, Nc MG, recaptureable, & spinoff
'                   <output> ilCosttype - as bit string
Sub mSetCostType(ilCostType As Integer)
    ilCostType = 0
    If RptSelCt!ckcSelC3(0).Value = vbChecked Then
        ilCostType = ilCostType Or SPOT_CHARGE          'bit 0
    End If
    If RptSelCt!ckcSelC3(1).Value = vbChecked Then
        ilCostType = ilCostType Or SPOT_00
    End If
    If RptSelCt!ckcSelC3(2).Value = vbChecked Then
        ilCostType = ilCostType Or SPOT_ADU
    End If
    If RptSelCt!ckcSelC3(3).Value = vbChecked Then
        ilCostType = ilCostType Or SPOT_BONUS
    End If
    If RptSelCt!ckcSelC3(4).Value = vbChecked Then
        ilCostType = ilCostType Or SPOT_EXTRA
    End If
    If RptSelCt!ckcSelC3(5).Value = vbChecked Then
        ilCostType = ilCostType Or SPOT_FILL
    End If
    If RptSelCt!ckcSelC3(6).Value = vbChecked Then
        ilCostType = ilCostType Or SPOT_NC
    End If
    If RptSelCt!ckcSelC3(7).Value = vbChecked Then
        ilCostType = ilCostType Or SPOT_MG
    End If
    If RptSelCt!ckcSelC3(8).Value = vbChecked Then
        ilCostType = ilCostType Or SPOT_RECAP
    End If
    If RptSelCt!ckcSelC3(9).Value = vbChecked Then                     'bit 9
        ilCostType = ilCostType Or SPOT_SPINOFF
    End If
End Sub

'                                           comm but dont show gross & net from which it was calc from.  Comm % allowed to exceed 100% in chf
'**********************************************************
'*                                                        *
'*      Procedure Name:mgetATTbyVef                       *
'*                                                        *
'*             Created:9/24/03      By:D. Hosaka          *
'*                                                        *
'*            Comments: Gather count of active agreement  *
'               for a given vehicle.  REturn count
'                                                         *
'       <input> ilvefcode - vehicle code to retrieve      *
'                           agreements                    *
'               slActiveStart - agreement must be greater *
'                           or equal to this date         *
'               slActiveEnd - agreement must be less      *
'                           equal to this date            *
'       <return> count of active agreements               *
'*
'*  2-1-06 ADD OPTION to include diffrent types of agreements:
'               maual, web or marketron
'**********************************************************
Private Sub mGetATTbyVef(hlAtt As Integer, ilVefCode As Integer, llActiveStart As Long, llActiveEnd As Long, ilCountATT As Integer, ilLoadCount As Integer, ilInclManual As Integer, ilInclWeb As Integer, ilInclMkt As Integer)
    Dim ilRet As Integer
    Dim llNoRec As Long
    Dim ilExtLen As Integer
    Dim llRecPos As Long
    Dim ilOffSet As Integer
    Dim llAttStart As Long
    Dim llAttEnd As Long
    Dim llTemp As Long
    Dim tlIntTypeBuff As POPINTEGERTYPE   'Type field record
    Dim tlAtt As ATT
    Dim ilAttRecLen As Integer
    Dim tlATTSrchKey1 As INTKEY0

    ilCountATT = 0
    ilLoadCount = 0
    If Not imATTExist Then
        Exit Sub
    End If

    ilExtLen = Len(tlAtt)    'Extract operation record size
    ilAttRecLen = Len(tlAtt)
    llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlAnf) 'Obtain number of records
    btrExtClear hlAtt   'Clear any previous extend operation
    tlATTSrchKey1.iCode = ilVefCode
    ilRet = btrGetEqual(hlAtt, tlAtt, ilAttRecLen, tlATTSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)
    If ilRet <> BTRV_ERR_NONE Then
        Exit Sub
    End If
    Call btrExtSetBounds(hlAtt, llNoRec, -1, "UC", "ATT", "") 'Set extract limits (all records)
    tlIntTypeBuff.iType = ilVefCode
    ilOffSet = gFieldOffset("ATT", "ATTVEFCODE")
    ilRet = btrExtAddLogicConst(hlAtt, BTRV_KT_INT, ilOffSet, 2, BTRV_EXT_EQUAL, BTRV_EXT_LAST_TERM, tlIntTypeBuff, 2)

    If ilRet <> BTRV_ERR_NONE Then
        Exit Sub
    End If
    ilRet = btrExtGetNext(hlAtt, tlAtt, ilExtLen, llRecPos)
    If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
        If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
            Exit Sub
        End If
        Do While ilRet = BTRV_ERR_REJECT_COUNT
            ilRet = btrExtGetNext(hlAtt, tlAtt, ilExtLen, llRecPos)
        Loop
        Do While ilRet = BTRV_ERR_NONE
            '2-1-06 only include the agreements types selected by user
            If (tlAtt.iCarryCmml = 0) And ((tlAtt.iExportType = 0 And ilInclManual = True) Or (tlAtt.iExportType = 1 And ilInclWeb = True) Or (tlAtt.iExportType = 2 And ilInclMkt = True)) Then
                gUnpackDateLong tlAtt.iOnAir(0), tlAtt.iOnAir(1), llAttStart
                gUnpackDateLong tlAtt.iOffAir(0), tlAtt.iOffAir(1), llAttEnd
                gUnpackDateLong tlAtt.iDropDate(0), tlAtt.iDropDate(1), llTemp  'drop date
                If llAttEnd = 0 Then        'if the agreement offair is TFN, make it the same as the requested
                                            'end date so it falls within the test
                    llAttEnd = llActiveEnd
                End If
                If llTemp <> 0 And llTemp < llAttEnd Then 'use the drop date if its earlier than the off air date (and not tfn)
                    llAttEnd = llTemp           'drop date is earlier
                End If
                If (llActiveStart <= llAttEnd And llActiveEnd >= llAttStart) Or (llActiveEnd >= llAttStart And llActiveEnd <= llAttEnd) Then  'test if requested dates span the active date of agreement
                    'test agreement start/end dates
                    If tlAtt.iLoad > 1 Then
                        ilLoadCount = ilLoadCount + (tlAtt.iLoad - 1) 'adjust for the count of true agreements
                        ilCountATT = ilCountATT + 1
                    Else
                        ilCountATT = ilCountATT + 1
                    End If

                End If

            End If
            ilRet = btrExtGetNext(hlAtt, tlAtt, ilExtLen, llRecPos)
            Do While ilRet = BTRV_ERR_REJECT_COUNT
                ilRet = btrExtGetNext(hlAtt, tlAtt, ilExtLen, llRecPos)
            Loop
        Loop
    End If
    Exit Sub
End Sub

'           mGetHiddenWkVGrs - Calculate the grps for each week individually
'           for hidden line totals by vehicle.  For packages only.
'           <input> llResearchPop - population
'                   ilVehlist() array of vehicle codes
'                   ilPkgLineList() array of package line #s
'           <output> 104 weekly grps for all lines
'           1-23-03
Sub mGetHiddenWkVGrps(llInResearchPop As Long, ilVehList() As Integer, ilPkgLineList() As Integer)
    Dim ilWeekly As Integer
    Dim ilWeeklyMinusOne As Integer
    Dim llLnSpots As Long
    Dim llCPP As Long
    Dim llCPM As Long
    Dim llAvgAud As Long
    Dim dlTotalCost As Double 'TTP 10439 - Rerate 21,000,000
    Dim llGrimps As Long
    Dim ilVehicle As Integer
    Dim ilUpperGrp As Integer
    Dim ilFound As Integer
    Dim illoop As Integer
    Dim ilPkgVehLoop As Integer
    Dim llResearchPop As Long           '6-29-04
    Dim llQtr As Long                   '4-10-19    replace ilQtr due to subscript out of range
    Dim llRchQtr As Long                '4-10-19    replace ilRchQtr
    Dim llVaryingQtrs As Long           '4-10-19    replace ilVaryingQtrs

    '2-11-00 Build weekly grps for all unique vehicles within a package.  Each line entry is 8 quarters (max 2 years).  Entries are unique
    'for  vehicle/daypart/#spots/line rate
    ReDim tmWkHiddenVGrps(0 To 0) As WEEKLYGRPS
    ilUpperGrp = 0
    For ilPkgVehLoop = LBound(ilPkgLineList) To UBound(ilPkgLineList) - 1 Step 1
        For ilVehicle = LBound(ilVehList) To UBound(ilVehList) - 1
            llVaryingQtrs = 0                     '11-14-11 handle varying quarters
           For llQtr = 1 To imMaxQtrs Step 1              'cycle thru 8 quarters
               For ilWeekly = 1 To imWeeksPerQtr(llQtr)
                    ilWeeklyMinusOne = ilWeekly - 1
                    ReDim tmVRtg(0 To 0) As Integer
                    ReDim tmVCost(0 To 0) As Long
                    ReDim tmVGRP(0 To 0) As Long
                    ReDim tmVGrimp(0 To 0) As Long

                    llLnSpots = 0
                    If tgSpf.sDemoEstAllowed = "Y" Then
                        llResearchPop = -1
                    Else
                        llResearchPop = llInResearchPop
                    End If
                    For llRchQtr = llQtr To UBound(tmLRch) - 1 Step 8   'process as many lines that are built
                        If (tmLRch(llRchQtr).sType = "H") And (tmLRch(llRchQtr).iVefCode = ilVehList(ilVehicle)) And (tmLRch(llRchQtr).iPkLineNo = ilPkgLineList(ilPkgVehLoop)) Then
                            llLnSpots = llLnSpots + tmLRch(llRchQtr).lSpots(ilWeeklyMinusOne)
                            If (tmLRch(llRchQtr).lSpots(ilWeeklyMinusOne) <> 0) Then              'only process if spots exist in the qtr
                                tmVRtg(UBound(tmVRtg)) = tmLRch(llRchQtr).iWklyRating(ilWeeklyMinusOne) '2-17-00
                                tmVCost(UBound(tmVCost)) = tmLRch(llRchQtr).lRates(ilWeeklyMinusOne)
                                tmVGRP(UBound(tmVGRP)) = tmLRch(llRchQtr).lWklyGRP(ilWeeklyMinusOne)
                                tmVGrimp(UBound(tmVGrimp)) = tmLRch(llRchQtr).lWklyGrimp(ilWeeklyMinusOne)
                                If tgSpf.sDemoEstAllowed = "Y" Then
                                    If llResearchPop = -1 Then
                                        llResearchPop = tmLRch(llRchQtr).lPopEst(ilWeeklyMinusOne)
                                    Else
                                        If llResearchPop <> tmLRch(llRchQtr).lPopEst(ilWeeklyMinusOne) And llResearchPop <> 0 Then
                                            llResearchPop = 0
                                        End If
                                    End If
                                End If
                                ReDim Preserve tmVRtg(0 To UBound(tmVRtg) + 1) As Integer
                                ReDim Preserve tmVCost(0 To UBound(tmVCost) + 1) As Long
                                ReDim Preserve tmVGRP(0 To UBound(tmVGRP) + 1) As Long
                                ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) + 1) As Long
                            End If
                        End If
                    Next llRchQtr
                    'If UBound(tmVRtg) > 1 Then
                    If UBound(tmVRtg) > LBound(tmVRtg) Then
                        'dimensions must be exact sizes
                        ReDim Preserve tmVRtg(0 To UBound(tmVRtg) - 1) As Integer
                        ReDim Preserve tmVCost(0 To UBound(tmVCost) - 1) As Long
                        ReDim Preserve tmVGRP(0 To UBound(tmVGRP) - 1) As Long
                        ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) - 1) As Long
                        llRchQtr = llVaryingQtrs + ilWeekly         '11-14-11
                        'only care about the weeks grps
                        ilFound = False
                        For illoop = LBound(tmWkHiddenVGrps) To UBound(tmWkHiddenVGrps) - 1
                            If tmWkHiddenVGrps(illoop).iVefCode = ilVehList(ilVehicle) And tmWkHiddenVGrps(illoop).iPkLineNo = ilPkgLineList(ilPkgVehLoop) Then
                                ilFound = True
                                Exit For
                            End If
                        Next illoop
                        If ilFound Then
                            'gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, llTotalCost, tmCbf.iAvgRate, llGrimps, tmWkHiddenVGrps(illoop).lGrps(llRchQtr), llCPP, llCPM, llAvgAud
                            gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, dlTotalCost, tmCbf.iAvgRate, llGrimps, tmWkHiddenVGrps(illoop).lGrps(llRchQtr), llCPP, llCPM, llAvgAud 'TTP 10439 - Rerate 21,000,000
                        Else
                            tmWkHiddenVGrps(ilUpperGrp).iVefCode = ilVehList(ilVehicle)
                            tmWkHiddenVGrps(ilUpperGrp).iPkLineNo = ilPkgLineList(ilPkgVehLoop)

                            'gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, llTotalCost, tmCbf.iAvgRate, llGrimps, tmWkHiddenVGrps(ilUpperGrp).lGrps(llRchQtr), llCPP, llCPM, llAvgAud
                            gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, dlTotalCost, tmCbf.iAvgRate, llGrimps, tmWkHiddenVGrps(ilUpperGrp).lGrps(llRchQtr), llCPP, llCPM, llAvgAud 'TTP 10439 - Rerate 21,000,000
                            ilUpperGrp = UBound(tmWkHiddenVGrps) + 1
                            ReDim Preserve tmWkHiddenVGrps(0 To ilUpperGrp) As WEEKLYGRPS
                        End If
                    End If
                Next ilWeekly
                llVaryingQtrs = llVaryingQtrs + imWeeksPerQtr(llQtr)
            Next llQtr
        Next ilVehicle
    Next ilPkgVehLoop
    Erase tmVRtg
    Erase tmVCost
    Erase tmVGRP
    Erase tmVGrimp
End Sub

'                   mBobSbfAdjustForNTR -  determine where item billing $ goes (Billed & Booked)
'                   <input> tlSbf() - array of SBF records to process
'                           llstdstartDates() - array of 13 start dates of the 12 months to gather
'                           ilFirstProjInx - index of first month to start projection (earlier is from receivables)
'                           llStartAdjust -  Earliest date to start searching for missed, etc.
'                           llEndAdjust - latest date to stop searchng for missed, etc.
'                           ilHowManyPer - # of periods to gather
'                                           (for billed & booked its 12,
'                                           for Sales Comparisons its max 3)
Sub mBobSbfAdjustForNTR(tlSbf() As SBF, llStdStartDates() As Long, ilFirstProjInx As Integer, llStartAdjust As Long, llEndAdjust As Long, ilHowManyPer As Integer, ilListIndex As Integer, tlMnf() As MNF)
    Dim slDate As String
    Dim llDate As Long
    Dim ilMonthInx As Integer
    Dim ilFoundMonth As Integer
    Dim ilFoundVef As Integer
    Dim ilTemp As Integer
    'TTP 10855 - prevent overflow due to too many NTR items
    'Dim ilSBFLoop As Integer
    Dim llSBFLoop As Long
    Dim ilIsItHardCost As Integer
    Dim ilFoundOption As Integer

    For llSBFLoop = LBound(tlSbf) To UBound(tlSbf) - 1
        tmSbf = tlSbf(llSBFLoop)
        gUnpackDate tmSbf.iDate(0), tmSbf.iDate(1), slDate
        llDate = gDateValue(slDate)
        If llDate > llEndAdjust Then
            Exit Sub
        End If
        'SBF is OK with dates, adjust the $

        'determine if hard cost to be included for Billed & Booked; other reports dont have option or is
        'interspersed with non hard cost
        ilFoundOption = True                'default to include the NTR if no options exist and its not B & B or Recap report
        If (ilListIndex = CNT_BOB Or ilListIndex = CNT_BOBRECAP Or ilListIndex = CNT_BOBCOMPARE Or ilListIndex = CNT_SALESCOMPARE) And (igRptCallType = CONTRACTSJOB) Then
            ilIsItHardCost = gIsItHardCost(tlSbf(llSBFLoop).iMnfItem, tlMMnf())

            If ilIsItHardCost Then              'hard cost item
                If Not imHardCost Then
                    ilFoundOption = False
                End If
            Else                                'normal NTR
                If Not imNTR Then
                    ilFoundOption = False
                End If
            End If
        End If

        If ilFoundOption Then
            ilFoundMonth = False
            For ilMonthInx = ilFirstProjInx To ilHowManyPer Step 1         'loop thru months to find the match
                If llDate >= llStdStartDates(ilMonthInx) And llDate < llStdStartDates(ilMonthInx + 1) Then
                    ilFoundMonth = True
                    Exit For
                End If
            Next ilMonthInx

            ilFoundVef = False
            'setup vehicle that spot was moved to
            For ilTemp = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1 Step 1
                If tmSBFAdjust(ilTemp).iVefCode = tlSbf(llSBFLoop).iBillVefCode And tmSBFAdjust(ilTemp).iSlsCommPct = tlSbf(llSBFLoop).iCommPct And tmSBFAdjust(ilTemp).sAgyComm = tlSbf(llSBFLoop).sAgyComm And tmSBFAdjust(ilTemp).iMnfItem = tlSbf(llSBFLoop).iMnfItem Then      '8-10-06
                    ilFoundVef = True
                    Exit For
                End If
            Next ilTemp
            If Not (ilFoundVef) Then
                ilTemp = UBound(tmSBFAdjust)
                tmSBFAdjust(ilTemp).iVefCode = tlSbf(llSBFLoop).iBillVefCode
                tmSBFAdjust(ilTemp).iSlsCommPct = tlSbf(llSBFLoop).iCommPct
                tmSBFAdjust(ilTemp).sAgyComm = tlSbf(llSBFLoop).sAgyComm
                tmSBFAdjust(ilTemp).iIsItHardCost = ilIsItHardCost              '8-10-06
                tmSBFAdjust(ilTemp).iMnfItem = tlSbf(llSBFLoop).iMnfItem        '8-10-06

                If ilFoundMonth Then
                    If imUseAcquisitionCost Then        '3-20-09 make sure acq costs are used instead of spot price if acq only option
                        tmSBFAdjust(ilTemp).lProject(ilMonthInx) = tmSBFAdjust(ilTemp).lProject(ilMonthInx) + (tlSbf(llSBFLoop).lAcquisitionCost * tlSbf(llSBFLoop).iNoItems)
                    Else
                        tmSBFAdjust(ilTemp).lProject(ilMonthInx) = tmSBFAdjust(ilTemp).lProject(ilMonthInx) + (tlSbf(llSBFLoop).lGross * tlSbf(llSBFLoop).iNoItems)
                    End If
                    tmSBFAdjust(ilTemp).lAcquisitionCost(ilMonthInx) = tmSBFAdjust(ilTemp).lAcquisitionCost(ilMonthInx) + (tlSbf(llSBFLoop).lAcquisitionCost * tlSbf(llSBFLoop).iNoItems)
                End If
                ReDim Preserve tmSBFAdjust(0 To UBound(tmSBFAdjust) + 1) As ADJUSTLIST
            Else
                If ilFoundMonth Then
                    If imUseAcquisitionCost Then
                        tmSBFAdjust(ilTemp).lProject(ilMonthInx) = tmSBFAdjust(ilTemp).lProject(ilMonthInx) + (tlSbf(llSBFLoop).lAcquisitionCost * tlSbf(llSBFLoop).iNoItems)
                    Else
                        tmSBFAdjust(ilTemp).lProject(ilMonthInx) = tmSBFAdjust(ilTemp).lProject(ilMonthInx) + (tlSbf(llSBFLoop).lGross * tlSbf(llSBFLoop).iNoItems)
                    End If
                    tmSBFAdjust(ilTemp).lAcquisitionCost(ilMonthInx) = tmSBFAdjust(ilTemp).lAcquisitionCost(ilMonthInx) + (tlSbf(llSBFLoop).lAcquisitionCost * tlSbf(llSBFLoop).iNoItems)
                End If
            End If
        End If
    Next llSBFLoop
End Sub

'                       Sales Placement routine
'                       mSlsPlacementInsert - Loop and calculate the gross, net &/or commission
'                                   Insert a projected record in GRF or
'                                    a MG record in GRF so that any
'                                    spot moved from one vehicle to another
'                                    will be reflected in the correct vehicle
'                                    if updating as aired
'                       <input> llTempProject - 12 months of projected $ (from
'                                               contract line or MG $
'                               ilCorT - 1 = Cash , 2 = Trade processing
'                               llProcessPct - % share of owners or slsp
'                               slPctTrade  - % of trade
'                               slCashAgyComm - agency comm %
'                               slCommPct - slsp % commission (Billed & booked commission report)
'                               slGrossOrNet - G = gross report, N = net report
'                               ilHowManyDefined - split transactions (i.e. slsp splits or owners splits)
'                               ilMatchSSCode - Sales Source code
'                               ilDateFlag - 0 = no comparison (base dates vs comparison dates)
'                                            1 = base date
'                                            2 = comparison date
'                               ilNewCode = mnf Revenue area "New" code
'                               ilStartMonth - start month to process   4-4-00, all billed &booked except slsp comm will proces all 12 months at a time
'                                       slsp comm retrieves a possible different  comm percentage for each month
'                                       (if neg, first time thru--initialize buckets)
'                               ilHI - end month to process, after 12th period, insert record in grf
'                               ilCurrMnfGroup - if running partcipant veh group with veh/participant option, use the participant that is associated with the
'                                               split, instead of the first one for the owner
'                               5/7/98 dh - add Show New/Return flag to grf.ipergenl(2)
'
'                               5/10/98 dh - change Billed & booked Commission to keep track of net dollars (vs gross)
'                                            in grf.lDollars(18) so that overage can be computed
'                               4-4-00 dh implement new commission structure where slsp can have different commissions
'                                           based on vehicles by start & end dates
'           8-8-02 copied from mBOBLoopOnMonth (from Billed and Booked) to update Sales Placement records
Sub mSlsPlacementInsert(llTempProject() As Long, llTempAcquisition() As Long, ilCorT As Integer, llProcessPct As Long, slPctTrade As String, slCashAgyComm As String, slGrossOrNet As String, ilHowManyDefined As Integer, ilDateFlag As Integer, ilNewCode As Integer, ilStartMonth As Integer, ilHi As Integer)
    Dim ilTemp As Integer
    Dim slAmount As String
    Dim slSharePct As String
    Dim slStr As String
    Dim slCode As String
    Dim slDollar As String
    Dim slNet As String
    Dim ilRet As Integer
    Dim ilTypes As Integer
    Dim ilmaxTypes As Integer
    Dim ilLo As Integer
    ilLo = ilStartMonth
    If ilLo < 0 Or ilLo = 1 Then            'first time, init buckets (from commissions) or from billed and booked
        For ilTemp = 1 To 18 Step 1             'init the years $ buckets for the contract
            tmGrf.lDollars(ilTemp - 1) = 0
            lgNetDollars(ilTemp) = 0
            lgGrsDollars(ilTemp) = 0            '2-26-01
            lgCommDollars(ilTemp) = 0
        Next ilTemp
        dg12MonthTotal = 0                      'total of 12 months buckets
        dg12MonthAcquisition = 0                '9-20-06
        If ilLo < 0 Then
        ilLo = -ilLo                'get back to positive for loop
        End If
    End If
    For ilTemp = ilLo To ilHi               '4-4-00 loop on # buckets to process.  If Slsp billed & booked comm, only processing one bucket at a time
        'because each month could have a different slsp comm percent
        slAmount = gLongToStrDec(llTempProject(ilTemp), 2)
        slSharePct = gLongToStrDec(llProcessPct, 4)                 'slsp or owner split share in %, else 100.0000%
        slStr = gMulStr(slSharePct, slAmount)                       ' gross portion of possible split
        slStr = gRoundStr(slStr, "1", 0)
        If ilCorT = 1 Then                 'all cash commissionable
            slCode = gSubStr("100.", slPctTrade)                'get the cash % (100-trade%)
            slDollar = gDivStr(gMulStr(slStr, slCode), "100")              'slsp gross
            slDollar = gRoundStr(slDollar, "1", 0)
            slNet = gRoundStr(gDivStr(gMulStr(slDollar, gSubStr("100.00", slCashAgyComm)), "100.00"), ".01", 0)
            If imAdjustAcquisition Then     'if adjusting for barter acquisition amounts, subtract it out (its already a net value)
                slAmount = gLongToStrDec(llTempAcquisition(ilTemp) * 100, 2)
                slStr = gDivStr(gMulStr(slSharePct, slAmount), "100")
                slStr = gRoundStr(slStr, "1", 0)
                slNet = gSubStr(slNet, slStr)
            End If

            tmGrf.sDateType = "C"
        Else
            If ilCorT = 2 Then                'at least cash is commissionable
            slCode = gIntToStrDec(tgChfCT.iPctTrade, 0)
            slDollar = gDivStr(gMulStr(slStr, slCode), "100")
            slDollar = gRoundStr(slDollar, "1", 0)
            If tgChfCT.iAgfCode > 0 And tgChfCT.sAgyCTrade = "Y" Then
                slNet = gRoundStr(gDivStr(gMulStr(slDollar, gSubStr("100.00", slCashAgyComm)), "100.00"), "1", 0)
                If imAdjustAcquisition Then     'if adjusting for barter acquisition amounts, subtract it out .  it has already been adjusted for commission if applicable
                    slAmount = gLongToStrDec(llTempAcquisition(ilTemp) * 100, 2)
                    slStr = gDivStr(gMulStr(slSharePct, slAmount), "100")
                    slStr = gRoundStr(slStr, "1", 0)
                    slNet = gSubStr(slNet, slStr)
                End If
            Else
                slNet = slDollar    'no commission , net is same as gross
                If imAdjustAcquisition Then     'if adjusting for barter acquisition amounts, subtract it out.  it has already been adjusted for commission if applicable
                    slAmount = gLongToStrDec(llTempAcquisition(ilTemp) * 100, 2)
                    slStr = gDivStr(gMulStr(slSharePct, slAmount), "100")
                    slStr = gRoundStr(slStr, "1", 0)
                    slNet = gSubStr(slNet, slStr)
                End If
            End If
            tmGrf.sDateType = "T"
            End If
        End If

        If slGrossOrNet = "G" Then
            tmGrf.lDollars(ilTemp - 1) = tmGrf.lDollars(ilTemp - 1) + Val(slDollar)
            dg12MonthTotal = dg12MonthTotal + Val(slDollar)     'accum the years total
            dg12MonthAcquisition = dg12MonthAcquisition + Val(slDollar)     '9-20-06
        ElseIf slGrossOrNet = "N" Or slGrossOrNet = "T" Then          'net or net-net
            lgNetDollars(ilTemp) = lgNetDollars(ilTemp) + Val(slNet)
            dg12MonthTotal = dg12MonthTotal + Val(slNet)        'accum the years total
            dg12MonthAcquisition = dg12MonthAcquisition + Val(slNet)     '9-20-06
        Else                                    '2-26-01
            tmGrf.lDollars(ilTemp - 1) = tmGrf.lDollars(ilTemp - 1) + Val(slDollar)
            lgNetDollars(ilTemp) = lgNetDollars(ilTemp) + Val(slNet)
            lgGrsDollars(ilTemp) = lgGrsDollars(ilTemp) + Val(slDollar)
            dg12MonthTotal = dg12MonthTotal + Val(slNet)        'accum the years total
            dg12MonthAcquisition = dg12MonthAcquisition + Val(slNet)     '9-20-06
        End If

    Next ilTemp

    If ilTemp = igPeriods + 1 Then      'end of all buckets, write out record
        'contract complete for cash and or trade values, write out contract
        tmGrf.iGenDate(0) = igNowDate(0)        'todays date used for retrieval/removal of records
        tmGrf.iGenDate(1) = igNowDate(1)
        gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
        tmGrf.lGenTime = lgNowTime
        tmGrf.sBktType = "C"                    'flag this as a contract recd (vs history, recv. or projection)
        tmGrf.lChfCode = tgChfCT.lCode            'contr internal code
        tmGrf.iAdfCode = tgChfCT.iAdfCode
        tmGrf.iPerGenl(0) = ilDateFlag
        If ilHowManyDefined > 1 Then                   'this line or contracthas split slsp or owners
            tmGrf.iYear = 1                     'this transaction is a split slsp or owner
        Else
            tmGrf.iYear = 0                     'this trans. is not a split slsp or owner
        End If

        If dg12MonthTotal > 0 Or dg12MonthAcquisition <> 0 Then                  '9-20-06 if all zeros don't write it out
            tmGrf.iPerGenl(1) = mBobTestNew(ilNewCode, tgChfCT)      'New/Return flag to show on report:  0 = show nothing (probably return),
                           '1 = New (show N), 2 = New Hold (show h), 3 = Return Hold ( show H)
            If smGrossOrNet = "B" Then          '2-26-01  Test for net-net
                ilmaxTypes = 2                  'create both Gross & Net records
            Else
                ilmaxTypes = 1                     'process on the gross or net orders on books
            End If

            For ilTypes = 1 To ilmaxTypes             'process 3 times if slsp commission:  1 = orders on books,
                    '2 = net, 3 = commission.  If not slsp comm, process once for orders on books
                'if iltype = 1 and ilMaxTypes <> 1 (slsp comm), then the orders on books values are already in tmGRF array  (which should be gross values)
                If ilTypes = 1 And ilmaxTypes = 1 Then   'process orders on books (gross or net)
                    'If slGrossOrNet = "N" Or slGrossOrNet = "D" Then      'put net values into common GRF array
                    If slGrossOrNet = "N" Or slGrossOrNet = "T" Then      'put net values into common GRF array
                        For ilTemp = 1 To 18
                            tmGrf.lDollars(ilTemp - 1) = lgNetDollars(ilTemp)
                        Next ilTemp
                    End If
                ElseIf ilTypes = 1 And ilmaxTypes <> 1 Then     '2-26-01
                    'processing for salesp commissions: Orders on the books (net)
                    For ilTemp = 1 To 18
                        tmGrf.lDollars(ilTemp - 1) = lgGrsDollars(ilTemp)
                    Next ilTemp
                ElseIf ilTypes = 2 Then      'process net
                    'processing for salesp commissions: Orders on the books (net)
                    For ilTemp = 1 To 18
                        tmGrf.lDollars(ilTemp - 1) = lgNetDollars(ilTemp)
                    Next ilTemp
                ElseIf ilTypes = 3 Then      'process comm
                    'processing for salesp commissions
                    For ilTemp = 1 To 18
                        tmGrf.lDollars(ilTemp - 1) = lgCommDollars(ilTemp)
                    Next ilTemp
                End If
                For ilTemp = 1 To 12 Step 1
                    'round the 12 values
                    slAmount = gLongToStrDec(tmGrf.lDollars(ilTemp - 1), 2)
                    slAmount = gMulStr("100", slAmount)                       ' gross portion of possible split
                    tmGrf.lDollars(ilTemp - 1) = Val(slAmount)
                Next ilTemp

                tmGrf.iPerGenl(4) = ilTypes                     'update for sorting of Slsp comm rept
                ilRet = btrInsert(hmGrf, tmGrf, imGrfRecLen, INDEXKEY0)
            Next ilTypes
        End If
    End If
End Sub

'           Sales Placement - Gather Projection data from contracts
'            mBuildSlsPlacement
'            Loop thru contracts within date last std bdcst billing
'            through the end of the year and build up to 12 periods
'
'                   <Input>  llStdStartDates - array of max 13 start dates, denoting
'                                              start date of each period to gather
'                            llLastBilled - Date of last invoice period
'                            ilHowManyPer - # of periods to gather
'                                           (for billed & booked its 12)
'                            ilDateFlag - 0 = no comparison (base dates vs comparison dates)
'                                         1 = base date
'                                         2 = comparison date
'
'   8-8-02 Copy of mBuildBobProj: modified to create Sales Placement
'   11-13-03 test to see ifuser allowed to see vehicle
'********************************************************************************************
Function mBuildSlsPlacement(llStdStartDates() As Long, llLastBilled As Long, ilHowManyPer As Integer, ilDateFlag As Integer)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  ilOKtoSeeVeh                  tmOneVefAllYear                                         *
    '******************************************************************************************
    Dim ilRet As Integer
    Dim slStdStart As String            'start date to gather (std start)
    Dim slStdEnd As String              'end date to gather (end of std year)
    Dim slTempStart As String           'Start date of period requested (minus 1 month) to handle makegoods outside
                        'end date of contrct
    Dim slCntrStatus As String          'list of contract status to gather (working, order, hold, etc)
    Dim slCntrType As String            'list of contract types to gather (Per inq, Direct Response, Remnants, etc)
    Dim ilHOState As Integer            'which type of HO cntr states to include (whether revisions should be included)
    Dim llContrCode As Long
    Dim ilCurrentRecd As Integer
    Dim ilFound As Integer
    Dim ilFoundOption As Integer
    Dim illoop As Integer
    Dim ilHowMany As Integer            '# times to loop and process line (up to 10 times for split slsp),
                        'up to 3 times for 3 diff. owners per vehicle, else loop once per
                        'flight (or sch line)
    Dim ilHowManyDefined As Integer     '# of percentages (slsp for each contract, or participants for each vehicle)
    Dim ilMatchSSCode As Integer        'Sales Source code to process for participants
    Dim ilClf As Integer                'loop count for lines
    Dim slNameCode As String
    Dim slCode As String
    Dim ilTemp As Integer
    Dim ilScratch As Integer
    Dim llStdStart As Long              'requested start date to gather (serial date)
    Dim llStdEnd As Long                'requested end date to gather (serial date)
    Dim ilCorT As Integer
    Dim ilStartCorT As Integer
    Dim ilEndCorT As Integer
    Dim slCashAgyComm As String
    Dim slPctTrade As String
    Dim ilFoundOne As Integer
    Dim llProcessPct As Long             'percent of slsp split, ownership, else 100.0000%
    Dim ilFirstProjInx As Integer
    Dim slCommPct As String                 'for comm proj only - slsp comm % xx.xxxx
    Dim ilSubMissed As Integer             'subtract misses (misses, cancel, hidden)
    Dim ilCountMGs As Integer                'count mgs where they air
    Dim ilAdjust As Integer
    Dim ilUsePkg As Integer                 'true if use package, false if use hidden
    Dim ilVehLoop As Integer                'loop for MGs by vehicle
    ReDim llTempProject(0 To 12) As Long      '12 months projection or MG $. Index zero ignored
    ReDim llTempAcquisition(0 To 12) As Long    '12 months acquisition costs to subtract. Index zero ignored
    Dim ilNewCode As Integer                    'Revenue area "New" mnf code to show designation on report
    
    ReDim tlSlf(0 To 0) As SLF                  '4-20-00
    Dim ilMnfSubCo As Integer
    Dim ilUseSlsComm As Integer             'true to use slsp share % for commission reports, else false to use revenue share to split sls $
    Dim ilListIndex As Integer                  '3-2-02
    Dim ilSaveSS As Integer
    Dim ilSaveSof As Integer
    Dim slName As String
    Dim ilStd As Integer
    Dim ilSearchSlf As Integer

    ilListIndex = RptSelCt!lbcRptType.ListIndex     '3-2-02
    ilStd = True                                    'currently forced to do std reporting (vs corporte)
    ilUsePkg = False
    igPeriods = RptSelCt!edcText.Text

    '4-2-00 Prepare for the different slsp commissions by vehicle if applicable
    hmScf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmScf, "", sgDBPath & "Scf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
    If tgSpf.sSubCompany = "Y" Then
        MsgBox "SCF Missing"
        ilRet = btrClose(hmScf)
        btrDestroy hmScf
        btrDestroy hmVef
        btrDestroy hmCHF
        btrDestroy hmSlf
        btrDestroy hmRvf
        btrDestroy hmGrf
        Exit Function
    End If
    End If
    imScfRecLen = Len(tmScf)

    ReDim tlScf(0 To 0) As SCF      '4-2-00
    ReDim tlSlfIndex(0 To 0) As SLFINDEX    '4-2-00
    ilRet = gObtainVef()                  '4-2-00 buildglobal vehicle table
    If ilRet = 0 Then
    btrDestroy hmScf
    btrDestroy hmVef
    btrDestroy hmCHF
    btrDestroy hmSlf
    btrDestroy hmRvf
    btrDestroy hmGrf
    btrDestroy hmVef
    Exit Function
    End If
    ilRet = gObtainSlf(RptSelCt, hmSlf, tlSlf())

    If tgSpf.sSubCompany = "Y" Then         'using commission by vehicle (sub-company)?
        '4-24-00 Build  slsp commission table
        ilRet = gObtainScf(RptSelCt, hmScf, tlScf(), llStdStartDates(1), llStdStartDates(13), tlSlfIndex())
    End If
    ilUseSlsComm = False            'use revenue share if by slsp (not comm share %)

    illoop = RptSelCt!cbcSet1.ListIndex
    imMajorSet = gFindVehGroupInx(illoop, tgVehicleSets1())

    'build array of selling office codes and their sales sources.  This is the most major sort
    'in the Business Booked reports
    ilTemp = 0
    ilRet = btrGetFirst(hmSof, tmSof, imSofRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
    Do While ilRet = BTRV_ERR_NONE
        ReDim Preserve tlSofList(0 To ilTemp) As SOFLIST
        tlSofList(ilTemp).iSofCode = tmSof.iCode
        tlSofList(ilTemp).iMnfSSCode = tmSof.iMnfSSCode
        ilRet = btrGetNext(hmSof, tmSof, imSofRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        ilTemp = ilTemp + 1
    Loop

    sgDemoMnfStamp = ""             'insure that the revenue sets are read
    ReDim tlMnf(0 To 0) As MNF
    'Get the revenue sets and find "New" code
    ilRet = gObtainMnfForType("R", sgDemoMnfStamp, tlMnf())
    ilNewCode = 0
    For illoop = LBound(tlMnf) To UBound(tlMnf) - 1 Step 1
        tmMnf = tlMnf(illoop)
        If Trim$(tmMnf.sName) = "New" Then
            ilNewCode = tmMnf.iCode
            Exit For
        End If
    Next illoop

    'Billed and Booked asks, Sales Placement defaults to the following
    ilSubMissed = False           'do not subt misses
    ilCountMGs = True             'count mgs where they air
    smAirOrder = tgSpf.sInvAirOrder         'bill as ordred, aired

    If smAirOrder = "S" Or Not ilStd Then           'bill as ordered or corporate reporting
        ilAdjust = False                    'always ignore missed and makegoods
    Else
        ilAdjust = True                     'missed or mg must be adjusted
    End If

    'determine what month index the actual is (versus the future dates)
    slStdStart = Format$(llStdStartDates(1), "m/d/yy")       'assume first date of proj is the quarter entered
    slStdEnd = Format$(llStdStartDates(ilHowManyPer + 1), "m/d/yy")

    'Possibly may need Corporate reporting later
    If Not ilStd Then          'corp, look at all orders for entire year
        ilFirstProjInx = 1
    Else                                        'std, decide what month to start looking at orders for future
        '7-12-01 Billed & Booked Slsp Comm comes thru here.  Do nothing with that report for now.
        If (tgSpf.iPkageGenMeth = 1 And Not ilUsePkg) Then           'calc virtual pkg by line & use airing Lines?
            ilFirstProjInx = 1                                   'if so, force to gather all information for contract because of balancing issue with receivables
        Else
            For illoop = 1 To ilHowManyPer Step 1
            If llLastBilled > llStdStartDates(illoop) And llLastBilled < llStdStartDates(illoop + 1) Then
                ilFirstProjInx = illoop + 1
                slStdStart = Format$(llStdStartDates(ilFirstProjInx), "m/d/yy")
                Exit For
            End If
            Next illoop
            If ilFirstProjInx = 0 Then
                ilFirstProjInx = 1                          'all projections, no actuals
            End If
            If llLastBilled >= llStdStartDates(ilHowManyPer + 1) Then   'all data was in the past only, dont do contracts
                Exit Function
            End If
        End If
    End If

    'dont test to see if all data in past here.  For corp, data is always gathered on
    'contracts since they are not billed corp (just the adjustments were obtained
    'from the receivables.
    'If llLastBilled >= llStdStartDates(ilHowManyPer + 1) Then   'all data was in the past only, dont do contracts
    '    Exit Function
    'End If
    llStdStart = llStdStartDates(ilFirstProjInx)  'first date to project
    llStdEnd = llStdStartDates(ilHowManyPer + 1)                'end date to project

    'build array of misses reasons and their billing rules so it doesn't have to be read with each missed spot
    ilTemp = 0
    ilRet = btrGetFirst(hmMnf, tmMnf, imMnfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
    Do While ilRet = BTRV_ERR_NONE
        If tmMnf.sType = "M" Then
            ReDim Preserve tmMnfList(0 To ilTemp) As MNFLIST
            tmMnfList(ilTemp).iMnfCode = tmMnf.iCode
            tmMnfList(ilTemp).iBillMissMG = tmMnf.iGroupNo
            ilTemp = ilTemp + 1
        End If
        ilRet = btrGetNext(hmMnf, tmMnf, imMnfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop

    ReDim tmCntAllYear(0 To 0) As ALLPIFPCTYEAR

    slCntrStatus = "HOGN"                 'statuses: hold, order, unsch hold, uns order
    slCntrType = "CVTRQ"         'all types: PI, DR, etc.  except PSA(p) and Promo(m)
    ilHOState = 2                       'get latest orders & revisions  (HOGN plus any revised orders WCI)
    'build table (into tlchfadvtext) of all contracts that fall within the dates required
    'Back up the start date for gathering of contracts by one month.  This will include
    'the case where the contract has ended, but makegood spots are in the next month.
    'If the contract spanned the first quarter requested, the makegood spot outside the
    'end date of the contract was gathered.  but if the contract was outside the requested
    'first quarter, the makegood was not gathered.
    slTempStart = Format$((gDateValue(slStdStart) - 30), "m/d/yy")
    ilRet = gObtainCntrForDate(RptSelCt, slTempStart, slStdEnd, slCntrStatus, slCntrType, ilHOState, tlChfAdvtExt())

    For illoop = 1 To 13 Step 1
        lmProject(illoop) = 0
        lmAcquisition(illoop) = 0
    Next illoop
    For ilCurrentRecd = LBound(tlChfAdvtExt) To UBound(tlChfAdvtExt) - 1 Step 1                                          'loop while llCurrentRecd < llRecsRemaining
    ilFound = True
    If lmSingleCntr > 0 And lmSingleCntr <> tlChfAdvtExt(ilCurrentRecd).lCntrNo Then
        ilFound = False
    End If

    If (ilFound) Then
        llContrCode = tlChfAdvtExt(ilCurrentRecd).lCode
        ilRet = gObtainCntr(hmCHF, hmClf, hmCff, llContrCode, False, tgChfCT, tgClfCT(), tgCffCT(), False)      '8-28-12 do not sort by special dp order
        ilFoundOption = True

        'Determine Office and Sales Source for later filtering if option by SS/Market
        ilMatchSSCode = 0
        For ilSearchSlf = LBound(tlSlf) To UBound(tlSlf) - 1 Step 1
            If tlSlf(ilSearchSlf).iCode = tgChfCT.iSlfCode(0) Then
                For ilTemp = 0 To UBound(tlSofList) Step 1
                    If tlSofList(ilTemp).iSofCode = tlSlf(ilSearchSlf).iSofCode Then
                        ilSaveSS = tlSofList(ilTemp).iMnfSSCode
                        ilSaveSof = tlSofList(ilTemp).iSofCode
                        Exit For
                    End If
                Next ilTemp
                Exit For
            End If
        Next ilSearchSlf

        'Filter Sales source
        If Not RptSelCt!ckcAll.Value = vbChecked Then
            ilFoundOption = False           'assume found something to report until selectivity checking
            For ilTemp = 0 To RptSelCt!lbcSelection(3).ListCount - 1
                If RptSelCt!lbcSelection(3).Selected(ilTemp) Then
                    slNameCode = tgSalesperson(ilTemp).sKey         'sales source code
                    ilRet = gParseItem(slNameCode, 2, "\", slCode)
                    If Val(slCode) = ilSaveSS Then      'sales source of this contract match one selected?
                        ilFoundOption = True
                        Exit For
                    End If
                End If
            Next ilTemp
        Else
            ilFoundOption = True
        End If
        'filter Sales Office
        If ilFoundOption Then            'found a sales source, continue with sales office; otherwise this is a contract not to be processed
            ilFoundOption = False
            If Not RptSelCt!ckcAllAAS.Value = vbChecked Then
                For ilTemp = 0 To RptSelCt!lbcSelection(2).ListCount - 1
                    If RptSelCt!lbcSelection(2).Selected(ilTemp) Then
                        slNameCode = tgSOCodeCT(ilTemp).sKey         'sales source code
                        ilRet = gParseItem(slNameCode, 2, "\", slCode)
                        If Val(slCode) = ilSaveSof Then      'sales office of this contract match one selected?
                            ilFoundOption = True
                            Exit For
                        End If
                    End If
                Next ilTemp
            Else
                ilFoundOption = True
            End If
        End If

        If ((tgChfCT.iPctTrade < 100) Or (tgChfCT.iPctTrade = 100 And imTrade)) And (ilFoundOption) Then        'all trade contr, include?
        'obtain agency for commission
        If tgChfCT.iAgfCode > 0 Then
            tmAgfSrchKey.iCode = tgChfCT.iAgfCode
            ilRet = btrGetEqual(hmAgf, tmAgf, imAgfRecLen, tmAgfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'get matching agy recd
            If ilRet = BTRV_ERR_NONE Then
            slCashAgyComm = gIntToStrDec(tmAgf.iComm, 2)
            End If          'ilret = btrv_err_none
        Else
            slCashAgyComm = ".00"
        End If              'iagfcode > 0

        slPctTrade = gIntToStrDec(tgChfCT.iPctTrade, 0)
        If tgChfCT.iPctTrade = 0 Then                     'setup loop to do cash & trade
            ilStartCorT = 1
            ilEndCorT = 1
        ElseIf tgChfCT.iPctTrade = 100 Then
            ilStartCorT = 2
            ilEndCorT = 2
        Else
            ilStartCorT = 1
            If imTrade Then             'Include trades?
            ilEndCorT = 2
            Else
            ilEndCorT = 1
            End If
        End If
        'ReDim Preserve tmAdjust(0 To 0) As ADJUSTLIST            'prepare list of mgs
        ReDim tmAdjust(0 To 0) As ADJUSTLIST             'prepare list of mgs
        imUpperAdjust = 0

        'build the vehicles participant tables for this contract only into tmCntAllYear, if by owner
        gInitCntPartYear hmVsf, tgChfCT, ilMatchSSCode, llStdStartDates(), tmCntAllYear(), tmPifKey(), tmPifPct()

        For ilClf = LBound(tgClfCT) To UBound(tgClfCT) - 1 Step 1
            tmClf = tgClfCT(ilClf).ClfRec
            ilFoundOption = True
            'determine which vehicle group is selected
            tmGrf.iPerGenl(3) = -1                      '(make compatible with the RVF/PHF records) vehicle group code if used
            tmGrf.iVefCode = tmClf.iVefCode
            tmGrf.iSofCode = ilSaveSof              'sales office code
            If imMajorSet > 0 Then
                gGetVehGrpSets tmGrf.iVefCode, imMinorSet, imMajorSet, ilTemp, tmGrf.iPerGenl(3)   'ilTemp -minor sort code unused, tmgrf.ipergenl(3) = major sort code
            End If

            If Not RptSelCt!CkcAllveh.Value = vbChecked And RptSelCt!lbcSelection(6).Visible = True Then        'all items in vehicle group selected?
                ilFoundOption = False
                'filter the vehicle group
                For illoop = 0 To RptSelCt!lbcSelection(6).ListCount - 1 Step 1
                    If RptSelCt!lbcSelection(6).Selected(illoop) Then
                        slNameCode = tgMnfCodeCT(illoop).sKey
                        ilRet = gParseItem(slNameCode, 1, "\", slName)
                        ilRet = gParseItem(slName, 3, "|", slName)
                        ilRet = gParseItem(slNameCode, 2, "\", slCode)
                        'Determine which vehicle set to test
                        If tmGrf.iPerGenl(3) = Val(slCode) Then
                            ilFoundOption = True
                            Exit For
                        End If
                    End If
                Next illoop
            End If


            '12-6-06 changed to check by contract gCNTROKforUser rather than vehicle
            If (ilFoundOption) Then 'And (ilOKtoSeeVeh) Then
                If ilUsePkg Then        'use pkg lines- this report is defauled to use hidden/conventional lines
                    If tmClf.sType <> "H" Then
                    mBOBBuildFlights ilClf, llStdStartDates(), ilFirstProjInx, ilHowManyPer + 1
                    End If
                Else                    'use hidden lines
                    If tmClf.sType <> "A" And tmClf.sType <> "O" And tmClf.sType <> "E" Then
                    mBOBBuildFlights ilClf, llStdStartDates(), ilFirstProjInx, ilHowManyPer + 1
                    End If
                End If
                'Adjust with misses and makegoods?  Defaulted to adjust misses & makegoods
                If ilAdjust Then
                    mBOBAdjust llStdStartDates(), ilFirstProjInx, llStdStart, llStdEnd, True, ilSubMissed, ilCountMGs, ilHowManyPer, True
                End If

                'obtain the sales source for major sort of business booked reports
                If tgChfCT.iSlfCode(0) <> tmSlf.iCode Then        'only read slsp recd if not in mem already
                    '7-2-14 use binary search for speed up; do not need the slsp comm pct in this version.  sales office required
                    ilRet = gBinarySearchSlf(tgChfCT.iSlfCode(0))
                    If ilRet = -1 Then              'not found
                        tmSlf.iSofCode = 0
                        tmSlf.iCode = 0
                    Else
                        tmSlf = tgMSlf(ilRet)
                    End If
                End If                                          'table of selling offices built into memory with its
                                        'associated sales source
                For illoop = LBound(tlSofList) To UBound(tlSofList)
                    If tlSofList(illoop).iSofCode = tmSlf.iSofCode Then
                        ilMatchSSCode = tlSofList(illoop).iMnfSSCode          'Sales source
                        Exit For
                    End If
                Next illoop
                End If
                If (imVehicle) Or (ilClf = UBound(tgClfCT) - 1) Then      'option by owner and vehicle must write out for each schline
                               'all others write out for contract if last line has been processed
                ilFoundOption = True                    'assume everything included


                If ilFoundOption Then             'matching vehicle or owner found
                    'slPctTrade = gIntToStrDec(tgChfCt.iPctTrade, 0)
                    'insure that the first slsp is 100 (or owner) if only one exists
                    ilHowMany = 0
                    ilHowManyDefined = 0
                    ReDim llSlfSplit(0 To 9) As Long           '4-20-00 slsp slsp share %
                    ReDim ilSlfCode(0 To 9) As Integer             '4-20-00
                    ReDim ilslfcomm(0 To 9) As Integer             'slsp under comm %
                    ReDim ilslfremnant(0 To 9) As Integer          'slsp under remnant %
                    ReDim llSlfSplitRev(0 To 9) As Long         '2-2-04 unused in this report (need for subroutine)

                    ilMnfSubCo = gGetSubCmpy(tgChfCT, ilSlfCode(), llSlfSplit(), tmClf.iVefCode, ilUseSlsComm, llSlfSplitRev())                                          '4-6-00
                    mBobGetHowManyFuture tmClf.iVefCode, ilHowMany, ilHowManyDefined, ilMatchSSCode, ilSlfCode(), llSlfSplit(), llStdStartDates()    '8-4-00 4-6-00determine the number of owner or slsp splits

                    For illoop = 0 To ilHowMany - 1 Step 1
                        llProcessPct = 1000000      'this version of the report doesnt have any splits
                        If llProcessPct <> 0 Then
                            'if split slsp comm exist and selective slsp requested, don't show all slsp on this order
                            ilFoundOne = mFoundSelection(illoop, tmClf.iVefCode, ilSlfCode(), llSlfSplit())         '8-4-00 see if selective slsp, owner, vehicle chosen
                            If ilFoundOne Then
                                For ilTemp = 1 To 12
                                    llTempProject(ilTemp) = lmProject(ilTemp)
'                                    llTempAcquisition(ilTemp) = lmAcquisition(ilTemp)
                                    llTempAcquisition(ilTemp) = lmAcquisitionNet(ilTemp)

                                Next ilTemp
                                For ilCorT = ilStartCorT To ilEndCorT Step 1

                                    '4-20-00
                                    'tmGrf.iPerGenl(6) = 0       'flag to indicate that at least one vehicle does not have a sub-company defined and
                                    tmGrf.iPerGenl(5) = 0       'flag to indicate that at least one vehicle does not have a sub-company defined and
                                        'there is at least one slsp in the header with a sub-co (they all must have it, or none at all)
                                    If ilMnfSubCo < 0 Then      'error, inconsistent sub-company definitions
                                        'tmGrf.iPerGenl(6) = 1
                                        tmGrf.iPerGenl(5) = 1
                                    End If
                                    'if this vehicle doesnt have a subcompany defined at there is at least one slsp
                                    'in the header that has a sub-company defined, the commissions may not be correct.
                                    'i.e.  Slsp A  Sub-co A  Slsp Share = 100
                                    '      Slsp A  Sub-co B  Slsp Share = 50%
                                    '      At least one line doesn't have a sub-company defined, therefore the splits will occur for Slsp A twice.
                                     mSlsPlacementInsert llTempProject(), llTempAcquisition(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, smGrossOrNet, ilHowManyDefined, ilDateFlag, ilNewCode, 1, igPeriods

                                Next ilCorT                             'process cash or trade portion
                            End If                          'ilFoundOne
                        End If                  'llProcessPct
                    Next illoop                 'Possibly process mutiple slsp or owners per line.  If advt or vehicle, fall thru after one loop
                 End If                         'ilfoundoption
                'process the makegoods for this line - there can be multiple vehicles that spots were moved  to.  Each
                'new vehicle must be retrieved and it's splits determined
                For ilVehLoop = 0 To imUpperAdjust - 1 Step 1

                    ilFoundOption = True                    'assume everything included

                    If tmAdjust(ilVehLoop).iVefCode > 0 And ilFoundOption Then
                        ilHowMany = 0
                        ilHowManyDefined = 0
                        '4-20-00
                        mBobGetHowManyFuture tmAdjust(ilVehLoop).iVefCode, ilHowMany, ilHowManyDefined, ilMatchSSCode, ilSlfCode(), llSlfSplit(), llStdStartDates()       '8-4-00 determine the number of owner or slsp splits
                        For illoop = 0 To ilHowMany - 1 Step 1
                            llProcessPct = 1000000              'if advt or vehicle, just use slsp since there will always be one
                                                'and only one pass will be processed
                            If llProcessPct > 0 Then
                                ilFoundOne = mFoundSelection(illoop, tmAdjust(ilVehLoop).iVefCode, ilSlfCode(), llSlfSplit())        '8-4-00 see if selective slsp, owner, vehicle chosen
                                If ilFoundOne Then
                                    For ilCorT = ilStartCorT To ilEndCorT Step 1
                                        For ilTemp = 1 To 12
                                            llTempProject(ilTemp) = tmAdjust(ilVehLoop).lProject(ilTemp)
                                            llTempAcquisition(ilTemp) = tmAdjust(ilVehLoop).lAcquisitionCost(ilTemp)
                                        Next ilTemp
                                    tmGrf.iVefCode = tmAdjust(ilVehLoop).iVefCode
                                    '7-2-14 some fields not required, remove them
                                    'mSlsPlacementInsert llTempProject(), llTempAcquisition(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, slCommPct, smGrossOrNet, ilHowManyDefined, ilMatchSSCode, ilDateFlag, ilNewCode, 1, igPeriods, tmVef.iMnfGroup(ilLoop + 1)  '8-31-00
                                    mSlsPlacementInsert llTempProject(), llTempAcquisition(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, smGrossOrNet, ilHowManyDefined, ilDateFlag, ilNewCode, 1, igPeriods
                                    Next ilCorT
                                End If              'ilfoundOne
                            End If                  'llprocesspct >0
                        Next illoop                 '0 to ilhowmany-1 step 1
                    End If
                Next ilVehLoop                  '0 To imUpperAdjust - 1

                For ilScratch = 1 To 13 Step 1    'init projection buckets for next line or contract
                    lmProject(ilScratch) = 0
                    lmAcquisition(ilScratch) = 0
                    lmAcquisitionNet(ilScratch) = 0
                Next ilScratch
                ReDim tmAdjust(0 To 0) As ADJUSTLIST             'prepare list of mgs
                imUpperAdjust = 0

                End If                          'if (owner), slsp,  or (vehicle) or end of contract
            Next ilClf                          'next schedule line - for advt & slsp the entire contr is accumulated before writing to GRF
        End If                                  'exclude all promotions, merchandising - only include trade if requested
    End If                                      'ilfound

    For ilScratch = 1 To 13 Step 1          'init projection buckets for next or contract
        lmProject(ilScratch) = 0
        lmAcquisition(ilScratch) = 0
    Next ilScratch
    Next ilCurrentRecd
    Erase tlSofList, tmMnfList, tlScf, tlSlf, tlSlfIndex
    Erase llTempProject, llTempAcquisition, tlMnf, tmAdjust
    Erase llSlfSplit, ilSlfCode, ilslfcomm, ilslfremnant

    ilRet = btrClose(hmScf)
    btrDestroy hmScf
End Function

'               CloseBRGenFiles
'               'DH 7-23-01
Sub mCloseBRGenFiles()
    Dim ilRet As Integer
    Dim ilValue As Integer
    
    ilRet = btrClose(hmSof)
    ilRet = btrClose(hmUrf)
    ilRet = btrClose(hmMnf)
    ilRet = btrClose(hmSlf)
    ilRet = btrClose(hmRdf)
    ilRet = btrClose(hmDnf)
    ilRet = btrClose(hmAgf)
    ilRet = btrClose(hmAdf)
    ilRet = btrClose(hmCff)
    ilRet = btrClose(hmClf)
    ilRet = btrClose(hmCHF)
    ilRet = btrClose(hmTChf)
    ilRet = btrClose(hmCbf)
    ilRet = btrClose(hmCxf)
    ilRet = btrClose(hmDrf)
    ilRet = btrClose(hmDpf)
    ilRet = btrClose(hmSbf)
    ilRet = btrClose(hmVsf)
    ilRet = btrClose(hmRvf)
    ilRet = btrClose(hmPhf)
    ilRet = btrClose(hmVbf)
    ilRet = btrClose(hmMkt)
    ilRet = btrClose(hmVLF)
    ilRet = btrClose(hmAtt)
    ilRet = btrClose(hmShf)
    ilRet = btrClose(hmTxr)
    ilRet = btrClose(hmSef)
    ilRet = btrClose(hmRaf)
    ilRet = btrClose(hmAnf)
    ilRet = btrClose(hmPcf)
    ilRet = btrClose(hmThf)
    ilRet = btrClose(hmTif)

    btrDestroy hmSof
    btrDestroy hmUrf
    btrDestroy hmMnf
    btrDestroy hmSlf
    btrDestroy hmRdf
    btrDestroy hmDnf
    btrDestroy hmAgf
    btrDestroy hmAdf
    btrDestroy hmCff
    btrDestroy hmClf
    btrDestroy hmCHF
    btrDestroy hmTChf
    btrDestroy hmCbf
    btrDestroy hmCxf
    btrDestroy hmDrf
    btrDestroy hmDpf
    btrDestroy hmDef
    btrDestroy hmSbf
    btrDestroy hmVsf
    btrDestroy hmRvf
    btrDestroy hmPhf
    btrDestroy hmVbf
    btrDestroy hmMkt
    btrDestroy hmVLF
    btrDestroy hmAtt
    btrDestroy hmShf
    btrDestroy hmTxr
    btrDestroy hmSef
    btrDestroy hmRaf
    btrDestroy hmAnf
    btrDestroy hmPcf
    btrDestroy hmThf
    btrDestroy hmTif

    ilValue = Asc(tgSpf.sSportInfo)
    If (ilValue And USINGSPORTS) = USINGSPORTS Then 'Using Sports, close game files
        ilRet = btrClose(hmCgf)
        ilRet = btrClose(hmGsf)
        btrDestroy hmCgf
        btrDestroy hmGsf
    End If
End Sub

Sub gBRGen()
    '*************************************************************************************
    '
    '       Broadcast Contract - Order or Proposal version
    '
    '       5/23/96  D Hosaka
    '
    '       Revised:  1/15/97 ADjust for bad start & end dates stored in
    '               the schedule line.  If dates outside of contract hdr
    '               dates and not Cancel Before Start, then ues the
    '               dates of the header for the earliest/latest dates of the line.
    '               2/23/98 Fix differences only option if the entire
    '                   schedule is moved to later date.  This was messed
    '                   up due to code implemented to fix bad sch lines
    '                   start/end dates
    '
    '               4/26/98 scheme changed in Differences option.  Rather
    '                   than calculating the spots, $, and research for
    '                   the previous and current versions, then subtracting
    '                   to get the differences, the following scheme will be
    '                   used:  When a contract is obtained and determined to
    '                   be differences only, set up a contract that has the
    '                   difference built into the schedule lines/flights.
    '                   So there may be spot counts & $ with negative values.
    '                   Then, spit out the BR with the normal code.
    '
    '               5/13/98 Changed to include vehicles when they dont have any rating info.
    '                       Include them in quarter/contract totals
    '               6/2/98 Add option for corp or std quarters
    '               11/6/98 Add selective vehicles for Insrtion orders, use only
    '                       hidden lines (no pkg)
    '               1/5/99 if no research selected, do not show survey book in header
    '                      Always show cancellation notice (on New & revisions)
    '               2/4/99  Fix Research totals for Contract.  Previously, each
    '                   quarters research values (by line) were used for the final
    '                   contract totals.  Change to gather entire line, regardless
    '                   of duration of line (not by quarters).
    '           3/4/99  For diff only - show diff if net result of spots = 0 and the
    '                   line is for N/c
    '           4/7/99  Change calculation of Research values for package buys
    '                   Remove all occurrances of tmPrevLRch (that was used for the
    '                   previous (vs current) for differences report.
    '           11/29/99 Fix research (avt rtg & grps) when using different books
    '                   across multiple lines for the same vehicle
    '           2/4/00  Add option (from site pref) to show weeks based on start of
    '                   std qtr even if less than 13 weeks vs based on start date if
    '                   less than 13 weeks
    '           2-10-00 Calculate grps for individual weeks by vehicle and contract
    '                   all the weekly totals must be stored in the CBF record;
    '                   it cannot be calculated in crystal
    '           2-18-00 Fix Package vehicle summary when more than 1 line of the same pkg
    '           6-2-00 Hidden lines counted on differences only causing overstated of previous version
    '           6-6-00 Hidden lines are counted on detail proof when totalling vehicle totals by qtr
    '           10-11-02 Create printed contract summary for NTR
    '           10-28-03 Add socio-economic research
    '           5-28-04  Add Satellite Research estimates
    '           6-15-04 Ignore CBS lines whose original start date is prior to the contract start/end dates
    '               When in prior periods, cases problems with researchtotals
    '           6-30-04 Add selectivity for differences only to Insertion order
    '           11-24-04 CPP and sometimes weekly grps invalid when a package name is the same
    '                       vehicle as the hidden lines.  Also, when excluding hidden lines with
    '                       with the same case above, and a conventional line also exists, the
    '                       research information on the summary resulted in all zeroes.
    '           '3-24-05 change ilprevSpots to llPrevSpots (long) for more than 32000 spots
    '           8-23-05 Insertion Order - show acquisition cost if it exists and research not requested
    '
    '       CBF Record types :  cbfExtra2Byte = 0:  detail
    '                                           2 = vehicle summary
    '                                           3 = contract tots
    '                                           4 = NTR
    '                                           5 = sports (games)
    '                                           6 = for Installment contracts only for those vehicles that
    '                                               were not on the air time schedule (i.e. NTRs).  These
    '                                               vehicles need to show on the Installment Summary version
    '                                           7 = Key record for Insertion Order
    '                                           8 = NTR billing summary (non-installment)
    '                                           9 = CPM detail IDs
    '                                           10 = CPM vehicle summary (for Research page)
    '                                           11 = CPM billing summary by vehicle
    '**************************************************************************************
    Dim ilStdQtrLess13 As Integer             '2-4-00 Show std qtr if less than 13 weeks
    Dim ilShowStdQtr As Integer             'true if std quarters, else false for corp, 0 = std, 1 = cal, 2 = corp
    Dim ilCorpStdYear As Integer            'corp or std year that contracts belongs in
    Dim ilStartMonth As Integer             'starting month of corp or std year that contract belongs in
    Dim ilRet As Integer
    Dim llCurrCode As Long                  'if differences, current cntr code
    Dim llPrevCode As Long                  'if differences, previous cntr code
    Dim ilPrintables As Integer              'from user input (printables- ckcselC3(0))
    Dim llContrPrinted As Long              'contr # printed from printables to keep track of bypassing
                                            'the same contr # when more than 1 header is active (due to
                                            'planner changes
    Dim ilDiffOnly As Integer               'from user input (Differences only - ckcSelC5(0))
    Dim ilShowMods As Integer               'from user input (for printables - show mods as differences ckcselc8(0))
    Dim ilCurrTotalMonths As Integer        'total months of order processing (to be stored in cbf)
    ReDim ilCurrStartQtr(0 To 1) As Integer   'start date of first qtr processing (to be stored in cbf)
    Dim ilFoundCnt As Integer               'valid contract to process
    Dim ilCurrentRecd As Integer            'number of contracts processed so far
    Dim ilDemo As Integer                   'loop variable for each of the 4 demos to process
    Dim illoop As Integer                   'temp loop variable
    Dim ilHiddenAndConv As Integer          '11-24-04
    Dim ilLoop3 As Integer                  'temp loop variable
    Dim ilRchQtr As Integer
    Dim ilTemp As Integer
    Dim ilSavePkVeh As Integer
    Dim ilMonthLoop As Integer
    Dim ilUpperPrint As Integer             'number of printable contracts
    Dim ilfirstTime As Integer
    Dim llContrCode As Long                 'Contr ID to process
    Dim slStartDate As String               'Contract start date
    Dim slEndDate As String                 'contract end date
    Dim ilTotalWks As Integer               'Total weeks of contract start to end
    Dim slMonth As String
    Dim slDay As String
    Dim slYear As String
    Dim ilClf As Integer                    'loop for lines
    Dim ilCff As Integer                    'loop for flights
    Dim ilPkgClf As Integer
    Dim ilLineRate As Integer               'count of # of line items due to unique rates
    Dim ilLineSpots As Integer              'count by line & rate of # spots per week
    Dim ilLineSpotsInx As Integer           'index to entry of unique line in table
    Dim slStr As String                     'temp string for conversions
    Dim ilWeekInx As Integer
    Dim ilQtr As Integer
    Dim llDate As Long                      'temp serial date
    Dim llTaxDate As Long
    Dim llDate2 As Long
    Dim llActiveStartDate As Long           'user input active start date or 1/5/70
    Dim llActiveEndDate As Long             'user input active end date or 12/29/2069
    Dim llEnterStartDate As Long            'user input entered start date or 1/5/70
    Dim llEnterEndDate As Long              'user input entered end date of 12/29/2069
    Dim llChfStart As Long                  'start date from contr header
    Dim llChfEnd As Long                    'end date from contr header
    Dim ilDay As Integer
    Dim llAccumSpotCount As Long            '3-25-05
    Dim llFltStart As Long                  'serial flight start date
    Dim llFltEnd As Long                    'serial flight end date
    Dim ilFoundLine As Integer              'flag that unique line & rate built in memory
    Dim ilFoundVeh As Integer               'include the vehicle for processing (only possibly excluded if Insertion Orders)
    Dim ilManyFlts As Integer               'true if more than 1 flt for a line, otherwise false.
                                            'This is so Crytal knows to show the package research totals when theres only 1 flt, and
                                            'not to put it on the total line only
    Dim ilSpots As Integer                  'total spots for the flight week
    Dim slValidDays As String * 40           '5-20-03 chged frm 20 to 30 for 4 char / day (plus blank) for dailies
                                             '11-19-02 chged to 20 (from 10)represents days of the week airing string (without blanks & commas)
    Dim slTempDays As String                 'represents days of the week airing string (with blanks & commas)
    Dim ilUpperDnf As Integer               'number of different demo research codes form contr
    Dim slNameCode As String
    Dim slCode As String
    Dim ilGetAll As Integer                 'true = get history plus current, false = get only current
    Dim slSurvey As String                  'string of research books from lines
    ReDim ilInputDays(0 To 6) As Integer      'valid days of the week for gGetAvgAud
    Dim llOvStartTime As Long               'override start time for Get Avg Aud
    Dim llOvEndTime As Long                 'overrride end time for gGetAvgAud
    Dim llPop As Long                       'population from gDemoPOP
    Dim llResearchPop As Long               'pop to use for Research Totals (if different across lines, send 0 and pop will be calc based on grimps)
                                            'otherwise send the pop from the book
    Dim llOverallPopEst As Long             '6-1-04 contract pop estimates for all lines
    Dim llAvgAud As Long
    Dim llLnSpots As Long                   'total spots to pass to Research routines
    Dim ilUpperClf As Integer
    Dim ilRealTotalWks As Integer           'total number of weeks based on contr start/end dates
    Dim ilCmpny As Integer                  'Company competitor "Us"
    Dim slTimeStamp As String               'time stamp to MNF file
    Dim llTemp As Long                      'temporary long variable
    Dim ilGot1ToPrint As Integer             'true if at least 1 line to print
    Dim llCntGrimps As Long                    'contract total grimps calculated before each line written todisk so that
                                               'the % distribution can be obtained
    Dim llPrevCntGrimps As Long                 'contr total grimps calculated o previous order before each line written to disk so that
                                                'the % distr can be obtained
    Dim llCurrMod As Long                      'total contrct $ for current mod
    Dim llCurrModSpots As Long              'total contract spots for current mod
    Dim llPrevSpots As Long                  '3-24-05 chg to long: total contracts spots for previous version (differences option)
    Dim llPrevGross As Long                     'total contracts gross $ for previous version (differences option)
    Dim ilVehicle As Integer                  'loop field for ilVehList
    Dim ilPkg As Integer                      'loop field for ilPkgVehList & ilPkgLineList
    Dim ilPkgOrSpot As Integer
    Dim ilThisCntMod As Integer
    Dim ilCurrTotalWks As Integer             'for differences - total weeks of current order (start date to end date, obtained from gGenDiff)
    Dim ilCurrAirWks As Integer             'for differences - total weeks airing spots from the current order - obtained from gGenDiff
    Dim ilListIndex As Integer              'index for the report selected in list (testing Proposals/Orders vs Insrtions Orders)
    ReDim tlInsertVehList(0 To 0) As INSERTINFO    '12-12-08
    '3-18-19
    ReDim ilWklyspots(0 To MAXWEEKSFOR2YRS - 1) As Integer    'arrays set up for each line to pass wkly research data to subrtn
    ReDim llWklyRates(0 To MAXWEEKSFOR2YRS - 1) As Long       'arrays set up for each line to pass wkly research data to subrtn
    ReDim llWklyAvgAud(0 To MAXWEEKSFOR2YRS - 1) As Long          'arrays set up for each line to pass wkly research data to subrtn
    ReDim ilWklyRtg(0 To MAXWEEKSFOR2YRS - 1) As Integer      'arrays set up for each line to return contracts research data
    ReDim llWklyGrimp(0 To MAXWEEKSFOR2YRS - 1) As Long       'arrays set up for each line to return contracts research data
    ReDim llWklyGRP(0 To MAXWEEKSFOR2YRS - 1) As Long         'arrays set up for each line to return contracts research data
    ReDim llWklyPopEst(0 To MAXWEEKSFOR2YRS - 1) As Long      'array set up for each line
    ReDim tmWkHiddenVGrps(0 To 0) As WEEKLYGRPS     '2-20-00
    Dim tlSBFType As SBFTypes
    Dim tlInstallSBFType As SBFTypes
    Dim ilDemoAvgAudDays(0 To 6) As Integer     '11-19-02, rquired for valid days sent to audienc rtn
    Dim slDailyExists As String * 1      '5-20-03 "Y" if at least 1 daily line exist for the contract
    Dim slSpotCount As String        '5-21-03
    Dim ilCBS As Integer             '5-24-03
    Dim ilSocEcoMnfCode As Integer         '10-28-03 socio-economic mnf pointer selected
    Dim llPopEst As Long
    Dim slPriceType As String * 1       '9-21-05 price type from line, except if insertion orders using acquisition cost, $0 will show blank
    Dim ilVefIndex As Integer
    Dim llTempStart As Long
    Dim llTempEnd As Long
    Dim ilOKToSeeCnt As Integer
    Dim slLastBillDate As String      'last bill date from Site
    ReDim tlRvf(0 To 0) As RVF
    Dim llTax1Pct As Long           'tax 1 pct from tax table
    Dim llTax2Pct As Long           'tax 2 pct from tax table
    Dim slGrossNet As String
    Dim llTax1CalcAmt As Long
    Dim llTax2CalcAmt As Long
    Dim ilLastBilledInx As Integer
    Dim ilAgyComm As Integer
    Dim llLastBillDate As Long
    ReDim ilVehiclesDone(0 To 1) As Integer       'array of installment vehicles processed
    ReDim tlSbf(0 To 0) As SBF                  'monthly installment records from SBF
    Dim ilAudFromSource As Integer
    Dim llAudFromCode As Long
    Dim ilVaryingQtrs As Integer
    Dim tlPkgVehicleForSurveyList() As PKGVEHICLEFORSURVEYLIST  '12-19-13  List of unique pakcage vehicles and book references.  i.e. 1 package vehicle may be defined for multiple lines.,
                                                                'the same hidden vehicle name name be across those 2 pkg lines and each have different book references
                                                                'i.e. Line 1 pkg: Acme pkg, hidden line Billy Crystal using book spring 2015; Line 2 pkg:  Acme, hidden line Billy Crystal using book Fall 2015
    Dim ilLoopOnDiff As Integer                         '5-13-15 If insertion order, could loop twice:  once for differences, once for whole contract.  If BR, go thru only once for option selected
    Dim ilOption1 As Integer                            'ilOption1 and ilOption2 indicate which version of the BR or Insertion order to print.  flag 1 = difference, flag 2 = whole contract
    Dim ilOption2 As Integer
    Dim ilContentIndex As Integer
    Dim blSelectedVehicle As Boolean
    Dim blGotInfo As Boolean
    Dim blAcqOK As Boolean
    Dim llAcqNet As Long
    Dim llAcqComm As Long
    Dim ilWhichSort As Integer              '1-7-21

    ilRet = mOpenBRFiles()                      'open all BR files
    If ilRet <> BTRV_ERR_NONE Then              'any error, exit and quit
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    '7-23-01 setup global variable for Demo Plus file (to see if any exists)
    lgDpfNoRecs = btrRecords(hmDpf)
    If lgDpfNoRecs = 0 Then
        lgDpfNoRecs = -1
    End If

    'obtain latest bill date in case taxes apply.  Past dates will obtain the tax values from
    'billed receivables, future will be calculated
    gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slLastBillDate
    If slLastBillDate = "" Then
        slLastBillDate = "1/1/1970"
    End If
    llLastBillDate = gDateValue(slLastBillDate)
    tmTranTypes.iAdj = False
    tmTranTypes.iAirTime = True
    tmTranTypes.iCash = True
    tmTranTypes.iInv = True
    tmTranTypes.iMerch = False
    tmTranTypes.iNTR = True
    tmTranTypes.iPromo = True
    tmTranTypes.iPymt = False
    tmTranTypes.iTrade = False
    tmTranTypes.iWriteOff = False

    'if NTR applicable, setup types of records to retrieve from SBF
    tlSBFType.iNTR = True           'get Item billing (NTR) only
    tlSBFType.iInstallment = False
    tlSBFType.iImport = False
    igBR_NTRDefined = False
    igBR_CPMDefined = False             '1-8-21

    'if Installment applicable, setup types of records to retrieve from SBF
    tlInstallSBFType.iNTR = False
    tlInstallSBFType.iInstallment = True
    tlInstallSBFType.iImport = False

    ilListIndex = RptSelCt!lbcRptType.ListIndex
    If (igRptType = 0) And (ilListIndex > 1) Then   'if proposals and the report index is greater than one,
        ilListIndex = ilListIndex + 1               'adjust for the report that is not shown
    End If
    imAllVehicles = True
    imShowNetNet = False                        '01-16-01
    ilSocEcoMnfCode = 0                                '10-28-03
    ReDim imUsevefcodes(0 To 0) As Integer      '10-24-08 Insertion order: maintain all vehicles including NTR for combined Insertion Order version
    imShowNTRBillSummary = True                 '1-28-10 default to show NTR billing summary with air time bill summary
    '1-7-21
    If RptSelCt!rbcSelCSelect(0).Value Then     'which sort - adv
        ilWhichSort = 0
    ElseIf RptSelCt!rbcSelCSelect(1).Value Then 'agy
        ilWhichSort = 1
    Else
        ilWhichSort = 2                         'slsp
    End If

    If ilListIndex = CNT_INSERTION Then
        imShowNTRBillSummary = False            '1-28-10 this is for combined NTR & air time billing summary, Not applicable to Insertion Orders
        If RptSelCt!ckcSelC10(0).Value = vbChecked Then              '01-16-01
            imShowNetNet = True
        End If
        ReDim imSelectedVehicles(0 To 0) As Integer
        imAllVehicles = gSetCheck(RptSelCt!CkcAllveh.Value) '9-12-02
        If RptSelCt!lbcSelection(6).SelCount <= 0 Then
            imAllVehicles = True
            RptSelCt!CkcAllveh.Value = vbChecked
        End If
        For ilVehicle = 0 To RptSelCt!lbcSelection(6).ListCount - 1 Step 1
            If (RptSelCt!lbcSelection(6).Selected(ilVehicle)) Then
                slNameCode = tgCSVNameCode(ilVehicle).sKey  'RptSelCt!lbcCSVNameCode.List(ilOption)
                ilRet = gParseItem(slNameCode, 2, "\", slCode)
                imSelectedVehicles(UBound(imSelectedVehicles)) = Val(slCode)
                ReDim Preserve imSelectedVehicles(0 To UBound(imSelectedVehicles) + 1) As Integer
            End If
        Next ilVehicle
        
        'if emailing, pick up content and response date from user input
        If RptSelCt!rbcOutput(3).Value = True Then
            ilContentIndex = RptSelCt!cbcEMailContent.ListIndex
            lmEmfCode = RptSelCt!cbcEMailContent.GetItemData(ilContentIndex)
            smResponseDate = RptSelCt!edcResponse.Text
        End If
        
        '4-18-18 Default to always show all aud % info if podcast
        bmShowAudIfPodcast = True
    Else                'contract print, not Insertion orders
        If RptSelCt!cbcSet1.ListIndex > 0 Then
            slNameCode = tgSocEcoCode(RptSelCt!cbcSet1.ListIndex - 1).sKey
            ilRet = gParseItem(slNameCode, 2, "\", slCode)
            ilSocEcoMnfCode = Val(slCode)
        End If
        If RptSelCt!ckcSelC10(1).Value = vbUnchecked Then       'exclude the NTR from billing summary
            imShowNTRBillSummary = False
        End If
        
        '4-18-18 determine how to show aud % for Podcast
        bmShowAudIfPodcast = True
        If RptSelCt!ckcInclRevAdj.Value = vbUnchecked Then
            bmShowAudIfPodcast = False              'do not show Aud % if podcast vehicle
        End If
        
        'TTP 10382 - Contract report: Option To not show Act1 codes on PDF
        bmShowACT1Codes = False
        If RptSelCt!ckcShowACT1.Value = vbChecked Then
            bmShowACT1Codes = True
        End If
    End If
    'gObtainCorpCal         'corp calendar (if used), has been retrieved in mInitReport , stored in tgMCof
'    ilShowStdQtr = True
    ilShowStdQtr = 0                    'default to std
    
    
'corp feature is not implemented, currently set for std or cal
'    If RptSelCt!rbcSelC9(0).Value Then                          'corp selected?
'        ilShowStdQtr = False
'    End If
    ilStdQtrLess13 = False
    If tgSpf.sSBrStdQt = "Y" Then               'always show std qtr regardless if less than 13 week order
        ilStdQtrLess13 = True
    End If
    ilPrintables = gSetCheck(RptSelCt!ckcSelC3(0).Value)                   'user input: Printables
    ilDiffOnly = gSetCheck(RptSelCt!ckcSelC5(0).Value)                     'userinput: Differences only
    ilShowMods = gSetCheck(RptSelCt!ckcSelC8(0).Value)                     'user input: for printables, showmods as differences
    ilThisCntMod = False
    imHiddenOverride = Asc(tgSpf.sUsingFeatures)                '3-10-06 determine if usinig hidden overrides on package hidden lines
    bmUseAcq = False                                            'assume not using acq cost for differences option
    
    'Get all company competitor records - specifically get "Us"
    ilRet = gObtainMnfForType("O", slTimeStamp, tlMMnf())
    For illoop = LBound(tlMMnf) To UBound(tlMMnf) Step 1
        If tlMMnf(illoop).iGroupNo = 1 Then
            ilCmpny = tlMMnf(illoop).iCode
        End If
    Next illoop
    
    gPopAnf hmAnf, tmAnfTable()              'populate the Named Avails in array for DP Overrides printing rules
    'setup earliest and latest active and entered dates for comparision to the header
    mBRInputDates llActiveStartDate, llActiveEndDate, llEnterStartDate, llEnterEndDate

    'ilUpperPrint = 1                                'init # of printable contracts
    'ReDim lgPrintedCnts(1 To 1) As Long             'table to maintain the contr pointers
    ilUpperPrint = 0                                'init # of printable contracts
    ReDim lgPrintedCnts(0 To 0) As Long             'table to maintain the contr pointers
                                                    'when contracts are finished printing, update print flag
                                                    'from this table
    ReDim lmMatchingCnts(0 To 0) As Long            'stored contr numbers to process
    ReDim tgEmail_PDFs(0 To 0) As EMAIL_PDFS        'init list of unique vehicle/cnt to separate insertion order pdfs
    'ilFoundCnt = 1
    ilFoundCnt = 0

    'Adjust for conflict in user entry:  Check Differences only on, plus check for printables to
    'show mods as differences
    If RptSelCt!ckcAllAAS.Value = vbChecked Then            'all selected to print
        If ilDiffOnly And ilShowMods Then       'differnces check as well as show mods as differences
            'override and do the "Show mods as differences"instead of showing all of them as differences
            ilDiffOnly = False
        End If
    Else                                        'selective ones chosen, cant process for show mods as differences
        ilShowMods = False
    End If
    If ilDiffOnly Then
        'ilGetAll = True                     'get history for differences
        ilGetAll = False                     ' When diff only, the differences are created
                                             'and put in tgChfCt array, eliminating the need to get history
        ilThisCntMod = True                  'show all cntracts to be printed as mods
    Else
        ilGetAll = False                    'get current version only
    End If
    igBR_SchLinesExist = False         'if selective contract, dont show if no sch lines; if more than 1 contract,
                                        'show when theres at least 1 sch line to a contract
    lmSingleCntr = 0                        '11-27099
    If RptSelCt!edcTopHowMany <> "" Then
        lmSingleCntr = Val(RptSelCt!edcTopHowMany)                  '10-20-06
    End If
    If lmSingleCntr > 0 Then            'get the contracts audo code
        tmChfSrchKey1.lCntrNo = lmSingleCntr
        tmChfSrchKey1.iCntRevNo = 32000
        tmChfSrchKey1.iPropVer = 32000
        ilRet = btrGetGreaterOrEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)

        ReDim Preserve lmMatchingCnts(0 To ilFoundCnt) As Long
        If lmSingleCntr = tmChf.lCntrNo Then
            lmMatchingCnts(ilFoundCnt) = tmChf.lCode
            ilFoundCnt = ilFoundCnt + 1
        End If
    End If

    If ilListIndex = CNT_INSERTION And imShowNetNet Then     'if insertion order and net-net, need to get the participants share
                                                'to calculate for this one contract; if multiple contracts selected, need to get all
                                            'participant records because its unknown as to how far back they will request a contract
        If lmSingleCntr > 0 Then
            gUnpackDateLong tmChf.iStartDate(0), tmChf.iStartDate(1), llDate2
        Else
            llDate2 = gDateValue("1/1/1970")
        End If
        gCreatePIFForRpts llDate2, tmPifKey(), tmPifPct(), RptSelCt
    End If
    
'    blGotInfo = gBuildAcqCommInfo(RptSelCt)        'build table of varying acquisition % by vehicle for all dates

    '3-120 this setup has been moved from below
    If ilListIndex = CNT_INSERTION Then         '5-13-15
        If ((Asc(tgSpf.sUsingFeatures2) And BARTER) = BARTER) And (RptSelCt!ckcSelC6(1).Value = vbUnchecked) Then
            bmUseAcq = True
        End If
        If ilDiffOnly Then
            ilOption1 = 1           'diff only
            ilOption2 = 2           'whole contract
        Else
            ilOption1 = 2           'only whole contract requested to output
            ilOption2 = 2
        End If
    Else                    'broadcast contract
        If (ilDiffOnly) Then            'user selected differences only
            ilOption1 = 1           'diff only
            ilOption2 = 1
        Else
            ilOption1 = 2           'whole contract only
            ilOption2 = 2
        End If
    End If
    
    If Not RptSelCt!ckcAllAAS.Value = vbChecked Or lmSingleCntr > 0 Then                'not all advt, agy or slsp (selective ones)
        If lmSingleCntr = 0 Then
            For illoop = 0 To RptSelCt!lbcSelection(0).ListCount - 1 Step 1
                If RptSelCt!lbcSelection(0).Selected(illoop) Then
                    'slNameCode = RptSelCt!lbcMultiCntrCode.List(ilLoop)
                    slNameCode = RptSelCt!lbcCntrCode.List(illoop)
                    ilRet = gParseItem(slNameCode, 2, "\", slCode)
                    ReDim Preserve lmMatchingCnts(0 To ilFoundCnt) As Long
                    lmMatchingCnts(ilFoundCnt) = Val(slCode)
                    ilFoundCnt = ilFoundCnt + 1
                End If
            Next illoop
        End If
    
        For ilLoopOnDiff = ilOption1 To ilOption2
            smSnapshot = ""
            If ilListIndex = CNT_INSERTION Then
                If ilLoopOnDiff = 2 Then               'if insertion order on pass 2, show the whole contract
                    ilDiffOnly = False
                    smSnapshot = ""
                Else                                'insertion order and pass 1, show the diff
                    smSnapshot = "D"            'diff only flag
                End If
            End If
        
            'Loop thru the selective contracts (array of contract codes) to be printed
            For ilCurrentRecd = LBound(lmMatchingCnts) To UBound(lmMatchingCnts) Step 1                                            'loop while llCurrentRecd < llRecsRemaining
                llPrevSpots = 0             '6-6-00
                llPrevGross = 0
                llContrCode = lmMatchingCnts(ilCurrentRecd)
    
                ilFoundCnt = mGetAContractCt(hmTChf, hmClf, hmCff, llContrCode, llEnterStartDate, llEnterEndDate, llActiveStartDate, llActiveEndDate, ilGetAll)
                ilGot1ToPrint = False       'init to havent got a line to print yet
                'if contract is greater than 2 years, we need to ignore it for now.  Tables are exceeded
                'mChfDatesToLong llDate, llDate2, slStartDate, slEndDate   'convert contract header start & end dates to long
                gChfDatesToLong tgChfCT.iStartDate(), tgChfCT.iEndDate(), llDate, llDate2, slStartDate, slEndDate  'convert contract header start & end dates to long
    
                If (tgChfCT.sDelete = "Y") Or ((llDate2 - llDate + 1) / 7 > 104) Or ((ilPrintables And tgChfCT.sPrint = "P")) Then
                    ilFoundCnt = False
                End If
                ilRet = m104PlusWks(llDate, llDate2, tlRvf(), tlInsertVehList(), ilWhichSort)           'see if over 104 weeks
    
                '12-6-06 OK if contr is not deleted, not over 104 weeks, and user is allowed to see contract
                If (ilFoundCnt) And (ilRet) And (gCntrOkForUser(hmVsf, tgUrf(0).iSlfCode, tgChfCT.lVefCode, tgChfCT.iSlfCode())) Then 'get a contract and test for printables,
                    llCurrCode = tgChfCT.lCode
                    llPrevCode = 0
                    If ilShowMods Or ilDiffOnly Then                            'differences or  differences for Mods on printables
                        If (ilListIndex = CNT_INSERTION And tgChfCT.iCntRevNo = 0) Then
                            ilFoundCnt = False
                        Else
                            ilFoundCnt = mGoGetCntr(llPrevSpots, llPrevGross, ilCurrTotalWks, ilCurrAirWks, tlRvf(), tlInsertVehList(), ilWhichSort, bmUseAcq)  '2-11-00
                        End If
                    End If
                    If ilFoundCnt Then
                        '6/8/16: Replaced GoSub
                        'GoSub ProcessBR:
                        mProcessBR slStartDate, slEndDate, llDate, llDate2, tlInstallSBFType, tlSbf(), ilUpperPrint, ilShowStdQtr, slLastBillDate, llLastBillDate, ilStdQtrLess13, tlInsertVehList(), tlRvf(), ilListIndex, ilSocEcoMnfCode, ilShowMods, ilDiffOnly, ilThisCntMod, ilCurrTotalWks, llPrevSpots, llPrevGross, ilCurrAirWks, ilGot1ToPrint, ilLoopOnDiff, ilOption1, ilOption2, tlSBFType
                    End If
                End If
            Next ilCurrentRecd
        Next ilLoopOnDiff
        'GoTo CloseAndExit
    Else                                        'all advt, agy, or slsp (probably printables, or for startup station to verify all contracts input)
        For ilLoopOnDiff = ilOption1 To ilOption2
            smSnapshot = ""
            If ilListIndex = CNT_INSERTION Then
                If ilLoopOnDiff = 2 Then               'if insertion order on pass 2, show the whole contract
                    ilDiffOnly = False
                    smSnapshot = ""
                Else                                'insertion order and pass 1, show the diff
                    smSnapshot = "D"            'diff only flag
                End If
            End If

            'change to use key1 (rather than key0) to test for 2 undeleted headers when printing printables
            ilRet = btrGetFirst(hmCHF, tmChf, imCHFRecLen, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point
            ilFoundCnt = True
            Do While ilRet = BTRV_ERR_NONE
                ilGetAll = False                 'assume full (normal) BR
                ilThisCntMod = False
                If (tmChf.sDelete = "N") Then        'bypass if deleted
                    If (RptSelCt!rbcSelCInclude(1).Value Or RptSelCt!rbcSelCInclude(2).Value) Then       'orders
                        'Must be Status HOGN or revised working with external mod # > 0, or printable requested and contract not yet printed, or not printables requested
                        'If ((tmChf.sStatus = "H" Or tmChf.sStatus = "O" Or tmChf.sStatus = "G" Or tmChf.sStatus = "N") Or (tmChf.sStatus = "W" And tmChf.iExtRevNo > 0)) And ((ilPrintables And tmChf.sPrint <> "P") Or Not (ilPrintables)) Then
                        If ((tmChf.sStatus = "H" Or tmChf.sStatus = "O" Or tmChf.sStatus = "G" Or tmChf.sStatus = "N")) And ((ilPrintables And tmChf.sPrint <> "P") Or Not (ilPrintables)) Then
                            If (ilDiffOnly) Or (ilShowMods And tmChf.iExtRevNo > 0) Then   'if differences or printables and show mods as differences then get the entire cnt
                                'ilGetAll = True
                                ilThisCntMod = True
                            End If
                            If tmChf.lCntrNo = llContrPrinted Then      'if this contract same as previous one printed, bypass it
                                                                        'there can be more than 1 contr with the same # thats not flagged as deleted.
                                ilFoundCnt = False
                            End If
                            llContrPrinted = tmChf.lCntrNo
                        Else
                            ilFoundCnt = False
                        End If
                    Else                                            'proposals                                           '
                        If (tmChf.sStatus = "H" Or tmChf.sStatus = "O" Or tmChf.sStatus = "G" Or tmChf.sStatus = "N") Or (tmChf.sType = "W" And tmChf.iExtRevNo > 0) Then   'its an order
                            ilFoundCnt = False
                        End If
                    End If
    
                    '12-06-06 check to see if user is allowed to see contract
                    ilOKToSeeCnt = gCntrOkForUser(hmVsf, tgUrf(0).iSlfCode, tmChf.lVefCode, tmChf.iSlfCode())
                    If (ilFoundCnt) And (ilOKToSeeCnt) Then
                        llPrevSpots = 0             '6-6-00
                        llPrevGross = 0
                        llContrCode = tmChf.lCode
                        ilFoundCnt = mGetAContractCt(hmTChf, hmClf, hmCff, llContrCode, llEnterStartDate, llEnterEndDate, llActiveStartDate, llActiveEndDate, ilGetAll)
                        'if contract is greater than 2 years, we need to ignore it for now.  TAbles are exceeded
                        'mChfDatesToLong llDate, llDate2, slStartDate, slEndDate    'convert contract header start & end dates to long
                        '11-30-07 make generalized routine
                        gChfDatesToLong tgChfCT.iStartDate(), tgChfCT.iEndDate(), llDate, llDate2, slStartDate, slEndDate   'convert contract header start & end dates to long
    
                        If (tgChfCT.sDelete = "Y") Or ((llDate2 - llDate + 1) / 7 > 104) Or (tgUrf(0).iSlfCode > 0 And tgUrf(0).iSlfCode <> tgChfCT.iSlfCode(0)) Then
                            ilFoundCnt = False
                            If ilPrintables Then          'if printables, still need to set the print flag so it wont appear next time
                                ReDim Preserve lgPrintedCnts(0 To ilUpperPrint) As Long
                                lgPrintedCnts(ilUpperPrint) = tgChfCT.lCode
                                ilUpperPrint = ilUpperPrint + 1
                            End If
                        End If
                        ilRet = m104PlusWks(llDate, llDate2, tlRvf(), tlInsertVehList(), ilWhichSort)          'see if over 104 weeks
    
                        If ilFoundCnt And ilRet Then
                            llCurrCode = tgChfCT.lCode
                            llPrevCode = 0
    
                            If (ilShowMods Or ilDiffOnly) And tgChfCT.iExtRevNo > 0 Then                            'differences for Mods
                                ilFoundCnt = mGoGetCntr(llPrevSpots, llPrevGross, ilCurrTotalWks, ilCurrAirWks, tlRvf(), tlInsertVehList, ilWhichSort, bmUseAcq) '2-11-00
                                If ilPrintables And Not ilFoundCnt Then         'if printables, still need to set the print flag so it wont appear next time
                                    ReDim Preserve lgPrintedCnts(0 To ilUpperPrint) As Long
                                    lgPrintedCnts(ilUpperPrint) = tgChfCT.lCode
                                    ilUpperPrint = ilUpperPrint + 1
                                End If
                            End If
                            If ilFoundCnt Then
                                '6/8/16: Replaced GoSub
                                'GoSub ProcessBR:
                                mProcessBR slStartDate, slEndDate, llDate, llDate2, tlInstallSBFType, tlSbf(), ilUpperPrint, ilShowStdQtr, slLastBillDate, llLastBillDate, ilStdQtrLess13, tlInsertVehList(), tlRvf(), ilListIndex, ilSocEcoMnfCode, ilShowMods, ilDiffOnly, ilThisCntMod, ilCurrTotalWks, llPrevSpots, llPrevGross, ilCurrAirWks, ilGot1ToPrint, ilLoopOnDiff, ilOption1, ilOption2, tlSBFType
                            End If
                        End If
                    End If
                End If                              'endiftmchf.sdelete
                ilRet = btrGetNext(hmCHF, tmChf, imCHFRecLen, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point
                ilFoundCnt = True
            Loop
        Next ilLoopOnDiff
    End If
    'GoTo CloseAndExit
    
    On Error Resume Next
    mCloseBRGenFiles         '7-23-01
    Erase lmPopPkgByLine        '11-11-05
    Erase tmLnr, tgClfCT, tgCffCT, lmMatchingCnts 'lgPrintedCnts
    Erase lmSpotsByWk, imDnfCodes, imProcessFlag            '12-19-13 remove imPkgDnfCodes
    Erase lmratesbywk
    Erase lmWklyspots, lmWklyRates, lmAvgAud, lmPopEst
    Erase lmPop, tmLRch
    Erase tlInsertVehList, tmVCost, tmVRtg, tmVGRP, tmVGrimp
    Erase tmQGRP, tmQCPP, tmQCPM, tmQGrimp, tmVehQtrList
    Erase tmPkVCost, tmPkVRtg, tmPkVGrimp, tmPkVGRP ', tmPkVehQtrList
    Erase tmPkLnCost, tmPkLnGrimp, tmPkLnGRP  ', tmPkLnQtrList
    Erase tmWkCntGrps, tmWkCntVGrps, tmWkHiddenVGrps    ', tmWkPkgVGrps
    Erase imSelectedVehicles
    Erase tlSbf, tmAnfTable
    Erase tmCPM_IDs, tmCPMSummary                                       '1-7-21
    Erase imAirWks, ilVehiclesDone, tlSofList, lmPopPkg, tlRvf     '12-19-13 remove ilPkgVehicleForSurveyList
End Sub

'           gCloseBOBFilesCt - Close all applicable files for
'                       Billed and booked, Slsp Comm Proj,
'                       and Sales Comparison reports
Sub gCloseBOBFilesCt()
    Dim ilRet As Integer

    ilRet = btrClose(hmGrf)
    ilRet = btrClose(hmRvf)
    ilRet = btrClose(hmCHF)
    ilRet = btrClose(hmSlf)
    ilRet = btrClose(hmVef)
    ilRet = btrClose(hmMnf)
    ilRet = btrClose(hmSof)
    ilRet = btrClose(hmClf)
    ilRet = btrClose(hmCff)
    ilRet = btrClose(hmAgf)
    ilRet = btrClose(hmSdf)
    ilRet = btrClose(hmSmf)
    ilRet = btrClose(hmSbf)
    ilRet = btrClose(hmVsf)
    ilRet = btrClose(hmPcf)
    btrDestroy hmGrf
    btrDestroy hmRvf
    btrDestroy hmCHF
    btrDestroy hmSlf
    btrDestroy hmVef
    btrDestroy hmMnf
    btrDestroy hmSof
    btrDestroy hmClf
    btrDestroy hmCff
    btrDestroy hmAgf
    btrDestroy hmSdf
    btrDestroy hmSmf
    btrDestroy hmSbf
    btrDestroy hmVsf
    btrDestroy hmPcf

    Erase tmPifKey, tmPifPct
    Erase tmCntAllYear, tmOneVehAllYear
    Erase tgBBCompare
End Sub

'*****************************************************************************************
'
'                   gCRBob - Billed & Booked report.
'           BILLED AND BOOKED
'           BILLED AND BOOKED RECAP
'           BILLED AND BOOKED COMPARISIONS
'           SALES COMPARISON
'           COMMISSION PROJECTIONS
'           SALES PLACEMENT
'
'                            1st part builds actual data from PHF & RVF.
'                            Gathers all "I" and "A" transactions and places
'                            the $ in the appropriate standard month. If selecting
'                            by owner, the $ are split by the vehicle participation.
'                            If running by slsp, split by commission split %.
'                   <Input>  llStdStartDates - array of max 13 start dates, denoting
'                                              start date of each period to gather
'                            llLastBilled - Date of last invoice period
'                            ilLastbilledInx - Index into llStdStartDates of period last
'                                           invoiced
'                            ilHowManyPer - # of periods to gather
'                                           (for billed & booked its 12,
'                                           for Sales Comparisons its max 2)
'                            ilDateFlag - 0 = no comparison (base dates vs comparison dates) stored in prepass file for .rpt analysis
'                                         1 = base date
'                                         2 = comparison date
'
'                   4/10/97 dh change gathering of PHF & RVF from transation date
'                              to ageing year & period.
'                   7/2/97 dh PHF & RVF used ageing year & period to gather data.  It
'                             also should have used the same to determine month to place $
'                             rather than using the trans. date
'                   3/25/98 dh Changed reference of Under and Over slsp commissions from long to integer
'                   5/7/98 dh Add adjustments (AN) if corporate months.
'                   5/7/98 dh - add Show New/Return flag to grf.ipergenl(2)
'                   3/11/99 dh - Commission Statement - new version
'                   4/5/99 - Create a phoney header when the contrat isnt found when
'                            there isnt a contract reference found
'    6/14/99 Fix projections by package lines (note:  the pkg vehicles must have their
'           sales source, owner , sort code defined)
'   8/26/99 multiple receivables without cntr #, force the fake header
'   2/15/00 Splitting by owner was incorrect due to difference in commission versus participant
'           arrays having different relative starting index. (0 vs 1)
'   4-20-00 dh New commission structure by vehicle & slsp (billed & booked commissions)
'             Add selective contract # to Billed & Booked Commissions
'   8-4-00 Split participants when option by vehicle (by option)
'   4-3-00 when changed to use extended reads for RVF/PHF, the period of retrieval assumed 1 year for
'           for billed and booked but screwed up Sales Comparison
'   4-5-01 Obtain vehicle participants revenue share for net-net option
'       2-11-05 Chg array of PHF/RVF array from integer to long (prevent overflow)
'    4-25-05 corporate reporting didnt show the adjustments for NTR
'   5-26-06 option to include politicals only
'   9-21-06 if T-net, always go thru the receivables to pick up merchandising $.  Previously never picked
'           up merch $
'   10-2-06 option to incl/excl politicals
'       12-14-06 add parm to gObtainRvfPhf to test on tran date (vs entry date)
'   02-15-07 implement calendar reporting
'   09-04-07 Implement major and minor sorting in Sales Comparison
'   10-1-07 Implement Billed and Booked Comparisons - has budget information comparisons against B & B
'
'   GRF fields:
'   grfgenDate - generation date
'   grfGenTime - generation time
'   grfChfCode - contract code
'   grfDateGenl - Date billed or paid
'   grfVefCode - vehicle code (airing or billing)
'   grfAdfCode = advertiser code
'   grfSlfCode = salesperson code
'   grfSofCode = Sales Source
'   grfCode2 - Sales Comparison (major or prim sort selection):  business category or production code or agency code or vehicle group
'   grfCode4 - Sales Commission
'   grfYear - split salesperson/owner flag
'   grfDateType = C = cash, T = trade
'   grfDollars(1-12) 12 months $
'   grfDollars(13) total year $ (gross or net)
'   grsDollars(14-17) Q1 - Q4 $
'   grfDollars(18) - year total $ always net
'   grfPerGenl(1) - 0 = no comparisons , 1 = base date, 2 = comparison date, 3 = last year actual for pacing sales comparison
'   grfPerGenl(2) - new/return flag
'   GrfPerGenl(3) - Minor vehicle group
'   GrfPerGenl(4) - major vehicle group
'   grfPerGenl(5) - Flag for sorting (Net/Net Billed & Booked) 1 = gross, 2 = net, 3= comm
'   grfPerGenl(7) -Participant % (no longer used since the calculation must be done in prepass, not in .rpt
'   grfPerGenl(8) - # periods
'   grfPerGenl(9)-  Is it hard cost (true/false) 3-22-05
'   grfPerGenl(10) - 4-20-05 subsort field for B & B Recap:  1 = airtime, 2 = NTR , 3 = hard cost NTR
'   grfPerGenl(10) - 11-06-06 changed to:  0 = not NTR or Hard cost, > 0 = MNF item code for NTR
'                   if NTR, flag in NTR indicates if agy sales, direct sales or NTR sales.  If
'                   agy or direct sales, embed them in those categories and not with NTR.
'   grfPerGenl(11) - B & B recap 11-06-06 0 = direct, 1 = airtime, 2 = NTR, 3 = political, 4 = Hard cost
'                   Sales comparison will use political flag = 4 to keep separate from other revenue
'                   B & B Comparison will use political flag = 4 to keep separate from other revenue
'   grfPerGenl(12) - Sales Comparison (minor or subsort selection):  business category or production code or agency code or vehicle group
'   grfPerGenl(13) - For B & B Comparison:  0 = revenue from rvf/phf & contracts, 1 = budget data
'   grfPerGenl(14) - Budget mnfcode selected for BOB Comparisons
'   grfPerGenl(18) - # periods to print
'
'Sales Comparison selection:
'   (imPrimSort) cbcSet1 Index: 0 = Advt, 1 = Agy, 2 = Bus Cat, 3 = Prod Prot, 4 = Slsp, 5 = VEhicle, 6 = Vehicle group
'   (imSubSort) cbcSet2 Index:  0 = none, 1 = Advt, 2 = Agy, 3 = Bus Cat, 4 = Prod Prot, 5 = Slsp, 6 = VEhicle, 7 = Vehicle group
'   lbcSelection(1)= agency,  lbcSelection(2) = Slsp, lbcSelection(3) = Bus Cat, lbcSelection(12) = Vehicle group (single select), (3-18-16:  lbcselection(4) changed to lbcselection(12) )
'   lbcSelection(5) = Advt, lbcSelection(6) = vehicle, lbcSelection(7) = prod protection
'*****************************************************************************************
Sub gCRBOB_PastCT(llStdStartDates() As Long, llLastBilled As Long, ilLastBilledInx As Integer, ilHowManyPer As Integer, ilDateFlag As Integer, tlBillCycle As BILLCYCLE)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  ilCurrentRecd                 slNameCode                    ilFound                   *
    '*  slAmount                      slDollar                      slPct                     *
    '*  ilLoopSlsp                    ilSearchSlf                   llAcquisitionCost         *
    '*  llTempStart                   llTempEnd                     ilLoopOnVG                *
    '*                                                                                        *
    '******************************************************************************************
    Dim ilRet As Integer
    Dim illoop  As Integer
    Dim slCode As String
    Dim slStr As String
    Dim llAmt As Long
    Dim ilMonthNo As Integer
    Dim llDate As Long
    Dim ilTemp As Integer
    Dim ilFoundMonth As Integer
    Dim llGrossDollar As Long
    Dim llTransGross As Long                'for participant splits, orig.  gross amt of trans.
    Dim llNetDollar As Long
    Dim llCommDollar As Long                   '3/11/99 for new comm rept  (comm amt for slsp)
    Dim llTransNet As Long                  'for participants splits, orig net amt of trans.
    Dim ilFoundOne As Integer
    Dim ilFoundOption As Integer
    Dim ilMatchCntr As Integer              'selectivity on holds, & contr types (remnants, PIs, etc)
    Dim ilHowMany As Integer                'times to loop - up to 10 records created per trans if by slsp with splits,
                                            'or just 1 per transaction if vehicle or advt option
    Dim ilMatchSSCode As Integer            'Sales source to process
    Dim ilHowManyDefined As Integer         '# of percentages (slsp for each contract, or participants for each vehicle)
    Dim llProcessPct As Long                '% of slsp split or vehicle owner split (else 100%)
    Dim slCommPct As String
    Dim ilNewCode As Integer                '"New" mnf code to flag the contract detail
    Dim ilmaxTypes As Integer               '# of records to create for Billed & booked vs Slsp comm rept
                                            'For Billed &booked:  1 for gross, 2 for net)
                                            '1 if comm rept and the trans is a merch or promotion, 3 if cash or trade transaction for comm rept)
    Dim ilMinTypes As Integer               'set to 1,2,or 3: For Billed &booked:  1 for gross, 2 for net
                                            'for slsp comm:  1 if its a cash or trade trans, 3 if its a merch or promo trans.  Only create
                                            'the comm , dont affect gross or net values
    Dim ilTypes As Integer
    Dim ilReverseFlag As Integer            'reverse sign of amount before updating record
    Dim ilLoopType As Integer
    Dim llLoopType As Long                  '7-29-09
    Dim ilFoundType As Integer
    Dim tlTranType As TRANTYPES
    Dim ilUsePkg As Integer
    Dim ilRelativeIndex As Integer          'relative index for slsp% split or participant split
    ReDim tlRvf(0 To 0) As RVF
    ReDim tlMnf(0 To 0) As MNF
    Dim ilSlfRecd As Integer                    '4-20-00
    ReDim tlSlf(0 To 0) As SLF                  '4-20-00
    Dim ilMnfSubCo As Integer
    Dim ilUseSlsComm As Integer                '4-20-00 true if using slsp comm shares for commission reports,
                        'else false for all other reports to use revenue share
    Dim ilLoopRecv As Integer                   '9-16-01

    Dim ilListIndex As Integer                    '9-25-01
    Dim ilMatchSOFCode As Integer
    Dim ilStd As Integer                        'true if std, else false for corporate or calendar
    Dim ilValidTran As Integer                  'valid trans for test of  NTR or AirTime
    Dim ilTempPeriods As Integer                'process # of periods based on user entered, or last period invoiced index, whichever is less
                                                'for example, last period invoiced index is 6 (June) but user requests 3 periods to process.
    Dim llTempStdStartDates(0 To 13) As Long    'monthly std dates for Sales Comparison. Index zero ignored
    Dim ilOKtoSeeVeh As Integer                 '11-13-03 flag to determine if user allowed to see vehicle
    Dim llRvfLoop As Long                       '2-11-05
    Dim ilIsItHardCost As Integer
    ReDim ilProdPct(0 To 1) As Integer            '5-1-07  Participant share
    ReDim ilMnfGroup(0 To 1) As Integer           '5-1-07  Participants
    ReDim ilMnfSSCode(0 To 1) As Integer          '5-1-07  Particpant sales source
    Dim ilSaveLastBilledInx As Integer
    Dim llDateAdjust As Long                        '1-08-08  adjustment for end of last bill date when other than std requested.
                                                    'i.e. last bill date = 11/25/07.  request corp which month of Nov ends 12/2/07.
                                                    'when its detected that the corp end date extends past the last billed date,
                                                    'its assumed that corp nov is in the future and stops.
    Dim slLastBilledDate As String              '1-08-08
    Dim slTemp As String
    Dim ilWhichDate As Integer       '8-4-08 if pacing, use date entered for AN; otherwise use trans date from RVF/PHF
    Dim llPacingDate As Long
    Dim ilIncludeVehicleGroup As Integer    '11-21-08
    Dim llContrCode As Long                 '8-19-09
    Dim llOHDDate As Long                   '8-19-09
    Dim llTransEnteredDate As Long          '8-19-09
    Dim ilPrevVefCode As Integer            'maintain previous month (using ilLoopRecv) & vehicle processed to avoid getting acq info again (if imAdjustAcquisition is true)
    Dim blAcqOK As Boolean
    ReDim llBillCycleTempStartDates(0 To 13) As Long        '1-13-21
    Dim ilTempLastBilledInx As Integer              '1-14-21
    Dim llTempLastBilled As Long                    '1-14-21
    Dim ilDoe As Integer
    
    ilListIndex = RptSelCt!lbcRptType.ListIndex
    ilSaveLastBilledInx = ilLastBilledInx
    slLastBilledDate = Format$(llLastBilled, "m/d/yy")   '1-08-08
    
    If Not tlBillCycle.blBillCycle Then             '1-14-21 not getting receivables by billing method.  There is an extra set of dates that contain the cal dates if by bill cycle
                                                    'when those dates are not used, make them the same as the std set, for use of common code
        For illoop = 0 To 13
            tlBillCycle.lBillCycleStartDates(illoop) = llStdStartDates(illoop)
        Next illoop
        'set the remaining fields with a default
        tlBillCycle.iBillCycleLastBilledInx = ilLastBilledInx
        tlBillCycle.lBillCycleLastBilled = llLastBilled
    End If
    
    llPacingDate = 0
    slStr = RptSelCt!edcText.Text           'pacing date
    If Trim$(slStr) <> "" Then
        llPacingDate = gDateValue(slStr)
        If llPacingDate > gDateValue(slLastBilledDate) Then         '10-19-15 use last billed date or pacing date entered, whichever is earlier for AN transactions
            llPacingDate = gDateValue(slLastBilledDate)
        End If
    End If

    'Get the revenue sets and find "New" code
    sgDemoMnfStamp = ""             'insure that the revenue sets are read
    ilRet = gObtainMnfForType("R", sgDemoMnfStamp, tlMnf())
    ilNewCode = 0
    For illoop = LBound(tlMnf) To UBound(tlMnf) - 1 Step 1
        tmMnf = tlMnf(illoop)
        If Trim$(tmMnf.sName) = "New" Then
            ilNewCode = tmMnf.iCode
            Exit For
        End If
    Next illoop
    
    'setup vehicle group sets
    imMajorSet = 0
    '8-6-10 need to get any vehicle group selection if the user requested vehicle w/split slsp subtotals
    'and we are swapping the option internally to get the splits properly
    If (imVehicle And ilListIndex <> CNT_SALESCOMPARE) Or (igSwapBOBOption) Then        '4-25-06 Sales comparison doesnt have vehicle groupings
        illoop = RptSelCt!cbcSet1.ListIndex
        imMajorSet = tgVehicleSets1(illoop).iCode
    ElseIf ilListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB Then
        imMajorSet = 0
        imMinorSet = 0
        If RptSelCt!cbcSet1.ListIndex = 6 Then
            'ilLoop = RptSelCt!lbcSelection(4).ListIndex
            illoop = RptSelCt!lbcSelection(12).ListIndex            '3-18-16 chged to single selection box
            imMajorSet = tgVehicleSets1(illoop).iCode
        End If

        If RptSelCt!cbcSet2.ListIndex = 7 Then
            'ilLoop = RptSelCt!lbcSelection(4).ListIndex
            illoop = RptSelCt!lbcSelection(12).ListIndex            '3-18-16 chged to single selection box
            imMinorSet = tgVehicleSets1(illoop).iCode
        End If
    ElseIf ilListIndex = CNT_BOBCOMPARE And igRptCallType = CONTRACTSJOB Then
        illoop = RptSelCt!cbcSet1.ListIndex
        imMajorSet = tgVehicleSets1(illoop).iCode
    End If
    
    'build array of selling office codes and their sales sources.  This is the most major sort
    'in the Business Booked reports
    ilTemp = 0
    ilRet = btrGetFirst(hmSof, tmSof, imSofRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
    Do While ilRet = BTRV_ERR_NONE
        ReDim Preserve tlSofList(0 To ilTemp) As SOFLIST
        tlSofList(ilTemp).iSofCode = tmSof.iCode
        tlSofList(ilTemp).iMnfSSCode = tmSof.iMnfSSCode
        ilRet = btrGetNext(hmSof, tmSof, imSofRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        ilTemp = ilTemp + 1
    Loop

   '4-20-00 Prepare for the different slsp commissions by vehicle if applicable
    hmScf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmScf, "", sgDBPath & "Scf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        If tgSpf.sSubCompany = "Y" Then         'using commission by vehicle (sub-company)?
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            ilRet = MsgBox("SCF Error # " & str$(ilRet), vbOKOnly + vbExclamation, "gCrBob_PastCT")
            ilRet = btrClose(hmScf)
            btrDestroy hmScf
            btrDestroy hmVef
            btrDestroy hmCHF
            btrDestroy hmSlf
            btrDestroy hmRvf
            btrDestroy hmGrf
            Exit Sub
        End If
    End If
    imScfRecLen = Len(tmScf)
    ReDim tlScf(0 To 0) As SCF      '4-20-00
    ReDim tlSlfIndex(0 To 0) As SLFINDEX    '4-20-00
    ilRet = gObtainVef()                  '4-2-00 buildglobal vehicle table
    If ilRet = 0 Then
        btrDestroy hmScf
        btrDestroy hmVef
        btrDestroy hmCHF
        btrDestroy hmSlf
        btrDestroy hmRvf
        btrDestroy hmGrf
        btrDestroy hmVef
        Exit Sub
    End If
    ilRet = gObtainSlf(RptSelCt, hmSlf, tlSlf())

    'build array of vehicles to include or exclude
    gObtainCodesForMultipleLists 6, tgCSVNameCode(), imInclVefCodes, imUsevefcodes(), RptSelCt
    gAddDormantVefToExclList imInclVefCodes, tgMVef(), imUsevefcodes()          '8-4-17 if excluding vehicles, make sure dormant ones exluded since
                                                                                'they wont be in original list
    'get the Advt codes selected
    gObtainCodesForMultipleLists 5, tgAdvertiser(), imInclAdfCodes, imUseAdfCodes(), RptSelCt
    'get the Advt codes selected
    gObtainCodesForMultipleLists 1, tgAgency(), imInclAgfCodes, imUseAgfCodes(), RptSelCt
    
    'Sales comparison and B & B Comparison reports have additional selectivity and need to retrieve the selections
    If (ilListIndex = CNT_SALESCOMPARE Or ilListIndex = CNT_BOBCOMPARE) And igRptCallType = CONTRACTSJOB Then
        'get the bus cat codes selected
        gObtainCodesForMultipleLists 3, tgMNFCodeRpt(), imInclCatCodes, imUseCatCodes(), RptSelCt
        'get the prod prot codes selected
        gObtainCodesForMultipleLists 7, tgMnfCodeCT(), imInclProdCodes, imUseProdCodes(), RptSelCt
    End If

    ilUseSlsComm = False        'assume not a Commission report (and use revenue shares for splits on slsp options)
    If tgSpf.sSubCompany = "Y" Then         'using commission by vehicle (sub-company)?
        '4-20-00 Build  slsp commission table
        ilRet = gObtainScf(RptSelCt, hmScf, tlScf(), llStdStartDates(1), llStdStartDates(13), tlSlfIndex())
    End If

    ilUsePkg = False
    'default all other options that are not asked for the Sales Placement report
    ilStd = True                                'Assume std reporting (vs corporate)
    If ilListIndex = CNT_SALESPLACEMENT Then        '8-8-02 this report has different field input that the Billed & booked
        'Sales placement does not have option for corporate reporting
        'igPeriods = Val(RptSelCt!edcText.Text)     '7-7-14 igPeriods set in validation subroutines
        illoop = RptSelCt!cbcSet1.ListIndex
        imMajorSet = gFindVehGroupInx(illoop, tgVehicleSets1())

    Else                            'report other than Sales Placement
        If RptSelCt!rbcSelC9(0).Value Or RptSelCt!rbcSelC9(2).Value Or RptSelCt!rbcSelC9(3).Value Then      'corp or calendar (lines), or cal (spots) option?
            ilStd = False                       'corporate selected
        End If
        If RptSelCt!rbcSelCSelect(0).Value Then     'use pkg, not hidden
            ilUsePkg = True
        End If

        If (ilListIndex = CNT_BOB Or ilListIndex = CNT_BOBRECAP Or ilListIndex = CNT_BOBCOMPARE Or ilListIndex = CNT_SALESCOMPARE) And (igRptCallType = CONTRACTSJOB) Then
            tmGrf.iPerGenl(7) = igPeriods                   '3-4-02 show # periods requestd on report
            If igPeriods < 1 Or igPeriods > 12 Then
                igPeriods = 12              'if errors in input, get normal report of 12 months
            End If
        Else
            igPeriods = 12
        End If
    End If

    ilWhichDate = 0          'assume no pacing, use trandate to retieve IN/ANs
    tlTranType.iAdj = True              'look only for adjustments in the History & Rec files
    If (ilListIndex = CNT_BOB Or ilListIndex = CNT_SALESCOMPARE) And (igRptCallType = CONTRACTSJOB) Then
        If RptSelCt!ckcInclRevAdj.Value = vbUnchecked Then
            tlTranType.iAdj = False
        End If
    End If
    
    '9/25/20 - TTP 9952 - show Adj on CNT_SALESCOMPARE
'    If (ilListIndex = CNT_SALESCOMPARE) Then
'        If RptSelCt!ckcInclRevAdj.Value = vbUnchecked Then
'            tlTranType.iAdj = False
'        End If
'    End If
    
    tlTranType.iInv = False
    tlTranType.iWriteOff = False
    tlTranType.iPymt = False
    tlTranType.iCash = True
    tlTranType.iTrade = False
    tlTranType.iMerch = False
    tlTranType.iPromo = False
    tlTranType.iNTR = False         '9-17-02
    If imNTR Or imHardCost Then                   '4-25-05 need to gather the NTR for adjustments too
        tlTranType.iNTR = True
    End If

    If imAdjustAcquisition Then         'subtr out acquisition $ and merch/promo
        tlTranType.iMerch = True
        tlTranType.iPromo = True
        tlTranType.iInv = True          'only for the Merch and Promo
        tlTranType.iTrade = True        '9-5-08 test for trades for t-net option
        If Not imTrade Then
            tlTranType.iTrade = False
        End If
    End If

    llDateAdjust = 0                                '1-08-08
    If imAdjustAcquisition Then                     'some sort of net-net or triple net option that requires Merchand $ and acquisition cost to be subtracted?
        ilTempPeriods = igPeriods
        If (Not ilStd) And (Not tlBillCycle.blBillCycle) Then       'Cal by contract or cal by spots selected. 1-14-21: and Its not by Billing cycle
            'corp or calendar by contr or spots need to take all adjustments.
            ilSaveLastBilledInx = 12             'take all adjustments for corporate
            '1-08-08 determine what the end date of the last bill month should be for the type of period requested (i.e. corp vs cal)
            'i.e. Last bill date is always a std bdcst date.  if running report by corp or cal, create an adjustment for the
            '# of days beyond the std bdcst end date of the last month billed
            If RptSelCt!rbcSelC9(0).Value Then          'corp
                'get the end date of last billed dates corp month
                slTemp = gObtainEndCorp(slLastBilledDate, False)
                llDateAdjust = gDateValue(slTemp) - llLastBilled
            Else                                        'cal by line or cal by spots
                'get the end date of last billed dates cal month
                slTemp = gObtainEndCal(slLastBilledDate)
                llDateAdjust = gDateValue(slTemp) - llLastBilled
            End If
            If RptSelCt!edcText.Text <> "" Then         'if pacing date entered, pick up transactions using date entered, not the tran date
                ilWhichDate = 1
            End If
        End If
    Else
        If (ilStd) Or (tlBillCycle.blBillCycle) Then        '1-14-21 by std or bill cycle, need to get invoices and adjustments
            If RptSelCt!edcText.Text = "" Or (ilListIndex = CNT_SALESPLACEMENT And igRptCallType = CONTRACTSJOB) Then          'no pacing date entered
                tlTranType.iInv = True
                tlTranType.iTrade = True
                tlTranType.iAirTime = True
                If Not imTrade Then
                    tlTranType.iTrade = False
                End If
                ilTempPeriods = ilLastBilledInx                   'month # last invoiced

                If igPeriods < ilTempPeriods Then               'process # of months, whichever is least (last month invoiced or # periods requested)
                    ilTempPeriods = igPeriods
                End If
            Else                                        'pacing, fake out and get the AN only
                ilTempPeriods = igPeriods
                ilSaveLastBilledInx = 12
                ilWhichDate = 1              'pick up transactions using date entered, not the trandate for pacing
            End If
        Else                            'corporate, get adjustments only
            ilTempPeriods = igPeriods
            ilSaveLastBilledInx = 12             'take all adjustments for corporate
            '1-08-08 determine what the end date of the last bill month should be for the type of period requested (i.e. corp vs cal)
            'i.e. Last bill date is always a std bdcst date.  if running report by corp or cal, create an adjustment for the
            '# of days beyond the std bdcst end date of the last month billed
            If RptSelCt!rbcSelC9(0).Value Then          'corp
                'get the end date of last billed dates corp month
                slTemp = gObtainEndCorp(slLastBilledDate, False)
                llDateAdjust = gDateValue(slTemp) - llLastBilled
            Else                                        'cal by line or cal by spots
                'get the end date of last billed dates cal month
                slTemp = gObtainEndCal(slLastBilledDate)
                llDateAdjust = gDateValue(slTemp) - llLastBilled
            End If
            If RptSelCt!edcText.Text <> "" Then         'if pacing date entered, pick up transactions using date entered, not the tran date
                ilWhichDate = 1
            End If
        End If
    End If

    If igRptCallType = SLSPCOMMSJOB Then        'B & B commissions option
        ilmaxTypes = 3              'create 3 records for slsp comm rpt (1 = gross, 2 = net, 3 = comm records)
        If tgSpf.sSubCompany = "Y" Then '7-14-00
            ilUseSlsComm = True         '4-20-00 use the slsp commision fields for deciding slsp share
        End If
    Else
        'billed & booked option
        If smGrossOrNet = "G" Then
            ilmaxTypes = 1          'gross only
        ElseIf smGrossOrNet = "N" Or smGrossOrNet = "T" Then   '6-9-06
            ilmaxTypes = 2          '11-17-06 net only, changed from 2 to 1
        Else                        'some form of B & B (Sales Placement, B & B recap, etc)
            'ilmaxTypes = 2          '2-26-01 net-net option (vehicle option)
            ilmaxTypes = 3
        End If
    End If
    ReDim tlGrf1(0 To 0) As GRF      'build array of records by contract/advt & type  (to avoid excess records from receivables)
                                      'type 1 = Gross, type 2 = net, type 3 = commission
    ReDim tlGrf2(0 To 0) As GRF
    ReDim tlGrf3(0 To 0) As GRF

    'Standard Broadcast option
    'corporate option
    If (ilListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB) Then
        'Sales Comparison uses 1 set of spanned dates (i.e. when requesting jan thru sept, rather than sending an array of 10 start dates, only 2 are required since
        'the data is combined together as 1 value to output.  But in gathering the receivables/history, it is gathered 1 month at a time.
        'Create an array of # of start months, as they are gathered one month at a time.
        ilTempPeriods = 0
        llDate = llStdStartDates(1)
        slStr = Format$(llDate, "m/d/yy")
        Do While llStdStartDates(2) >= llDate
            ilTempPeriods = ilTempPeriods + 1
            llTempStdStartDates(ilTempPeriods) = gDateValue(slStr)
            slStr = gObtainEndStd(slStr)
            llDate = gDateValue(slStr) + 1                      'increment for next month
            slStr = Format$(llDate, "m/d/yy")
        Loop

        ilTempPeriods = ilTempPeriods - 1
        'temp periods = the # months to process

        If ilHowManyPer = 2 And imAdjustAcquisition Then               'past and future data to process, if adjusting merch/acquisition costs, need to
                                            'to get those future transactions
            ilTempPeriods = ilTempPeriods + 1
            Do While llDate <= llStdStartDates(3)
                ilTempPeriods = ilTempPeriods + 1
                llTempStdStartDates(ilTempPeriods) = gDateValue(slStr)
                slStr = gObtainEndStd(slStr)
                llDate = gDateValue(slStr) + 1                      'increment for next month
                slStr = Format$(llDate, "m/d/yy")
            Loop
            ilTempPeriods = ilTempPeriods - 1
        End If
    Else            'all versions except Sales Compare
        For illoop = 1 To 13
        '    1-14-21  If requesting Bill cycle method,need to gather trans for the entire cal month vs just the std month dates.  Use the 2nd set of dates passed which
        '   has been set up with calendar dates.  If not bill cycle method, the 1st set of dates have been copied into the calendar set of dates
            llTempStdStartDates(illoop) = tlBillCycle.lBillCycleStartDates(illoop)
        Next illoop
    End If
    For ilLoopRecv = 1 To ilTempPeriods       'loop for as many months that have been billed.  When RVF and PHF accessed separately, exceeded
                                              '32000 (prior to VB6)
        If (((llTempStdStartDates(ilLoopRecv + 1) - 1) > tlBillCycle.lBillCycleLastBilled + llDateAdjust) And llPacingDate = 0) And (Not tlBillCycle.blBillCycle) Then     '1-08-08; 8-4-08 if pacing, still need adjustments so dont turn AN off
            'must be doing adjusting acquisitions
            '8-10-10 Acquisitions (or t-net) need to get merch/promotions in the future to back them out, but still need to ignore other billed transactions such as NTR, hardcost,
            'and any other invoices that may have been created before setting last date invoiced
            tlTranType.iAdj = False              'ignore AN for tran dates in the future
            tlTranType.iNTR = False
            tlTranType.iHardCost = False
            '8-2-14 if invoices have been generated and the last invoice date hasnt been set (i.e. rep invoices not completed), need to ignore the current month invoiced
            tlTranType.iCash = False
            tlTranType.iTrade = False
        End If

        slStr = Format$(llTempStdStartDates(ilLoopRecv), "m/d/yy")           'get the start date of month to process
        slCode = Format$(llTempStdStartDates(ilLoopRecv + 1) - 1, "m/d/yy")  'get the end date of the month to process
        If llPacingDate > 0 Then                'pacing, dont get ANs past the user entered pacing date
            If Not imAdjustAcquisition Then         '8-18-09, For pacing and TNet, do not test the dates here. need to continue so that
                                                    'merchandising is retrieved
                'never get ANs past the user effective pacing date
                If llPacingDate < llTempStdStartDates(ilLoopRecv) Then       'pacing date is prior to the months start date, done with the AN pass
                    Exit For
                ElseIf llPacingDate >= llTempStdStartDates(ilLoopRecv) And llPacingDate < llTempStdStartDates(ilLoopRecv + 1) Then
                    'pacing date falls within this month, make sure the end date isnt beyond the users entered pacing date
                    slCode = Format$(llPacingDate, "m/d/yy")
                'else just use the start & end dates of the month processing to find the ANs
                End If
            End If
        End If

        ReDim tlRvf(0 To 0) As RVF

        lgSTime1 = timeGetTime
        ilRet = gObtainPhfRvf(RptSelCt, slStr, slCode, tlTranType, tlRvf(), ilWhichDate)
        If ilRet = 0 Then
            Exit Sub
        End If
        lgETime1 = timeGetTime
        lgTtlTime1 = lgTtlTime1 + (lgETime1 - lgSTime1)         'total time in retrieving past
        
        lgSTime2 = timeGetTime
        Debug.Print "gCRBOB_PastCT - " & UBound(tlRvf) & " recs"
        For llRvfLoop = LBound(tlRvf) To UBound(tlRvf) - 1 Step 1
            ilDoe = ilDoe + 1
            If ilDoe > 30000 Then
                ilDoe = 0
                DoEvents
            End If
            tmRvf = tlRvf(llRvfLoop)

            ilValidTran = mBOBNTRTestRVF(tlMMnf(), ilIsItHardCost)
            
            'TTP 10955 - Billed and Booked Cal Spots: slowness reported, possibly due to including digital lines
            If RptSelCt!ckcSelC3(10).Value = vbUnchecked And tmRvf.lPcfCode > 0 Then
                ilValidTran = False
            End If
            
            'gPDNToLong tmRvf.sNet, llAmt
            llAmt = mBOBWhichAmtToLong(tmRvf.sNet)            'use receivables gross/net or acquisition cost
            If tgSpf.sSEnterAgeDate = "E" Then      'use entered date or ageing date
                gUnpackDate tmRvf.iTranDate(0), tmRvf.iTranDate(1), slStr
            Else
                slCode = Trim$(str$(tmRvf.iAgePeriod) & "/15/" & Trim$(str$(tmRvf.iAgingYear)))
                slStr = gObtainEndStd(slCode)
            End If
            llDate = gDateValue(slStr)                  'convert trans date to test if within requested limits
            'valid record must be an "Invoice", History Invoices, or Adjustment types, non-zero amount, and transaction date within the start date of the
            'cal year and end date of the current cal month requested
            'Merchandising and Promotions contracts for net-net options to be subtracted from the net amounts
            '11-25-02 Addl test to see if airtime or NTR should be included
            '9-21-06 if T-net, and you have changed the last billed date to the future (for testing purposes), the receivables entry that
            'was generated for the months billing will be included.
            '10-4-07 rvftype must be blank (regular revenue) or "A" (installment revenue)

            '1-5-15 with tnet option, and spot rate $0, need to include the transaction for processing
            '6-5-19 fix inclusion of zero $ if selected
            If (Left$(tmRvf.sTranType, 1) = "I" Or tmRvf.sTranType = "HI" Or Left$(tmRvf.sTranType, 1) = "A") And (Trim$(tmRvf.sType) = "" Or tmRvf.sType = "A") And ((llAmt <> 0) Or ((llAmt = 0) And (imAdjustAcquisition = True Or imInclZero))) And (llDate >= llStdStartDates(1)) And (ilValidTran) Then            'looking for Invoice types only
                'get contract from history or rec file
                tmChfSrchKey1.lCntrNo = tmRvf.lCntrNo
                tmChfSrchKey1.iCntRevNo = 32000
                tmChfSrchKey1.iPropVer = 32000
                ilRet = btrGetGreaterOrEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE) 'get matching contr recd

                '9-19-06 when there is no sch lines and need to process merchandising for t-net, the contract may not be scheduled (schstatus = "N");  need to process those contracts
                Do While (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tmRvf.lCntrNo) And (tmChf.sSchStatus <> "F" And tmChf.sSchStatus <> "M" And tmChf.sSchStatus <> "N")
                     ilRet = btrGetNext(hmCHF, tmChf, imCHFRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop

                '4-20-00 mFakeChf                                'if contract headr not found, setup fake header
                gFakeChf tmRvf, tmChf

                ilMatchCntr = mBobTestTypes()           'test contract types against user requested types to include
                
                '1-14-21 test if running by bill cycle: is the transaction within the proper bill cycle?  ie.  if contract std, its month is different than a bill cycle defined as calendar
                'Case:  generating month of dec 2020.  Std month is 11/30/20 - 12/27/20; cal is 12/1/20- 12/31/20.  Exclude any std transactions that are between 12/28/20 and 12/31/20; include them
                'if bill cycle defined as calendar
                If tlBillCycle.blBillCycle Then
                    If tmChf.sBillCycle = "S" Then              'standard bill contract
                        'the date cannot be beyond the end of the std date for the month processing
                        If llDate < llStdStartDates(ilLoopRecv) Or llDate >= llStdStartDates(ilLoopRecv + 1) Then      'out month of std dates
                            ilMatchCntr = False
                        End If
                    Else                    'this contract ha been billed by calendar
                       If llDate < llTempStdStartDates(ilLoopRecv) Or llDate >= llTempStdStartDates(ilLoopRecv + 1) Then      'within month of cal  dates
                            ilMatchCntr = False
                        End If
                    End If
                End If

                '8-7-09 All categories is printed when selecting as minor sort even tho not selected
                'if major is has all selected, no further testing on categories
                'if minor is competitive or business categories, need to test its selectivity
                If (ilMatchCntr And Not RptSelCt!ckcAll.Value = vbChecked) Or (ilMatchCntr And (imSubSort = 4 Or imSubSort = 3)) Then  'passed all filters so far and selecting all entries?
                    ilMatchCntr = mBobTestCatProt()             'ilmatchcntr may be altered if not correct cat or prod protect code
                End If

                '4-20-00   Contract # selectivity
                If lmSingleCntr > 0 And (lmSingleCntr <> tmRvf.lCntrNo) Then
                    ilMatchCntr = False
                End If

                '12-6-06 changed to see if user allowed to see contract
                ilOKtoSeeVeh = gCntrOkForUser(hmVsf, tgUrf(0).iSlfCode, tmChf.lVefCode, tmChf.iSlfCode())
                'ilOKtoSeeVeh = gUserAllowedVehicle(tmRvf.iBillVefCode)      '11-13-03 determine if user allowed to see this vehicle

                'if passed all filters, special testing for Sales Commissions to see if its
                'merchandising or promotions.  These need to be included and deducted from
                'commission calc.  (3/15/99)

                If igRptCallType = SLSPCOMMSJOB Then
                    'get all merchandising and promotions transactions (for normal billed & booked the only trans.
                    'used are prior to the last billing date)
                    If llDate >= llStdStartDates(13) Then        'test for outside of requested period to report, and include merch/promo, cash & trades for now
                        ilMatchCntr = False
                    End If
                Else
                    If Not imAdjustAcquisition Then         'if not Adjustment acquisitions, if its a future transaction and not cash or trade, ignore it
                        'If llDate < llStdStartDates(ilSaveLastBilledInx + 1) And (tmRvf.sCashTrade = "C" Or tmRvf.sCashTrade = "T") Then
                        If llDate < llTempStdStartDates(ilTempPeriods + 1) And (tmRvf.sCashTrade = "C" Or tmRvf.sCashTrade = "T") Then  '3-17-16 use the # of periods processing against the date array
                            'this is an "INvoice" transaction whose trans date is greater than the reqeusted start date.
                            'It got a non-zero amount and is only cash or trade.
                        Else
                            ilMatchCntr = False
                        End If
                    End If
                End If

                'find the sales source and office;
'               'obtain vehicle group if applicable, see if sales source is the selected
                ilFoundOption = mBOBSSCodeRVFSelect(tlSlf(), tlSofList(), ilMatchSSCode, ilMatchSOFCode, ilUsePkg)

                'error return not tested because a phoney record is created if contr not found
                If ilMatchCntr And ilFoundOption And ilOKtoSeeVeh Then       '11-13-03

                    mBOBFormatGrfFromRVF ilUsePkg, ilIsItHardCost           'format basic fields of prepass record

                    'if the transaction has a purge date, its definitely in history.
                    'if the transaction doesnt have a purge date, if its a trade and site doesnt use trades, it goes directly
                    'into history
                    If (tmRvf.iPurgeDate(0) <> 0) Or (tmRvf.sCashTrade = "T" And tgSpf.sRUseTrade = "N") Then
                        tmGrf.sBktType = "H"                    'let crystal know these records are histroy/receivables (vs contracts)
                    Else
                        tmGrf.sBktType = "R"
                    End If
                    'determine the month that this transaction falls within
                    ilFoundMonth = False
                    
                    '1-14-21 If running by bill cycle method, need to use the proper set of dates and associated last billed information
                    If tlBillCycle.blBillCycle Then             'if bill cycle method, need to use the calendar dates
                        'determine which dates to use based on the contract bill cycle
                        If tmChf.sBillCycle = "S" Then
                            For illoop = 0 To 13
                                llBillCycleTempStartDates(illoop) = llTempStdStartDates(illoop)
                            Next illoop
                            llTempLastBilled = llLastBilled
                            ilTempLastBilledInx = ilSaveLastBilledInx
                        Else
                            For illoop = 0 To 13
                                llBillCycleTempStartDates(illoop) = tlBillCycle.lBillCycleStartDates(illoop)
                            Next illoop
                            llTempLastBilled = tlBillCycle.lBillCycleLastBilled
                            ilTempLastBilledInx = tlBillCycle.iBillCycleLastBilledInx
                        End If
                    Else
                        If ilListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB Then
                            For illoop = 0 To 13
                                llBillCycleTempStartDates(illoop) = tlBillCycle.lBillCycleStartDates(illoop)
                            Next illoop
                            llTempLastBilled = llLastBilled
                            ilTempLastBilledInx = ilSaveLastBilledInx
                        Else
                            For illoop = 0 To 13
                                llBillCycleTempStartDates(illoop) = llTempStdStartDates(illoop)
                            Next illoop
                            llTempLastBilled = llLastBilled
                            ilTempLastBilledInx = ilSaveLastBilledInx
                        End If
                    End If
                    
                    For ilMonthNo = 1 To ilHowManyPer Step 1         'loop thru months to find the match
'                        If llDate >= llStdStartDates(ilMonthNo) And llDate < llStdStartDates(ilMonthNo + 1) Then
                        '1-14-21 need to use the proper set of std or cal dates.  other date options use whats in std date array
                        If llDate >= llBillCycleTempStartDates(ilMonthNo) And llDate < llBillCycleTempStartDates(ilMonthNo + 1) Then

                            'if this transaction if for a month in the future, ignore the AN (adjustments ) and
                            'only process the Merchandising and Promotions for net-net/triple net options.
                            '
                            If Not imAdjustAcquisition Then     'no acquisition adjustments, just retrieve the AN trans. for cash & trade
                                If ilStd Then                   'for standard option, need the IN and AN
                                    If ((tmRvf.sCashTrade = "C") Or (tmRvf.sCashTrade = "T" And imTrade)) And (tmRvf.sTranType = "AN" Or tmRvf.sTranType = "IN" Or tmRvf.sTranType = "HI") Then     '9-26-06 include HI History for the past
                                        '5-23-14 exclude receivables whose dates are prior to last billed date for pacing
                                        If llPacingDate = 0 Then
                                            ilFoundMonth = True
                                        Else
 '                                           If llDate <= llLastBilled Then            'ok, prior to last billed month
                                             If llDate <= llTempLastBilled Then            '1-14-21 Last billed is either std or cal if billing cycle method
                                                ilFoundMonth = True
                                            End If
                                            'if transaction is beyond last billed date, exclude on pacing
                                        End If
                                    End If
                                Else                            'for corporate, only AN since the revenue is driven by lines
                                    If ((tmRvf.sCashTrade = "C") Or (tmRvf.sCashTrade = "T" And imTrade)) And (tmRvf.sTranType = "AN") Then
                                        ilFoundMonth = True
                                    End If
                                End If
                                Exit For
                            Else                                'adjust acquistion and merch $, and still need the adjustments
                                If llPacingDate = 0 Then        '8-18-09
'                                    If (ilMonthNo <= ilSaveLastBilledInx) Then           'ok, prior to last billed month
                                    If (ilMonthNo <= ilTempLastBilledInx) Then           'ok, prior to last billed month
                                        If ilStd Then               'for std option, need the IN and AN
                                            '8-18-09
                                            If ((tmRvf.sCashTrade = "C" And tlTranType.iCash) Or (tmRvf.sCashTrade = "T" And imTrade) Or (tmRvf.sCashTrade = "M") Or (tmRvf.sCashTrade = "P")) And (tmRvf.sTranType = "AN" Or tmRvf.sTranType = "IN" Or tmRvf.sTranType = "HI") Then     '9-26-06 include HI for the past
                                                ilFoundMonth = True
                                            End If
                                        Else                        'for corporate, only AN since the revenue is driven by lines
                                                                    '6-19-08 adjusting acquisition , if merch/promo need to process
                                            '8-18-09
                                            If ((tmRvf.sCashTrade = "C" And tlTranType.iCash) Or (tmRvf.sCashTrade = "T" And imTrade)) And (tmRvf.sTranType = "AN") Or ((tmRvf.sCashTrade = "M" Or tmRvf.sCashTrade = "P") And (tmRvf.sTranType = "IN" Or tmRvf.sTranType = "AN")) Then
                                                ilFoundMonth = True
                                            End If
                                        End If
                                        Exit For
                                    Else                                        'after last billed month, ok to use if Merch/promo
                                        If (tmRvf.sCashTrade = "M" Or tmRvf.sCashTrade = "P") And (tmRvf.sTranType = "AN" Or tmRvf.sTranType = "IN" Or tmRvf.sTranType = "HI") Then
                                            ilFoundMonth = True
                                        End If
                                        Exit For
                                    End If
                                Else                    'pacing report with acquisitions
                                    'if merchandising or Promotions, ok to use to adjust out
                                    If (tmRvf.sCashTrade = "M" Or tmRvf.sCashTrade = "P") And (tmRvf.sTranType = "AN" Or tmRvf.sTranType = "IN" Or tmRvf.sTranType = "HI") Then
                                        llContrCode = gPaceCntr(tmRvf.lCntrNo, llPacingDate, hmCHF, tmChf)
                                        If llContrCode > 0 Then          'a contract was found
                                            'see if it should be used in the pacing
                                            gUnpackDate tmChf.iOHDDate(0), tmChf.iOHDDate(1), slStr
                                            llOHDDate = gDateValue(slStr)
                                            gUnpackDate tmRvf.iDateEntrd(0), tmRvf.iDateEntrd(1), slStr
                                            llTransEnteredDate = gDateValue(slStr)      'date entered of Merch/promo must be equal/prior to pacing date
                                            If llOHDDate <= llPacingDate And llTransEnteredDate <= llPacingDate Then
                                                ilFoundMonth = True
                                                Exit For
                                            End If
                                        End If
                                    Else            'its not merch/promotions, if AN it must be prior to the pacing date
                                        If (llDate <= llPacingDate) And ((tmRvf.sCashTrade = "C" And tlTranType.iCash) Or (tmRvf.sCashTrade = "T" And imTrade)) And (tmRvf.sTranType = "AN") Then
                                            llContrCode = gPaceCntr(tmRvf.lCntrNo, llPacingDate, hmCHF, tmChf)
                                            If llContrCode > 0 Then          'a contract was found
                                                'see if it should be used in the pacing
                                                gUnpackDate tmChf.iOHDDate(0), tmChf.iOHDDate(1), slStr
                                                llOHDDate = gDateValue(slStr)
                                                gUnpackDate tmRvf.iDateEntrd(0), tmRvf.iDateEntrd(1), slStr
                                                llTransEnteredDate = gDateValue(slStr)  'date entered of adjustment must be equal prior to the pacing date
                                                If llOHDDate <= llPacingDate And llTransEnteredDate <= llPacingDate Then
                                                    ilFoundMonth = True
                                                    Exit For
                                                End If
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    Next ilMonthNo
                    If ilFoundMonth And ilMonthNo <= igPeriods Then '3-2-02
                        If (imAdjustAcquisition) Or (imUseAcquisitionCost) Then                            'varying commissions maybe used, or use acquisition cost only
                            If ilMonthNo <> ilLoopRecv Or tmRvf.iAirVefCode <> ilPrevVefCode Then     'different month and/or vehicle to process, need to get new possible varying commission for acquisition
                                blAcqOK = gGetAcqCommInfoByVehicle(tmRvf.iAirVefCode, imAcqLoInx, imAcqHiInx)
                                imAcqCommPct = gGetEffectiveAcqComm(llDate, imAcqLoInx, imAcqHiInx)     'if varying commissions for acq costs on Insertion order, get the % to be used to calc.
                                slCommPct = gIntToStrDec(imAcqCommPct, 2)
                                ilPrevVefCode = tmRvf.iAirVefCode
                            End If
                        End If

                        llTransGross = mBOBWhichAmtToLong(tmRvf.sGross)            'use receivables gross/net or acquisition cost
                        llTransNet = mBOBWhichAmtToLong(tmRvf.sNet)            'use receivables gross/net or acquisition cost
                        ilReverseFlag = mBobReverseSign(llTransNet, llTransGross)

                        'obtain the sales source for major sort of business booked reports
                        '7-1-14 speed up and use binary search
                        ilRet = gBinarySearchSlf(tmChf.iSlfCode(0))
                        If ilRet = -1 Then          'not found
                            tmSlf.iRemUnderComm = 0
                            tmSlf.iSofCode = 0
                        Else
                            tmSlf = tgMSlf(ilRet)
                        End If
                        
                        'different commission for remnants
                        If tmChf.sType = "T" Then       '4-8-09 chg from tgchfct
                            slCommPct = gIntToStrDec(tmSlf.iRemUnderComm, 2)
                        End If

                         'if NTR, get that commission instead
                        If tmRvf.iMnfItem > 0 Then          'this indicates NTR
                            'retrieve the associated NTR record from SBF
                            tmSbfSrchKey.lCode = tmRvf.lSbfCode  '12-16-02
                            ilRet = btrGetEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)
                            If ilRet <> BTRV_ERR_NONE Then          '7-28-03 insure the previous % isnt used
                                tmSbf.iCommPct = 0
                            End If
                        End If

                        'associated sales source
                        For illoop = LBound(tlSofList) To UBound(tlSofList)
                            If tlSofList(illoop).iSofCode = tmSlf.iSofCode Then
                                ilMatchSSCode = tlSofList(illoop).iMnfSSCode          'Sales source
                                Exit For
                            End If
                        Next illoop

                        ' Build ilMnfSSCode(), ilMnfGroup(), ilProdPct(), tmPifKey(), tmPifPct()
                        mBobGetHowManyPast ilMatchSSCode, ilHowMany, ilHowManyDefined, ilMnfSSCode(), ilMnfGroup(), ilProdPct()       '7-6-05

                        'For Advt & Vehicle, create 1 record per transaction
                        'For Owner , create as many as 3 records per transaction.  (up to 3 owners per vehicle)
                        'For slsp, create as many as 10 records per trans (up to 10 split slsp) per trans.
                        For illoop = 0 To ilHowMany - 1 Step 1        'loop based on report option
                            For ilTemp = 1 To 18 Step 1               'init the years $ buckets
                                tmGrf.lDollars(ilTemp - 1) = 0
                            Next ilTemp
                            If imSlsp Then
                                '4-20-00
                                ReDim llSlfSplit(0 To 9) As Long           '4-20-00 slsp slsp share %
                                ReDim ilSlfCode(0 To 9) As Integer             '4-20-00
                                ReDim ilslfcomm(0 To 9) As Integer             'slsp under comm %
                                ReDim ilslfremnant(0 To 9) As Integer          'slsp under remnant %
                                ReDim llSlfSplitRev(0 To 9) As Long         '2-2-04 unused in this report (need for subroutine)
                                
                                '4-6-00
                                ilMnfSubCo = gGetSubCmpy(tmChf, ilSlfCode(), llSlfSplit(), tmRvf.iAirVefCode, ilUseSlsComm, llSlfSplitRev())
                                '7-7-14 only get commission values if sales comm job, or a commission based report
                                If igRptCallType = SLSPCOMMSJOB Then        'loop one month at a time because each month could have a different slsp comm %- retrieve the unique one
                                    gGetCommByDates ilSlfCode(), ilslfcomm(), ilslfremnant(), tlSlfIndex(), tlScf(), tlSlf(), tmRvf.iAirVefCode, llDate, tmChf '7-14-00
                                End If
                            
                                '7-1-14 speed up and use binary search
                                ilSlfRecd = gBinarySearchSlf(ilSlfCode(illoop))
                                If ilSlfRecd = -1 Then          'not found
                                    tmSlf.iRemUnderComm = 0
                                    tmSlf.iSofCode = 0
                                Else
                                    tmSlf = tgMSlf(ilSlfRecd)
                                End If

                                '4-20-00 llProcessPct = tmChf.lComm(ilLoop)          'slsp split % or 100%
                                llProcessPct = llSlfSplit(illoop)          '4-20-00 slsp split % or 100%

                                'obtain the sales source for major sort of business booked reports
                                slCommPct = gIntToStrDec(ilslfcomm(illoop), 2)            '4-20-00 slsp commision % for under goal
                                'different commission for remnants
                                If tmChf.sType = "T" Then        '4-8-09 chg from tgchfct
                                    slCommPct = gIntToStrDec(tmSlf.iRemUnderComm, 2)
                                End If
                                If tmRvf.iMnfItem > 0 And Not ilUseSlsComm Then          'ntr, has different slsp comm %
                                    slCommPct = gIntToStrDec(tmSbf.iCommPct, 2)           'slsp commision % for NTR
                                End If

                                'table of selling offices built into memory with its
                                'associated sales source
                                For ilTemp = LBound(tlSofList) To UBound(tlSofList)
                                    If tlSofList(ilTemp).iSofCode = tmSlf.iSofCode Then
                                        ilMatchSSCode = tlSofList(ilTemp).iMnfSSCode          'Sales source
                                        Exit For
                                    End If
                                Next ilTemp
                            ElseIf imOwner Or imTrikIfOwner Then        '8-4-00
                                'First match on the sales source
                                'If tmVef.iMnfSSCode(ilLoop + 1) = ilMatchSSCode Then
                                If ilMnfSSCode(illoop + 1) = ilMatchSSCode Then     '7-6-05
                                    llProcessPct = ilProdPct(illoop + 1)            '7-6-05
                                    llProcessPct = llProcessPct * 100      'make it xxx.xxxx
                                Else
                                    llProcessPct = 1000000
                                End If
                            ElseIf (imVehicle And smGrossOrNet = "B") Then      '4-5-01  need the participant share for net-net option
                                If ilMnfSSCode(illoop + 1) = ilMatchSSCode Then
                                    llProcessPct = 1000000
                                    slCommPct = gIntToStrDec(ilProdPct(illoop + 1), 2)
                                Else
                                    If ilMnfSSCode(1) = 0 Then      'no sales source was found for this vehicle, default to 100%
                                        llProcessPct = 1000000
                                        slCommPct = ".00"
                                    Else                            'done with the splits
                                        llProcessPct = 0
                                        slCommPct = ".00"
                                    End If
                                End If
                            Else
                                llProcessPct = 1000000              'if advt or vehicle, just use slsp since there will always be one
                                                                    'and only one pass will be processed
                            End If

                            If llProcessPct > 0 Then
                              'if slsp or owner, check to see if this split should be included
                                ilFoundOne = mBobChkSlspInfo(ilSlfCode(), ilMnfGroup(), illoop)       'see if valid slsp or participant

                                If ilFoundOne Then
                                    ilRelativeIndex = mBobPastSetupKeyForReport(ilListIndex, ilSlfCode(), ilMnfGroup(), illoop, ilUsePkg)

                                    If ilHowManyDefined > 1 Then                   'this line or contract has splits
                                        tmGrf.iYear = 1                     'this transaction is a split slsp or owner
                                    Else
                                        tmGrf.iYear = 0                     'this trans. is not a split slsp or owner
                                    End If
                                    tmGrf.iSofCode = ilMatchSSCode          'sales source
                                    tmGrf.iPerGenl(0) = ilDateFlag          'processing no comparisons, base for comparison, or comparison dates
                                    tmGrf.iPerGenl(14) = 0                  '4-11-16 init flag to indicate its report by vehicle with participant vg
                                    mBobConvertAndSplitPast llProcessPct, slCommPct, llTransGross, llTransNet, llGrossDollar, llNetDollar, llCommDollar, ilRelativeIndex, ilHowManyDefined, ilReverseFlag

                                    'Bucket 13 contains total gross for slsp
                                    'bucket 1-12 contains slsp comm amount calc from his gross allocation
                                    'accum for 4 quarters totals
                                    'bucket 14 = 1st qtr
                                    'bucket 15 = 2nd qtr
                                    'bucket 16 = 3rd qtr
                                    'bucket 17 = 4th qtr
                                    '
                                    'Dont write any zero records out--
                                    ilMinTypes = 1          'detrmine the # of records to create if billed & booked vs commissions
                                    'If (smGrossOrNet = "N" Or smGrossOrNet = "T" Or smGrossOrNet = "D") And igRptCallType <> SLSPCOMMSJOB Then        'billed & booked net option (comm proj is forced to NET)
                                    If (smGrossOrNet = "N" Or smGrossOrNet = "T") And igRptCallType <> SLSPCOMMSJOB Then         'billed & booked net option (comm proj is forced to NET)
                                        ilMinTypes = 2          'Net billed & booked option
                                    End If
                                    If (tmRvf.sCashTrade = "M" Or tmRvf.sCashTrade = "P") And igRptCallType = SLSPCOMMSJOB Then
                                        ilMinTypes = 2  '3       'if merch or promotions, dont affect the gross or net values
                                    End If

                                    ilIncludeVehicleGroup = True
                                    '8-6-10 option swapped vehicle w/split slsp subtotals with split slsp sort w/vehicle subtotals
                                    'need to get the vehicle group selection if applicable
                                    If imVehicle Or imTrikIfOwner Or igSwapBOBOption Or (imMinorSet > 0 Or imMajorSet > 0) Then           '8-4-00 if vehicle option, get the sort criteria
                                        'gGetVehGrpSets tmGrf.iVefCode, imMinorSet, imMajorSet, tmGrf.iPerGenl(3), tmGrf.iPerGenl(4)   'Genl(3) = minor sort code, genl(4) = major sort code
                                        gGetVehGrpSets tmGrf.iVefCode, imMinorSet, imMajorSet, tmGrf.iPerGenl(2), tmGrf.iPerGenl(3)   'Genl(3) = minor sort code, genl(4) = major sort code
                                        '8-8-00 if vehicle sort, if NONE selected, distinguish between NONE a vehicle that doesnt have a vehicle group defined while running in Crystal
                                        If imMinorSet = 0 Then
                                            tmGrf.iPerGenl(2) = -1
                                        End If
                                        If imMajorSet = 0 Then
                                            tmGrf.iPerGenl(3) = -1
                                        End If
                                        If imMajorSet = 1 And imTrikIfOwner Or (imMajorSet = 1 And imVehicle And smGrossOrNet = "B") Then   '5-11-09 participant option with veh/participant (strange case to choose)
                                            If ilMnfGroup(illoop + 1) <> 0 Then                 '4-5-16 handle case were sales source not defined with vehicle; include so things balance
                                                tmGrf.iPerGenl(3) = ilMnfGroup(illoop + 1)        '5-2-07
                                            Else
                                                tmGrf.iPerGenl(3) = 0                           '4-14-16 no participant exist for sales source
                                            End If
                                            If (imMajorSet = 1 And imTrikIfOwner = True And imVehicle = True) Then  '4-11-16 special case by vehicle with participant VG; send flag to print different header
                                                tmGrf.iPerGenl(14) = -1
                                            End If
                                        End If
                                        If tmGrf.iPerGenl(3) > 0 Then                   '4-14-16 for B & B by Gross/Net,
                                            ilIncludeVehicleGroup = mTestVGItem()
                                        End If
                                    End If

                                    '4-26-13 test to include $0 contracts on B & B (only B & B has option implemented)
                                    If ((llNetDollar <> 0 Or llGrossDollar <> 0) Or (llNetDollar = 0 And imInclZero)) And ilIncludeVehicleGroup Then
                                        'tmGrf.iPerGenl(2) = mBobTestNew(ilNewCode, tmChf)      'New/Return flag to show on report:  0 = show nothing (probably return),
                                        tmGrf.iPerGenl(1) = mBobTestNew(ilNewCode, tmChf)      'New/Return flag to show on report:  0 = show nothing (probably return),

                                        For ilTypes = ilMinTypes To ilmaxTypes
                                            If ilTypes = 1 Then
                                                tmGrf.lDollars(ilMonthNo - 1) = llGrossDollar
                                                                                    'all the month columns add up to the qtr & year columns
                                            ElseIf ilTypes = 2 Then
                                                tmGrf.lDollars(ilMonthNo - 1) = llNetDollar
                                            Else
                                                tmGrf.lDollars(ilMonthNo - 1) = llCommDollar
                                            End If
                                            tmGrf.iPerGenl(4) = ilTypes     'update for sorting
                                            If ilReverseFlag Then   '10-22-08 And (ilTypes <> 3) And igRptCallType = CONTRACTSJOB) Then           'reverse the sign (math always with positive amts); but dont make the % of owners share negative for B & B Netnet
                                                tmGrf.lDollars(ilMonthNo - 1) = -tmGrf.lDollars(ilMonthNo - 1)
                                            End If
                                            If ilmaxTypes = ilMinTypes Then     '6/3/99 Only gross, or only net (billed & booked,not slsp comm), write out record rather
                                                                                'than building data in memory
                                                '2-25-14 remove build of this table, budgets will be created for all vehicles selected if B & B comparison
                                                'gTestSSForBBCompare tmGrf.iSofCode, tmGrf.iVefCode      'keep track of unique sales sources/vehicles for B & B Comparison budgets
                                                ilRet = btrInsert(hmGrf, tmGrf, imGrfRecLen, INDEXKEY0)
                                            Else
                                                lgSTime3 = timeGetTime
                                                '7-8-14 write out 1 record per trans, takes too long to loop to array to find matches with above code
                                                ilRet = btrInsert(hmGrf, tmGrf, imGrfRecLen, INDEXKEY0)
                                                lgETime3 = timeGetTime
                                                lgTtlTime3 = lgTtlTime3 + (lgETime3 - lgSTime3)
                                            End If
                                        Next ilTypes
                                        
                                    End If
                                End If                          'ilFoundOne
                            End If                              'llProcessPct > 0
                            If imVehicle And smGrossOrNet = "B" Then        '4-5-01 net-net option only by vehicle
                                illoop = ilHowMany
                            End If
                        Next illoop                             'loop for 10 slsp possible splits, or 3 possible owners, otherwise loop once
                    End If                                      'if foundmonth
                End If
            End If                                          'contr # doesnt match or not a fully sched contr
        Next llRvfLoop          '03-13-01
    Next ilLoopRecv
    lgETime2 = timeGetTime
    lgTtlTime2 = lgTtlTime2 + (lgETime2 - lgSTime2)         'total time in retrieving past
    
    lgSTime4 = timeGetTime

    For llLoopType = 0 To UBound(tlGrf1) - 1
        ilRet = btrInsert(hmGrf, tlGrf1(llLoopType), imGrfRecLen, INDEXKEY0)
    Next llLoopType
    For llLoopType = 0 To UBound(tlGrf2) - 1
        ilRet = btrInsert(hmGrf, tlGrf2(llLoopType), imGrfRecLen, INDEXKEY0)
    Next llLoopType
    For llLoopType = 0 To UBound(tlGrf3) - 1        'this is used for B & B vehicle/participant
        ilRet = btrInsert(hmGrf, tlGrf3(llLoopType), imGrfRecLen, INDEXKEY0)
    Next llLoopType
    
    lgETime4 = timeGetTime
    lgTtlTime4 = lgTtlTime4 + (lgETime4 - lgSTime4)

    'reinitialize arrays for RVF file (finished history)
    ReDim tlGrf1(0 To 0) As GRF      'build array of records by contract/advt & type  (to avoid excess records from receivables)
                                      'type 1 = Gross, type 2 = net, type 3 = commission
    ReDim tlGrf2(0 To 0) As GRF
    ReDim tlGrf3(0 To 0) As GRF

    ilRet = btrClose(hmRvf)
    btrDestroy hmRvf

    Erase tlSofList, tlGrf1, tlGrf2, tlGrf3
    Erase tlSofList, tlSlf, tlScf, tlSlfIndex, tlMnf, tlRvf
    ilRet = btrClose(hmScf)
    btrDestroy hmScf
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:gCRQAvailsClear                 *
'*                                                     *
'*             Created:10/09/93      By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Clear Quarterly avails Data     *
'*                     for Crystal report              *
'*                                                     *
'*******************************************************
Sub gCRQAvailsClearCt()
    Dim ilRet As Integer
    hmAvr = CBtrvTable(TEMPHANDLE)  '(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmAvr, "", sgDBPath & "Avr.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmAvr)
        btrDestroy hmAvr
        Exit Sub
    End If
    ReDim tmAvr(0 To 0) As AVR
    imAvrRecLen = Len(tmAvr(0))
    tmAvrSrchKey.iGenDate(0) = igNowDate(0)
    tmAvrSrchKey.iGenDate(1) = igNowDate(1)
    gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
    tmAvrSrchKey.lGenTime = lgNowTime

    ilRet = btrGetGreaterOrEqual(hmAvr, tmAvr(0), imAvrRecLen, tmAvrSrchKey, INDEXKEY0, BTRV_LOCK_NONE)
    Do While (ilRet = BTRV_ERR_NONE) And (tmAvr(0).iGenDate(0) = igNowDate(0)) And (tmAvr(0).iGenDate(1) = igNowDate(1)) And (tmAvr(0).lGenTime = lgNowTime)
        ilRet = btrDelete(hmAvr)
        ilRet = btrGetNext(hmAvr, tmAvr(0), imAvrRecLen, BTRV_LOCK_NONE, SETFORWRITE)
    Loop
    Erase tmAvr
    ilRet = btrClose(hmAvr)
    btrDestroy hmAvr
End Sub

'************************************************************************
'*                                                                      *
'*      Procedure Name:gCRQAvailsGen                                    *
'*                                                                      *
'*             Created:10/09/93      By:D. LeVine                       *
'*            Modified:              By:                                *
'*                                                                      *
'*            Comments:Generate Quarterly avails Data                   *
'*                     for Crystal report                               *
'                                                                       *
'           4/27/98:  Changed to use sort codes from the                *
'               RIF file rather than  RDF file.                         *
'               Change to use fields "Show on Report"                   *
'               from RIF rather than RDF.                               *
'*         7-20-04 Option to include/exclude local & network spots      *
'*         2-7-05 Units based vehicles:  each avail must be defined as  *
'                 1 unit/any seconds for units based to work            *
'*         5-16-05 chg reference of ckcselc3 to ckcselc10               *
'*               (this is holds/orders question_                        *
'*               Add spot type selectivity and rework screen            *
'*                                                                      *
'************************************************************************
Sub gCRQAvailsGenCt()
    Dim illoop As Integer
    Dim ilLoopSet As Integer
    Dim ilRet As Integer
    Dim slDate As String
    Dim llDate As Long
    Dim ilVehicle As Integer
    Dim slNameCode As String
    Dim slName As String
    Dim slCode As String
    Dim ilVefCode As Integer
    Dim ilNoQuarters As Integer
    Dim ilQNo As Integer
    Dim slQSDate As String
    Dim sl1WkDate As String
    Dim ll1WkDate As Long
    Dim ilFirstQ As Integer
    Dim ilRec As Integer
    Dim ilVpfIndex As Integer
    Dim ilUpper As Integer
    Dim ilDateOk As Integer
    Dim llRif As Long
    Dim ilRdf As Integer
    Dim ilRcf As Integer
    Dim ilStdQtr As Integer                 'true if using std qtr, else false
    Dim ilFound As Integer
    Dim slSaveReport As String               'Show on report code from RDF (if RIF not answered) or RIF
    Dim ilSaveSort As Integer               'Sort code from RDF (if RIF not answered) or RIF
    Dim ilmnfMinorCode As Integer           'minor sort code (zero for this report, unused)
    Dim ilMnfMajorCode As Integer           'major vehicle set for vehicle
    Dim ilMinorSet As Integer                  'unused for sorting purposes
    Dim ilMajorSet As Integer                  'major vehicle set selected
    Dim ilCountsBy As Integer               '0 = units (1 column reprt), 1 = 30/60   (2 column)
    Dim ilCostType As Integer               'bit map of spot types to include/exclude
    Dim ilNoWeeks As Integer                '9-1-09
    Dim ilLoopOnWeeks As Integer
    Dim llTemp As Long
    Dim slUserRequest As String * 1 '   '8-13-10 show output in Units (U) or 30/60 (B).  Unit counts should not exceed the # units defined

    ilNoQuarters = ((Val(RptSelCt!edcSelCFrom1.Text)) - 1) \ 13 + 1 '9-1-09 convert # weeks to quarters
    ilNoWeeks = Val(RptSelCt!edcSelCFrom1.Text)
    If RptSelCt!rbcSelCSelect(0).Value Then           'avails
        smBucketType = "A"
    ElseIf (RptSelCt!rbcSelCSelect(1).Value) Then       'sold in minutes
        smBucketType = "S"
    ElseIf (RptSelCt!rbcSelCSelect(3).Value) Then         'sold in percent
        smBucketType = "P"
    Else
        smBucketType = "I"
    End If
    If smBucketType = "I" Then
        imMissed = False
        imRemnant = False
        imDR = False
        imPI = False
        imPSA = False
        imPromo = False
        imXtra = False
        imReserv = False
        imStandard = False
        imTrade = False
        imNC = False
        imHold = False
        imOrder = False
        imOrphan = False
    Else
        imHold = gSetCheck(RptSelCt!ckcSelC10(0).Value)  '5-16-05 chg from ckcselc3
        imOrder = gSetCheck(RptSelCt!ckcSelC10(1).Value) '5-16-05 chg from ckcselc3
        imStandard = gSetCheck(RptSelCt!ckcSelC5(0).Value)
        imReserv = gSetCheck(RptSelCt!ckcSelC5(1).Value)
        imRemnant = gSetCheck(RptSelCt!ckcSelC5(2).Value)
        imDR = gSetCheck(RptSelCt!ckcSelC5(3).Value)
        imPI = gSetCheck(RptSelCt!ckcSelC5(4).Value)
        imPSA = gSetCheck(RptSelCt!ckcSelC5(5).Value)
        imPromo = gSetCheck(RptSelCt!ckcSelC5(6).Value)
        imTrade = gSetCheck(RptSelCt!ckcSelC6(0).Value)
        imMissed = gSetCheck(RptSelCt!ckcSelC6(1).Value)
        'imNC = gSetCheck(RptSelCt!ckcSelC6(2).Value)       '5-16-05 all spot types are now a separate option
        'imXtra = gSetCheck(RptSelCt!ckcSelC6(3).Value)     '5-16-05
        imOrphan = gSetCheck(RptSelCt!ckcSelC8(0).Value)
    End If
    imLocked = gSetCheck(RptSelCt!ckcSelC6(4).Value)    '3-13-03 regardless of inventory or avails, determine request to include/exclude locked avails
    'imLocal = gSetCheck(RptSelCt!ckcSelC12(0).Value)     '7-20-04 Include local?
    If (imOrder) Or (imHold) Then                       'Holds & orders are contract spots
        imLocal = True
    End If
    imFeed = gSetCheck(RptSelCt!ckcSelC12(0).Value)     '7-20-04 Include network feed?

    If RptSelCt!rbcSelC11(0).Value Then         'counts by units
        ilCountsBy = 0
        slUserRequest = "U"
    Else                                        'counts by 30/60
        ilCountsBy = 1
        slUserRequest = "B"
    End If

    mSetCostType ilCostType             'set bit pattern of types of spots to include

    hmVef = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVef, "", sgDBPath & "Vef.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmVef)
        btrDestroy hmVef
        Exit Sub
    End If
    imVefRecLen = Len(tmVef)
    hmSdf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSdf, "", sgDBPath & "Sdf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVef)
        btrDestroy hmSdf
        btrDestroy hmVef
        Exit Sub
    End If
    imSdfRecLen = Len(tmSdf)
    hmAvr = CBtrvTable(TEMPHANDLE)  '(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmAvr, "", sgDBPath & "Avr.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmAvr)
        btrDestroy hmAvr
        btrDestroy hmSdf
        btrDestroy hmVef
        Exit Sub
    End If
    ReDim tmAvr(0 To 0) As AVR
    imAvrRecLen = Len(tmAvr(0))
    hmSsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSsf, "", sgDBPath & "Ssf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSsf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmAvr)
        btrDestroy hmSsf
        btrDestroy hmAvr
        btrDestroy hmSdf
        btrDestroy hmVef
        Exit Sub
    End If
    hmLcf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmLcf, "", sgDBPath & "Lcf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmLcf)
        ilRet = btrClose(hmSsf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmAvr)
        btrDestroy hmLcf
        btrDestroy hmSsf
        btrDestroy hmAvr
        btrDestroy hmSdf
        btrDestroy hmVef
        Exit Sub
    End If
    imLcfRecLen = Len(tmLcf)
    hmCHF = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCHF, "", sgDBPath & "Chf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmCHF)
        ilRet = btrClose(hmLcf)
        ilRet = btrClose(hmSsf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmAvr)
        btrDestroy hmCHF
        btrDestroy hmLcf
        btrDestroy hmSsf
        btrDestroy hmAvr
        btrDestroy hmSdf
        btrDestroy hmVef
        Exit Sub
    End If
    imCHFRecLen = Len(tmChf)
    hmClf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmClf, "", sgDBPath & "Clf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        ilRet = btrClose(hmLcf)
        ilRet = btrClose(hmSsf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmAvr)
        btrDestroy hmClf
        btrDestroy hmCHF
        btrDestroy hmLcf
        btrDestroy hmSsf
        btrDestroy hmAvr
        btrDestroy hmSdf
        btrDestroy hmVef
        Exit Sub
    End If
    imClfRecLen = Len(tmClf)
    hmCff = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCff, "", sgDBPath & "Cff.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        ilRet = btrClose(hmLcf)
        ilRet = btrClose(hmSsf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmAvr)
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        btrDestroy hmLcf
        btrDestroy hmSsf
        btrDestroy hmAvr
        btrDestroy hmSdf
        btrDestroy hmVef
        Exit Sub
    End If
    imCffRecLen = Len(tmCff)
    hmSmf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSmf, "", sgDBPath & "Smf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSmf)
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        ilRet = btrClose(hmLcf)
        ilRet = btrClose(hmSsf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmAvr)
        btrDestroy hmSmf
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        btrDestroy hmLcf
        btrDestroy hmSsf
        btrDestroy hmAvr
        btrDestroy hmSdf
        btrDestroy hmVef
        Exit Sub
    End If
    imSmfRecLen = Len(tmSmf)
    '7-20-04    open to test avail type to include/exclude local or network avails
    hmAnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmAnf, "", sgDBPath & "Anf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmAnf)
        ilRet = btrClose(hmSmf)
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        ilRet = btrClose(hmLcf)
        ilRet = btrClose(hmSsf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmAvr)
        btrDestroy hmAnf
        btrDestroy hmSmf
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        btrDestroy hmLcf
        btrDestroy hmSsf
        btrDestroy hmAvr
        btrDestroy hmSdf
        btrDestroy hmVef
        Exit Sub
    End If
    imAnfRecLen = Len(tmAnf)
    hmFsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmFsf, "", sgDBPath & "Fsf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmFsf)
        ilRet = btrClose(hmAnf)
        ilRet = btrClose(hmSmf)
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        ilRet = btrClose(hmLcf)
        ilRet = btrClose(hmSsf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmAvr)
        btrDestroy hmFsf
        btrDestroy hmAnf
        btrDestroy hmSmf
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        btrDestroy hmLcf
        btrDestroy hmSsf
        btrDestroy hmAvr
        btrDestroy hmSdf
        btrDestroy hmVef
        Exit Sub
    End If
    imFsfRecLen = Len(tmFsf)
    hmGsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmGsf, "", sgDBPath & "Gsf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmGsf)
        ilRet = btrClose(hmFsf)
        ilRet = btrClose(hmAnf)
        ilRet = btrClose(hmSmf)
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        ilRet = btrClose(hmLcf)
        ilRet = btrClose(hmSsf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmAvr)
        btrDestroy hmGsf
        btrDestroy hmFsf
        btrDestroy hmAnf
        btrDestroy hmSmf
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        btrDestroy hmLcf
        btrDestroy hmSsf
        btrDestroy hmAvr
        btrDestroy hmSdf
        btrDestroy hmVef
        Exit Sub
    End If
    imGsfRecLen = Len(tmGsf)
    ilRet = gObtainAvail()
    ilStdQtr = True
    If RptSelCt!rbcSelC9(1).Value Then          'use start date entered (dont do the standard qtr)
        ilStdQtr = False
    End If
    illoop = RptSelCt!cbcSet1.ListIndex
    'ilMajorSet = tgVehicleSets1(ilLoop).icode
    ilMajorSet = gFindVehGroupInx(illoop, tgVehicleSets1())

    slDate = RptSelCt!edcSelCFrom.Text
    ilRet = gObtainRcfRifRdf()          'get the rate cards and assoc dayparts

    sl1WkDate = RptSelCt!edcSelCFrom.Text
    ll1WkDate = gDateValue(sl1WkDate)
    If ilStdQtr Then
        slDate = gObtainYearStartDate(0, slDate)        'get start of std year so it can advance to the correct qtr requested
        llDate = gDateValue(slDate)
        Do While (ll1WkDate < llDate) Or (ll1WkDate > llDate + 13 * 7 - 1)  'advance to start of the current requested qtr
            llDate = llDate + 13 * 7
        Loop
    Else
        llDate = gDateValue(slDate)             'not using std qtr, start with date user entered, but back it up to the current Monday
        illoop = gWeekDayLong(llDate)
        Do While illoop <> 0
            llDate = llDate - 1
            illoop = gWeekDayLong(llDate)
        Loop
    End If
    slQSDate = Format$(llDate, "m/d/yy")

    tmVef.iCode = 0
    For ilQNo = 1 To ilNoQuarters Step 1
        If ilNoWeeks <= 13 Then
            ilLoopOnWeeks = ilNoWeeks
            ilNoWeeks = 0
        Else
            ilLoopOnWeeks = 13
            ilNoWeeks = ilNoWeeks - 13
        End If
        llDate = gDateValue(slQSDate)
        For illoop = 1 To 13 Step 1
            If ilStdQtr Then                'using the standard qtr, always show from start of the qtr requested
                If (ll1WkDate >= llDate) And (ll1WkDate <= llDate + 6) Then
                    ilFirstQ = illoop
                End If
            Else
            ilFirstQ = 1                    'assume not showing the std qtr, in which case
                                            'the 13 weeks will wrap around with whatever start entered
            End If
            lmSAvailsDates(illoop) = llDate
            lmEAvailsDates(illoop) = llDate + 6
            llDate = llDate + 7
        Next illoop
        For ilVehicle = 0 To RptSelCt!lbcSelection(6).ListCount - 1 Step 1
            If (RptSelCt!lbcSelection(6).Selected(ilVehicle)) Then
                slNameCode = tgCSVNameCode(ilVehicle).sKey 'RptSelCt!lbcCSVNameCode.List(ilVehicle)
                ilRet = gParseItem(slNameCode, 1, "\", slName)
                ilRet = gParseItem(slName, 3, "|", slName)
                ilRet = gParseItem(slNameCode, 2, "\", slCode)
                ilVefCode = Val(slCode)
                ilVpfIndex = -1
                illoop = gBinarySearchVpf(ilVefCode)
                If illoop <> -1 Then
                    ilVpfIndex = illoop
                End If
                ilFound = True
                If (Not RptSelCt!ckcAllAAS.Value = vbChecked And ilMajorSet > 0) Then                 'all vehicle sets selected
                    For illoop = LBound(tgMVef) To UBound(tgMVef) Step 1
                        ilFound = False
                        If ilVefCode = tgMVef(illoop).iCode Then
                            If ilMajorSet = 1 Then
                                ilRec = tgMVef(illoop).iOwnerMnfCode    '5-12-07
                            ElseIf ilMajorSet = 2 Then
                                ilRec = tgMVef(illoop).iMnfVehGp2
                            ElseIf ilMajorSet = 3 Then
                                ilRec = tgMVef(illoop).iMnfVehGp3Mkt
                            ElseIf ilMajorSet = 4 Then
                                ilRec = tgMVef(illoop).iMnfVehGp4Fmt
                            ElseIf ilMajorSet = 5 Then
                                ilRec = tgMVef(illoop).iMnfVehGp5Rsch
                            ElseIf ilMajorSet = 6 Then
                                ilRec = tgMVef(illoop).iMnfVehGp6Sub
                            End If
                            For ilLoopSet = 0 To RptSelCt!lbcSelection(2).ListCount - 1 Step 1
                                If RptSelCt!lbcSelection(2).Selected(ilLoopSet) Then
                                    slNameCode = tgSOCodeCT(ilLoopSet).sKey
                                    ilRet = gParseItem(slNameCode, 1, "\", slName)
                                    ilRet = gParseItem(slName, 3, "|", slName)
                                    ilRet = gParseItem(slNameCode, 2, "\", slCode)
                                    'Determine which vehicle set to test
                                    If ilRec = Val(slCode) Then
                                        ilFound = True
                                        Exit For
                                    End If
                                End If
                            Next ilLoopSet
                            Exit For
                        End If
                    Next illoop
                End If
                If Not ilFound Then
                    ilVpfIndex = -1
                End If
                If ilVpfIndex >= 0 Then
                    imRcf = -1                  'no rate card found yet
                    For ilRcf = LBound(tgMRcf) To UBound(tgMRcf) - 1 Step 1
                        tmRcf = tgMRcf(ilRcf)
                        ilDateOk = False
                        For illoop = 0 To RptSelCt!lbcSelection(12).ListCount - 1 Step 1
                            slNameCode = tgRateCardCode(illoop).sKey
                            ilRet = gParseItem(slNameCode, 3, "\", slCode)
                            If Val(slCode) = tgMRcf(ilRcf).iCode Then
                                If (RptSelCt!lbcSelection(12).Selected(illoop)) Then
                                    ilDateOk = True
                                    imRcf = ilRcf               'needed for missed spots if not using other missed spots category
                                End If
                                Exit For
                            End If
                        Next illoop

                        If ilDateOk Then
                            ReDim tmAvr(0 To 0) As AVR
                            ReDim tmAvRdf(0 To 0) As RDF
                            ReDim tmRifSorts(0 To 0) As RIF
                            ilUpper = 0
                            For llRif = LBound(tgMRif) To UBound(tgMRif) - 1 Step 1
                                If tgMRif(llRif).iRcfCode = tgMRcf(ilRcf).iCode And tgMRif(llRif).iVefCode = ilVefCode Then
                                    ilRdf = gBinarySearchRdf(tgMRif(llRif).iRdfCode)
                                    If ilRdf <> -1 Then
                                        'Determine if Rate Card items have been entered, if not, use Daypart (RDF) fields
                                        If tgMRif(llRif).sRpt <> "Y" And tgMRif(llRif).sRpt <> "N" Then
                                            slSaveReport = tgMRdf(ilRdf).sReport
                                        Else
                                            slSaveReport = tgMRif(llRif).sRpt
                                        End If
                                        If tgMRif(llRif).iSort = 0 Then
                                            ilSaveSort = tgMRdf(ilRdf).iSortCode
                                        Else
                                            ilSaveSort = tgMRif(llRif).iSort
                                        End If
                                        If tgMRdf(ilRdf).iCode = tgMRif(llRif).iRdfCode And Trim$(slSaveReport) <> "N" And tgMRdf(ilRdf).sState <> "D" And tgMRif(llRif).iVefCode = ilVefCode Then
                                            ilFound = False
                                            For illoop = LBound(tmAvRdf) To ilUpper - 1 Step 1
                                                If tmAvRdf(illoop).iCode = tgMRdf(ilRdf).iCode Then
                                                    ilFound = True
                                                    Exit For
                                                End If
                                            Next illoop
                                            If Not ilFound Then
                                                tmRifSorts(ilUpper) = tgMRif(llRif)
                                                tmRifSorts(ilUpper).iSort = ilSaveSort
                                                tmAvRdf(ilUpper) = tgMRdf(ilRdf)
                                                ilUpper = ilUpper + 1
                                                ReDim Preserve tmRifSorts(0 To ilUpper) As RIF
                                                ReDim Preserve tmAvRdf(0 To ilUpper) As RDF
                                            End If
                                        End If
                                    End If
                                End If
                            Next llRif
                            mGetAvailCounts ilVefCode, ilVpfIndex, ilFirstQ, lmSAvailsDates(ilFirstQ), lmEAvailsDates(ilLoopOnWeeks), ilCountsBy, ilCostType, slUserRequest      '5-16-05
                            'Setup the major sort factor
                            gGetVehGrpSets ilVefCode, ilMinorSet, ilMajorSet, ilmnfMinorCode, ilMnfMajorCode
                            'Output records
                            For ilRec = 0 To UBound(tmAvr) - 1 Step 1
                                tmAvr(ilRec).imnfMajorCode = ilMnfMajorCode
                                If tmAvr(ilRec).iRdfSortCode = -1 Then      'this is the orphaned missed group,
                                    tmAvr(ilRec).iRdfSortCode = 0           'Crystal will test for absence of code to detect
                                 End If
                                tmAvr(ilRec).iWksInQtr = ilLoopOnWeeks
                                ilRet = btrInsert(hmAvr, tmAvr(ilRec), imAvrRecLen, INDEXKEY0)
                            Next ilRec
                        End If
                    Next ilRcf
                End If
            End If
        Next ilVehicle
        llDate = gDateValue(slQSDate) + 13 * 7
        slQSDate = Format$(llDate, "m/d/yy")
        ll1WkDate = llDate
    Next ilQNo
    Erase tmAvr
    Erase tmAvRdf
    Erase tmRifSorts
    ilRet = btrClose(hmSsf)
    ilRet = btrClose(hmRdf)
    ilRet = btrClose(hmRcf)
    ilRet = btrClose(hmSdf)
    ilRet = btrClose(hmVef)
    ilRet = btrClose(hmAvr)
    ilRet = btrClose(hmCHF)
    ilRet = btrClose(hmClf)
    ilRet = btrClose(hmCff)
    ilRet = btrClose(hmAnf)
    ilRet = btrClose(hmFsf)
    ilRet = btrClose(hmGsf)
    btrDestroy hmRdf
    btrDestroy hmRcf
    btrDestroy hmAvr
    btrDestroy hmSdf
    btrDestroy hmVef
    btrDestroy hmSsf
    btrDestroy hmCHF
    btrDestroy hmClf
    btrDestroy hmCff
    btrDestroy hmAnf
    btrDestroy hmFsf
    btrDestroy hmGsf
End Sub

'********************************************************************
'*                                                                  *
'*      Procedure Name:gCRSpotProjGen                               *
'*                                                                  *
'*             Created:10/09/93      By:D. LeVine                   *
'*            Modified:              By:                            *
'*                                                                  *
'*            Comments:Generate Spot Projection Data                *
'*                     for Crystal report                           *
'                                                                   *
'           1/23/98 dh:  Add more contract selectivity,             *
'           gross/net, & calendar option .  Change DDF              *
'           to add contrct code so all versions of the              *
'           Crystal report dont have to be changed.                 *
'                                                                   *
'           1/30/00 Add # periods to print.  Add vehicle            *
'               groupings for all sort types                        *
'           7-19-04 Always exclude network spots since they dont    *
'                   have $ associated
'       11-8-04 if use agency commission % stored in
'           agency record for comm % (dont default to 15%
'       8-18-05  BB spots should not have rates
'       6-28-07 implement Air Time, NTR, Politicals
'********************************************************************
Sub gCRSpotProjGenCt()
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  ilNonZero                     ilRec                         slAmount                  *
    '*  llAmount                      slCAmount                     llCAmount                 *
    '*  slTAmount                     llTAmount                     slTPct                    *
    '*  ilTPct                        slCPct                        ilCPct                    *
    '*  ilGrossNet                    ilTradeGrossNet               llAllDollars              *
    '*  llSplitDollars                tlCJsr                        tlTJsr                    *
    '*  ilMajorVGrp                   llNumberPeriods                                         *
    '******************************************************************************************
    Dim illoop As Integer
    Dim ilRet As Integer
    Dim slDate As String
    Dim ilVehicle As Integer
    Dim slNameCode As String
    Dim slName As String
    Dim slCode As String
    Dim ilVefCode As Integer
    Dim ilMonth As Integer
    Dim slStartDate As String
    Dim slEndDate As String
    Dim ilAllSelected As Integer
    Dim ilfilter As Integer
    Dim slGrossNet As String * 1        'G = Gross, N = net
    Dim ilNumberPeriods As Integer        '1-31-00
    ReDim ilSelectedVefCodes(0 To 0) As Integer
    Dim ilUpper As Integer
    Dim slStamp As String
    Dim llLastBilled As Long

    slCode = Trim$(RptSelCt!edcText.Text)
    If slCode = "" Then
        lmSingleCntr = 0
    Else
        lmSingleCntr = CLng(slCode)
    End If

    If RptSelCt!rbcSelC4(0).Value Then          'gross
        slGrossNet = "G"
    Else
        slGrossNet = "N"
    End If
    For illoop = 1 To 13 Step 1
        lmSProjDates(illoop) = 0
        lmEProjDates(illoop) = 0
    Next illoop
    slDate = RptSelCt!CSI_CalFrom.Text      'Date: 1/7/2020 added CSI calendar controls for date entries --> edcSelCFrom.Text
    If RptSelCt!rbcSelCSelect(0).Value Then  'set last sunday of first week
        slDate = gObtainNextSunday(slDate)
        lmEProjDates(1) = gDateValue(slDate)
        lmSProjDates(1) = lmEProjDates(1) - 6
        For illoop = 2 To 13
            lmSProjDates(illoop) = lmSProjDates(illoop - 1) + 7
            lmEProjDates(illoop) = lmEProjDates(illoop - 1) + 7
        Next illoop
        slStartDate = Format$(lmSProjDates(1), "m/d/yy")
        slEndDate = Format$(lmEProjDates(13), "m/d/yy")
    ElseIf RptSelCt!rbcSelCSelect(1).Value Then  'set last date of 12 standard periods
        slDate = gObtainStartStd(slDate)
        ilMonth = Month(Format$(gDateValue(slDate) + 15, "m/d/yy"))
        slDate = Format$(gDateValue(slDate) - 1, "m/d/yy")   'End date of previous month
        'For ilLoop = ilMonth To 12 Step 1
        For illoop = 1 To 12 Step 1
            slDate = Format$(gDateValue(slDate) + 1, "m/d/yy")   'Start date next month
            lmSProjDates(illoop) = gDateValue(slDate)
            slDate = gObtainEndStd(slDate)
            lmEProjDates(illoop) = gDateValue(slDate)
        Next illoop
        'slStartDate = Format$(lmSProjDates(ilMonth), "m/d/yy")
        slStartDate = Format$(lmSProjDates(1), "m/d/yy")
        slEndDate = Format$(lmEProjDates(12), "m/d/yy")
    ElseIf RptSelCt!rbcSelCSelect(2).Value Then  'set last date of 12 corporate periods
        slDate = gObtainStartCorp(slDate, True)
        ilMonth = Month(Format$(gDateValue(slDate) + 15, "m/d/yy"))
        slDate = Format$(gDateValue(slDate) - 1, "m/d/yy")   'End date of previous month
        'For ilLoop = ilMonth To 12 Step 1
        For illoop = 1 To 12 Step 1
            slDate = Format$(gDateValue(slDate) + 1, "m/d/yy")   'Start date next month
            lmSProjDates(illoop) = gDateValue(slDate)
            slDate = gObtainEndCorp(slDate, True)
            lmEProjDates(illoop) = gDateValue(slDate)
        Next illoop
        'slStartDate = Format$(lmSProjDates(ilMonth), "m/d/yy")
        slStartDate = Format$(lmSProjDates(1), "m/d/yy")
        slEndDate = Format$(lmEProjDates(12), "m/d/yy")
    ElseIf RptSelCt!rbcSelCSelect(3).Value Then  'set last date of 12 calendar periods
        slDate = gObtainStartCal(slDate)
        ilMonth = Month(Format$(gDateValue(slDate) + 15, "m/d/yy"))
        slDate = Format$(gDateValue(slDate) - 1, "m/d/yy")   'End date of previous month
        'For ilLoop = ilMonth To 12 Step 1
        For illoop = 1 To 12 Step 1
            slDate = Format$(gDateValue(slDate) + 1, "m/d/yy")   'Start date next month
            lmSProjDates(illoop) = gDateValue(slDate)
            slDate = gObtainEndCal(slDate)
            lmEProjDates(illoop) = gDateValue(slDate)
        Next illoop
        'slStartDate = Format$(lmSProjDates(ilMonth), "m/d/yy")
        slStartDate = Format$(lmSProjDates(1), "m/d/yy")
        slEndDate = Format$(lmEProjDates(12), "m/d/yy")
    End If
    hmCHF = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCHF, "", sgDBPath & "Chf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmCHF)
        btrDestroy hmCHF
        Exit Sub
    End If
    imCHFRecLen = Len(tgChfCT)
    hmClf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmClf, "", sgDBPath & "Clf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmClf
        btrDestroy hmCHF
        Exit Sub
    End If
    imClfRecLen = Len(tmClf)
    hmVef = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVef, "", sgDBPath & "Vef.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmVef
        btrDestroy hmClf
        btrDestroy hmCHF
        Exit Sub
    End If
    imVefRecLen = Len(tmVef)
    hmVsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVsf, "", sgDBPath & "Vsf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmVsf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmVsf
        btrDestroy hmVef
        btrDestroy hmClf
        btrDestroy hmCHF
        Exit Sub
    End If
    imVsfRecLen = Len(tmVsf)
    hmSdf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSdf, "", sgDBPath & "Sdf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVsf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmSdf
        btrDestroy hmVsf
        btrDestroy hmVef
        btrDestroy hmClf
        btrDestroy hmCHF
        Exit Sub
    End If
    imSdfRecLen = Len(tmSdf)
    hmSmf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSmf, "", sgDBPath & "Smf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSmf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVsf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmSmf
        btrDestroy hmSdf
        btrDestroy hmVsf
        btrDestroy hmVef
        btrDestroy hmClf
        btrDestroy hmCHF
        Exit Sub
    End If
    imSmfRecLen = Len(tmSmf)
    hmJsr = CBtrvTable(TEMPHANDLE)  '(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmJsr, "", sgDBPath & "Jsr.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmJsr)
        ilRet = btrClose(hmSmf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVsf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmJsr
        btrDestroy hmSmf
        btrDestroy hmSdf
        btrDestroy hmVsf
        btrDestroy hmVef
        btrDestroy hmClf
        btrDestroy hmCHF
        Exit Sub
    End If

    hmCff = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCff, "", sgDBPath & "Cff.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmJsr)
        ilRet = btrClose(hmSmf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVsf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmJsr
        btrDestroy hmSmf
        btrDestroy hmSdf
        btrDestroy hmVsf
        btrDestroy hmVef
        btrDestroy hmClf
        btrDestroy hmCHF
        Exit Sub
    End If

    hmAgf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmAgf, "", sgDBPath & "Agf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmAgf)
        ilRet = btrClose(hmJsr)
        ilRet = btrClose(hmSmf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVsf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmAgf
        btrDestroy hmJsr
        btrDestroy hmSmf
        btrDestroy hmSdf
        btrDestroy hmVsf
        btrDestroy hmVef
        btrDestroy hmClf
        btrDestroy hmCHF
        Exit Sub
    End If

    hmSbf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSbf, "", sgDBPath & "Sbf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSbf)
        ilRet = btrClose(hmAgf)
        ilRet = btrClose(hmJsr)
        ilRet = btrClose(hmSmf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVsf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmSbf
        btrDestroy hmAgf
        btrDestroy hmJsr
        btrDestroy hmSmf
        btrDestroy hmSdf
        btrDestroy hmVsf
        btrDestroy hmVef
        btrDestroy hmClf
        btrDestroy hmCHF
        Exit Sub
    End If
    imSbfRecLen = Len(tmSbf)

    hmMnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmMnf, "", sgDBPath & "Mnf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmMnf)
        ilRet = btrClose(hmSbf)
        ilRet = btrClose(hmAgf)
        ilRet = btrClose(hmJsr)
        ilRet = btrClose(hmSmf)
        ilRet = btrClose(hmSdf)
        ilRet = btrClose(hmVsf)
        ilRet = btrClose(hmVef)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmMnf
        btrDestroy hmSbf
        btrDestroy hmAgf
        btrDestroy hmJsr
        btrDestroy hmSmf
        btrDestroy hmSdf
        btrDestroy hmVsf
        btrDestroy hmVef
        btrDestroy hmClf
        btrDestroy hmCHF
        Exit Sub
    End If
    imSbfRecLen = Len(tmSbf)

    gObtainVirtVehList

    ilRet = gObtainMnfForType("I", slStamp, tlMMnf())        'NTR Item types to check for hard cost

    ReDim tmJsr(0 To 0) As JSR
    imJsrRecLen = Len(tmJsr(0))
    tmVef.iCode = 0
    tmChf.lCode = 0
    ReDim imAdfCode(0 To 0) As Integer
    ReDim imSelSlfCode(0 To 0) As Integer
    ReDim imSelAgfCode(0 To 0) As Integer   '4-08-08
    ReDim lmChfCode(0 To 0) As Long
    ilfilter = 0    'None
    imMiss = False
    imHidden = False
    imCancel = False
    If RptSelCt!ckcSelC3(2).Value = vbChecked Then            'include missed
        imMiss = True
    End If
    If RptSelCt!ckcSelC3(3).Value = vbChecked Then            'include Cancel
        imCancel = True
    End If
    If RptSelCt!ckcSelC3(4).Value = vbChecked Then            'include Hidden
        imHidden = True
    End If
    If Not RptSelCt!ckcAll.Value = vbChecked Then
        If RptSelCt!rbcSelCInclude(0).Value Then 'Advertiser/Contracts
            ilAllSelected = True
            For illoop = 0 To RptSelCt!lbcSelection(0).ListCount - 1 Step 1
                If Not RptSelCt!lbcSelection(0).Selected(illoop) Then
                    ilAllSelected = False
                    Exit For
                End If
            Next illoop
            If ilAllSelected Then
                ilfilter = 1
                For illoop = 0 To RptSelCt!lbcSelection(5).ListCount - 1 Step 1
                    If RptSelCt!lbcSelection(5).Selected(illoop) Then
                        slNameCode = tgAdvertiser(illoop).sKey 'Traffic!lbcAdvertiser.List(ilLoop)
                        ilRet = gParseItem(slNameCode, 2, "\", slCode)    'Get application name
                        imAdfCode(UBound(imAdfCode)) = Val(slCode)
                        ReDim Preserve imAdfCode(0 To UBound(imAdfCode) + 1) As Integer
                    End If
                Next illoop
            Else
                ilfilter = 2
                For illoop = 0 To RptSelCt!lbcSelection(0).ListCount - 1 Step 1
                    If RptSelCt!lbcSelection(0).Selected(illoop) Then
                        slNameCode = RptSelCt!lbcCntrCode.List(illoop)
                        ilRet = gParseItem(slNameCode, 2, "\", slCode)    'Get application name
                        lmChfCode(UBound(lmChfCode)) = Val(slCode)
                        ReDim Preserve lmChfCode(0 To UBound(lmChfCode) + 1) As Long
                    End If
                Next illoop
            End If
        ElseIf RptSelCt!rbcSelCInclude(1).Value Then 'Salesperson
            ilfilter = 3
            For illoop = 0 To RptSelCt!lbcSelection(2).ListCount - 1 Step 1
                If (RptSelCt!lbcSelection(2).Selected(illoop)) Then
                    slNameCode = tgSalesperson(illoop).sKey    'Traffic!lbcSalesperson.List(ilLoop)
                    ilRet = gParseItem(slNameCode, 2, "\", slCode)
                    imSelSlfCode(UBound(imSelSlfCode)) = Val(slCode)
                    ReDim Preserve imSelSlfCode(0 To UBound(imSelSlfCode) + 1) As Integer
                End If
            Next illoop

        ElseIf RptSelCt!rbcSelCInclude(3).Value Then '4-08-08 agency option
            ilfilter = 4
            For illoop = 0 To RptSelCt!lbcSelection(1).ListCount - 1 Step 1
                slNameCode = RptSelCt!lbcNoSort.List(illoop)
                ilRet = gParseItem(slNameCode, 2, "\", slCode)
                If RptSelCt!lbcSelection(1).Selected(illoop) Then                'selected ?
                    If InStr(slNameCode, "/Direct") = 0 And InStr(slNameCode, "/Non-") = 0 Then         'not a direct, and not a direct that was changed to reg agency, this is reg agency
                        imSelAgfCode(UBound(imSelAgfCode)) = Val(slCode)
                    Else
                        imSelAgfCode(UBound(imSelAgfCode)) = -Val(slCode)
                    End If
                    ReDim Preserve imSelAgfCode(0 To UBound(imSelAgfCode) + 1) As Integer
                End If
            Next illoop
        End If
    End If

    imStandard = gSetCheck(RptSelCt!ckcSelC5(0).Value)
    imReserv = gSetCheck(RptSelCt!ckcSelC5(1).Value)
    imRemnant = gSetCheck(RptSelCt!ckcSelC5(2).Value)
    imDR = gSetCheck(RptSelCt!ckcSelC5(3).Value)
    imPI = gSetCheck(RptSelCt!ckcSelC5(4).Value)
    imPSA = gSetCheck(RptSelCt!ckcSelC5(5).Value)
    imPromo = gSetCheck(RptSelCt!ckcSelC5(6).Value)
    imTrade = gSetCheck(RptSelCt!ckcSelC6(0).Value)
    imHold = gSetCheck(RptSelCt!ckcSelC3(0).Value)
    imOrder = gSetCheck(RptSelCt!ckcSelC3(1).Value)
    imAirTime = gSetCheck(RptSelCt!ckcSelC6(1).Value)
    imNTR = gSetCheck(RptSelCt!ckcSelC6(2).Value)
    imHardCost = gSetCheck(RptSelCt!ckcSelC6(3).Value)
    imInclPolit = gSetCheck(RptSelCt!ckcSelC12(0).Value)
    imInclNonPolit = gSetCheck(RptSelCt!ckcSelC12(1).Value)
    imInclAdj = gSetCheck(RptSelCt!ckcSelC10(0).Value)

    'filters for rvf/phf if adjustments requested
    tmTranTypes.iAdj = False
    tmTranTypes.iInv = False
    tmTranTypes.iWriteOff = False
    tmTranTypes.iPymt = False
    tmTranTypes.iCash = True
    tmTranTypes.iTrade = False
    tmTranTypes.iMerch = False
    tmTranTypes.iPromo = False
    tmTranTypes.iNTR = False         '9-17-02
    If imNTR Or imHardCost Then                   '4-25-05 need to gather the NTR for adjustments too
        tmTranTypes.iNTR = True
    End If
    If imInclAdj Then                   'incl rvf/phf adjustments (AN)
        tmTranTypes.iAdj = True
    End If
    If imTrade Then
        tmTranTypes.iTrade = True
    End If

    '10-1-01 Setup array of vehicles to process.  The spots are gathered by vehicle.
    'If option is by vehicle, only gather those selected.
    'if other than vehicle selection, need to gather all spots for all vehicles even if dormant.
    If RptSelCt!rbcSelCInclude(2).Value And RptSelCt!ckcAll.Value = vbUnchecked Then        'vehicle option, only gather those selected (if not all selected)
        ilUpper = 0
        For ilVehicle = 0 To RptSelCt!lbcSelection(3).ListCount - 1 Step 1
            If (RptSelCt!lbcSelection(3).Selected(ilVehicle)) Then
                slNameCode = tgVehicle(ilVehicle).sKey
                ilRet = gParseItem(slNameCode, 1, "\", slName)
                ilRet = gParseItem(slName, 3, "|", slName)
                ilRet = gParseItem(slNameCode, 2, "\", slCode)
                ilSelectedVefCodes(ilUpper) = Val(slCode)
                ilUpper = ilUpper + 1
                ReDim Preserve ilSelectedVefCodes(0 To ilUpper) As Integer
            End If
        Next ilVehicle
     Else
        'not vehicle option:  either slsp or advt or its vehicle option and all selected
        ilUpper = 0
        For ilVehicle = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
            'only need the conventional and selling vehicles.  6-9-06 add games to search.
            If tgMVef(ilVehicle).sType = "S" Or tgMVef(ilVehicle).sType = "C" Or tgMVef(ilVehicle).sType = "G" Or (tgMVef(ilVehicle).sType = "N" And (imNTR = True Or imHardCost = True)) Then
                ilSelectedVefCodes(ilUpper) = tgMVef(ilVehicle).iCode
                ilUpper = ilUpper + 1
                ReDim Preserve ilSelectedVefCodes(0 To ilUpper) As Integer
            End If
        Next ilVehicle
    End If

    '1-30-00
    imMajorSet = 0
    imMinorSet = 0
    illoop = RptSelCt!cbcSet1.ListIndex
    imMajorSet = tgVehicleSets1(illoop).iCode
    ilNumberPeriods = Val(RptSelCt!edcSelCTo.Text)   '# columns to print
    If ilNumberPeriods = 0 Then
        ilNumberPeriods = 13            'force to print everything if periods to print is blank
    End If
    '10-1-04 use new array of vehicles created for only those vehicles selected (if vehicle option)
    'or all selling & conv vehicles if by advt or slsp so that dormant vehicles with spots can be found
    If imAirTime Then
        For ilVehicle = 0 To UBound(ilSelectedVefCodes) - 1
            ilVefCode = ilSelectedVefCodes(ilVehicle)
            ReDim tmJsr(0 To 0) As JSR
            mGetSdfProjData ilVefCode, slStartDate, slEndDate, ilfilter
            'Output records
            mWriteJSRProj slGrossNet, ilNumberPeriods

        Next ilVehicle
    End If

    If imNTR Or imHardCost Then
        ReDim tmJsr(0 To 0) As JSR
        mGetNTRProjData ilSelectedVefCodes(), slStartDate, slEndDate, ilfilter, slGrossNet, ilNumberPeriods
    End If

    If imInclAdj Then                   'include rvf/phf adjustments
        ReDim tmJsr(0 To 0) As JSR
        gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slName       'convert last bdcst billing date to string
        If Trim$(slName) = "" Then
            slName = "1/1/1975"
        End If
        llLastBilled = gDateValue(slName)            'convert last month billed to long
        'determine what dates to gather adjustments (only prior to last billed date)
        '6-03-10 if the last billed date is within the requested span or the last bill date is in the future of the requested end date, process adjustments
        If llLastBilled > gDateValue(slStartDate) And llLastBilled <= gDateValue(slEndDate) Or (llLastBilled > gDateValue(slEndDate)) Then    'dont bother with adjustments if billperiod not part of run
            If llLastBilled < gDateValue(slEndDate) Then
                slEndDate = Format$(llLastBilled, "m/d/yy")
            End If
            mGetAdjProjData ilSelectedVefCodes(), slStartDate, slEndDate, ilfilter, slGrossNet, ilNumberPeriods
        End If
    End If

    Erase tmJsr
    Erase imAdfCode
    Erase imSelSlfCode, imSelAgfCode
    Erase lmChfCode
    Erase ilSelectedVefCodes
    ilRet = btrClose(hmAgf)
    ilRet = btrClose(hmJsr)
    ilRet = btrClose(hmSmf)
    ilRet = btrClose(hmSdf)
    ilRet = btrClose(hmVsf)
    ilRet = btrClose(hmVef)
    ilRet = btrClose(hmClf)
    ilRet = btrClose(hmCHF)
    ilRet = btrClose(hmCff)
    ilRet = btrClose(hmSbf)
    ilRet = btrClose(hmMnf)
    btrDestroy hmAgf
    btrDestroy hmJsr
    btrDestroy hmSmf
    btrDestroy hmSdf
    btrDestroy hmVsf
    btrDestroy hmVef
    btrDestroy hmClf
    btrDestroy hmCHF
    btrDestroy hmSbf
    btrDestroy hmMnf
End Sub

'***********************************************************************************************************************************
'
'                      gGetStartEndWeeks - ilCalType, ilperiod, ilYear, ilStartWks, ilEndWks
'                                          Calculate start and end weeks of a period (month or quarter, or week) given a year
'                                          or date (for weekly)
'                                          Return 2 arrays: one with start weeks of each period
'                                                           one with end weeks of each period
'                      <input> ilCalType - 1 = std, 2 = corp
'                              ilPeriod  - 1 = week, 2 = month, 3 = qtr
'                              ilYear - year to get weeks for (1996, 1997, 2000, etc)
'                      <output> ilStartWks(1 to 13) - start weeks of each period
'                               ilEndWks(1 to 13)  - end weeks of each period
'                       Created: 08/07/96 d.hosaka
'
'***********************************************************************************************************************************
Sub gGetStartEndWeeksCt(ilCalType As Integer, ilPeriod As Integer, ilYear As Integer, ilStartWk() As Integer, ilEndWk() As Integer)
    Dim slDate As String
    Dim slStart As String
    Dim slEnd As String
    Dim slPrevStart As String
    Dim illoop As Integer
    Dim ilWkNo As Integer
    Dim ilRet As Integer
    Dim ilAdjust As Integer
    Dim ilCorpWeeks As Integer
    
    If ilCalType = 1 Then                    'std
        'determine # weeks in each period (standard  month)
        slDate = "1/15/" & Trim$(str$(ilYear))
        slStart = gObtainStartStd(slDate)
        slPrevStart = slStart
        If ilPeriod = 2 Then          'std month
            For illoop = 1 To 13 Step 1
                slEnd = gObtainEndStd(slStart)
                If illoop = 1 Then
                    ilStartWk(1) = 1
                End If
                ilEndWk(illoop) = (gDateValue(slEnd) - gDateValue(slPrevStart) + 1) \ 7
                slStart = gIncOneDay(slEnd)
                If illoop < 13 Then
                    ilStartWk(illoop + 1) = ilEndWk(illoop) + 1
                End If
            Next illoop
            slStart = gIncOneDay(slEnd)
        ElseIf ilPeriod = 3 Then          'std quarter
                For illoop = 1 To 4 Step 1
                    For ilWkNo = 1 To 3 Step 1
                        slEnd = gObtainEndStd(slStart)
                        slStart = gIncOneDay(slEnd)
                    Next ilWkNo
                    If illoop = 1 Then
                        ilStartWk(1) = 1
                    End If
                    ilEndWk(illoop) = (gDateValue(slEnd) - gDateValue(slPrevStart) + 1) \ 7
                    slStart = gIncOneDay(slEnd)
                    ilStartWk(illoop + 1) = ilEndWk(illoop) + 1
                Next illoop
        Else                                               'std week
            slDate = RptSelCt!edcSelCTo.Text                 'user input
            ilRet = ((gDateValue(slDate) - gDateValue(slStart)) \ 7 + 1)    'get week index
            For illoop = 1 To 13 Step 1
                If illoop = 1 Then
                    ilStartWk(1) = 1
                    If ilRet <> 1 Then
                        ilStartWk(1) = ilRet
                    End If
                End If
                slEnd = gObtainNextSunday(slDate)        'obtain end of week
                ilEndWk(illoop) = (((gDateValue(slEnd) - gDateValue(slStart) + 1)) \ 7)
                slDate = gIncOneDay(slEnd)
                If illoop < 13 Then
                    ilStartWk(illoop + 1) = ilEndWk(illoop) + 1
                End If
            Next illoop
            slStart = gIncOneDay(slEnd)
        End If
    End If                                      'endif std
    If ilCalType = 2 Then            'corporate calendar
        'determine # weeks in each period corp period
        ilRet = gGetCorpCalIndex(ilYear)
        gUnpackDate tgMCof(ilRet).iStartDate(0, 0), tgMCof(ilRet).iStartDate(1, 0), slStart         'convert last bdcst billing date to string
        gUnpackDate tgMCof(ilRet).iEndDate(0, 11), tgMCof(ilRet).iEndDate(1, 11), slEnd
        slEnd = gObtainEndCorp(slStart, True)
        ilStartWk(1) = 1
        If ilPeriod = 2 Then      'corp month  (vs qtr)
            For illoop = 1 To 12 Step 1
                If illoop = 1 Then
                    ilEndWk(1) = (gDateValue(slEnd) - gDateValue(slStart) + 1) \ 7
                    ilAdjust = gWeekDayStr(slStart)
                    If ilAdjust <> 0 Then
                        ilEndWk(1) = ilEndWk(1) + 1   'adjust for week of 1/1 thru sunday, plus the
                                                                'remainder from divide
                    End If
                Else
                    slStart = gIncOneDay(slEnd)
                    slEnd = gObtainEndCorp(slStart, True)
                    ilStartWk(illoop) = ilEndWk(illoop - 1) + 1
                    ilEndWk(illoop) = (ilStartWk(illoop) + ((gDateValue(slEnd) - gDateValue(slStart) + 1) \ 7)) - 1
                End If
            Next illoop
            slStart = gIncOneDay(slEnd)
        ElseIf ilPeriod = 3 Then              'corp qtr
            For illoop = 1 To 4 Step 1
                For ilWkNo = 1 To 3 Step 1
                    If illoop = 1 And ilWkNo = 1 Then
                        ilCorpWeeks = (gDateValue(slEnd) - gDateValue(slStart) + 1) \ 7
                        ilAdjust = gWeekDayStr(slStart)
                        If ilAdjust <> 0 Then
                            ilCorpWeeks = ilCorpWeeks + 1   'adjust for week of 1/1 thru sunday, plus the
                                                                'remainder from divide
                        End If
                    Else
                        slStart = gIncOneDay(slEnd)
                        slEnd = gObtainEndCorp(slStart, True)
                        ilCorpWeeks = ilCorpWeeks + ((gDateValue(slEnd) - gDateValue(slStart) + 1) \ 7)
                    End If
                Next ilWkNo
                ilEndWk(illoop) = ilCorpWeeks
                ilStartWk(illoop + 1) = ilEndWk(illoop) + 1
                slStart = gIncOneDay(slEnd)
            Next illoop
        Else                                'corp week
            slDate = RptSelCt!edcSelCTo.Text          'user input date
            ilRet = ((gDateValue(slDate) - gDateValue(slStart)) \ 7 + 1)    'get week index
            For illoop = 1 To 13 Step 1
                    If illoop = 1 And ilRet <> 1 Then       'preset to "1" earlier
                        ilStartWk(1) = ilRet
                    End If
                    ilEndWk(illoop) = ilStartWk(illoop)
                    If illoop < 13 Then
                        ilStartWk(illoop + 1) = ilEndWk(illoop) + 1
                    End If
                    slEnd = gObtainNextSunday(slDate)
                    slDate = gIncOneDay(slEnd)
            Next illoop
            slDate = gIncOneDay(slEnd)
        End If
    End If
End Sub

Sub gJsrClearCt()
    Dim ilRet As Integer
    hmJsr = CBtrvTable(TEMPHANDLE)  '(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmJsr, "", sgDBPath & "Jsr.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmJsr)
        btrDestroy hmJsr
        Exit Sub
    End If
    ReDim tmJsr(0 To 0) As JSR
    imJsrRecLen = Len(tmJsr(0))
    tmJsrSrchKey.iGenDate(0) = igNowDate(0)
    tmJsrSrchKey.iGenDate(1) = igNowDate(1)
    gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
    tmJsrSrchKey.lGenTime = lgNowTime
    ilRet = btrGetGreaterOrEqual(hmJsr, tmJsr(0), imJsrRecLen, tmJsrSrchKey, INDEXKEY0, BTRV_LOCK_NONE)
    Do While (ilRet = BTRV_ERR_NONE) And (tmJsr(0).iGenDate(0) = igNowDate(0)) And (tmJsr(0).iGenDate(1) = igNowDate(1)) And (tmJsr(0).lGenTime = lgNowTime)
        ilRet = btrDelete(hmJsr)
        ilRet = btrGetNext(hmJsr, tmJsr(0), imJsrRecLen, BTRV_LOCK_NONE, SETFORWRITE)
    Loop
    Erase tmJsr
    ilRet = btrClose(hmJsr)
    btrDestroy hmJsr
End Sub

'           mBobOpenFiles - open files applicable to Billed & Booked
'                           Commission Projection, and Sales Comparison,
'                           B & B Recap, Sales Placement
Function gOpenBOBFilesCt() As Integer
    Dim ilRet As Integer
    Dim slStr As String
    Dim ilError As Integer
    Dim ilListIndex As Integer
    Dim slStamp As String
    Dim illoop As Integer
    Dim slTemp As String

    ilListIndex = RptSelCt!lbcRptType.ListIndex     'report option from CONTRACTSJOB or SLSPCOMMSJOB task
    ilError = False

    On Error GoTo gOpenBOBFilesErr
    '1-27-07 implement ntr selectivity in sales compare
    If ((ilListIndex = CNT_BOB Or ilListIndex = CNT_BOBRECAP Or ilListIndex = CNT_SALESCOMPARE Or ilListIndex = CNT_BOBCOMPARE) And (igRptCallType = CONTRACTSJOB)) Or ((ilListIndex = COMM_PROJECTION Or ilListIndex = COMM_SALESCOMM) And (igRptCallType = SLSPCOMMSJOB)) Then              'billed and bookd may have NTR billing (ITEM billing)
        hmSbf = CBtrvTable(TEMPHANDLE)  '(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmSbf, "", sgDBPath & "Sbf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            ilError = ilRet
        End If
        imSbfRecLen = Len(tmSbf)
    End If
    
    ilRet = Asc(tgSaf(0).sFeatures8)
    If (((ilRet And PODCASTCPMTAG) = PODCASTCPMTAG) Or ((ilRet And PODCASTCPMTAG) = PODCASTCPMTAG)) And ilListIndex = CNT_BOB Then    'using cpm podcasts
        'open  podcast cpm file
        hmPcf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmPcf, "", sgDBPath & "Pcf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            ilError = ilRet
        End If
    End If

    hmGrf = CBtrvTable(TEMPHANDLE)  '(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmGrf, "", sgDBPath & "Grf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imGrfRecLen = Len(tmGrf)
    hmRvf = CBtrvTable(ONEHANDLE) 'CBtrvObj()            'read History files using RVF handles and buffers
    ilRet = btrOpen(hmRvf, "", sgDBPath & "Phf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imRvfRecLen = Len(tmRvf)
    hmCHF = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCHF, "", sgDBPath & "Chf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imCHFRecLen = Len(tmChf)

    hmSlf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSlf, "", sgDBPath & "Slf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imSlfRecLen = Len(tmSlf)
    hmVef = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVef, "", sgDBPath & "Vef.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imVefRecLen = Len(tmVef)

    hmMnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmMnf, "", sgDBPath & "Mnf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imMnfRecLen = Len(tmMnf)
    hmSof = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSof, "", sgDBPath & "Sof.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imSofRecLen = Len(tmSof)
    hmClf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmClf, "", sgDBPath & "Clf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imClfRecLen = Len(tmClf)
    hmCff = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCff, "", sgDBPath & "Cff.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imCffRecLen = Len(tmCff)
    hmAgf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmAgf, "", sgDBPath & "Agf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imAgfRecLen = Len(tmAgf)
    hmSdf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSdf, "", sgDBPath & "Sdf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imSdfRecLen = Len(tmSdf)
    hmSmf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSmf, "", sgDBPath & "Smf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imSmfRecLen = Len(tmSmf)

    'open VSF if contract needs to check whether user can see the contract
    hmVsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVsf, "", sgDBPath & "Vsf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imVsfRecLen = Len(tmVsf)
    On Error GoTo 0

    imInclZero = False                          '4-26-13 default to Include $0 contracts on B & B (goes thru common routine to write out record for different versions of B & B)
    imAdjustAcquisition = False                 'this is for the net-net or triple-net options
    imUseAcquisitionCost = False                'assume using normal gross/net values from rvf/phf and sch lines (vs acquisition costs)
                                                'this option is used to verify the acquisition $ entered in receivables and lines

    '10-2-06 assume to include all politicals/non-politicals
    imInclPolit = True
    imInclNonPolit = True

    'Comm Projection doesnt ask question, but defaults to Net
    If RptSelCt!rbcSelC7(0).Value Then
        smGrossOrNet = "G"

    'Net-net, vehicle option, set in B & B processing below
    'ElseIf RptSelCt!rbcSelC7(2).Value = True And RptSelCt!rbcSelCInclude(2).Value = True Then
    '    smGrossOrNet = "B"                      '2-26-01 This version of net-net shows only one side of the owners share
                                                'both gross and net values are shown on separate lines
    ElseIf RptSelCt!rbcSelC7(1).Value Then
         smGrossOrNet = "N"
              '2-26-01 This version of net-net shows only one side of the owners share
                                                'both gross and net values are shown on separate lines
    End If

    imSubSort = 0           'assume no secondary sorting (Sales Comparison)
    imPrimSort = 0
    imAdvt = False
    imSlsp = False
    imVehicle = False
    imOwner = False
    imVehSub = False                'sub total by vehicle for slsp option (12/24/98)
    imAgency = False
    imBusCat = False
    imProdProt = False
    imVehGroup = False
    imAirTime = True        '11-25-02   unless asked, always include the air time
    imNTR = False           '11-25-02
    imTrikIfOwner = False   '10-21-03   Init for re-entrant
    imHardCost = False      '3-21-05

    ReDim tgBBCompare(0 To 0) As BBCOMPARE      '4-15-09

    '11-17-06 Billed and Booked sort options changed from radio buttons to list box due to space
    'The list box answer has been mapped back into the the radio buttons for processing
    'Sort     List box index     radio button index   smGrossNet
    'Advt          0                   0               G, N or T(t-net)
    'Agency        1                   5               G, N or T(t-net)
    'Owner         2                   3               G, N or T(t-net)
    'Slsp          3                   1               G, N or T(t-net)
    'Vehicle       4                   2               G, N or T(t-net)
    'veh/net-net   5                   2               B show 4 lines per vehicle (gross, net, owners share and net-net)
    'veh/particip  6                   4               G, N or T(t-net)
    igSwapBOBOption = False         '8-6-10 If default as no special swapping of options taking place.
                                        'this is used if Vehicle option, with slsp subtotals w/splits
                                        'trick to change options as tho  slsp is the main sort with splits
    If ((ilListIndex = CNT_BOB) And (igRptCallType = CONTRACTSJOB)) Then        'Billed & Booked, various sort options

        '6-8-06 set the adjustacquistion flag if:  Vehicle option (rbcselcInclude(2) & net-net rbcselc(2), OR
        'If (RptSelCt!rbcSelCInclude(2).Value = True And RptSelCt!rbcSelC7(2).Value = True) Then
       If (RptSelCt!rbcSelCInclude(6).Value = True And RptSelCt!rbcSelC7(2).Value = True) Then
            smGrossOrNet = "B"                            'need to see a line for gross, net & netnet
            'do not adjust acquisition for the 4-line version (gross/net/comm/net-net), so it truly it a net-net report.
            'if acquistion is to be added later, it needs to show a new line with the acquistion costs
            'i.e. Lines will be:  gross, net, acq $, %comm, t-net
            'imAdjustAcquisition = True
            imVehicle = True
        'B & B other than vehicle net-net; see if t-net selected for other sort
        ElseIf RptSelCt!rbcSelC7(2).Value = True Then       'test for triple net
            smGrossOrNet = "T"
            imAdjustAcquisition = True
        End If

        If RptSelCt!rbcSelCInclude(0).Value Then
            imAdvt = True
        ElseIf RptSelCt!rbcSelCInclude(1).Value Then
            imSlsp = True
            If RptSelCt!ckcSelC10(1).Value = vbChecked Then 'subtotals by vehicle?
                imVehSub = True
            End If

        ElseIf RptSelCt!rbcSelCInclude(2).Value Then
            imVehicle = True
            '8-6-10 Vehicle option, if subtotals by slsp along with splits requested, fake out code to do the slsp option and splits
            '2-8-16 Cannot have Vehicle sort, with both Participant VG and Slsp splits (either vehicle sort with participant VG, or vehicle sort with slsp splits).  Design doesnt
            'allow for 2 levels of splits, except for net net (which is a different scenario)
            If RptSelCt!ckcSelC10(0).Value = vbChecked And RptSelCt!ckcSelC10(1).Value = vbChecked Then
                igSwapBOBOption = True
                imVehicle = False
                'change to slsp option with vehicle subtotals
                imSlsp = True
                imVehSub = True
            End If
            illoop = RptSelCt!cbcSet1.ListIndex             'retrieve the vehicle set selected (applies to vehicle option)
            If tgVehicleSets1(illoop).iCode = 1 Then        '2-16-16 participant vehicle group selected
                imTrikIfOwner = True
            End If
            
        ElseIf RptSelCt!rbcSelCInclude(4).Value Then   '8-4-00     vehicle/participant
            imVehicle = True
            imTrikIfOwner = True
        ElseIf RptSelCt!rbcSelCInclude(5).Value Then   '4-12-02
            imAgency = True
        ElseIf RptSelCt!rbcSelCInclude(3).Value Then    'rbcselcInclude(3)                  '
            imOwner = True
        End If
        If RptSelCt!ckcSelC13(0).Value = vbChecked Then     'use the acquisition cost instead of rvf gross/net and sch line rates
            imUseAcquisitionCost = True
        End If

        '10-2-06
        imInclPolit = gSetCheck(RptSelCt!ckcSelC12(0).Value)       'include politicals
        imInclNonPolit = gSetCheck(RptSelCt!ckcSelC12(1).Value)       'include non-politicals
        imInclZero = gSetCheck(RptSelCt!ckcInclZero.Value)          '4-26-13 Include $0 contracts on detail
    ElseIf ((ilListIndex = CNT_BOBRECAP) And (igRptCallType = CONTRACTSJOB)) Then   'Billed & booked recap
        If RptSelCt!rbcSelC7(2).Value = True Then          'triple-net?
            imAdjustAcquisition = True
            smGrossOrNet = "T"
        End If

    ElseIf ((ilListIndex = CNT_SALESPLACEMENT) And (igRptCallType = CONTRACTSJOB)) Then   'Sales Placement
        If RptSelCt!rbcSelC7(2).Value = True Then          'triple-net?
            imAdjustAcquisition = True
            smGrossOrNet = "T"          '11-17-06 chged from "D" to "T" (triple net flag)
        End If
    ElseIf ((ilListIndex = CNT_SALESCOMPARE Or ilListIndex = CNT_BOBCOMPARE) And (igRptCallType = CONTRACTSJOB)) Then      'Sales Comparison
        If RptSelCt!rbcSelC7(2).Value = True Then          'triple-net?
            imAdjustAcquisition = True
            smGrossOrNet = "T"
        End If
        '1-27-07 chg the control political/non-politcal is in
        imInclPolit = gSetCheck(RptSelCt!ckcSelC12(0).Value)       'include politicals
        imInclNonPolit = gSetCheck(RptSelCt!ckcSelC12(1).Value)       'include non-politicals

    End If

    'Billed & Booked Commissions
    If (ilListIndex = COMM_PROJECTION And igRptCallType = SLSPCOMMSJOB) Then        'Billed & Booked?
        'Always defaults to NET
        'If RptSelCt!rbcSelC7(1).Value = True Then       'net
            imAdjustAcquisition = True
        'End If
    End If

    ilRet = gObtainMnfForType("I", slStamp, tlMMnf())        'NTR Item types

    If ilListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB Then '4-18-05
        'force options to similate slsp in the event that minor sort is salesperson and it
        'needs to split the revenue.
        'Test for each option to set option flag for major option because of
        'forcing slsp flag if its the minor sort
        If RptSelCt!cbcSet1.ListIndex = 4 Or RptSelCt!cbcSet2.ListIndex = 5 Then    'major or minor selection is by slsp
            imSlsp = True
        End If
        If RptSelCt!cbcSet1.ListIndex = 0 Then         'advt
            imAdvt = True
        End If
        If RptSelCt!cbcSet1.ListIndex = 1 Then          'agency
            imAgency = True
        End If
        If RptSelCt!cbcSet1.ListIndex = 2 Then          'bus cat
            imBusCat = True
        End If
        If RptSelCt!cbcSet1.ListIndex = 3 Then          'prod prot
            imProdProt = True
        End If
        If RptSelCt!cbcSet1.ListIndex = 5 Or RptSelCt!cbcSet1.ListIndex = 5 Then
            imVehicle = True
        End If
        If RptSelCt!cbcSet1.ListIndex = 6 Then         'vehicle group
            imVehGroup = True
        End If

        imSubSort = RptSelCt!cbcSet2.ListIndex          'Sales Comparison major sort field
        imPrimSort = RptSelCt!cbcSet1.ListIndex         'sales comparison minor sort field

        '04-20-07 force type of calendar to standard only (no corp or calendar option)
'        RptSelCt!rbcSelC9(1).Value = True           'turn on standard
    ElseIf ilListIndex = CNT_SALESPLACEMENT And igRptCallType = CONTRACTSJOB Then       '4-19-05
        'imAdvt = True       ' this report is gathered by advt , no splits
        imVehicle = True
        imHold = True       'include all contract types except PSA & promos
        imOrder = True
        imStandard = True
        imReserv = True
        imRemnant = True
        imDR = True
        imPI = True
        imPSA = False
        imPromo = False
        imTrade = True
        imAirTime = True                'always include air time
        imNTR = False                   'always exclude ntr

    ElseIf ilListIndex = CNT_BOBRECAP And igRptCallType = CONTRACTSJOB Then     '4-18-05
        'B & B recap -include everything except Psa & promos
        'imAgency = False                     'force to output by agency, 11-06-06 chg to vehicle
        imVehicle = True                     '11-06-06
        'since the Recap doesnt allow any specials sorts, it is being force to be by vehicle to
        'process in the prepass.  Default vehicle groups to avoid subscript errors
        gPopVehicleGroups RptSelCt!cbcSet1, tgVehicleSets1(), True
        RptSelCt!cbcSet1.ListIndex = 0

    ElseIf ilListIndex = CNT_BOBCOMPARE And igRptCallType = CONTRACTSJOB Then
        If RptSelCt!cbcSet2.ListIndex = 4 Then     ' slsp
            imSlsp = True
        ElseIf RptSelCt!cbcSet2.ListIndex = 0 Then         'advt
            imAdvt = True
        ElseIf RptSelCt!cbcSet2.ListIndex = 1 Then          'agency
            imAgency = True
        ElseIf RptSelCt!cbcSet2.ListIndex = 2 Then          'bus cat
            imBusCat = True
        ElseIf RptSelCt!cbcSet2.ListIndex = 3 Then          'prod prot
            imProdProt = True
        ElseIf RptSelCt!cbcSet2.ListIndex = 5 Then          'vehicle
            imVehicle = True
        End If

        'save the budget selected
        igBSelectedIndex = -1
        'see if any budgets selected, optional.
        For illoop = 0 To RptSelCt!lbcSelection(4).ListCount - 1 Step 1
            If RptSelCt!lbcSelection(4).Selected(illoop) Then
                'get the mnfCode to pick up budget record
                slTemp = RptSelCt!lbcSelection(4).List(illoop)          '11-30-16 get the year of the budget selected
                ilRet = gParseItem(slTemp, 2, "/", slStr)
                igBYear = Val(slStr)
                slTemp = tgRptSelBudgetCodeCT(illoop).sKey
                ilRet = gParseItem(slTemp, 2, "\", slStr)      'obtain budget name for comparisons
                igBSelectedIndex = Val(slStr)
            End If
        Next illoop


    ElseIf ilListIndex = COMM_PROJECTION And igRptCallType = SLSPCOMMSJOB Then                                '11-12-05 billed & booked commissions
        If RptSelCt!rbcSelCInclude(0).Value Then
            imAdvt = True
        ElseIf RptSelCt!rbcSelCInclude(1).Value Then
            imSlsp = True
            If RptSelCt!ckcSelC10(1).Value = vbChecked Then
                imVehSub = True
            End If

        ElseIf RptSelCt!rbcSelCInclude(2).Value Then
            imVehicle = True
        ElseIf RptSelCt!rbcSelCInclude(4).Value Then   '8-4-00
            imVehicle = True
            imTrikIfOwner = True
        ElseIf RptSelCt!rbcSelCInclude(5).Value Then   '4-12-02
            imAgency = True
        ElseIf RptSelCt!rbcSelCInclude(3).Value = True Then
            imOwner = True
        End If

    End If
    'If ilListIndex <> CNT_SALESPLACEMENT And igRptCallType <> CONTRACTSJOB Then
    '10-14-02 ContractsJOB & SALESCOMMISSIONS need to go thru here, ignore only for Sales Placement report
    If igRptCallType = CONTRACTSJOB And ilListIndex = CNT_SALESPLACEMENT Then
        'do nothing
    'ElseIf Not (igRptCallType = CONTRACTSJOB And ilListIndex = CNT_BOBRECAP) Then          'billed & booked, sales comparison or billed & booked commissions
    Else            'all versions of B & B / RECAP tests the contract types
        imHold = False
        imOrder = False
        imStandard = False
        imReserv = False
        imRemnant = False
        imDR = False
        imPI = False
        imPSA = False
        imPromo = False
        imTrade = False
        imNTR = False           '11-25-02
        imAirTime = True        '11-25-02  normal reports should always include Air Time (vs NTR) unless there is selectivity to
                                'exclude the Air Time
        If RptSelCt!ckcSelC3(0).Value = vbChecked Then
            imHold = True
        End If
        If RptSelCt!ckcSelC3(1).Value = vbChecked Then
            imOrder = True
        End If
        If RptSelCt!ckcSelC5(0).Value = vbChecked Then  'include std cntrs?
            imStandard = True
        End If
        If RptSelCt!ckcSelC5(1).Value = vbChecked Then   'include reserves?
            imReserv = True
        End If
        If RptSelCt!ckcSelC5(2).Value = vbChecked Then   'include remnants?
            imRemnant = True
        End If
        If RptSelCt!ckcSelC5(3).Value = vbChecked Then   'direct response?
            imDR = True
        End If
        If RptSelCt!ckcSelC5(4).Value = vbChecked Then   'per inquiry?
            imPI = True
        End If
        If RptSelCt!ckcSelC5(5).Value = vbChecked Then   'psa?
            imPSA = True
        End If
        If RptSelCt!ckcSelC5(6).Value = vbChecked Then  'promo?
            imPromo = True
        End If
        If RptSelCt!ckcSelC6(0).Value = vbChecked Then   'trades?
            imTrade = True
        End If
        '1-27-07 Sales compare has same contract type selectivity as billed & booked
        If ((ilListIndex = CNT_BOB Or ilListIndex = CNT_BOBRECAP Or ilListIndex = CNT_SALESCOMPARE Or ilListIndex = CNT_BOBCOMPARE) And (igRptCallType = CONTRACTSJOB)) Then          '11-09-06Recap now has same contract type selectivity as B&B
            If RptSelCt!ckcSelC6(1).Value = vbUnchecked Then   'Air Time?
                imAirTime = False
            End If
            If RptSelCt!ckcSelC6(2).Value = vbChecked Then   'NTR
                imNTR = True
            End If
            If RptSelCt!ckcSelC6(3).Value = vbChecked Then   'hard cost
                imHardCost = True
            End If
        ElseIf ilListIndex = COMM_PROJECTION And igRptCallType = SLSPCOMMSJOB Then
            '11-25-02 Billed & Booked Commissions should include NTR & Air Time commission calculation
            imNTR = True
            imAirTime = True
        End If
    End If
    If ilListIndex = CNT_SALESCOMPARE Then
        slStr = RptSelCt!edcSelCTo1.Text            'single contract #
    ElseIf ilListIndex = CNT_SALESPLACEMENT Then
        slStr = RptSelCt!edcTopHowMany.Text              'single cntr #
    ElseIf ilListIndex = CNT_BOBCOMPARE Then            'single contract #
        slStr = RptSelCt!edcSelCTo1.Text
    Else                                    'billed & booked - sales comm proj.
        slStr = RptSelCt!edcSelCTo.Text
    End If
    If slStr = "" Then
        lmSingleCntr = 0
    Else
        lmSingleCntr = CLng(slStr)
    End If
    
    lgSTime1 = 0
    lgSTime2 = 0
    lgSTime3 = 0
    lgSTime4 = 0
    lgSTime5 = 0
    lgSTime6 = 0
    
    lgETime1 = 0
    lgETime2 = 0
    lgETime3 = 0
    lgETime4 = 0
    lgETime5 = 0
    lgETime6 = 0
    
    lgTtlTime1 = 0
    lgTtlTime2 = 0
    lgTtlTime3 = 0
    lgTtlTime4 = 0
    lgTtlTime5 = 0
    lgTtlTime6 = 0
    
    Exit Function

gOpenBOBFilesErr:
    ilRet = btrClose(hmGrf)
    ilRet = btrClose(hmRvf)
    ilRet = btrClose(hmCHF)
    ilRet = btrClose(hmSlf)
    ilRet = btrClose(hmVef)
    ilRet = btrClose(hmMnf)
    ilRet = btrClose(hmSof)
    ilRet = btrClose(hmClf)
    ilRet = btrClose(hmCff)
    ilRet = btrClose(hmAgf)
    ilRet = btrClose(hmSdf)
    ilRet = btrClose(hmSmf)
    btrDestroy hmGrf
    btrDestroy hmRvf
    btrDestroy hmCHF
    btrDestroy hmSlf
    btrDestroy hmVef
    btrDestroy hmMnf
    btrDestroy hmSof
    btrDestroy hmClf
    btrDestroy hmCff
    btrDestroy hmAgf
    btrDestroy hmSdf
    btrDestroy hmSmf
    gOpenBOBFilesCt = ilError
End Function

'                   gSalesCPPCPMGen - Generate prepass file for
'                   Sales Analysis by CPM & CPM
'                   This report generated CPP and CPMs for each
'                   demo category with and without remmants, PIs,
'                   and Direct responses.
'
'                   4/10/98 Exclude 100% trade contracts
'                   1-13-04 change to retrieve only current lines (not history)
'                   6-4-04 Implement Demo Estimates
Sub gSalesCppCpmGen()
    Dim ilRet As Integer
    Dim ilFoundCnt As Integer               'valid contract to process
    Dim ilCurrentRecd As Integer            'number of contracts processed so far
    Dim illoop As Integer                   'temp loop variable
    Dim ilLoop2 As Integer                  'temp loop variable
    Dim ilLoop3 As Integer                  'temp loop variable
    Dim llContrCode As Long                 'Contr ID to process
    Dim slStartDate As String               'Contract start date
    Dim slEndDate As String                 'contract end date
    Dim llStartDate As Long                 'quarter requested start date
    Dim llEndDate As Long                   'quarter reqested end date
    Dim ilClf As Integer                    'loop for lines
    Dim ilCff As Integer                    'loop for flights
    Dim slStr As String                     'temp string for conversions
    Dim llDate As Long                      'temp serial date
    Dim llDate2 As Long
    Dim ilDay As Integer
    Dim slNameCode As String
    Dim slCode As String
    Dim slCntrType As String                'valid contract types (per inq, direct respon, etc) to retrieve
    Dim slCntrStatus As String              'valid contr status (working, complete, etc) to retrieve
    Dim ilHOState As Integer                'which type of Holds Orders to retrieved (internally WCI)
    Dim llPop As Long                       'population obtained per schedule line
    Dim llAvgAud As Long                    'avg audience obtained per flight
    Dim llGetTo As Long                     'test contract's date entered against this span
    Dim llGetFrom As Long                   'test contract's date entered against this span
    Dim ilMonth As Integer
    Dim ilYear As Integer
    Dim ilCorpStd As Integer                '1 = corp, 2 = std
    Dim llFltStart As Long
    Dim llFltEnd As Long
    Dim ilSpots As Integer
    Dim llOvStartTime As Long
    Dim llOvEndTime As Long
    ReDim llDateS(0 To 2) As Long        'quarter dates. Index zero ignored
    ReDim ilInputDays(0 To 6) As Integer    'valid days of the week for audience retrieval
    Dim ilUpperWk As Integer
    Dim llTemp As Long
    Dim ilWinx As Integer
    Dim ilWOInx As Integer
    Dim llTotalCPP As Long
    Dim llTotalCPM As Long
    Dim llTotalGrImp As Long
    Dim llTotalGRP As Long
    'Dim llTotalCost As Long
    Dim dlTotalCost As Double 'TTP 10439 - Rerate 21,000,000
    Dim llTotalAvgAud As Long
    Dim ilTotalAvgRtg As Integer
    Dim llLnSpots As Long
    Dim ilTotLnSpts As Integer
    Dim ilCorpCalInx As Integer               'index into tgCof for the year processing
    Dim slTYStartYr As String                 'start of corp or std year
    Dim slTYEndYr As String                   'end of corp or std year
    ReDim ilEffDate(0 To 1) As Integer            'Effective date entered stored as btrieve date
    Dim llPopEst As Long
    Dim ilAudFromSource As Integer
    Dim llAudFromCode As Long
    Dim llRate As Long
    Dim slGrossNet As String * 1              '1-26-19 gross or net option
    
    hmCHF = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCHF, "", sgDBPath & "Chf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmCHF)
        btrDestroy hmCHF
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imCHFRecLen = Len(tmChf)
    ReDim tgClfCT(0 To 0) As CLFLIST
    tgClfCT(0).iStatus = -1 'Not Used
    tgClfCT(0).lRecPos = 0
    tgClfCT(0).iFirstCff = -1
    ReDim tgCffCT(0 To 0) As CFFLIST
    tgCffCT(0).iStatus = -1 'Not Used
    tgCffCT(0).lRecPos = 0
    tgCffCT(0).iNextCff = -1
    hmClf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmClf, "", sgDBPath & "Clf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmClf
        btrDestroy hmCHF
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imClfRecLen = Len(tgClfCT(0).ClfRec)
    hmCff = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCff, "", sgDBPath & "Cff.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imCffRecLen = Len(tgCffCT(0).CffRec)
    hmMnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmMnf, "", sgDBPath & "Mnf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmMnf)
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmMnf
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imMnfRecLen = Len(tmMnf)
    hmUrf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmUrf, "", sgDBPath & "Urf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmUrf)
        ilRet = btrClose(hmMnf)
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmUrf
        btrDestroy hmMnf
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imUrfRecLen = Len(tmUrf)
    hmCbf = CBtrvTable(TEMPHANDLE)  '(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCbf, "", sgDBPath & "Cbf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmCbf)
        ilRet = btrClose(hmUrf)
        ilRet = btrClose(hmMnf)
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmCbf
        btrDestroy hmUrf
        btrDestroy hmMnf
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imCbfRecLen = Len(tmCbf)
    hmDrf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmDrf, "", sgDBPath & "Drf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmDrf)
        ilRet = btrClose(hmCbf)
        ilRet = btrClose(hmUrf)
        ilRet = btrClose(hmMnf)
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmDrf
        btrDestroy hmCbf
        btrDestroy hmUrf
        btrDestroy hmMnf
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imDrfRecLen = Len(tmDrf)
    hmDpf = CBtrvTable(ONEHANDLE) 'CBtrvObj()     '7-23-01
    ilRet = btrOpen(hmDpf, "", sgDBPath & "Dpf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmDpf)
        ilRet = btrClose(hmDrf)
        ilRet = btrClose(hmCbf)
        ilRet = btrClose(hmUrf)
        ilRet = btrClose(hmMnf)
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmDpf
        btrDestroy hmDrf
        btrDestroy hmCbf
        btrDestroy hmUrf
        btrDestroy hmMnf
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imDpfRecLen = Len(tmDpf)
    hmDef = CBtrvTable(ONEHANDLE) 'CBtrvObj()     '7-23-01
    ilRet = btrOpen(hmDef, "", sgDBPath & "Def.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmDef)
        ilRet = btrClose(hmDpf)
        ilRet = btrClose(hmDrf)
        ilRet = btrClose(hmCbf)
        ilRet = btrClose(hmUrf)
        ilRet = btrClose(hmMnf)
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmDef
        btrDestroy hmDpf
        btrDestroy hmDrf
        btrDestroy hmCbf
        btrDestroy hmUrf
        btrDestroy hmMnf
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    hmRaf = CBtrvTable(ONEHANDLE) 'CBtrvObj()     '7-23-01
    ilRet = btrOpen(hmRaf, "", sgDBPath & "Raf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmDef)
        ilRet = btrClose(hmDpf)
        ilRet = btrClose(hmDrf)
        ilRet = btrClose(hmCbf)
        ilRet = btrClose(hmUrf)
        ilRet = btrClose(hmMnf)
        ilRet = btrClose(hmCff)
        ilRet = btrClose(hmClf)
        ilRet = btrClose(hmCHF)
        btrDestroy hmRaf
        btrDestroy hmDef
        btrDestroy hmDpf
        btrDestroy hmDrf
        btrDestroy hmCbf
        btrDestroy hmUrf
        btrDestroy hmMnf
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmCHF
        Screen.MousePointer = vbDefault
        Exit Sub
    End If

    '7-23-01 setup global variable for Demo Plus file (to see if any exists)
    lgDpfNoRecs = btrRecords(hmDpf)
    If lgDpfNoRecs = 0 Then
        lgDpfNoRecs = -1
    End If

    If RptSelCt!edcTopHowMany <> "" Then                      '6-4-04
        lmSingleCntr = CLng(RptSelCt!edcTopHowMany)
    End If
    
    slGrossNet = "G"                                '1-25-19 Implement gross net option; default to gross
    If RptSelCt!rbcSelC4(1).Value Then
        slGrossNet = "N"
    End If


    If RptSelCt!rbcSelCInclude(0).Value Then        'corp
        ilCorpStd = 1
        ilCorpCalInx = gGetCorpCalIndex(igYear)
    Else
        ilCorpStd = 2
    End If
    slStr = RptSelCt!CSI_CalFrom.Text       'Date: 12/10/2019 added CSI calendar control for date entry --> edcSelCFrom.Text               'effective date entred
    'obtain the entered dates year based on the std month
    llGetTo = gDateValue(slStr)                     'gather contracts thru this date
    slStr = Format$(llGetTo, "m/d/yy")               'reformat date to insure year is there
    gPackDate slStr, ilEffDate(0), ilEffDate(1)

    slStr = gObtainEndStd(Format$(llGetTo, "m/d/yy"))
    gObtainMonthYear 0, slStr, ilMonth, ilYear           'get year  of effective date (to figure out the beginning of std year)
    slStr = "1/15/" & Trim$(str$(ilYear))                 'Jan of std year effective dat entered
    If ilCorpStd = 1 Then
        'gUnpackDate tgMCof(ilCorpCalInx).iStartDate(0, 1), tgMCof(ilCorpCalInx).iStartDate(1, 1), slStr         'convert last bdcst billing date to string
        gUnpackDate tgMCof(ilCorpCalInx).iStartDate(0, 0), tgMCof(ilCorpCalInx).iStartDate(1, 0), slStr         'convert last bdcst billing date to string
        llGetFrom = gDateValue(gObtainStartCorp(slStr, True))  'gather contracts from this date thru effective entered date
        illoop = (igMonthOrQtr - 1) * 3 + 1             'determine starting month based on qtr entred
        gUnpackDate tgMCof(ilCorpCalInx).iStartDate(0, illoop - 1), tgMCof(ilCorpCalInx).iStartDate(1, illoop - 1), slStr     'convert last bdcst billing date to string
        llDateS(1) = gDateValue(gObtainStartCorp(slStr, True))  'gather contracts from this date thru effective entered date
        gGetStartEndYear 1, ilYear, slTYStartYr, slTYEndYr       'obtain the requested years start and end dates for corp
    Else
        llGetFrom = gDateValue(gObtainStartStd(slStr))  'gather contracts from this date thru effective entered date
        ilYear = Val(RptSelCt!edcSelCTo.Text)           'year requested
        'Determine this years quarter span
        illoop = (igMonthOrQtr - 1) * 3 + 1             'determine starting month based on qtr entred
        slStr = Trim$(str$(illoop)) & "/15/" & Trim$(RptSelCt!edcSelCTo.Text)
        llDateS(1) = gDateValue(gObtainStartStd(slStr))
        gGetStartEndYear 2, ilYear, slTYStartYr, slTYEndYr       'obtain the requested years start and end dates for std
    End If
    llDateS(2) = llDateS(1) + 90                'end date of this year's quarter requested
    slStartDate = Trim$(Format$(llDateS(1), "m/d/yy"))
    slEndDate = Trim$(Format$(llDateS(2), "m/d/yy"))
    llStartDate = gDateValue(slStartDate)           'convert string date to long for date comparisons
    llEndDate = gDateValue(slEndDate)               'convert string end date to long for date comparisons
    slCntrType = gBuildCntTypes()
    slCntrStatus = "HOGN"              'only get holds and orders
    ilHOState = 2                  'get latest orders and revisions
    ilRet = gObtainCntrForDate(RptSelCt, slStartDate, slEndDate, slCntrStatus, slCntrType, ilHOState, tlChfAdvtExt())

    ReDim tlWList(0 To 0) As RESEARCHINFO           'list of Research totals with Remnants, DR, PI ( 1 cnt at a time)
    ReDim tlWOList(0 To 0) As RESEARCHINFO          'list of Research totals without Remnants, DR, PI  (1 cnt at a time)

    For ilCurrentRecd = LBound(tlChfAdvtExt) To UBound(tlChfAdvtExt) - 1 Step 1                                           'loop while llCurrentRecd < llRecsRemaining
        'check for valid demo selection
        If (RptSelCt!ckcAll.Value = vbChecked) Then
            '6-4-04 implement single contract option for debugging
            If lmSingleCntr > 0 And lmSingleCntr <> tlChfAdvtExt(ilCurrentRecd).lCntrNo Then
                ilFoundCnt = False
            Else
                ilFoundCnt = True
                llContrCode = tlChfAdvtExt(ilCurrentRecd).lCode
                llContrCode = gPaceCntr(tlChfAdvtExt(ilCurrentRecd).lCntrNo, llGetTo, hmCHF, tmChf)
                If llContrCode > 0 Then
                    '1-13-04 change to retrieve only current lines (not history)
                    ilRet = gObtainCntr(hmCHF, hmClf, hmCff, llContrCode, False, tgChfCT, tgClfCT(), tgCffCT(), False)  '8-28-12 do not sort by special dp order
                    'convert date entered to long
                    gUnpackDateLong tgChfCT.iOHDDate(0), tgChfCT.iOHDDate(1), llTemp

                    If tgChfCT.iMnfDemo(0) = 0 Or llTemp > llGetTo Then      'if demo doesnt exist or the date entered is later than requested
                        ilFoundCnt = False
                    End If
                Else
                    ilFoundCnt = False
                End If
            End If
        Else
            If lmSingleCntr > 0 And lmSingleCntr <> tlChfAdvtExt(ilCurrentRecd).lCntrNo Then
                ilFoundCnt = False
            Else
                ilFoundCnt = False                             'assume nothing found until match in demo selection table
                For illoop = 0 To RptSelCt!lbcSelection(11).ListCount - 1 Step 1
                    If RptSelCt!lbcSelection(11).Selected(illoop) Then
                        slNameCode = tgRptSelDemoCodeCT(illoop).sKey
                        ilRet = gParseItem(slNameCode, 2, "\", slCode)
                        If Val(slCode) = tlChfAdvtExt(ilCurrentRecd).iMnfDemo0 Then
                            ilFoundCnt = True
                            llContrCode = tlChfAdvtExt(ilCurrentRecd).lCode
                            llContrCode = gPaceCntr(tlChfAdvtExt(ilCurrentRecd).lCntrNo, llGetTo, hmCHF, tmChf)
                            If llContrCode > 0 Then
                                '1-13-04 change to retrieve only current lines (not history)

                                ilRet = gObtainCntr(hmCHF, hmClf, hmCff, llContrCode, False, tgChfCT, tgClfCT(), tgCffCT(), False)  '8-28-12 do not sort by special dp order
                                'convert date entered to long
                                gUnpackDateLong tgChfCT.iOHDDate(0), tgChfCT.iOHDDate(1), llTemp

                                If tgChfCT.iMnfDemo(0) = 0 Or llTemp > llGetTo Then      'if demo doesnt exist or the date entered is later than requested
                                    ilFoundCnt = False
                                End If
                                Exit For
                            Else
                                ilFoundCnt = False
                                Exit For
                            End If
                        End If
                    End If
                Next illoop
            End If
        End If

        If (ilFoundCnt And tgChfCT.iPctTrade <> 100) Then                                  'get a contract and test for printables,
                                                        'user input Entered and Active dates
            ilTotLnSpts = 0                 'init total # spots per line
            'ReDim tlCntList(1 To 1) As RESEARCHINFO           'list of Research totals for cnt
            ReDim tlCntList(0 To 0) As RESEARCHINFO           'list of Research totals for cnt
            For ilClf = LBound(tgClfCT) To UBound(tgClfCT) - 1 Step 1
                tmClf = tgClfCT(ilClf).ClfRec
                If tmClf.sType = "H" Or tmClf.sType = "S" Then   '3-6-01 process on hidden & std lines (no packages)
                    'obtain population and demo codes by schedule line
                    'ReDim llWklyspots(1 To 14) As Integer       'sched lines weekly # spots
                    'ReDim llWklyAvgAud(1 To 14) As Long             'sched lines weekly avg aud
                    'ReDim llWklyRates(1 To 14) As Long           'sched lines weekly rates
                    'ReDim llWklyPopEst(1 To 14) As Long
                    ReDim llWklyspots(0 To 13) As Long       'sched lines weekly # spots
                    ReDim llWklyAvgAud(0 To 13) As Long             'sched lines weekly avg aud
                    ReDim llWklyRates(0 To 13) As Long           'sched lines weekly rates
                    ReDim llWklyPopEst(0 To 13) As Long
                    ilRet = gGetDemoPop(hmDrf, hmMnf, hmDpf, tmClf.iDnfCode, 0, tgChfCT.iMnfDemo(0), llPop)
                    If tmClf.iStartTime(0) = 1 And tmClf.iStartTime(1) = 0 Then
                        llOvStartTime = 0
                        llOvEndTime = 0
                    Else
                        'override times exist
                        gUnpackTimeLong tmClf.iStartTime(0), tmClf.iStartTime(1), False, llOvStartTime
                        gUnpackTimeLong tmClf.iEndTime(0), tmClf.iEndTime(1), True, llOvEndTime
                    End If

                    ilCff = tgClfCT(ilClf).iFirstCff
                    Do While ilCff <> -1
                        tmCff = tgCffCT(ilCff).CffRec
                        For illoop = 0 To 6                 'init all days to not airing, setup for research results later
                            ilInputDays(illoop) = False
                        Next illoop

                        gUnpackDate tmCff.iStartDate(0), tmCff.iStartDate(1), slStr
                        llFltStart = gDateValue(slStr)
                        'backup start date to Monday
                        illoop = gWeekDayLong(llFltStart)
                        Do While illoop <> 0
                            llFltStart = llFltStart - 1
                            illoop = gWeekDayLong(llFltStart)
                        Loop
                        gUnpackDate tmCff.iEndDate(0), tmCff.iEndDate(1), slStr
                        llFltEnd = gDateValue(slStr)
                        '
                        'Loop thru the flight by week and build the number of spots for each week
                        '
                        For llDate2 = llFltStart To llFltEnd Step 7
                            If llDate2 >= llStartDate And llDate2 <= llEndDate Then
                                If tmCff.sDyWk = "W" Then            'weekly
                                    ilSpots = tmCff.iSpotsWk + tmCff.iXSpotsWk
                                     For ilDay = 0 To 6 Step 1
                                        If (llDate2 + ilDay >= llFltStart) And (llDate2 + ilDay <= llFltEnd) Then
                                            If tmCff.iDay(ilDay) > 0 Or tmCff.sXDay(ilDay) = "1" Then
                                                ilInputDays(ilDay) = True
                                            End If
                                        End If
                                     Next ilDay
                                Else                                        'daily
                                     If illoop + 6 < llFltEnd Then           'we have a whole week
                                        ilSpots = tmCff.iDay(0) + tmCff.iDay(1) + tmCff.iDay(2) + tmCff.iDay(3) + tmCff.iDay(4) + tmCff.iDay(5) + tmCff.iDay(6)    'got entire week
                                        For ilDay = 0 To 6 Step 1
                                            If tmCff.iDay(ilDay) > 0 Then
                                                ilInputDays(ilDay) = True
                                            End If
                                        Next ilDay
                                     Else                                    'do partial week
                                        For llDate = llDate2 To llFltEnd Step 1
                                            ilDay = gWeekDayLong(llDate)
                                            ilSpots = ilSpots + tmCff.iDay(ilDay)
                                            If tmCff.iDay(ilDay) > 0 Then
                                                ilInputDays(ilDay) = True
                                            End If
                                        Next llDate
                                    End If
                                End If

                                ilRet = gGetDemoAvgAud(hmDrf, hmMnf, hmDpf, hmDef, hmRaf, tmClf.iDnfCode, tmClf.iVefCode, 0, tgChfCT.iMnfDemo(0), llDate2, llDate2, tmClf.iRdfCode, llOvStartTime, llOvEndTime, ilInputDays(), tmClf.sType, tmClf.lRafCode, llAvgAud, llPopEst, ilAudFromSource, llAudFromCode)
                                'Loop and build avg aud, spots, & spots per week
                                'calc week index
                                ilUpperWk = (llDate2 - llStartDate) / 7 + 1
                                llWklyspots(ilUpperWk - 1) = ilSpots
                                ilTotLnSpts = ilTotLnSpts + ilSpots
                                '1-26-19 implement net option
                                llRate = gGetGrossOrNetFromRate(tmCff.lActPrice, slGrossNet, tgChfCT.iAgfCode)
                                llWklyRates(ilUpperWk - 1) = llRate
                                llWklyAvgAud(ilUpperWk - 1) = llAvgAud
                                llWklyPopEst(ilUpperWk - 1) = llPopEst
                                ilUpperWk = ilUpperWk + 1

                                '14 weeks are always created with each contract (
                            End If                  'if llDate2 >= llStartDate and llDate2 <= llEndDAte
                        Next llDate2
                        ilCff = tgCffCT(ilCff).iNextCff               'get next flight record from mem
                    Loop                                            'while ilcff <> -1
                    'Finished all flights, calculat the lines research values
                    ilUpperWk = 14
                    ReDim tmVRtg(0 To ilUpperWk)                   'setup arrays for return values from audtolnresearch
                    ReDim tmVGrimp(0 To ilUpperWk)
                    ReDim tmVGRP(0 To ilUpperWk)
                    ReDim tmVCost(0 To ilUpperWk)                    'setup arrays for return values from audtolnresearch
                    'Schedule line complete, get its avg aud data for the line
                    If ilTotLnSpts > 0 And llPop > 0 Then
                        'gAvgAudToLnResearch sm1or2PlaceRating, False, llPop, llWklyPopEst(), llWklyspots(), llWklyRates(), llWklyAvgAud(), llTotalCost, llTotalAvgAud, tmVRtg(), ilTotalAvgRtg, tmVGrimp(), llTotalGrImp, tmVGRP(), llTotalGRP, llTotalCPP, llTotalCPM, llPopEst
                        gAvgAudToLnResearch sm1or2PlaceRating, False, llPop, llWklyPopEst(), llWklyspots(), llWklyRates(), llWklyAvgAud(), dlTotalCost, llTotalAvgAud, tmVRtg(), ilTotalAvgRtg, tmVGrimp(), llTotalGrImp, tmVGRP(), llTotalGRP, llTotalCPP, llTotalCPM, llPopEst 'TTP 10439 - Rerate 21,000,000
                        'Build totals by line
                        ilWinx = UBound(tlCntList)
                        tlCntList(ilWinx).lPop = llPop
                        tlCntList(ilWinx).lSatelliteEst = llPopEst          '6-4-04
                        'tlCntList(ilWinx).lTotalCost = llTotalCost
                        tlCntList(ilWinx).dTotalCost = dlTotalCost 'TTP 10439 - Rerate 21,000,000
                        tlCntList(ilWinx).lTotalCPP = llTotalCPP
                        tlCntList(ilWinx).lTotalCPM = llTotalCPM
                        tlCntList(ilWinx).lTotalGrimps = llTotalGrImp
                        tlCntList(ilWinx).lTotalGRP = llTotalGRP
                        tlCntList(ilWinx).iTotalAvgRating = ilTotalAvgRtg
                        tlCntList(ilWinx).lTotalAvgAud = llTotalAvgAud
                        'ReDim Preserve tlCntList(1 To ilWinx + 1)
                        ReDim Preserve tlCntList(0 To ilWinx + 1)
                    End If
                End If
            Next ilClf                                    'get next line
            'all line totals completed, get total contract research values
            'If UBound(tlCntList) > 1 Then       'found at least 1 line with research totals
            If UBound(tlCntList) > LBound(tlCntList) Then       'found at least 1 line with research totals
                llPop = -1
                For illoop = LBound(tlCntList) To UBound(tlCntList) - 1 Step 1
                    ReDim Preserve tmVCost(0 To illoop) As Long
                    ReDim Preserve tmVGrimp(0 To illoop) As Long
                    ReDim Preserve tmVGRP(0 To illoop) As Long
                    tmVCost(illoop) = tlCntList(illoop).dTotalCost 'TTP 10439 - Rerate 21,000,000
                    tmVGrimp(illoop) = tlCntList(illoop).lTotalGrimps
                    tmVGRP(illoop) = tlCntList(illoop).lTotalGRP
                    'determine if varying populations across the weeks (demo estimates) or across the lines
                    If tgSpf.sDemoEstAllowed = "Y" Then             '6-4-04
                        If llPop < 0 Then
                            llPop = tlCntList(illoop).lSatelliteEst
                        ElseIf llPop <> tlCntList(illoop).lSatelliteEst And tlCntList(illoop).lSatelliteEst <> 0 Then
                            llPop = 0
                        End If

                    Else
                        If llPop < 0 Then
                            llPop = tlCntList(illoop).lPop
                        ElseIf llPop <> tlCntList(illoop).lPop And tlCntList(illoop).lPop <> 0 Then
                            llPop = 0
                        End If
                    End If
                Next illoop
                'gResearchTotals False, llPop, tmVCost(), tmVRtg(), tmVGrimp(), tmVGRP(), llTotalCost, ilTotalAvgRtg, llTotalGrimp, llTotalGRP, llTotalCPP, llTotalCPM
                '4/7/99
                'Obtain contract research totals
                'gResearchTotals sm1or2PlaceRating, False, llPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, llTotalCost, ilTotalAvgRtg, llTotalGrImp, llTotalGRP, llTotalCPP, llTotalCPM, llTotalAvgAud
                gResearchTotals sm1or2PlaceRating, False, llPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, dlTotalCost, ilTotalAvgRtg, llTotalGrImp, llTotalGRP, llTotalCPP, llTotalCPM, llTotalAvgAud 'TTP 10439 - Rerate 21,000,000
                If llTotalCPP <> 0 Or llTotalCPM <> 0 Then
                    'maintain research contract totals for all contracts to be able to total them by demo
                    'include all contracts types (with remnants, DR, & PI)
                    ilWinx = UBound(tlWList)
                    tlWList(ilWinx).iVefCode = tgChfCT.iMnfDemo(0)
                    tlWList(ilWinx).lPop = llPop
                    tlWList(ilWinx).lSatelliteEst = llPop            '6-4-04
                    'tlWList(ilWinx).lTotalCost = llTotalCost
                    tlWList(ilWinx).dTotalCost = dlTotalCost 'TTP 10439 - Rerate 21,000,000
                    tlWList(ilWinx).lTotalCPP = llTotalCPP
                    tlWList(ilWinx).lTotalCPM = llTotalCPM
                    tlWList(ilWinx).lTotalGrimps = llTotalGrImp
                    tlWList(ilWinx).lTotalGRP = llTotalGRP
                    tlWList(ilWinx).iTotalAvgRating = ilTotalAvgRtg
                    tlWList(ilWinx).lTotalAvgAud = llTotalAvgAud
                    'ReDim Preserve tlWList(1 To ilWinx + 1)
                    ReDim Preserve tlWList(0 To ilWinx + 1)
                    If tgChfCT.sType <> "T" And tgChfCT.sType <> "R" And tgChfCT.sType <> "Q" Then     'exclude remnants, PI and DR
                        'Without remnants
                        ilWOInx = UBound(tlWOList)
                        tlWOList(ilWOInx).iVefCode = tgChfCT.iMnfDemo(0)
                        tlWOList(ilWOInx).lPop = llPop
                        tlWOList(ilWOInx).lSatelliteEst = llPopEst      '6-4-04
                        'tlWOList(ilWOInx).lTotalCost = llTotalCost
                        tlWOList(ilWOInx).dTotalCost = dlTotalCost 'TTP 10439 - Rerate 21,000,000
                        tlWOList(ilWOInx).lTotalCPP = llTotalCPP
                        tlWOList(ilWOInx).lTotalCPM = llTotalCPM
                        tlWOList(ilWOInx).lTotalGrimps = llTotalGrImp
                        tlWOList(ilWOInx).lTotalGRP = llTotalGRP
                        tlWOList(ilWOInx).iTotalAvgRating = ilTotalAvgRtg
                        tlWOList(ilWOInx).lTotalAvgAud = llTotalAvgAud
                        'ReDim Preserve tlWOList(1 To ilWOInx + 1)
                        ReDim Preserve tlWOList(0 To ilWOInx + 1)
                    End If
                End If                  'cpp or cpm are zero
            End If                      'found at least 1 line with research totals
        End If                          'ilfoundcnt = true
    Next ilCurrentRecd                  'get another cnt

    'all contracts completed with and without remnants, PI and DR
    'Cycle thru the list and build by demo category
    For illoop = 0 To RptSelCt!lbcSelection(11).ListCount - 1 Step 1
        slNameCode = tgRptSelDemoCodeCT(illoop).sKey
        ilRet = gParseItem(slNameCode, 2, "\", slCode)

        For ilLoop2 = 1 To 2                '2 passes, first with remants, 2nd without them
            ilUpperWk = 1
            If ilLoop2 = 1 Then             'with remnants, dr, & pi
                'For ilLoop3 = 1 To UBound(tlWList) - 1 Step 1
                For ilLoop3 = LBound(tlWList) To UBound(tlWList) - 1 Step 1
                    If tlWList(ilLoop3).iVefCode = Val(slCode) Then
                        ReDim Preserve tmVCost(0 To ilUpperWk - 1) As Long
                        ReDim Preserve tmVGrimp(0 To ilUpperWk - 1) As Long
                        ReDim Preserve tmVGRP(0 To ilUpperWk - 1) As Long
                        tmVCost(ilUpperWk - 1) = tlWList(ilLoop3).dTotalCost 'TTP 10439 - Rerate 21,000,000
                        tmVGrimp(ilUpperWk - 1) = tlWList(ilLoop3).lTotalGrimps
                        tmVGRP(ilUpperWk - 1) = tlWList(ilLoop3).lTotalGRP
                        'determine if varying populations across the weeks (demo estimates) or across the lines
                        If tgSpf.sDemoEstAllowed = "Y" Then             '6-4-04
                            If llPop < 0 Then
                                llPop = tlWList(ilLoop3).lSatelliteEst
                            ElseIf llPop <> tlWList(ilLoop3).lSatelliteEst And tlWList(ilLoop3).lSatelliteEst <> 0 Then
                                llPop = 0
                            End If
                        Else
                            If llPop < 0 Then
                                llPop = tlWList(ilLoop3).lPop
                            ElseIf llPop <> tlWList(ilLoop3).lPop And tlWList(ilLoop3).lPop <> 0 Then
                                llPop = 0
                            End If
                        End If

                        ilUpperWk = ilUpperWk + 1
                    End If
                Next ilLoop3
            Else                            'without remnants, dr, & pi
                For ilLoop3 = LBound(tlWOList) To UBound(tlWOList) - 1 Step 1
                    If tlWOList(ilLoop3).iVefCode = Val(slCode) Then
                        ReDim Preserve tmVCost(0 To ilUpperWk - 1) As Long
                        ReDim Preserve tmVGrimp(0 To ilUpperWk - 1) As Long
                        ReDim Preserve tmVGRP(0 To ilUpperWk - 1) As Long
                        tmVCost(ilUpperWk - 1) = tlWOList(ilLoop3).dTotalCost 'TTP 10439 - Rerate 21,000,000
                        tmVGrimp(ilUpperWk - 1) = tlWOList(ilLoop3).lTotalGrimps
                        tmVGRP(ilUpperWk - 1) = tlWOList(ilLoop3).lTotalGRP
                        'determine if varying populations across the weeks (demo estimates) or across the lines
                        If tgSpf.sDemoEstAllowed = "Y" Then             '6-4-04
                            If llPop < 0 Then
                                llPop = tlWList(ilLoop3).lSatelliteEst
                            ElseIf llPop <> tlWList(ilLoop3).lSatelliteEst And tlWList(ilLoop3).lSatelliteEst <> 0 Then
                                llPop = 0
                            End If
                        Else
                            If llPop < 0 Then
                                llPop = tlWList(ilLoop3).lPop
                            ElseIf llPop <> tlWList(ilLoop3).lPop And tlWList(ilLoop3).lPop <> 0 Then
                                llPop = 0
                            End If
                        End If
                        ilUpperWk = ilUpperWk + 1
                    End If
                Next ilLoop3
            End If
            'Get Research values for the demo with or without remnants (build a record for each)
            If ilUpperWk > 1 Then
                '4/7/99
                Dim ilCost As Integer
                'ReDim flVCost(0 To UBound(tmVCost)) As Single
                ReDim dlVCost(0 To UBound(tmVCost)) As Double 'TTP 10439 - Rerate 21,000,000
                For ilCost = 0 To UBound(tmVCost) Step 1
                    'flVCost(ilCost) = tmVCost(ilCost)
                    dlVCost(ilCost) = tmVCost(ilCost) 'TTP 10439 - Rerate 21,000,000
                Next ilCost
                'gResearchTotalsFloat sm1or2PlaceRating, False, llPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, tmCbf.lRate, tmCbf.iAvgRate, tmCbf.lGrImp, tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, tmCbf.lAvgAud
                'gResearchTotalsFloat sm1or2PlaceRating, False, llPop, flVCost(), tmVGrimp(), tmVGRP(), llLnSpots, tmCbf.lRate, tmCbf.iAvgRate, tmCbf.lGrImp, tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, tmCbf.lAvgAud
                gResearchTotalsFloat sm1or2PlaceRating, False, llPop, dlVCost(), tmVGrimp(), tmVGRP(), llLnSpots, CDbl(tmCbf.lRate), tmCbf.iAvgRate, tmCbf.lGrImp, tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, tmCbf.lAvgAud  'TTP 10439 - Rerate 21,000,000 - 'Fix TTP 10439 per Jason email v81 Contract report overflow error - Wed 11/16/22 9:42 AM
                'create CBF record for each demo gathered
                gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
                tmCbf.lGenTime = lgNowTime
                tmCbf.iGenDate(0) = igNowDate(0)
                tmCbf.iGenDate(1) = igNowDate(1)
                tmCbf.iDtFrstBkt(0) = ilEffDate(0)
                tmCbf.iDtFrstBkt(1) = ilEffDate(1)
                tmCbf.iDnfCode = Val(slCode)                         'Demo code
                tmCbf.iExtra2Byte = 1                           'assume with remannts & pi
                If ilLoop2 = 2 Then                             'without remnants or PI
                    tmCbf.iExtra2Byte = 2
                End If
                ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
            End If                  'nothing with the current demo
        Next ilLoop2                'finished with list includ remnants, dr, & PI; now do list without them
    Next illoop                      'process next demo

    ilRet = btrClose(hmUrf)
    ilRet = btrClose(hmMnf)
    ilRet = btrClose(hmCff)
    ilRet = btrClose(hmClf)
    ilRet = btrClose(hmCHF)
    ilRet = btrClose(hmCbf)
    ilRet = btrClose(hmDpf)
    ilRet = btrClose(hmDef)
    ilRet = btrClose(hmDrf)
    btrDestroy hmRaf
    btrDestroy hmUrf
    btrDestroy hmMnf
    btrDestroy hmCff
    btrDestroy hmClf
    btrDestroy hmCHF
    btrDestroy hmCbf
    btrDestroy hmDpf
    btrDestroy hmDef
    btrDestroy hmDrf

    Erase tgClfCT, tgCffCT
    Erase llWklyspots, llWklyRates, llWklyAvgAud, llWklyPopEst
    Erase tmVRtg, tmVGrimp, tmVGRP, tmVCost
    Erase tlCntList, tlWList, tlWOList  ', tlDemoList
End Sub

' *******************************************************************************
'
'               gTieOutGen - Generate Generic file for Detail Tie Out Report
'                           by Office or Vehicle
'                           A plan is selected for a given year and it is
'                           compared to the previous year's data for Orders
'                           on the Books at this time and this time last year.
'                           Split plans are also reported for each office.
'                           This is a Pacing report that gets that as of the effective
'                           entered date.  any contracts entered up to the entered
'                           date is included.
'               Created 8/2/96 d. hosaka
'               4/8/98 Ignore 100% trade contrcts
'               4-20-00 Retrieve slsp share from new comm structure
'   2-11-05 Chg array of PHF/RVF array from integer to long (prevent overflow)
'       12-14-06 add parm to gObtainRvfPhf to test on tran date (vs entry date)
'************************************************************************************
Sub gTieOutGenCt()
    Dim ilRet As Integer                    '
    Dim ilClf As Integer                    'loop for schedule lines
    Dim ilHOState As Integer                'retrieve only latest order or revision
    Dim slCntrTypes As String               'retrieve remnants, PI, DR, etc
    Dim slCntrStatus As String              'retrieve H, O G or N (holds, orders, unsch hlds & orders)
    Dim slMonth As String
    Dim slDay As String
    Dim slYear As String
    Dim ilYearInx As Integer
    Dim ilCurrentRecd As Integer            'loop for processing last years contracts
    Dim llContrCode As Long                 'Internal Contr code to build all lines & flights of a contract
    Dim ilTieOutUpper As Integer            '# of vehicle or office tieout arrays
    Dim ilFoundOne As Integer               'Found a matching  office built into mem
    Dim ilSelected As Integer               'found matching vehicle
    Dim ilTemp As Integer
    Dim illoop As Integer                   'temp loop variable
    Dim ilLoop2 As Integer                  'temp loop variable
    Dim ilQtr As Integer                    'temp loop variable to accumulate qtrs within year, while doing monthly totals
    Dim slTemp As String                    'temp string for dates
    Dim slLatest As String                  'temp string for dates
    Dim ilPeriod As Integer                 '1 = weekly (not used here), 2 = monthly, 3 = quarters
    Dim ilCalType As Integer                '1 = std, 2 = corp calendar
    'Date used to gather information
    Dim slLYStart As String                 'start date of last year to begin gathering (could be std or corp)
    Dim slLYEnd As String                   'end date of last year to begin gathering (could be std or corp)
    Dim slLYEffStart As String              'start date of effective year entered  (for last year)
    Dim slLYEffEnd As String                'end date of effective year entered    (for last year)
    Dim llLYStart As Long                   'start date of last year to begin gathering (long)
    Dim llLYEnd As Long                     'end date of last year to begin gathering (long
    Dim llLYEffStart As Long                'previous years effective entered date start
    Dim slTYStart As String                 'start date of this year to begin gathering  (string)
    Dim slTYEnd As String                   'end date of this year to begin gathering
    Dim slTYEffStart As String              'start date of effective year entered
    Dim slTYEffEnd As String                'end date of effective year entered
    Dim llTYStart As Long                   'start date of this year to begin gathering (Long)
    Dim llTYEnd As Long                     'end date of this year to begin gthering (long)
    Dim llTYEffStart As Long                'This years effective entered date start
    Dim llTYEffEnd As Long
    Dim slStartDate As String
    Dim slEndDate As String
    Dim llSametimeLYStart As Long           'start date of week for same time last year (based on week index)
    ReDim ilSameTimeLYStart(0 To 1) As Integer    'same time (last year, sameweek ) in btrieve format
    Dim slTodayStart As String              'start date of week for this years new business entered this week
    Dim llTodayStart As Long                'start date of week for this years new business entered on te user entered week
    Dim llEntryDate As Long
    Dim ilStartMonth As Integer             'for standard the year always starts on Jan, for Corporate calendar it must
                                            'be retrieved from corp calendar
    'Week dates are for gathering budget information
    ReDim ilTYStartWks(0 To 13) As Integer      'array of start weeks for the std or corp reporting months. Index zero ignored
    ReDim ilTYEndWks(0 To 13) As Integer        'array of end weeks for the std or corp reporting months. Index zero ignored
    ReDim ilLYStartWks(0 To 13) As Integer      'array of start weeks for the std or corp reporting months. Index zero ignored
    ReDim ilLYEndWks(0 To 13) As Integer        'array of end weeks for the std or corp reporting months. Index zero ignored
    ReDim llGenlDates(0 To 13) As Long          'start dates of each month.  This will contain either this years 13 dates or last years 13 dates,
                                                'depending on the contracts dates. Index zero ignored
    'Month Starts to gather projection $ from flights
    ReDim llTYStarts(0 To 13) As Long           'this year corp or std start dates.  Index zero ignored
    ReDim llLYStarts(0 To 13) As Long           'last year corp or std start dates. Index zero ignored
    '   end of date variables
    ReDim llProject(0 To 13) As Long        '$ projected for 12 months. Index zero ignored
    Dim llDate As Long                      'temp date variable
    Dim llDate2 As Long                     'temp date variable
    Dim ilTieOutIndex As Integer            'index into the TIEOUT record of the array being built
    Dim ilMnfCode As Integer                'Direct Budget code to access
    Dim ilSplitmnfCode As Integer           'Split Budget code to access
    Dim ilmnfNewBus As Integer              'New Business rev set code
    Dim ilBudget As Integer                 'loop variable to get direct & split budgets
    Dim slNameCode As String
    Dim slCode As String
    Dim ilThisOffice As Integer             'main slsp office to test against the splits
    Dim ilTY As Integer                         'true if the contract processing this year, else false
    Dim dlTemp As Double
    Dim ilPastFut As Integer
    Dim tlTranType As TRANTYPES             'inclusion/exclusion of transaction types "I", "A", "W", & "P"
    ReDim tlRvf(0 To 0) As RVF
    Dim llRvfLoop As Long                   '2-11-05
    Dim ilMonth As Integer
    ' Dan M 7-16-08 ntr/hard cost and single contract selectivity
    Dim blIncludeNTR As Boolean
    Dim blIncludeHardCost As Boolean
    Dim blNTRWithTotal As Boolean
    Dim tlNTRInfo() As NTRPacing
    Dim ilLowerboundNTR As Integer
    Dim ilUpperboundNTR As Integer
    Dim ilNTRCounter As Integer
    Dim llSingleContract As Long
    Dim llDateEntered As Long               'receivables entered date for pacing test
    Dim blFailedMatchNtrOrHardCost As Boolean
    Dim blFailedBecauseInstallment As Boolean
    
    If Val(RptSelCt!edcText.Text) > 0 And RptSelCt!edcText.Text <> " " Then
         llSingleContract = Val(RptSelCt!edcText.Text)
    Else
        llSingleContract = NOT_SELECTED
    End If
    hmSof = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSof, "", sgDBPath & "Sof.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSof)
        btrDestroy hmSof
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imSofRecLen = Len(tmSof)
    hmBvf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmBvf, "", sgDBPath & "Bvf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmBvf)
        btrDestroy hmBvf
        btrDestroy hmSof
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imBvfRecLen = Len(tmBvf)
    hmGrf = CBtrvTable(TEMPHANDLE)  '(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmGrf, "", sgDBPath & "Grf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmGrf)
        btrDestroy hmGrf
        btrDestroy hmBvf
        btrDestroy hmSof
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imGrfRecLen = Len(tmGrf)
    hmVef = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVef, "", sgDBPath & "Vef.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmVef)
        btrDestroy hmVef
        btrDestroy hmGrf
        btrDestroy hmBvf
        btrDestroy hmSof
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imVefRecLen = Len(tmVef)

    hmUrf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmUrf, "", sgDBPath & "Urf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmUrf)
        btrDestroy hmUrf
        btrDestroy hmVef
        btrDestroy hmGrf
        btrDestroy hmBvf
        btrDestroy hmSof
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imUrfRecLen = Len(tmUrf)
    hmSlf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSlf, "", sgDBPath & "Slf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSlf)
        btrDestroy hmSlf
        btrDestroy hmUrf
        btrDestroy hmVef
        btrDestroy hmGrf
        btrDestroy hmBvf
        btrDestroy hmSof
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imSlfRecLen = Len(tmSlf)
    hmMnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmMnf, "", sgDBPath & "Mnf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmMnf)
        btrDestroy hmMnf
        btrDestroy hmSlf
        btrDestroy hmUrf
        btrDestroy hmVef
        btrDestroy hmGrf
        btrDestroy hmBvf
        btrDestroy hmSof
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imMnfRecLen = Len(tmMnf)
    hmClf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmClf, "", sgDBPath & "Clf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmClf)
        btrDestroy hmClf
        btrDestroy hmMnf
        btrDestroy hmSlf
        btrDestroy hmUrf
        btrDestroy hmVef
        btrDestroy hmGrf
        btrDestroy hmBvf
        btrDestroy hmSof
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imClfRecLen = Len(tmClf)
    hmCff = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCff, "", sgDBPath & "Cff.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmCff)
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmMnf
        btrDestroy hmSlf
        btrDestroy hmUrf
        btrDestroy hmVef
        btrDestroy hmGrf
        btrDestroy hmBvf
        btrDestroy hmSof
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imCffRecLen = Len(tmCff)
    hmCHF = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCHF, "", sgDBPath & "Chf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmCHF)
        btrDestroy hmCHF
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmMnf
        btrDestroy hmSlf
        btrDestroy hmUrf
        btrDestroy hmVef
        btrDestroy hmGrf
        btrDestroy hmBvf
        btrDestroy hmSof
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    imCHFRecLen = Len(tmChf)
     ' Dan M 7-16-08
    hmSbf = CBtrvTable(ONEHANDLE)
    ilRet = btrOpen(hmSbf, "", sgDBPath & "sbf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSbf)
        btrDestroy hmSbf
        btrDestroy hmCHF
        btrDestroy hmCff
        btrDestroy hmClf
        btrDestroy hmMnf
        btrDestroy hmSlf
        btrDestroy hmUrf
        btrDestroy hmVef
        btrDestroy hmGrf
        btrDestroy hmBvf
        btrDestroy hmSof
        Screen.MousePointer = vbDefault
        Exit Sub
    End If
    ReDim tmMnfNtr(0 To 0) As MNF
        tlTranType.iAdj = True              'look only for adjustments in the History & Rec files
    tlTranType.iInv = False
    tlTranType.iWriteOff = False
    tlTranType.iPymt = False
    tlTranType.iCash = True
    tlTranType.iTrade = False
    tlTranType.iMerch = False
    tlTranType.iPromo = False
    tlTranType.iNTR = False         '9-17-02

    If RptSelCt!ckcSelC3(0).Value Or RptSelCt!ckcSelC3(1).Value Then    'don't waste time filling array if don't need.
        tlTranType.iNTR = True
    'set flags ntr or hard cost or both chosen
        If RptSelCt!ckcSelC3(0).Value = 1 Then
             blIncludeNTR = True
        End If
        If RptSelCt!ckcSelC3(1).Value = 1 Then
            blIncludeHardCost = True
        End If
        ilRet = gObtainMnfForType("I", "", tmMnfNtr())
        If ilRet <> True Then
            MsgBox "error retrieving MNF files", vbOKOnly + vbCritical
            Exit Sub
        End If
    End If

    ReDim tgClfCT(0 To 0) As CLFLIST
    tgClfCT(0).iStatus = -1 'Not Used
    tgClfCT(0).lRecPos = 0
    tgClfCT(0).iFirstCff = -1
    ReDim tgCffCT(0 To 0) As CFFLIST
    tgCffCT(0).iStatus = -1 'Not Used
    tgCffCT(0).lRecPos = 0
    tgCffCT(0).iNextCff = -1
    'obtain the direct plan
    For illoop = 0 To RptSelCt!lbcSelection(4).ListCount - 1 Step 1
        If RptSelCt!lbcSelection(4).Selected(illoop) Then
            'get the mnfCode to pick up budget record
            slTemp = tgRptSelBudgetCodeCT(illoop).sKey   'RptSelCt!lbcBudgetCode.List(ilLoop)          'pick up office code
            ilRet = gParseItem(slTemp, 2, "\", slLatest)      'obtain budget name for comparisons
            ilMnfCode = Val(slLatest)
        End If
    Next illoop
    If RptSelCt!rbcSelCInclude(0).Value Then
        'obtain the split plan only if by office
        For illoop = 0 To RptSelCt!lbcSelection(12).ListCount - 1 Step 1
            If RptSelCt!lbcSelection(12).Selected(illoop) Then
                'get the mnfCode to pick up budget record
                slTemp = tgRptSelBudgetCodeCT(illoop).sKey   'RptSelCt!lbcBudgetCode.List(ilLoop)          'pick up office code
                ilRet = gParseItem(slTemp, 2, "\", slLatest)      'obtain budget name for comparisons
                ilSplitmnfCode = Val(slLatest)
            End If
        Next illoop
    End If
    'Get STart and end dates of current week for new business test
    slTodayStart = RptSelCt!CSI_CalFrom.Text        'Date: 1/8/2020 added CSI calendar control for date entry --> edcSelCFrom.Text

    llTodayStart = gDateValue(slTodayStart)

    'setup year processing from end date of the week (regardless of std or corp calendars)
    'gObtainYearMonthDayStr slTemp, True, slYear, slMonth, slDay
    'igYear = Val(slYear)
    '10/4/97 use Year entered by input for the year processing
    'Determine earliest and latest dates of current year and last year
    slTYStart = "01/15/" & Trim$(str$(igYear))
    slTYEnd = "12/15/" & Trim$(str$(igYear))

    If RptSelCt!rbcSelCSelect(0).Value Then      'corp month or qtr? (vs std)
        ilCalType = 2                   'corp
        ilRet = gGetCorpCalIndex(igYear)
        gUnpackDate tgMCof(ilRet).iStartDate(0, 0), tgMCof(ilRet).iStartDate(1, 0), slTYStart         'convert last bdcst billing date to string
        gUnpackDate tgMCof(ilRet).iEndDate(0, 11), tgMCof(ilRet).iEndDate(1, 11), slTYEnd
        ilStartMonth = tgMCof(ilRet).iStartMnthNo
    Else
        ilStartMonth = 1                'standard months always start jan (save to put into GRF record)
        ilCalType = 1                   'std
        slTYStart = gObtainStartStd(slTYStart)              'obtain start and end dates of current std year
        slTYEnd = gObtainEndStd(slTYEnd)
    End If
    ilPeriod = 2                        'assume months (vs qtrs)
    gGetStartEndWeeksCt ilCalType, ilPeriod, igYear, ilTYStartWks(), ilTYEndWks()

    'Last Year
    illoop = igYear - 1
    slLYStart = "01/15/" & Trim$(str$(illoop))
    slLYEnd = "12/15/" & Trim$(str$(illoop))
    If RptSelCt!rbcSelCSelect(0).Value Then                   'corp month (vs std)
        ilCalType = 2                   'corp
        ilRet = gGetCorpCalIndex(igYear - 1)
        gUnpackDate tgMCof(ilRet).iStartDate(0, 0), tgMCof(ilRet).iStartDate(1, 0), slLYStart         'convert last bdcst billing date to string
        gUnpackDate tgMCof(ilRet).iEndDate(0, 11), tgMCof(ilRet).iEndDate(1, 11), slLYEnd
    Else
        ilCalType = 1                   'std                'obtain start and end dates of previous std year
        slLYStart = gObtainStartStd(slLYStart)
        slLYEnd = gObtainEndStd(slLYEnd)
    End If
    gGetStartEndWeeksCt ilCalType, ilPeriod, illoop, ilLYStartWks(), ilLYEndWks()
    llTYStart = gDateValue(slTYStart)               'This years start date needed  in long format  to test spans
    llTYEnd = gDateValue(slTYEnd)                   'This years end date needed in long format to test spans
    llLYStart = gDateValue(slLYStart)               'Last years start date needed in long format to test spans
    llLYEnd = gDateValue(slLYEnd)                   'Last years end date needed in long format to test spans


    'get start and end dates (same time last year) for orders on books same time last year
    'based on week index of todays date .  First, get start and end dates for
    'this years effective date entered; then start and end dates for last year to
    'do calculation of the same relative week # for last year
    If RptSelCt!rbcSelCSelect(0).Value Then                   'corp month (vs std)
        ilCalType = 2                   'corp
        ilYearInx = gGetCorpInxByDate(llTodayStart, llTYEffStart, llTYEffEnd)
        slTYEffStart = Format$(llTYEffStart, "m/d/yy")
        slTYEffEnd = Format$(llTYEffEnd, "m/d/yy")
    Else
        ilCalType = 1                   'std                'obtain start and end dates of previous std year
        gObtainYearMonthDayStr slTodayStart, True, slYear, slMonth, slDay
        slTYEffStart = "01/15/" & Trim$(Val(igYear))    'slYear)    '1-08-08
        slTYEffEnd = "12/15/" & Trim$(Val(igYear))  'slYear)        '1-08-08

        slTYEffStart = gObtainStartStd(slTYEffStart)
        slTYEffEnd = gObtainEndStd(slTYEffEnd)
    End If
    llTYEffStart = gDateValue(slTYEffStart)
    If RptSelCt!rbcSelCSelect(0).Value Then                   'corp month (vs std)
        ilCalType = 2                   'corp
        ilYearInx = gGetCorpCalIndex(tgMCof(ilYearInx).iYear - 1)   'get previous years effective date start date of yr
        gUnpackDate tgMCof(ilYearInx).iStartDate(0, 0), tgMCof(ilYearInx).iStartDate(1, 0), slLYEffStart         'convert last bdcst billing date to string
        gUnpackDate tgMCof(ilYearInx).iEndDate(0, 11), tgMCof(ilYearInx).iEndDate(1, 11), slLYEffEnd
    Else
        ilCalType = 1                   'std                'obtain start and end dates of previous std year
        slLYEffStart = "01/15/" & Trim$(str$(igYear - 1))       '1-08-08
        slLYEffEnd = "12/15/" & Trim$(str$(igYear - 1))         '1-08-08
        slLYEffStart = gObtainStartStd(slLYEffStart)
        slLYEffEnd = gObtainEndStd(slLYEffEnd)
    End If
    llLYEffStart = gDateValue(slLYEffStart)
    llSametimeLYStart = llLYEffStart + (llTodayStart - llTYEffStart)
    gPackDateLong llSametimeLYStart, ilSameTimeLYStart(0), ilSameTimeLYStart(1)
    If RptSelCt!rbcSelCSelect(0).Value Then
        ilRet = gGetCorpCalIndex(igYear - 1)            'obtain last years dates
        For illoop = 1 To 12
            gUnpackDateLong tgMCof(ilRet).iStartDate(0, illoop - 1), tgMCof(ilRet).iStartDate(1, illoop - 1), llLYStarts(illoop)
        Next illoop
        gUnpackDateLong tgMCof(ilRet).iEndDate(0, 11), tgMCof(ilRet).iEndDate(1, 11), llLYStarts(13)
        llLYStarts(13) = llLYStarts(13) + 1
        ilRet = gGetCorpCalIndex(igYear)             'obtain this years dates
        For illoop = 1 To 12
            gUnpackDateLong tgMCof(ilRet).iStartDate(0, illoop - 1), tgMCof(ilRet).iStartDate(1, illoop - 1), llTYStarts(illoop)
        Next illoop
        gUnpackDateLong tgMCof(ilRet).iEndDate(0, 11), tgMCof(ilRet).iEndDate(1, 11), llTYStarts(13)
        llTYStarts(13) = llTYStarts(13) + 1
    Else                        'standard
        'igMonthOrQtr must be starting month to calculate dates
        'igYear must be year to process
        igMonthOrQtr = 1
        '11-21-05 add pacing date to call (n/a to this report)
        ilMonth = (igMonthOrQtr - 1) * 3 + 1
        gSetupBOBDates 2, llTYStarts(), llDate, ilTemp, 0, ilMonth  'build array of start & end dates
        'save the year requested, obtain dates for previous year
        illoop = igYear                 'save the year to process, get past year for gSetupBOBDates
        igYear = igYear - 1
        '11-21-05 add pacing date to call (n/a to this report)
        ilMonth = (igMonthOrQtr - 1) * 3 + 1
        gSetupBOBDates 2, llLYStarts(), llDate, ilTemp, 0, ilMonth  'build array of start & end dates
        igYear = illoop                 'restore the current year to process
    End If

    ilTieOutUpper = 0
    'populate list box with mnf revenue sets to get new business code
    ilRet = gPopMnfPlusFieldsBox(RptSelCt, RptSelCt!lbcSelection(11), tgRptSelDemoCodeCT(), sgRptSelDemoCodeTagCT, "R")
    ilmnfNewBus = 0
    For illoop = 0 To RptSelCt!lbcSelection(11).ListCount - 1 Step 1
        slTemp = tgRptSelDemoCodeCT(illoop).sKey 'RptSelCt!lbcDemoCode.List(ilLoop)
        ilRet = gParseItem(slTemp, 1, "\", slLatest)    'Get application name
        If slLatest = "New" Then
            ilRet = gParseItem(slTemp, 2, "\", slLatest)    'Get application name
            ilmnfNewBus = Val(slLatest)                         'mnf new busines code
            Exit For
        End If
    Next illoop
    'Build  slsp in memory to avoid rereading for office
    ReDim tlSlf(0 To 0) As SLF
    ilRet = gObtainSlf(RptSelCt, hmSlf, tlSlf())
    ReDim tmTieOut(0 To 0) As TIEOUT
    igTieOutUpper = 0
    For ilBudget = 1 To 2 Step 1
        'Build budgets for this year, first pass for direct budgets, 2nd pass for split budgets
        tmBvfSrchKey.iYear = igYear                     'budget year requested
        tmBvfSrchKey.iSeqNo = 1
        If ilBudget = 1 Then
            tmBvfSrchKey.iMnfBudget = ilMnfCode              'direct budget to report
            ilThisOffice = ilMnfCode
        Else
            tmBvfSrchKey.iMnfBudget = ilSplitmnfCode         'split budget to report
            ilThisOffice = ilSplitmnfCode
        End If
        ilRet = btrGetEqual(hmBvf, tmBvf, imBvfRecLen, tmBvfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'get matching budget records
        Do While (ilRet = BTRV_ERR_NONE And tmBvf.iYear = igYear And tmBvf.iMnfBudget = ilThisOffice)
            If RptSelCt!rbcSelCInclude(0).Value Then
                ilFoundOne = mCreateTieOut(1, 1, tmBvf.iSofCode, ilTieOutIndex, tmTieOut())     'office option
            Else
                ilFoundOne = mCreateTieOut(1, 2, tmBvf.iVefCode, ilTieOutIndex, tmTieOut())     'vehicle option
            End If
            If ilFoundOne Then
                For illoop = 1 To 53 Step 1             'loop for all 53 weeks
                    For ilLoop2 = 1 To 12 Step 1        'compute monthly total
                        If illoop >= ilTYStartWks(ilLoop2) And illoop <= ilTYEndWks(ilLoop2) Then
                            'ilQtr = Fix((ilLoop2 - 1) \ 3 + 1)
                            If tmBvf.sSplit = "S" And ilBudget = 2 Then              'split budgets
                                tmTieOut(ilTieOutIndex).lTYSplitPlan(ilLoop2) = tmTieOut(ilTieOutIndex).lTYSplitPlan(ilLoop2) + tmBvf.lGross(illoop)        'accum months
                                Exit For
                            Else
                                If tmBvf.sSplit = "D" And ilBudget = 1 Then 'direct budgets
                                    tmTieOut(ilTieOutIndex).lTYPlan(ilLoop2) = tmTieOut(ilTieOutIndex).lTYPlan(ilLoop2) + tmBvf.lGross(illoop)              'accum months
                                    Exit For
                                End If
                            End If
                        End If
                    Next ilLoop2                        'compute monthly totals
                Next illoop                             'loop for all 53 weeks
             End If
             ilRet = btrGetNext(hmBvf, tmBvf, imBvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
         Loop                           'while budgets match
        If RptSelCt!rbcSelCInclude(1).Value Then      'vehicle option, doesn't need splits
            Exit For
        End If
    Next ilBudget

    'Gather all contracts for previous year and current year whose effective date entered
    'is prior to the effective date that affects either previous year or current year
    slCntrTypes = gBuildCntTypes()
    slCntrStatus = "HOGN"               'Holds, orders, unsch hold, unsch order.
    ilHOState = 2                       'get latest orders & revisions   (may include G & N if later, plus revised orders turned proposals WCI)
    slStartDate = slLYStart
    slEndDate = slLYEnd

    ilRet = gObtainPhfRvf(RptSelCt, slLYStart, slTYEnd, tlTranType, tlRvf(), 0)
    For llRvfLoop = LBound(tlRvf) To UBound(tlRvf) - 1 Step 1
        tmRvf = tlRvf(llRvfLoop)
       'dan M 7-16-08 added single contract selectivity
        If llSingleContract = NOT_SELECTED Or llSingleContract = tmRvf.lCntrNo Then
            gUnpackDate tmRvf.iTranDate(0), tmRvf.iTranDate(1), slTemp
            llDate = gDateValue(slTemp)
            ilTY = False
            ilFoundOne = False
            gUnpackDate tmRvf.iDateEntrd(0), tmRvf.iDateEntrd(1), slTemp
            llDateEntered = gDateValue(slTemp)
            'Dan M 8-15-8 ntr/hard cost adjustments.  Is this record ntr/hard cost and do we want that?
            blFailedMatchNtrOrHardCost = False
            'Dan M 8-15-8 don't allow installment option "I"
            blFailedBecauseInstallment = False
            If tmRvf.sType = "I" Then
                blFailedBecauseInstallment = True
            End If
            If ((blIncludeNTR) Xor (blIncludeHardCost)) And tmRvf.iMnfItem > 0 Then      'one or the other is true, but not both (if both true, don't have to isolate anything)
                ilRet = gIsItHardCost(tmRvf.iMnfItem, tmMnfNtr())
            'if is hard cost but blincludentr  or isn't hard cost but blincludehardcost then it needs to be removed. set failedmatchntrorhardcost true
                If (ilRet And blIncludeNTR) Or ((Not ilRet) And blIncludeHardCost) Then
                    blFailedMatchNtrOrHardCost = True
                End If
            End If
            If Not (blFailedMatchNtrOrHardCost Or blFailedBecauseInstallment) Then  'if both false, continue
                If llDate >= llTYStart And llDate <= llTYEnd Then
                    ilTY = True
                    'If llDate <= llTodayStart Then  Dan M replaced with below 8-15-08
                    If llDateEntered <= llTodayStart Then
                        For ilTemp = 1 To 12                            'setup general buffer to use This years dates   Dan M changed from 13 to 12 may cause overflow
                            'llGenlDates(ilTemp) = llTYStarts(ilTemp)
                            If llDate >= llTYStarts(ilTemp) And llDate < llTYStarts(ilTemp + 1) Then
                                ilFoundOne = True
                                gPDNToLong tmRvf.sGross, llProject(ilTemp)
                                Exit For
                            End If
                        Next ilTemp
                    End If
                'if trans date not within current year, assume last year
                Else
                    If llDateEntered <= llSametimeLYStart Then      'from lldate to lldateentered  dan m 8-15-08
                        For ilTemp = 1 To 12                        'setup general buffer to use last years dates Dan M changed from 13 to 12
                            If llDate >= llLYStarts(ilTemp) And llDate < llLYStarts(ilTemp + 1) Then
                                ilFoundOne = True
                                gPDNToLong tmRvf.sGross, llProject(ilTemp)
                                Exit For
                            End If
                        Next ilTemp
                    End If
                End If
            End If
            If ilFoundOne Then
                'Read the contract
                tmChfSrchKey1.lCntrNo = tmRvf.lCntrNo
                tmChfSrchKey1.iCntRevNo = 32000
                tmChfSrchKey1.iPropVer = 32000
                ilRet = btrGetGreaterOrEqual(hmCHF, tgChfCT, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE) 'get matching contr recd
                'Do While (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo <> tmRvf.lCntrNo Or (tmChf.sSchStatus <> "F" And tmChf.sSchStatus <> "M"))
                Do While (ilRet = BTRV_ERR_NONE) And (tgChfCT.lCntrNo = tmRvf.lCntrNo) And (tgChfCT.sSchStatus <> "F" And tgChfCT.sSchStatus <> "M")
                    ilRet = btrGetNext(hmCHF, tgChfCT, imCHFRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop
                If ((ilRet <> BTRV_ERR_NONE) Or (tgChfCT.lCntrNo <> tmRvf.lCntrNo)) Then  'phoney a header from the receivables record so it can be procesed
                    For illoop = 0 To 9
                        tgChfCT.iSlfCode(illoop) = 0
                        tgChfCT.lComm(illoop) = 0
                        tgChfCT.iMnfSubCmpy(illoop) = 0       '4-20-00
                    Next illoop
                    tgChfCT.iSlfCode(0) = tmRvf.iSlfCode
                    tgChfCT.lComm(0) = 1000000
                    tgChfCT.iPctTrade = 0
                    If tmRvf.sCashTrade = "T" Then
                        tgChfCT.iPctTrade = 100           'ignore trades   later
                    End If
                End If
                ilThisOffice = 0                   'init to 0 until something found
                For ilTemp = LBound(tlSlf) To UBound(tlSlf) - 1
                    If tlSlf(ilTemp).iCode = tgChfCT.iSlfCode(0) Then
                        ilThisOffice = tlSlf(ilTemp).iSofCode               'save slsp office code
                        Exit For
                    End If
                Next ilTemp
                ilSelected = False
                'Verify that this office was selected (if option by office)
                If RptSelCt!rbcSelCInclude(0).Value Then            'office selection

                    'Process all offices because of split in and split out $.  Filter out
                    'when record written to disk.
                    ilRet = mCreateTieOut(1, 2, ilThisOffice, ilTieOutIndex, tmTieOut())     'vehicle option
                    If ilRet Then
                        ilSelected = True
                    End If
                Else
                    For ilTemp = 0 To RptSelCt!lbcSelection(6).ListCount - 1 Step 1
                        If (RptSelCt!lbcSelection(6).Selected(ilTemp)) Then
                            slNameCode = tgCSVNameCode(ilTemp).sKey  'RptSelCt!lbcCSVNameCode.List(ilOption)
                            ilRet = gParseItem(slNameCode, 2, "\", slCode)
                            If Val(slCode) = tmRvf.iBillVefCode Then
                                ilRet = mCreateTieOut(1, 1, tmRvf.iBillVefCode, ilTieOutIndex, tmTieOut())     'office option
                                'ilThisOffice = tmchf.iVefCode       'save into common test field  Dan M changed this to below
                                ilThisOffice = tmRvf.iBillVefCode
                                ilSelected = True
                                Exit For
                            End If
                        End If
                    Next ilTemp
                End If
                If ilSelected Then
                    'Build the projected $ from lines into its appropriate category
                    mTieOutRvfOrder ilTY, ilTieOutIndex, ilThisOffice, ilmnfNewBus, llProject(), tlSlf(), tmRvf.iAirVefCode     '4-20-00

                    '***********   for debugging only  (comment out btrinsert when creating office or vehicle records when debugging)
                    'If ilTY Then            'current year only
                    '    llTestGross = 0
                    '    For ilLoop = 1 To 12
                    '        tmGrf.lDollars(ilLoop) = llProject(ilLoop)
                    '        llTestGross = llTestGross + llProject(ilLoop)
                    '    Next ilLoop
                    '    tmGrf.lchfcode = tgChfCt.lCode
                    '    tmGrf.iPerGenl(1) = 0               'from receivables, no line #
                    '    tmGrf.iPerGenl(2) = ilCalType      '1 = std, 2 = corp
                    '    tmGrf.ivefCode = tmRvf.iBillvefcode
                    '    tmGrf.iYear = igYear
                    '    gPackDateLong llTodayStart, tmGrf.iDate(0), tmGrf.iDate(1)
                    '    If llTestGross <> 0 Then
                    '        ilRet = btrInsert(hmGrf, tmGrf, imGrfRecLen, INDEXKEY0)
                    '    End If
                    'End If

                    '********* end debugging code *************

                Else
                    For illoop = 1 To 12
                        llProject(illoop) = 0
                    Next illoop
                End If
            End If                          'ilfoundOne
            For illoop = 1 To 12            '4-20-00
                llProject(illoop) = 0
            Next illoop
        End If                                'contract selectivity
    Next llRvfLoop
    'Process contracts for last and this year
    'Alter last years start date to pick up the contracts that may have been modified
    'after the pacing date, removing the period that should be included.
    slLYStart = Format$(gDateValue(slLYStart) - 90, "m/d/yy")   'go back 1 qtr for last years active dates becuase
    '                                       the latest version might have been altered, which cancelled the period
    '                                       the period to be reported

    slTYEnd = Format$(gDateValue(slTYEnd) + 90, "m/d/yy")        'get an extra quarter to make sure all changes included
    ilRet = gObtainCntrForDate(RptSelCt, slLYStart, slTYEnd, slCntrStatus, slCntrTypes, ilHOState, tlChfAdvtExt())
    For ilCurrentRecd = LBound(tlChfAdvtExt) To UBound(tlChfAdvtExt) - 1 Step 1
        '7-15-08 added single contract selectivity dan M
        If llSingleContract = NOT_SELECTED Or llSingleContract = tlChfAdvtExt(ilCurrentRecd).lCntrNo Then
            For ilPastFut = 1 To 2
            'get conts earliest and latest dates to see which year it spans
            llContrCode = 0
            ilTY = False
            If ilPastFut = 2 Then                   'current
                llContrCode = gPaceCntr(tlChfAdvtExt(ilCurrentRecd).lCntrNo, llTodayStart, hmCHF, tmChf)
                gUnpackDate tmChf.iStartDate(0), tmChf.iStartDate(1), slTemp
                llDate = gDateValue(slTemp)
                gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slTemp
                llDate2 = gDateValue(slTemp)
                If llContrCode > 0 And llDate <= llTYEnd And llDate2 >= llTYStart Then
                    ilTY = True
                Else
                    llContrCode = 0             'force not found for this year
                End If
            Else                                    'past
                'does cnt dates span last year ?
                llContrCode = gPaceCntr(tlChfAdvtExt(ilCurrentRecd).lCntrNo, llSametimeLYStart, hmCHF, tmChf)
                gUnpackDate tmChf.iStartDate(0), tmChf.iStartDate(1), slTemp
                llDate = gDateValue(slTemp)
                gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slTemp
                llDate2 = gDateValue(slTemp)
                If llContrCode > 0 And llDate <= llLYEnd And llDate2 >= llLYStart Then
                    ilTY = False            'last year found
                Else
                    llContrCode = 0         'force not found for last year
                End If
            End If
            ilFoundOne = False
            If llContrCode > 0 Then
                ilRet = gObtainCntr(hmCHF, hmClf, hmCff, llContrCode, False, tgChfCT, tgClfCT(), tgCffCT(), False)  '8-28-12 do not sort by special dp order
                'ignore 100% trades, process all others
                If tgChfCT.iPctTrade <> 100 Then
                    'test current or last year date range
                    gUnpackDate tgChfCT.iOHDDate(0), tgChfCT.iOHDDate(1), slTemp
                    llEntryDate = gDateValue(slTemp)

                    ' Dan M 7-16-08 Add NTR/Hard Cost option
                    'Does user want to see HardCost/NTR? Make sure contract's entry date is appropriate.
                     If (blIncludeNTR Or blIncludeHardCost) And (tgChfCT.sNTRDefined = "Y") And llEntryDate <= llTodayStart Then
                        'call routine to fill array with choice.  Each line in tlntrinfo() is one ntr item, matching the chfcode and between the dates input which are start and end dates of chf
                        gNtrByContract llContrCode, llDate, llDate2, tlNTRInfo(), tmMnfNtr(), hmSbf, blIncludeNTR, blIncludeHardCost, RptSelCt
                        ilLowerboundNTR = LBound(tlNTRInfo)
                        ilUpperboundNTR = UBound(tlNTRInfo)
                     'ntr or hard cost found?
                        If ilUpperboundNTR <> ilLowerboundNTR Then
                            'flag to see that contract has a value for writing
                            For ilNTRCounter = ilLowerboundNTR To ilUpperboundNTR - 1 Step 1
                                'send to routine to write to grf
                                ilThisOffice = 0                   'init to 0 until something found
                                For ilTemp = LBound(tlSlf) To UBound(tlSlf) - 1
                                    If tlSlf(ilTemp).iCode = tgChfCT.iSlfCode(0) Then
                                        ilThisOffice = tlSlf(ilTemp).iSofCode               'save slsp office code
                                        Exit For
                                    End If
                                Next ilTemp
                                ilSelected = False
                                    'Verify that this office was selected (if option by office)
                                If RptSelCt!rbcSelCInclude(0).Value Then            'office selection
                                    'Process all offices because of split in and split out $.  Filter out
                                    'when record written to disk.
                                    ilRet = mCreateTieOut(1, 2, ilThisOffice, ilTieOutIndex, tmTieOut())     'vehicle option
                                    If ilRet Then
                                        ilSelected = True
                                    End If
                                Else
                                    For ilTemp = 0 To RptSelCt!lbcSelection(6).ListCount - 1 Step 1
                                        If (RptSelCt!lbcSelection(6).Selected(ilTemp)) Then
                                            slNameCode = tgCSVNameCode(ilTemp).sKey  'RptSelCt!lbcCSVNameCode.List(ilOption)
                                            ilRet = gParseItem(slNameCode, 2, "\", slCode)
                                            If Val(slCode) = tlNTRInfo(ilNTRCounter).iVefCode Then         'tmRvf.iBillVefCode Then
                                                ilRet = mCreateTieOut(1, 1, tlNTRInfo(ilNTRCounter).iVefCode, ilTieOutIndex, tmTieOut())     'office optio
                                                ilThisOffice = tlNTRInfo(ilNTRCounter).iVefCode       'save into common test field
                                                If ilRet Then
                                                    ilSelected = True
                                                End If
                                                Exit For
                                            End If
                                        End If
                                    Next ilTemp
                                End If
                                If ilSelected Then      'ntr record matches vehicle or office
                                'clear array that is a bucket that each ntrinfo will be added to. In this case, each array element is a month.
                                    For illoop = 1 To 13
                                        llProject(illoop) = 0
                                    Next illoop
                                    blNTRWithTotal = False
                                    If ilPastFut = 2 Then
                                        For ilTemp = 1 To 12    'dan
                                      'look at each ntr record's date to see if falls into specific time period.
                                            If tlNTRInfo(ilNTRCounter).lSbfDate >= llTYStarts(ilTemp) And tlNTRInfo(ilNTRCounter).lSbfDate < llTYStarts(ilTemp + 1) Then
                                                                      'flag so won't write record if all values are 0
                                                If tlNTRInfo(ilNTRCounter).lSBFTotal > 0 Then
                                                    blNTRWithTotal = True
                                                    llProject(ilTemp) = llProject(ilTemp) + tlNTRInfo(ilNTRCounter).lSBFTotal
                                                End If
                                                Exit For       'can probably put this back in.
                                            End If
                                        Next ilTemp
                                    Else
                                        For ilTemp = 1 To 12
                                            If tlNTRInfo(ilNTRCounter).lSbfDate >= llLYStarts(ilTemp) And tlNTRInfo(ilNTRCounter).lSbfDate < llLYStarts(ilTemp + 1) Then
                                                'flag so won't write record if all values are 0
                                                If tlNTRInfo(ilNTRCounter).lSBFTotal > 0 Then
                                                    blNTRWithTotal = True
                                                    llProject(ilTemp) = llProject(ilTemp) + tlNTRInfo(ilNTRCounter).lSBFTotal
                                                End If
                                                Exit For
                                            End If
                                        Next ilTemp
                                    End If      'past/future
                                    If blNTRWithTotal = True Then
                                         'Build the projected $ from lines into its appropriate category
                                        mTieOutRvfOrder ilTY, ilTieOutIndex, ilThisOffice, ilmnfNewBus, llProject(), tlSlf(), tlNTRInfo(ilNTRCounter).iVefCode   '4-20-00
                                    End If 'lbntrwithtotal
                                End If          'ilselected = true
                            Next ilNTRCounter
                        End If  'upperbound<>lowerbound ilntrinfo
                    End If 'hard cost?

                    'Determine what years is being processed and if its within pacing period  problem testing by adding ilselected add to last year too
                    If ilTY Then
                        If llEntryDate <= llTodayStart Then
                            ilFoundOne = True
                            For ilTemp = 1 To 13                            'setup general buffer to use This years dates
                                llGenlDates(ilTemp) = llTYStarts(ilTemp)
                            Next ilTemp
                            'ilTY = True
                        End If
                    Else
                        If llEntryDate <= llSametimeLYStart Then
                            ilFoundOne = True
                            For ilTemp = 1 To 13                        'setup general buffer to use last years dates
                                llGenlDates(ilTemp) = llLYStarts(ilTemp)
                            Next ilTemp
                            'ilTY = False
                        End If
                    End If
                    ilThisOffice = 0                   'init to 0 until something found
                    For ilTemp = LBound(tlSlf) To UBound(tlSlf) - 1
                        If tlSlf(ilTemp).iCode = tgChfCT.iSlfCode(0) Then
                            ilThisOffice = tlSlf(ilTemp).iSofCode               'save slsp office code
                            Exit For
                        End If
                    Next ilTemp
                    'Verify that this office was selected (if option by office)
                    If RptSelCt!rbcSelCInclude(0).Value Then            'office selection

                        'Process all offices because of split in and split out $.  Filter out
                        'when record written to disk.
                        ilRet = mCreateTieOut(1, 2, ilThisOffice, ilTieOutIndex, tmTieOut())     'vehicle option
                        If Not (ilRet) Then
                            ilFoundOne = False
                        End If
                    End If
                End If                              'tgChfCt.ipcttrade <> 100
            End If                                  'if ilContrCode > 0
            'Find all contracts for this year (start of the year thru the user requested week) or last years business from the start of last year
            'thru the same week last year
             If ilFoundOne Then

                For ilClf = LBound(tgClfCT) To UBound(tgClfCT) - 1 Step 1
                    tmClf = tgClfCT(ilClf).ClfRec
                    ilSelected = True
                    If RptSelCt!rbcSelCInclude(1).Value Then            'vehicle selection
                        ilSelected = False
                        'If Not RptSelCt!ckcAll.Value Then
                        For ilTemp = 0 To RptSelCt!lbcSelection(6).ListCount - 1 Step 1
                            If (RptSelCt!lbcSelection(6).Selected(ilTemp)) Then
                                slNameCode = tgCSVNameCode(ilTemp).sKey  'RptSelCt!lbcCSVNameCode.List(ilOption)
                                ilRet = gParseItem(slNameCode, 2, "\", slCode)
                                If Val(slCode) = tmClf.iVefCode Then
                                    ilSelected = True
                                    ilRet = mCreateTieOut(1, 1, tmClf.iVefCode, ilTieOutIndex, tmTieOut())     'office option
                                    ilThisOffice = tmClf.iVefCode       'save into common test field
                                    Exit For
                                End If
                            End If
                        Next ilTemp
                        'End If
                    End If
                    If tmClf.sType <> "S" And tmClf.sType <> "H" Then    'only project standard or hidden lines
                        ilSelected = False
                    End If

                    If ilSelected Then              'only process those vechicles or offices that was selected
                        'Project the $ from the flights
                        gBuildFlights ilClf, llGenlDates(), 1, 13, llProject(), 1, tgClfCT(), tgCffCT()

                    '***********   for debugging only  (comment out btrinsert when creating office or vehicle records when debugging)
                    '    If ilPastFut = 2 Then           'current year only
                    '        llTestGross = 0
                    '        For ilLoop = 1 To 12
                    '            tmGrf.lDollars(ilLoop) = llProject(ilLoop)
                    '            llTestGross = llTestGross + llProject(ilLoop)
                    '        Next ilLoop
                    '        tmGrf.lchfcode = tgChfCt.lCode
                    '        tmGrf.iPerGenl(1) = tmClf.iLine
                    '        tmGrf.iPerGenl(2) = ilCalType      '1 = std, 2 = corp
                    '        tmGrf.ivefCode = tmClf.ivefCode
                    '        tmGrf.iYear = igYear
                    '        gPackDateLong llTodayStart, tmGrf.iDate(0), tmGrf.iDate(1)
                    '        If llTestGross <> 0 Then
                    '            ilRet = btrInsert(hmGrf, tmGrf, imGrfRecLen, INDEXKEY0)
                    '        End If
                    '    End If
                        'Build the projected $ from lines into its appropriate category
                        mTieOutRvfOrder ilTY, ilTieOutIndex, ilThisOffice, ilmnfNewBus, llProject(), tlSlf(), tmClf.iVefCode    '4-20-00
                    End If                                      'ilSelected
                Next ilClf                                      'loop thru schedule lines
            End If                                              'ilfound
            Next ilPastFut                                      'process both last year & this year for same contr
        End If                                              'contract selectivity
    Next ilCurrentRecd                                      'loop for CHF records
    'Build $ from this year and last years budget plans
    'Determine % differences, then write the records to disk
    'Each office or vehicle will have multiple records:
    'Plan, Orders on the books, % to plan, Need, New Business, % to plan,
    'Prior year, % to plan, split plan, splits in, splits out, OOB withsplit, % split

    'Build all the categories in memory for 1 office or vehicle so that the 13
    'categories can be written to disk at one time
    tmGrf.iGenDate(0) = igNowDate(0)                'Date genrated, used to send to crystal and remove later
    tmGrf.iGenDate(1) = igNowDate(1)
    gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
    tmGrf.lGenTime = lgNowTime
    gPackDate slTodayStart, tmGrf.iDate(0), tmGrf.iDate(1)
    tmGrf.iDateGenl(0, 0) = ilSameTimeLYStart(0)
    tmGrf.iDateGenl(1, 0) = ilSameTimeLYStart(1)
    If RptSelCt!rbcSelCInclude(0).Value Then          'use in crystal for heading
        tmGrf.sDateType = "O"
    Else
        tmGrf.sDateType = "V"
    End If
    tmGrf.iYear = igYear
    tmGrf.iPerGenl(0) = ilStartMonth                         'start month index to standard or corp year
    tmGrf.iPerGenl(1) = ilCalType                   '1 = std, 2 = corp
    tmGrf.iAdfCode = ilMnfCode                      'use in crystal for heading
    For illoop = LBound(tmTieOut) To UBound(tmTieOut)
        ilFoundOne = True
        If RptSelCt!rbcSelCInclude(0).Value Then            'office selection, filter out unselected ones
            If Not RptSelCt!ckcAll.Value = vbChecked Then
                ilFoundOne = False
                'determine if office selected
                For ilTemp = 0 To RptSelCt!lbcSelection(2).ListCount - 1 Step 1
                    If (RptSelCt!lbcSelection(2).Selected(ilTemp)) Then
                        slNameCode = tgSOCodeCT(ilTemp).sKey   'RptSelCt!lbcSOCode.List(ilOption)
                        ilRet = gParseItem(slNameCode, 2, "\", slCode)
                        If Val(slCode) = tmTieOut(illoop).iCode Then
                            ilFoundOne = True
                            Exit For
                        End If
                    End If
                Next ilTemp
            End If
        End If

        'There must be some values in Plan, Orders or Prior year to be reported
        llProject(1) = 0            'work counter
        llProject(2) = 0
        llProject(3) = 0
        For ilLoop2 = 1 To 12
            llProject(1) = llProject(1) + tmTieOut(illoop).lTYPlan(ilLoop2)
            llProject(2) = llProject(2) + tmTieOut(illoop).lTYOrders(ilLoop2)
            llProject(3) = llProject(3) + tmTieOut(illoop).lLYOrders(ilLoop2)
        Next ilLoop2
        If llProject(1) + llProject(2) + llProject(3) = 0 Then
            ilFoundOne = False                  'exclude if everything is zero
        End If
        If ilFoundOne Then                              'found always selected here for vehicles; if office it may not be selected.  If so, bypass.

            For ilLoop2 = 1 To 12                       'accum the qtrly and yearly totals
                ilQtr = (ilLoop2 - 1) \ 3 + 1           'detrmine qtr index
                tmTieOut(illoop).lTYPlan(13 + ilQtr) = tmTieOut(illoop).lTYPlan(13 + ilQtr) + tmTieOut(illoop).lTYPlan(ilLoop2)   'accum qtrs
                tmTieOut(illoop).lTYPlan(13) = tmTieOut(illoop).lTYPlan(13) + tmTieOut(illoop).lTYPlan(ilLoop2)   'accum yearly

                tmTieOut(illoop).lTYSplitPlan(13 + ilQtr) = tmTieOut(illoop).lTYSplitPlan(13 + ilQtr) + tmTieOut(illoop).lTYSplitPlan(ilLoop2)   'accum qtrs
                tmTieOut(illoop).lTYSplitPlan(13) = tmTieOut(illoop).lTYSplitPlan(13) + tmTieOut(illoop).lTYSplitPlan(ilLoop2)   'accum yearly

                tmTieOut(illoop).lTYOrders(13 + ilQtr) = tmTieOut(illoop).lTYOrders(13 + ilQtr) + tmTieOut(illoop).lTYOrders(ilLoop2)   'accum qtrs
                tmTieOut(illoop).lTYOrders(13) = tmTieOut(illoop).lTYOrders(13) + tmTieOut(illoop).lTYOrders(ilLoop2)   'accum yearly

                tmTieOut(illoop).lTYNewBus(13 + ilQtr) = tmTieOut(illoop).lTYNewBus(13 + ilQtr) + tmTieOut(illoop).lTYNewBus(ilLoop2)   'accum qtrs
                tmTieOut(illoop).lTYNewBus(13) = tmTieOut(illoop).lTYNewBus(13) + tmTieOut(illoop).lTYNewBus(ilLoop2)   'accum yearly

                tmTieOut(illoop).lLYOrders(13 + ilQtr) = tmTieOut(illoop).lLYOrders(13 + ilQtr) + tmTieOut(illoop).lLYOrders(ilLoop2)   'accum qtrs
                tmTieOut(illoop).lLYOrders(13) = tmTieOut(illoop).lLYOrders(13) + tmTieOut(illoop).lLYOrders(ilLoop2)   'accum yearly

                tmTieOut(illoop).lSplits(13 + ilQtr) = tmTieOut(illoop).lSplits(13 + ilQtr) + tmTieOut(illoop).lSplits(ilLoop2)   'accum qtrs
                tmTieOut(illoop).lSplits(13) = tmTieOut(illoop).lSplits(13) + tmTieOut(illoop).lSplits(ilLoop2)   'accum yearly

                tmTieOut(illoop).lSplitsIn(13 + ilQtr) = tmTieOut(illoop).lSplitsIn(13 + ilQtr) + tmTieOut(illoop).lSplitsIn(ilLoop2)   'accum qtrs
                tmTieOut(illoop).lSplitsIn(13) = tmTieOut(illoop).lSplitsIn(13) + tmTieOut(illoop).lSplitsIn(ilLoop2)   'accum yearly

                tmTieOut(illoop).lSplitsOut(13 + ilQtr) = tmTieOut(illoop).lSplitsOut(13 + ilQtr) + tmTieOut(illoop).lSplitsOut(ilLoop2)   'accum qtrs
                tmTieOut(illoop).lSplitsOut(13) = tmTieOut(illoop).lSplitsOut(13) + tmTieOut(illoop).lSplitsOut(ilLoop2)   'accum yearly

                tmTieOut(illoop).lOOBSplits(13 + ilQtr) = tmTieOut(illoop).lOOBSplits(13 + ilQtr) + tmTieOut(illoop).lOOBSplits(ilLoop2)   'accum qtrs
                tmTieOut(illoop).lOOBSplits(13) = tmTieOut(illoop).lOOBSplits(13) + tmTieOut(illoop).lOOBSplits(ilLoop2)   'accum yearly
            Next ilLoop2
            For ilLoop2 = 1 To 17 Step 1                'loop for 12 months and total year , plus the quarters
                lNeed(ilLoop2) = tmTieOut(illoop).lTYPlan(ilLoop2) - tmTieOut(illoop).lTYOrders(ilLoop2)
                lOOBSplit(ilLoop2) = (tmTieOut(illoop).lTYOrders(ilLoop2) + tmTieOut(illoop).lSplitsIn(ilLoop2)) - tmTieOut(illoop).lSplitsOut(ilLoop2)
                If tmTieOut(illoop).lTYPlan(ilLoop2) > 0 Then
                     '% orders to plan
                     dlTemp = tmTieOut(illoop).lTYOrders(ilLoop2)
                     lPctPlanOrders(ilLoop2) = dlTemp * 100 / tmTieOut(illoop).lTYPlan(ilLoop2)

                Else
                    'lLYPctPlan(ilLoop2) = 0
                    lPctPlanOrders(ilLoop2) = 0     'chged from initializing lLYPctPlan to lPctPlanOrders (6/12/98)
               End If

               If tmTieOut(illoop).lTYOrders(ilLoop2) > 0 Then
                     '% orders to plan

                     '%New business to OOB  (chged from % to plan to % to OOB 3/24/98)
                     dlTemp = tmTieOut(illoop).lTYNewBus(ilLoop2)
                     lPctPlanNew(ilLoop2) = dlTemp * 100 / tmTieOut(illoop).lTYOrders(ilLoop2)

                    '%prior Year to OOB   (chged from % prior year to plan to OOB 3/24/98)
                    'dlTemp = tmTieOut(ilLoop).lLYOrders(ilLoop2)
                    'lLYPctPlan(ilLoop2) = dlTemp * 100 / tmTieOut(ilLoop).lTYOrders(ilLoop2)
                Else
                    'lPctPlanOrders(ilLoop2) = 0
                    lPctPlanNew(ilLoop2) = 0
                End If

               If tmTieOut(illoop).lLYOrders(ilLoop2) > 0 Then
                    '4/30/98 changed calc from prior year/OOB to OOB/prior yr)
                    '%prior Year to OOB   (chged from % prior year to plan to OOB 3/24/98)
                    dlTemp = tmTieOut(illoop).lTYOrders(ilLoop2)
                    'lLYPctPlan(ilLoop2) = dlTemp * 100 / tmTieOut(ilLoop).lTYOrders(ilLoop2)
                    lLYPctPlan(ilLoop2) = dlTemp * 100 / tmTieOut(illoop).lLYOrders(ilLoop2)
                Else
                    'lPctPlanOrders(ilLoop2) = 0
                    lLYPctPlan(ilLoop2) = 0     'chg from initializing lPctPlanOrders to lLYPctPlan (6/12/98)
                End If


               If tmTieOut(illoop).lTYSplitPlan(ilLoop2) > 0 Then
                    'split to split plan
                    dlTemp = lOOBSplit(ilLoop2)
                    lPctSplit(ilLoop2) = dlTemp * 100 / tmTieOut(illoop).lTYSplitPlan(ilLoop2)
               Else
                    lPctSplit(ilLoop2) = 0
               End If
            Next ilLoop2
            'Now create the records for each of the 13 categories for this one vehicle or office
            'retain all values in nearest thousands

            For ilLoop2 = 1 To 13 Step 1                        'Loop for 13 different categories
                tmGrf.iVefCode = tmTieOut(illoop).iCode              'office or vehicle code
                tmGrf.iCode2 = ilLoop2
                For ilThisOffice = 1 To 17 Step 1               'loop for all 12 periods plus totl year and 4 qtrs for one category at a time
                    Select Case ilLoop2                         'select on category
                        Case 1
                            tmGrf.lDollars(ilThisOffice - 1) = tmTieOut(illoop).lTYPlan(ilThisOffice)
                        Case 2
                            tmGrf.lDollars(ilThisOffice - 1) = tmTieOut(illoop).lTYOrders(ilThisOffice)
                        Case 3
                            tmGrf.lDollars(ilThisOffice - 1) = lPctPlanOrders(ilThisOffice)
                        Case 4
                            If lNeed(ilThisOffice) < 0 Then
                                tmGrf.lDollars(ilThisOffice - 1) = lNeed(ilThisOffice)
                            Else
                                tmGrf.lDollars(ilThisOffice - 1) = lNeed(ilThisOffice)
                            End If
                        Case 5
                            tmGrf.lDollars(ilThisOffice - 1) = tmTieOut(illoop).lTYNewBus(ilThisOffice)
                        Case 6
                            tmGrf.lDollars(ilThisOffice - 1) = lPctPlanNew(ilThisOffice)
                        Case 7
                            tmGrf.lDollars(ilThisOffice - 1) = tmTieOut(illoop).lLYOrders(ilThisOffice)
                        Case 8
                            tmGrf.lDollars(ilThisOffice - 1) = lLYPctPlan(ilThisOffice)
                        Case 9
                            tmGrf.lDollars(ilThisOffice - 1) = tmTieOut(illoop).lTYSplitPlan(ilThisOffice)
                        Case 10
                            tmGrf.lDollars(ilThisOffice - 1) = tmTieOut(illoop).lSplitsIn(ilThisOffice)
                        Case 11
                            'negate the splits out
                            tmGrf.lDollars(ilThisOffice - 1) = -tmTieOut(illoop).lSplitsOut(ilThisOffice)
                        Case 12
                            tmGrf.lDollars(ilThisOffice - 1) = lOOBSplit(ilThisOffice)
                        Case 13
                            tmGrf.lDollars(ilThisOffice - 1) = lPctSplit(ilThisOffice)
                    End Select
                Next ilThisOffice                          'loop for 13 periods this category
                If (RptSelCt!rbcSelCInclude(0).Value) Or (RptSelCt!rbcSelCInclude(1).Value And ilLoop2 < 9) Then     'write a recd for everything
                                                            'but vehicle option and categories 9-13 (split stuff)
                  ilRet = btrInsert(hmGrf, tmGrf, imGrfRecLen, INDEXKEY0)
                End If
            Next ilLoop2                'loop for next category (1 to 13)
        End If                      'office not selected
    Next illoop                     'Create records for next vehicle or office
    sgCntrForDateStamp = ""         'clear out time stamp to reread contr if not exiting report selectivity
    Erase tmTieOut, tlChfAdvtExt, tlRvf, tlSlf, tmMnfNtr
    Erase lPctPlanOrders, lNeed
    Erase lPctPlanNew
    Erase lLYPctPlan
    Erase lOOBSplit, lPctSplit
    Erase ilTYStartWks, ilTYEndWks, ilLYStartWks, ilLYEndWks, llGenlDates
    Erase llTYStarts, llLYStarts
    Erase tgClfCT, tgCffCT
    ilRet = btrClose(hmCHF)
    ilRet = btrClose(hmClf)
    ilRet = btrClose(hmCff)
    ilRet = btrClose(hmSof)

    ilRet = btrClose(hmUrf)
    ilRet = btrClose(hmMnf)
    ilRet = btrClose(hmBvf)
    ilRet = btrClose(hmVef)
    ilRet = btrClose(hmGrf)
    ilRet = btrClose(hmSlf)
    btrDestroy hmCHF
    btrDestroy hmClf
    btrDestroy hmCff
    btrDestroy hmSof
    btrDestroy hmUrf
    btrDestroy hmMnf
    btrDestroy hmBvf
    btrDestroy hmVef
    btrDestroy hmGrf
    btrDestroy hmSlf
End Sub

'           m104PlusWks - test if contract or previous version
'           due to differences are over 104 weeks.  if so,
'           cannot process the contract.
'           <input> lldate - start date of contract
'                   lldate2 - end date of contract
'           <return> true if OK to process, else false
'
'       1-18-06 Print the NTR contract even if contracts exceeds 104 weeks
Function m104PlusWks(llDate As Long, llDate2 As Long, tlRvf() As RVF, tlVehList() As INSERTINFO, ilWhichSort As Integer) As Integer
    Dim ilRet As Integer
    Dim slStartDate As String
    Dim slEndDate As String
    Dim slMonth As String
    Dim slDay As String
    Dim slYear As String
    Dim ilTotalsWks As Integer
    Dim tlSBFType As SBFTypes       '1-18-06 print NTR page even tho the contract detail exceeds 104 weeks
    Dim ilListIndex As Integer
    ReDim tlSbf(0 To 0) As SBF
    ReDim ilVehiclesDone(0 To 0) As Integer
    ReDim llStdStartDates(0 To 13) As Long  'Index zero ignored

    m104PlusWks = True
    slStartDate = Format$(llDate, "m/d/yy")
    slStartDate = gObtainEndStd(slStartDate)       'get std bdcst end date
    gObtainYearMonthDayStr slStartDate, True, slYear, slMonth, slDay
    Do While (slMonth <> "01") And (slMonth <> "04") And (slMonth <> "07") And (slMonth <> "10")
        slMonth = str$((Val(slMonth) - 1))
        slDay = "15"
        slStartDate = slMonth & "/" & slDay & "/" & slYear
        gObtainYearMonthDayStr slStartDate, True, slYear, slMonth, slDay
        slStartDate = gObtainEndStd(slStartDate)        'get std bdcst end date
    Loop
    'slStartDate now contains the end date of a quarter
    slStartDate = gObtainStartStd(slStartDate)      'start date of the quarter for this cnt
    slEndDate = Format$(llDate2, "m/d/yy")

    'recalculate the totals wks because the start date was pushed back to the start of the qtr
    ilTotalsWks = (gDateValue(slEndDate) - gDateValue(slStartDate)) \ 7 + 1

    If ilTotalsWks > 104 And llDate > 0 Then
        tmCbf = tmZeroCbf
        gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
        tmCbf.lGenTime = lgNowTime
        tmCbf.iGenDate(0) = igNowDate(0)
        tmCbf.iGenDate(1) = igNowDate(1)
        tmCbf.lChfCode = tgChfCT.lCode                'contract internal code
        tmCbf.sSurvey = "Reduce contract to 104 weeks"
        mSetupBrHdr ilWhichSort                                'format remaining header fields to output
        tmCbf.sDailyExists = "N"
        tmCbf.sDailyWkly = "0"
        ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
        igBR_SchLinesExist = True            'force contrct to print
        m104PlusWks = False

        'print out the NTR
        'Process NTR if applicable
        tlSBFType.iNTR = True           'this applies to Billed & Booked only to retrieve future $
        tlSBFType.iInstallment = False
        tlSBFType.iImport = False
        'retrieve all NTR records for this contract as long as its not insertion orders
        ilListIndex = RptSelCt!lbcRptType.ListIndex
        If (igRptType = 0) And (ilListIndex > 1) Then   'if proposals and the report index is greater than one,
            ilListIndex = ilListIndex + 1               'adjust for the report that is not shown
        End If
        mProcessBrNTR "1/1/1970", "12/31/2069", tlSBFType, tlRvf(), tlSbf(), ilVehiclesDone(), llStdStartDates(), ilListIndex, tlVehList(), ilWhichSort
    End If
End Function

'                   mAddTieOut -  Flight $ have been projected, adjust the projected
'                                 $ for split slsp if they apply
'                   <input>  llProject() - array of 12 buckets for the flights projections
'                           llCommPct - % (xxx.xxxx) allocated to slsp
'                   <output> llArrayToAdd() - array of 12 periods adjusted
'
'                   'Modified 9/4/97 dh remove CTF as method of gathering data
'
Sub mAddTieOut(llProject() As Long, llArrayToAdd() As Long, llCommPct As Long)
    Dim illoop As Integer
    Dim slStr As String
    Dim slSharePct As String
    Dim slAmount As String
    
    For illoop = 1 To 12 Step 1            'monthly totals
        'Determine qtr for this month
        If llCommPct = 1000000 Then
            llArrayToAdd(illoop) = llArrayToAdd(illoop) + (llProject(illoop) \ 100)     'remove cents before accum
        Else                    'split comm, calc office share
            slAmount = gLongToStrDec((llProject(illoop) \ 100), 0)      'remove cents
            slSharePct = gLongToStrDec(llCommPct, 4)                    'slsp split share in %
            slStr = gDivStr(gMulStr(slSharePct, slAmount), "100")         'slsp gross portion of possible split
            slStr = gRoundStr(slStr, "01.", 0)
            llArrayToAdd(illoop) = llArrayToAdd(illoop) + Val(slStr)   'no cents
        End If
    Next illoop                    'monthly totals
End Sub

'                   mBobAdjust - Subtract missed spots (missed, cancel, hidden)
'                                Count MGs where they air
'                               Billed and booked report
'                   <input> llstdstartDates() - array of 13 start dates of the 12 months to gather
'                           ilFirstProjInx - index of first month to start projection (earlier is from receivables)
'                           llStartAdjust -  Earliest date to start searching for missed, etc.
'                           llEndAdjust - latest date to stop searchng for missed, etc.
'                           ilPkgPrice - true if retrieving rate from the matching clf and cff
'                                        false if retrieving rate from the package clf of the hidden clf (aired billing)
'                           ilSubMissed - true if subtract $ from missed vehicle for missed, cancel, hidden spots
'                           ilCountMGs - true if subtract $ from missed vehicle, move $ to makegood vehicle
'                           ilHowManyPer - # of periods to gather
'                                           (for billed & booked its 12,
'                                           for Sales Comparisons its max 3)
'                           ilAdjustMissedForMG - true to subtract out the missed part of the mg,
'                                       false to ignore the missed part of the MG.
'                                       When gathering spots, accumlating spot $ will be short if
'                                       the missed part is subtracted out
'
'       3/97 dh Comment out code to test the MNF Missed Reasons - field contains
'               value whether or not to bill the mg, bill the missed, etc.
'       3-15-00 Speed up the gathering of SMF spots; obtain the flight instead of going through the
'               generalized routines (which reads & rereads SMF) and could also have caused looping when
'               an SMF error existed.
'               Also, when retrieving the SMF, since the key is missed date, start searching for the spots
'               based on the start of the reporting period minus 2 months, as opposed to the beginning (zero).
'       8-17-06 count mg where they air is not checked for air time billing.  It was always included
'       11-12-07 add flag to test to adjust the missed portion of the makegood
Sub mBOBAdjust(llStdStartDates() As Long, ilFirstProjInx As Integer, llStartAdjust As Long, llEndAdjust As Long, ilPkgPrice As Integer, ilSubMissed As Integer, ilCountMGs As Integer, ilHowManyPer As Integer, ilAdjustMissedForMG As Integer)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  ilListIndex                   ilFoundOption                                           *
    '******************************************************************************************
    
    Dim slDate As String
    ReDim ilDate(0 To 1) As Integer           'converted date for earliest start date for sdf keyread
    Dim ilRet As Integer
    Dim llDate As Long
    Dim ilMonthInx As Integer
    Dim ilFoundMonth As Integer
    Dim ilDoAdjust As Integer
    Dim slPrice As String           'rate from flight
    Dim ilSavePkLineNo As Integer
    Dim illoop As Integer
    Dim llActPrice As Long          'rate from flight
    Dim ilFoundVef As Integer
    Dim ilTemp As Integer
    Dim ilAcqCommPct As Integer
    Dim ilAcqLoInx As Integer
    Dim ilAcqHiInx As Integer
    Dim llAcqNet As Long
    Dim llAcqComm As Long
    Dim blAcqOK As Boolean
    Dim ilTempVefCode As Integer            '8-3-16
    Dim ilDoe As Integer
    
    'Rules to subtract missed spots
    '----------------+-----------------+------------------------+-------------------------
    '                |    Case 1 "S"   |    Case 2 "O"          |   Case 3 "A"
    '                |  Bill as Order  | Bill as Order          |  As Aired
    '                |  update Order   | Update aired           |  Update aired
    '----------------+-----------------+------------------------+-------------------------
    'Package Lines   |  ignore missed  | Ignore missed          |  Ignore missed
    '----------------+-----------------+------------------------+-------------------------
    'Hidden Lines    |  ignore missed  | Ignore missed          |  Ignore missed
    '----------------+-----------------+------------------------+-------------------------
    'Standard Lines  |  ignore missed  | Answer from user input |  Answer from user input
    '----------------+-----------------+------------------------+-------------------------
    If ilSubMissed And smAirOrder <> "S" And tmClf.sType = "S" Then        'possibly adjust missed for standard lines; 'subtract missed, cancel, hidden spots?
        tmSdfSrchKey.iVefCode = tmClf.iVefCode
        tmSdfSrchKey.lChfCode = tgChfCT.lCode
        tmSdfSrchKey.iLineNo = tmClf.iLine
        tmSdfSrchKey.lFsfCode = 0
        slDate = Format$(llStartAdjust, "m/d/yy")
        gPackDate slDate, ilDate(0), ilDate(1)
        tmSdfSrchKey.iDate(0) = ilDate(0)
        tmSdfSrchKey.iDate(1) = ilDate(1)
        tmSdfSrchKey.sSchStatus = ""
        tmSdfSrchKey.iTime(0) = 0
        tmSdfSrchKey.iTime(1) = 0
        ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)
        Do While (ilRet = BTRV_ERR_NONE) And (tmSdf.iVefCode = tmClf.iVefCode) And (tmSdf.lChfCode = tgChfCT.lCode) And (tmSdf.iLineNo = tmClf.iLine)
'Debug.Print "-Missed Check-sdf Code:" & tmSdf.lCode & " ,Status:" & tmSdf.sSchStatus
            ilDoe = ilDoe + 1
            If ilDoe > 1000 Then
                ilDoe = 0
                DoEvents
            End If
            
            If (tmSdf.sSchStatus = "C" Or tmSdf.sSchStatus = "M" Or tmSdf.sSchStatus = "U" Or tmSdf.sSchStatus = "R" Or tmSdf.sSchStatus = "H") Then
                gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                llDate = gDateValue(slDate)
                If llDate > llEndAdjust Then
                    Exit Do
                End If
                'spot is OK, adjust the $
                ilFoundMonth = False
                For ilMonthInx = ilFirstProjInx To ilHowManyPer Step 1         'loop thru months to find the match
                    If llDate >= llStdStartDates(ilMonthInx) And llDate < llStdStartDates(ilMonthInx + 1) Then
                        ilFoundMonth = True
                        ilDoAdjust = True
                        Exit For
                    End If
                Next ilMonthInx
                
                If ilDoAdjust Then
                    If ilPkgPrice Then
                        ilRet = gGetRate(tmSdf, tmClf, hmCff, tmSmf, tmCff, slPrice)
                    Else                        'fake it out to get price from package (instead of hidden line)
                        ilSavePkLineNo = tmClf.iLine    'save the contents of the line id since it still may be
                                                        'needed
                        tmClf.iLine = tmClf.iPkLineNo
                        ilRet = gGetRate(tmSdf, tmClf, hmCff, tmSmf, tmCff, slPrice)
                        tmClf.iLine = ilSavePkLineNo
                    End If
    
                    If (InStr(slPrice, ".") <> 0) Then        'found spot cost
                        If (Asc(tgSaf(0).sFeatures2) And ACQUISITIONCOMMISSIONABLE) = ACQUISITIONCOMMISSIONABLE Then
                            ilAcqCommPct = 0
                            blAcqOK = gGetAcqCommInfoByVehicle(tmClf.iVefCode, ilAcqLoInx, ilAcqHiInx)
                            ilAcqCommPct = gGetEffectiveAcqComm(llDate, ilAcqLoInx, ilAcqHiInx)
                            gCalcAcqComm ilAcqCommPct, tmClf.lAcquisitionCost, llAcqNet, llAcqComm
                        Else
                            llAcqNet = tmClf.lAcquisitionCost
                        End If
                    
                        If imUseAcquisitionCost Then          'using acquisition costs?
                            lmAcquisition(ilMonthInx) = lmAcquisition(ilMonthInx) - llAcqNet                    '8-3-15 adjust for acq commission
                        Else
                            llActPrice = gStrDecToLong(slPrice, 2)
                            lmProject(ilMonthInx) = lmProject(ilMonthInx) - llActPrice     'subtr missed $, since they won't be invoiced
                            '8-3-15 determine if acq is commissionable
                            lmAcquisition(ilMonthInx) = lmAcquisition(ilMonthInx) - llAcqNet
                        End If
                    End If
                End If
            End If                          'sschstatus = C, M, H, U, R
            ilRet = btrGetNext(hmSdf, tmSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            
            igDoe = igDoe + 1
            If igDoe >= 500 Then
                DoEvents
                igDoe = 0
            End If
            
        Loop                                        'while BTRV_err none and contracts & lines match
    End If
    
    'Rules for Count mgs where they air
    '----------------+-----------------+--------------------------+--------------------------------
    '                | Case 1 "S"      | Case 2 "O"               | Case 3 "A"
    '                | Bill as Order   | Bill as Order            | As Aired
    '                | update Order    | Update aired             | Update aired
    '----------------+-----------------+--------------------------+--------------------------------
    'Package Lines   | ignore MGs      | Ignore mgs               | Same as Case 2 (hidden Line)
    '----------------+-----------------+--------------------------+--------------------------------
    'Hidden Lines    | ignore mgs      | Count MGs where they     | Same as Case 2 (hidden line)
    '                |                 | air($ sub from month of  |
    '                |                 | missed spots vehicle and |
    '                |                 | moved to the missed month|
    '                |                 | of the mgs spots vehicle.|
    '----------------+-----------------+--------------------------+-------------------------------
    'Standard Lines  | ignore mgs      | Same as case 2 except $  | Same as Case 2 (std Line)
    '                |                 | in month vehicle moved to|
    '----------------+-----------------+--------------------------+-------------------------------
    'TTP 10329 Billed and Booked cal spots version, when the setting "for standard lines - count MGs where they air
    'If (smAirOrder = "O" And tmClf.sType = "H") Or (smAirOrder = "O" And tmClf.sType = "S") Or (smAirOrder = "A") Then          '8-3-16 if bill as aired, test mg/out for where they should show
    '11/10/21 - JW - Fixes to TTP 10326 Billed and Booked Cal Spots
    'Do the "Outs" and "MGs"
    
    tmSmfSrchKey.lChfCode = tgChfCT.lCode
    tmSmfSrchKey.iLineNo = tmClf.iLine
    tmSmfSrchKey.iMissedDate(0) = tmClf.iStartDate(0)
    tmSmfSrchKey.iMissedDate(1) = tmClf.iStartDate(1)
    ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)
    Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tgChfCT.lCode) And (tmSmf.iLineNo = tmClf.iLine)
        ilDoe = ilDoe + 1
        If ilDoe > 10000 Then
            ilDoe = 0
            DoEvents
        End If
        'test dates later in SDF
        'Find associated spot in SDF
        If (tmSmf.sSchStatus = "O" Or tmSmf.sSchStatus = "G") Then
            'Debug.Print "mBobAdjust checking MG/OS on chfCode:" & tgChfCT.lCode & ", SmfCode:" & tmSmf.lCode & ", SmfStatus:" & tmSmf.sSchStatus & ", SdfCode:" & tmSmf.lSdfCode
            
            tmSdfSrchKey3.lCode = tmSmf.lSdfCode
            ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)
            If (ilRet = BTRV_ERR_NONE) Then
                'spot is OK, assume to adjust $ to where spot was aired  (as aired billing)
                gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                'Debug.Print " - Aired: " & slDate
                'use Month spot moved to, or month missed from?
'                If (smAirOrder = "O" And tmClf.sType = "H") Or (smAirOrder = "A" And tmClf.sType <> "S") Then
                '8-3-16 test as aired billing : if standard line, is option to show mg where it was originally ordered? (for std lines: show mg where they air is Unchecked)
                ilTempVefCode = tmSdf.iVefCode
                'TTP 10329 Billed and Booked cal spots version, when the setting "for standard lines - count MGs where they air
                If Not ilCountMGs Then        'if not counting mgs where they air; always use the original Ordered (missed) date
                    gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                    'Debug.Print " - Missed: " & slDate
                    ilTempVefCode = tmClf.iVefCode
                Else
                    'use aired Date (Aired Date is set above in slDate )
                    If (smAirOrder = "O" And tmClf.sType = "H") Or (smAirOrder = "A" And tmClf.sType <> "S") Then
                        'use aired Date
                        gUnpackDate tmSmf.iActualDate(0), tmSmf.iActualDate(1), slDate
                        'Debug.Print " - Actual: " & slDate
                    End If
                End If
                llDate = gDateValue(slDate)
                ilFoundMonth = False
                For ilMonthInx = ilFirstProjInx To ilHowManyPer Step 1         'loop thru months to find the match
                    If llDate >= llStdStartDates(ilMonthInx) And llDate < llStdStartDates(ilMonthInx + 1) Then
                        ilFoundMonth = True
                        Exit For
                    End If
                Next ilMonthInx
                ilDoAdjust = False
                If ilFoundMonth Then
                    '4-7-17 if adjusting  makegoods where they air, only add it if billing as aired
                    'if billing as ordered, adjustments overstates the $ in the future (because we were using Cal averaging from Schedule Lines (Contract) before we've evaluated where the Spots Actually are)
                    If smAirOrder = "A" Then
                        ilDoAdjust = True
                    Else        'as ordered
                        'If llDate > llStdStartDates(ilFirstProjInx) Then   'date of mg in the future, already here because as ordered billing; do not adjust since already added in for past from receivables
                         gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                         'Debug.Print " - Missed: " & slDate
                         'Debug.Print "   ilMonthInx = " & ilMonthInx & ", ilFirstProjInx=" & ilFirstProjInx & ", " & slDate & " => " & Format(llStdStartDates(ilFirstProjInx), "ddddd")
                         'TTP 10634 - If Cal Spot mode, Do the Adjustments.  if billing as ordered, there wont be any adjustments overstates the $ in the future
                         If RptSelCt.rbcSelC9(3).Value = True Then 'Cal (Spots)
                            ilDoAdjust = True
                            'Debug.Print "   Cal (Spots); doAdjust = true"
                         Else
                             If ilMonthInx >= ilFirstProjInx And gDateValue(slDate) >= llStdStartDates(ilFirstProjInx) Then       'month found in the future, check if orig missed date is in the future or has been invoiced
                                'was missed portion already invoiced?
                                ilDoAdjust = True
                                'Debug.Print "   already invoiced; doAdjust = true"
                            Else
                                'Always go thru the adjustments
                                 ilDoAdjust = ilDoAdjust
                                 'Debug.Print "   Always go thru; doAdjust = " & IIF(ilDoAdjust = 0, "false", "true")
                            End If
                        End If
                    End If
                End If
                
                If ilDoAdjust Then
                    If ilPkgPrice Then
                        '03-13-01 ilRet = gGetSpotPrice(tmSdf, tmClf, hmCff, hmSmf, hmVef, hmVsf, slPrice)
                        ilRet = gGetRate(tmSdf, tmClf, hmCff, tmSmf, tmCff, slPrice)
                    Else                        'fake it out to get price from package (instead of hidden line)
                        ilSavePkLineNo = tmClf.iLine    'save the contents of the line id since it still may be needed
                        tmClf.iLine = tmClf.iPkLineNo
                        'ilRet = gGetSpotPrice(tmSdf, tmClf, hmCff, hmSmf, hmVef, hmVsf, slPrice)
                        ilRet = gGetRate(tmSdf, tmClf, hmCff, tmSmf, tmCff, slPrice)
                        tmClf.iLine = ilSavePkLineNo
                    End If

                    If (InStr(slPrice, ".") <> 0) Then         'found spot cost and its a selected vehicle
                        ilFoundVef = False
                        'setup vehicle that spot was moved to
                        '8-3-16 if standard line and show mg where they air is unchecked, use original vehicle
                        For ilTemp = LBound(tmAdjust) To UBound(tmAdjust) - 1 Step 1
                            If tmAdjust(ilTemp).iVefCode = ilTempVefCode Then
                                ilFoundVef = True
                                Exit For
                            End If
                        Next ilTemp
                        If Not (ilFoundVef) Then
                            ReDim Preserve tmAdjust(0 To imUpperAdjust) As ADJUSTLIST
                            tmAdjust(imUpperAdjust).iVefCode = ilTempVefCode
                            ilTemp = imUpperAdjust
                            imUpperAdjust = imUpperAdjust + 1
                        End If

                        'mg $ - if ordered (update ordered or aired), put mg in same month it was ordered
                        'if update as aired, put mg where it ran
                        llActPrice = gStrDecToLong(slPrice, 2)
                        If (Asc(tgSaf(0).sFeatures2) And ACQUISITIONCOMMISSIONABLE) = ACQUISITIONCOMMISSIONABLE Then
                            ilAcqCommPct = 0
                            blAcqOK = gGetAcqCommInfoByVehicle(tmClf.iVefCode, ilAcqLoInx, ilAcqHiInx)
                            ilAcqCommPct = gGetEffectiveAcqComm(llDate, ilAcqLoInx, ilAcqHiInx)
                            gCalcAcqComm ilAcqCommPct, tmClf.lAcquisitionCost, llAcqNet, llAcqComm
                        Else
                            llAcqNet = tmClf.lAcquisitionCost
                        End If
                        
                        If imUseAcquisitionCost Then            'using acq cost only?
                            tmAdjust(ilTemp).lAcquisitionCost(ilMonthInx) = tmAdjust(ilTemp).lAcquisitionCost(ilMonthInx) + llAcqNet
                        Else
                            tmAdjust(ilTemp).lProject(ilMonthInx) = tmAdjust(ilTemp).lProject(ilMonthInx) + llActPrice    'add back in the mg that is invoiced
                            tmAdjust(ilTemp).lAcquisitionCost(ilMonthInx) = tmAdjust(ilTemp).lAcquisitionCost(ilMonthInx) + llAcqNet
                        End If
                        
                        '------------------------------------------------------------------
                        'now do the missed portion of the mg
                        gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                        llDate = gDateValue(slDate)
                        ilFoundMonth = False
                        For ilMonthInx = 1 To ilHowManyPer Step 1         'loop thru months to find the match
                            If llDate >= llStdStartDates(ilMonthInx) And llDate < llStdStartDates(ilMonthInx + 1) Then
                                ilFoundMonth = True
                                Exit For
                            End If
                        Next ilMonthInx
                        If ilFoundMonth And ilAdjustMissedForMG Then    'subtract out the missed portion of the mg?
                            If ilMonthInx >= ilFirstProjInx Then            'only adjust if its in the future
                                If imUseAcquisitionCost Then                'use acq cost only?
                                    lmAcquisition(ilMonthInx) = lmAcquisition(ilMonthInx) - tmClf.lAcquisitionCost
                                Else
                                    lmProject(ilMonthInx) = lmProject(ilMonthInx) - llActPrice    'adjust the missed portion of the mg
                                    lmAcquisition(ilMonthInx) = lmAcquisition(ilMonthInx) - tmClf.lAcquisitionCost
                                End If
                            End If
                        End If
                    End If
                Else                    'month not found for mg, find missed part of adjustment
                    gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                    llDate = gDateValue(slDate)
                    ilFoundMonth = False
                    For ilMonthInx = 1 To ilHowManyPer Step 1         'loop thru months to find the match
                        If llDate >= llStdStartDates(ilMonthInx) And llDate < llStdStartDates(ilMonthInx + 1) Then
                            ilFoundMonth = True
                            Exit For
                        End If
                    Next ilMonthInx
                    If ilFoundMonth And ilAdjustMissedForMG Then    'subtract out the missed portion of the mg?
                        'If tmMnfList(ilLoop).iBillMissMG <= 1 Or tmSdf.iMnfMissed = 0 Then     'nc missed, bill mg
                        ilDoAdjust = False
                        For illoop = LBound(tmMnfList) To UBound(tmMnfList) Step 1
                            '1=bill mg, nc missed  , 3 = bill both missed & mg
                            ilDoAdjust = True
                            Exit For
                        Next illoop
                        If ilDoAdjust Then
                            If ilPkgPrice Then
                                ilRet = gGetRate(tmSdf, tmClf, hmCff, tmSmf, tmCff, slPrice)
                            Else                        'fake it out to get price from package (instead of hidden line)
                                ilSavePkLineNo = tmClf.iLine    'save the contents of the line id since it still may be
                                                                'needed
                                tmClf.iLine = tmClf.iPkLineNo
                                ilRet = gGetRate(tmSdf, tmClf, hmCff, tmSmf, tmCff, slPrice)
                                tmClf.iLine = ilSavePkLineNo
                            End If
                            If (InStr(slPrice, ".") <> 0) Then         'found spot cost
                                llActPrice = gStrDecToLong(slPrice, 2)
                                If ilMonthInx >= ilFirstProjInx Then            'only adjust if its in the future
                                    If imUseAcquisitionCost Then                'use acq cost only?
                                        lmAcquisition(ilMonthInx) = lmAcquisition(ilMonthInx) - tmClf.lAcquisitionCost
                                    Else
                                        lmProject(ilMonthInx) = lmProject(ilMonthInx) - llActPrice    'adjust the missed portion of the mg
                                        lmAcquisition(ilMonthInx) = lmAcquisition(ilMonthInx) - tmClf.lAcquisitionCost
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            End If                          'btrv_err_none
        End If                              'schstatus = O,G
        ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        
        igDoe = igDoe + 1
        If igDoe >= 10000 Then
            DoEvents
            igDoe = 0
        End If
    Loop
End Sub

'                   Billed & Booked - determine how many slsp to split $,
'                       or how many participants (owners to split $)
'
'                   mBobGetHowManyPast ilMatchSsCode, ilHowMany, ilHowManyDefined
'                   <input> ilMatchSSCode - valid only for owner option
'                   <output> ilHowMany - Total times to loop for splits
'                            ilHowManyDefined - # of elements having values to split
'                            (i.e. There may be only 2 slsp defined, but they are not
'                            in sequence in the arrays - element 1 used, element 2 unused, element 3 used)
'                   4-5-01 obtain participants rev share for net-netoption
Sub mBobGetHowManyPast(ilMatchSSCode As Integer, ilHowMany As Integer, ilHowManyDefined As Integer, ilMnfSSCode() As Integer, ilMnfGroup() As Integer, ilProdPct() As Integer)  '7-6-05
    Dim illoop As Integer
    Dim ilRet As Integer
    'Index zero ignored in arrays below
    ReDim ilMnfSSCode(0 To 1) As Integer
    ReDim ilMnfGroup(0 To 1) As Integer
    ReDim ilProdPct(0 To 1) As Integer
    Dim ilUse100pct As Integer              '8-21-07 use 100% of participant share if rvfmnfgroup is present

    ilHowMany = 0
    ilHowManyDefined = 0
    If imSlsp Then                              'slsp option, see if slsp splits and how many
        If igRptCallType = CONTRACTSJOB And RptSelCt!lbcRptType.ListIndex = CNT_BOB And RptSelCt!ckcSelC10(0).Value = vbUnchecked Then   '8-8-06 question chged from use primary slsp only (no splits) to show splits (meaning of question changed)
            'Billed and Booked report by slsp does not want any slsp splits (as option)
            tmChf.lComm(0) = 1000000
            ilHowMany = 1
            ilHowManyDefined = 1
            For illoop = 1 To 9 Step 1
                tmChf.iSlfCode(illoop) = 0          'fake out the cnt so it doesnt have split slsp
                tmChf.lComm(illoop) = 0
            Next illoop
        Else
            For illoop = 0 To 9 Step 1
                If tmChf.iSlfCode(illoop) > 0 Then
                    ilHowMany = ilHowMany + 1
                End If
            Next illoop
            If ilHowMany = 1 And tmChf.lComm(0) = 0 Then    'theres only 1 slsp  w/o comm defined (force 100%)
                tmChf.lComm(0) = 1000000                'xxx.xxxx
            Else
                If ilHowMany > 1 Then
                    ilHowMany = 10                      'more than 1 slsp, process all 10 because some in the
                                                    'middle may not be used
                End If
            End If
            ilHowManyDefined = ilHowMany            'these % do not have to add up to 100%, so the actual
                                                    '#  of slsp to process can be the same, whereas reporting
                                                    'by owner, all $ must be accounted for and balance to the penny
        End If
    '4-5-01 obtain participants rev share for net-netoption
    ElseIf imOwner Or imTrikIfOwner Then                           '8-4-00 owner, get the vehicle groups associated with the vehicle
        'get the vehicle for this transaction
        '7-6-05 create separate array of vehicle sales source, particpants & percentages since it maybe
        'altered if the transaction has already been split
        ilUse100pct = True          '8-21-07 use 100% coming from recv if mnfgroup exists
        gInitPartGroupAndPcts tmRvf.iAirVefCode, ilMatchSSCode, tmRvf.iMnfGroup, ilMnfSSCode(), ilMnfGroup(), ilProdPct(), tmRvf.iTranDate(), tmPifKey(), tmPifPct(), ilUse100pct
        For illoop = 1 To UBound(ilMnfSSCode) Step 1
            ilHowManyDefined = UBound(ilMnfSSCode)
        Next illoop
        ilHowMany = UBound(ilMnfSSCode)
    ElseIf (imVehicle And smGrossOrNet = "B") Then                          '8-4-00 owner, get the vehicle groups associated with the vehicle
        'get the vehicle for this transaction
        '7-6-05 create separate array of vehicle sales source, particpants & percentages since it maybe
        'altered if the transaction has already been split
        ilUse100pct = False             '8-21-07 dont use 100% for participant share, search for the participants %
        gInitPartGroupAndPcts tmRvf.iAirVefCode, ilMatchSSCode, 0, ilMnfSSCode(), ilMnfGroup(), ilProdPct(), tmRvf.iTranDate(), tmPifKey(), tmPifPct(), ilUse100pct
        'For ilLoop = LBound(ilMnfSSCode) To UBound(ilMnfSSCode) Step 1
        For illoop = 1 To UBound(ilMnfSSCode) Step 1
            ilHowManyDefined = 1
        Next illoop
        ilHowMany = 1
    Else
        ilHowMany = 1
    End If
End Sub

'               mBobRvfSelect - Billed & Booked: test selection of
'                   advertiser, vehicle or agency against the Phf/Rvf file
'
'               mBobSelect return = true if rvf record is valid
'                                      false if ignore record (not a selected one)
'               <input> ilUsePkg  - true if use package (billing vehicle) vs airing (hidden) vehicle
'
'                       ilSaveSS - Sales source to test for match if selectives one chosen
'                       ilSaveSOF - sales office code to test if selective ones chosen
Function mBobRvfSelect(ilUsePkg As Integer, ilSaveSS As Integer, ilSaveSof As Integer) As Integer
    Dim ilFoundOption As Integer
    Dim ilTemp As Integer
    Dim slNameCode As String
    Dim ilRet As Integer
    Dim slCode As String
    Dim ilListIndex As Integer

    ilListIndex = RptSelCt!lbcRptType.ListIndex
    ilFoundOption = False
    If ilListIndex = CNT_SALESPLACEMENT And igRptCallType = CONTRACTSJOB Then
        'Filter Sales source
        If Not RptSelCt!ckcAll.Value = vbChecked Then
            For ilTemp = 0 To RptSelCt!lbcSelection(3).ListCount - 1
                If RptSelCt!lbcSelection(3).Selected(ilTemp) Then
                    slNameCode = tgSalesperson(ilTemp).sKey         'sales source code
                    ilRet = gParseItem(slNameCode, 2, "\", slCode)
                    If Val(slCode) = ilSaveSS Then      'sales source of this contract match one selected?
                        ilFoundOption = True
                        Exit For
                    End If
                End If
            Next ilTemp
        Else
            ilFoundOption = True
        End If
        'filter Sales Office
        If ilFoundOption Then            'found a sales source, continue with sales office; otherwise this is a contract not to be processed
            ilFoundOption = False
            If Not RptSelCt!ckcAllAAS.Value = vbChecked Then
                For ilTemp = 0 To RptSelCt!lbcSelection(2).ListCount - 1
                    If RptSelCt!lbcSelection(2).Selected(ilTemp) Then
                        slNameCode = tgSOCodeCT(ilTemp).sKey         'sales source code
                        ilRet = gParseItem(slNameCode, 2, "\", slCode)
                        If Val(slCode) = ilSaveSof Then      'sales office of this contract match one selected?
                            ilFoundOption = True
                            Exit For
                        End If
                    End If
                Next ilTemp
            Else
                ilFoundOption = True
            End If
        End If
        'filter vehicle groups
        If ilFoundOption Then            'found a sales source, continue with sales office; otherwise this is a contract not to be processed
            ilFoundOption = False
            If Not RptSelCt!CkcAllveh.Value = vbChecked And RptSelCt!lbcSelection(6).Visible = True Then
                For ilTemp = 0 To RptSelCt!lbcSelection(6).ListCount - 1
                    If RptSelCt!lbcSelection(6).Selected(ilTemp) Then
                        slNameCode = tgMnfCodeCT(ilTemp).sKey         'vehicle group selected
                        ilRet = gParseItem(slNameCode, 2, "\", slCode)
                        'If Val(slCode) = tmGrf.iPerGenl(4) Then      'test vehicle group selected vs transaction
                        If Val(slCode) = tmGrf.iPerGenl(3) Then      'test vehicle group selected vs transaction
                            ilFoundOption = True
                            Exit For
                        End If
                    End If
                Next ilTemp
            Else
                ilFoundOption = True
            End If
        End If
    Else
        ilFoundOption = True
        'imsubsort: = 1= adv, 2 = agy, 3 = bus cat, 4 = prod prot, 5 = agy, 6 = vehicle
        If imAdvt Or imSubSort = 1 Then             'major sort = advt or using minor sort = advt
            ilFoundOption = gTestIncludeExclude(tmRvf.iAdfCode, imInclAdfCodes, imUseAdfCodes())
        End If
        If Not ilFoundOption Then
            mBobRvfSelect = ilFoundOption
            Exit Function
        End If

        If imVehicle Or imSubSort = 6 Then      'major sort is vehicle or subsort = vehicle  option
            If ilUsePkg Then
                ilFoundOption = gTestIncludeExclude(tmRvf.iBillVefCode, imInclVefCodes, imUsevefcodes())
            Else
                ilFoundOption = gTestIncludeExclude(tmRvf.iAirVefCode, imInclVefCodes, imUsevefcodes())
            End If
        End If
        If Not ilFoundOption Then
            mBobRvfSelect = ilFoundOption
            Exit Function
        End If

        'cant test for business category or product protection yet since the contract has not been read
        If imAgency Or imSubSort = 2 Then
            ilFoundOption = gTestIncludeExclude(tmRvf.iAgfCode, imInclAgfCodes, imUseAgfCodes())
        End If
        If Not ilFoundOption Then
            mBobRvfSelect = ilFoundOption
            Exit Function
        End If

        If imSlsp Then                          'slsp filtered later, but it this with veh subtotals?  if so, filter out vehicle now
            ilFoundOption = True
            '8-6-10 if option swapped from vehicle w/split slsp subtotals to split slsp sort w/vehicle subtotals, check if selective vehicles
            If ((imVehSub) And (Not RptSelCt!ckcAllAAS.Value = vbChecked)) Or ((igSwapBOBOption = True) And (RptSelCt!ckcAll.Value = vbUnchecked)) Then
                ilFoundOption = False
                If ilUsePkg Then
                    ilFoundOption = gTestIncludeExclude(tmRvf.iBillVefCode, imInclVefCodes, imUsevefcodes())
                Else
                    ilFoundOption = gTestIncludeExclude(tmRvf.iAirVefCode, imInclVefCodes, imUsevefcodes())
                End If
            End If
            If ilFoundOption Then           'so far OK toinclude, check sales office
                If RptSelCt!lbcRptType.ListIndex = CNT_BOB Then          '6-19-08  only B & B by slsp has office option
                    '8-6-10 if option swapped from vehicle w/split slsp subtotals to split slsp sort w/vehicle subtotals, include all offices
                    If igSwapBOBOption Then
                        ilFoundOption = True
                    Else
                        ilFoundOption = False
                        If Not RptSelCt!CkcAllveh.Value = vbChecked Then
                            For ilTemp = 0 To RptSelCt!lbcSelection(7).ListCount - 1
                                If RptSelCt!lbcSelection(7).Selected(ilTemp) Then
                                    slNameCode = tgSOCodeCT(ilTemp).sKey         'sales source code
                                    ilRet = gParseItem(slNameCode, 2, "\", slCode)
                                    If Val(slCode) = ilSaveSof Then      'sales office of this contract match one selected?
                                        ilFoundOption = True
                                        Exit For
                                    End If
                                End If
                            Next ilTemp
                        Else
                            ilFoundOption = True
                        End If
                    End If
                End If
            End If
        End If
        If Not ilFoundOption Then
            mBobRvfSelect = ilFoundOption
            Exit Function
        End If

        If imVehGroup Or imSubSort = 7 Then                      'Sales comparison
            ilFoundOption = True                    'no selectivity of items of a vehicle group
        End If

        If ilFoundOption And ((ilListIndex = CNT_SALESCOMPARE Or ilListIndex = CNT_BOB Or ilListIndex = CNT_BOBRECAP Or ilListIndex = CNT_BOBCOMPARE) And (igRptCallType = CONTRACTSJOB)) Then
            'if the record is valid for inclusion/exclusion of politicals and non-politicals
            If mCheckAdvPolitical(tmRvf.iAdfCode) Then          'its a political, include this contract?
                 If Not imInclPolit Then
                    'Changed 8/31/06
                    ilFoundOption = False
                End If

            Else                                                'not a political advt, include this contract?
                'If RptSelCt!ckcSelC6(2).Value = vbUnchecked Then        'dont include the non-politicals
                 If Not imInclNonPolit Then
                    'Changed 8/31/06
                    ilFoundOption = False
                End If
            End If
        End If
    End If

    '11-1-07 All B & B Comparisons options have the vehicle selectivity
    If ilFoundOption And (ilListIndex = CNT_BOBCOMPARE) Then
        ilFoundOption = gTestIncludeExclude(tmRvf.iAirVefCode, imInclVefCodes, imUsevefcodes())
    End If

    mBobRvfSelect = ilFoundOption
End Function

'               for Sales Comparison:  mBobTestCatProt - if option
'                   by Business Category or Product Protection,
'                   see if valid selection
'
'               Return: True if valid selection
Function mBobTestCatProt() As Integer
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  ilLoopSlsp                    slNameCode                    slCode                    *
    '*  ilRet                                                                                 *
    '******************************************************************************************
    Dim ilFoundOption As Integer
    
    ilFoundOption = True
    If imBusCat Or imSubSort = 3 Then   'subsort used in Sales Comparison for secondary subtotals
        ilFoundOption = False
        ilFoundOption = gTestIncludeExclude(tmChf.iMnfBus, imInclCatCodes, imUseCatCodes())
    ElseIf imProdProt Or imSubSort = 4 Then  'subsort used in Sales Comparison for secondary subtotals
        ilFoundOption = False
        ilFoundOption = gTestIncludeExclude(tmChf.iMnfComp(0), imInclProdCodes, imUseProdCodes())
    End If
    mBobTestCatProt = ilFoundOption
End Function

'               mBobNewCode - determine if the contract is a New
'                   Revenue Status.  If so, setup field in GRF
'                   so that it can be flagged on the report.
'
'                   <input> - ilNewCode : mnf code  of "New" Revenue area
'                             Chf image - either tmchf or tgChfCt to test revenue areas
'                   <Return> - 0 = show nothing, 1 = New (show N), 2 = NewHold(show h), 3= Return hold (show H)
'
'                   Created: 5/7/98
Function mBobTestNew(ilNewCode As Integer, tlChf As CHF) As Integer
    Dim illoop As Integer
    Dim ilFoundNew As Integer
    
    ilFoundNew = False
    mBobTestNew = 0
    For illoop = 1 To 5
        If tlChf.iMnfRevSet(illoop - 1) = ilNewCode Then
            ilFoundNew = True
            Exit For
        End If
    Next illoop
    If tlChf.sStatus = "H" Or tlChf.sStatus = "G" Then          'test for hold
        If ilFoundNew Then
            mBobTestNew = 2                         'New Hold, show h for New Hold
        Else
            mBobTestNew = 3                         'probably return , show H for Hold
        End If
    Else                                                        'not hold
        If ilFoundNew Then
            mBobTestNew = 1                            'New contract, show N
        End If
    End If
End Function

'                   Billed & Booked - test contract types against
'                       the user requested types to include
'
'                   Return - true if valid contract to use
'                            false to ignore the contract
'
'           8-9-06 Make NTR a type of its own.  Do not check the contract
'           types as a condition for including/excluding NTR and Hard cost
Function mBobTestTypes() As Integer
    Dim ilMatchCntr As Integer
    ilMatchCntr = True
    If tmChf.lCntrNo <> tmRvf.lCntrNo Or tmChf.sSchStatus <> "F" And tmChf.sSchStatus <> "M" And tmChf.sSchStatus <> "N" Or (lmSingleCntr > 0 And lmSingleCntr <> tmRvf.lCntrNo) Then
        ilMatchCntr = False
    End If

    If tmRvf.iMnfItem = 0 Then              'NTR are its own type, dont check contract types
        If tmChf.sStatus = "H" And Not imHold Then    'include holds
            ilMatchCntr = False
        End If
        If tmChf.sStatus = "O" And Not imOrder Then    'include orders
            ilMatchCntr = False
        End If
        If tmChf.sType = "C" And Not imStandard Then  'include std cntrs?
            ilMatchCntr = False
        End If
        If tmChf.sType = "V" And Not imReserv Then  'include reserves?
            ilMatchCntr = False
        End If
        If tmChf.sType = "T" And Not imRemnant Then  'include remnants?
            ilMatchCntr = False
        End If
        If tmChf.sType = "R" And Not imDR Then  'direct response?
            ilMatchCntr = False
        End If
        If tmChf.sType = "Q" And Not imPI Then  'per inquiry?
            ilMatchCntr = False
        End If
        If tmChf.sType = "S" And Not imPSA Then  'psa?
            ilMatchCntr = False
        End If
        If tmChf.sType = "M" And Not imPromo Then  'promo?
            ilMatchCntr = False
        End If
        'If tmChf.iPctTrade = 100 And Not imTrade Then  'trades?
        If tmRvf.sCashTrade = "T" And Not imTrade Then  'trades?
            ilMatchCntr = False
        End If
    End If
    mBobTestTypes = ilMatchCntr
End Function

'               mBRDaystimes - Format Days & Times to print for each
'                   schedule line on the Broadcast Contract printout
'
'               <input> ilLoop - index into the array (tmLNR) containing data to process
'                       slDailyExists - Y if at least one daily exists on the order, else N
'               mBRDaysTimes ilLoop
'
'               created:  4/22/98
'                         5/25/00 Dayparts for a vehicle sometimes printing out of DP sort order
'                         11-19-02 Implement daily buys
'                         5-21-03 Implement flag to know if the contract has at least one daily line.  Special
'                           format on printed contract to show vertical lines separating days of the week
Sub mBRDaysTimes(illoop As Integer, slDailyExists As String, tlSofList() As SOFLIST, ilListIndex As Integer)
    Dim ilRet As Integer
    Dim ilLoop2 As Integer
    Dim ilShowOVDays As Integer
    Dim ilShowOVTimes As Integer
    Dim slStr As String
    Dim ilTemp As Integer
    Dim slPrefStartTime As String
    Dim slPrefEndTime As String
    Dim slPrefDays As String
    Dim slTempDays As String
    Dim ilDays(0 To 6) As Integer
    Dim slPrefDaysOfWk(0 To 6) As String * 1
    Dim slDay As String
    Dim slOVStartTime As String
    Dim slOVEndTime As String
    Dim ilPrefDaysExists As Integer
    Dim ilLoop3 As Integer
    Dim llrunningStartTime As Long
    Dim llrunningEndtime As Long
    Dim ilXMid As Integer
    Dim slOVTemp As String
    Dim ilAnfIndex As Integer
    Dim llLineRef As Long
        
    tmCbf.lRate = tmLnr(illoop).lRate
    tmCbf.sPriceType = tmLnr(illoop).sPriceType     '2-23-01 sch line price type (adu, recap, bonus, etc)
    tmCbf.sDysTms = tmLnr(illoop).sValidDays
    slOVStartTime = ""                      '7-8-05
    slOVEndTime = ""
    If ilListIndex = CNT_INSERTION Then
        'loop thru unique list of vehicles to detrmine if each vehcle is only weekly, or at least 1 daily exists for the vehicle
        For ilTemp = LBound(tlSofList) To UBound(tlSofList) - 1
            If tlSofList(ilTemp).iMnfSSCode = tmClf.iVefCode Then
                If tlSofList(ilTemp).iSofCode = True Then   'at least 1 daily
                    tmCbf.sDailyExists = "Y"
                    If tmLnr(illoop).sDailyWkly = "D" Then
                        tmCbf.sDailyWkly = "1"
                    Else
                        tmCbf.sDailyWkly = "2"
                    End If
                Else
                    tmCbf.sDailyExists = "N"
                    tmCbf.sDailyWkly = "0"
                End If
                Exit For
            End If
        Next ilTemp
    Else
        'tmCbf.sDailyWkly: 0 = no dailies, 1 = daily line, 2 = wkly line but there are dailies on this order
        If slDailyExists = "N" Then        '5-21-03
            tmCbf.sDailyWkly = "0"            'weekly only
        Else
            If tmLnr(illoop).sDailyWkly = "D" Then
                tmCbf.sDailyWkly = "1"
            Else
                tmCbf.sDailyWkly = "2"
            End If
        End If
    End If
    tmCbf.iLen = tmClf.iLen
    tmCbf.lLineNo = CLng((tmClf.iLine) * CLng(1000)) + tmClf.iCntRevNo
    tmCbf.iVefCode = tmClf.iVefCode
    tmCbf.lRafCode = tmClf.lRafCode '8-30-06

    '3-28-05 open/close bb len
    tmCbf.iOBBLen = tmClf.iBBOpenLen
    tmCbf.iCBBLen = tmClf.iBBCloseLen
    tmCbf.sCBS = ""             'flag to indicate to crystal how to show the open/close bb
    If ((Asc(tgSpf.sUsingFeatures6) And BBCLOSEST) = BBCLOSEST) Then    'use closest avail, dont know if its open or close
        tmCbf.sCBS = "C"       'flag to use closest to show on report
    Else                            'open & closes are defined
       tmCbf.sCBS = "S"        'use specific avail
    End If
    
    llLineRef = tmClf.iLine
    If tmClf.sType = "H" Then
        llLineRef = tmClf.iPkLineNo
    End If
    mSetResortField tmClf.sType, llLineRef               '1-7-21

    tmRdfSrchKey.iCode = tmClf.iRdfCode
    ilRet = btrGetEqual(hmRdf, tmRdf, imRdfRecLen, tmRdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'find matching r/c recd
    If ilRet <> BTRV_ERR_NONE Then
        tmCbf.sDysTms = "Missing DP"
        Exit Sub
    End If
    For ilLoop2 = 0 To 6 Step 1
        If tmRdf.sWkDays(6, ilLoop2) = "Y" Then             'is DP is a valid day

            If tmLnr(illoop).iCffDays(ilLoop2) >= 0 Then         '11-19-02 is flight a valid day? 0=invalid day, >1 = daily # spots
                ilShowOVDays = True
                Exit For
            Else
                ilShowOVDays = False
            End If
        End If
    Next ilLoop2
    'Times
    ilShowOVTimes = False
    '3-6-07 determine how to sort the order:  using R/C Items sort code, DP sort code, or Sch Line #
    tmCbf.iRdfDPSort = gFindDPSort(tmMRif(), tmMRDF(), tmClf.iRdfCode, tmClf.iVefCode)
    If tmCbf.iRdfDPSort < 0 Then
        tmCbf.iRdfDPSort = tmClf.iLine
    End If
    If ((tmClf.iStartTime(0) <> 1) Or (tmClf.iStartTime(1) <> 0)) And ((tmClf.iEndTime(0) <> 1) Or (tmClf.iEndTime(1) <> 0)) Then
        gUnpackTime tmClf.iStartTime(0), tmClf.iStartTime(1), "A", "1", slOVStartTime       '7-8-05
        gUnpackTime tmClf.iEndTime(0), tmClf.iEndTime(1), "A", "1", slOVEndTime
        'init the daypart code so it won't print
        ilShowOVTimes = True
        gAdjOverrideTimes tmClf.iVefCode, slOVStartTime, slOVEndTime    'adjust the override times to a specified time zone (site) if applicable
        slOVTemp = slOVStartTime & "-" & slOVEndTime
    Else
        'Add times
        ilXMid = False
        'if there are multiple segments and it cross midnight, show the earliest start time and xmidnight end time;
        'otherwise the first segments start and end times are shown
        slOVTemp = ""           'init forming of dp segment times
        For ilLoop2 = LBound(tmRdf.iStartTime, 2) To UBound(tmRdf.iStartTime, 2) Step 1 'Row
               If (tmRdf.iStartTime(0, ilLoop2) <> 1) Or (tmRdf.iStartTime(1, ilLoop2) <> 0) Then
                gUnpackTime tmRdf.iStartTime(0, ilLoop2), tmRdf.iStartTime(1, ilLoop2), "A", "1", slOVStartTime '7-8-05
                gUnpackTime tmRdf.iEndTime(0, ilLoop2), tmRdf.iEndTime(1, ilLoop2), "A", "1", slOVEndTime
                gUnpackTimeLong tmRdf.iEndTime(0, ilLoop2), tmRdf.iEndTime(1, ilLoop2), True, llrunningEndtime
                'If llrunningEndtime = 86400 And ilLoop2 <> 7 Then     '6-8-10 if the running time is 12m and its not the first entry, process for x-midnite
                If llrunningEndtime = 86400 And ilLoop2 <> UBound(tmRdf.iStartTime, 2) Then     '6-8-10 if the running time is 12m and its not the first entry, process for x-midnite
                    ilXMid = True
                End If
                For ilLoop3 = ilLoop2 + 1 To UBound(tmRdf.iStartTime, 2)
                    gUnpackTimeLong tmRdf.iStartTime(0, ilLoop3), tmRdf.iStartTime(1, ilLoop3), False, llrunningStartTime
                     If llrunningStartTime = 0 And llrunningEndtime = 86400 Then
                        If ilXMid Then
                            gUnpackTime tmRdf.iEndTime(0, ilLoop3), tmRdf.iEndTime(1, ilLoop3), "A", "1", slOVEndTime
                            Exit For
                        End If
                    Else
                        gUnpackTimeLong tmRdf.iEndTime(0, ilLoop3), tmRdf.iEndTime(1, ilLoop3), True, llrunningEndtime
                    End If
                Next ilLoop3
                
                '4-12-10 show all times defined in the DP when there is an override
                gAdjOverrideTimes tmClf.iVefCode, slOVStartTime, slOVEndTime        'adjust the times (by option in Site), if x-mid daypart
                If slOVTemp = "" Then
                    slOVTemp = slOVStartTime & "-" & slOVEndTime
                Else
                    slOVTemp = slOVTemp & "," & slOVStartTime & "-" & slOVEndTime
                End If
                If ilXMid Then
                    ilShowOVTimes = True
                    Exit For
                End If
            End If
        Next ilLoop2
    End If

    slPrefDays = tmCbf.sDysTms          'default if no preferred days defined and the preferred must be shown
    If ilShowOVDays Or ilShowOVTimes Then
        '4-14-11 option to choose what to show as additional description when DP overrides exist
        If tmRdf.sOverridePrtRules = "D" Then   'show DP name
            tmCbf.sDysTms = RTrim$(tmCbf.sDysTms) & " " & Trim$(slOVTemp) & sgCR & sgLF & "(" & Trim$(tmRdf.sName) & ")"     '4-14-11 show the DP name along with the override desc
        ElseIf tmRdf.sOverridePrtRules = "A" Then  'show Avail Name
            ilAnfIndex = gBinarySearchAnf(tmRdf.ianfCode, tmAnfTable())
            If ilAnfIndex <> -1 Then
                'include or exclude the AVail
                If tmRdf.sInOut = "I" Then      'include avail
                    tmCbf.sDysTms = RTrim$(tmCbf.sDysTms) & " " & Trim$(slOVTemp) & sgCR & sgLF & "(" & Trim$(tmAnfTable(ilAnfIndex).sName) & ")"     '4-14-11 show the DP name along with the override desc
               Else                            'exclude avail
                    tmCbf.sDysTms = RTrim$(tmCbf.sDysTms) & " " & Trim$(slOVTemp) & sgCR & sgLF & "(Excl " & Trim$(tmAnfTable(ilAnfIndex).sName) & ")"     '4-14-11 show the DP name along with the override desc
                End If
            Else
                tmCbf.sDysTms = RTrim$(tmCbf.sDysTms) & " " & Trim$(slOVTemp)
            End If
        Else
            tmCbf.sDysTms = RTrim$(tmCbf.sDysTms) & " " & Trim$(slOVTemp)
        End If
        'slOVStartTime & slOVEndTime will be needed incase there are preferred times
        'init the daypart code to it won't print .  Print overrride time instead
                                             'research disclaimer on printed contract summary
        If (imHiddenOverride And HIDDENOVERRIDE) = HIDDENOVERRIDE And tmClf.sType = "H" Then
            tmCbf.sHiddenOverride = "Y"     '3-10-06 show Site Research disclaimer on contract
        End If
    Else
        tmCbf.sDysTms = tmRdf.sName
    End If

    ilPrefDaysExists = False        'assume preferred days do not exists
    If (tmClf.iPrefStartTime(0) = 1 And tmClf.iPrefStartTime(1) = 0) And (tmClf.sPrefDays(0) = "") Then         'test for preferred days or times
        'no preferred times
        ilRet = ilRet
    Else
        gUnpackTime tmClf.iPrefStartTime(0), tmClf.iPrefStartTime(1), "A", "1", slPrefStartTime
        gUnpackTime tmClf.iPrefEndTime(0), tmClf.iPrefEndTime(1), "A", "1", slPrefEndTime


        If tmClf.sPrefDays(0) <> "" Then
            For ilTemp = 0 To 6
                slPrefDaysOfWk(ilTemp) = ""     'unused for now, reqd for gDaynames parameter
                If tmClf.sPrefDays(ilTemp) = "Y" Then
                    ilDays(ilTemp) = 1
                    ilPrefDaysExists = True
                Else
                    ilDays(ilTemp) = 0
                End If
            Next ilTemp

            If ilPrefDaysExists Then
                slPrefDays = ""
                slTempDays = gDayNames(ilDays(), slPrefDaysOfWk(), 2, slStr)            'slstr not needed when returned
                For ilTemp = 1 To Len(slTempDays) Step 1
                    slDay = Mid$(slTempDays, ilTemp, 1)
                    If slDay <> " " And slDay <> "," Then
                        slPrefDays = Trim$(slPrefDays) & Trim$(slDay)
                    End If
                Next ilTemp
            Else
                'preferred days dont exist, show
                    If tmLnr(illoop).sDailyWkly = "D" Then      'daily vs wkly
                     slPrefDays = ""
                    slTempDays = gDayNames(ilDays(), slPrefDaysOfWk(), 2, slStr)            'slstr not needed when returned
                    For ilTemp = 1 To Len(slTempDays) Step 1
                        slDay = Mid$(slTempDays, ilTemp, 1)
                        If slDay <> " " And slDay <> "," Then
                            slPrefDays = Trim$(slPrefDays) & Trim$(slDay)
                        End If
                    Next ilTemp
                End If
            End If

        End If
        If slPrefStartTime <> "" Or ilPrefDaysExists Then
            If slPrefStartTime = "" Then
                slPrefStartTime = slOVStartTime
                slPrefEndTime = slOVEndTime
            End If
            tmCbf.sPrefDT = Trim$(slPrefDays) & " " + Trim$(slPrefStartTime) & "-" & Trim$(slPrefEndTime)
        End If
     End If
End Sub

'           mBRInputDates - convert Start/End dates for
'               Active and Entered to long
'
'           <Output> llActiveStartDate - User entered active start date
'                                       (set to 1/5/1970 if nothing entered)
'                   llActiveEndDate - user entered active end date
'                                       (set to 12/29/2069 if nothing entered)
'                   llEnterStartDate - User entered contract entered start date
'                                       (set to 1/5/1970 if nothing entered)
'                   llEnterEndDate - user entered contract entered end date
'                                       (set to 12/29/2069 if nothing entered)
'           These dates are used to filter the contracts based on date selectivity
Sub mBRInputDates(llActiveStartDate As Long, llActiveEndDate As Long, llEnterStartDate As Long, llEnterEndDate As Long)
    Dim slStartDate As String
    
    slStartDate = RptSelCt!CSI_CalFrom.Text         'Date: 1/15/2020 added CSI calendar control for date entries --> edcSelCFrom.Text   'Start date
    If slStartDate = "" Then
        slStartDate = "1/5/1970" 'Monday
    End If
    slStartDate = gObtainPrevMonday(slStartDate)
    llActiveStartDate = gDateValue(slStartDate)
    
    slStartDate = RptSelCt!CSI_CalTo.Text           'Date: 1/15/2020 added CSI calendar control for date entries --> edcSelCFrom1.Text   'End date
    If (StrComp(slStartDate, "TFN", 1) = 0) Or (Len(slStartDate) = 0) Then
        llActiveEndDate = gDateValue("12/29/2069")    'Sunday
    Else
        slStartDate = gObtainNextSunday(slStartDate)
        llActiveEndDate = gDateValue(slStartDate)
    End If
    
    slStartDate = RptSelCt!CSI_From1.Text           'Date: 1/15/2020 added CSI calendar control for date entries --> edcSelCTo.Text   'Start date
    If slStartDate = "" Then
        slStartDate = "1/5/1970" 'Monday
        slStartDate = gObtainPrevMonday(slStartDate)
    End If
    llEnterStartDate = gDateValue(slStartDate)
    
    slStartDate = RptSelCt!CSI_To1.Text             'Date: 1/15/2020 added CSI calendar control for date entries --> edcSelCTo1.Text   'End date
    If (StrComp(slStartDate, "TFN", 1) = 0) Or (Len(slStartDate) = 0) Then
        llEnterEndDate = gDateValue("12/29/2069")    'Sunday
    Else
        llEnterEndDate = gDateValue(slStartDate)
    End If
End Sub

'           Generate the Quarterly Research totals for packages only
'           3-25-08 Hidden lines may include the orig line and the line that has been changed to show
'                   the increase or decrease of spots/$. (Change in $ shows a 2nd line on the printed
'                   contract for differences).  When a decrease in spots occurs, it results in zero grimps, grps, etc.
'                   The Orig line will have the grimps, grps, etc and both the orig and the zero values will
'                   be sent to gResearchTotals; which results in no avg rating when theres a decrease.
'                   For example:  Pkg line with 12 spots and 3 hidden lines, each with 4 spots in the week.
'                   The week is deleted.  Diff only version will show the hidden line with the orig 4 spots in each week
'                   then another line showing the decrease of the 4 spots. This is the line with no grps, cpp, grimps, etc.
'                   All of that is sent to gResearchTotals which returns no avg rtg and avg aud; but other
'                   reserach info is returned.
Sub mBRPkgQtrTotals(ilPkgLineList() As Integer, ilVehList() As Integer, ilPkgVehList() As Integer)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  ilVehicle                                                                             *
    '******************************************************************************************
    
    Dim ilPkg As Integer
    'Dim ilQtr As Integer
    Dim ilTemp As Integer
    'ReDim llPkgWkGrp(1 To 14) As Long       '11-14'11
    ReDim llPkgWkGrp(0 To 14) As Long       '11-14'11. Index zero ignored
    Dim llLnSpots As Long
    'Dim ilRchQtr As Integer
    Dim llResearchPop As Long
    'Dim llTemp As Long
    Dim dlTemp As Double 'TTP 10439 - Rerate 21,000,000
    Dim llQtr As Long               '4-10-19 replace ilQtr due to subscript out of range
    Dim llRchQtr As Long            '4-10-19 replace ilRchQtr due to subscript out of range
    
    'For Packages Only........
    'Create array of grps, weekly rating, grimps and rates to pass to routine to generate qtrly totals for individual
    'line packages.  (combination of all hidden lines for 1 package line)
    For ilPkg = LBound(ilPkgLineList) To UBound(ilPkgLineList) - 1 Step 1
        For llQtr = 1 To imMaxQtrs Step 1
            ReDim tmPkLnCost(0 To 0) As Long
            ReDim tmPkLnGRP(0 To 0) As Long
            ReDim tmPkLnGrimp(0 To 0) As Long
            ReDim llPkgWkGrp(0 To imWeeksPerQtr(llQtr)) As Long
            For ilTemp = 1 To imWeeksPerQtr(llQtr)      '11-14-11 handle varying qtrs
                llPkgWkGrp(ilTemp) = 0
            Next ilTemp
            llLnSpots = 0
            'get each package vehicle for a quarter at a time (detail option)
            If tgSpf.sDemoEstAllowed = "Y" Then     '6-1-04
                llResearchPop = -1
            End If
            For llRchQtr = llQtr To UBound(tmLRch) - 1 Step 8
                If tmLRch(llRchQtr).iLineNo = ilPkgLineList(ilPkg) Then
                    llLnSpots = llLnSpots + tmLRch(llRchQtr).lQSpots
                End If
                If tmLRch(llRchQtr).lQSpots <> 0 And tmLRch(llRchQtr).iPkLineNo = ilPkgLineList(ilPkg) Then
                    If tgSpf.sDemoEstAllowed = "Y" Then         '6-1-04
                        If llResearchPop = -1 Then
                            llResearchPop = tmLRch(llRchQtr).lSatelliteEst
                        Else
                            If llResearchPop <> tmLRch(llRchQtr).lSatelliteEst And llResearchPop <> 0 Then
                                llResearchPop = 0
                            End If
                        End If
                    Else
                        '11-11-05 use pkg pop by line (not by unique veh) for detail sch line research
                        llResearchPop = lmPopPkgByLine(ilPkg)
                    End If
                    tmPkLnCost(UBound(tmPkLnCost)) = tmLRch(llRchQtr).dTotalCost 'TTP 10439 - Rerate 21,000,000
                    tmPkLnGRP(UBound(tmPkLnGRP)) = tmLRch(llRchQtr).lTotalGRP
                    tmPkLnGrimp(UBound(tmPkLnGrimp)) = tmLRch(llRchQtr).lTotalGrimps
                    ReDim Preserve tmPkLnCost(LBound(tmPkLnCost) To UBound(tmPkLnCost) + 1) As Long
                    ReDim Preserve tmPkLnGRP(LBound(tmPkLnGRP) To UBound(tmPkLnGRP) + 1) As Long
                    ReDim Preserve tmPkLnGrimp(LBound(tmPkLnGrimp) To UBound(tmPkLnGrimp) + 1) As Long
                    For ilTemp = 1 To imWeeksPerQtr(llQtr)          '11-14-11
                        llPkgWkGrp(ilTemp) = llPkgWkGrp(ilTemp) + tmLRch(llRchQtr).lWklyGRP(ilTemp - 1)
                    Next ilTemp
                End If
            Next llRchQtr               'loop to get next lines same qtr
            If UBound(tmPkLnCost) > LBound(tmPkLnCost) Then      '4/7/99 Avg Rating eliminated from computations
                'dimensions must be exact sizes
                ReDim Preserve tmPkLnCost(LBound(tmPkLnCost) To UBound(tmPkLnCost) - 1) As Long
                ReDim Preserve tmPkLnGRP(LBound(tmPkLnGRP) To UBound(tmPkLnGRP) - 1) As Long
                ReDim Preserve tmPkLnGrimp(LBound(tmPkLnGrimp) To UBound(tmPkLnGrimp) - 1) As Long
                '4/7/99
                'gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmPkLnCost(), tmPkLnGrimp(), tmPkLnGRP(), llLnSpots, llTemp, tmCbf.iAvgRate, tmCbf.lVQGrimp, tmCbf.lVQGRP, tmCbf.lVQCPP, tmCbf.lVQCPM, tmCbf.lAvgAud
                gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmPkLnCost(), tmPkLnGrimp(), tmPkLnGRP(), llLnSpots, dlTemp, tmCbf.iAvgRate, tmCbf.lVQGrimp, tmCbf.lVQGRP, tmCbf.lVQCPP, tmCbf.lVQCPM, tmCbf.lAvgAud 'TTP 10439 - Rerate 21,000,000
            End If
            'Research totals for a quarter for each hidden line of the package has been gathered
            'Place the totals into the package line
            For llRchQtr = llQtr To UBound(tmLRch) - 1 Step 8
                If tmLRch(llRchQtr).iLineNo = ilPkgLineList(ilPkg) And tmLRch(llRchQtr).lQSpots <> 0 Then
                    tmLRch(llRchQtr).lTotalCPP = tmCbf.lVQCPP
                    tmLRch(llRchQtr).lTotalCPM = tmCbf.lVQCPM
                    tmLRch(llRchQtr).lTotalGRP = tmCbf.lVQGRP
                    tmLRch(llRchQtr).lTotalGrimps = tmCbf.lVQGrimp
                    tmLRch(llRchQtr).iTotalAvgRating = tmCbf.iAvgRate
                    tmLRch(llRchQtr).lTotalAvgAud = tmCbf.lAvgAud       '4/7/99
                    'tmLRch(llRchQtr).lTotalCost = llTemp
                    tmLRch(llRchQtr).dTotalCost = dlTemp 'TTP 10439 - Rerate 21,000,000
                    tmLRch(llRchQtr).lSatelliteEst = llResearchPop      '6-1-04

                    For ilTemp = 1 To imWeeksPerQtr(llQtr)          '11-14-11
                        tmLRch(llRchQtr).lWklyGRP(ilTemp - 1) = llPkgWkGrp(ilTemp)
                    Next ilTemp
                    'the weekly totals only gets updated once for the package
                    For ilTemp = 1 To imWeeksPerQtr(llQtr)      '11-14-11
                        llPkgWkGrp(ilTemp) = 0
                    Next ilTemp
                End If
            Next llRchQtr
        Next llQtr
    Next ilPkg
    Erase llPkgWkGrp                '11-4-13
End Sub

'           mBRPkgVehTotals ilPkgLineList, ilVehlist, ilPkgVehList
'           Get the package totals by line and place them into
'           the package lines buckets and show on detail line only
Sub mBRPkgVehTotals(ilPkgLineList() As Integer, ilVehList() As Integer, ilPkgVehList() As Integer)
    Dim ilPkg As Integer
    Dim llLnSpots As Long
    Dim ilFound As Integer
    Dim llResearchPop As Long
    Dim ilVehicle As Integer
    Dim dlTemp As Double 'TTP 10439 - Rerate 21,000,000
    Dim ilWeekly As Integer
    Dim ilWeeklyMinusOne As Integer
    Dim ilUpperGrp As Integer
    Dim illoop As Integer
    ReDim tmWkPkgVGrps(0 To 0) As WEEKLYGRPS
    Dim llQtr As Long                   '4-10-19    replace ilQtr due to subscript out of range
    Dim llRchQtr As Long                '4-10-19    replace ilRchQtr
    Dim llVaryingQtrs As Long           '4-10-19    replace ilVaryingQtrs
    ilUpperGrp = 0
    'For Packages Only (Get the totals by package line)........
    'Create array of grps, weekly rating, grimps and rates to pass to routine to generate qtrly totals for individual
    'line packages.  (combination of all hidden lines for 1 package line)
    For ilPkg = LBound(ilPkgLineList) To UBound(ilPkgLineList) - 1 Step 1
        llVaryingQtrs = 0           '11-14-11 handle varying qtrs
        For llQtr = 1 To imMaxQtrs
            For ilWeekly = 1 To imWeeksPerQtr(llQtr)
                ilWeeklyMinusOne = ilWeekly - 1
                ReDim tmPkLnCost(0 To 0) As Long
                ReDim tmPkLnGRP(0 To 0) As Long
                ReDim tmPkLnGrimp(0 To 0) As Long
                llLnSpots = 0

                For llRchQtr = llQtr To UBound(tmLRch) - 1 Step 8       '5-16-00

                    If tmLRch(llRchQtr).iPkLineNo = ilPkgLineList(ilPkg) Then
                        llLnSpots = llLnSpots + tmLRch(llRchQtr).lSpots(ilWeeklyMinusOne)
                        For ilVehicle = LBound(ilVehList) To UBound(ilVehList) - 1 Step 1
                            llResearchPop = 0
                            If ilVehList(ilVehicle) = ilPkgVehList(ilPkg) Then
                                If tgSpf.sDemoEstAllowed = "Y" Then
                                    llResearchPop = -1
                                    Exit For
                                Else
                                    'llResearchPop = lmPopPkg(ilVehicle)     '11-24-04   ; removed 3-15-19 , and replace with below
                                    llResearchPop = lmPopPkgByLine(ilPkg)           '3-15-19
                                    Exit For
                                End If
                            End If
                        Next ilVehicle
                        'look only for the matching hidden line
                        If (tmLRch(llRchQtr).lSpots(ilWeeklyMinusOne)) <> 0 And tmLRch(llRchQtr).iPkLineNo = ilPkgLineList(ilPkg) Then

                            tmPkLnCost(UBound(tmPkLnCost)) = tmLRch(llRchQtr).lRates(ilWeeklyMinusOne)
                            tmPkLnGRP(UBound(tmPkLnGRP)) = tmLRch(llRchQtr).lWklyGRP(ilWeeklyMinusOne)
                            tmPkLnGrimp(UBound(tmPkLnGrimp)) = tmLRch(llRchQtr).lWklyGrimp(ilWeeklyMinusOne)

                            If tgSpf.sDemoEstAllowed = "Y" Then
                                If llResearchPop = -1 Then
                                    llResearchPop = tmLRch(llRchQtr).lPopEst(ilWeeklyMinusOne)
                                Else
                                    If llResearchPop <> tmLRch(llRchQtr).lPopEst(ilWeeklyMinusOne) And llResearchPop <> 0 Then
                                        llResearchPop = 0
                                    End If
                                End If
                            End If

                            ReDim Preserve tmPkLnCost(LBound(tmPkLnCost) To UBound(tmPkLnCost) + 1) As Long
                            ReDim Preserve tmPkLnGRP(LBound(tmPkLnGRP) To UBound(tmPkLnGRP) + 1) As Long
                            ReDim Preserve tmPkLnGrimp(LBound(tmPkLnGrimp) To UBound(tmPkLnGrimp) + 1) As Long
                        End If
                    End If
                Next llRchQtr
                If UBound(tmPkLnCost) > LBound(tmPkLnCost) Then      '4/7/99 Avg Rating eliminated from computations
                    'dimensions must be exact sizes
                    ReDim Preserve tmPkLnCost(LBound(tmPkLnCost) To UBound(tmPkLnCost) - 1) As Long
                    ReDim Preserve tmPkLnGRP(LBound(tmPkLnGRP) To UBound(tmPkLnGRP) - 1) As Long
                    ReDim Preserve tmPkLnGrimp(LBound(tmPkLnGrimp) To UBound(tmPkLnGrimp) - 1) As Long
                    llRchQtr = llVaryingQtrs + ilWeekly
                    'only care about the weeks grps
                    ilFound = False
                    For illoop = LBound(tmWkPkgVGrps) To UBound(tmWkPkgVGrps) - 1
                        If tmWkPkgVGrps(illoop).iVefCode = ilPkgLineList(ilPkg) Then
                            ilFound = True
                            Exit For
                        End If
                    Next illoop
                    If ilFound Then
                        '4/7/99
                        'gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmPkLnCost(), tmPkLnGrimp(), tmPkLnGRP(), llLnSpots, llTemp, tmCbf.iAvgRate, tmCbf.lVQGrimp, tmWkPkgVGrps(illoop).lGrps(llRchQtr), tmCbf.lVQCPP, tmCbf.lVQCPM, tmCbf.lAvgAud
                        gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmPkLnCost(), tmPkLnGrimp(), tmPkLnGRP(), llLnSpots, dlTemp, tmCbf.iAvgRate, tmCbf.lVQGrimp, tmWkPkgVGrps(illoop).lGrps(llRchQtr), tmCbf.lVQCPP, tmCbf.lVQCPM, tmCbf.lAvgAud 'TTP 10439 - Rerate 21,000,000
                    Else
                        tmWkPkgVGrps(ilUpperGrp).iVefCode = ilPkgLineList(ilPkg)
                        'gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmPkLnCost(), tmPkLnGrimp(), tmPkLnGRP(), llLnSpots, llTemp, tmCbf.iAvgRate, tmCbf.lVQGrimp, tmWkPkgVGrps(ilUpperGrp).lGrps(llRchQtr), tmCbf.lVQCPP, tmCbf.lVQCPM, tmCbf.lAvgAud
                        gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmPkLnCost(), tmPkLnGrimp(), tmPkLnGRP(), llLnSpots, dlTemp, tmCbf.iAvgRate, tmCbf.lVQGrimp, tmWkPkgVGrps(ilUpperGrp).lGrps(llRchQtr), tmCbf.lVQCPP, tmCbf.lVQCPM, tmCbf.lAvgAud 'TTP 10439 - Rerate 21,000,000
                        ilUpperGrp = UBound(tmWkPkgVGrps) + 1
                        ReDim Preserve tmWkPkgVGrps(0 To ilUpperGrp) As WEEKLYGRPS
                    End If
                End If
            Next ilWeekly
            llVaryingQtrs = llVaryingQtrs + imWeeksPerQtr(llQtr)
        Next llQtr
    Next ilPkg
End Sub

'                   mBobBuildFlights - Loop through the flights of the schedule line
'                                   and build the projections dollars into lmprojmonths array
'                   <input> ilclf = sched line index into tgClfCt
'                           llStdStartDates() - 13 std month start dates
'                           ilFristProjInx - index of 1st month to start projecting
'                           ilHowManyPer - # entries containing a date to test in date array
'                   <output> lmProject = array of 12 months data corresponding to
'                                           12 std start months
'
'                   Returning:  lmProject - gross actual spot cost or gross acquisition costs
'                               lmAcquisition - gross acquisition costs
'                               lmAcquisitionNet - net acquisition costs if varying acq commissions; otherwise 0
'           6-8-08 subtract out acquisition $ from schedule line for net-net & triple net options
Sub mBOBBuildFlights(ilClf As Integer, llStdStartDates() As Long, ilFirstProjInx As Integer, ilHowManyPer As Integer)
    Dim ilCff As Integer
    Dim slStr As String
    Dim llFltStart As Long
    Dim llFltEnd As Long
    Dim illoop As Integer
    Dim llDate As Long
    Dim llDate2 As Long
    Dim llSpots As Long
    Dim ilTemp As Integer
    Dim llStdStart As Long
    Dim llStdEnd As Long
    Dim ilMonthInx As Integer
    Dim ilAcqCommPct As Integer
    Dim ilAcqLoInx As Integer
    Dim ilAcqHiInx As Integer
    Dim llAcqNet As Long
    Dim llAcqComm As Long
    Dim blAcqOK As Boolean

    llStdStart = llStdStartDates(ilFirstProjInx)
    llStdEnd = llStdStartDates(ilHowManyPer)
    ilCff = tgClfCT(ilClf).iFirstCff
    Do While ilCff <> -1
    tmCff = tgCffCT(ilCff).CffRec

    'first decide if its Cancel Before Start
    gUnpackDate tmCff.iStartDate(0), tmCff.iStartDate(1), slStr
    llFltStart = gDateValue(slStr)
    gUnpackDate tmCff.iEndDate(0), tmCff.iEndDate(1), slStr
    llFltEnd = gDateValue(slStr)
    If llFltEnd < llFltStart Then
        Exit Sub
    End If
    
    'backup start date to Monday
    illoop = gWeekDayLong(llFltStart)
    Do While illoop <> 0
        llFltStart = llFltStart - 1
        illoop = gWeekDayLong(llFltStart)
    Loop
    'gUnpackDate tmcff.iEndDate(0), tmcff.iEndDate(1), slStr
    'llFltEnd = gDateValue(slStr)
    'the flight dates must be within the start and end of the projection periods,
    'not be a CAncel before start flight, and have a cost > 0
    If (llFltStart < llStdEnd And llFltEnd >= llStdStart) And (llFltEnd >= llFltStart And (tmCff.lActPrice > 0 Or tmClf.lAcquisitionCost <> 0)) Then        '9-20-06
        'only retrieve for projections, anything in the past has already
        'been invoiced and has been retrieved from history or receiv files
        'adjust the gather dates from flights: use flight start date or requested start date, whichever is later
        If llStdStart > llFltStart Then
            llFltStart = llStdStart
        End If
        'use flight end date or requsted end date, whichever is lesser
        If llStdEnd < llFltEnd Then
            llFltEnd = llStdEnd
        End If

        For llDate = llFltStart To llFltEnd Step 7
            'Loop on the number of weeks in this flight
            'calc week into of this flight to accum the spot count
            If tmCff.sDyWk = "W" Then            'weekly
                llSpots = tmCff.iSpotsWk + tmCff.iXSpotsWk
            Else                                        'daily
                If illoop + 6 < llFltEnd Then           'we have a whole week
                    llSpots = tmCff.iDay(0) + tmCff.iDay(1) + tmCff.iDay(2) + tmCff.iDay(3) + tmCff.iDay(4) + tmCff.iDay(5) + tmCff.iDay(6)
                Else
                    llFltEnd = llDate + 6
                    If llDate > llFltEnd Then
                        llFltEnd = llFltEnd       'this flight isn't 7 days
                    End If
                    For llDate2 = llDate To llFltEnd Step 1
                        ilTemp = gWeekDayLong(llDate2)
                        llSpots = llSpots + tmCff.iDay(ilTemp)
                    Next llDate2
                End If
            End If
            'determine month that this week belongs in, then accumulate the gross and net $
            'currently, the projections are based on STandard bdcst
            For ilMonthInx = ilFirstProjInx To 12 Step 1         'loop thru months to find the match
                If llDate >= llStdStartDates(ilMonthInx) And llDate < llStdStartDates(ilMonthInx + 1) Then
                    
                    If tgClfCT(ilClf).ClfRec.sType = "E" Then            'pckage pricing where spot rate equals the entire price for the week
                        If (Asc(tgSaf(0).sFeatures2) And ACQUISITIONCOMMISSIONABLE) = ACQUISITIONCOMMISSIONABLE Then
                            ilAcqCommPct = 0
                            blAcqOK = gGetAcqCommInfoByVehicle(tgClfCT(ilClf).ClfRec.iVefCode, ilAcqLoInx, ilAcqHiInx)
                            ilAcqCommPct = gGetEffectiveAcqComm(llDate, ilAcqLoInx, ilAcqHiInx)
                            gCalcAcqComm ilAcqCommPct, tgClfCT(ilClf).ClfRec.lAcquisitionCost, llAcqNet, llAcqComm
                            lmAcquisitionNet(ilMonthInx) = lmAcquisitionNet(ilMonthInx) + llAcqNet          'acq net, may be needed to tnet
                            'lmAcquisition gets set with the gross acquisition amts
                        End If
                        If imUseAcquisitionCost = True Then
                            lmProject(ilMonthInx) = lmProject(ilMonthInx) + tmClf.lAcquisitionCost  'for billed and booked, process using the
                                                            'acquisition cost as a way of balancing the triple-net options
                        Else
                            lmProject(ilMonthInx) = lmProject(ilMonthInx) + tmCff.lActPrice
                        End If
                        lmAcquisition(ilMonthInx) = lmAcquisition(ilMonthInx) + (tmClf.lAcquisitionCost)
                    Else
                        If (Asc(tgSaf(0).sFeatures2) And ACQUISITIONCOMMISSIONABLE) = ACQUISITIONCOMMISSIONABLE Then
                            ilAcqCommPct = 0
                            blAcqOK = gGetAcqCommInfoByVehicle(tgClfCT(ilClf).ClfRec.iVefCode, ilAcqLoInx, ilAcqHiInx)
                            ilAcqCommPct = gGetEffectiveAcqComm(llDate, ilAcqLoInx, ilAcqHiInx)
                            gCalcAcqComm ilAcqCommPct, tgClfCT(ilClf).ClfRec.lAcquisitionCost * llSpots, llAcqNet, llAcqComm
                            lmAcquisitionNet(ilMonthInx) = lmAcquisitionNet(ilMonthInx) + llAcqNet          'acq net, may be needed to tnet
                            'lmAcquisition gets set with the gross acquisition amts
                        End If
                       
                         If imUseAcquisitionCost Then
                             lmProject(ilMonthInx) = lmProject(ilMonthInx) + (tgClfCT(ilClf).ClfRec.lAcquisitionCost * llSpots)     'gross acq cost
                         Else
                             lmProject(ilMonthInx) = lmProject(ilMonthInx) + (llSpots * tmCff.lActPrice)         'gross actual spot price
                         End If
                    
                        lmAcquisition(ilMonthInx) = lmAcquisition(ilMonthInx) + (tgClfCT(ilClf).ClfRec.lAcquisitionCost * llSpots)   'acq gross
                        Exit For
                    End If
                End If
            Next ilMonthInx
        Next llDate                                     'for llDate = llFltStart To llFltEnd
    End If                                          '
    ilCff = tgCffCT(ilCff).iNextCff                   'get next flight record from mem
    Loop                                            'while ilcff <> -1
End Sub

'**********************************************************************
'
'            Billed & Booked Report - Gather Projection data
'            mBobBuildProjCt
'
'           BILLED AND BOOKED
'           BILLED AND BOOKED RECAP
'           BILLED AND BOOKED COMPARISIONS
'           SALES COMPARISON
'           COMMISSION PROJECTIONS
'
'            Loop thru contracts within date last std bdcst billing
'            through the end of the year and build up to 12 periods
'
'                   <Input>  llStdStartDates - array of max 13 start dates, denoting
'                                              start date of each period to gather
'                            llLastBilled - Date of last invoice period
'                            ilHowManyPer - # of periods to gather
'                                           (for billed & booked its 12,
'                                           for Sales Comparisons its max 2 (past period & future period)
'                            ilDateFlag - 0 = no comparison (base dates vs comparison dates)
'                                         1 = base date
'                                         2 = comparison date
'                            tlBillCycle - record of required dates for bill method processing
'
'               3/23/98 DH changed reference of Under/Over slsp comm from long to integer
'    12/10/98:  DH (Gather all makegoods)-
'    Back up the start date for gathering of contracts by one month.  This will include
'    the case where the contract has ended, but makegood spots are in the next month.
'    If the contract spanned the first quarter requested, the makegood spot outside the
'    end date of the contract was gathered.  but if the contract was outside the requested
'    first quarter, the makegood was not gathered.
'    6/14/99 Fix projections by package lines (note:  the pkg vehicles must have their
'           sales source, owner , sort code defined)
'    4-20-98 DH New commission structure with new scf file by vehicle/slsp
'    8-4-00 Split participants when option by vehicle (by option)
'   11-13-03 test if user allowed to see vehicle
'   1-31-04 fix subscript out of range for B& B Sales Commission Projection.  It was processing as
'           tho it needed to use participant index (which only goes thru 8), and slsp index as
'           being passed (which is 10)
'   11-21-05 Add Pacing to B & B
'   4-25-06 add vehicle option to sales comparison
'   6-8-06 Adjust acquisition $ (triple-net for vehicle option & slsp/vehicle option,net-net for vehicle/participant option
'   10-2-06 option to incl/excl polit & non politic
'   5-10-07 implement new design of participants
'
'   GRF fields:
'   grfgenDate - generation date
'   grfGenTime - generation time
'   grfChfCode - contract code
'   grfDateGenl - Date billed or paid
'   grfVefCode - vehicle code (airing or billing)
'   grfAdfCode = advertiser code
'   grfSlfCode = salesperson code
'   grfSofCode = Sales Source
'   grfCode2 - Sales Comparison:  (major or primary sort selection) business category or production cod or agency code or vehicle goup
'   grfCode4 - Sales Commission
'   grfYear - split salesperson/owner flag
'   grfDateType = C = cash, T = trade
'   grfDollars(1-12) 12 months $
'   grfDollars(13) total year $ (gross or net)
'   grsDollars(14-17) Q1 - Q4 $
'   grfDollars(18) - year total $ always net
'   grfPerGenl(1) - 0 = no comparisons , 1 = base date, 2 = comparison date, 3 = last year actual for pacing sales comparison
'   grfPerGenl(2) - new/return flag
'   GrfPerGenl(3) - Minor vehicle group
'   GrfPerGenl(4) - major vehicle group
'   grfPerGenl(5) - Flag for sorting (Net/Net Billed & Booked) 1 = gross, 2 = net, 3= comm
'   grfPerGenl(7) -Participant %
'   grfPerGenl(8) - # periods
'   grfPerGenl(9)-  Is it hard cost (true/false) 3-22-05
'   grfPerGenl(10) - 4-20-05 subsort field for B & B Recap:  1 = airtime, 2 = NTR , 3 = hard cost NTR
'   grfPerGenl(10) - 11-06-06 changed to:  0 = not NTR or Hard cost, > 0 = MNF item code for NTR
'                   if NTR, flag in NTR indicates if agy sales, direct sales or NTR sales.  If
'                   agy or direct sales, embed them in those categories and not with NTR.
'   grfPerGenl(11) - B & B recap 11-06-06 0 = direct, 1 = airtime, 2 = NTR, 3 = political, 4 = Hard cost
'   grfPerGenl(12) - Sales Comparison:  (minor or sub sort selection) business category or production cod or agency code or vehicle goup
'   grfPerGenl(13) - For B & B Comparison: 0 = data from rvf/phf & contracts, 1 = budgets
'   grfPerGenl(14) - Budget mnfcode selected for BOB Comparisons
'   grfPerGenl(18) - # periods to print
'Sales Comparison selection:
'   (imPrimSort) cbcSet1 Index: 0 = Advt, 1 = Agy, 2 = Bus Cat, 3 = Prod Prot, 4 = Slsp, 5 = VEhicle, 6 = Vehicle group
'   (imSubSort) cbcSet2 Index:  0 = none, 1 = Advt, 2 = Agy, 3 = Bus Cat, 4 = Prod Prot, 5 = Slsp, 6 = VEhicle, 7 = Vehicle group
'   lbcSelection(1)= agency,  lbcSelection(2) = Slsp, lbcSelection(3) = Bus Cat, lbcSelection(12) = Vehicle group (single select), 3-18-16 chg from lbcselection(4),
'   lbcSelection(5) = Advt, lbcSelection(6) = vehicle, lbcSelection(7) = prod protection
'******************************************************************************************************
Function mBobBuildProjCt(llStdStartDates() As Long, llLastBilled As Long, ilHowManyPer As Integer, ilDateFlag As Integer, tlBillCycle As BILLCYCLE)     '1-20-21 currently tlbillcycle is unused.  in the event contracts are used to project the future, this record will be required
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  slNameCode                    ilIsItHardCost                llDate1                   *
    '*  llDate2                       tmOneVefAllYear                                         *
    '******************************************************************************************
    
    Dim ilRet As Integer
    Dim slStdStart As String            'start date to gather (std start)
    Dim slStdEnd As String              'end date to gather (end of std year)
    Dim slTempStart As String           'Start date of period requested (minus 1 month) to handle makegoods outside
                                        'end date of contrct
    Dim slTempEnd As String            'end date of period + 3 months to ensure that pacing changes have been included
    Dim slCntrStatus As String          'list of contract status to gather (working, order, hold, etc)
    Dim slCntrType As String            'list of contract types to gather (Per inq, Direct Response, Remnants, etc)
    Dim ilHOState As Integer            'which type of HO cntr states to include (whether revisions should be included)
    Dim llContrCode As Long
    Dim ilCurrentRecd As Integer
    Dim ilFound As Integer
    Dim ilFoundOption As Integer
    Dim illoop As Integer
    Dim ilHowMany As Integer            '# times to loop and process line (up to 10 times for split slsp),
                                        'up to 3 times for 3 diff. owners per vehicle, else loop once per
                                        'flight (or sch line)
    Dim ilHowManyDefined As Integer     '# of percentages (slsp for each contract, or participants for each vehicle)
    Dim ilMatchSSCode As Integer        'Sales Source code to process for participants
    Dim ilClf As Integer                'loop count for lines
    Dim slCode As String
    Dim ilTemp As Integer
    Dim ilScratch As Integer
    Dim llStdStart As Long              'requested start date to gather (serial date)
    Dim llStdEnd As Long                'requested end date to gather (serial date)
    Dim ilCorT As Integer
    Dim ilStartCorT As Integer
    Dim ilEndCorT As Integer
    Dim slCashAgyComm As String
    Dim slPctTrade As String
    Dim ilFoundOne As Integer
    Dim llProcessPct As Long                'percent of slsp split, ownership, else 100.0000%
    Dim ilFirstProjInx As Integer
    Dim slCommPct As String                 'for comm proj only - slsp comm % xx.xxxx
    Dim ilSubMissed As Integer              'subtract misses (misses, cancel, hidden)
    Dim ilCountMGs As Integer               'count mgs where they air
    Dim ilAdjust As Integer
    Dim ilUsePkg As Integer                 'true if use package, false if use hidden
    Dim ilVehLoop As Integer                'loop for MGs by vehicle
    Dim llTempProject(0 To 12) As Long      '12 months projection or MG $
    Dim llTempAcquisition(0 To 12) As Long
    Dim ilNewCode As Integer                'Revenue area "New" mnf code to show designation on report
    ReDim tlSlf(0 To 0) As SLF              '4-20-00
    Dim ilUseSlsComm As Integer             'true to use slsp share % for commission reports,
    Dim ilListIndex As Integer              '3-2-02
    Dim tlSBFType As SBFTypes
    Dim tlSplitInfo As splitinfo
    ReDim tlSbf(0 To 0) As SBF              '9-30-02
    Dim ilOKtoSeeVeh As Integer             '11-13-03 flag to detrmine if user allowed to see vehicle
                                            'else false to use revenue share to split sls $
    Dim ilAdjustDays As Integer             '11-21-05
    ReDim ilValidDays(0 To 6) As Integer
    Dim tlPriceTypes As PRICETYPES
    Dim ilAdjustMissedForMG As Integer  'flag to adjust the missed spots for makegoods.
                                        'for all B & B options except Cal (spots), the
                                        'missed part of the mg is subtracted.  When
                                        'gathering spots, ignore the missed part
    Dim ilSaveNTRFlag As Integer
    Dim ilContinue As Integer
    Dim ilSlfRecd As Integer
    Dim ilWriteForEachLine As Integer       '3-25-13 Slsp option only, write out prepass record each sched line, or on entire contract
    Dim blExpired As Boolean                '11-9-18
    Dim llClfStart As Long                  'schedule line start date
    Dim llClfEnd As Long                    'scheudle line end date
    Dim blAllZero As Boolean
    Dim slStr As String
    Dim blAtLeastOneLineToProcess As Boolean        '11-5-19
    Dim blAllOK As Boolean                          '2-8-21
    ReDim tlRvf(0 To 0) As RVF
    Dim ilWhichPeriod As Integer                '0 = corp, 1 = std, 2 = calendar contract
    Dim slRvfStart As String                    'earliest date to retrieve billed adserver trans
    Dim slRvfEnd As String                      'latest date to retrieve billed adserver trans
    Dim ilDoe As Integer
    
    ilListIndex = RptSelCt!lbcRptType.ListIndex     '3-2-02
    tlSBFType.iNTR = True           'this applies to Billed & Booked only to retrieve future $
    tlSBFType.iInstallment = False
    tlSBFType.iImport = False
    
    ilUsePkg = False
    If RptSelCt!rbcSelCSelect(0).Value Then     'use pkg, not hidden
        ilUsePkg = True
    End If
    
    'this is for the retrieval of billed rvf items if there are any adserver $ to project
    tmTranTypes.iInv = True
    tmTranTypes.iWriteOff = False
    tmTranTypes.iPymt = False
    tmTranTypes.iCash = True
    tmTranTypes.iTrade = False
    tmTranTypes.iMerch = False
    tmTranTypes.iPromo = False
    tmTranTypes.iNTR = False
    tmTranTypes.iAirTime = True
    tmTranTypes.iAdj = True
    
    '4-2-00 Prepare for the different slsp commissions by vehicle if applicable
    hmScf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmScf, "", sgDBPath & "Scf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        If tgSpf.sSubCompany = "Y" Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            ilRet = MsgBox("SCF Error # " & str$(ilRet), vbOKOnly + vbExclamation, "mBobBuildProjCt")
            ilRet = btrClose(hmScf)
            btrDestroy hmScf
            btrDestroy hmVef
            btrDestroy hmCHF
            btrDestroy hmSlf
            btrDestroy hmRvf
            btrDestroy hmGrf
            Exit Function
        End If
    End If
    imScfRecLen = Len(tmScf)
    ReDim tlScf(0 To 0) As SCF      '4-2-00
    ReDim tlSlfIndex(0 To 0) As SLFINDEX    '4-2-00
    ilRet = gObtainVef()                  '4-2-00 buildglobal vehicle table
    If ilRet = 0 Then
        btrDestroy hmScf
        btrDestroy hmVef
        btrDestroy hmCHF
        btrDestroy hmSlf
        btrDestroy hmRvf
        btrDestroy hmGrf
        btrDestroy hmVef
        Exit Function
    End If
    ilRet = gObtainSlf(RptSelCt, hmSlf, tlSlf())
    ilUseSlsComm = False            'use revenue share if by slsp (not comm share %)

    If tgSpf.sSubCompany = "Y" Then         'using commission by vehicle (sub-company)?
        '4-24-00 Build  slsp commission table
        ilRet = gObtainScf(RptSelCt, hmScf, tlScf(), llStdStartDates(1), llStdStartDates(13), tlSlfIndex())
        If igRptCallType = SLSPCOMMSJOB Then
            ilUseSlsComm = True
        End If
    End If
    imMajorSet = 0
    '8-6-10 vehicle w/split slsp subtotals swapped to do slsp w/vehicle subtotals.
    'get the vehicle groups selected, if applicable
    If (imVehicle And ilListIndex <> CNT_SALESCOMPARE) Or igSwapBOBOption Then   '4-25-05 sales compare doesnt have vehicle groups
        illoop = RptSelCt!cbcSet1.ListIndex             'retrieve the vehicle set selected (applies to vehicle option)
        imMajorSet = tgVehicleSets1(illoop).iCode
    ElseIf ilListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB Then
        imMajorSet = 0
        imMinorSet = 0
        If RptSelCt!cbcSet1.ListIndex = 6 Then
            illoop = RptSelCt!lbcSelection(12).ListIndex            '3-18-16 chged to single selection vg
            imMajorSet = tgVehicleSets1(illoop).iCode
        End If

        If RptSelCt!cbcSet2.ListIndex = 7 Then
            illoop = RptSelCt!lbcSelection(12).ListIndex            '3-18-16 chg to single selection vg
            imMinorSet = tgVehicleSets1(illoop).iCode
        End If
    ElseIf ilListIndex = CNT_BOBCOMPARE And igRptCallType = CONTRACTSJOB Then
        illoop = RptSelCt!cbcSet1.ListIndex
        imMajorSet = tgVehicleSets1(illoop).iCode
    End If
    'build array of selling office codes and their sales sources.  This is the most major sort
    'in the Business Booked reports
    ilTemp = 0
    ilRet = btrGetFirst(hmSof, tmSof, imSofRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
    Do While ilRet = BTRV_ERR_NONE
        ReDim Preserve tlSofList(0 To ilTemp) As SOFLIST
        tlSofList(ilTemp).iSofCode = tmSof.iCode
        tlSofList(ilTemp).iMnfSSCode = tmSof.iMnfSSCode
        ilRet = btrGetNext(hmSof, tmSof, imSofRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        ilTemp = ilTemp + 1
    Loop

    sgDemoMnfStamp = ""             'insure that the revenue sets are read
    ReDim tlMnf(0 To 0) As MNF
    'Get the revenue sets and find "New" code
    ilRet = gObtainMnfForType("R", sgDemoMnfStamp, tlMnf())
    ilNewCode = 0
    For illoop = LBound(tlMnf) To UBound(tlMnf) - 1 Step 1
        tmMnf = tlMnf(illoop)
        If Trim$(tmMnf.sName) = "New" Then
            ilNewCode = tmMnf.iCode
            Exit For
        End If
    Next illoop

    'ilAdjust = False
    ilSubMissed = gSetCheck(RptSelCt!ckcSelC8(0).Value) 'For standard lines- subtract unresolved missed
    ilCountMGs = gSetCheck(RptSelCt!ckcSelC8(1).Value)  'Count MGs where they air
    smAirOrder = tgSpf.sInvAirOrder                     'bill as ordred, aired
    If smAirOrder = "S" Or RptSelCt!rbcSelC9(0).Value Or RptSelCt!rbcSelC9(2).Value Then     'bill as ordered (update as order) or Corporate or Calendar, no adjustments for makegoods/missed
        ilAdjust = False                                'always ignore missed and makegoods
    Else
        ilAdjust = True                                 'missed or mg must be adjusted
    End If

    '1-20-21 currently tlbillcycle is UNUSED.  in the event contracts are used to project the future, this record will be required so that the proer dates can be tested when projecting
    If Not tlBillCycle.blBillCycle Then             '1-14-21 not getting receivables by billing method.  There is an extra set of dates that contain the cal dates if by bill cycle
                                                    'when those dates are not used, make them the same as the std set
        For illoop = 0 To 13
            tlBillCycle.lBillCycleStartDates(illoop) = llStdStartDates(illoop)
        Next illoop
        'set the remaining fields with a default
        tlBillCycle.lBillCycleLastBilled = llLastBilled
    End If
    
    slStdStart = Format$(llStdStartDates(1), "m/d/yy")       'assume first date of proj is the quarter entered
    slStdEnd = Format$(llStdStartDates(ilHowManyPer + 1), "m/d/yy")

    ReDim llCalSpots(0 To 0) As Long        'init buckets for daily calendar values
    ReDim llCalAmt(0 To 0) As Long
    ReDim llCalAcqAmt(0 To 0) As Long
    ReDim llCalAcqNetAmt(0 To 0) As Long

    ilWhichPeriod = 1                           'default to standard
    ilAdjustMissedForMG = True
    If RptSelCt!rbcSelC9(0).Value Then           'corp , look at all orders for entire year
        ilFirstProjInx = 1
        ilWhichPeriod = 0                       'corp calendar
    ElseIf RptSelCt!rbcSelC9(1).Value Then      'std, decide what month to start looking at orders for future
        '7-12-01 Billed & Booked Slsp Comm comes thru here.  Do nothing with that report for now.
        If (tgSpf.iPkageGenMeth = 1 And Not ilUsePkg) And (igRptCallType = CONTRACTSJOB) Then          'calc virtual pkg by line & use airing Lines?
            ilFirstProjInx = 1                                   'if so, force to gather all information for contract because of balancing issue with receivables
        ElseIf RptSelCt!edcText.Text <> "" Then            'pacing, get all months
            ilFirstProjInx = 1
        Else
            If (gUsingBarters()) And (RptSelCt!ckcSelC13(0).Value = vbChecked) And ((Asc(tgSaf(0).sFeatures2) And PAYMENTONCOLLECTION) = PAYMENTONCOLLECTION) Then     '7-25-16 barter and use acq cost instead of spot cost & Acq payment on Collections
                ilFirstProjInx = 1
            Else
                For illoop = 1 To ilHowManyPer Step 1
                    If llLastBilled > llStdStartDates(illoop) And llLastBilled < llStdStartDates(illoop + 1) Then
                        ilFirstProjInx = illoop + 1
                        slStdStart = Format$(llStdStartDates(ilFirstProjInx), "m/d/yy")
                        Exit For
                    End If
                Next illoop
                If ilFirstProjInx = 0 Then
                    ilFirstProjInx = 1                          'all projections, no actuals
                End If
                If llLastBilled >= llStdStartDates(ilHowManyPer + 1) Then   'all data was in the past only, dont do contracts
                    Exit Function
                End If
            End If
        End If
    Else                                            'Cal month by line (cal month by spots in gBobCalBySpots)
        ilWhichPeriod = 2                           'calendar period
        ilAdjustDays = (llStdStartDates(ilHowManyPer + 1) - llStdStartDates(1)) + 1
        ReDim llCalSpots(0 To ilAdjustDays) As Long        'init buckets for daily calendar values
        ReDim llCalAmt(0 To ilAdjustDays) As Long
        ReDim llCalAcqAmt(0 To ilAdjustDays) As Long
        ReDim llCalAcqNetAmt(0 To ilAdjustDays) As Long
        For illoop = 0 To 6                         'days of the week
            ilValidDays(illoop) = True              'force alldays as valid
        Next illoop
        'dont bother trying to calculate rates that are 0, since this report doesnt need spot counts
        tlPriceTypes.iCharge = True     'Chargeable lines
        tlPriceTypes.iZero = False      '.00 lines
        tlPriceTypes.iADU = False     'adu lines
        tlPriceTypes.iBonus = False          'bonus lines
        tlPriceTypes.iNC = False          'N/C lines
        tlPriceTypes.iRecap = False        'recapturable
        tlPriceTypes.iSpinoff = False      'spinoff

        ilFirstProjInx = 1
    End If
    
    'set flag if slsp option whether to write prepass record for each sch line or by the contract
    'Different options within the slsp option require the prepass records to be written for each sch line processed
    'For example:  if by slsp with splits need to be written each line, but if no splits, write out for the contract only
    ilWriteForEachLine = False
    If imAdjustAcquisition Or imUseAcquisitionCost Then                 'triple net, or use just the acquisition cost
        gBuildACQPctByPeriod llStdStartDates(1), igMonthOrQtr, tmAcqPctByPeriod()
        ilWriteForEachLine = True
    End If

    '3-2-02 if Billed and Booked use the entered #periods, otherwise force to 12 for all other options
    'igPeriods = Val(RptSelCt!edcSelCTo1.Text)
    If (ilListIndex = CNT_BOB Or ilListIndex = CNT_BOBRECAP Or ilListIndex = CNT_BOBCOMPARE) And (igRptCallType = CONTRACTSJOB) Then
        '3-2-02 if Billed and Booked use the entered #periods, otherwise force to 12 for all other options
        If ilListIndex = CNT_BOB Or ilListIndex = CNT_BOBRECAP Then
            igPeriods = Val(RptSelCt!edcSelCTo1.Text)
        Else
            igPeriods = Val(RptSelCt!edcSelCTo.Text)
        End If

        If igPeriods < 1 Or igPeriods > 12 Then
            igPeriods = 12              'if errors in input, get normal report of 12 months
        End If
        tmGrf.iPerGenl(7) = igPeriods                   '3-4-02 show # periods requestd on report
        
        If Not imNTR And Not imHardCost Then           '3-22-05 is ntr or hard cost selected?
            tlSBFType.iNTR = False           'no, ignore NTR projected $
        End If
    Else
        igPeriods = 12
    End If
    
    llStdStart = llStdStartDates(ilFirstProjInx)  'first date to project
    llStdEnd = llStdStartDates(ilHowManyPer + 1)                'end date to project
Debug.Print "mBobBuildProjCT - " & Format(llStdStart, "ddddd") & " to " & Format(llStdEnd, "ddddd")
    'build array of misses reasons and their billing rules so it doesn't have to be read with each missed spot
    ilTemp = 0
    ilRet = btrGetFirst(hmMnf, tmMnf, imMnfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
    Do While ilRet = BTRV_ERR_NONE
        If tmMnf.sType = "M" Then
            ReDim Preserve tmMnfList(0 To ilTemp) As MNFLIST
            tmMnfList(ilTemp).iMnfCode = tmMnf.iCode
            tmMnfList(ilTemp).iBillMissMG = tmMnf.iGroupNo
            ilTemp = ilTemp + 1
        End If
        ilRet = btrGetNext(hmMnf, tmMnf, imMnfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    slCntrStatus = ""                 'statuses: hold, order, unsch hold, uns order
    If imHold Then                  'exclude holds and uns holds
        slCntrStatus = "HG"             'include orders and uns orders
    End If
    If imOrder Then                  'exclude holds and uns holds
        slCntrStatus = slCntrStatus & "ON"             'include orders and uns orders
    End If
    slCntrType = ""
    If RptSelCt!ckcSelC5(0).Value = vbChecked Then
        slCntrType = "C"
    End If
    If RptSelCt!ckcSelC5(1).Value = vbChecked Then
        slCntrType = slCntrType & "V"
    End If
    If RptSelCt!ckcSelC5(2).Value = vbChecked Then
        slCntrType = slCntrType & "T"
    End If
    If RptSelCt!ckcSelC5(3).Value = vbChecked Then
        slCntrType = slCntrType & "R"
    End If
    If RptSelCt!ckcSelC5(4).Value = vbChecked Then
        slCntrType = slCntrType & "Q"
    End If
    If RptSelCt!ckcSelC5(5).Value = vbChecked Then
        slCntrType = slCntrType & "S"
    End If
    If RptSelCt!ckcSelC5(6).Value = vbChecked Then
        slCntrType = slCntrType & "M"
    End If
    If slCntrType = "CVTRQSM" Then          'all types: PI, DR, etc.  except PSA(p) and Promo(m)
        slCntrType = ""                     'blank out string for "All"
    End If
    ilHOState = 2                       'get latest orders & revisions  (HOGN plus any revised orders WCI)
    'build table (into tlchfadvtext) of all contracts that fall within the dates required
    'Back up the start date for gathering of contracts by one month.  This will include
    'the case where the contract has ended, but makegood spots are in the next month.
    'If the contract spanned the first quarter requested, the makegood spot outside the
    'end date of the contract was gathered.  but if the contract was outside the requested
    'first quarter, the makegood was not gathered.

    ilAdjustDays = 30       'adjustment for the days back to retrieve contracts
    '11-21-05 get effective pacing date by option
    lmPacingDate = 0
    'only bill & booked and b & b Recap can be pacing reports
    '2-19-16 implement pacing for Sales Comparison
    If ((ilListIndex = CNT_BOB Or ilListIndex = CNT_BOBRECAP Or ilListIndex = CNT_SALESCOMPARE) And (igRptCallType = CONTRACTSJOB)) Then
        If RptSelCt!edcText.Text <> "" Then
            slCode = RptSelCt!edcText.Text
            lmPacingDate = gDateValue(slCode)
            ilAdjustDays = 90
        End If
    End If

    ReDim tmCntAllYear(0 To 0) As ALLPIFPCTYEAR

    slTempStart = Format$((gDateValue(slStdStart) - ilAdjustDays), "m/d/yy")
    slTempEnd = Format$((gDateValue(slStdEnd) + 90), "m/d/yy")
    ilRet = gObtainCntrForDate(RptSelCt, slTempStart, slTempEnd, slCntrStatus, slCntrType, ilHOState, tlChfAdvtExt())
    For illoop = 1 To 13 Step 1
        lmProject(illoop) = 0
        lmAcquisition(illoop) = 0
        lmAcquisitionNet(illoop) = 0
    Next illoop

    'Create array of agy, advt, vehicle (etc) codes to include or exclude to
    'avoid parsing the list boxes for each contract/line
    If ilListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB Then
         'build array of vehicles to include or exclude
        gObtainCodesForMultipleLists 6, tgCSVNameCode(), imInclVefCodes, imUsevefcodes(), RptSelCt
        gAddDormantVefToExclList imInclVefCodes, tgMVef(), imUsevefcodes()          '8-4-17 if excluding vehicles, make sure dormant ones exluded since
                                                                                'they wont be in original list
        'get the Advt codes selected
        gObtainCodesForMultipleLists 5, tgAdvertiser(), imInclAdfCodes, imUseAdfCodes(), RptSelCt
        'get the Advt codes selected
        gObtainCodesForMultipleLists 1, tgAgency(), imInclAgfCodes, imUseAgfCodes(), RptSelCt
        'get the bus cat codes selected
        gObtainCodesForMultipleLists 3, tgMNFCodeRpt(), imInclCatCodes, imUseCatCodes(), RptSelCt
        'get the prod prot codes selected
        gObtainCodesForMultipleLists 7, tgMnfCodeCT(), imInclProdCodes, imUseProdCodes(), RptSelCt
    Else
        If imAdvt Then
            'gObtainCodesForMultipleLists 5, tgAdvertiser(), imIncludeCodes, imUseCodes(), RptSelCt
            gObtainCodesForMultipleLists 5, tgAdvertiser(), imInclAdfCodes, imUseAdfCodes(), RptSelCt
        ElseIf imAgency Then
            'gObtainCodesForMultipleLists 1, tgAgency(), imIncludeCodes, imUseCodes(), RptSelCt
            gObtainCodesForMultipleLists 1, tgAgency(), imInclAgfCodes, imUseAgfCodes(), RptSelCt
        'ElseIf imBusCat Or imProdProt Then
            'gObtainCodesForMultipleLists 2, tgSalesperson(), imIncludeCodes, imUseCodes(), RptSelCt
        ElseIf imBusCat Then
            gObtainCodesForMultipleLists 3, tgMNFCodeRpt(), imInclCatCodes, imUseCatCodes(), RptSelCt
        ElseIf imProdProt Then
            gObtainCodesForMultipleLists 7, tgMnfCodeCT(), imInclProdCodes, imUseProdCodes(), RptSelCt
        ElseIf imVehicle Then
            gObtainCodesForMultipleLists 6, tgCSVNameCode(), imInclVefCodes, imUsevefcodes(), RptSelCt
        ElseIf imSlsp Then          'might need vehicle subtotals within slsp
            'build array of vehicles to include or exclude
            gObtainCodesForMultipleLists 6, tgCSVNameCode(), imInclVefCodes, imUsevefcodes(), RptSelCt
        End If
    End If

    '1-21-08 need to always get the vehicles for selectivity
    If (ilListIndex = CNT_BOBCOMPARE) And igRptCallType = CONTRACTSJOB Then
        'get the vehicle codes selected
        gObtainCodesForMultipleLists 6, tgCSVNameCode(), imInclVefCodes, imUsevefcodes(), RptSelCt
    End If

    If imSlsp Then
        If igRptCallType = CONTRACTSJOB Then
            If ilListIndex = CNT_BOB Then                   'regular B & B has option to use splits or prinary slsp only
                'options by Salesperson with splits or Vehicle option with slsp subtotals
                If RptSelCt!ckcSelC10(0).Value = vbChecked Or igSwapBOBOption = True Then
                    ilWriteForEachLine = True
                End If
            ElseIf ilListIndex = CNT_SALESCOMPARE Then          'sales comparison and B & B Comparison always use splits for slsp option
                ilWriteForEachLine = True
            ElseIf ilListIndex = CNT_BOBCOMPARE Then
                ilWriteForEachLine = True
            End If
        ElseIf igRptCallType = SLSPCOMMSJOB Then        'need to breakout slsp within vehicle for commission projection (COMM_PROJECTION)
            ilWriteForEachLine = True
        End If
    End If
    
    For ilCurrentRecd = LBound(tlChfAdvtExt) To UBound(tlChfAdvtExt) - 1 Step 1                                          'loop while llCurrentRecd < llRecsRemaining
        ilDoe = ilDoe + 1
        If ilDoe > 60 Then
            ilDoe = 0
            DoEvents
        End If
        'check for valid slsp selection
        ilFound = True          'assume found something to report until selectivity checking

        If imAdvt Or imSubSort = 1 Then          'advertiser selectivity
            'If (Not RptSelCt!ckcAll.Value = vbChecked) Then
                ilFound = False                             'assume nothing found until match in advt selection table
                If gFilterLists(tlChfAdvtExt(ilCurrentRecd).iAdfCode, imInclAdfCodes, imUseAdfCodes()) Then
                    ilFound = True
                End If
            'End If
        'cant test for exclusion of business category or product protection yet since contract not read in
        End If

        If ilFound Then         'pass advt filter?
            If imAgency Or imSubSort = 2 Then
                'If Not RptSelCt!ckcAll.Value = vbChecked Then
                   ilFound = False
                    If gFilterLists(tlChfAdvtExt(ilCurrentRecd).iAgfCode, imInclAgfCodes, imUseAgfCodes()) Then
                        ilFound = True
                    End If
                'End If
            End If
        End If


        'if single contract entered, must match
        If lmSingleCntr > 0 And lmSingleCntr <> tlChfAdvtExt(ilCurrentRecd).lCntrNo Then
            ilFound = False
        End If

        '5-26-06 Check for political only option on Sales Comparison
        If (ilFound) And ((ilListIndex = CNT_SALESCOMPARE Or ilListIndex = CNT_BOB Or ilListIndex = CNT_BOBRECAP Or ilListIndex = CNT_BOBCOMPARE) And (igRptCallType = CONTRACTSJOB)) Then
            'if the record is valid for inclusion, see if Sales Comparison asks for Political only
            If mCheckAdvPolitical(tlChfAdvtExt(ilCurrentRecd).iAdfCode) Then          'its a political, include this contract?
                 If Not imInclPolit Then
                    ilFound = False
                End If
            Else                                                'not a political advt, include this contract?
                 If Not imInclNonPolit Then
                    ilFound = False
                End If
            End If
        End If

        If (ilFound) Then
            If lmPacingDate > 0 Then        'get the proper contract revision for this pacing date
                llContrCode = gPaceCntr(tlChfAdvtExt(ilCurrentRecd).lCntrNo, lmPacingDate, hmCHF, tmChf)
            Else
                llContrCode = tlChfAdvtExt(ilCurrentRecd).lCode
            End If

            If llContrCode = 0 Then             'no contract found
                ilFoundOption = False
            Else
                ilRet = gObtainCntr(hmCHF, hmClf, hmCff, llContrCode, False, tgChfCT, tgClfCT(), tgCffCT(), False)  '8-28-12 do not sort by special dp order

                ilFoundOption = True
                '8-7-9 check for a minor sort by competitive or business category
                If (Not RptSelCt!ckcAll.Value = vbChecked) Or (imSubSort = 3 Or imSubSort = 4) Then 'passed all filters so far and selecting all entries?
                    If imBusCat Or imSubSort = 3 Then       'imSubsort used for SalesComparison minor sort and subtotals
                        ilFoundOption = False
                        'If gFilterLists(tgChfCT.iMnfBus, imIncludeCodes, imUseCodes()) Then
                        If gFilterLists(tgChfCT.iMnfBus, imInclCatCodes, imUseCatCodes()) Then

                            ilFoundOption = True
                        End If
                    ElseIf imProdProt Or imSubSort = 4 Then      'imSubsort used for SalesComparison minor sort and subtotals
                        ilFoundOption = False
                        'If gFilterLists(tgChfCT.iMnfComp(0), imIncludeCodes, imUseCodes()) Then
                        If gFilterLists(tgChfCT.iMnfComp(0), imInclProdCodes, imUseProdCodes()) Then
                            ilFoundOption = True
                        End If
                    End If
                End If
            End If
            If ((tgChfCT.iPctTrade < 100) Or (tgChfCT.iPctTrade = 100 And imTrade)) And (ilFoundOption) Then        'all trade contr, include?
                'obtain agency for commission
                If (tgChfCT.iAgfCode > 0) And (Not imUseAcquisitionCost) Then  'if direct advert or showing acquisition costs, dont take any agency comm out
                    tmAgfSrchKey.iCode = tgChfCT.iAgfCode
                    ilRet = btrGetEqual(hmAgf, tmAgf, imAgfRecLen, tmAgfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'get matching agy recd
                    If ilRet = BTRV_ERR_NONE Then
                        slCashAgyComm = gIntToStrDec(tmAgf.iComm, 2)
                    End If          'ilret = btrv_err_none
                Else
                    slCashAgyComm = ".00"
                End If              'iagfcode > 0

                slPctTrade = gIntToStrDec(tgChfCT.iPctTrade, 0)
                If tgChfCT.iPctTrade = 0 Then                     'setup loop to do cash & trade
                    ilStartCorT = 1
                    ilEndCorT = 1
                ElseIf tgChfCT.iPctTrade = 100 Then
                    ilStartCorT = 2
                    ilEndCorT = 2
                Else
                    ilStartCorT = 1
                    If imTrade Then             'Include trades?
                        ilEndCorT = 2
                    Else
                        ilEndCorT = 1
                    End If
                End If
 
                '9-30-02 this code was moved from inside line processing to outside of line processing
                 'obtain the sales source for major sort of business booked reports
                If tgChfCT.iSlfCode(0) <> tmSlf.iCode Then        'only read slsp recd if not in mem already
                    '7-2-14 use binarysearch for speed
                    ilRet = gBinarySearchSlf(tgChfCT.iSlfCode(0))
                    If ilRet = -1 Then              'not found
                        tmSlf.iUnderComm = 0
                        tmSlf.iRemUnderComm = 0
                        tmSlf.iSofCode = 0
                    Else
                        tmSlf = tgMSlf(ilRet)
                    End If
                    slCommPct = gIntToStrDec(tmSlf.iUnderComm, 2)
                    If tgChfCT.sType = "T" Then                   'if remnant, differ commission
                        slCommPct = gIntToStrDec(tmSlf.iRemUnderComm, 2)
                    End If
                End If                                          'table of selling offices built into memory with its
                                                            'associated sales source
                For illoop = LBound(tlSofList) To UBound(tlSofList)
                    If tlSofList(illoop).iSofCode = tmSlf.iSofCode Then
                        ilMatchSSCode = tlSofList(illoop).iMnfSSCode          'Sales source
                        Exit For
                    End If
                Next illoop

                ReDim tmAdjust(0 To 0) As ADJUSTLIST             'prepare list of mgs
                imUpperAdjust = 0

                'only go thru SBF if NTR should be included and the contract header has it flagged as an NTR order
                '1-27-07 implement NTR/hard cost into Sales Comparison

                If (((ilListIndex = CNT_BOB Or ilListIndex = CNT_BOBRECAP Or ilListIndex = CNT_SALESCOMPARE Or ilListIndex = CNT_BOBCOMPARE) And (igRptCallType = CONTRACTSJOB)) Or (ilListIndex = COMM_PROJECTION And igRptCallType = SLSPCOMMSJOB)) Then      'Billed & booked needs to get the SBF (NTR Item billing) for the future if Item billing defined
                    ilContinue = False
                    ilSaveNTRFlag = tlSBFType.iNTR
                    ReDim tmSBFAdjust(0 To 0) As ADJUSTLIST             'build new for every contract

                    If (tgChfCT.sInstallDefined = "Y" And (Asc(tgSpf.sUsingFeatures6) And INSTALLMENTREVENUEEARNED) <> INSTALLMENTREVENUEEARNED) Then     'its an install contract, if install method is bill as aired, get the NTRs from SBF                                                                 'if install bill method is Invoiced, get the installment records from SBF
                        'install method is invoiced, get the future from Installment records
                        tlSBFType.iNTR = False
                        tlSBFType.iInstallment = True
                        ilContinue = True
                        ilRet = gObtainSBF(RptSelCt, hmSbf, tgChfCT.lCode, slStdStart, slStdEnd, tlSBFType, tlSbf(), 0) '11-28-06 add last parm to indicate which key to use
                        'Build array of the vehicles and their NTR $ into tmSBFAdjust array
                        mBobSbfAdjustForInstall tlSbf(), llStdStartDates(), ilFirstProjInx, llStdStart, llStdEnd, ilHowManyPer, ilListIndex, tlMnf()
                    Else
                        If ((tgChfCT.sNTRDefined = "Y") And (imNTR = True Or imHardCost = True)) Then
                            ilRet = gObtainSBF(RptSelCt, hmSbf, tgChfCT.lCode, slStdStart, slStdEnd, tlSBFType, tlSbf(), 0) '11-28-06 add last parm to indicate which key to use
                            'Build array of the vehicles and their NTR $ into tmSBFAdjust array
                            mBobSbfAdjustForNTR tlSbf(), llStdStartDates(), ilFirstProjInx, llStdStart, llStdEnd, ilHowManyPer, ilListIndex, tlMnf()
                            ilContinue = True
                        End If
                    End If
                    If ilContinue Then
                        'ReDim tmSBFAdjust(0 To 0) As ADJUSTLIST             'build new for every contract
                        'ilRet = gObtainSBF(RptSelCt, hmSbf, tgChfCT.lCode, slStdStart, slStdEnd, tlSBFType, tlSbf(), 0) '11-28-06 add last parm to indicate which key to use
                        'Build array of the vehicles and their NTR $ into tmSBFAdjust array
                        'mBobSbfAdjustForNTR tlSbf(), llStdStartDates(), ilFirstProjInx, llStdStart, llStdEnd, ilHowManyPer, ilListIndex, tlMnf()
                        'loop on sbf to process each $
                        For ilVehLoop = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1      '11-06-06 chg to ubound -1
                            ilFoundOption = True                    'assume everything included
                            'If imVehicle And Not RptSelCt!ckcAll.Value = vbChecked Then   'vehicle option and selected vehicles
                            'all options in B & B compare has vehicle selectivity
                            If imVehicle Or imSubSort = 6 Or ilListIndex = CNT_BOBCOMPARE Then          'vehicle sort or subsort is vehicle
                                ilFoundOption = False
                                If gFilterLists(tmSBFAdjust(ilVehLoop).iVefCode, imInclVefCodes, imUsevefcodes()) Then
                                    ilFoundOption = True
                                End If
                            End If
                            '12-6-07 changed to use gCntrOKForUser instead of testing vehicle
                            ilOKtoSeeVeh = True             '12-05-06 force to be ok since it already passed contract test
                            
                            If ilOKtoSeeVeh Then
                                mBobSelectVeh tmSBFAdjust(ilVehLoop).iVefCode, ilFoundOption, ilListIndex 'if slsp (with veh subtotals) or vehicle option, see if this vehicle is selected

                                If ilFoundOption Then
                                    tlSplitInfo.iMatchSSCode = ilMatchSSCode
                                    tlSplitInfo.iStartCorT = ilStartCorT
                                    tlSplitInfo.iEndCorT = ilEndCorT
                                    tlSplitInfo.iFirstProjInx = ilFirstProjInx
                                    tlSplitInfo.iUseSlsComm = ilUseSlsComm
                                    tlSplitInfo.iVefCode = tmSBFAdjust(ilVehLoop).iVefCode
                                    tlSplitInfo.iDateFlag = ilDateFlag
                                    tlSplitInfo.iNewCode = ilNewCode
                                    tlSplitInfo.sPctTrade = slPctTrade
                                    If ((tgChfCT.sInstallDefined = "Y" And (Asc(tgSpf.sUsingFeatures6) And INSTALLMENTREVENUEEARNED) = INSTALLMENTREVENUEEARNED)) Or tgChfCT.sInstallDefined <> "Y" Then     'its an install contract, if install method is bill as aired (separate inv from revenue), get the NTRs from SBF                                                                 'if install bill method is Invoiced, get the installment records from SBF
                                        'this is revenue for NTR / Hard Cost in the future
                                        tlSplitInfo.sTradeAgyComm = tmSBFAdjust(ilVehLoop).sAgyComm
                                        If tmSBFAdjust(ilVehLoop).sAgyComm = "Y" Then
                                            tlSplitInfo.sCashAgyComm = slCashAgyComm
                                        Else
                                            tlSplitInfo.sCashAgyComm = "00.00"
                                        End If
                                        tlSplitInfo.iNTRSlspComm = tmSBFAdjust(ilVehLoop).iSlsCommPct      '2-2-04 NTR slsp comm if not using sub-companies.
                                        tlSplitInfo.sNTR = "Y"
                                        tlSplitInfo.iHardCost = tmSBFAdjust(ilVehLoop).iIsItHardCost      'true false if hard cost
                                        tlSplitInfo.iMnfNTRItemCode = tmSBFAdjust(ilVehLoop).iMnfItem       '11-06-06 NTR Item type from MNF
                                    Else           'otherwise its billed as invoiced and need to get future from NTR and lines
                                        'this is SBF records for Installment in the future
                                        'tlSplitInfo.sCashAgyComm = slCashAgyComm
                                        If tmSBFAdjust(ilVehLoop).sAgyComm = "Y" Then
                                            tlSplitInfo.sCashAgyComm = slCashAgyComm
                                        Else
                                            tlSplitInfo.sCashAgyComm = "00.00"
                                        End If
                                        tlSplitInfo.sTradeAgyComm = tgChfCT.sAgyCTrade        '12-23-02
                                        tlSplitInfo.iNTRSlspComm = 0            '2-2-04
                                        tlSplitInfo.sNTR = "N"
                                        tlSplitInfo.iHardCost = False
                                        tlSplitInfo.iMnfNTRItemCode = 0         '11-06-06 not an NTR
                                    End If

                                    For illoop = 1 To 12
                                        lmProject(illoop) = tmSBFAdjust(ilVehLoop).lProject(illoop)
                                        lmAcquisition(illoop) = tmSBFAdjust(ilVehLoop).lAcquisitionCost(illoop)
                            
                                    Next illoop
                                    '2-3-03 fake out the schedule line since there isnt a schedule line that contains vefcode
                                    tmClf.iVefCode = tlSplitInfo.iVefCode   'other subrtn use the vehicle code from line (SBF doesnt have sch lines)
                                    tmClf.sType = "S"       'standard line
                                    mBobSetupPctOfSplit tlSplitInfo, llStdStartDates(), tlSlf(), tlScf(), tlSlfIndex(), tmCntAllYear(), tmOneVehAllYear()
                                End If
                            End If
                        Next ilVehLoop
                    End If
                    tlSBFType.iNTR = ilSaveNTRFlag
                    tlSBFType.iInstallment = False  'installment flag to retrieve SBF records are only set when getting installment records for the future based on install method "Invoiced"
                End If
                'Insure the common monthly buckets are initialized for the adserver data
                
                For illoop = 1 To 12
                    lmProject(illoop) = 0
                    lmAcquisition(illoop) = 0
                    lmAcquisitionNet(illoop) = 0
                Next illoop
                
                '1-21-21 For CPM podcast, take the overall $ ordered (pcf), subtract the billed(rvf/phf), and average the remaining across the overall months ordered  (total ordered - total billed)
                'TTP 10955 - Billed and Booked Cal Spots: slowness reported, possibly due to including digital lines
                'If (tgChfCT.sAdServerDefined = "Y") And (ilListIndex = CNT_BOB) Then
                If (tgChfCT.sAdServerDefined = "Y") And (ilListIndex = CNT_BOB) And RptSelCt.ckcSelC3(10).Value = vbChecked Then
                    gUnpackDate tgChfCT.iStartDate(0), tgChfCT.iStartDate(1), slRvfStart
                    slRvfEnd = Format(llStdStartDates(ilFirstProjInx) - 1, "ddddd")
                    If tlBillCycle.blBillCycle Then
                        If tgChfCT.sBillCycle = "S" Then
                           slRvfEnd = Format(llLastBilled, "ddddd")
                        Else
                            slRvfEnd = Format(tlBillCycle.lBillCycleLastBilled, "ddddd")
                        End If
                    End If

                    ReDim tmSBFAdjust(0 To 0) As ADJUSTLIST             'build new for every contract
                    blAllOK = gObtainPcf(hmPcf, tgChfCT.lCode, tmPcf())       'obtain all pcm for matching contract code
                    If blAllOK Then
                        'gather all the receivables that exist for this contract
                        'If Abs(ilWhichPeriod) = 1 Or ilWhichPeriod = -2 Then 'TTP 10746 - Billed and Booked standard month pacing version: digital lines getting calculated incorrectly (Dont use Receivables, Pacing uses Contract)
                        If (Abs(ilWhichPeriod) = 1 Or ilWhichPeriod = -2) And lmPacingDate = 0 Then      'std and cal bill cycle method needs receivables
                            ilRet = gObtainPhfRvfbyCntr(RptSelCt, tgChfCT.lCntrNo, slRvfStart, slRvfEnd, tmTranTypes, tlRvf())
                        Else
                            ReDim tlRvf(0 To 0) As RVF
                            ilRet = True
                        End If
                        If ilRet = True Then          'got data , OK
                            If lmPacingDate <> 0 Then
                                'TTP 10746 - Billed and Booked standard month pacing version: digital lines getting calculated incorrectly
                                'Use the 1st StdStartDate-1 as Last billed date so that Contract data is used for the entire contract span
                                mBobAdjustForAdServer tmPcf(), tlRvf(), llStdStartDates(), llStdStartDates(1) - 1, ilHowManyPer, ilWhichPeriod, tgChfCT.lCntrNo
                            Else
                                mBobAdjustForAdServer tmPcf(), tlRvf(), llStdStartDates(), llLastBilled, ilHowManyPer, ilWhichPeriod, tgChfCT.lCntrNo
                            End If
                            'loop on sbf to process each $
                            For ilVehLoop = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1      '11-06-06 chg to ubound -1
                                ilFoundOption = True                    'assume everything included
                                If imVehicle And Not RptSelCt!ckcAll.Value = vbChecked Then   'vehicle option and selected vehicles
                                    ilFoundOption = False
                                    'If gFilterLists(tmSBFAdjust(ilVehLoop).iVefCode, imIncludeCodes, imUseCodes()) Then
                                    If gFilterLists(tmSBFAdjust(ilVehLoop).iVefCode, imInclVefCodes, imUsevefcodes()) Then
                                        ilFoundOption = True
                                    End If
                                End If
        
                                mBobSelectVeh tmSBFAdjust(ilVehLoop).iVefCode, ilFoundOption, ilListIndex 'if slsp (with veh subtotals) or vehicle option, see if this vehicle is selected
    
                                If ilFoundOption Then
                                    tlSplitInfo.iMatchSSCode = ilMatchSSCode
                                    tlSplitInfo.iStartCorT = ilStartCorT
                                    tlSplitInfo.iEndCorT = ilEndCorT
                                    tlSplitInfo.iFirstProjInx = ilFirstProjInx
                                    tlSplitInfo.iUseSlsComm = ilUseSlsComm
                                    tlSplitInfo.iVefCode = tmSBFAdjust(ilVehLoop).iVefCode
                                    tlSplitInfo.iDateFlag = ilDateFlag
                                    tlSplitInfo.iNewCode = ilNewCode
                                    tlSplitInfo.sPctTrade = slPctTrade
                                    tlSplitInfo.sCashAgyComm = slCashAgyComm
                                    tlSplitInfo.sTradeAgyComm = tgChfCT.sAgyCTrade
                                    tlSplitInfo.iNTRSlspComm = 0
                                    tlSplitInfo.sNTR = "N"
                                    tlSplitInfo.iHardCost = False
                                    tlSplitInfo.iMnfNTRItemCode = 0         '11-06-06 not an NTR
                                    
                                    For illoop = 1 To 12
                                        lmProject(illoop) = tmSBFAdjust(ilVehLoop).lProject(illoop)
                                        lmAcquisition(illoop) = tmSBFAdjust(ilVehLoop).lAcquisitionCost(illoop)
                                    Next illoop
                                    '2-3-03 fake out the schedule line since there isnt a schedule line that contains vefcode
                                    tmClf.iVefCode = tlSplitInfo.iVefCode   'other subrtn (mFoundSelection) use the vehicle code from line (PCF doesnt have sch lines)
                                    tmClf.sType = "S"       'standard line
                                    '1-20-21 if using bill cycle option, need to use the correct set of dates to project
                                    mBobSetupPctOfSplit tlSplitInfo, llStdStartDates(), tlSlf(), tlScf(), tlSlfIndex(), tmCntAllYear(), tmOneVehAllYear()
                                End If
                            Next ilVehLoop
                        End If
                    End If
                End If
                
                'Insure the common monthly buckets are initialized for the schedule lines
                For illoop = 1 To 12
                    lmProject(illoop) = 0
                    lmAcquisition(illoop) = 0
                    lmAcquisitionNet(illoop) = 0
                Next illoop
                '2-27-08 process the schedule lines if air time included and its not a installment contract, or
                'air time included and its an installment method is Aired (separate invoicing from revenue); get the
                'future from schedule lines.  If installment whose method is invoiced (inv = revenue),
                If (imAirTime And tgChfCT.sInstallDefined <> "Y") Or (imAirTime And tgChfCT.sInstallDefined = "Y" And (Asc(tgSpf.sUsingFeatures6) And INSTALLMENTREVENUEEARNED) = INSTALLMENTREVENUEEARNED) Then                    '11-25-02 include air time (vs NTR)?
                    'build the vehicles participant tables for this contract only into tmCntAllYear, if by owner
                    'If imOwner Or (imVehicle And imTrikIfOwner) Then
                        gInitCntPartYear hmVsf, tgChfCT, ilMatchSSCode, llStdStartDates(), tmCntAllYear(), tmPifKey(), tmPifPct()
                    'End If

                    blAtLeastOneLineToProcess = False           '11-5-19 Is there at least 1 line that falls within the period that should be output
                    For ilClf = LBound(tgClfCT) To UBound(tgClfCT) - 1 Step 1
                        tmClf = tgClfCT(ilClf).ClfRec
                        ilFoundOption = True            'assume the vehicle should be included
                        mBobSelectVeh tmClf.iVefCode, ilFoundOption, ilListIndex 'if slsp (with veh subtotals) or vehicle option, see if this vehicle is selected
                        tmGrf.iVefCode = tmClf.iVefCode
                        '12-06-07 changed to use gCNTROkforUser when obtaining contracts instead of testing vehicle
                        'ilOKtoSeeVeh = gUserAllowedVehicle(tmClf.iVefCode)  'determine if user is allowed to see this vehicle

                        If (ilFoundOption) Then     'And (ilOKtoSeeVeh) Then
                            If ilUsePkg Then        'use pkg lines
                                If tmClf.sType <> "H" Then  'dont use hidden line
                                    If RptSelCt!rbcSelC9(2).Value = False Then        'not cal, its std or corp
                                        mBOBBuildFlights ilClf, llStdStartDates(), ilFirstProjInx, ilHowManyPer + 1
                                        gSetAcqFieldsForOutput imAdjustAcquisition, imUseAcquisitionCost, smGrossOrNet, lmProject(), lmAcquisition(), lmAcquisitionNet()
                                   Else                                'cal or corp
                                        gCalendarFlightsWithNetAcq tgClfCT(ilClf), tgCffCT(), llStdStart, llStdEnd, ilValidDays(), True, llCalAmt(), llCalSpots(), llCalAcqAmt(), llCalAcqNetAmt(), imUseAcquisitionCost, tlPriceTypes
                                        'TTP 10665 - RAB Cal Contract: digital/ad server contract not appearing when lines are for Jan and the start month is Jan
                                        gAccumCalFromDaysWithAcqNet llStdStartDates(), llCalAmt(), llCalAcqAmt(), llCalAcqNetAmt(), imAdjustAcquisition, imUseAcquisitionCost, smGrossOrNet, lmProject(), lmAcquisition(), ilHowManyPer + 1, ilFirstProjInx
                                    End If
                                End If
                            Else                    'use hidden lines
                                If tmClf.sType <> "A" And tmClf.sType <> "O" And tmClf.sType <> "E" Then
                                    If RptSelCt!rbcSelC9(2).Value = False Then       'not calendar, its std or corp
                                        mBOBBuildFlights ilClf, llStdStartDates(), ilFirstProjInx, ilHowManyPer + 1
                                        gSetAcqFieldsForOutput imAdjustAcquisition, imUseAcquisitionCost, smGrossOrNet, lmProject(), lmAcquisition(), lmAcquisitionNet()
                                    Else
                                        gCalendarFlightsWithNetAcq tgClfCT(ilClf), tgCffCT(), llStdStart, llStdEnd, ilValidDays(), True, llCalAmt(), llCalSpots(), llCalAcqAmt(), llCalAcqNetAmt(), imUseAcquisitionCost, tlPriceTypes
                                        'TTP 10665 - RAB Cal Contract: digital/ad server contract not appearing when lines are for Jan and the start month is Jan
                                        gAccumCalFromDaysWithAcqNet llStdStartDates(), llCalAmt(), llCalAcqAmt(), llCalAcqNetAmt(), imAdjustAcquisition, imUseAcquisitionCost, smGrossOrNet, lmProject(), lmAcquisition(), ilHowManyPer + 1, ilFirstProjInx
                                    End If
                                End If
                            End If
                           
                            'Adjust with misses and makegoods?
                            If ilAdjust And lmPacingDate = 0 Then   '12-11-14 adjust misses/mg only if not pacing.  If pacing, all data from contract
                                mBOBAdjust llStdStartDates(), ilFirstProjInx, llStdStart, llStdEnd, True, ilSubMissed, ilCountMGs, ilHowManyPer, ilAdjustMissedForMG
                            End If
                        End If
                                                
                        '11-9-18 Test to see if schedule line is all $0.  Feature to include $0 contracts, but only schedule line dates within the requested period
                        blAllZero = True
                        blExpired = False
                        For illoop = LBound(lmProject) To UBound(lmProject) - 1
                            If lmProject(illoop) <> 0 Then
                                blAllZero = False
                                blAtLeastOneLineToProcess = True            '11-5-19
                                Exit For
                            End If
                        Next illoop
                        
                        If (blAllZero) And (imInclZero) Then            'if this sch line projected all zero, does it fall within the requested parametrs
                            'first decide if its Cancel Before Start
                            gUnpackDate tmClf.iStartDate(0), tmClf.iStartDate(1), slStr
                            llClfStart = gDateValue(slStr)
                            gUnpackDate tmClf.iEndDate(0), tmClf.iEndDate(1), slStr
                            llClfEnd = gDateValue(slStr)
                            If llClfEnd < llClfStart Then
                                blExpired = True
                            Else
                                'not cbs, does the line span the requested period (ie spots start in the future of request)
                                If llClfStart > llStdEnd Or llClfEnd < llStdStart Then        'this line outside the range
                                    'ttp 9560 11-5-19 this line is expired, determine if each line is to be output to process
                                    If (ilClf = UBound(tgClfCT) - 1) Then       'end of all lines to process; need to write out data (i.e. by advt)
                                        If Not blAtLeastOneLineToProcess Then   'didnt find anything to process, ignore the contract or line
                                            blExpired = True
                                        End If
                                    Else            'this line is outside the parameters of request, and its not the last line to process.
                                                    'if one of these options, ignore writing out the lines data
                                        If (imOwner) Or (imVehicle) Or (ilWriteForEachLine) Or (ilListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB And (imSubSort > 0 Or imPrimSort = 6)) Or (ilListIndex = CNT_BOBCOMPARE And igRptCallType = CONTRACTSJOB And imMajorSet > 0) Then
                                            blExpired = True
                                        End If
                                    End If
                                Else
                                    blAtLeastOneLineToProcess = True
                                End If
                            End If
                        End If
                        
                        If Not blExpired Then
                            '4-20-00 If (imOwner) Or (imVehicle) Or (ilClf = UBound(tgClfCt) - 1) Or (imSlsp And imVehSub) Then   'option by owner and vehicle must write out for each schline
                            '3-7-08 B & B Comparison needs to process and create the records for each vehicle if a vehicle group is selected since the group needs to be retrieved from the vehicle
                            'If (imOwner) Or (imVehicle) Or (ilClf = UBound(tgClfCT) - 1) Or (imSlsp) Or igRptCallType = SLSPCOMMSJOB Or (ilListIndex = CNT_BOBCOMPARE And igRptCallType = CONTRACTSJOB And imMajorSet > 0) Or (ilListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB And imSubSort > 0) Then     'option by owner and vehicle must write out for each schline
                                                       'all others write out for contract if last line has been processed
                            '4-17-09 if b & b comparison, need to always test the vehicle selectivity; fall thru so testing will be processed
                            '7-13-10 Sales Comparison selectivity needs to test vehicles if applicable
                            '2-15-13 write out record if vehicle group option on Sales Comparison (imPrimsort = 6, or any subsort selected) , need to make sure different vehicle groups are updated by vehicle
                            
                            'Note:  if the option selected was Vehicle, with sales split subtotals, flags have been swapped to process by slsp instead of vehicle so that the splits can occur.
                            'For that case, prepass records need to be written for each line (by vehicle) since the results printed will be by vehicle
                            
                            '3-25-13 more testing with slsp option whether or not to write each prepass record.
                            'if without splits, only write out for entire contract, not each line to preserve more accuracy
                            '8-4-00 vehicle or owners need to init the projection buckets after each sch line
                            '8-2-14 need to write out record for B & B Comparison after each line if by vehicle group, too many different sorts required
                            If (imOwner) Or (imVehicle) Or (ilClf = UBound(tgClfCT) - 1) Or (ilWriteForEachLine) Or (ilListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB And (imSubSort > 0 Or imPrimSort = 6)) Or (ilListIndex = CNT_BOBCOMPARE And igRptCallType = CONTRACTSJOB And imMajorSet > 0) Then
                            'If (imOwner) Or (imVehicle) Or (ilClf = UBound(tgClfCT) - 1) Or (imSlsp) Or igRptCallType = SLSPCOMMSJOB Or (ilListIndex = CNT_BOBCOMPARE And igRptCallType = CONTRACTSJOB) Or (ilListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB And (imSubSort > 0 Or imPrimSort = 6)) Then
                               ilFoundOption = True                    'assume everything included
                                'If (imVehicle And Not RptSelCt!ckcAll.Value = vbChecked) Then    'vehicle option and selected vehicles
                                If imVehicle Or imSubSort = 6 Then  'Or ilListIndex = CNT_BOBCOMPARE Then          '6-7-13 vehicle should not be tested here for Billed and Booked Compare, since its at the end of the contract (all sch lines processed already)
                                    ilFoundOption = False
                                    'If gFilterLists(tmClf.iVefCode, imIncludeCodes, imUseCodes()) Then
                                    If gFilterLists(tmClf.iVefCode, imInclVefCodes, imUsevefcodes()) Then
                                        ilFoundOption = True
                                    End If
                                End If
    
                                If ilFoundOption Then             'matching vehicle or owner found
                                    tlSplitInfo.iMatchSSCode = ilMatchSSCode
                                    tlSplitInfo.iStartCorT = ilStartCorT
                                    tlSplitInfo.iEndCorT = ilEndCorT
                                    tlSplitInfo.iFirstProjInx = ilFirstProjInx
                                    tlSplitInfo.iUseSlsComm = ilUseSlsComm
                                    tlSplitInfo.iVefCode = tmClf.iVefCode
                                    tlSplitInfo.iDateFlag = ilDateFlag
                                    tlSplitInfo.iNewCode = ilNewCode
                                    tlSplitInfo.sPctTrade = slPctTrade
                                    tlSplitInfo.sCashAgyComm = slCashAgyComm
                                    tlSplitInfo.sTradeAgyComm = tgChfCT.sAgyCTrade        '12-23-02
                                    tlSplitInfo.iNTRSlspComm = 0            '2-2-04
                                    tlSplitInfo.sNTR = "N"
                                    tlSplitInfo.iHardCost = False
                                    tlSplitInfo.iMnfNTRItemCode = 0         '11-06-06 not an NTR
                                    mBobSetupPctOfSplit tlSplitInfo, llStdStartDates(), tlSlf(), tlScf(), tlSlfIndex, tmCntAllYear(), tmOneVehAllYear()
                                 End If                         'ilfoundoption
        
                                'process the makegoods for this line - there can be multiple vehicles that spots were moved  to.  Each
                                'new vehicle must be retrieved and it's splits determined
                                For ilVehLoop = 0 To imUpperAdjust - 1 Step 1
                                    ilFoundOption = True                    'assume everything included
                                    'If imVehicle And Not RptSelCt!ckcAll.Value = vbChecked Then   'vehicle option and selected vehicles
                                    If imVehicle Or imSubSort = 6 Or (imSlsp And imVehSub) Or ilListIndex = CNT_BOBCOMPARE Then
                                        ilFoundOption = False                    'assume everything included
                                        'If gFilterLists(tmAdjust(ilVehLoop).iVefCode, imIncludeCodes, imUseCodes()) Then
                                        If gFilterLists(tmAdjust(ilVehLoop).iVefCode, imInclVefCodes, imUsevefcodes()) Then
                                            ilFoundOption = True
                                        End If
                                    End If
    
                                    If tmAdjust(ilVehLoop).iVefCode > 0 And ilFoundOption Then
                                        ilHowMany = 0
                                        ilHowManyDefined = 0
                                        '4-20-00
                                        mBobGetHowManyFuture tmAdjust(ilVehLoop).iVefCode, ilHowMany, ilHowManyDefined, ilMatchSSCode, imSlfCode(), lmSlfSplit(), llStdStartDates()         '8-4-00 determine the number of owner or slsp splits
                                        For illoop = 0 To ilHowMany - 1 Step 1
                                            If imSlsp Then
                                                'llProcessPct = tgChfCt.lComm(ilLoop)          'slsp split % or 100%
                                                llProcessPct = lmSlfSplit(illoop)           '4-20-00
                                                          'slsp split % or 100%
                                                lmSlfDiffComm = lmSlfSplitRev(illoop)       '1-31-04
                                                ilSlfRecd = gBinarySearchSlf(imSlfCode(illoop))
                                                If ilSlfRecd = -1 Then
                                                    llProcessPct = 0
                                                Else
                                                    tmSlf = tgMSlf(ilSlfRecd)
                                                End If
                                            ElseIf imOwner Or imTrikIfOwner Then            '8-4-00
                                                If tmOneVehAllYear(illoop).AllYear.iSSMnfCode = ilMatchSSCode Then
                                                    llProcessPct = -1
                                                    tmGrf.iCode2 = tmOneVehAllYear(illoop).AllYear.iMnfGroup 'participant
                                                Else                            '4-6-16 handle case where sales source doesnt exist with vehicle
                                                    llProcessPct = 0
                                                    tmGrf.iCode2 = 0                'no owner (participant)
                                                End If
                                            ElseIf (imVehicle And smGrossOrNet = "B") Then      '4-5-01  need the participant share for net-net option
                                                If tmOneVehAllYear(illoop).AllYear.iSSMnfCode = ilMatchSSCode Then
                                                    llProcessPct = 1000000
                                                    '6-15-09 need to re-establish the one participants percentages
                                                    tmOnePartAllYear = tmOneVehAllYear(illoop).AllYear          '5-11-09 participant percentages for the year
                                                    If tmOnePartAllYear.iMnfGroup <> 0 Then             '4-6-16 handle case where participant not defined with vehicle
                                                        If tmOnePartAllYear.iOwnerByDate <> 1 Then
                                                            llProcessPct = 0
                                                        End If
                                                    End If
                                                Else
                                                    llProcessPct = 0
                                                End If
                                            Else
                                                llProcessPct = 1000000              'if advt or vehicle, just use slsp since there will always be one
                                                                                    'and only one pass will be processed
                                            End If
    
                                            If llProcessPct <> 0 Then               '-1 indicates owner where the % must be retrieved by date
                                                ilFoundOne = mFoundSelection(illoop, tmAdjust(ilVehLoop).iVefCode, imSlfCode(), lmSlfSplit())         '8-4-00 see if selective slsp, owner, vehicle chosen
                                                If ilFoundOne Then
                                                    For ilCorT = ilStartCorT To ilEndCorT Step 1
                                                        For ilTemp = 1 To 12
                                                            llTempProject(ilTemp) = tmAdjust(ilVehLoop).lProject(ilTemp)
                                                            llTempAcquisition(ilTemp) = tmAdjust(ilVehLoop).lAcquisitionCost(ilTemp)
                                                        Next ilTemp
                                                        tmGrf.iVefCode = tmAdjust(ilVehLoop).iVefCode
                                                        '4-20-00 mBOBNewInsert llTempProject(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, slCommPct, smGrossOrNet, ilHowManydefined, ilMatchSSCode, ilDateFlag, ilNewCode
                                                        If igRptCallType = SLSPCOMMSJOB Then        'loop one month at a time because each month could have a different slsp comm %- retrieve the unique one
    
                                                            For ilTemp = ilFirstProjInx To 12
                                                                '4-20-00
                                                                gGetCommByDates imSlfCode(), imslfcomm(), imslfremnant(), tlSlfIndex(), tlScf(), tlSlf(), tmClf.iVefCode, llStdStartDates(ilTemp), tgChfCT '7-11-00
                                                                slCommPct = gIntToStrDec(imslfcomm(illoop), 2)
    
                                                                If tgChfCT.sType = "T" Then                   'if remnant, differ commission
                                                                    slCommPct = gIntToStrDec(imslfremnant(illoop), 2)
                                                                End If
                                                                '1-31-04 mBOBLoopOnMonth: do not send participant index.  Not used by Slsp comm; force 0
                                                                If ilTemp = ilFirstProjInx Then     '4-6-00 first time thru, init buckets in mBOBLoopOnMonth rtn
                                                                    mBOBLoopOnMonth llTempProject(), llTempAcquisition(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, slCommPct, smGrossOrNet, ilHowManyDefined, ilMatchSSCode, ilDateFlag, ilNewCode, -ilTemp, ilTemp, tmOnePartAllYear, tgChfCT.sAgyCTrade '1-31-04
                                                                Else
                                                                    mBOBLoopOnMonth llTempProject(), llTempAcquisition(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, slCommPct, smGrossOrNet, ilHowManyDefined, ilMatchSSCode, ilDateFlag, ilNewCode, ilTemp, ilTemp, tmOnePartAllYear, tgChfCT.sAgyCTrade  '1-31-04
                                                                End If
                                                            Next ilTemp
                                                        Else
                                                            If imOwner Or (imVehicle And imTrikIfOwner) Or (imVehicle And smGrossOrNet = "B") Then      '5-11-09
                                                                tmOnePartAllYear = tmOneVehAllYear(illoop).AllYear
                                                            Else
                                                                tmOnePartAllYear = tmOneVehAllYear(0).AllYear
                                                            End If
                                                            '5-11-09 if vehicle gross/net option, need to make sure to get the correct owner % in case owner has changed
                                                            If imVehicle And smGrossOrNet = "B" Then
                                                                '8-2-09 already got the sales source; if first time thru cycle its the owner
                                                                 If tmOnePartAllYear.iOwnerByDate = 1 Or tmOnePartAllYear.iMnfGroup = 0 Then        '4-6-16 handle case where no group defined with vehicle, always include
                                                                    mBOBLoopOnMonth llTempProject(), llTempAcquisition(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, slCommPct, smGrossOrNet, ilHowManyDefined, ilMatchSSCode, ilDateFlag, ilNewCode, 1, igPeriods, tmOnePartAllYear, tgChfCT.sAgyCTrade
                                                                End If
                                                            Else
                                                                mBOBLoopOnMonth llTempProject(), llTempAcquisition(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, slCommPct, smGrossOrNet, ilHowManyDefined, ilMatchSSCode, ilDateFlag, ilNewCode, 1, igPeriods, tmOnePartAllYear, tgChfCT.sAgyCTrade
                                                            End If
                                                        End If
    
                                                    Next ilCorT
                                                End If              'ilfoundOne
                                            End If                  'llprocesspct >0
                                            '5-11-09 remove
                                            'If imVehicle And smGrossOrNet = "B" Then        '4-5-01 net-net option only by vehicle
                                                'If tmVef.iMnfSSCode(ilLoop + 1) = ilMatchSSCode Then  'only use the first one of the matching sales source
                                            '        ilLoop = ilHowMany
                                                'End If
                                            'End If
                                        Next illoop                 '0 to ilhowmany-1 step 1
                                    End If
                                Next ilVehLoop                  '0 To imUpperAdjust - 1
                                '4-20-00 If (imVehicle) Or (imOwner) Or (imSlsp And imVehSub) Then     'vehicle or owners need to init the projection buckets after each sch line
                                '3-7-08 B & B Comparison needs to process and create the records for each vehicle if a vehicle group is selected since the group needs to be retrieved from the vehicle
                                '2-15-13 write out record if vehicle group option on Sales Comparison (imPrimsort = 6, or any subsort selected) , need to make sure different vehicle groups are updated by vehicle
                                
                                'Note:  if the option selected was Vehicle, with sales split subtotals, flags have been swapped to process by slsp instead of vehicle so that the splits can occur.
                                'For that case, prepass records need to be written for each line (by vehicle) since the results printed will be by vehicle
                                
                                '3-25-13 more testing with slsp option whether or not to write each prepass record.
                                'if without splits, only write out for entire contract, not each line to preserve more accuracy
                                '8-4-00 vehicle or owners need to init the projection buckets after each sch line
                                '8-2-14 need to write out record for B & B Comparison after each line if by vehicle group, too many different sorts required
                                If (imVehicle) Or (imOwner) Or (imVehicle And imTrikIfOwner) Or (ilWriteForEachLine) Or (ilListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB And (imSubSort > 0 Or imPrimSort = 6)) Or (ilListIndex = CNT_BOBCOMPARE And igRptCallType = CONTRACTSJOB And imMajorSet > 0) Then
                                    For ilScratch = 1 To 13 Step 1    'init projection buckets for next line or contract
                                        lmProject(ilScratch) = 0
                                        lmAcquisition(ilScratch) = 0
                                        lmAcquisitionNet(ilScratch) = 0
                                    Next ilScratch
                                     ReDim tmAdjust(0 To 0) As ADJUSTLIST             'prepare list of mgs
                                    imUpperAdjust = 0
                                    'init the acquistion costs
                                    For ilScratch = 0 To UBound(llCalSpots) - 1
                                        llCalSpots(ilScratch) = 0        'init buckets for daily calendar values
                                        llCalAmt(ilScratch) = 0
                                        llCalAcqAmt(ilScratch) = 0
                                        llCalAcqNetAmt(ilScratch) = 0
                                    Next ilScratch
                                End If
                            End If                          'if (owner), slsp,  or (vehicle) or end of contract
                            'End If                          'ilFoundoption and <> H
                        End If                      'blExpired
                    Next ilClf                          'next schedule line - for advt & slsp the entire contr is accumulated before writing to GRF
                End If                              'include Air Time vs NTR
            End If                                  'exclude all promotions, merchandising - only include trade if requested
        End If                                      'ilfound
        If (imAdvt) Or (imAgency) Or (imBusCat) Or (imProdProt) Or (imSlsp) Then                'these options have processed by contract, not lines.  Contract complete, init $
            For ilScratch = 1 To 13 Step 1          'init projection buckets for next or contract
                lmProject(ilScratch) = 0
                lmAcquisition(ilScratch) = 0
                lmAcquisitionNet(ilScratch) = 0
            Next ilScratch
        End If
    Next ilCurrentRecd
    
    Erase tlSofList, tmMnfList, tlScf, tlSlf, tlSlfIndex, tlSbf
    Erase tlMnf, tmAdjust, tmSBFAdjust
    Erase lmSlfSplit, imSlfCode, imslfcomm, imslfremnant
    Erase imUsevefcodes, imUseAdfCodes, imUseAgfCodes, imUseCatCodes, imUseProdCodes
    Erase imUseCodes, imUseSlfCodes
    Erase tmAcqPctByPeriod, tlRvf

    ilRet = btrClose(hmScf)
    btrDestroy hmScf
End Function

'               mBuildLRch - Create the current versions line research data based on unique rate & DP or
'                           Create the previous versions line research data
'               <output> tlRch() - Current research array (tmLRch) or Previous research array (tmPrevLRch)
'               <input> llTemp - 4-11-19 chg to long;index into the saved lines research data
'                       ilSavePkVgh - Package vehicle code
'                       llCntGrimps - Total Gross impressions accumulated
'                       llPop - population
'                       ilQtr - quarter that is being calculated 2-20-00
'       4-10-19 iltemp changed to long llTemp due to subscript out of range
Sub mBuildLRch(tlLRch() As RESEARCHINFO, llTemp As Long, ilSavePkVeh As Integer, llCntGrimps As Long, llPop As Long)
    'Dim llTotalCost As Long
    Dim dlTotalCost As Double 'TTP 10439 - Rerate 21,000,000
    Dim llPopEst As Long
    If tmClf.sType <> "A" And tmClf.sType <> "O" And tmClf.sType <> "E" Then
        'gAvgAudToLnResearch sm1or2PlaceRating, True, llPop, tlLRch(llTemp).lPopEst(), tlLRch(llTemp).lSpots(), tlLRch(llTemp).lRates(), tlLRch(llTemp).lAvgAud(), llTotalCost, tmCbf.lAvgAud, tlLRch(llTemp).iWklyRating(), tmCbf.iAvgRate, tlLRch(llTemp).lWklyGrimp(), tmCbf.lGrImp, tlLRch(llTemp).lWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, llPopEst
        gAvgAudToLnResearch sm1or2PlaceRating, True, llPop, tlLRch(llTemp).lPopEst(), tlLRch(llTemp).lSpots(), tlLRch(llTemp).lRates(), tlLRch(llTemp).lAvgAud(), dlTotalCost, tmCbf.lAvgAud, tlLRch(llTemp).iWklyRating(), tmCbf.iAvgRate, tlLRch(llTemp).lWklyGrimp(), tmCbf.lGrImp, tlLRch(llTemp).lWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, llPopEst 'TTP 10439 - Rerate 21,000,000
    Else
        'llTotalCost = 0
        dlTotalCost = 0 'TTP 10439 - Rerate 21,000,000
        tmCbf.lAvgAud = 0
        tmCbf.iAvgRate = 0
        tmCbf.lGrImp = 0
        tmCbf.lGRP = 0
        tmCbf.lCPP = 0
        tmCbf.lCPM = 0
        llPopEst = 0            '6-1-04
    End If
    'Update array with results of research routine (didn't use the actual field names in the subroutine call because
    'the total parameters were too long
    tlLRch(llTemp).iVefCode = tmClf.iVefCode
    tlLRch(llTemp).iLineNo = tmClf.iLine
    tlLRch(llTemp).sType = tmClf.sType          's = std, O = order, a=air, H = hidden
    tlLRch(llTemp).iPkLineNo = tmClf.iPkLineNo  'pkg line reference if hidden
    tlLRch(llTemp).iPkvefCode = ilSavePkVeh     'associ pkg vehicle code if hidden line
    'tlLRch(llTemp).lTotalCost = llTotalCost
    tlLRch(llTemp).dTotalCost = dlTotalCost 'TTP 10439 - Rerate 21,000,000
    tlLRch(llTemp).lTotalCPP = tmCbf.lCPP
    tlLRch(llTemp).lTotalCPM = tmCbf.lCPM
    tlLRch(llTemp).lTotalGRP = tmCbf.lGRP
    tlLRch(llTemp).lTotalGrimps = tmCbf.lGrImp
    tlLRch(llTemp).iTotalAvgRating = tmCbf.iAvgRate
    tlLRch(llTemp).lTotalAvgAud = tmCbf.lAvgAud
    tlLRch(llTemp).lSatelliteEst = llPopEst             '6-1-04
    ReDim Preserve tlLRch(LBound(tlLRch) To UBound(tlLRch) + 1)
    llCntGrimps = llCntGrimps + tmCbf.lGrImp              'accum contracts total grimps so that % distrib on each line can be calculated in BR
End Sub

'           For insertion Orders, calculate producers share and
'           participants share
'           <input) ilListIndex = report index (CNT_BR or CNT_INSERTION)
'                   imCalcNetNet - true if show netnet value on Insrtion Order , 10-28-08 chg to common module variable
''
'           01-16-01
'
'           '10-29-08 NTR calls this routine, make common to air time and NTR
Sub mCalcNetNet(ilListIndex As Integer)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  ilSSLoop                                                                              *
    '******************************************************************************************
    
    Dim ilVefCode As Integer
    Dim llProcessPct As Long
    Dim slPct As String
    Dim slAmount As String
    Dim slDollar As String
    Dim ilRet As Integer
    Dim illoop As Integer
    Dim ilSaveProdPct As Integer

    llProcessPct = 0
    ilSaveProdPct = tmCbf.iProdPct
    tmCbf.iProdPct = 0
    If ilListIndex = CNT_INSERTION And imShowNetNet Then
        'Read in the salesperson and office to find the Sales Source
        'read only if not already in memory
        If tmSlf.iCode <> tgChfCT.iSlfCode(0) Then
            tmSlfSrchKey.iCode = tgChfCT.iSlfCode(0)
            ilRet = btrGetEqual(hmSlf, tmSlf, imSlfRecLen, tmSlfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'find matching Slsp recd
            If ilRet <> BTRV_ERR_NONE Then
                'set the parameters to zero, dont show on insertion order
                tmCbf.iProdPct = 0
            End If
        End If
        If tmSof.iCode <> tmSlf.iSofCode Then
            tmSofSrchKey.iCode = tmSlf.iSofCode
            ilRet = btrGetEqual(hmSof, tmSof, imSofRecLen, tmSofSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'find matching Slsp recd
            If ilRet <> BTRV_ERR_NONE Then
                'set the parameters to zero, don't show on Insrtion order
                tmCbf.iProdPct = 0
            End If
        End If
        ilVefCode = 0
        'the sales source is sof.imnfsscode
        'find the matching vehicle in memory
        illoop = gBinarySearchVef(tmCbf.iVefCode)
        If illoop <> -1 Then
            ilVefCode = illoop
        End If
        If ilVefCode > 0 Then
            '3-12-14 if net-net but already an acquisition cost, do not net it down
            If Trim(tmCbf.sPriceType) <> "" Then      'has a price type, meaning its a spot rate vs acq and ok to net net the rate
                tmCbf.iProdPct = gObtainOwnerPctForSS(tmCbf.iVefCode, tmSof.iMnfSSCode, tgChfCT.iStartDate(), tmPifKey(), tmPifPct())
                'calculate the lines net/net value
                slPct = gIntToStrDec(tmCbf.iProdPct, 2)
                slAmount = gLongToStrDec(tmCbf.lRate, 2)
                slDollar = gMulStr(slPct, slAmount)
                tmCbf.lRate = Val(gRoundStr(slDollar, "01.", 0))
            End If
        End If
    End If              'ilListIndex = CNT_INSERTION
    tmCbf.iProdPct = ilSaveProdPct
End Sub

'**********************************************************************************************************
'
'                       mCreateTieOut - Based on vehicle or office option, create
'                                       arrays for a new vehicle or office from
'                                       the budget file or contract file.  Note:
'                                       all arrays should be created from the budget
'                                       file by the time it gets to the contracts.
'                       <input>  ilBgtCnt - 1 = test budget field for matching office or veh.
'                                           2 = test contr field for matching office or veh.
'                                ilOfcVeh - 1 = testing office field
'                                           2 = testing vehicle field
'                                ilOfcVehCode - office code or vehicle code
'                       <output> ilTieOutIndex - index into the matching office or veh array
'                                tmTieOut() - array of categories to gather from budget or
'                                             contract files (i.e. plan $, orders on books, new
'                                             business, etc.
'                       mCreateTieOut = True if valid budget or contract to process (the
'                                       list box is tested for valid selection)
'                                       Otherwise False.
'
'*********************************************************************************************************
Function mCreateTieOut(ilBgtCnt, ilOfcVeh, ilOfcVehCode, ilTieOutIndex, tmTieOut() As TIEOUT) As Integer
    Dim ilSelected As Integer
    Dim slNameCode As String
    Dim slCode As String
    Dim illoop As Integer
    Dim ilOption As Integer
    Dim ilRet As Integer
    Dim ilFoundOne As Integer
    ilFoundOne = False
    If RptSelCt!rbcSelCInclude(1).Value Then                  'vehicle option
        If RptSelCt!ckcAll.Value = vbChecked Then                           'all veh selected
            ilSelected = True
        Else
            ilSelected = False
            For ilOption = 0 To RptSelCt!lbcSelection(6).ListCount - 1 Step 1
                If (RptSelCt!lbcSelection(6).Selected(ilOption)) Then
                    slNameCode = tgCSVNameCode(ilOption).sKey  'RptSelCt!lbcCSVNameCode.List(ilOption)
                    ilRet = gParseItem(slNameCode, 2, "\", slCode)
                    If Val(slCode) = ilOfcVehCode Then
                        ilSelected = True
                        Exit For
                    End If
                End If
            Next ilOption
        End If
        If ilSelected Then
            For illoop = LBound(tmTieOut) To UBound(tmTieOut) Step 1
                'see if valid vehicle exists
                If tmTieOut(illoop).iCode = ilOfcVehCode Then
                    ilFoundOne = True
                    ilTieOutIndex = illoop
                    Exit For
                End If
            Next illoop
            If Not ilFoundOne Then
                ReDim Preserve tmTieOut(0 To igTieOutUpper) As TIEOUT
                tmTieOut(igTieOutUpper).sType = "V"
                tmTieOut(igTieOutUpper).iCode = ilOfcVehCode
                ilTieOutIndex = igTieOutUpper
                igTieOutUpper = igTieOutUpper + 1
                ilFoundOne = True
            End If
        End If
    Else                                                    'office option
        If RptSelCt!ckcAll.Value = vbChecked Then                           'all veh selected
            ilSelected = True
        Else
            ilSelected = False
            For ilOption = 0 To RptSelCt!lbcSelection(2).ListCount - 1 Step 1
                'Need to process all offices because of split in and split out $.  Filter
                'the office out when writing records to disk.
                'If (RptSelCt!lbcSelection(2).Selected(ilOption)) Then
                    slNameCode = tgSOCodeCT(ilOption).sKey   'RptSelCt!lbcSOCode.List(ilOption)
                    ilRet = gParseItem(slNameCode, 2, "\", slCode)
                    If Val(slCode) = ilOfcVehCode Then
                        ilSelected = True
                        Exit For
                    End If
                'End If
            Next ilOption
        End If
        If ilSelected Then
            For illoop = LBound(tmTieOut) To UBound(tmTieOut) Step 1
                'see if valid office exists
                If tmTieOut(illoop).iCode = ilOfcVehCode Then
                    ilFoundOne = True
                    ilTieOutIndex = illoop
                    Exit For
                End If
            Next illoop
            If Not ilFoundOne Then
                ReDim Preserve tmTieOut(0 To igTieOutUpper) As TIEOUT
                tmTieOut(igTieOutUpper).sType = "O"
                tmTieOut(igTieOutUpper).iCode = ilOfcVehCode
                ilTieOutIndex = igTieOutUpper
                igTieOutUpper = igTieOutUpper + 1
                ilFoundOne = True
            End If
        End If
    End If
    mCreateTieOut = ilFoundOne
End Function

'               Look up the Demo category descriptions and
'               format into one string for the contract
'               header
'
'               11/6/98 - create subroutine - ran out of
'                       memory space
'
'               10-28-03 show socio-economic category
Sub mDemoDesc(ilDemo As Integer)
    Dim slDemos As String
    Dim ilFirstDemo As Integer
    Dim ilLastDemo As Integer
    Dim illoop As Integer
    Dim ilRet As Integer
    Dim slStr As String
    Dim slSocEco As String
    Dim slNameCode As String
    Dim slCode As String
    Dim ilListIndex As Integer

    slSocEco = ""           '10-28-03 - show social economic category if selected
    If RptSelCt!cbcSet1.ListIndex > 0 Then
        slNameCode = tgSocEcoCode(RptSelCt!cbcSet1.ListIndex - 1).sKey
        'ilRet = gParseItem(slNameCode, 1, "\", slSocEco)
        ilRet = gParseItem(slNameCode, 2, "\", slCode)
        ilListIndex = Val(slCode)
        For illoop = LBound(tgSocEcoMnf) To UBound(tgSocEcoMnf)
            If ilListIndex = tgSocEcoMnf(illoop).iCode Then
                slSocEco = Trim$(tgSocEcoMnf(illoop).sName)
                Exit For
            End If
        Next illoop
    End If
    'Obtain all the demos used for this contract, string out the  names
    slDemos = " "
    ilFirstDemo = 0                 'assume gathering all 4 demos
    ilLastDemo = 3
    If RptSelCt!rbcSelC7(1).Value Then            'Use all demos (proposal option only)
        'Only show the demo it's gathering for rather than stringing out all of them (which is
        'what will be shown when only the primary is used)
        ilFirstDemo = ilDemo
        ilLastDemo = ilDemo
    End If
    
    If tgSaf(0).sHideDemoOnBR = "Y" And tgChfCT.sHideDemo = "Y" Then
        slDemos = "Impressions"
    Else
        For illoop = ilFirstDemo To ilLastDemo Step 1
            If tgChfCT.iMnfDemo(illoop) > 0 Then
                tmMnfSrchKey.iCode = tgChfCT.iMnfDemo(illoop)         'demo category
                ilRet = btrGetEqual(hmMnf, tmMnf, imMnfRecLen, tmMnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'find matching demo name
                If ilRet <> BTRV_ERR_NONE Then
                    tmMnf.sName = " "                        'error
                End If
                If slDemos = " " Then
                    slDemos = RTrim$(tmMnf.sName)
                Else
                    slDemos = slDemos & ", " & RTrim$(tmMnf.sName)
                End If
                'show CPP or CPM data
                If tgChfCT.lTarget(illoop) > 0 And RptSelCt!ckcSelC6(2).Value = vbChecked Then        'show cpp or cpm on proof only
                    If tgChfCT.sCppCpm = "P" Then         'CPP
                        slStr = Format$(tgChfCT.lTarget(illoop) / 100, "###")
                        slDemos = slDemos & " CPP@" & Trim$(slStr)
                    ElseIf tgChfCT.sCppCpm = "M" Then     'CPM
                        slStr = Format$(tgChfCT.lTarget(illoop) / 100, "###.00")
                        slDemos = slDemos & " CPM@" & Trim$(slStr)
                    End If
                End If
            End If
        Next illoop
    End If
    If slSocEco = "" Then
        tmCbf.sDemos = slDemos
    Else
        tmCbf.sDemos = slSocEco & " " & slDemos
    End If
End Sub

Function mFoundSelection(ilWhichSelection As Integer, ilVefCode As Integer, ilSlfCode() As Integer, llSlfSplit() As Long) As Integer    '8-4-00
    Dim illoop As Integer
    Dim slNameCode As String
    Dim slCode As String
    Dim ilRet As Integer
    Dim ilFoundOne As Integer
    
    ilFoundOne = False
    If (imSlsp Or imOwner) Or (imVehicle And imTrikIfOwner) Then
        If imSlsp And igSwapBOBOption Then     '9-28-10 option selected was vehicle with split slsp subtotals.  The option was internally swapped to slsp
                                                'for this option, there is no slsp selectivity, force all slsp to process
            ilFoundOne = True
        Else
            If imSlsp Or imOwner Then
                For illoop = 0 To RptSelCt!lbcSelection(2).ListCount - 1 Step 1
                    If RptSelCt!lbcSelection(2).Selected(illoop) Then
                        slNameCode = tgSalesperson(illoop).sKey
                        ilRet = gParseItem(slNameCode, 2, "\", slCode)    'Get application name
                        If imSlsp Then
                            If Val(slCode) = ilSlfCode(ilWhichSelection) Then       '11-23-03
                                ilFoundOne = True
                                Exit For
                            End If
                        Else                                        'selected this owner?
                            If tmOneVehAllYear(ilWhichSelection).AllYear.iMnfGroup = 0 Then          '4-6-16 handle case where sales source does not exist with vehicle
                                ilFoundOne = True
                                Exit For
                            Else
                                If Val(slCode) = tmOneVehAllYear(ilWhichSelection).AllYear.iMnfGroup Then
                                    ilFoundOne = True
                                    Exit For
                                End If
                            End If
                        End If
                
                    End If
                    If ilFoundOne Then
                        Exit For
                    End If
                Next illoop
            Else
                If RptSelCt!rbcSelCInclude(4).Value = True Then             'participant/vehicle splits
                    For illoop = 0 To RptSelCt!lbcSelection(2).ListCount - 1 Step 1
                        If RptSelCt!lbcSelection(2).Selected(illoop) Then
                            slNameCode = tgSalesperson(illoop).sKey
                            ilRet = gParseItem(slNameCode, 2, "\", slCode)    'Get application name
                            If tmOneVehAllYear(ilWhichSelection).AllYear.iMnfGroup = 0 Then     '4-6-16 handle case where Sales source/vehicle group isnt defined with vehicle
                                ilFoundOne = True
                                Exit For
                            Else
                                If Val(slCode) = tmOneVehAllYear(ilWhichSelection).AllYear.iMnfGroup Then
                                    ilFoundOne = True
                                    Exit For
                                End If
                            End If
                        End If
                        If ilFoundOne Then
                            Exit For
                        End If
                    Next illoop
                Else
                    ilFoundOne = True
                End If
            End If
        End If
     Else
        ilFoundOne = True           'all other options, include
    End If
    
    If imSlsp Then
        tmGrf.iSlfCode = ilSlfCode(ilWhichSelection) 'slsp code
        tmGrf.lCode4 = llSlfSplit(ilWhichSelection)        'slsp comm %
        tmGrf.iVefCode = tmClf.iVefCode
        If ilFoundOne Then      'if OK so far, continue to test sales office
            'no salesofice test for sales comparison
             If RptSelCt!lbcRptType.ListIndex = CNT_BOB Then      '6-19-08 only b&B by slsp has office option
                ilFoundOne = False
                If igSwapBOBOption Then     '8-6-10 vehicle w/split slsp subtotals swapped to do slsp w/vehicle subtotals.  No
                                            'need to test sales offices, take them all
                    ilFoundOne = True
                Else
                    If Not RptSelCt!CkcAllveh.Value = vbChecked Then
                        For illoop = 0 To RptSelCt!lbcSelection(7).ListCount - 1
                            If RptSelCt!lbcSelection(7).Selected(illoop) Then
                                slNameCode = tgSOCodeCT(illoop).sKey         'sales source code
                                ilRet = gParseItem(slNameCode, 2, "\", slCode)
                                If Val(slCode) = tmSlf.iSofCode Then      'sales office of this contract match one selected?
                                    ilFoundOne = True
                                    Exit For
                                End If
                            End If
                        Next illoop
                    Else
                        ilFoundOne = True
                    End If
                End If
            End If
        End If
    ElseIf imOwner Or imTrikIfOwner Then    '8-4-00
        tmGrf.iCode2 = tmOneVehAllYear(ilWhichSelection).AllYear.iMnfGroup
        tmGrf.iVefCode = tmClf.iVefCode
    ElseIf imVehicle Or imVehGroup Then         'imVehGroup = Sales Comparison (major sort = Vehicle Group)
        tmGrf.iVefCode = tmClf.iVefCode
        If RptSelCt!lbcRptType.ListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB Then        '4-25-06
            tmGrf.iCode2 = tmClf.iVefCode
            'set major sort for vehicle group if selected
        ElseIf RptSelCt!lbcRptType.ListIndex = CNT_BOBRECAP And igRptCallType = CONTRACTSJOB Then       '11-6-06
            '11-06-06 this is airtime contracts, If recap, split agency from direct
            If mCheckAdvPolitical(tgChfCT.iAdfCode) Then          'its a political, include this contract?
                tmGrf.iPerGenl(10) = 3                        'separate politicals from direct & agy comm & NTR
            Else
                If tgChfCT.iAgfCode = 0 Then
                    tmGrf.iPerGenl(10) = 0                  'direct
                Else
                    tmGrf.iPerGenl(10) = 1                  'agency
                End If
            End If
        Else
            '7-1-14 move obtaining vehicle only when needed; use binary search for speed up
            If tmVef.iCode <> tmClf.iVefCode Then
                'get the vehicle code for its associated vehicle group
                ilRet = gBinarySearchVef(tmClf.iVefCode)
                If ilRet = -1 Then          'not found
                    tmVef.iCode = 0
                    tmVef.iOwnerMnfCode = 0
                End If
            End If
            tmGrf.iCode2 = tmVef.iOwnerMnfCode       'pick up first veh group
            'for billed and booked, allow subsort by slsp within vehicle    '10-18-06
            tmGrf.iSlfCode = tgChfCT.iSlfCode(0)      'use primary one onlyl
        End If
    ElseIf imBusCat Then                        'bus category
        tmGrf.iCode2 = tgChfCT.iMnfBus
    ElseIf imProdProt Then                      'product protection
        tmGrf.iCode2 = tgChfCT.iMnfComp(0)
    ElseIf imAgency Then                        'agency
        tmGrf.iCode2 = tgChfCT.iAgfCode
    End If

    'if Sales Comparison report with minor sort field defined, setup for output
    If RptSelCt!lbcRptType.ListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB Then
        'selection is always set to slsp in case the minor sort needs to be split by the slsp
        'setup all fields sort fields for major and minor selection
        If imPrimSort = 2 Then      'bus category
            tmGrf.iCode2 = tgChfCT.iMnfBus
        ElseIf imPrimSort = 3 Then                      'product protection
            tmGrf.iCode2 = tgChfCT.iMnfComp(0)
        ElseIf imPrimSort = 1 Then                       'agency
            tmGrf.iCode2 = tgChfCT.iAgfCode
        ElseIf imPrimSort = 6 Then                      'vehicle group
            gGetVehGrpSets ilVefCode, 0, imMajorSet, ilRet, tmGrf.iCode2     '7-1-11 setup vehicle group as major sort
        End If
        If imSubSort > 0 Then      'subsort defined
            If imSubSort = 6 Then           'minor sort  = vehicles
                tmGrf.iVefCode = ilVefCode
            ElseIf imSubSort = 1 Or imSubSort = 5 Then 'advt, slsp  already exists
            ElseIf imSubSort = 2 Then       'agy
                tmGrf.iPerGenl(11) = tgChfCT.iAgfCode
            ElseIf imSubSort = 3 Then       'bus cat
                tmGrf.iPerGenl(11) = tgChfCT.iMnfBus
            ElseIf imSubSort = 4 Then       'prod prot
                tmGrf.iPerGenl(11) = tgChfCT.iMnfComp(0)
            ElseIf imSubSort = 7 Then       'veh group
                gGetVehGrpSets ilVefCode, imMinorSet, 0, tmGrf.iPerGenl(11), ilRet     '7-1-11 setup vehicle group as minor sort
            End If
        End If
    End If

    If RptSelCt!lbcRptType.ListIndex = CNT_BOBCOMPARE And igRptCallType = CONTRACTSJOB Then
        tmGrf.iVefCode = tmClf.iVefCode             'if the minor selection wasnt vehicle, then this prepass vehicle field hasnt been set up yet
        gGetVehGrpSets tmGrf.iVefCode, imMinorSet, imMajorSet, tmGrf.iPerGenl(2), tmGrf.iPerGenl(3)     'setup vehicle group as minor sort
        tmGrf.iPerGenl(13) = igBSelectedIndex       'Budget mnf code
    End If

    mFoundSelection = ilFoundOne
End Function

'                   mGenDiff - Compare the current contract version against
'                       the previous versions and build the difference
'                       in "TG" array (tgChfCt, tgClfCt, tgCffCt)
'
'                   <input> lmCurrCode = current versions contract code
'                           lmPrevCode = previous versions contract code
'                   <output> llPrevSpots - total spot count of current version
'                            llPrevGross - total gross $ of current version
'                            ilCurrTotWks - total weeks from start date to end date (ignoring
'                                           if spots aired in every week
'                            ilCurrAirWks - total weeks having spots to air
'                   Created:  4/25/98 (copied & modified from Contract.bas (cbcDifference)
'                             6/3/00 hidden lines (from packags are added in spots & $ causing overstated amounts)
'
'           3-24-05 chg ilPrevSpots to long for more than 32000 spots
'           3-12-08 when comparing current and previous contracts with mutual weeks, a second
'                   line is created to show the differences when the $ changes.
'                   # spots must not be changed to zero (thats a removal of a week)
'                   When current weeks are different than the previous weeks and there is no $ change,
'                   the difference is shown on one line, not two.
Sub mGenDiff(lmCurrCode As Long, lmPrevcode As Long, llPrevSpots As Long, llPrevGross As Long, ilCurrTotWks, ilCurrAirWks, Optional bmUseAcq As Boolean = False)
    Dim ilRet As Integer
    Dim ilFound As Integer
    Dim ilClf As Integer
    Dim ilDiffClf As Integer
    Dim ilCff As Integer
    Dim ilDiffCff As Integer
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim llLnStartDate As Long
    Dim llLnEndDate As Long
    Dim ilFirstCff As Integer
    Dim ilSpots As Integer
    Dim ilDiffSpots As Integer
    Dim ilDay As Integer
    Dim llDate As Long
    Dim ilCffFound As Integer
    Dim ilDiffCffFound As Integer
    Dim ilPrevCff As Integer
    Dim ilCffIndex As Integer
    Dim ilAddWk As Integer
    Dim slStartDate As String
    Dim slEndDate As String
    Dim ilClfIndex As Integer
    Dim illoop As Integer
    Dim llPrice As Long
    Dim ilPass As Integer
    Dim ilSpotsChgd As Integer
    Dim ilPriceChgd As Integer
    ReDim ilAllWks(0 To MAXWEEKSFOR2YRS) As Integer     'map of 2 years weeks, set on indicating spot airing in that week. Index zero ignored
    
    ilRet = gObtainCntr(hmCHF, hmClf, hmCff, lmCurrCode, False, tgChfCT, tmCClf(), tmCCff())
    If Not ilRet Then
        Exit Sub
    End If
    If lmPrevcode = 0 Then                  'no prvious, show everything as Added
        ReDim tmPclf(0 To 0) As CLFLIST
        tmPclf(0).iStatus = -1 'Not Used
        tmPclf(0).lRecPos = 0
        tmPclf(0).iFirstCff = -1
        ReDim tmPCff(0 To 0) As CFFLIST
        tmPCff(0).iStatus = -1 'Not Used
        tmPCff(0).lRecPos = 0
        tmPCff(0).iNextCff = -1
    Else
        ilRet = gObtainCntr(hmCHF, hmClf, hmCff, lmPrevcode, False, tmPChf, tmPclf(), tmPCff())
        If Not ilRet Then
            Exit Sub
        End If
    End If
    ReDim tgClfCT(0 To 0) As CLFLIST
    tgClfCT(0).iStatus = -1 'Not Used
    tgClfCT(0).lRecPos = 0
    tgClfCT(0).iFirstCff = -1
    ReDim tgCffCT(0 To 0) As CFFLIST
    tgCffCT(0).iStatus = -1 'Not Used
    tgCffCT(0).lRecPos = 0
    tgCffCT(0).iNextCff = -1

    'Compute Total spots and cost for current version
    llPrevSpots = 0
    llPrevGross = 0
    For ilClf = LBound(tmPclf) To UBound(tmPclf) - 1 Step 1
        ilCff = tmPclf(ilClf).iFirstCff
        Do While ilCff <> -1
        If (tmPCff(ilCff).iStatus = 0) Or (tmPCff(ilCff).iStatus = 1) Then
            llStartDate = tmPCff(ilCff).lStartDate
            llEndDate = tmPCff(ilCff).lEndDate
            Do While gWeekDayLong(llStartDate) <> 0
                llStartDate = llStartDate - 1
            Loop
            For llDate = llStartDate To llEndDate Step 7
                If tmPCff(ilCff).CffRec.sDyWk = "D" Then
                    ilSpots = 0
                    For ilDay = 0 To 6 Step 1
                    If (llDate + ilDay >= llStartDate) And (llDate + ilDay <= llEndDate) Then
                        ilSpots = ilSpots + tmPCff(ilCff).CffRec.iDay(ilDay)
                    End If
                    Next ilDay
                Else
                    ilSpots = tmPCff(ilCff).CffRec.iSpotsWk + tmPCff(ilCff).CffRec.iXSpotsWk
                End If
                
                If bmUseAcq Then
                    llPrice = tmPclf(ilClf).ClfRec.lAcquisitionCost     'differences with acq insertion order
                Else
                    Select Case tmPCff(ilCff).CffRec.sPriceType
                        Case "T"
                        llPrice = tmPCff(ilCff).CffRec.lActPrice
                        Case Else
                        llPrice = 0
                    End Select
                End If
                If tmPclf(ilClf).ClfRec.sType <> "H" Then           '6-3-00
                    llPrevGross = llPrevGross + (llPrice * ilSpots)
                    llPrevSpots = llPrevSpots + ilSpots
                End If
            Next llDate
        End If
        ilCff = tmPCff(ilCff).iNextCff
        Loop
    Next ilClf

    'Calculate the total airing weeks and total weeks (contract headr
    'start/end) from the current version for the output since differences
    'contract wont be correct
    ilCurrTotWks = 0
    ilCurrAirWks = 0
    'get start date of current header
    gUnpackDateLong tgChfCT.iStartDate(0), tgChfCT.iStartDate(1), llLnStartDate
    gUnpackDateLong tgChfCT.iEndDate(0), tgChfCT.iEndDate(1), llLnEndDate
    ilCurrTotWks = (llLnEndDate - llLnStartDate) \ 7 + 1
    For ilClf = LBound(tmCClf) To UBound(tmCClf) - 1 Step 1
        ilCff = tmCClf(ilClf).iFirstCff
        Do While ilCff <> -1
        If (tmCCff(ilCff).iStatus = 0) Or (tmCCff(ilCff).iStatus = 1) Then
            llStartDate = tmCCff(ilCff).lStartDate
            llEndDate = tmCCff(ilCff).lEndDate
            Do While gWeekDayLong(llStartDate) <> 0
                llStartDate = llStartDate - 1
            Loop
            For llDate = llStartDate To llEndDate Step 7
                If tmCCff(ilCff).CffRec.sDyWk = "D" Then
                    For ilDay = 0 To 6 Step 1
                    If (llDate + ilDay >= llStartDate) And (llDate + ilDay <= llEndDate) Then
                        ilSpots = ilSpots + tmCCff(ilCff).CffRec.iDay(ilDay)
                    End If
                    Next ilDay
                Else
                    ilSpots = tmCCff(ilCff).CffRec.iSpotsWk + tmCCff(ilCff).CffRec.iXSpotsWk
                End If
                If ilSpots <> 0 Then
                    illoop = (llDate - llLnStartDate) \ 7 + 1
                    If illoop > 0 Then
                        ilAllWks(illoop) = 1
                    End If
                End If
                ilSpots = 0             'init for next week
            Next llDate
        End If
        ilCff = tmCCff(ilCff).iNextCff
        Loop
    Next ilClf
    For illoop = 1 To MAXWEEKSFOR2YRS                   'add up all the weeks that have spots across the lines examined
        If ilAllWks(illoop) <> 0 Then
            ilCurrAirWks = ilCurrAirWks + 1
        End If
    Next illoop

    'Match up lines and determine differences.  Loop thru current versions.  for each line,
    'find matching line in the previous version
    For ilClf = LBound(tmCClf) To UBound(tmCClf) - 1 Step 1
        'Find matching line
        ilFirstCff = -1
        'Loop thru previous version, find a matching line with the current
        For ilDiffClf = LBound(tmPclf) To UBound(tmPclf) - 1 Step 1
            If tmCClf(ilClf).ClfRec.iLine = tmPclf(ilDiffClf).ClfRec.iLine Then
                gUnpackDateLong tmCClf(ilClf).ClfRec.iStartDate(0), tmCClf(ilClf).ClfRec.iStartDate(1), llStartDate
                gUnpackDateLong tmCClf(ilClf).ClfRec.iEndDate(0), tmCClf(ilClf).ClfRec.iEndDate(1), llEndDate
                gUnpackDateLong tmPclf(ilDiffClf).ClfRec.iStartDate(0), tmPclf(ilDiffClf).ClfRec.iStartDate(1), llLnStartDate
                gUnpackDateLong tmPclf(ilDiffClf).ClfRec.iEndDate(0), tmPclf(ilDiffClf).ClfRec.iEndDate(1), llLnEndDate
                If llEndDate >= llStartDate Then                        'current end date >= Prev start date?
                    If llLnEndDate >= llLnStartDate Then
                        If llLnStartDate < llStartDate Then             'prev start date < that current start date?
                            llStartDate = llLnStartDate                 'get earliest start date from previous
                        End If
                        If llLnEndDate > llEndDate Then                 'prev end date > that current start?
                            llEndDate = llLnEndDate                     'get latest end date from previous
                        End If
                    End If
                Else                                                    'current is a CBS, use the previous start & end dates
                    llStartDate = llLnStartDate
                    llEndDate = llLnEndDate
                End If
                ilCffFound = -1
                ilDiffCffFound = -1
                ilSpotsChgd = False
                ilPriceChgd = False
                For ilPass = 1 To 2                                      '1st pass:  look for matching lines with both spot count & price changed
                                                                        '2nd pass:  Ignore if both found, adjust for this case in removal & addition of week
                                                                        '2nd pass:  create the other differences
                    If llEndDate >= llStartDate Then                        'test for cancel before start
                        'Build airing week
                        For llDate = llStartDate To llEndDate Step 7        'loop from the start to the end, builld one week at a time
                            ilCffFound = -1
                            ilCff = tmCClf(ilClf).iFirstCff
                            ilSpots = 0
                            Do While ilCff <> -1
                                If (tmCCff(ilCff).iStatus = 0) Or (tmCCff(ilCff).iStatus = 1) Then
                                    gUnpackDateLong tmCCff(ilCff).CffRec.iStartDate(0), tmCCff(ilCff).CffRec.iStartDate(1), llLnStartDate    'Week Start date
                                    gUnpackDateLong tmCCff(ilCff).CffRec.iEndDate(0), tmCCff(ilCff).CffRec.iEndDate(1), llLnEndDate    'Week Start date
                                    If (llDate >= llLnStartDate) And (llDate <= llLnEndDate) Then
                                        ilCffFound = ilCff
                                        If tmCCff(ilCff).CffRec.sDyWk = "D" Then
                                            For ilDay = 0 To 6 Step 1
                                                ilSpots = ilSpots + tmCCff(ilCff).CffRec.iDay(ilDay)
                                            Next ilDay
                                        Else
                                            ilSpots = tmCCff(ilCff).CffRec.iSpotsWk + tmCCff(ilCff).CffRec.iXSpotsWk
                                        End If
                                        Exit Do
                                    End If
                                End If
                                ilCff = tmCCff(ilCff).iNextCff
                            Loop
                            ilDiffCffFound = -1
                            ilDiffCff = tmPclf(ilDiffClf).iFirstCff
                            ilDiffSpots = 0
                            Do While ilDiffCff <> -1
                                If (tmPCff(ilDiffCff).iStatus = 0) Or (tmPCff(ilDiffCff).iStatus = 1) Then
                                    gUnpackDateLong tmPCff(ilDiffCff).CffRec.iStartDate(0), tmPCff(ilDiffCff).CffRec.iStartDate(1), llLnStartDate    'Week Start date
                                    gUnpackDateLong tmPCff(ilDiffCff).CffRec.iEndDate(0), tmPCff(ilDiffCff).CffRec.iEndDate(1), llLnEndDate    'Week Start date
                                    If (llDate >= llLnStartDate) And (llDate <= llLnEndDate) Then
                                        ilDiffCffFound = ilDiffCff
                                        If tmPCff(ilDiffCff).CffRec.sDyWk = "D" Then
                                            For ilDay = 0 To 6 Step 1
                                                ilDiffSpots = ilDiffSpots + tmPCff(ilDiffCff).CffRec.iDay(ilDay)
                                            Next ilDay
                                        Else
                                            ilDiffSpots = tmPCff(ilDiffCff).CffRec.iSpotsWk + tmPCff(ilDiffCff).CffRec.iXSpotsWk
                                        End If
                                        Exit Do
                                    End If
                                End If
                                ilDiffCff = tmPCff(ilDiffCff).iNextCff
                            Loop
                            ilAddWk = 0
                            If (ilCffFound >= 0) And (ilDiffCffFound >= 0) Then
                                If ilSpots <> ilDiffSpots Then
                                    ilAddWk = 1
                                    ilSpotsChgd = True
                                End If
                                If tmCCff(ilCffFound).CffRec.sPriceType <> tmPCff(ilDiffCffFound).CffRec.sPriceType Then
                                    ilAddWk = 1
                                    ilPriceChgd = True
                                End If
                                
                                If bmUseAcq Then            '7-10-15 differences with acq costs implemented
                                    If tmCClf(ilClf).ClfRec.lAcquisitionCost <> tmPclf(ilDiffClf).ClfRec.lAcquisitionCost Then
                                        ilAddWk = 1
                                        ilPriceChgd = True
                                    End If
                                Else
                                    If tmCCff(ilCffFound).CffRec.lActPrice <> tmPCff(ilDiffCffFound).CffRec.lActPrice Then
                                        ilAddWk = 1
                                        ilPriceChgd = True
                                    End If
                                End If

                            ElseIf (ilCffFound >= 0) Then
                                ilAddWk = 2                         'current version new airing week
                            ElseIf (ilDiffCffFound >= 0) Then
                                ilAddWk = 3                         'current version removed airing week
                            End If
                            'The first pass is to only set the schedule lines to negative if something needs to be done
                            'in removal or addition of week logic (below)
                            If ((ilSpotsChgd) And (ilPriceChgd) And (ilPass = 1)) Or ((Not ilSpotsChgd) And (ilPriceChgd) And (ilPass = 1)) Then   'both rate & spot count changed, negate the
                                                                                    'line #s to indicate to process these as removal
                                                                                    'and addition of week
                                tmCClf(ilClf).ClfRec.iLine = -tmCClf(ilClf).ClfRec.iLine
                                tmPclf(ilDiffClf).ClfRec.iLine = -tmPclf(ilDiffClf).ClfRec.iLine
                                Exit For
                            End If
                            If ilPass = 2 Then
                                If ilAddWk > 0 Then
                                    ilCffIndex = UBound(tgCffCT)
                                    tgCffCT(ilCffIndex).iNextCff = -1
                                    If ilFirstCff = -1 Then
                                        ilClfIndex = UBound(tgClfCT)
                                        tgClfCT(ilClfIndex) = tmCClf(ilClf)
                                        tgClfCT(ilClfIndex).ClfRec.iStartDate(0) = 0
                                        tgClfCT(ilClfIndex).ClfRec.iStartDate(1) = 0
                                        tgClfCT(ilClfIndex).iFirstCff = ilCffIndex
                                        ReDim Preserve tgClfCT(0 To UBound(tgClfCT) + 1) As CLFLIST
                                        tgClfCT(UBound(tgClfCT)).iFirstCff = -1
                                        tgClfCT(UBound(tgClfCT)).iStatus = -1
                                        ilFirstCff = ilCffIndex
                                    Else
                                        tgCffCT(ilPrevCff).iNextCff = ilCffIndex
                                    End If
                                    ilPrevCff = ilCffIndex
                                    ReDim Preserve tgCffCT(0 To UBound(tgCffCT) + 1) As CFFLIST
                                    tgCffCT(UBound(tgCffCT)).iStatus = -1 'Not Used
                                    tgCffCT(UBound(tgCffCT)).lRecPos = 0
                                    tgCffCT(UBound(tgCffCT)).iNextCff = -1
                                    tgCffCT(ilCffIndex).iStatus = 0   'New to not used
                                    tgCffCT(ilCffIndex).CffRec.lChfCode = tgChfCT.lCode
                                    tgCffCT(ilCffIndex).CffRec.iClfLine = tmCClf(ilClf).ClfRec.iLine
                                    tgCffCT(ilCffIndex).CffRec.iCntRevNo = tmCClf(ilClf).ClfRec.iCntRevNo
                                    tgCffCT(ilCffIndex).CffRec.iPropVer = tmCClf(ilClf).ClfRec.iPropVer
                                    If llDate = llStartDate Then
                                        slStartDate = Format$(llDate, "m/d/yy")
                                    Else
                                        slStartDate = Format$(llDate, "m/d/yy")
                                        slStartDate = gObtainPrevMonday(slStartDate)
                                    End If
                                    If tgClfCT(ilClfIndex).ClfRec.iStartDate(0) = 0 And tgClfCT(ilClfIndex).ClfRec.iStartDate(1) = 0 Then
                                        gPackDate slStartDate, tgClfCT(ilClfIndex).ClfRec.iStartDate(0), tgClfCT(ilClfIndex).ClfRec.iStartDate(1)
                                    End If
                                    slEndDate = Format$(llDate, "m/d/yy")
                                    slEndDate = gObtainNextSunday(slEndDate)
                                    If gDateValue(slEndDate) > llEndDate Then
                                        slEndDate = Format$(llEndDate, "m/d/yy")
                                    End If
                                    gPackDate slEndDate, tgClfCT(ilClfIndex).ClfRec.iEndDate(0), tgClfCT(ilClfIndex).ClfRec.iEndDate(1)
                                    gPackDate slStartDate, tgCffCT(ilCffIndex).CffRec.iStartDate(0), tgCffCT(ilCffIndex).CffRec.iStartDate(1)
                                    gPackDate slEndDate, tgCffCT(ilCffIndex).CffRec.iEndDate(0), tgCffCT(ilCffIndex).CffRec.iEndDate(1)
                                    tgCffCT(ilCffIndex).lStartDate = gDateValue(slStartDate)
                                    tgCffCT(ilCffIndex).lEndDate = gDateValue(slEndDate)
                                    If ilAddWk = 1 Then
                                        If tmCCff(ilCffFound).CffRec.sDyWk = tmPCff(ilDiffCffFound).CffRec.sDyWk Then
                                            If tmCCff(ilCffFound).CffRec.sDyWk = "D" Then
                                                tgCffCT(ilCffIndex).CffRec.sDyWk = "D"
                                                For ilDay = 0 To 6 Step 1
                                                    tgCffCT(ilCffIndex).CffRec.iDay(ilDay) = tmCCff(ilCffFound).CffRec.iDay(ilDay) - tmPCff(ilDiffCffFound).CffRec.iDay(ilDay)
                                                Next ilDay
                                            Else
                                                tgCffCT(ilCffIndex).CffRec.sDyWk = "W"
                                                tgCffCT(ilCffIndex).CffRec.iSpotsWk = tmCCff(ilCffFound).CffRec.iSpotsWk - tmPCff(ilDiffCffFound).CffRec.iSpotsWk
                                                For ilDay = 0 To 6 Step 1
                                                    tgCffCT(ilCffIndex).CffRec.iDay(ilDay) = tmCCff(ilCffFound).CffRec.iDay(ilDay)
                                                Next ilDay
                                            End If
                                        Else
                                            If tmCCff(ilCffFound).CffRec.sDyWk = "D" Then
                                                'Convert to weekly as only showing difference in spot count
                                                tgCffCT(ilCffIndex).CffRec.sDyWk = "W"
                                                tgCffCT(ilCffIndex).CffRec.iSpotsWk = ilSpots - ilDiffSpots
                                                For ilDay = 0 To 6 Step 1
                                                    If tmCCff(ilCffFound).CffRec.iDay(ilDay) > 0 Then
                                                        tgCffCT(ilCffIndex).CffRec.iDay(ilDay) = 1
                                                    Else
                                                        tgCffCT(ilCffIndex).CffRec.iDay(ilDay) = 0
                                                    End If
                                                Next ilDay
                                            Else
                                                tgCffCT(ilCffIndex).CffRec.sDyWk = "W"
                                                tgCffCT(ilCffIndex).CffRec.iSpotsWk = ilSpots - ilDiffSpots
                                                For ilDay = 0 To 6 Step 1
                                                    tgCffCT(ilCffIndex).CffRec.iDay(ilDay) = tmCCff(ilCffFound).CffRec.iDay(ilDay)
                                                Next ilDay
                                            End If
                                        End If
                                    ElseIf ilAddWk = 2 Then
                                        If tmCCff(ilCffFound).CffRec.sDyWk = "D" Then
                                            tgCffCT(ilCffIndex).CffRec.sDyWk = "D"
                                            For ilDay = 0 To 6 Step 1
                                                tgCffCT(ilCffIndex).CffRec.iDay(ilDay) = tmCCff(ilCffFound).CffRec.iDay(ilDay)
                                            Next ilDay
                                        Else
                                            tgCffCT(ilCffIndex).CffRec.sDyWk = "W"
                                            tgCffCT(ilCffIndex).CffRec.iSpotsWk = tmCCff(ilCffFound).CffRec.iSpotsWk
                                            For ilDay = 0 To 6 Step 1
                                                tgCffCT(ilCffIndex).CffRec.iDay(ilDay) = tmCCff(ilCffFound).CffRec.iDay(ilDay)
                                            Next ilDay
                                        End If
                                    ElseIf ilAddWk = 3 Then
                                        If tmPCff(ilDiffCffFound).CffRec.sDyWk = "D" Then
                                            tgCffCT(ilCffIndex).CffRec.sDyWk = "D"
                                            For ilDay = 0 To 6 Step 1
                                                tgCffCT(ilCffIndex).CffRec.iDay(ilDay) = -tmPCff(ilDiffCffFound).CffRec.iDay(ilDay)
                                            Next ilDay
                                        Else
                                            tgCffCT(ilCffIndex).CffRec.sDyWk = "W"
                                            tgCffCT(ilCffIndex).CffRec.iSpotsWk = -tmPCff(ilDiffCffFound).CffRec.iSpotsWk
                                            For ilDay = 0 To 6 Step 1
                                                tgCffCT(ilCffIndex).CffRec.iDay(ilDay) = tmPCff(ilDiffCffFound).CffRec.iDay(ilDay)
                                            Next ilDay
                                        End If
                                    End If
                                    tgCffCT(ilCffIndex).CffRec.sDelete = "N"
                                    
                                    If bmUseAcq Then            '7-10-15 implement diff with acq costs
                                        If ilAddWk = 1 Then
                                            If tmCCff(ilCffFound).CffRec.sPriceType <> tmPCff(ilDiffCffFound).CffRec.sPriceType Then
                                                If tmCCff(ilCffFound).CffRec.sPriceType = "T" Then
                                                    tgCffCT(ilCffIndex).CffRec.sPriceType = tmCCff(ilCffFound).CffRec.sPriceType
                                                    tgCffCT(ilCffIndex).CffRec.lActPrice = tmCClf(ilClf).ClfRec.lAcquisitionCost  'tmCCff(ilCffFound).CffRec.lActPrice
                                                ElseIf tmPCff(ilDiffCffFound).CffRec.sPriceType = "T" Then
                                                    tgCffCT(ilCffIndex).CffRec.sPriceType = tmPCff(ilDiffCffFound).CffRec.sPriceType
                                                    tgCffCT(ilCffIndex).CffRec.lActPrice = -tmPclf(ilDiffClf).ClfRec.lAcquisitionCost
                                                End If
                                            Else
                                                tgCffCT(ilCffIndex).CffRec.sPriceType = tmCCff(ilCffFound).CffRec.sPriceType
                                                If ilSpotsChgd Then
                                                    tgCffCT(ilCffIndex).CffRec.lActPrice = tmCClf(ilClf).ClfRec.lAcquisitionCost    'tmCCff(ilCffFound).CffRec.lActPrice
                                                Else
                                                    tgCffCT(ilCffIndex).CffRec.lActPrice = tmCClf(ilClf).ClfRec.lAcquisitionCost - tmPclf(ilDiffClf).ClfRec.lAcquisitionCost 'tmCCff(ilCffFound).CffRec.lActPrice - tmPCff(ilDiffCffFound).CffRec.lActPrice
                                                End If
                                            End If
                                        ElseIf ilAddWk = 2 Then                 'adding a week in current
                                                tgCffCT(ilCffIndex).CffRec.lActPrice = tmCClf(ilClf).ClfRec.lAcquisitionCost    'tmCCff(ilCffFound).CffRec.lActPrice
                                                tgCffCT(ilCffIndex).CffRec.sPriceType = tmCCff(ilCffFound).CffRec.sPriceType
                                        ElseIf ilAddWk = 3 Then             'removing a week , show decrease in $
                                                tgCffCT(ilCffIndex).CffRec.lActPrice = tmPclf(ilDiffClf).ClfRec.lAcquisitionCost    'tmPCff(ilDiffCffFound).CffRec.lActPrice
                                                tgCffCT(ilCffIndex).CffRec.sPriceType = tmPCff(ilDiffCffFound).CffRec.sPriceType
    
                                        End If
                                    Else
                                        If ilAddWk = 1 Then
                                            If tmCCff(ilCffFound).CffRec.sPriceType <> tmPCff(ilDiffCffFound).CffRec.sPriceType Then
                                                If tmCCff(ilCffFound).CffRec.sPriceType = "T" Then
                                                    tgCffCT(ilCffIndex).CffRec.sPriceType = tmCCff(ilCffFound).CffRec.sPriceType
                                                    tgCffCT(ilCffIndex).CffRec.lActPrice = tmCCff(ilCffFound).CffRec.lActPrice
                                                ElseIf tmPCff(ilDiffCffFound).CffRec.sPriceType = "T" Then
                                                    tgCffCT(ilCffIndex).CffRec.sPriceType = tmPCff(ilDiffCffFound).CffRec.sPriceType
                                                    tgCffCT(ilCffIndex).CffRec.lActPrice = -tmPCff(ilDiffCffFound).CffRec.lActPrice
                                                End If
                                            Else
                                                tgCffCT(ilCffIndex).CffRec.sPriceType = tmCCff(ilCffFound).CffRec.sPriceType
                                                If ilSpotsChgd Then
                                                    tgCffCT(ilCffIndex).CffRec.lActPrice = tmCCff(ilCffFound).CffRec.lActPrice
                                                Else
                                                    tgCffCT(ilCffIndex).CffRec.lActPrice = tmCCff(ilCffFound).CffRec.lActPrice - tmPCff(ilDiffCffFound).CffRec.lActPrice
                                                End If
                                            End If
                                        ElseIf ilAddWk = 2 Then                 'adding a week in current
                                                tgCffCT(ilCffIndex).CffRec.lActPrice = tmCCff(ilCffFound).CffRec.lActPrice
                                                tgCffCT(ilCffIndex).CffRec.sPriceType = tmCCff(ilCffFound).CffRec.sPriceType
                                        ElseIf ilAddWk = 3 Then             'removing a week , show decrease in $
                                                tgCffCT(ilCffIndex).CffRec.lActPrice = tmPCff(ilDiffCffFound).CffRec.lActPrice
                                                tgCffCT(ilCffIndex).CffRec.sPriceType = tmPCff(ilDiffCffFound).CffRec.sPriceType
    
                                        End If
                                    End If

                                End If              'iladdwk > 0
                            End If              'if ilpass = 2
                        Next llDate             '
                        If (ilPass = 1 And ilSpotsChgd And ilPriceChgd) Or ((ilPass = 1) And (Not ilSpotsChgd) And (ilPriceChgd)) Then
                            Exit For
                        End If
                        'Exit For                'llDate = llStartDate To llEndDate Step 7
                    End If                      'llenddate >= llstartdate
                Next ilPass                 'ilpass = 1 to 2
                Exit For
            End If                          'tmCClf(ilClf).ClfRec.iLine = tmPClf(ilDiffClf).ClfRec.iLine
        Next ilDiffClf                      'ilDiffClf = LBound(tmPClf) To UBound(tmPClf)
    Next ilClf                              'ilClf = LBound(tmCClf) To UBound(tmCClf

    'Find a current line that  has been added (not in previous)
    For ilClf = LBound(tmCClf) To UBound(tmCClf) - 1 Step 1
        'Find matching line
        ilFirstCff = -1
        ilFound = False
        If tmCClf(ilClf).ClfRec.iLine > 0 Then          'both rate and spot count not changed
            For ilDiffClf = LBound(tmPclf) To UBound(tmPclf) - 1 Step 1
                If tmCClf(ilClf).ClfRec.iLine = tmPclf(ilDiffClf).ClfRec.iLine Then
                    ilFound = True
                    Exit For
                End If
            Next ilDiffClf
        Else                                'both rate & spot count changed, do a addition and removal for differences
            tmCClf(ilClf).ClfRec.iLine = -tmCClf(ilClf).ClfRec.iLine
        End If
        If Not ilFound Then
            'Add line
            ilClfIndex = UBound(tgClfCT)
            tgClfCT(ilClfIndex) = tmCClf(ilClf)
            ReDim Preserve tgClfCT(0 To UBound(tgClfCT) + 1) As CLFLIST
            tgClfCT(ilClfIndex).iFirstCff = -1
            tgClfCT(UBound(tgClfCT)).iFirstCff = -1
            tgClfCT(UBound(tgClfCT)).iStatus = -1
            ilCff = tmCClf(ilClf).iFirstCff
            Do While ilCff <> -1
                tgCffCT(UBound(tgCffCT)) = tmCCff(ilCff)
                If tgClfCT(ilClfIndex).iFirstCff = -1 Then
                    tgClfCT(ilClfIndex).iFirstCff = UBound(tgCffCT)
                Else
                    tgCffCT(UBound(tgCffCT) - 1).iNextCff = UBound(tgCffCT)
                End If
                tgCffCT(UBound(tgCffCT)).iNextCff = -1
                tgCffCT(UBound(tgCffCT)).lRecPos = 0
                tgCffCT(UBound(tgCffCT)).iStatus = 0
                ReDim Preserve tgCffCT(0 To UBound(tgCffCT) + 1) As CFFLIST
                tgCffCT(UBound(tgCffCT)).iStatus = -1 'Not Used
                tgCffCT(UBound(tgCffCT)).iNextCff = -1
                tgCffCT(UBound(tgCffCT)).lRecPos = 0
                ilCff = tmCCff(ilCff).iNextCff
            Loop
        End If
    Next ilClf
    'Find a line that has been removed (deleted) in the current version (found in previous
    'but not in current)
    For ilDiffClf = LBound(tmPclf) To UBound(tmPclf) - 1 Step 1
        'Find matching line
        ilFirstCff = -1
        ilFound = False
        If tmPclf(ilDiffClf).ClfRec.iLine > 0 Then          'both spot count and rate not changed
            For ilClf = LBound(tmCClf) To UBound(tmCClf) - 1 Step 1
                If tmCClf(ilClf).ClfRec.iLine = tmPclf(ilDiffClf).ClfRec.iLine Then
                    ilFound = True
                    Exit For
                End If
            Next ilClf
        Else                            'both spot count & rate changed, do removal
            tmPclf(ilDiffClf).ClfRec.iLine = -tmPclf(ilDiffClf).ClfRec.iLine
        End If
        If Not ilFound Then
            ilClfIndex = UBound(tgClfCT)
            tgClfCT(ilClfIndex) = tmPclf(ilDiffClf)
            ReDim Preserve tgClfCT(0 To UBound(tgClfCT) + 1) As CLFLIST
            tgClfCT(ilClfIndex).iFirstCff = -1
            tgClfCT(UBound(tgClfCT)).iFirstCff = -1
            tgClfCT(UBound(tgClfCT)).iStatus = -1
            ilDiffCff = tmPclf(ilDiffClf).iFirstCff
            Do While ilDiffCff <> -1
                tgCffCT(UBound(tgCffCT)) = tmPCff(ilDiffCff)
                If tgClfCT(ilClfIndex).iFirstCff = -1 Then
                    tgClfCT(ilClfIndex).iFirstCff = UBound(tgCffCT)
                Else
                    tgCffCT(UBound(tgCffCT) - 1).iNextCff = UBound(tgCffCT)
                End If
                tgCffCT(UBound(tgCffCT)).iNextCff = -1
                tgCffCT(UBound(tgCffCT)).lRecPos = 0
                tgCffCT(UBound(tgCffCT)).iStatus = 0
                If tmPCff(ilDiffCff).CffRec.sDyWk = "D" Then    '4-21-15 wrong index, chg fom ildiffclf to ildiffcff
                    tgCffCT(UBound(tgCffCT)).CffRec.sDyWk = "D"
                    For ilDay = 0 To 6 Step 1
                        tgCffCT(UBound(tgCffCT)).CffRec.iDay(ilDay) = -tmPCff(ilDiffCff).CffRec.iDay(ilDay)
                    Next ilDay
                Else
                    tgCffCT(UBound(tgCffCT)).CffRec.sDyWk = "W"
                    tgCffCT(UBound(tgCffCT)).CffRec.iSpotsWk = -tmPCff(ilDiffCff).CffRec.iSpotsWk
                End If
                If bmUseAcq Then        '7-10-15 implement differences with acq costs
                    tgCffCT(UBound(tgCffCT)).CffRec.lActPrice = tmPclf(ilDiffClf).ClfRec.lAcquisitionCost
                Else
                    tgCffCT(UBound(tgCffCT)).CffRec.lActPrice = tmPCff(ilDiffCff).CffRec.lActPrice
                End If
                ReDim Preserve tgCffCT(0 To UBound(tgCffCT) + 1) As CFFLIST
                tgCffCT(UBound(tgCffCT)).iStatus = -1 'Not Used
                tgCffCT(UBound(tgCffCT)).iNextCff = -1
                tgCffCT(UBound(tgCffCT)).lRecPos = 0
                ilDiffCff = tmPCff(ilDiffCff).iNextCff
            Loop
        End If
    Next ilDiffClf

    'Determine earliest and latest dates of previous and current to put in diff header
    gUnpackDateLong tgChfCT.iStartDate(0), tgChfCT.iStartDate(1), llStartDate
    gUnpackDateLong tgChfCT.iEndDate(0), tgChfCT.iEndDate(1), llEndDate
    gUnpackDateLong tmPChf.iStartDate(0), tmPChf.iStartDate(1), llLnStartDate
    gUnpackDateLong tmPChf.iEndDate(0), tmPChf.iEndDate(1), llLnEndDate
    If llLnStartDate < llStartDate Then
        gPackDateLong llLnStartDate, tgChfCT.iStartDate(0), tgChfCT.iStartDate(1)
    End If
    If llLnEndDate > llEndDate Then
        gPackDateLong llLnEndDate, tgChfCT.iEndDate(0), tgChfCT.iEndDate(1)
    End If
    Erase tmPclf, tmPCff
End Sub

'**********************************************************************
'
'          Read a contract and filter on:
'           User input Entered Start/End dates
'           User input Active Start/End dates
'           Printables
'           GetAll = true = obtain history plus current, false = only current
'           Created 5/30/96    d.hosaka
'
'***********************************************************************
Function mGetAContractCt(hmCHF As Integer, hmClf As Integer, hmCff As Integer, llContrCode As Long, llEntSDate As Long, llEntEDate As Long, llActSDate As Long, llActEDate As Long, ilGetAll As Integer) As Integer
    Dim ilFound As Integer
    Dim slDate As String
    Dim llSDate As Long
    Dim llEDate As Long
    Dim ilRet As Integer
    
    ilFound = False
    If (ilGetAll) Then                'differences only, get history of contract
        ilRet = gObtainCntr(hmCHF, hmClf, hmCff, llContrCode, True, tgChfCT, tgClfCT(), tgCffCT())
    Else                                            'current only
        ilRet = gObtainCntr(hmCHF, hmClf, hmCff, llContrCode, False, tgChfCT, tgClfCT(), tgCffCT())
    End If

    gUnpackDate tgChfCT.iStartDate(0), tgChfCT.iStartDate(1), slDate
    If slDate <> "" Then
        llSDate = gDateValue(slDate)
        gUnpackDate tgChfCT.iEndDate(0), tgChfCT.iEndDate(1), slDate
        llEDate = gDateValue(slDate)
        If (llEDate >= llActSDate) And (llSDate <= llActEDate) Then
            ilFound = True
        End If
    Else
        If (llActSDate <= gDateValue("1/5/1970")) Or (llActEDate >= gDateValue("12/29/2069")) Then
            ilFound = True
        End If
    End If
    If ilFound Then
        ilFound = False
        '2-6-07 determine entered date selectivity by ohddate, not proposal date
        gUnpackDate tgChfCT.iOHDDate(0), tgChfCT.iOHDDate(1), slDate
        If slDate <> "" Then
            llSDate = gDateValue(slDate)
            If (llSDate >= llEntSDate) And (llSDate <= llEntEDate) Then
                ilFound = True
            End If
        Else
            If (llEntSDate <= gDateValue("1/5/1970")) Or (llEntEDate >= gDateValue("12/29/2069")) Then
                ilFound = True
            End If
        End If
     End If
    If (RptSelCt!ckcSelC3(0).Value = vbChecked And tgChfCT.sPrint = "P") Then   'check if only printables requested
        ilFound = False                                   'cntr already printed
    End If
    If llContrCode = 0 Then                                     'see if there were any contracts selected and retrieved
        ilFound = False
    End If
    mGetAContractCt = ilFound
End Function

'*********************************************************************
'*                                                                   *
'*      Procedure Name:mGetAvailCounts                               *
'*                                                                   *
'*             Created:10/09/93      By:D. LeVine                    *
'*            Modified:              By:                             *
'*                                                                   *
'*            Comments:Obtain the Avail counts                       *
'*                                                                   *
'*      4/27/98:  changed to use the sort code from the              *
'*          RIF file rather than the RDF file.                       *
'*      1/27/99: change matching units to include 10s                *
'*               (combine with 30s)                                  *
'*      6-4-04 When not using Other missed spots category,           *
'*              place the missed spots into dayparts                 *
'*              that fall within time & day, but also                *
'*              match of the avails types that are allowed           *
'*      7-20-04 Option to include/exclude local or network spots & avails
'*         2-7-05 Units based vehicles:  each avail must be defined as
'                 1 unit/any seconds for units based to work
'*********************************************************************
Sub mGetAvailCounts(ilVefCode As Integer, ilVpfIndex As Integer, ilFirstQ As Integer, llStartDate As Long, llEndDate As Long, ilCountsBy As Integer, ilCostType As Integer, slUserRequest As String)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  llActPrice                                                                            *
    '******************************************************************************************
    '   Where:
    '       ilVefCode = vehicle code to process
    '       ilVpfIndex - associated index to vehicles vpf
    '       ilFirstQ - week index into date array where to start processing
    '       llStartDate - first date to process
    '       llEndDate - last date to process
    '       ilCountsBy - 0 = units (1 column reprt), 1 = 30/60   (2 column)
    '       ilCosttype - bit map of spot types to include/exclude
    '
    '   smBucketType(I): A=Avail; S=Sold; I=Inventory  , P = Percent sellout
    '   lmSAvailsDates(I)- Array of bucket start dates
    '   lmEAvailsDates(I)- Array of bucket end dates
    '   imHold(I)- True = include hold contracts
    '   imOrder(I)- True= include complete order contracts
    '   imMissed(I)- True=Include missed
    '   imXtra(I)- True=Include Xtra bonus spots
    '   imTrade(I)- True = include trade contracts
    '   imNC(I)- True = include NC spots
    '   imReserv(I) - True = include Reservations spots
    '   imRemnant(I)- True=Include Remnant
    '   imStandard(I)- true = include std contracts
    '   imDR(I)- True=Include Direct Response
    '   imPI(I)- True=Include per Inquiry
    '   imPSA(I)- True=Include PSA
    '   imPromo(I)- True=Include Promo
    '   ilUnitType(I) = 0 - 10 only, 1=30 only, 2 = 30/60
    '
    '   Note: Remnants; Direct Response; per Inquiry; PSA and Promos are not
    '         saved with a miss status
    '         For scheduled spots the rank is used to determine if it is one
    '         of the above (Direct reponse=1010; Remnant=1020; per Inquiry= 1030;
    '         PSA=1060; Promo=1050.
    Dim slType As String
    Dim ilType As Integer
    Dim ilDate0 As Integer
    Dim ilDate1 As Integer
    Dim slDate As String
    Dim llDate As Long
    Dim ilEvt As Integer
    Dim ilRet As Integer
    Dim ilSpot As Integer
    Dim llTime As Long
    Dim ilRdf As Integer
    Dim llRif As Long        '6-4-04
    Dim illoop As Integer
    Dim ilFound As Integer
    Dim llStartTime As Long
    Dim llEndTime As Long
    Dim ilRec As Integer
    Dim ilRecIndex As Integer
    Dim ilLen As Integer
    Dim ilUnits As Integer
    Dim ilNo30 As Integer
    Dim ilNo60 As Integer
    Dim ilDay As Integer
    Dim ilSaveDay As Integer
    Dim slDays As String
    Dim ilLtfCode As Integer
    Dim ilAvailOk As Integer
    Dim ilPass As Integer
    Dim ilStartPass As Integer
    Dim ilEndPass As Integer
    Dim ilDayIndex As Integer
    Dim ilLoopIndex As Integer
    Dim ilBucketIndex As Integer
    Dim ilBucketIndexMinusOne As Integer
    Dim ilSpotOK As Integer
    Dim llLoopDate As Long
    Dim ilWeekDay As Integer
    Dim llLatestDate As Long
    Dim ilIndex As Integer
    Dim slPrice As String
    Dim ilAdjAdd As Integer
    Dim ilAdjSub As Integer
    Dim ilOrphanMissedLoop As Integer
    Dim ilOrphanFound As Integer
    Dim ilOrphanMax As Integer             'only 1 pass if not using orpha category, otherwise 2 passes
    ReDim ilSAvailsDates(0 To 1) As Integer
    ReDim ilEvtType(0 To 14) As Integer
    ReDim ilRdfCodes(0 To 1) As Integer
    Dim ilLockedFlag As Integer         '3-13-03
    Dim tlOrderedRDF As RDF             '6-4-04 Ordered dp for missed spot
    Dim slChfType As String * 1         'contract header type
    Dim slChfStatus As String * 1       'contract header type
    Dim ilSpotTypeOK As Integer         '5-16-05
    Dim ilVefIndex As Integer
    Dim ilGsfFound As Integer
    Dim ilGameNo As Integer
    Dim ilPctTrade As Integer           '4-12-18

    ilOrphanMax = 1             'only 1 pass if not using orphan category.  Placed the missed spots
                                'not within any matching DP into first DP it finds
    If imOrphan Then
        ilOrphanMax = 2
    End If
    slDate = Format$(lmSAvailsDates(1), "m/d/yy")
    gPackDate slDate, ilSAvailsDates(0), ilSAvailsDates(1)
    ilType = 0
    If smBucketType = "A" Then
        ilStartPass = 1
        ilEndPass = 2
    ElseIf (smBucketType = "S") Or (smBucketType = "P") Then
        ilStartPass = 2
        ilEndPass = 2
    Else
        ilStartPass = 1
        ilEndPass = 1
    End If
    llLatestDate = gGetLatestLCFDate(hmLcf, "C", ilVefCode)
    'set the type of events to get fro the day (only Contract avails)
    For illoop = LBound(ilEvtType) To UBound(ilEvtType) Step 1
        ilEvtType(illoop) = False
    Next illoop
    ilEvtType(2) = True
    If tgVpf(ilVpfIndex).sSSellOut = "B" Then           'if units & seconds - add 2 to 30 sec unit and take away 1 fro 60
        ilAdjAdd = 2
        ilAdjSub = 1
    ElseIf tgVpf(ilVpfIndex).sSSellOut = "U" Then       'if units only - take 1 away from 60 count and add 1 to 30 count
        ilAdjAdd = 1
        ilAdjSub = 1
    End If
    ilVefIndex = gBinarySearchVef(ilVefCode)

    For llLoopDate = llStartDate To llEndDate Step 1
        slDate = Format$(llLoopDate, "m/d/yy")
        gPackDate slDate, ilDate0, ilDate1
        imSsfRecLen = Len(tmSsf) 'Max size of variable length record
        If tgMVef(ilVefIndex).sType <> "G" Then
            tmSsfSrchKey.iType = ilType
            tmSsfSrchKey.iVefCode = ilVefCode
            tmSsfSrchKey.iDate(0) = ilDate0
            tmSsfSrchKey.iDate(1) = ilDate1
            tmSsfSrchKey.iStartTime(0) = 0
            tmSsfSrchKey.iStartTime(1) = 0
            ilRet = gSSFGetGreaterOrEqual(hmSsf, tmSsf, imSsfRecLen, tmSsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)
        Else
            '5-25-06 Change to use SSFKey2.  When there is a game, not all game SSF records are retrieved
            tmSsfSrchKey2.iVefCode = ilVefCode
            tmSsfSrchKey2.iDate(0) = ilDate0
            tmSsfSrchKey2.iDate(1) = ilDate1
            ilRet = gSSFGetGreaterOrEqualKey2(hmSsf, tmSsf, imSsfRecLen, tmSsfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)
            ilType = tmSsf.iType
        End If
        '   if games, tmSsf.iType will be the game #.  this report is not driven by game; but by week
        If (ilRet <> BTRV_ERR_NONE) Or (tmSsf.iVefCode <> ilVefCode) Or ((tmSsf.iDate(0) <> ilDate0) And (tmSsf.iDate(1) = ilDate1)) Or (ilType <> tmSsf.iType And tgMVef(ilVefIndex).sType <> "G") Then
            If (llLoopDate > llLatestDate) Then
                ReDim tlLLC(0 To 0) As LLC  'Merged library names
                If tgMVef(ilVefIndex).sType <> "G" Then
                    ilWeekDay = gWeekDayStr(slDate) + 1 '1=Monday TFN; 2=Tues,...7=Sunday TFN
                    If ilWeekDay = 1 Then
                         ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNMO", "12M", "12M", ilEvtType(), tlLLC())
                    ElseIf ilWeekDay = 2 Then
                         ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNTU", "12M", "12M", ilEvtType(), tlLLC())
                    ElseIf ilWeekDay = 3 Then
                         ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNWE", "12M", "12M", ilEvtType(), tlLLC())
                    ElseIf ilWeekDay = 4 Then
                         ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNTH", "12M", "12M", ilEvtType(), tlLLC())
                    ElseIf ilWeekDay = 5 Then
                         ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNFR", "12M", "12M", ilEvtType(), tlLLC())
                    ElseIf ilWeekDay = 6 Then
                         ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNSA", "12M", "12M", ilEvtType(), tlLLC())
                    ElseIf ilWeekDay = 7 Then
                         ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNSU", "12M", "12M", ilEvtType(), tlLLC())
                    End If
                End If
                tmSsf.iType = ilType
                tmSsf.iVefCode = ilVefCode
                tmSsf.iDate(0) = ilDate0
                tmSsf.iDate(1) = ilDate1
                gPackTime tlLLC(0).sStartTime, tmSsf.iStartTime(0), tmSsf.iStartTime(1)
                tmSsf.iCount = 0
                
                For ilIndex = LBound(tlLLC) To UBound(tlLLC) - 1 Step 1
                    tmAvail.iRecType = Val(tlLLC(ilIndex).sType)
                    gPackTime tlLLC(ilIndex).sStartTime, tmAvail.iTime(0), tmAvail.iTime(1)
                    tmAvail.iLtfCode = tlLLC(ilIndex).iLtfCode
                    tmAvail.iAvInfo = tlLLC(ilIndex).iAvailInfo Or tlLLC(ilIndex).iUnits
                    tmAvail.iLen = CInt(gLengthToCurrency(tlLLC(ilIndex).sLength))
                    tmAvail.ianfCode = Val(tlLLC(ilIndex).sName)
                    tmAvail.iNoSpotsThis = 0
                    tmAvail.iOrigUnit = 0
                    tmAvail.iOrigLen = 0
                    tmSsf.iCount = tmSsf.iCount + 1
                    tmSsf.tPas(ADJSSFPASBZ + tmSsf.iCount) = tmAvail
                Next ilIndex
                ilRet = BTRV_ERR_NONE
            End If
        End If

        'Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.sType = slType) And (tmSsf.iVefCode = ilVefCode And (tmSsf.iDate(0) = ilDate0) And (tmSsf.iDate(1) = ilDate1))
        Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.iVefCode = ilVefCode And (tmSsf.iDate(0) = ilDate0) And (tmSsf.iDate(1) = ilDate1))
            gUnpackDateLong tmSsf.iDate(0), tmSsf.iDate(1), llDate
            ilBucketIndex = -1

            For illoop = 1 To 13 Step 1
                If (llDate >= lmSAvailsDates(illoop)) And (llDate <= lmEAvailsDates(illoop)) Then
                    ilBucketIndex = illoop
                    Exit For
                End If
            Next illoop
            
            ilEvt = 1                               'initialize events in vehicle
            If tmSsf.iType > 0 Then                 '7-18-13 its a game; otherwise ignore test for cancelled or postponed event
                ilGameNo = tmSsf.iType                  'game number, if applicable
                '6-14-13 bypass cancelled or postponed games
                ilGsfFound = False
                tmGsfSrchKey3.iGameNo = ilGameNo
                tmGsfSrchKey3.iVefCode = ilVefCode
                ilRet = btrGetEqual(hmGsf, tmGsf, imGsfRecLen, tmGsfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)
                
                Do While (ilRet = BTRV_ERR_NONE) And (tmGsf.iVefCode = ilVefCode) And (tmGsf.iGameNo = tmSsf.iType)
                    If (tmGsf.iAirDate(0) = tmSsf.iDate(0)) And (tmGsf.iAirDate(1) = tmSsf.iDate(1)) Then
                        ilGsfFound = True
                        Exit Do
                    End If
                    ilRet = btrGetNext(hmGsf, tmGsf, imGsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
                Loop
                
                'If ilRet <> BTRV_ERR_NONE Then          'no game applicable, ignore this entry
                If Not ilGsfFound Then          'no game applicable, ignore this entry
                    ilEvt = tmSsf.iCount + 1            'force exit
                Else
                    'determine if postponed or cancelled
                    If (tmGsf.sGameStatus = "C") Or (tmGsf.sGameStatus = "P") Then
                        ilEvt = tmSsf.iCount + 1        'force exit
                    End If
                End If
            End If
            
            If ilBucketIndex > 0 Then
                ilBucketIndexMinusOne = ilBucketIndex - 1
                ilDay = gWeekDayLong(llDate)
                'ilEvt = 1
                Do While ilEvt <= tmSsf.iCount
                   LSet tmProg = tmSsf.tPas(ADJSSFPASBZ + ilEvt)
                    If tmProg.iRecType = 1 Then    'Program (not working for nested prog)
                        ilLtfCode = tmProg.iLtfCode
                    ElseIf (tmProg.iRecType >= 2) And (tmProg.iRecType <= 2) Then 'Contract Avails only
                       LSet tmAvail = tmSsf.tPas(ADJSSFPASBZ + ilEvt)
                        gUnpackTimeLong tmAvail.iTime(0), tmAvail.iTime(1), False, llTime
                        '3-13-03 see if locked avail should be ignored
                        ilLockedFlag = tmAvail.iAvInfo And &H40
                        '3-15-05 Changed design of how locked avails are tested & excluded for the % Sellout option.
                        'Previously, avails and spots totally excluded if locked (and exluded.  meaning No Inventory at all).  Now, if locked and
                        'excluded, always assume the avail is sold-out.  Use the same counts as those that
                        'are added into inventory to be added into the spots sold counts (see where spots are examined.)

                        'If (ilLockedFlag <> &H40) Or ((ilLockedFlag = &H40) And imLocked) Then
                        'if not locked or its locked and excluded on sellout % option, need to process to force the avail to be full
                        If ((ilLockedFlag <> &H40) Or ((ilLockedFlag = &H40) And Not imLocked) And smBucketType = "P") Or (imLocked) Then

                            'Determine which rate card program this is associated with
                            For ilRdf = LBound(tmAvRdf) To UBound(tmAvRdf) - 1 Step 1
                                ilAvailOk = False
                                If (tmAvRdf(ilRdf).iLtfCode(0) <> 0) Or (tmAvRdf(ilRdf).iLtfCode(1) <> 0) Or (tmAvRdf(ilRdf).iLtfCode(2) <> 0) Then
                                    If (ilLtfCode = tmAvRdf(ilRdf).iLtfCode(0)) Or (ilLtfCode = tmAvRdf(ilRdf).iLtfCode(1)) Or (ilLtfCode = tmAvRdf(ilRdf).iLtfCode(1)) Then
                                        ilAvailOk = False    'True- code later
                                    End If
                                Else

                                    For illoop = LBound(tmAvRdf(ilRdf).iStartTime, 2) To UBound(tmAvRdf(ilRdf).iStartTime, 2) Step 1 'Row
                                        If (tmAvRdf(ilRdf).iStartTime(0, illoop) <> 1) Or (tmAvRdf(ilRdf).iStartTime(1, illoop) <> 0) Then
                                            gUnpackTimeLong tmAvRdf(ilRdf).iStartTime(0, illoop), tmAvRdf(ilRdf).iStartTime(1, illoop), False, llStartTime
                                            gUnpackTimeLong tmAvRdf(ilRdf).iEndTime(0, illoop), tmAvRdf(ilRdf).iEndTime(1, illoop), True, llEndTime
                                            'If (llTime >= llStartTime) And (llTime < llEndTime) And (tmAvRdf(ilRdf).sWkDays(ilLoop, ilDay + 1) = "Y") Then
                                            If (llTime >= llStartTime) And (llTime < llEndTime) And (tmAvRdf(ilRdf).sWkDays(illoop, ilDay) = "Y") Then
                                                ilAvailOk = True
                                                ilLoopIndex = illoop
                                                slDays = ""
                                                For ilDayIndex = 1 To 7 Step 1
                                                    If (tmAvRdf(ilRdf).sWkDays(illoop, ilDayIndex - 1) = "Y") Or (tmAvRdf(ilRdf).sWkDays(illoop, ilDayIndex - 1) = "N") Then
                                                        slDays = slDays & tmAvRdf(ilRdf).sWkDays(illoop, ilDayIndex - 1)
                                                    Else
                                                        slDays = slDays & "N"
                                                    End If
                                                Next ilDayIndex
                                                Exit For
                                            End If
                                        End If
                                    Next illoop
                                End If
                                If ilAvailOk Then
                                    If tmAvRdf(ilRdf).sInOut = "I" Then   'Book into
                                        If tmAvail.ianfCode <> tmAvRdf(ilRdf).ianfCode Then
                                            ilAvailOk = False
                                        End If
                                    ElseIf tmAvRdf(ilRdf).sInOut = "O" Then   'Exclude
                                        If tmAvail.ianfCode = tmAvRdf(ilRdf).ianfCode Then
                                            ilAvailOk = False
                                        End If
                                    End If
                                End If

                                If ilAvailOk Then
                                    '7-19-04 the Named avail property must allow local spots to be included
                                    
                                    ilRet = gBinarySearchAnf(tmAvail.ianfCode, tgAvailAnf())
                                    If ilRet <> -1 Then
                                        If Not imLocal And tgAvailAnf(ilRet).sBookLocalFeed = "L" Then      'Local avail requested to be excluded, exclude if avail type = "L"
                                            ilAvailOk = False
                                        End If
                                        If Not imFeed And tgAvailAnf(ilRet).sBookLocalFeed = "F" Then      'Network avail requested to be excluded, exclude if avail type = "F"
                                            ilAvailOk = False
                                        End If
                                    End If

                                End If
                                'allow the avail to be gathered if the field doesnt have a value, indicating an original avail defined as Both
                                'allow the avail to be gathered even if the named avail code isnt found

                                If ilAvailOk Then
                                    'Determine if Avr created
                                    ilFound = False
                                    ilSaveDay = ilDay
                                    If RptSelCt!rbcSelCInclude(0).Value Then              'daypart option, place all values in same record
                                                                                        'to get better availability
                                        ilDay = 0                                       'force all data in same day of week
                                    End If
                                    For ilRec = 0 To UBound(tmAvr) - 1 Step 1
                                        'If (tmAvr(ilRec).iRdfCode = tmAvRdf(ilRdf).iCode) And (tmAvr(ilRec).iFirstBucket = ilFirstQ) And (tmAvr(ilRec).iDay = ilDay) Then
                                        If (ilRdfCodes(ilRec) = tmAvRdf(ilRdf).iCode) And (tmAvr(ilRec).iFirstBucket = ilFirstQ) And (tmAvr(ilRec).iDay = ilDay) Then
                                            ilFound = True
                                            ilRecIndex = ilRec
                                            Exit For
                                        End If
                                    Next ilRec
                                    If Not ilFound Then
                                        ilRecIndex = UBound(tmAvr)
                                        tmAvr(ilRecIndex).iGenDate(0) = igNowDate(0)
                                        tmAvr(ilRecIndex).iGenDate(1) = igNowDate(1)
                                        gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
                                        tmAvr(ilRecIndex).lGenTime = lgNowTime
                                        tmAvr(ilRecIndex).iVefCode = ilVefCode
                                        tmAvr(ilRecIndex).iDay = ilDay
                                        tmAvr(ilRecIndex).iQStartDate(0) = ilSAvailsDates(0)
                                        tmAvr(ilRecIndex).iQStartDate(1) = ilSAvailsDates(1)
                                        tmAvr(ilRecIndex).iFirstBucket = ilFirstQ
                                        tmAvr(ilRecIndex).sBucketType = smBucketType
                                        ilRdfCodes(ilRecIndex) = tmAvRdf(ilRdf).iCode
                                        'if fields are switched so that the sort code goes into rdfsortcode and DP code goes into .irdfcode
                                        'then the avails reports must be fixed in each of the formulas  since its grouping is by .irdcode (not .irdfsortcode)
                                        tmAvr(ilRecIndex).iRdfCode = tmRifSorts(ilRdf).iSort   'DP Sort code  from RIF
                                        tmAvr(ilRecIndex).iRdfSortCode = tmAvRdf(ilRdf).iCode   'DP code to retrieve DP name description
                                        tmAvr(ilRecIndex).sInOut = tmAvRdf(ilRdf).sInOut
                                        tmAvr(ilRecIndex).ianfCode = tmAvRdf(ilRdf).ianfCode
                                        tmAvr(ilRecIndex).iDPStartTime(0) = tmAvRdf(ilRdf).iStartTime(0, ilLoopIndex)
                                        tmAvr(ilRecIndex).iDPStartTime(1) = tmAvRdf(ilRdf).iStartTime(1, ilLoopIndex)
                                        tmAvr(ilRecIndex).iDPEndTime(0) = tmAvRdf(ilRdf).iEndTime(0, ilLoopIndex)
                                        tmAvr(ilRecIndex).iDPEndTime(1) = tmAvRdf(ilRdf).iEndTime(1, ilLoopIndex)
                                        tmAvr(ilRecIndex).sDPDays = slDays
                                        tmAvr(ilRecIndex).sNot30Or60 = "N"
                                        ReDim Preserve tmAvr(0 To ilRecIndex + 1) As AVR
                                        ReDim Preserve ilRdfCodes(0 To ilRecIndex + 1)
                                    End If
                                    ilDay = ilSaveDay
                                    If (smBucketType <> "S") Or RptSelCt!rbcSelC4(1).Value Then   'not sold (min ) or it's the qtrly detail which
                                        'needs to gather inventory
                                        ilLen = tmAvail.iLen
                                        ilUnits = tmAvail.iAvInfo And &H1F
                                        gGatherInventory tmAvr(), ilVpfIndex, smBucketType, ilRecIndex, ilBucketIndex, ilLen, ilUnits, ilNo30, ilNo60, slUserRequest
                                    End If
                                    If smBucketType <> "I" Then                         'avails, sellout, sellout %

                                        If ((ilLockedFlag = &H40) And (Not imLocked)) And smBucketType = "P" Then      '3-15-05 if locked avail and exclude locked on the Percent sellout option, assume the avail is full
                                                                                                'by forcing all spots sold based on the avails inventory
                                                                                                'that was returned from gGatherInventory
                                            tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                            tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                        Else
                                            For ilSpot = 1 To tmAvail.iNoSpotsThis Step 1

                                               LSet tmSpot = tmSsf.tPas(ADJSSFPASBZ + ilEvt + ilSpot)
                                                ilSpotOK = True                             'assume spot is OK to include
                                                'test the spot statuses before reading any contract
                                                'priority may change the ranking and may not pass the matching mask;
                                                'additional testing of the contract header later
                                                If ((tmSpot.iRank And RANKMASK) = REMNANTRANK) And (Not imRemnant) Then
                                                    ilSpotOK = False
                                                End If
                                                If ((tmSpot.iRank And RANKMASK) = PERINQUIRYRANK) And (Not imPI) Then
                                                    ilSpotOK = False
                                                End If
                                                '4-12-18 DR wasnt previously tested
                                                If ((tmSpot.iRank And RANKMASK) = DIRECTRESPONSERANK) And (Not imDR) Then
                                                    ilSpotOK = False
                                                End If
                                        
                                                If ((tmSpot.iRank And RANKMASK) = TRADERANK) And (Not imTrade) Then
                                                    ilSpotOK = False
                                                End If
                                                '3-24-03 change way to test for fill/extra, use SDF
                                                If ((tmSpot.iRank And RANKMASK) = PROMORANK) And (Not imPromo) Then
                                                    ilSpotOK = False
                                                End If
                                                If ((tmSpot.iRank And RANKMASK) = PSARANK) And (Not imPSA) Then
                                                    ilSpotOK = False
                                                End If
                                                '4-12-18 Reservations wasnt previously tested
                                                If ((tmSpot.iRank And RANKMASK) = RESERVATIONRANK) And (Not imReserv) Then
                                                    ilSpotOK = False
                                                End If
                                                If (tmSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                                                    ilSpotOK = False
                                                End If
                                                ilLen = tmSpot.iPosLen And &HFFF
                                                
                                                If ilSpotOK Then                            'continue testing other filters                                    ilLen = tmSpot.iPosLen And &HFFF
                                                    tmSdfSrchKey3.lCode = tmSpot.lSdfCode   'get the spot record
                                                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)
                                                    If ilRet <> BTRV_ERR_NONE Then
                                                        ilSpotOK = False                    'invalid sdf code
                                                    End If

                                                    'Test for Feed Spot
                                                    If ilRet = BTRV_ERR_NONE And tmSdf.lChfCode = 0 And ilSpotOK Then        'feed spot
                                                        'obtain the network information
                                                        tmFSFSrchKey.lCode = tmSdf.lFsfCode
                                                        ilRet = btrGetEqual(hmFsf, tmFsf, imFsfRecLen, tmFSFSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
                                                        If ilRet <> BTRV_ERR_NONE Or Not imFeed Then
                                                            ilSpotOK = False                    'invalid network code
                                                        End If
                                                        slChfType = ""          'contract types dont apply with feed spots
                                                        slChfStatus = ""       'status types dont apply with feed spots
                                                     Else            'Test for contract spots
                                                        If ilRet = BTRV_ERR_NONE And tmSdf.lChfCode > 0 And ilSpotOK Then
                                                            'obtain contract info
                                                            If tmSpot.lSdfCode = tmSdf.lCode And ilRet = BTRV_ERR_NONE And ilSpotOK = True Then
                                                                If tmSdf.lChfCode <> tmChf.lCode Then               'if already in mem, don't reread
                                                                    tmChfSrchKey.lCode = tmSdf.lChfCode
                                                                    ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
                                                                    If ilRet <> BTRV_ERR_NONE Then
                                                                        ilSpotOK = False
                                                                    End If
                                                                    slChfType = tmChf.sType
                                                                    slChfStatus = tmChf.sStatus
                                                                End If

                                                                '7-20-04
                                                                ilLen = tmSdf.iLen
                                                                If tmChf.sStatus = "H" Then
                                                                    If Not imHold Then
                                                                        ilSpotOK = False
                                                                    End If
                                                                ElseIf tmChf.sStatus = "O" Then
                                                                    If Not imOrder Then
                                                                        ilSpotOK = False
                                                                    End If
                                                                Else
                                                                    ilSpotOK = False
                                                                End If
                                                
                                                                '3-16-10 Standard contract type is designated by C, not S as was coded
                                                                If tmChf.sType = "C" And Not imStandard Then      'include Standard types?
                                                                    ilSpotOK = False
                                                                End If
                                                                '4-12-18 all all contract type selection; pty may have changed the ranking if last week of order
                                                                If tmChf.sType = "V" And Not imReserv Then      'include reservations ?
                                                                    ilSpotOK = False
                                                                End If
                                                                If tmChf.sType = "R" And Not imDR Then      'include DR?
                                                                    ilSpotOK = False
                                                                End If
                                                                
                                                                If (tmChf.sType = "T") And (Not imRemnant) Then
                                                                    ilSpotOK = False
                                                                End If
                                                                If (tmChf.sType = "Q") And (Not imPI) Then
                                                                    ilSpotOK = False
                                                                End If
                                                                If (tmChf.sType = "M") And (Not imPromo) Then
                                                                    ilSpotOK = False
                                                                End If
                                                                If (tmChf.sType = "S") And (Not imPSA) Then
                                                                    ilSpotOK = False
                                                                End If
                                                                If (tmChf.iPctTrade = 100) And (Not imTrade) Then       'partial trade allowed
                                                                    ilSpotOK = False
                                                                End If

                                                                tmClfSrchKey.lChfCode = tmSdf.lChfCode
                                                                tmClfSrchKey.iLine = tmSdf.iLineNo
                                                                tmClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
                                                                tmClfSrchKey.iPropVer = 32000 ' 0 show latest version
                                                                ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)
                                                                If (tmClf.lChfCode <> tmSdf.lChfCode) Then     'got the matching line reference?
                                                                    ilSpotOK = False
                                                                Else
                                                                    'Retrieve spot cost from flight ; flight not returned if spot type is Extra/Fill
                                                                    'otherwise flight returned in tgPriceCff
                                                                    ilRet = gGetSpotPrice(tmSdf, tmClf, hmCff, hmSmf, hmVef, hmVsf, slPrice)

                                                                    ilSpotTypeOK = gTestCostType(ilCostType, slPrice)
                                                                    If ilSpotTypeOK = False Then        'exclude this spot type?
                                                                        ilSpotOK = False
                                                                    End If
                                                                                                                    '10-29-10  if excluding MG, that includes MG rate spot types & MG/outside spots
                                                                    'test for mg/outside (cant be a bonus spot) and if MG should be included
                                                                    If ((tmSdf.sSchStatus = "G" Or tmSdf.sSchStatus = "O") And tmSdf.sSpotType <> "X") And ((ilCostType And SPOT_MG) <> SPOT_MG) Then
                                                                        ilSpotOK = False
                                                                    End If

                                                                End If
                                                            End If                  'tmSpot.lSdfCode = tmSdf.lCode And ilRet = BTRV_ERR_NONE And ilSpotOK = True
                                                        End If                      'ilRet = BTRV_ERR_NONE And tmSdf.lChfCode > 0
                                                    End If                          'ilSpotOK


                                                    If ilSpotOK Then
                                                        ilNo30 = 0
                                                        ilNo60 = 0
                                                        'ilLen = tmSpot.iPosLen And &HFFF
                                                        If tgVpf(ilVpfIndex).sSSellOut = "B" Then                   'both units and seconds
                                                        'Convert inventory to number of 30's and 60's
                                                            Do While ilLen >= 60
                                                                ilNo60 = ilNo60 + 1
                                                                ilLen = ilLen - 60
                                                            Loop
                                                            Do While ilLen >= 30
                                                                ilNo30 = ilNo30 + 1
                                                                ilLen = ilLen - 30
                                                            Loop
                                                            If ilLen < 30 And ilLen > 0 Then    '7-6-00 assume anything under 30" is 1-30" unit availability
                                                                ilNo30 = ilNo30 + 1
                                                                ilLen = 0
                                                            End If

                                                            If (smBucketType = "S") Or (smBucketType = "P") Then    'sellout or %sellout, accum sold
                                                                If RptSelCt!rbcSelC4(1).Value Then                'qtrly detail
                                                                    If slChfType = "V" Then                       'Type reserve
                                                                        'Show on separate line or buy in sold?
                                                                        If RptSelCt!rbcSelC7(0).Value Then                       'hide the reserves
                                                                            tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                                                            tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                                                        Else                                            'show the reserves- (If Excluding reserves, it has already been
                                                                                                                        'excluded by the time it gets here)
                                                                            tmAvr(ilRecIndex).i30Reserve(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Reserve(ilBucketIndexMinusOne) + ilNo30
                                                                            tmAvr(ilRecIndex).i60Reserve(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Reserve(ilBucketIndexMinusOne) + ilNo60
                                                                        End If
                                                                    ElseIf slChfStatus = "H" Then                         'staus "Hold" , always show on separate line
                                                                        tmAvr(ilRecIndex).i30Hold(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Hold(ilBucketIndexMinusOne) + ilNo30
                                                                        tmAvr(ilRecIndex).i60Hold(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Hold(ilBucketIndexMinusOne) + ilNo60
                                                                    Else
                                                                        tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                                                        tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                                                    End If
                                                                Else
                                                                    tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                                                    tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                                                End If
                                                            Else                                                    'avails: accum available
                                                                '9-8-10 for a units report, do not overstate the inventory based on 30/60 inventory count
                                                                'always need to insure that for a 30 spot scheduled in a 60 avail, that the 60 inventory is take away
                                                                'and no longer avail
                                                                If slUserRequest = "U" Then
                                                                    If ilNo30 > 0 Then
                                                                        If tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) > 0 Then
                                                                            tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) - ilNo30
                                                                        Else
                                                                            tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) - ilNo30
                                                                        
                                                                        End If
                                                                    Else            '60s
                                                                        tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) - ilNo60
                                                                    End If
                                                                Else
                                                                    tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) - ilNo60
                                                                    tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) - ilNo30
                                                                End If
                                                            End If
                                                            'adjust the available buckets (used for qtrly detail  report only)
                                                            If slUserRequest = "U" Then
                                                                If ilNo30 > 0 Then
                                                                    If tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) > 0 Then
                                                                        tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) - ilNo30
                                                                    Else
                                                                        tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) - ilNo30
                                                                    
                                                                    End If
                                                                Else            '60s
                                                                    tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) - ilNo60
                                                                End If
                                                            Else
                                                                tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) - ilNo60
                                                                tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) - ilNo30
                                                            End If
                                                        ElseIf tgVpf(ilVpfIndex).sSSellOut = "U" Then               'units sold
                                                            'Count 30 or 60 and set flag if neither
                                                            If ilLen = 60 Then
                                                                ilNo60 = 1
                                                            ElseIf ilLen = 30 Then
                                                                ilNo30 = 1
                                                            Else
                                                                tmAvr(ilRecIndex).sNot30Or60 = "Y"
                                                                If ilLen <= 30 Then
                                                                    ilNo30 = 1
                                                                Else
                                                                    ilNo60 = 1
                                                                End If
                                                            End If
                                                            If (ilNo60 <> 0) Or (ilNo30 <> 0) Then
                                                                If (smBucketType = "S") Or (smBucketType = "P") Then
                                                                    If RptSelCt!rbcSelC4(1).Value Then                'qtrly detail
                                                                        If slChfType = "V" Then                       'Type reserve
                                                                            'Show on separate line or buy in sold?
                                                                            If RptSelCt!rbcSelC7(0).Value Then                       'hide the reserves
                                                                                tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                                                                tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                                                            Else                                            'show the reserves- (if excluding reserves, it has
                                                                                                                            'already been excluded by the time it gets here)
                                                                                tmAvr(ilRecIndex).i30Reserve(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Reserve(ilBucketIndexMinusOne) + ilNo30
                                                                                tmAvr(ilRecIndex).i60Reserve(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Reserve(ilBucketIndexMinusOne) + ilNo60
                                                                            End If
                                                                        ElseIf slChfStatus = "H" Then                         'staus "Hold", always show on separate line

                                                                            tmAvr(ilRecIndex).i30Hold(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Hold(ilBucketIndexMinusOne) + ilNo30
                                                                            tmAvr(ilRecIndex).i60Hold(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Hold(ilBucketIndexMinusOne) + ilNo60
                                                                        Else
                                                                            tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                                                            tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                                                        End If
                                                                    Else
                                                                        tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                                                        tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                                                    End If
                                                                Else                                                   'staus hold or reserve n/a for other qtrly summary options
                                                                    'Gather Inventory
                                                                    If ilNo60 > 0 Then                     'spot found a 60?
                                                                        tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) - ilNo60
                                                                    Else
                                                                        If tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) > 0 Then
                                                                            tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) - ilNo30
                                                                        Else
                                                                            If tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) > 0 Then
                                                                                tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) - ilNo30
                                                                            Else                        'oversold units
                                                                                tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) - ilNo30
                                                                            End If
                                                                        End If
                                                                    End If
                                                                End If
                                                            End If
                                                            'adjust the available buckets  (used for detail version only)
                                                            If ilNo60 > 0 Then      '60 can only take away from 60s bucket since it cant go into anything less
                                                                tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) - ilNo60
                                                            Else        'must be 30 or less
                                                                'see if there are 30s to subtract, may have to take from 60 since its unit based
                                                                If tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) > 0 Then   'theres enuf 30s to take away from
                                                                    tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) - ilNo30
                                                                Else
                                                                    'take away from the 60s bucket if any exist, otherwise oversell the 30 avail
                                                                    If tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) > 0 Then
                                                                    tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) - ilNo30
                                                                    Else
                                                                    tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) - ilNo30
                                                                    End If
                                                                End If
                                                            End If

                                                        ElseIf tgVpf(ilVpfIndex).sSSellOut = "M" Then               'matching units
                                                            'Count 30 or 60 and set flag if neither
                                                            If ilLen = 60 Then
                                                                ilNo60 = 1
                                                            ElseIf ilLen <= 30 Then
                                                                ilNo30 = 1
                                                            Else
                                                                tmAvr(ilRecIndex).sNot30Or60 = "Y"
                                                            End If
                                                            If (smBucketType = "S") Or (smBucketType = "P") Then        'if Sellout or % sellout, accum the seconds sold
                                                                'Qtrly detail has been forced to "Sellout" for internal testing
                                                                If RptSelCt!rbcSelC4(1).Value Then            'qtrly detail
                                                                    If slChfType = "V" Then                       'Type reserve
                                                                        'Show on separate line or bury in sold?
                                                                        If RptSelCt!rbcSelC7(0).Value Then                       'hide the reserves
                                                                            tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                                                            tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                                                        Else                                            'show the reserves - (if excluding reserves, it has
                                                                                                                        'already been excluded by the time it gets here)
                                                                            tmAvr(ilRecIndex).i30Reserve(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Reserve(ilBucketIndexMinusOne) + ilNo30
                                                                            tmAvr(ilRecIndex).i60Reserve(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Reserve(ilBucketIndexMinusOne) + ilNo60
                                                                        End If
                                                                    ElseIf slChfStatus = "H" Then                         'staus "Hold", always show on separate line
                                                                        tmAvr(ilRecIndex).i30Hold(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Hold(ilBucketIndexMinusOne) + ilNo30
                                                                        tmAvr(ilRecIndex).i60Hold(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Hold(ilBucketIndexMinusOne) + ilNo60
                                                                    Else            'not held or reserved, put in sold
                                                                        tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                                                        tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                                                    End If
                                                                Else
                                                                    tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                                                    tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                                                End If
                                                            Else                                                    'holds & reserve n/a for othr qtrly summary options
                                                                tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) - ilNo60
                                                                tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) - ilNo30
                                                            End If
                                                            'adjust the available bucket (used for qrtrly detail report only)
                                                            tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) - ilNo60
                                                            tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) - ilNo30
                                                        ElseIf tgVpf(ilVpfIndex).sSSellOut = "T" Then
                                                        End If
                                                    End If                              'ilspotOK
                                                End If
                                            Next ilSpot                             'loop from ssf file for # spots in avail
                                        End If                                  'exclude locked avails
                                    End If                                      'if <> "I"
                                End If                                          'Avail OK
                            Next ilRdf
                        End If              'test locked avail
                        ilEvt = ilEvt + tmAvail.iNoSpotsThis                'bypass spots
                    End If
                    ilEvt = ilEvt + 1   'Increment to next event
                Loop                                                        'do while ilEvt <= tmSsf.iCount
            End If                                                              'ilBucketIndex > 0
            imSsfRecLen = Len(tmSsf) 'Max size of variable length record
            ilRet = gSSFGetNext(hmSsf, tmSsf, imSsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            If tgMVef(ilVefIndex).sType = "G" Then
                ilType = tmSsf.iType
            End If
        Loop                                'loop on ssf
    Next llLoopDate

    'Get missed
    '10/30/98: For each missed status (missed, ready, and unscheduled) there are up to two passes
    'for each spot.  The first pass looks for a daypart that matches the schedule line.
    'if found, the missed spot is placed in that DP.  If no DP are found that match
    'the missed spots schedule line, the second pass creates an AVR entry and places
    'that missed spot into that "Orphan Missed Spots" DP.
    If (imMissed) And (smBucketType <> "I") Then
        'Key 2: VefCode; SchStatus; AdfCode; Date, Time
        For ilPass = 0 To 2 Step 1
            tmSdfSrchKey2.iVefCode = ilVefCode
            If ilPass = 0 Then
                slType = "M"
            ElseIf ilPass = 1 Then
                slType = "R"
            ElseIf ilPass = 2 Then
                slType = "U"
            End If
            tmSdfSrchKey2.sSchStatus = slType
            tmSdfSrchKey2.iAdfCode = 0
            tmSdfSrchKey2.iDate(0) = ilSAvailsDates(0)
            tmSdfSrchKey2.iDate(1) = ilSAvailsDates(1)
            tmSdfSrchKey2.iTime(0) = 0
            tmSdfSrchKey2.iTime(1) = 0
            ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point
            'This code added as replacement for Ext operation
            'include the missed spot if there wasnt an error reading spot, the spot vehicle matches the vehicle to be processed,
            'the spot type is a missed, ready or unsched, and local to be include and spot is local (or network to be incl and spot is network)
            Do While (ilRet = BTRV_ERR_NONE) And (tmSdf.iVefCode = ilVefCode) And (tmSdf.sSchStatus = slType) And ((imLocal And tmSdf.lChfCode > 0) Or (imFeed And tmSdf.lChfCode = 0))
                '4/12/18: Add spot type test
                ilSpotOK = True                             'assume spot is OK to include
                '4-12-18 implement testing of contract types
                If tmSdf.lChfCode <> tmChf.lCode Then               'if already in mem, don't reread
                    tmChfSrchKey.lCode = tmSdf.lChfCode
                    ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        ilSpotOK = False
                    End If
                    slChfType = tmChf.sType
                    slChfStatus = tmChf.sStatus
                End If
                If (slChfType = "C") And (Not imStandard) Then
                    ilSpotOK = False
                End If
                If (slChfType = "V") And (Not imReserv) Then
                    ilSpotOK = False
                End If
                If (slChfType = "T") And (Not imRemnant) Then
                    ilSpotOK = False
                End If
                If (slChfType = "R") And (Not imDR) Then
                    ilSpotOK = False
                End If
                If (slChfType = "Q") And (Not imPI) Then
                    ilSpotOK = False
                End If
 
                If (slChfType = "M") And (Not imPromo) Then
                    ilSpotOK = False
                End If
                If (slChfType = "S") And (Not imPSA) Then
                    ilSpotOK = False
                End If
                'exclude if partial or full trade
                If (ilPctTrade = 100) And (Not imTrade) Then
                    ilSpotOK = False
                End If
                                
                If ilSpotOK Then
                    'end of add
                    gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llDate
                    If (llDate >= lmSAvailsDates(ilFirstQ)) And (llDate <= lmEAvailsDates(13)) Then
                        ilBucketIndex = -1
                        For illoop = 1 To 13 Step 1
                            If (llDate >= lmSAvailsDates(illoop)) And (llDate <= lmEAvailsDates(illoop)) Then
                                                                    'lmsavailsdates & lmeavailsdates are the full qtr weekly dates.  since it was changed to allow # weeks to print,
                                                                    'may need to exit for any missed spots beyond the last week requested
                                If llDate > llEndDate Then        '4-6-12 llenddate is the last date to process (for this qtr) due to # of weeks entered
                                    Exit For
                                End If
                                ilBucketIndex = illoop
                                Exit For
                            End If
                        Next illoop
    
                        If tmSdf.lChfCode = 0 Then
                            'no daypart
                            tmClf.iRdfCode = 0
                        Else
                             '6-4-04 Gather line daypart info.  If not using other missed spots category, need to check daypart to see if exclusions/exclusions
                            tmClfSrchKey.lChfCode = tmSdf.lChfCode
                            tmClfSrchKey.iLine = tmSdf.iLineNo
                            tmClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
                            tmClfSrchKey.iPropVer = 32000 ' 0 show latest version
                            ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)
                            If (tmClf.lChfCode <> tmSdf.lChfCode) Then
                                ilBucketIndex = -1          'error in reading line, bypass spot
                            Else
                                'need to get the schedule lines daypart info to see if spot can go/cant go into certain avails
                                For llRif = LBound(tgMRif) To UBound(tgMRif) - 1
                                    If tgMRif(llRif).iRcfCode = tgMRcf(imRcf).iCode And tgMRif(llRif).iVefCode = ilVefCode And tgMRif(llRif).iRdfCode = tmClf.iRdfCode Then
                                        ilRdf = gBinarySearchRdf(tgMRif(llRif).iRdfCode)
                                        If ilRdf <> -1 Then
                                            'got the daypart, save if there are includes/excludes and named avails
                                            tlOrderedRDF = tgMRdf(ilRdf)
                                        Else
                                            ilBucketIndex = -1          'ignore this spot, cannot find ordered DP
                                        End If
                                    End If
                                Next llRif
                            End If
                        End If
    
    
                        If ilBucketIndex > 0 Then
                            ilBucketIndexMinusOne = ilBucketIndex - 1
                            ilDay = gWeekDayLong(llDate)
                            gUnpackTimeLong tmSdf.iTime(0), tmSdf.iTime(1), False, llTime
    
                            For ilOrphanMissedLoop = 1 To ilOrphanMax
                                ilOrphanFound = False
                                For ilRdf = LBound(tmAvRdf) To UBound(tmAvRdf) - 1 Step 1
                                    ilAvailOk = False
                                    If (tmAvRdf(ilRdf).iLtfCode(0) <> 0) Or (tmAvRdf(ilRdf).iLtfCode(1) <> 0) Or (tmAvRdf(ilRdf).iLtfCode(2) <> 0) Then
                                        If (ilLtfCode = tmAvRdf(ilRdf).iLtfCode(0)) Or (ilLtfCode = tmAvRdf(ilRdf).iLtfCode(1)) Or (ilLtfCode = tmAvRdf(ilRdf).iLtfCode(1)) Then
                                            ilAvailOk = False    'True- code later
                                        End If
                                    Else
                                        If tmAvRdf(ilRdf).iCode = tlOrderedRDF.iCode Then
                                            ilAvailOk = True
                                            ilLoopIndex = 1       '10-24-13 force to ues 1st time index defined in the dp
                                        Else
                                            For illoop = LBound(tmAvRdf(ilRdf).iStartTime, 2) To UBound(tmAvRdf(ilRdf).iStartTime, 2) Step 1 'Row
                                                If (tmAvRdf(ilRdf).iStartTime(0, illoop) <> 1) Or (tmAvRdf(ilRdf).iStartTime(1, illoop) <> 0) Then
                                                    gUnpackTimeLong tmAvRdf(ilRdf).iStartTime(0, illoop), tmAvRdf(ilRdf).iStartTime(1, illoop), False, llStartTime
                                                    gUnpackTimeLong tmAvRdf(ilRdf).iEndTime(0, illoop), tmAvRdf(ilRdf).iEndTime(1, illoop), True, llEndTime
                                                    If UBound(tmAvRdf) - 1 = LBound(tmAvRdf) Then   'could be a conv bumped spot sched in
                                                                                                'in conven veh.  The VV has DP times different than the
                                                                                                'conven veh.
                                                        llStartTime = llTime
                                                        llEndTime = llTime + 1              'actual time of spot
                                                    End If
                                                    'Don't include the end time i.e. 10a-3p is 10a thru 2:59:59p
                                                    ilLoopIndex = illoop        '11-10-99  day not within a DP shown on report
                                                    If (llTime >= llStartTime) And (llTime < llEndTime) And (tmAvRdf(ilRdf).sWkDays(illoop, ilDay) = "Y") Then
                                                        'times and day ok, is this allowed to have the same kind of spot based on inclusion or exclusion or avail
                                                        ilAvailOk = True
                                                        If tlOrderedRDF.iCode <> tmAvRdf(ilRdf).iCode Then
                                                            ilAvailOk = False
                                                        End If
        
                                                        ilLoopIndex = illoop
                                                        slDays = ""
                                                        For ilDayIndex = 1 To 7 Step 1
                                                            If (tmAvRdf(ilRdf).sWkDays(illoop, ilDayIndex - 1) = "Y") Or (tmAvRdf(ilRdf).sWkDays(illoop, ilDayIndex - 1) = "N") Then
                                                                slDays = slDays & tmAvRdf(ilRdf).sWkDays(illoop, ilDayIndex - 1)
                                                            Else
                                                                slDays = slDays & "N"
                                                            End If
                                                        Next ilDayIndex
                                                        If ilAvailOk Then       'this daypart is ok, no need to go thru any more--so get out
                                                            Exit For
                                                        End If
        
                                                    End If
                                                End If
                                            Next illoop
                                        End If
                                    End If
                                    If ilAvailOk Or ilOrphanMissedLoop = 2 Then      'if pass 2, force the missed spot into the
                                        ilSpotOK = True
                                        '6-4-04 move reading of schedule earlier
                                        'only tests to see if its a matching DP against avail if orphans should be used in separate category
                                        If ilOrphanMissedLoop = 1 And imOrphan Then          'pass one must find matching daypart with sch line
                                            If tmClf.iRdfCode <> tmAvRdf(ilRdf).iCode Then
                                                ilSpotOK = False
                                            End If
                                        End If
                                        
                                        '10-29-10 include/exclude mg as option (that is mg spot rate and mg/out
                                        'Retrieve spot cost from flight ; flight not returned if spot type is Extra/Fill
                                        'otherwise flight returned in tgPriceCff
                                        ilRet = gGetSpotPrice(tmSdf, tmClf, hmCff, hmSmf, hmVef, hmVsf, slPrice)
    
                                        ilSpotTypeOK = gTestCostType(ilCostType, slPrice)
                                        If ilSpotTypeOK = False Then        'exclude this spot type?
                                            ilSpotOK = False
                                        End If
    
                                        If ilSpotOK Then
                                            ilOrphanFound = True
                                            'Determine if Avr created
                                            ilFound = False
                                            ilSaveDay = ilDay
                                            If RptSelCt!rbcSelCInclude(0).Value Then              'daypart option, place all values in same record
                                                                                                'to get better availability
                                                ilDay = 0                                       'force all data in same day of week
                                            End If
                                            If ilOrphanMissedLoop = 2 Then
                                                For ilRec = 0 To UBound(tmAvr) - 1 Step 1
                                                    If (ilRdfCodes(ilRec) = -1) And (tmAvr(ilRec).iFirstBucket = ilFirstQ) And (tmAvr(ilRec).iDay = ilDay) Then
                                                        ilFound = True
                                                        ilRecIndex = ilRec
                                                        Exit For
                                                    End If
                                                Next ilRec
                                            Else
                                                For ilRec = 0 To UBound(tmAvr) - 1 Step 1
                                                    'If (tmAvr(ilRec).iRdfCode = tmAvRdf(ilRdf).iCode) And (tmAvr(ilRec).iFirstBucket = ilFirstQ) And (tmAvr(ilRec).iDay = ilDay) Then
                                                    If (ilRdfCodes(ilRec) = tmAvRdf(ilRdf).iCode) And (tmAvr(ilRec).iFirstBucket = ilFirstQ) And (tmAvr(ilRec).iDay = ilDay) Then
                                                        ilFound = True
                                                        ilRecIndex = ilRec
                                                        Exit For
                                                    End If
                                                Next ilRec
                                            End If
                                            If Not ilFound Then
                                                ilRecIndex = UBound(tmAvr)
                                                tmAvr(ilRecIndex).iGenDate(0) = igNowDate(0)
                                                tmAvr(ilRecIndex).iGenDate(1) = igNowDate(1)
                                                gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
                                                tmAvr(ilRecIndex).lGenTime = lgNowTime
                                                tmAvr(ilRecIndex).iDay = ilDay
                                                tmAvr(ilRecIndex).iQStartDate(0) = ilSAvailsDates(0)
                                                tmAvr(ilRecIndex).iQStartDate(1) = ilSAvailsDates(1)
                                                tmAvr(ilRecIndex).iFirstBucket = ilFirstQ
                                                tmAvr(ilRecIndex).sBucketType = smBucketType
                                                tmAvr(ilRecIndex).iDPStartTime(0) = tmAvRdf(ilRdf).iStartTime(0, ilLoopIndex)
                                                tmAvr(ilRecIndex).iDPStartTime(1) = tmAvRdf(ilRdf).iStartTime(1, ilLoopIndex)
                                                tmAvr(ilRecIndex).iDPEndTime(0) = tmAvRdf(ilRdf).iEndTime(0, ilLoopIndex)
                                                tmAvr(ilRecIndex).iDPEndTime(1) = tmAvRdf(ilRdf).iEndTime(1, ilLoopIndex)
                                                tmAvr(ilRecIndex).sDPDays = slDays
                                                tmAvr(ilRecIndex).sNot30Or60 = "N"
                                                tmAvr(ilRecIndex).iVefCode = ilVefCode
                                                tmAvr(ilRecIndex).iRdfCode = tmAvRdf(ilRdf).iSortCode
                                                ilRdfCodes(ilRecIndex) = tmAvRdf(ilRdf).iCode
                                                tmAvr(ilRecIndex).sInOut = tmAvRdf(ilRdf).sInOut
                                                tmAvr(ilRecIndex).ianfCode = tmAvRdf(ilRdf).ianfCode
                                                If ilOrphanMissedLoop = 2 Then
                                                    'override some of the codes if its in the orphan pass (where no shown DP equals the DP of the missed spot)
                                                    ilRdfCodes(ilRecIndex) = -1         'phoney daypart for orphaned missed spots 'tmAvRdf(ilRdf).icode
                                                    tmAvr(ilRecIndex).iRdfCode = 32000     'sort it last tmRifSorts(ilRdf).isort   'DP Sort code  from RIF
                                                    tmAvr(ilRecIndex).iRdfSortCode = -1 'tmAvRdf(ilRdf).icode   'DP code to retrieve DP name description
                                                Else
                                                    ilRdfCodes(ilRecIndex) = tmAvRdf(ilRdf).iCode         'phoney daypart for orphaned missed spots 'tmAvRdf(ilRdf).icode
                                                    tmAvr(ilRecIndex).iRdfCode = tmRifSorts(ilRdf).iSort       'sort it last tmRifSorts(ilRdf).isort   'DP Sort code  from RIF
                                                    tmAvr(ilRecIndex).iRdfSortCode = tmAvRdf(ilRdf).iCode 'tmAvRdf(ilRdf).icode   'DP code to retrieve DP name description
                                                
                                                End If
                                                ReDim Preserve tmAvr(0 To ilRecIndex + 1) As AVR
                                                ReDim Preserve ilRdfCodes(0 To ilRecIndex + 1)
                                            End If
                                            ilDay = ilSaveDay
                                            ilNo30 = 0
                                            ilNo60 = 0
                                            ilLen = tmSdf.iLen
                                            If tgVpf(ilVpfIndex).sSSellOut = "B" Then
                                            'Convert inventory to number of 30's and 60's
                                                Do While ilLen >= 60
                                                    ilNo60 = ilNo60 + 1
                                                    ilLen = ilLen - 60
                                                Loop
                                                Do While ilLen >= 30
                                                    ilNo30 = ilNo30 + 1
                                                    ilLen = ilLen - 30
                                                Loop
                                                If ilLen < 30 And ilLen > 0 Then    '7-6-00 assume anything under 30" is 1-30" unit availability
                                                    ilNo30 = ilNo30 + 1
                                                    ilLen = 0
                                                End If
    
                                                If (smBucketType = "S") Or (smBucketType = "P") Then
                                                    tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                                    tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                                Else
                                                    tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) - ilNo60
                                                        tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) - ilNo30
                                                End If
                                                'adjust the available bucket (used for qrtrly detail report only)
                                                tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) - ilNo60
                                                tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) - ilNo30
                                            ElseIf tgVpf(ilVpfIndex).sSSellOut = "U" Then
                                                'Count 30 or 60 and set flag if neither
                                                If ilLen = 60 Then
                                                    ilNo60 = 1
                                                ElseIf ilLen = 30 Then
                                                    ilNo30 = 1
                                                Else
                                                    tmAvr(ilRecIndex).sNot30Or60 = "Y"
                                                    If ilLen <= 30 Then
                                                        ilNo30 = 1
                                                    Else
                                                        ilNo60 = 1
                                                    End If
                                                End If
                                                If (smBucketType = "S") Or (smBucketType = "P") Then
                                                    tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                                    tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                                Else
                                                    tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) - ilNo60
                                                        tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) - ilNo30
                                                End If
                                                'adjust the available bucket (used for qrtrly detail report only)
                                                If ilNo60 > 0 Then                      'spot found a 60?
                                                    tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) - ilNo60
                                                Else
                                                    If tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) > 0 Then
                                                        tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) - ilNo30
                                                    Else
                                                        If tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) > 0 Then
                                                            tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) - ilNo30
                                                        Else                        'oversold units
                                                            tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) - ilNo30
                                                        End If
                                                    End If
                                                End If
    
                                            ElseIf tgVpf(ilVpfIndex).sSSellOut = "M" Then
                                                'Count 30 or 60 and set flag if neither
                                                If ilLen = 60 Then
                                                    ilNo60 = 1
                                                ElseIf ilLen <= 30 Then
                                                    ilNo30 = 1
                                                Else
                                                    tmAvr(ilRecIndex).sNot30Or60 = "Y"
                                                End If
                                                If (smBucketType = "S") Or (smBucketType = "P") Then
                                                    tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) + ilNo30
                                                    tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) + ilNo60
                                                Else
                                                    tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Count(ilBucketIndexMinusOne) - ilNo30
                                                    tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Count(ilBucketIndexMinusOne) - ilNo60
                                                End If
                                                'adjust the available bucket (used for qrtrly detail report only)
                                                tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i60Avail(ilBucketIndexMinusOne) - ilNo60
                                                tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) = tmAvr(ilRecIndex).i30Avail(ilBucketIndexMinusOne) - ilNo30
                                            ElseIf tgVpf(ilVpfIndex).sSSellOut = "T" Then
                                            End If
                                            Exit For            'count missed only once, force exit
                                        End If      'ilSpotOK
                                    End If          'ilAvailok
                                    If ilOrphanMissedLoop = 2 Then
                                        Exit For
                                    End If
                                Next ilRdf
                                If ilOrphanFound Then
                                   Exit For                 'missed found a matching daypart
                                End If
                            Next ilOrphanMissedLoop
                        End If
                    End If
                End If
                ilRet = btrGetNext(hmSdf, tmSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
        Next ilPass
    End If

    'Adjust counts
    'If (smBucketType = "A") And (tgVpf(ilVpfIndex).sSSellOut = "B" Or tgVpf(ilVpfIndex).sSSellOut = "U") Then
    If (smBucketType = "A" And tgVpf(ilVpfIndex).sSSellOut = "B") Then
        For ilRec = 0 To UBound(tmAvr) - 1 Step 1
            'For ilLoop = 1 To 13 Step 1
            For illoop = LBound(tmAvr(ilRec).i30Count) To UBound(tmAvr(ilRec).i30Count) Step 1
                If tmAvr(ilRec).i30Count(illoop) < 0 Then
                    Do While (tmAvr(ilRec).i60Count(illoop) > 0) And (tmAvr(ilRec).i30Count(illoop) < 0)
                        tmAvr(ilRec).i60Count(illoop) = tmAvr(ilRec).i60Count(illoop) - ilAdjSub    '1
                        tmAvr(ilRec).i30Count(illoop) = tmAvr(ilRec).i30Count(illoop) + ilAdjAdd    '2
                    Loop
                ElseIf (tmAvr(ilRec).i60Count(illoop) < 0) Then
                End If
            Next illoop
        Next ilRec
    End If
    'Adjust counts for qtrly detail availbilty
    If (RptSelCt!rbcSelC4(1).Value And tgVpf(ilVpfIndex).sSSellOut = "B") Then                   'qtrly detail?
        For ilRec = 0 To UBound(tmAvr) - 1 Step 1
            'For ilLoop = 1 To 13 Step 1
            For illoop = LBound(tmAvr(ilRec).i30Avail) To UBound(tmAvr(ilRec).i30Avail) Step 1
                If tmAvr(ilRec).i30Avail(illoop) < 0 Then
                    Do While (tmAvr(ilRec).i60Avail(illoop) > 0) And (tmAvr(ilRec).i30Avail(illoop) < 0)
                        tmAvr(ilRec).i60Avail(illoop) = tmAvr(ilRec).i60Avail(illoop) - 1
                        tmAvr(ilRec).i30Avail(illoop) = tmAvr(ilRec).i30Avail(illoop) + 2
                    Loop
                ElseIf (tmAvr(ilRec).i60Avail(illoop) < 0) Then
                End If
            Next illoop
        Next ilRec
    End If
    If slUserRequest = "U" Then
        For ilRec = 0 To UBound(tmAvr) - 1 Step 1
            'For ilLoop = 1 To 13 Step 1
            For illoop = LBound(tmAvr(ilRec).i30Count) To UBound(tmAvr(ilRec).i30Count) Step 1
                tmAvr(ilRec).i30Count(illoop) = tmAvr(ilRec).i30Count(illoop) + tmAvr(ilRec).i60Count(illoop)
                tmAvr(ilRec).i60Count(illoop) = 0
                tmAvr(ilRec).i30InvCount(illoop) = tmAvr(ilRec).i30InvCount(illoop) + tmAvr(ilRec).i60InvCount(illoop)
                tmAvr(ilRec).i60InvCount(illoop) = 0
                tmAvr(ilRec).i30Avail(illoop) = tmAvr(ilRec).i30Avail(illoop) + tmAvr(ilRec).i60Avail(illoop)
                tmAvr(ilRec).i60Avail(illoop) = 0
            Next illoop
        Next ilRec
    End If
    
    'Restore the selling method if it was altered
    'tgVpf(ilVpfIndex).sSSellOut = slSaveSellOut
    Erase ilSAvailsDates
    Erase ilEvtType
    Erase ilRdfCodes
    Erase tlLLC
End Sub

'           mGetCntWkGrps - Calculate the grps for each week individually
'           for contract totals
'           <input> llResearchPop - population
'           <output> 104 weekly grps for all lines
'           2-11-00
'
Sub mGetCntWkGrps(llInResearchPop As Long)
    Dim ilWeekly As Integer
    Dim ilWeeklyMinusOne As Integer
    Dim llLnSpots As Long
    Dim llCPP As Long
    Dim llCPM As Long
    Dim llAvgAud As Long
    'Dim llTotalCost As Long
    Dim dlTotalCost As Double 'TTP 10439 - Rerate 21,000,000
    Dim llGrimps As Long
    Dim llResearchPop As Long           '6-29-04
    Dim llQtr As Long                   '4-10-19    replace ilQtr due to subscript out of range
    Dim llRchQtr As Long                '4-10-19    replace ilRchQtr
    Dim llVaryingQtrs As Long           '4-10-19    replace ilVaryingQtrs
     ReDim tmWkCntGrps(0 To 0) As WEEKLYGRPS
    '2-11-00 Build weekly grimps for all vehicles.  Each line entry is 8 quarters (max 2 years).  Entries are unique
    'for  vehicle/daypart/#spots/line rate
   
    llVaryingQtrs = 0                       '11-14-11 handle varying qtrs
    For llQtr = 1 To imMaxQtrs Step 1              'cycle thru 8 quarters
        For ilWeekly = 1 To imWeeksPerQtr(llQtr)
            ilWeeklyMinusOne = ilWeekly - 1
            ReDim tmVRtg(0 To 0) As Integer
            ReDim tmVCost(0 To 0) As Long
            ReDim tmVGRP(0 To 0) As Long
            ReDim tmVGrimp(0 To 0) As Long

            llLnSpots = 0
            If tgSpf.sDemoEstAllowed = "Y" Then
                llResearchPop = -1
            Else
                llResearchPop = llInResearchPop
            End If
            For llRchQtr = llQtr To UBound(tmLRch) - 1 Step 8   'process as many lines that are built
                'bypass the Package lines, the quarterly totals will be obtained from the individual hidden lines because
                'each package line can contain the same data repeated in each flight.  Exclude package lines to avoid
                'duplicating results.
                If (tmLRch(llRchQtr).sType <> "A" And tmLRch(llRchQtr).sType <> "O" And tmLRch(llRchQtr).sType <> "E") Then    'not a package of any kind
                    llLnSpots = llLnSpots + tmLRch(llRchQtr).lSpots(ilWeeklyMinusOne)
                    If (tmLRch(llRchQtr).lSpots(ilWeeklyMinusOne) <> 0) Then              'only process if spots exist in the qtr
                        'tmVRtg(UBound(tmVRtg)) = tmLRch(ilRchQtr).lAvgAud(ilWeekly)
                        tmVRtg(UBound(tmVRtg)) = tmLRch(llRchQtr).iWklyRating(ilWeeklyMinusOne) '2-17-00
                        tmVCost(UBound(tmVCost)) = tmLRch(llRchQtr).lRates(ilWeeklyMinusOne)
                        tmVGRP(UBound(tmVGRP)) = tmLRch(llRchQtr).lWklyGRP(ilWeeklyMinusOne)
                        tmVGrimp(UBound(tmVGrimp)) = tmLRch(llRchQtr).lWklyGrimp(ilWeeklyMinusOne)
                        If tgSpf.sDemoEstAllowed = "Y" Then
                            If llResearchPop = -1 Then
                                llResearchPop = tmLRch(llRchQtr).lPopEst(ilWeeklyMinusOne)
                            Else
                                If llResearchPop <> tmLRch(llRchQtr).lPopEst(ilWeeklyMinusOne) And llResearchPop <> 0 Then
                                    llResearchPop = 0
                                End If
                            End If
                        End If

                        ReDim Preserve tmVRtg(0 To UBound(tmVRtg) + 1) As Integer
                        ReDim Preserve tmVCost(0 To UBound(tmVCost) + 1) As Long
                        ReDim Preserve tmVGRP(0 To UBound(tmVGRP) + 1) As Long
                        ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) + 1) As Long
                    End If
                End If
            Next llRchQtr
            If UBound(tmVRtg) > LBound(tmVRtg) Then
                'dimensions must be exact sizes
                ReDim Preserve tmVRtg(0 To UBound(tmVRtg) - 1) As Integer
                ReDim Preserve tmVCost(0 To UBound(tmVCost) - 1) As Long
                ReDim Preserve tmVGRP(0 To UBound(tmVGRP) - 1) As Long
                ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) - 1) As Long
                llRchQtr = llVaryingQtrs + ilWeekly
                'only care about the weeks grimps
                'gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, llTotalCost, tmCbf.iAvgRate, llGrimps, tmWkCntGrps(0).lGrps(llRchQtr), llCPP, llCPM, llAvgAud
                gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, dlTotalCost, tmCbf.iAvgRate, llGrimps, tmWkCntGrps(0).lGrps(llRchQtr), llCPP, llCPM, llAvgAud 'TTP 10439 - Rerate 21,000,000
            End If
        Next ilWeekly
        llVaryingQtrs = llVaryingQtrs + imWeeksPerQtr(llQtr) 'accumulate # weeks in qtr to get the index into week processing, no longer hard coded 13 weeks/qtr
    Next llQtr
End Sub

'           mGetCntWkVGrs - Calculate the grps for each week individually
'           for contract totals
'           <input> llResearchPop - population
'                   ilVehlist() array of vehicle codes
'           <output> 104 weekly grps for all lines
'           2-11-00
Sub mGetCntWkVGrps(llInResearchPop As Long, ilVehList() As Integer)
    Dim ilWeekly As Integer
    Dim ilWeeklyMinusOne As Integer
    Dim llLnSpots As Long
    Dim llCPP As Long
    Dim llCPM As Long
    Dim llAvgAud As Long
    'Dim llTotalCost As Long
    Dim dlTotalCost As Double 'TTP 10439 - Rerate 21,000,000
    Dim llGrimps As Long
    Dim ilVehicle As Integer
    Dim ilUpperGrp As Integer
    Dim ilFound As Integer
    Dim illoop As Integer
    Dim llResearchPop As Long       '6-29-04
    Dim llQtr As Long                   '4-10-19    replace ilQtr due to subscript out of range
    Dim llRchQtr As Long                '4-10-19    replace ilRchQtr
    Dim llVaryingQtrs As Long           '4-10-19    replace ilVaryingQtrs
    '2-11-00 Build weekly grps for all vehicles.  Each line entry is 8 quarters (max 2 years).  Entries are unique
    'for  vehicle/daypart/#spots/line rate
    ReDim tmWkCntVGrps(0 To 0) As WEEKLYGRPS
    ilUpperGrp = 0
    For ilVehicle = LBound(ilVehList) To UBound(ilVehList) - 1 Step 1
        llVaryingQtrs = 0                   '11-14-11 handle varying qtrs
        For llQtr = 1 To imMaxQtrs Step 1              'cycle thru 8 quarters
            For ilWeekly = 1 To imWeeksPerQtr(llQtr)
                ilWeeklyMinusOne = ilWeekly - 1
                ReDim tmVRtg(0 To 0) As Integer
                ReDim tmVCost(0 To 0) As Long
                ReDim tmVGRP(0 To 0) As Long
                ReDim tmVGrimp(0 To 0) As Long

                llLnSpots = 0
                If tgSpf.sDemoEstAllowed = "Y" Then
                llResearchPop = -1
                Else
                    llResearchPop = llInResearchPop
                End If
                For llRchQtr = llQtr To UBound(tmLRch) - 1 Step 8   'process as many lines that are built
                    'bypass the Package lines, the quarterly totals will be obtained from the individual hidden lines because
                    'each package line can contain the same data repeated in each flight.  Exclude package lines to avoid
                    'duplicating results.
                    If (tmLRch(llRchQtr).sType <> "A" And tmLRch(llRchQtr).sType <> "O" And tmLRch(llRchQtr).sType <> "E") And tmLRch(llRchQtr).iVefCode = ilVehList(ilVehicle) Then    'not a package of any kind
                        If tmLRch(llRchQtr).sType = "S" Then            'bypass the hidden here, dont want to duplicate research for the week
                            llLnSpots = llLnSpots + tmLRch(llRchQtr).lSpots(ilWeeklyMinusOne)
                            If (tmLRch(llRchQtr).lSpots(ilWeeklyMinusOne) <> 0) Then              'only process if spots exist in the qtr
                                'tmVRtg(UBound(tmVRtg)) = tmLRch(ilRchQtr).lAvgAud(ilWeekly)
                                tmVRtg(UBound(tmVRtg)) = tmLRch(llRchQtr).iWklyRating(ilWeeklyMinusOne) '2-17-00
                                tmVCost(UBound(tmVCost)) = tmLRch(llRchQtr).lRates(ilWeeklyMinusOne)
                                tmVGRP(UBound(tmVGRP)) = tmLRch(llRchQtr).lWklyGRP(ilWeeklyMinusOne)
                                tmVGrimp(UBound(tmVGrimp)) = tmLRch(llRchQtr).lWklyGrimp(ilWeeklyMinusOne)
                                If tgSpf.sDemoEstAllowed = "Y" Then
                                    If llResearchPop = -1 Then
                                        llResearchPop = tmLRch(llRchQtr).lPopEst(ilWeeklyMinusOne)
                                    Else
                                        If llResearchPop <> tmLRch(llRchQtr).lPopEst(ilWeeklyMinusOne) And llResearchPop <> 0 Then
                                            llResearchPop = 0
                                        End If
                                    End If
                                End If
                                ReDim Preserve tmVRtg(0 To UBound(tmVRtg) + 1) As Integer
                                ReDim Preserve tmVCost(0 To UBound(tmVCost) + 1) As Long
                                ReDim Preserve tmVGRP(0 To UBound(tmVGRP) + 1) As Long
                                ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) + 1) As Long
                            End If
                        End If
                    End If
                Next llRchQtr
                
                If UBound(tmVRtg) > LBound(tmVRtg) Then
                    'dimensions must be exact sizes
                    ReDim Preserve tmVRtg(0 To UBound(tmVRtg) - 1) As Integer
                    ReDim Preserve tmVCost(0 To UBound(tmVCost) - 1) As Long
                    ReDim Preserve tmVGRP(0 To UBound(tmVGRP) - 1) As Long
                    ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) - 1) As Long
                    llRchQtr = llVaryingQtrs + ilWeekly
                    'only care about the weeks grps
                    ilFound = False
                    For illoop = LBound(tmWkCntVGrps) To UBound(tmWkCntVGrps) - 1
                        If tmWkCntVGrps(illoop).iVefCode = ilVehList(ilVehicle) Then
                            ilFound = True
                            Exit For
                        End If
                    Next illoop
                    If ilFound Then
                        'gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, llTotalCost, tmCbf.iAvgRate, llGrimps, tmWkCntVGrps(illoop).lGrps(llRchQtr), llCPP, llCPM, llAvgAud
                        gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, dlTotalCost, tmCbf.iAvgRate, llGrimps, tmWkCntVGrps(illoop).lGrps(llRchQtr), llCPP, llCPM, llAvgAud 'TTP 10439 - Rerate 21,000,000

                    Else
                        tmWkCntVGrps(ilUpperGrp).iVefCode = ilVehList(ilVehicle)
                        'tmWkCntVGrps(ilUpperGrp).iQtr = ilQtr
                        'gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, llTotalCost, tmCbf.iAvgRate, llGrimps, tmWkCntVGrps(ilUpperGrp).lGrps(llRchQtr), llCPP, llCPM, llAvgAud
                        gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, dlTotalCost, tmCbf.iAvgRate, llGrimps, tmWkCntVGrps(ilUpperGrp).lGrps(llRchQtr), llCPP, llCPM, llAvgAud 'TTP 10439 - Rerate 21,000,000
                        ilUpperGrp = UBound(tmWkCntVGrps) + 1
                        'ReDim Preserve tmWkCntVGrps(1 To ilUpperGrp) As WEEKLYGRPS
                        ReDim Preserve tmWkCntVGrps(0 To ilUpperGrp) As WEEKLYGRPS
                    End If
                End If
            Next ilWeekly
            llVaryingQtrs = llVaryingQtrs + imWeeksPerQtr(llQtr)  'accumulate # weeks in qtr to get the index into week processing, no longer hard coded 13 weeks/qtr
        Next llQtr
    Next ilVehicle
    Erase tmVRtg
    Erase tmVCost
    Erase tmVGRP
    Erase tmVGrimp
End Sub

Sub mGetComment(lmOutComment As Long, lmInComment As Long)
    '
    '   1-24-05 test if contract is proposal or order; then print the comment only if "Show" flag
    '           is set to Yes.  Previously, tested to see if testing proposals, order or both.
    Dim ilRet As Integer
    'Setup comment pointers only if show = yes for each applicable comment
    lmOutComment = 0                     'assume no "comment
    tmCxfSrchKey.lCode = lmInComment      'comment  code
    imCxfRecLen = Len(tmCxf)
    ilRet = btrGetEqual(hmCxf, tmCxf, imCxfRecLen, tmCxfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'find matching comment recd
    If ilRet = BTRV_ERR_NONE Then
        If tgChfCT.sStatus = "W" Or tgChfCT.sStatus = "D" Or tgChfCT.sStatus = "C" Or tgChfCT.sStatus = "I" Then        '1-24-05 proposal of some sort
            If tmCxf.sShProp = "Y" Then         'show comment on proposal
                lmOutComment = lmInComment
            End If
        Else                                    'order/hold
            If RptSelCt!lbcRptType.ListIndex = CNT_INSERTION Then
                If tmCxf.sShInsertion <> "N" Then        'show it on Insertion, assume to show if blank or Y to be backwards compatible
                    lmOutComment = lmInComment
                End If
            Else
                If tmCxf.sShOrder = "Y" Then        'show it on order
                    lmOutComment = lmInComment
                End If
            End If
        End If
    End If
End Sub

'***********************************************************************
'*
'*      Procedure Name:mGetSdfProjData
'*      <input> ilvefcode = vehicle code
'*              slStartDate - earliest requested date to gather spots
'*              slEndDate - latest requested date to gather spots
'*              ilFilter - type of selectivity:  0 get all advt, slsp
'*                         1 = selective advt, 2 = selective cntr, 3 = sel slsp
'*                         outer loop is by vehicle selectivity
'*
'*             Created:10/09/93      By:D. LeVine
'*            Modified:              By:
'*
'*            Comments:Obtain the Sdf records to be
'*                     reported
'*
'*      3-10-05 remove reading of SMF , doesn't need it
'*      6-28-07 include NTR retrieval
'***********************************************************************
Sub mGetSdfProjData(ilVefCode As Integer, slStartDate As String, slEndDate As String, ilfilter As Integer)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  ilFound                       slPrice                                                 *
    '******************************************************************************************
    '
    '
    '   where:
    '       ilFilter(I)-0=None; 1=Advt; 2=Contract; 3=Salesperson
    '
    Dim llDate As Long
    Dim ilRet As Integer
    Dim ilExtLen As Integer
    Dim ilOffSet As Integer
    Dim llNoRec As Long
    Dim llRecPos As Long
    Dim ilOk As Integer
    Dim tlIntTypeBuff As POPINTEGERTYPE   'Type field record
    Dim tlDateTypeBuff As POPDATETYPE   'Type field record
    Dim tlLongTypeBuff As POPLCODE      '7-19-04
    Dim illoop As Integer
    Dim ilIndex As Integer
    Dim slSpotAmount As String
    Dim llSpotAmount As Long            '1-18-06
    Dim slSpotOrNTR As String * 1        'A = air time, N = NTR

    If imAirTime Then
        btrExtClear hmSdf   'Clear any previous extend operation
        ilExtLen = Len(tmSdf)
        llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlSdf) 'Obtain number of records
        btrExtClear hmSdf   'Clear any previous extend operation
        tmSdfSrchKey1.iVefCode = ilVefCode
        gPackDate slStartDate, tmSdfSrchKey1.iDate(0), tmSdfSrchKey1.iDate(1)
        tmSdfSrchKey1.iTime(0) = 0
        tmSdfSrchKey1.iTime(1) = 0
        tmSdfSrchKey1.sSchStatus = ""
        ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_END_OF_FILE Then
            If ilRet <> BTRV_ERR_NONE Then
                Exit Sub
            End If
            Call btrExtSetBounds(hmSdf, llNoRec, -1, "UC", "SDF", "") 'Set extract limits (all records)
            tlIntTypeBuff.iType = ilVefCode

            '7-19-04 exclude network spots in the extended read, indicated by the SDFCode having a value
            ilOffSet = gFieldOffset("Sdf", "sdfCode")
            tlLongTypeBuff.lCode = 0
            ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_INT, ilOffSet, 4, BTRV_EXT_GT, BTRV_EXT_AND, tlLongTypeBuff, 4)

            ilOffSet = gFieldOffset("Sdf", "SdfVefCode")
            ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_INT, ilOffSet, 2, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlIntTypeBuff, 2)
            If slStartDate <> "" Then
                gPackDate slStartDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
                ilOffSet = gFieldOffset("Sdf", "SdfDate")
                If slEndDate <> "" Then
                    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_GTE, BTRV_EXT_AND, tlDateTypeBuff, 4)
                Else
                    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_GTE, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)
                End If
            End If
            If slEndDate <> "" Then
                gPackDate slEndDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
                ilOffSet = gFieldOffset("Sdf", "SdfDate")
                ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_LTE, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)
            End If
            ilRet = btrExtAddField(hmSdf, 0, ilExtLen)  'Extract Name
            If ilRet <> BTRV_ERR_NONE Then
                Exit Sub
            End If
            ilRet = btrExtGetNext(hmSdf, tmSdf, ilExtLen, llRecPos)
            If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
                If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                    Exit Sub
                End If
                'ilRet = btrExtGetFirst(hlSdf, tlSdfExt(ilUpper), ilExtLen, llRecPos)
                Do While ilRet = BTRV_ERR_REJECT_COUNT
                    ilRet = btrExtGetNext(hmSdf, tmSdf, ilExtLen, llRecPos)
                Loop
                Do While ilRet = BTRV_ERR_NONE
                    'Build sort key
                    ilOk = True
                    If tmSdf.lChfCode <> tmChf.lCode Then
                        tmChfSrchKey.lCode = tmSdf.lChfCode
                        ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
                    Else
                        ilRet = BTRV_ERR_NONE
                    End If

                    If ilRet <> BTRV_ERR_NONE Then
                        ilOk = False
                    Else
                        slSpotOrNTR = "A"           'air time
                        ilOk = mFilterProjData(tmSdf.iVefCode, ilfilter, slSpotOrNTR, ilIndex)       'test contract types, advt/cntr/slsp selectivity
                    End If

                    If (lmSingleCntr <> 0 And lmSingleCntr <> tmChf.lCntrNo) Then
                        ilOk = False
                    End If

                    If ilOk Then
                        'Determine bucket
                        gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llDate
                        tmClfSrchKey.lChfCode = tmChf.lCode
                        tmClfSrchKey.iLine = tmSdf.iLineNo
                        tmClfSrchKey.iCntRevNo = tmChf.iCntRevNo
                        tmClfSrchKey.iPropVer = tmChf.iPropVer
                        ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                        slSpotAmount = ".00"
                        '3-5-15 insure the line retrieved is the same # as the spot (prevent bad data results when spot is present but line doesnt exist)
                        If tmSdf.sSpotType <> "X" And tmSdf.sSpotType <> "O" And tmSdf.sSpotType <> "C" And tmClf.iLine = tmSdf.iLineNo Then                  'bonus?
                            ilRet = gGetSpotPrice(tmSdf, tmClf, hmCff, hmSmf, hmVef, hmVsf, slSpotAmount)
                            If InStr(slSpotAmount, ".") = 0 Then        'didnot find decimal point
                                slSpotAmount = ".00"
                            End If
                            If (tmSdf.sPriceType = "N") Then
                                slSpotAmount = ".00"
                            ElseIf (tmSdf.sPriceType = "P") Then
                                slSpotAmount = ".00"
                            End If
                        End If
                        
                        llSpotAmount = gStrDecToLong(slSpotAmount, 2)
                        If slSpotAmount <> ".00" Then
                            For illoop = 1 To 13 Step 1
                                If (llDate >= lmSProjDates(illoop)) And (llDate <= lmEProjDates(illoop)) Then
                                    If (tmSdf.sSchStatus = "S") Then                                        'scheduled
                                        tmJsr(ilIndex).lSchDollars(illoop - 1) = tmJsr(ilIndex).lSchDollars(illoop - 1) + llSpotAmount

                                    ElseIf (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then        'mg or outside
                                        '1-08-06 replace the string math with long math
                                        tmJsr(ilIndex).lMGODollars(illoop - 1) = tmJsr(ilIndex).lMGODollars(illoop - 1) + llSpotAmount
                                     ElseIf (tmSdf.sSchStatus = "H" And imHidden) Or (tmSdf.sSchStatus = "M" And imMiss) Or (tmSdf.sSchStatus = "C" And imCancel) Then
                                        '1-18-06 replace the string math with long math
                                        tmJsr(ilIndex).lMCHDollars(illoop - 1) = tmJsr(ilIndex).lMCHDollars(illoop - 1) + llSpotAmount
                                    End If
                                    Exit For
                                End If
                            Next illoop
                        End If
                    End If
                    ilRet = btrExtGetNext(hmSdf, tmSdf, ilExtLen, llRecPos)
                    Do While ilRet = BTRV_ERR_REJECT_COUNT
                        ilRet = btrExtGetNext(hmSdf, tmSdf, ilExtLen, llRecPos)
                    Loop
                Loop
            End If
        End If              'ilRet <> BTRV_ERR_END_OF_FILE
    End If                  'endif AirTime
    DoEvents
End Sub

'               mGoGetCntr - Find a previous version of contract for differ
'               only option (as another version for snapshot)
'
'               <input> contract buffer in tgChfCt & tmchf buffers
'               <output> llPrevSpots - total spots on previous version
'                       ilPrevGross - total gross on previous version
'                       ilCurrTotalsWks - Total weeks on current version
'                       ilCurrAirWks - total airing weeks on current version
'               Return true if contract found
'
'               2/11/00
'
'           3-24-05 chg ilPrevSpots to long for more than 32000 spots
Function mGoGetCntr(llPrevSpots As Long, llPrevGross As Long, ilCurrTotalWks As Integer, ilCurrAirWks As Integer, tlRvf() As RVF, tlVehList() As INSERTINFO, ilWhichSort As Integer, Optional bmUseAcq As Boolean = False) As Integer
    Dim ilRet As Integer
    Dim llCurrCode As Long          'retrieve from tgChfCt.lcode
    Dim llPrevCode As Long
    Dim llDate As Long
    Dim llDate2 As Long
    Dim slStartDate As String
    Dim slEndDate As String
    
    llCurrCode = tgChfCT.lCode
    llPrevCode = 0
    tmChfSrchKey1.lCntrNo = tgChfCT.lCntrNo
    tmChfSrchKey1.iCntRevNo = tgChfCT.iCntRevNo - 1       'look for previous internal rev #
    tmChfSrchKey1.iPropVer = 32000
    ilRet = btrGetGreaterOrEqual(hmTChf, tmTChf, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)
    If tgChfCT.lCntrNo = tmTChf.lCntrNo Then
        llPrevCode = tmTChf.lCode
    End If
    'differences only on this contract required - compare 2 contracts and return differences in the contract
    
    mGenDiff llCurrCode, llPrevCode, llPrevSpots, llPrevGross, ilCurrTotalWks, ilCurrAirWks, bmUseAcq
    '3-19-13 remove and use general routine gChfDAtesToLong
    'mChfDatesToLong llDate, llDate2, slStartDate, slEndDate    'convert contract header start & end dates to long
    gChfDatesToLong tgChfCT.iStartDate(), tgChfCT.iEndDate(), llDate, llDate2, slStartDate, slEndDate   'convert contract header start & end dates to long
    
    mGoGetCntr = m104PlusWks(llDate, llDate2, tlRvf(), tlVehList(), ilWhichSort)        'see if contr with previous version is over 104 weeks
End Function

'                       Billed and Booked subroutine
'                       mBOBLoopOnMonths - Loop and calculate the gross, net &/or commission
'                                   Insert a projected record in GRF or
'                                    a MG record in GRF so that any
'                                    spot moved from one vehicle to another
'                                    will be reflected in the correct vehicle
'                                    if updating as aired
'                       <input> llTempProject - 12 months of projected $ (from
'                                               contract line or MG $
'                               ilCorT - 1 = Cash , 2 = Trade processing, 3 = Hard Costs
'                               llProcessPct - % share of owners or slsp
'                               slPctTrade  - % of trade
'                               slCashAgyComm - agency comm %
'                               slCommPct - slsp % commission (Billed & booked commission report)
'                               slGrossOrNet - G = gross report, N = net report, B = net-net for Vehicle option, T = triple net
'                                               for slsp/vehicle option, or D = net-net for vehicle/participant option
'                               ilHowManyDefined - split transactions (i.e. slsp splits or owners splits)
'                               ilMatchSSCode - Sales Source code
'                               ilDateFlag - 0 = no comparison (base dates vs comparison dates)
'                                            1 = base date
'                                            2 = comparison date
'                               ilNewCode = mnf Revenue area "New" code
'                               ilStartMonth - start month to process   4-4-00, all billed &booked except slsp comm will proces all 12 months at a time
'                                       slsp comm retrieves a possible different  comm percentage for each month
'                                       (if neg, first time thru--initialize buckets)
'                               ilHI - end month to process, after 12th period, insert record in grf
'                               ilCurrMnfGroup - if running partcipant veh group with veh/participant option, use the participant that is associated with the
'                                               split, instead of the first one for the owner
'                               slTradeAgyComm - agy commission for trade for air time or for NTR (NTR could be different than whats defined for airtime)
'                               ilIsItHardCost - true or false
'                               5/7/98 dh - add Show New/Return flag to grf.ipergenl(2)
'
'                               5/10/98 dh - change Billed & booked Commission to keep track of net dollars (vs gross)
'                                            in grf.lDollars(18) so that overage can be computed
'                               4-4-00 dh implement new commission structure where slsp can have different commissions
'                                           based on vehicles by start & end dates
Sub mBOBLoopOnMonth(llTempProject() As Long, llTempAcquisition() As Long, ilCorT As Integer, llProcessPct As Long, slPctTrade As String, slCashAgyComm As String, slCommPct As String, slGrossOrNet As String, ilHowManyDefined As Integer, ilMatchSSCode As Integer, ilDateFlag As Integer, ilNewCode As Integer, ilStartMonth As Integer, ilHi As Integer, tlOnePartAllYear As ONEPARTYEAR, slTradeAgyComm As String)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  ilMonInx                      ilLoopOnVG                                              *
    '******************************************************************************************
    Dim ilTemp As Integer
    Dim slAmount As String
    Dim slSharePct As String
    Dim slStr As String
    Dim slCode As String
    Dim slDollar As String
    Dim slNet As String
    Dim ilRet As Integer
    Dim ilTypes As Integer
    Dim ilmaxTypes As Integer
    Dim ilLo As Integer
    Dim ilOwnerFlag As Integer
    Dim ilIncludeVehicleGroup As Integer

    ilOwnerFlag = False
    If llProcessPct < 0 Then        'if negative value, the % is a participant split and the splits
                                    'comes from the dated participant table
        ilOwnerFlag = True
    End If
    ilLo = ilStartMonth
    If ilLo < 0 Or ilLo = 1 Then            'first time, init buckets (from commissions) or from billed and booked
        For ilTemp = 1 To 18 Step 1             'init the years $ buckets for the contract
            tmGrf.lDollars(ilTemp - 1) = 0
            lgNetDollars(ilTemp) = 0
            lgGrsDollars(ilTemp) = 0            '2-26-01
            lgCommDollars(ilTemp) = 0
        Next ilTemp
        dg12MonthTotal = 0                      'total of 12 months buckets
        dg12MonthAcquisition = 0                '9-20-06
        If ilLo < 0 Then
            ilLo = -ilLo                'get back to positive for loop
        End If
    End If
    For ilTemp = ilLo To ilHi               '4-4-00 loop on # buckets to process.  If Slsp billed & booked comm, only processing one bucket at a time
                            'because each month could have a different slsp comm percent
        If ilOwnerFlag Then          'this must be a participant split
                                        'retrieve the correct % for the dates processing
            llProcessPct = tlOnePartAllYear.iPct(ilTemp)
            llProcessPct = llProcessPct * 100
        End If
        slAmount = gLongToStrDec(llTempProject(ilTemp), 2)
        slSharePct = gLongToStrDec(llProcessPct, 4)                 'slsp or owner split share in %, else 100.0000%
        slStr = gMulStr(slSharePct, slAmount)                       ' gross portion of possible split
        slStr = gRoundStr(slStr, "1", 0)

        '3-20-09 use acqusition costs in the future if requested
        If ilCorT = 1 Or ilCorT = 3 Then                 'all cash commissionable, or hard costs
            slCode = gSubStr("100.", slPctTrade)
            slDollar = gDivStr(gMulStr(slStr, slCode), "100")              'slsp gross
            slDollar = gRoundStr(slDollar, "1", 0)
            slNet = gRoundStr(gDivStr(gMulStr(slDollar, gSubStr("100.00", slCashAgyComm)), "100.00"), ".01", 0)

            If imAdjustAcquisition Then     'if adjusting for barter acquisition amounts, subtract it out (its already a net value)
                'slAmount = gLongToStrDec(llTempAcquisition(ilTemp) * 100, 2)
                slAmount = gLongToStrDec(llTempAcquisition(ilTemp), 2)
                slAmount = (gMulStr(slAmount, "100"))
                slStr = gDivStr(gMulStr(slSharePct, slAmount), "100")
                slStr = gRoundStr(slStr, "1", 0)
                slNet = gSubStr(slNet, slStr)
            End If
            tmGrf.sDateType = "C"
            If ilCorT = 3 Then                          'if hard cost, force to end of report as a separate category to cash & trade
                tmGrf.sDateType = "Z"
            End If
        Else
            If ilCorT = 2 Then                'at least cash is commissionable
                slCode = gIntToStrDec(tgChfCT.iPctTrade, 0)
                slDollar = gDivStr(gMulStr(slStr, slCode), "100")
                slDollar = gRoundStr(slDollar, "1", 0)
                If tgChfCT.iAgfCode > 0 And slTradeAgyComm = "Y" Then

                    slNet = gRoundStr(gDivStr(gMulStr(slDollar, gSubStr("100.00", slCashAgyComm)), "100.00"), "1", 0)
                    If imAdjustAcquisition Then     'if adjusting for barter acquisition amounts, subtract it out (its already a net value)
                        slAmount = gLongToStrDec(llTempAcquisition(ilTemp) * 100, 2)
                        slStr = gDivStr(gMulStr(slSharePct, slAmount), "100")
                        slStr = gRoundStr(slStr, "1", 0)
                        slNet = gSubStr(slNet, slStr)
                    End If
                Else
                    slNet = slDollar    'no commission , net is same as gross
                    If imAdjustAcquisition Then     'if adjusting for barter acquisition amounts, subtract it out (its already a net value)
                        slAmount = gLongToStrDec(llTempAcquisition(ilTemp) * 100, 2)
                        slStr = gDivStr(gMulStr(slSharePct, slAmount), "100")
                        slStr = gRoundStr(slStr, "1", 0)
                        slNet = gSubStr(slNet, slStr)
                    End If
                End If
                tmGrf.sDateType = "T"
            End If
        End If

        If igRptCallType = SLSPCOMMSJOB Then
            'Accum to Orders on the books before destroying that field
            If lmSlfDiffComm = 0 And llProcessPct > 0 Then
                'dont accum gross & net if the rev split % is 0.  slsp doesnt get rev but does get comm.
            Else
                'tmGrf.lDollars(ilTemp) = tmGrf.lDollars(ilTemp) + Val(slDollar)
                lgGrsDollars(ilTemp) = lgGrsDollars(ilTemp) + Val(slDollar)      '2-26-01
                lgNetDollars(ilTemp) = lgNetDollars(ilTemp) + Val(slNet)
            End If
            dg12MonthTotal = dg12MonthTotal + Val(slDollar)     'accum the years total
            dg12MonthAcquisition = dg12MonthAcquisition + Val(slNet)    'Val(slDollar)  '9-20-06 accum total acquisition $
            
            slDollar = slNet                    'put back the net into temp field to calc the net comm $
            slNet = gRoundStr(gDivStr(gMulStr(slDollar, slCommPct), "100.00"), ".01", 0)   'Mult slsp comm * $, then round
            lgCommDollars(ilTemp) = lgCommDollars(ilTemp) + Val(slNet)
        Else                                'normal billed & booked
            If slGrossOrNet = "G" Then
                tmGrf.lDollars(ilTemp - 1) = tmGrf.lDollars(ilTemp - 1) + Val(slDollar)
                dg12MonthTotal = dg12MonthTotal + Val(slDollar)     'accum the years total
                dg12MonthAcquisition = dg12MonthAcquisition + Val(slDollar)  '9-20-06 accum total acquisition $
            ElseIf slGrossOrNet = "N" Then          '2-26-01
                lgNetDollars(ilTemp) = lgNetDollars(ilTemp) + Val(slNet)
                dg12MonthTotal = dg12MonthTotal + Val(slNet)        'accum the years total
                dg12MonthAcquisition = dg12MonthAcquisition + Val(slNet)  '9-20-06 accum total acquisition $
            ElseIf slGrossOrNet = "B" Then                           '2-26-01 net net option on Vehicle option
                tmGrf.lDollars(ilTemp - 1) = tmGrf.lDollars(ilTemp - 1) + Val(slDollar)
                lgNetDollars(ilTemp) = lgNetDollars(ilTemp) + Val(slNet)
                lgGrsDollars(ilTemp) = lgGrsDollars(ilTemp) + Val(slDollar)
                dg12MonthTotal = dg12MonthTotal + Val(slNet)        'accum the years total
                dg12MonthAcquisition = dg12MonthAcquisition + Val(slNet)  '9-20-06 accum total acquisition $
                'need to create extra record to maintain the varying months of different participant %
                lgCommDollars(ilTemp) = tlOnePartAllYear.iPct(ilTemp)           'maintain the owner pct (not dollars)

                '5-11-09 if VEhicle/Gross Net option, when there is an owner change, it cannot show the gross $ for each month of
                'for each owner.
                If tlOnePartAllYear.iPct(ilTemp) = 0 Then
                    lgNetDollars(ilTemp) = 0
                    lgGrsDollars(ilTemp) = 0
                End If
            Else                                                    'either net net on vehicle/participant or slsp option
                lgNetDollars(ilTemp) = lgNetDollars(ilTemp) + Val(slNet)
                dg12MonthTotal = dg12MonthTotal + Val(slNet)        'accum the years total
                dg12MonthAcquisition = dg12MonthAcquisition + Val(slNet)  '9-20-06 accum total acquisition $
            End If
        End If
    Next ilTemp

    '4-4-00 if the 12th bucket completed, write out the record for year
    If ilTemp = igPeriods + 1 Then      'end of all buckets, write out record
        'contract complete for cash and or trade values, write out contract
        tmGrf.iGenDate(0) = igNowDate(0)        'todays date used for retrieval/removal of records
        tmGrf.iGenDate(1) = igNowDate(1)
        gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
        tmGrf.lGenTime = lgNowTime
        tmGrf.iPerGenl(12) = 0                  'flag to indicate data from contracts (vs budget info for B & B Comparison)
        tmGrf.sBktType = "C"                    'flag this as a contract recd (vs history, recv. or projection)
        tmGrf.lChfCode = tgChfCT.lCode            'contr internal code
        tmGrf.iAdfCode = tgChfCT.iAdfCode
        tmGrf.iPerGenl(0) = ilDateFlag
        tmGrf.iPerGenl(14) = 0                  '4-11-16 flag to indicate vehicle option with participant vg (different than with other VG options
                                                'because this particpant option doesnt split and uses 100% for owner)
        If ilHowManyDefined > 1 Then                   'this line or contracthas split slsp or owners
            tmGrf.iYear = 1                     'this transaction is a split slsp or owner
        Else
            tmGrf.iYear = 0                     'this trans. is not a split slsp or owner
        End If
        tmGrf.iSofCode = ilMatchSSCode              'sales source

        ilIncludeVehicleGroup = True
        '8-6-10 vehicle w/split slsp subtotals swapped to do slsp w/vehicle subtotals.
        'need to get the vehicle group if application
        If imVehicle Or imTrikIfOwner Or igSwapBOBOption Or (imMinorSet > 0 Or imMajorSet > 0) Then      '5-18-11 subsort may be by a vehicle group
            gGetVehGrpSets tmGrf.iVefCode, imMinorSet, imMajorSet, tmGrf.iPerGenl(2), tmGrf.iPerGenl(3)   'Genl(3) = minor sort code, genl(4) = major sort code
            '8-8-00 if vehicle sort, if NONE selected, distinguish between NONE a vehicle that doesnt have a vehicle group defined while running in Crystal
            If imMinorSet = 0 Then
                tmGrf.iPerGenl(2) = -1
            End If
            If imMajorSet = 0 Then
                tmGrf.iPerGenl(3) = -1
            End If
            If imMajorSet = 1 And imTrikIfOwner Or (imVehicle And smGrossOrNet = "B" And imMajorSet = 1) Then  '5-11-09
                If tlOnePartAllYear.iMnfGroup <> 0 Then
                    tmGrf.iPerGenl(3) = tlOnePartAllYear.iMnfGroup  '4-5-16 handle case were sales source not defined with vehicle; include so things balance
                Else
                    tmGrf.iPerGenl(3) = 0                           '4-14-16 no participant exists for sales source
                End If
                If imMajorSet = 1 And imTrikIfOwner And imVehicle = True Then   '4-11-16    Show different header on Report (indicate vg participant option)
                    tmGrf.iPerGenl(14) = -1
                End If
            End If
            If tmGrf.iPerGenl(2) > 0 Or tmGrf.iPerGenl(3) > 0 Then          '4-14-16
                ilIncludeVehicleGroup = mTestVGItem()
            End If
        End If

        '4-26-13 test for option to include $0 contracts (currently only b&b has option)
        If ((dg12MonthTotal > 0) Or (dg12MonthAcquisition <> 0) Or (dg12MonthTotal = 0 And imInclZero)) And (ilIncludeVehicleGroup = True) Then                       'if all zeros don't write it out
            tmGrf.iPerGenl(1) = mBobTestNew(ilNewCode, tgChfCT)      'New/Return flag to show on report:  0 = show nothing (probably return),
                                       '1 = New (show N), 2 = New Hold (show h), 3 = Return Hold ( show H)
            If igRptCallType = SLSPCOMMSJOB Then
                ilmaxTypes = 3                      'process 3 types of records:  orders on books, net, & commission
            Else
                If smGrossOrNet = "B" Then          '2-26-01  Test for net-net
                    ilmaxTypes = 3                  'create both Gross & Net records & owners share
                Else
                    ilmaxTypes = 1                     'process on the gross or net orders on books
                End If
            End If
            For ilTypes = 1 To ilmaxTypes             'process 3 times if slsp commission:  1 = orders on books,
                            '2 = net, 3 = commission.  If not slsp comm, process once for orders on books
                'if iltype = 1 and ilMaxTypes <> 1 (slsp comm), then the orders on books values are already in tmGRF array  (which should be gross values)
                If ilTypes = 1 And ilmaxTypes = 1 Then   'process orders on books (gross or net)
                    'If slGrossOrNet = "N" Or slGrossOrNet = "T" Or slGrossOrNet = "D" Then      'put net values into common GRF array
                    If slGrossOrNet = "N" Or slGrossOrNet = "T" Then       'put net values into common GRF array
                        For ilTemp = 1 To 18
                            tmGrf.lDollars(ilTemp - 1) = lgNetDollars(ilTemp)
                        Next ilTemp
                    End If
                ElseIf ilTypes = 1 And ilmaxTypes <> 1 Then     '2-26-01
                    'processing for salesp commissions: Orders on the books (net)
                    For ilTemp = 1 To 18
                        tmGrf.lDollars(ilTemp - 1) = lgGrsDollars(ilTemp)
                    Next ilTemp
                ElseIf ilTypes = 2 Then      'process net
                    'processing for salesp commissions: Orders on the books (net)
                    For ilTemp = 1 To 18
                        tmGrf.lDollars(ilTemp - 1) = lgNetDollars(ilTemp)
                    Next ilTemp
                ElseIf ilTypes = 3 Then      'process comm
                    'processing for salesp commissions
                    For ilTemp = 1 To 18
                        tmGrf.lDollars(ilTemp - 1) = lgCommDollars(ilTemp)
                    Next ilTemp
                End If
                For ilTemp = 1 To 12 Step 1
                    'round the 12 values
                    slAmount = gLongToStrDec(tmGrf.lDollars(ilTemp - 1), 2)
                    slAmount = gMulStr("100", slAmount)                       ' gross portion of possible split
                    tmGrf.lDollars(ilTemp - 1) = Val(slAmount)
                Next ilTemp
                tmGrf.iPerGenl(4) = ilTypes                     'update for sorting of Slsp comm rept
                ilRet = btrInsert(hmGrf, tmGrf, imGrfRecLen, INDEXKEY0)
            Next ilTypes
        End If
    End If
End Sub

'******************************************************************************
'                   mBobGetHowManyFuture - Obtain the number of slsp or owner
'                                   splits to calculate.  There can be
'                                   a maximum of 10 slsp splits, or
'                                   8 owner (participant) splits.
'                                   Called in billed and booked report
'                   <input>  ilMatchSSCode - for ownership report- find matching
'                                   sales source in the vehicle
'                   <output> ilHowMany - total number of splits there can possibly be
'                                   (for owner always 8, for slsp its the number with
'                                   commission split percent defined, all others its 1)
'                           ilHowManyDefined - total number of splits actually having
'                                   values (for slsp defaults to 1 if not defined and
'                                   he gets 100%; for owner the number is that found
'                                   with the matching sales source; all others its 0)
'                           ilSlfCode() - slsp codes to gather splits for
'                           llSlfCode() - slsp splits percentages for each slsp to process
'
'      Created:  DH 3/97
'      4-20-00 New commission structure by vehicle & slsp & date
'      8-4-00 Option to split participants for vehicle option
'      4-5-01 DH Obtain participants share % for net-net version
'
'******************************************************************************
Sub mBobGetHowManyFuture(ilVefCode As Integer, ilHowMany As Integer, ilHowManyDefined As Integer, ilMatchSSCode As Integer, ilSlfCode() As Integer, llSlfSplit() As Long, llStdStartDates() As Long)   '8-4-00
    Dim illoop As Integer
    Dim ilRet As Integer
    Dim ilFound As Integer

    ilFound = gInitVehAllYearPcts(ilMatchSSCode, ilVefCode, tmCntAllYear(), tmOneVehAllYear()) 'only those participants for the contracts matching SS have
                                    'been built into the tmCntAllYear array.  Each entry is for a different participant of the sales source
    If Not ilFound Then     'no matching vehicle found,must be a mg or outside vehicle that is not on the contract
         gGetOneVehAllYearForMG ilVefCode, llStdStartDates(), ilMatchSSCode, tmPifKey(), tmPifPct(), tmCntAllYear()
        ilFound = gInitVehAllYearPcts(ilMatchSSCode, ilVefCode, tmCntAllYear(), tmOneVehAllYear()) 'only those participants for the contracts matching SS have
        If Not ilFound Then         'force to 100%
            tmOneVehAllYear(0).AllYear.iVefCode = ilVefCode
            tmOneVehAllYear(0).AllYear.iSSMnfCode = ilMatchSSCode
            For illoop = 1 To 12
                tmOneVehAllYear(0).AllYear.iPct(illoop) = 10000
            Next illoop
            tmOneVehAllYear(0).AllYear.iMnfGroup = 0        'unknown participant
        End If
   End If

    If imSlsp Then                              'slsp option, see if slsp splits and how many
        If igRptCallType = CONTRACTSJOB And RptSelCt!lbcRptType.ListIndex = CNT_BOB And RptSelCt!ckcSelC10(0).Value = vbUnchecked Then  '8-8-06 Use primary only has been changed to Show splits (meaning of question has changed)
            'Billed and Booked report by slsp does not want any slsp splits (as option)
            tgChfCT.lComm(0) = 1000000
            ilHowMany = 1
            ilHowManyDefined = 1
            For illoop = 1 To 9 Step 1
                tgChfCT.iSlfCode(illoop) = 0          'fake out the cnt so it doesnt have split slsp
                tgChfCT.lComm(illoop) = 0
                tgChfCT.iMnfSubCmpy(illoop) = 0       '4-20-00
            Next illoop
            '4-20-00
            For illoop = 0 To 9
                ilSlfCode(illoop) = tgChfCT.iSlfCode(illoop)
                llSlfSplit(illoop) = tgChfCT.lComm(illoop)
            Next illoop
        ElseIf igRptCallType = SLSPCOMMSJOB Then        '4-20-00
            For illoop = 0 To 9 Step 1
                If ilSlfCode(illoop) > 0 Then
                    ilHowMany = ilHowMany + 1
                End If
            Next illoop
            If ilHowMany = 1 And llSlfSplit(0) = 0 Then                       'theres only 1 slsp
               llSlfSplit(0) = 1000000                'xxx.xxxx
            Else
                If ilHowMany > 1 Then                   'found more than 1 slsp defined:
                    ilHowMany = 10                       'force do process all 10, some in themiddle may not be used (ABC stuff)
                End If
            End If
            ilHowManyDefined = ilHowMany
        Else                                            'Sales Comparison by slsp, B & B comparison always split slsp
            For illoop = 0 To 9 Step 1
                If ilSlfCode(illoop) > 0 Then
                    ilHowMany = ilHowMany + 1
                End If
            Next illoop
            If ilHowMany = 1 And llSlfSplit(0) = 0 Then                       'theres only 1 slsp
                llSlfSplit(0) = 1000000                'xxx.xxxx
            Else
                If ilHowMany > 1 Then                   'found more than 1 slsp defined:
                    ilHowMany = 10                       'force do process all 10, some in themiddle may not be used (ABC stuff)
                End If
            End If
            ilHowManyDefined = ilHowMany
        End If
    '4-5-01 get participants rev share for net-net option
    ElseIf imOwner Or imTrikIfOwner Or (imVehicle And smGrossOrNet = "B") Then           '8-4-00 owner, get the vehicle groups associated with the vehicle
        'get the vehicle for this transaction
        ilHowManyDefined = UBound(tmOneVehAllYear)
        ilHowMany = UBound(tmOneVehAllYear)
    Else
        ilHowMany = 1
    End If
End Sub

Function mOpenBRFiles() As Integer
    Dim ilRet As Integer
    Dim ilValue As Integer
    mOpenBRFiles = 0                        'assume no Open File errors

    hmCHF = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCHF, "", sgDBPath & "Chf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        'ilRet = btrClose(hmCHF)
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imCHFRecLen = Len(tmChf)
    ReDim tgClfCT(0 To 0) As CLFLIST
    tgClfCT(0).iStatus = -1 'Not Used
    tgClfCT(0).lRecPos = 0
    tgClfCT(0).iFirstCff = -1
    ReDim tgCffCT(0 To 0) As CFFLIST
    tgCffCT(0).iStatus = -1 'Not Used
    tgCffCT(0).lRecPos = 0
    tgCffCT(0).iNextCff = -1
    hmClf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmClf, "", sgDBPath & "Clf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imClfRecLen = Len(tgClfCT(0).ClfRec)
    hmCff = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCff, "", sgDBPath & "Cff.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imCffRecLen = Len(tgCffCT(0).CffRec)
    hmAdf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmAdf, "", sgDBPath & "Adf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imAdfRecLen = Len(tmAdf)
    hmAnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmAnf, "", sgDBPath & "Anf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imAnfRecLen = Len(tmAnf)
    hmAgf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmAgf, "", sgDBPath & "Agf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imAgfRecLen = Len(tmAgf)
    hmAnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmAnf, "", sgDBPath & "Anf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imAnfRecLen = Len(tmAnf)
    hmRdf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmRdf, "", sgDBPath & "Rdf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imRdfRecLen = Len(tmRdf)
    hmDnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmDnf, "", sgDBPath & "Dnf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imDnfRecLen = Len(tmDnf)
    hmSlf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSlf, "", sgDBPath & "Slf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imSlfRecLen = Len(tmSlf)
    hmMnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmMnf, "", sgDBPath & "Mnf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imMnfRecLen = Len(tmMnf)
    hmUrf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmUrf, "", sgDBPath & "Urf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imUrfRecLen = Len(tmUrf)
    hmSof = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSof, "", sgDBPath & "Sof.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imSofRecLen = Len(tmSof)
    hmCbf = CBtrvTable(TEMPHANDLE)  '(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCbf, "", sgDBPath & "Cbf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imCbfRecLen = Len(tmCbf)
    hmCxf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCxf, "", sgDBPath & "Cxf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imCxfRecLen = Len(tmCxf)
    hmDrf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmDrf, "", sgDBPath & "Drf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imDrfRecLen = Len(tmDrf)
    hmDpf = CBtrvTable(ONEHANDLE) 'CBtrvObj()      '7-23-01
    ilRet = btrOpen(hmDpf, "", sgDBPath & "Dpf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    imDpfRecLen = Len(tmDpf)
    hmDef = CBtrvTable(ONEHANDLE) 'CBtrvObj()      '7-23-01
    ilRet = btrOpen(hmDef, "", sgDBPath & "Def.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    hmTChf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmTChf, "", sgDBPath & "Chf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    hmVsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVsf, "", sgDBPath & "Vsf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    hmSbf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSbf, "", sgDBPath & "Sbf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    '4-23-13 moved from processing for split networks, always open for the demo names to create the string of books names for packages when different across hidden lines
    hmTxr = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmTxr, "", sgDBPath & "Txr.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        mCloseBRGenFiles
        mOpenBRFiles = 1
        Exit Function
    End If
    If ((Asc(tgSpf.sUsingFeatures3) And TAXONAIRTIME) = TAXONAIRTIME) Or ((Asc(tgSpf.sUsingFeatures3) And TAXONNTR) = TAXONNTR) Then
        hmRvf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmRvf, "", sgDBPath & "Rvf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            mCloseBRGenFiles
            mOpenBRFiles = 1
            Exit Function
        End If

        hmPhf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmPhf, "", sgDBPath & "Phf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            mOpenBRFiles = 1
            Exit Function
        End If
        ilRet = gObtainTrf()
        If Not ilRet Then
            mCloseBRGenFiles
            mOpenBRFiles = 1
            Exit Function
        End If
    End If

    ilValue = Asc(tgSpf.sSportInfo)
    If (ilValue And USINGSPORTS) = USINGSPORTS Then 'Using Sports, open game files
        hmCgf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmCgf, "", sgDBPath & "Cgf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            mCloseBRGenFiles
            mOpenBRFiles = 1
            Exit Function
        End If
        imCgfRecLen = Len(tmCgf)

        hmGsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmGsf, "", sgDBPath & "GSf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            mCloseBRGenFiles
            mOpenBRFiles = 1
            Exit Function
        End If
        imGsfRecLen = Len(tmGsf)
    End If

    imUsingBarters = False
    If RptSelCt!lbcRptType.ListIndex = CNT_INSERTION Then
        imUsingBarters = gUsingBarters()
        If imUsingBarters Then
            hmVbf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
            ilRet = btrOpen(hmVbf, "", sgDBPath & "Vbf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
            If ilRet <> BTRV_ERR_NONE Then
                mCloseBRGenFiles
                mOpenBRFiles = 1
                Exit Function
            End If
            imVBfRecLen = Len(tmVbf)
        End If
    End If
    
    ilValue = Asc(tgSaf(0).sFeatures8)
    If ((ilValue And PODCASTCPMTAG) = PODCASTCPMTAG) Or ((ilValue And PODCASTCPMTAG) = PODCASTCPMTAG) Then   'using cpm podcasts
        'open  podcast cpm file
        hmPcf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmPcf, "", sgDBPath & "Pcf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            mOpenBRFiles = -1
        End If
    End If

    If ((Asc(tgSpf.sUsingFeatures2) And SPLITNETWORKS) <> SPLITNETWORKS) Then
        If ((Asc(tgSaf(0).sFeatures4) And MKTNAMEONBR) = MKTNAMEONBR) Then      '8-9-18 build stations and markets when not using split networks and using show mktname on contract
            ilRet = gObtainAllStations()
            ilRet = gObtainMarkets()
        End If
        Exit Function
    Else
        'open the necessary split network files
        hmRaf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmRaf, "", sgDBPath & "Raf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            mCloseBRGenFiles
            mOpenBRFiles = 1
       End If

        hmSef = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmSef, "", sgDBPath & "Sef.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            mCloseBRGenFiles
            mOpenBRFiles = 1
        End If
        
        hmShf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmShf, "", sgDBPath & "Shtt.mkd", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            mCloseBRGenFiles
            mOpenBRFiles = 1
        End If

        hmMkt = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmMkt, "", sgDBPath & "Mkt.mkd", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            mCloseBRGenFiles
            mOpenBRFiles = 1
        End If
        
                
        If ((Asc(tgSaf(0).sFeatures4) And MKTNAMEONBR) = MKTNAMEONBR) Then      '2-22-18 build stations and markets
            ilRet = gObtainAllStations()
            ilRet = gObtainMarkets()
        End If

        hmVLF = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmVLF, "", sgDBPath & "Vlf.btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            mCloseBRGenFiles
            mOpenBRFiles = 1
        End If

        hmAtt = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmAtt, "", sgDBPath & "Att.mkd", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            mCloseBRGenFiles
            mOpenBRFiles = 1
       End If
    End If
End Function

'       mPutCntWkGrps - Store the overall weekly contract grps into
'               all detail lines, built and stored into tmWkCntGrps
'       2-18-00
Sub mPutCntWkGrps(ilQtr As Integer)
    Dim illoop As Integer
    Dim ilWeekInx As Integer
    Dim ilVehicle As Integer
    Dim ilFound As Integer
    
    ilFound = False
    If tmClf.sType = "H" Then       '2-20-00hidden lines have their own weekly grp totals because
        For ilVehicle = LBound(tmWkHiddenVGrps) To UBound(tmWkHiddenVGrps) - 1
            'If tmClf.iLine = tmWkHiddenVGrps(ilVehicle).iVefCode Then   'line # is stored in palce of vehicle in the weekly grp array
            '1-24-03
            If tmClf.iVefCode = tmWkHiddenVGrps(ilVehicle).iVefCode And tmClf.iPkLineNo = tmWkHiddenVGrps(ilVehicle).iPkLineNo Then   'line # is stored in palce of vehicle in the weekly grp array
                ilFound = True
                Exit For
            End If
        Next ilVehicle 'they are not combined with other lines for the same vehicle
    ElseIf tmClf.sType = "S" Then
        For ilVehicle = LBound(tmWkCntVGrps) To UBound(tmWkCntVGrps) - 1
            If tmCbf.iVefCode = tmWkCntVGrps(ilVehicle).iVefCode Then
                ilFound = True
                Exit For
            End If
        Next ilVehicle
    Else
        'For ilVehicle = 1 To UBound(tmWkPkgVGrps) - 1
        For ilVehicle = LBound(tmWkPkgVGrps) To UBound(tmWkPkgVGrps) - 1
            If tmClf.iLine = tmWkPkgVGrps(ilVehicle).iVefCode Then  'get the matching package grps from array
                ilFound = True
                Exit For
            End If
        Next ilVehicle
    End If

    ilWeekInx = 0           '11-14-11 handle varying qtrs
    For illoop = 1 To ilQtr - 1
        ilWeekInx = ilWeekInx + imWeeksPerQtr(illoop)
    Next illoop
    ilWeekInx = ilWeekInx + 1

    For illoop = 1 To imWeeksPerQtr(ilQtr)
        ''tmCbf.lWkCntGrp(ilLoop) = tmWkCntGrps(1).lGrps(ilWeekInx + ilLoop - 1)  'only 1 array for the contract weekly totals
        'tmCbf.lWkCntGrp(ilLoop) = tmWkCntGrps(0).lGrps(ilWeekInx + ilLoop - 1)  'only 1 array for the contract weekly totals
        tmCbf.lWkCntGrp(illoop - 1) = tmWkCntGrps(0).lGrps(ilWeekInx + illoop - 1) 'only 1 array for the contract weekly totals
        If ilFound Then
            If tmClf.sType = "H" Then
                tmCbf.lWkVehGrp(illoop - 1) = tmWkHiddenVGrps(ilVehicle).lGrps(ilWeekInx + illoop - 1)
            ElseIf tmClf.sType = "S" Then
                tmCbf.lWkVehGrp(illoop - 1) = tmWkCntVGrps(ilVehicle).lGrps(ilWeekInx + illoop - 1)
            Else
                tmCbf.lWkVehGrp(illoop - 1) = tmWkPkgVGrps(ilVehicle).lGrps(ilWeekInx + illoop - 1)
            End If
        Else
            tmCbf.lWkVehGrp(illoop - 1) = 0
        End If
    Next illoop
    If illoop = 13 And imWeeksPerQtr(ilQtr) = 13 Then       '11-14-11 if processing 13th week in qtr, clear out the 14th week if
        tmCbf.lWkVehGrp(13) = 0         'initialize 14th bucket when only 13 weeks exist in qtr
    ElseIf illoop = 12 And imWeeksPerQtr(ilQtr) = 12 Then        'very rare occurence when qtr is 12 weeks
        tmCbf.lWkVehGrp(12) = 0
        tmCbf.lWkVehGrp(13) = 0
    End If
End Sub

'               Move in common data into Research arrays
'
'               mRchSameData  ilIndex, llCost
'               <input>  llIndex - 4-11-19 chg to long, index into Research array
'                        llCost - total cost of period
'                        llPopEst - estimated subscribers (population) for satellite research
Sub mRchSameData(llIndex As Long, llCost As Long)
    tmLRch(llIndex).dTotalCost = llCost 'TTP 10439 - Rerate 21,000,000
    tmLRch(llIndex).lTotalCPP = tmCbf.lCPP
    tmLRch(llIndex).lTotalCPM = tmCbf.lCPM
    tmLRch(llIndex).lTotalGRP = tmCbf.lGRP
    tmLRch(llIndex).lTotalGrimps = tmCbf.lGrImp
    tmLRch(llIndex).iTotalAvgRating = tmCbf.iAvgRate
    tmLRch(llIndex).lTotalAvgAud = tmCbf.lAvgAud
    ReDim Preserve tmLRch(LBound(tmLRch) To UBound(tmLRch) + 1)
End Sub

'                   mSetupBrHdr - Read advertiser, agency and salesperson records once per contract
'                       and place into the tmCBF (prepass record)
'
'                   <input> ilwhichsort - 0 = sort by advt, 1 = agy, 2 = slsp
Sub mSetupBrHdr(ilWhichSort As Integer)
    Dim ilRet As Integer
    'Build the advertiser, agency, slsp, and sort fields specifications that need to be built
    'only once per contract.
    '
    tmCbf.iAdfCode = tgChfCT.iAdfCode
    tmAdfSrchKey.iCode = tgChfCT.iAdfCode
    ilRet = btrGetEqual(hmAdf, tmAdf, imAdfRecLen, tmAdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'find matching advt recd
    If ilRet <> BTRV_ERR_NONE Then
        tmAdf.sName = "Missing"
        tmCbf.iAdfCode = 0
    End If
    If tgChfCT.iAgfCode > 0 Then                          'contract has an agency
        tmCbf.iAgfCode = tgChfCT.iAgfCode
        tmAgfSrchKey.iCode = tgChfCT.iAgfCode
        ilRet = btrGetEqual(hmAgf, tmAgf, imAgfRecLen, tmAgfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'get matching agency recd
        If ilRet <> BTRV_ERR_NONE Then
            tmAgf.sName = "Missing"
            tmCbf.iAgfCode = 0
        End If
    End If
    '10/27/14: set 1 or 2 place rating
    sm1or2PlaceRating = gSet1or2PlaceRating(tgChfCT.iAgfCode)

    If tgChfCT.iSlfCode(0) > 0 Then
        tmCbf.iSlfCode = tgChfCT.iSlfCode(0)
        tmSlfSrchKey.iCode = tgChfCT.iSlfCode(0)
        ilRet = btrGetEqual(hmSlf, tmSlf, imSlfRecLen, tmSlfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'find matching Slsp recd
        If ilRet <> BTRV_ERR_NONE Then
            tmSlf.sFirstName = "Mising"
            tmSlf.sLastName = "Missing"
            tmCbf.iSlfCode = 0
        End If
    End If
    
    If ilWhichSort = 0 Then                               '1-7-21 advt/cont sort
        tmCbf.sSortField1 = ""
        tmCbf.sSortField2 = ""
    ElseIf ilWhichSort = 1 Then                           '1-7-21 agy
        If tgChfCT.iAgfCode > 0 Then                      'has an agy (vs. direct)
            tmCbf.sSortField1 = tmAgf.sName
        Else
            tmCbf.sSortField1 = tmAdf.sName             'direct
        End If
        tmCbf.sSortField2 = tmAdf.sName
    Else                                                'salesperson
        tmCbf.sSortField1 = tmSlf.sFirstName & "" & tmSlf.sLastName
        tmCbf.sSortField2 = ""
    End If
    'format all fields that need to be retrieved from CHF and
    'place into CBF so that snapshot will work since there is
    'no actual contract written to disk
    tmCbf.iPropVer = tgChfCT.iPropVer
    tmCbf.iCntRevNo = tgChfCT.iCntRevNo
    tmCbf.iExtRevNo = tgChfCT.iExtRevNo
    tmCbf.sStatus = tgChfCT.sStatus
    If (Asc(tgSaf(0).sFeatures6) And SIGNATUREONPROPOSAL) = SIGNATUREONPROPOSAL Then 'Print signature line on proposals      '6-14-19 if feature set to show signature line on Proposals, set falg
                                                                    'the field cbfdrfcode isnt used in crystal
        tmCbf.lDrfCode = 1              'show  signature line on working
    Else
        tmCbf.lDrfCode = 0              'do not show signature line except on the orders and complete prop
    End If

    tmCbf.sProduct = tgChfCT.sProduct
    tmCbf.iStartDate(0) = tgChfCT.iStartDate(0)
    tmCbf.iStartDate(1) = tgChfCT.iStartDate(1)
    tmCbf.iEndDate(0) = tgChfCT.iEndDate(0)
    tmCbf.iEndDate(1) = tgChfCT.iEndDate(1)
    tmCbf.iPctTrade = tgChfCT.iPctTrade
    tmCbf.sAgyCTrade = tgChfCT.sAgyCTrade
    tmCbf.lContrNo = tgChfCT.lCntrNo
    If tgChfCT.sStatus = "H" Or tgChfCT.sStatus = "O" Or tgChfCT.sStatus = "G" Or tgChfCT.sStatus = "N" Then
        tmCbf.iPropOrdDate(0) = tgChfCT.iOHDDate(0)
        tmCbf.iPropOrdDate(1) = tgChfCT.iOHDDate(1)
        tmCbf.iPropOrdTime(0) = tgChfCT.iOHDTime(0)
        tmCbf.iPropOrdTime(1) = tgChfCT.iOHDTime(1)
    Else
        tmCbf.iPropOrdDate(0) = tgChfCT.iPropDate(0)
        tmCbf.iPropOrdDate(1) = tgChfCT.iPropDate(1)
        tmCbf.iPropOrdTime(0) = tgChfCT.iPropTime(0)
        tmCbf.iPropOrdTime(1) = tgChfCT.iPropTime(1)
    End If
    
    tmCbf.lGenTime = lgNowTime
    tmCbf.iGenDate(0) = igNowDate(0)
    tmCbf.iGenDate(1) = igNowDate(1)
    '2-16-13 Update the user ID into the record to filter along with gendate and time
    tmCbf.iUrfCode = tgUrf(0).iCode
    tmCbf.lChfCode = tgChfCT.lCode                'contract internal code
    
    tmCbf.sType = ""
    If bmUseAcq Then
        tmCbf.sType = "A"
    End If

    If imDiffExceeds104Wks Then             '3-9-06 this difference only exceeds 104 weeks.  its an old contract with
                                           'an invalid end date
        tmCbf.sSurvey = "Incomplete: exceeds 104+ weeks"
    End If
End Sub

'           mTieOutRvfOrder - Build TiOut entry in Table from the
'           Contract Line or from the Receivables (PHF/RVF)
'           <InPut> ilTY - true if this years date, else false
'                   ilTieOutIndex - entry into TieOut Array to accum data
'                   ilThisOffice - Primary office of contract
'                   tlSlf() - array of slsp records to determine selling offices
'                               from the slsp code
'           <output> llProject - array to build $ into for the 12 months
'           4-20-00 use revenue share for the matching sub-co of the vehicle and matching slsp
Sub mTieOutRvfOrder(ilTY As Integer, ilTieOutIndex As Integer, ilThisOffice As Integer, ilmnfNewBus As Integer, llProject() As Long, tlSlf() As SLF, ilVehicle As Integer)
    Dim ilTemp As Integer
    Dim illoop As Integer
    Dim ilCode As Integer
    Dim ilSplitInInx As Integer
    Dim llCommPct As Long
    Dim ilMnfSubCo As Integer
    '4-20-00 Obtain the vehicles sub-company if applicable and gather only those slsp in the heading that matches that sub-company
    ReDim llSlfSplit(0 To 9) As Long           '4-12-00 slsp rev share %
    ReDim ilSlfCode(0 To 9) As Integer         '4-12-00
    ReDim llSlfSplitRev(0 To 9) As Long         '2-2-04 unused in this report (need for subroutine)

    ilMnfSubCo = gGetSubCmpy(tgChfCT, ilSlfCode(), llSlfSplit(), ilVehicle, False, llSlfSplitRev())
    'Find the vehicle or office this record should be added to
    llCommPct = 1000000                             '(100.0000) assume everything goes for the 100%, no splits
    ilTemp = 0                                   'find out how many slsp belong to this contr
    For illoop = 0 To 9
        If ilSlfCode(illoop) > 0 Then
            ilTemp = ilTemp + 1
        End If
    Next illoop
    If llSlfSplit(0) = 0 And ilTemp = 1 Then    'if no comm defined and only 1 slsp (means no splits)
        llSlfSplit(0) = 1000000
    End If
    If (ilTY) Then                    'this years stuff
        For illoop = 0 To 4 Step 1                          'find new business only
            If tgChfCT.iMnfRevSet(illoop) = ilmnfNewBus And tgChfCT.iMnfRevSet(illoop) <> 0 Then   '(lNewBus)
                mAddTieOut llProject(), tmTieOut(ilTieOutIndex).lTYNewBus(), llCommPct
            End If
        Next illoop
        'Do splits if office option
        If RptSelCt!rbcSelCInclude(0).Value Then                  'office option
            mAddTieOut llProject(), tmTieOut(ilTieOutIndex).lTYOrders(), llCommPct
            If llSlfSplit(0) <> 1000000 Then               'first slsp does not have 100% of the order
                                                            'commission has been set to 1000000 if option by vehicle (no splits to process)
                'first do the split out
                For illoop = 0 To 9 Step 1                  'get splits out  2nd thru 10 slsp
                    'Determine the office for this contract
                    ilCode = 0                   'init to 0 until something found
                    For ilTemp = LBound(tlSlf) To UBound(tlSlf) - 1
                        If tlSlf(ilTemp).iCode = ilSlfCode(illoop) Then
                            ilCode = tlSlf(ilTemp).iSofCode
                            Exit For
                        End If
                    Next ilTemp
                    If llSlfSplit(illoop) > 0 And ilSlfCode(illoop) > 0 Then        'next slsp has something to split
                        If ilThisOffice = ilCode Then
                            ' mAddTieOut llProject(), tmTieOut(ilTieOutIndex).lTYOrders(), tgChfCt.lComm(ilLoop)
                        Else                               'do splits out(side of the primary office)
                            '4-13-00 mAddTieOut llProject(), tmTieOut(ilTieOutIndex).lSplitsOut(), tgChfCt.lComm(ilLoop)
                            mAddTieOut llProject(), tmTieOut(ilTieOutIndex).lSplitsOut(), llSlfSplit(illoop)
                            ' splits in - go find the office to process to put money in
                            For ilSplitInInx = LBound(tmTieOut) To UBound(tmTieOut)
                                If tmTieOut(ilSplitInInx).iCode = ilCode Then
                                    '4-20-00 mAddTieOut llProject(), tmTieOut(ilSplitInInx).lSplitsIn(), tgChfCt.lComm(ilLoop)
                                    mAddTieOut llProject(), tmTieOut(ilSplitInInx).lSplitsIn(), llSlfSplit(illoop)
                                    Exit For
                                End If
                            Next ilSplitInInx
                        End If                  'ilthisoffice <> tmctf.isofcode
                    End If                      'tmctf.lcomm(iloop) > 0
                Next illoop                     '1 to 9
            End If                              'tmctf.lcomm(0) <> 100%
        Else                                        'vehicle option , no splits
            mAddTieOut llProject(), tmTieOut(ilTieOutIndex).lTYOrders(), llCommPct

        End If
    Else                                            'test for last year
        mAddTieOut llProject(), tmTieOut(ilTieOutIndex).lLYOrders(), llCommPct
    End If
    For illoop = 1 To 12
        llProject(illoop) = 0
    Next illoop
End Sub

'       Billed & Booked - Test for vehicle selectivity
'       <input> ilVef - vehicle code from line or SBF
'               ilListIndex - report Index
'       <output> ilFoundOption - true if found a matching vehicle to include
'
Public Sub mBobSelectVeh(ilVef As Integer, ilFoundOption As Integer, ilListIndex As Integer)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  ilTemp                        slNameCode                    slCode                    *
    '*                                                                                        *
    '*****************************************************************************************
    Dim ilRet As Integer
    If ilVef <> tmVef.iCode Then            'insure correct vehicle in memory
        '7-1-14 speed up by using binary search
        ilRet = gBinarySearchVef(ilVef)
        If ilRet = -1 Then          'not found
            tmVef.iCode = 0
        Else
            tmVef = tgMVef(ilRet)
        End If
    End If

    '6-6-13 add filering of vehicle for B & B Comparison
    If (imSlsp And imVehSub) Or ilListIndex = CNT_BOBCOMPARE Then            'slsp option with vehicle subtotals
        If Not RptSelCt!ckcAllAAS.Value = vbChecked Then      'all vehicles selected?
            ilFoundOption = False
            If gFilterLists(ilVef, imInclVefCodes, imUsevefcodes()) Then
                ilFoundOption = True
            End If
        End If
    End If
End Sub

'           mBobSetupPctOfSplit - Split the revenue (if required) for the Schedule or SBF.  Create as many
'               GRF records required for splits
'           <input> tlSplitInfo - TYPE array containing  common parameters required when this
'                               code was made into subroutine
'                   llStdStartDates() - array of standard start dates for the year
'                   tlSlf() - array of salesperson records
'                   tlSCF() - salespeople commissions
'                   tlSlfIndex() - array of start/end indices pointing to tlSCF
'                   tlCntAllYear() - array of all participants for all vehicles for 1 contract
Public Sub mBobSetupPctOfSplit(tlSplitInfo As splitinfo, llStdStartDates() As Long, tlSlf() As SLF, tlScf() As SCF, tlSlfIndex() As SLFINDEX, tlCntAllYear() As ALLPIFPCTYEAR, tlOneVehAllYear() As ALLPIFPCTYEAR)
    Dim ilHowMany As Integer
    Dim ilMnfSubCo As Integer
    Dim ilHowManyDefined As Integer
    Dim illoop As Integer
    Dim ilSlfRecd As Integer
    Dim ilFoundOne As Integer
    Dim ilLoopSlsp As Integer
    Dim slNameCode As String
    Dim ilRet As Integer
    Dim slCode As String
    Dim llProcessPct As Long
    Dim ilTemp As Integer
    Dim llTempProject(0 To 12) As Long  'Index zero ignored
    Dim llTempAcquisition(0 To 12) As Long  'Index zero ignored
    Dim ilCorT As Integer
    Dim ilStartCorT As Integer
    Dim ilEndCorT As Integer
    Dim ilVefCode As Integer
    Dim ilFirstProjInx As Integer
    Dim ilUseSlsComm As Integer
    Dim ilDateFlag As Integer
    Dim ilNewCode As Integer
    Dim slPctTrade As String
    Dim slCashAgyComm As String
    Dim ilMatchSSCode As Integer
    Dim slCommPct As String
    Dim slTradeAgyComm As String    '12-23-02
    Dim ilSlspNTRComm As Integer
    Dim slNTR As String * 1
    Dim ilIsItHardCost As Integer
    Dim ilSaveCorT As Integer
    Dim ilMnfItem As Integer
    Dim ilNTRLoop As Integer
    
    ilMatchSSCode = tlSplitInfo.iMatchSSCode
    ilStartCorT = tlSplitInfo.iStartCorT
    ilEndCorT = tlSplitInfo.iEndCorT
    ilFirstProjInx = tlSplitInfo.iFirstProjInx
    ilUseSlsComm = tlSplitInfo.iUseSlsComm
    ilVefCode = tlSplitInfo.iVefCode
    ilDateFlag = tlSplitInfo.iDateFlag
    ilNewCode = tlSplitInfo.iNewCode
    slPctTrade = tlSplitInfo.sPctTrade
    slCashAgyComm = tlSplitInfo.sCashAgyComm
    slTradeAgyComm = tlSplitInfo.sTradeAgyComm
    ilSlspNTRComm = tlSplitInfo.iNTRSlspComm        '2-2-04
    slNTR = tlSplitInfo.sNTR
    ilIsItHardCost = tlSplitInfo.iHardCost
    ilMnfItem = tlSplitInfo.iMnfNTRItemCode         '11-06-06

    ilHowMany = 0
    ilHowManyDefined = 0

    ReDim lmSlfSplit(0 To 9) As Long           '4-20-00 slsp slsp share %
    ReDim imSlfCode(0 To 9) As Integer             '4-20-00
    ReDim imslfcomm(0 To 9) As Integer             'slsp under comm %
    ReDim imslfremnant(0 To 9) As Integer          'slsp under remnant %
    ReDim lmSlfSplitRev(0 To 9) As Long         '2-2-04 unused in this report (need for subroutine)

    ilMnfSubCo = gGetSubCmpy(tgChfCT, imSlfCode(), lmSlfSplit(), ilVefCode, ilUseSlsComm, lmSlfSplitRev())
    'if owner, it will build array of one vehicles participants in tmOneVehAllYear()
    mBobGetHowManyFuture ilVefCode, ilHowMany, ilHowManyDefined, ilMatchSSCode, imSlfCode(), lmSlfSplit(), llStdStartDates()     '8-4-00 4-6-00determine the number of owner or slsp splits

    For illoop = 0 To ilHowMany - 1 Step 1

        If imSlsp Then
            ilSlfRecd = gBinarySearchSlf(imSlfCode(illoop))
            If ilSlfRecd = -1 Then              'not found
                tmSlf.iSofCode = 0
                ilMatchSSCode = 0
            Else
                tmSlf = tgMSlf(ilSlfRecd)
            End If
            '7-23-07 when slsp sort, need to make sure the correct sales source is being used;
            'some split slsp are coming from different sales sources
            'A Slsp recd has been read in even tho its not a slsp option.  If not by slsp, using the
            'sales source from the first salesperson
            For ilTemp = LBound(tlSofList) To UBound(tlSofList)
                If tlSofList(ilTemp).iSofCode = tmSlf.iSofCode Then
                    ilMatchSSCode = tlSofList(ilTemp).iMnfSSCode          'Sales source
                    Exit For
                End If
            Next ilTemp
            
            ilFoundOne = True
             '8-6-10 If swapping from vehicle w/slsp split subtotals to slsp split w/vehicle subtotals, take all slsp
            If (Not RptSelCt!ckcAll.Value = vbChecked) And (igSwapBOBOption = False) Then
                 ilFoundOne = False
                 For ilLoopSlsp = 0 To RptSelCt!lbcSelection(2).ListCount - 1 Step 1
                     If RptSelCt!lbcSelection(2).Selected(ilLoopSlsp) Then              'selected slsp
                         slNameCode = tgSalesperson(ilLoopSlsp).sKey    'Traffic!lbcSalesperson.List(ilLoopSlsp)         'pick up slsp code
                         ilRet = gParseItem(slNameCode, 2, "\", slCode)
                         If Val(slCode) = imSlfCode(illoop) Then  '7-10-00
                             ilFoundOne = True
                             Exit For
                         End If
                     End If
                 Next ilLoopSlsp
            End If
            
            If ilFoundOne Then
                '4-20-00 llProcessPct = tgChfCt.lComm(ilLoop)          'slsp split % or 100%
                llProcessPct = lmSlfSplit(illoop)                '4-20-00
                lmSlfDiffComm = lmSlfSplitRev(illoop)       '1-31-04
            Else
                llProcessPct = 0
            End If
        ElseIf imBusCat Then                    'bus category
            llProcessPct = 1000000               'if advt or vehicle, just use slsp since there will always be one
                                                 'and only one pass will be processed
        ElseIf imProdProt Then                  'product protection
            llProcessPct = 1000000               'if advt or vehicle, just use slsp since there will always be one
                                                 'and only one pass will be processed
        ElseIf imAgency Then                    'agency
            llProcessPct = 1000000               'if advt or vehicle, just use slsp since there will always be one
                                                 'and only one pass will be processed
        ElseIf imOwner Or imTrikIfOwner Then    '8-4-00
            'only the matching sales sources and vehicle and participants have been build into tmOneVehAllYear()
            If tlOneVehAllYear(illoop).AllYear.iSSMnfCode = ilMatchSSCode Then
                 tmGrf.iCode2 = tlOneVehAllYear(illoop).AllYear.iMnfGroup 'participant
                 If tlOneVehAllYear(illoop).AllYear.iMnfGroup = 0 Then
                     llProcessPct = 1000000                               'take the full amount so it wont be excluded from report
                 Else
                     llProcessPct = -1          'flag to indicate need to process percentages by date (not just 1 percent for all dates applicable)
                 End If
            Else
                 If tlOneVehAllYear(0).AllYear.iSSMnfCode = 0 Then       'no sales source was found
                    llProcessPct = 1000000                               'take the full amount so it wont be excluded from report
                 Else
                    llProcessPct = 0
                 End If
            End If
        Else
            If (imVehicle And smGrossOrNet = "B") Then      '4-5-01  need the participant share for net-net option
                If tlOneVehAllYear(illoop).AllYear.iSSMnfCode = ilMatchSSCode Then
                     llProcessPct = 1000000
                     tmOnePartAllYear = tlOneVehAllYear(illoop).AllYear          '5-11-09 participant percentages for the year
                     If tmOnePartAllYear.iMnfGroup <> 0 Then       '4-6-16 handle case where owner isnt defined with vehicle
                         '8-2-09, got the matching sales source so if its the first time thru, this is the owner
                         If tmOnePartAllYear.iOwnerByDate <> 1 Then
                             llProcessPct = 0
                         End If
                     End If
                 Else
                    llProcessPct = 0
                End If
            Else
                llProcessPct = 1000000              'if advt or vehicle, just use slsp since there will always be one
            End If                                   'and only one pass will be processed
        End If

        If llProcessPct <> 0 Then        '-1 indicates to process percentages by date (by owner or participant/vehicle option); non 0 indicates a possible slsp split,
                                         '0 indicates to not go thru, nothing to calculate
            'if split slsp comm exist and selective slsp requested, don't show all slsp on this order
            ilFoundOne = mFoundSelection(illoop, ilVefCode, imSlfCode(), lmSlfSplit())         '8-4-00 see if selective slsp, owner, vehicle chosen
            If ilFoundOne Then
                For ilTemp = 1 To 12
                    llTempProject(ilTemp) = lmProject(ilTemp)
                    llTempAcquisition(ilTemp) = lmAcquisition(ilTemp)
                Next ilTemp
                For ilCorT = ilStartCorT To ilEndCorT Step 1
                    'mBOBNewInsert llTempProject(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, slCommPct, smGrossOrNet, ilHowManydefined, ilMatchSSCode, ilDateFlag, ilNewCode
                    tmGrf.iPerGenl(5) = 0       'flag to indicate that at least one vehicle does not have a sub-company defined and
                                'there is at least one slsp in the header with a sub-co (they all must have it, or none at all)
                    If ilMnfSubCo < 0 Then      'error, inconsistent sub-company definitions
                        tmGrf.iPerGenl(5) = 1
                    End If
                    'if this vehicle doesnt have a subcompany defined at there is at least one slsp
                    'in the header that has a sub-company defined, the commissions may not be correct.
                    'i.e.  Slsp A  Sub-co A  Slsp Share = 100
                    '      Slsp A  Sub-co B  Slsp Share = 50%
                    '      At least one line doesn't have a sub-company defined, therefore the splits will occur for Slsp A twice.

                    '4-20-05 determine if air time, ntr or hard cost for subsorting  in B & B Recap report
                    tmGrf.iPerGenl(9) = 0               'assume not an NTR
                    
                    '8-26-09 separate politicals on Sales comparison for contracts, future (vs past)
                     If mCheckAdvPolitical(tgChfCT.iAdfCode) Then      'test for political
                        tmGrf.iPerGenl(10) = 4                          'political, keep separate from direct, agy, ntr and H/C
                        tmGrf.iPerGenl(9) = 0                          'NTR subsort doesnt apply
                     Else                                               'not political
                        If tgChfCT.iAgfCode = 0 Then
                          tmGrf.iPerGenl(10) = 0                        'direct
                          tmGrf.iPerGenl(9) = 0                        'subsort dont apply for directs contracts (not NTR or HC) B & B Recap
                        Else
                          tmGrf.iPerGenl(10) = 1                        'agency
                          tmGrf.iPerGenl(9) = 0
                        End If
                     End If
                      
                    If slNTR = "Y" Then                  'NTR?
                         tmGrf.iPerGenl(9) = ilMnfItem      '11-06-06  If B&B Recap, subsort by NTR types
                         If ilIsItHardCost Then
                             tmGrf.iPerGenl(10) = 4           '11-06-06 For Billed & Booked Recap, this is to keep Hard Costs separate from Direct/Agy/NTR/Polits
                         Else
                             ''6-17-08 Determine Agency Sales, Direct Sales or just NTR
                             tmGrf.iPerGenl(10) = 2           '11-06-06 For Billed & Booked Recap, this is to keep NTR separate from Direct/Agy/Polits
                             'For NTR, determine if its flagged as direct or agy sales.  If so, place with agy or direct and not with NTRs
                             For ilNTRLoop = LBound(tlMMnf) To UBound(tlMMnf) - 1
                                 If (ilMnfItem = tlMMnf(ilNTRLoop).iCode) Then
                                     If (Trim(tlMMnf(ilNTRLoop).sUnitType) = "A") Then     'Agency sales
                                         tmGrf.iPerGenl(10) = 1
                                         tmGrf.iPerGenl(9) = 0      'force to no MNF code since it belongs in agency sales
                                     ElseIf (Trim(tlMMnf(ilNTRLoop).sUnitType) = "D") Then 'direct sales
                                         tmGrf.iPerGenl(10) = 0
                                         tmGrf.iPerGenl(9) = 0      'force to no MNF code since it belongs in direct sales
                                     Else
                                         tmGrf.iPerGenl(10) = 2      'normal NTR
                                     End If
                                     Exit For
                                 End If
                             Next ilNTRLoop
                         End If
                    End If

                    If igRptCallType = SLSPCOMMSJOB Then   'loop one month at a time because each month could have a different slsp comm %- retrieve the unique one
                        For ilTemp = ilFirstProjInx To 12   'start with first projection date
                            gGetCommByDates imSlfCode(), imslfcomm(), imslfremnant(), tlSlfIndex(), tlScf(), tlSlf(), ilVefCode, llStdStartDates(ilTemp), tgChfCT '7-11-00
                            slCommPct = gIntToStrDec(imslfcomm(illoop), 2)

                            If tgChfCT.sType = "T" Then                   'if remnant, differ commission
                                slCommPct = gIntToStrDec(imslfremnant(illoop), 2)
                            End If

                            '12-16-02 if NTR, use the slsp comm from SBF
                            If tgSpf.sSubCompany <> "Y" Then      'not using subcompanies for slsp comm , retrieve comm for NTR from SBF data
                                                                  'otherwise it was retreived from SCF tables
                                 If slNTR = "Y" Then              '2-3-04 not using subcompanies and its an NTR, use slsp comm from NTR recd
                                     slCommPct = gIntToStrDec(ilSlspNTRComm, 2)
                                 End If
                            End If

                            '1-31-04 mBOBLoopOnMonth: do not send the  participant index, as it is not used for the Slsp comm (force 0))
                            If ilTemp = ilFirstProjInx Then     '4-6-00 first time thru, init buckets in mBOBLoopOnMonth rtn
                                mBOBLoopOnMonth llTempProject(), llTempAcquisition(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, slCommPct, smGrossOrNet, ilHowManyDefined, ilMatchSSCode, ilDateFlag, ilNewCode, -ilTemp, ilTemp, tmOnePartAllYear, slTradeAgyComm '1-31-04
                            Else
                                mBOBLoopOnMonth llTempProject(), llTempAcquisition(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, slCommPct, smGrossOrNet, ilHowManyDefined, ilMatchSSCode, ilDateFlag, ilNewCode, ilTemp, ilTemp, tmOnePartAllYear, slTradeAgyComm '1-31-04
                            End If
                        Next ilTemp
                    Else
                        ilSaveCorT = ilCorT         'for the billed & booked, force hard cost items to end of report as separte category to cash & trade
                        If ilIsItHardCost = True Then
                            ilCorT = 3
                        End If
                        If imOwner Or (imVehicle And imTrikIfOwner) Or (imVehicle And smGrossOrNet = "B") Then      '5-11-09
                            tmOnePartAllYear = tlOneVehAllYear(illoop).AllYear          'participant percentages for the year
                        Else
                            tmOnePartAllYear = tlOneVehAllYear(0).AllYear          'versions other than owner and participant/vehicle dont need to have the participant percentages,
                                                                                         'may need the first participant name
                        End If
                        '5-11-09  If Vehicle Gross/Net option, need to make sure to get the correct owner % in case the owner has changed
                        If imVehicle And smGrossOrNet = "B" Then
                            '8-2-09 matched on the sales source already, if first time thru this is the owner
                            'If tmOnePartAllYear.iOwnerSeq = 1 Then
                            If tmOnePartAllYear.iOwnerByDate = 1 Or tmOnePartAllYear.iMnfGroup = 0 Then       '4-6-16 handle case where owner isnt defined with vehicle
                                mBOBLoopOnMonth llTempProject(), llTempAcquisition(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, slCommPct, smGrossOrNet, ilHowManyDefined, ilMatchSSCode, ilDateFlag, ilNewCode, 1, igPeriods, tmOnePartAllYear, slTradeAgyComm
                            End If
                        Else
                            mBOBLoopOnMonth llTempProject(), llTempAcquisition(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, slCommPct, smGrossOrNet, ilHowManyDefined, ilMatchSSCode, ilDateFlag, ilNewCode, 1, igPeriods, tmOnePartAllYear, slTradeAgyComm
                        End If
                        ilCorT = ilSaveCorT
                    End If
                Next ilCorT                             'process cash or trade portion
            End If                          'ilFoundOne
        End If                  'llProcessPct
    Next illoop                 'Possibly process mutiple slsp or owners per line.  If advt or vehicle, fall thru after one loop
End Sub

'           mProcessBRNTR - process NTR transactions for this order to show on Printed Contract Summary
'           If contract has flag that NTR is defined, find all associated NTR records from SBF
'           and build in array.  then create a record for each one to show on contract summary
'           <input>  slStart - start date to search  SBF
'                    slEnd - end date to search SBF
'                    tlSBFType - type of SBF records to obtain
'                    tlRVF() - array of RVF records found for tax computations
'                    tlInstallSBF() - array of Instllment $ from sBF
'                    ilVehiclesDone() - array of vehicles processed already (monthly installments gathered for vehicle
'                    llSTdStartDates() - array of 12 months to determine what month to place $ into
'                    ilListIndex - Proposals/Contracts or Insertion Orders
'                    ilVehList() - list of vehicles processed for air time.  If any airtime already created for an NTR vehicle,
'                                   dont create another special record for the Insertion order version
Public Sub mProcessBrNTR(slStart As String, slEnd As String, tlSBFType As SBFTypes, tlRvf() As RVF, tlInstallSBF() As SBF, ilVehiclesDone() As Integer, llStdStartDates() As Long, ilListIndex As Integer, tlVehList() As INSERTINFO, ilWhichSort As Integer)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  llProjectedFlights                                                                    *
    '******************************************************************************************
    'TTP 10855 - prevent overflow due to too many NTR items
    'Dim ilSbf As Integer
    Dim llSbf As Long
    Dim illoop As Integer
    ReDim tlSbf(0 To 0) As SBF
    Dim ilRet As Integer
    Dim llTax1Pct As Long
    Dim llTax2Pct As Long
    Dim slGrossNet As String
    Dim llProjectedTax1 As Long
    Dim llProjectedTax2 As Long
    Dim ilAgyComm As Integer
    Dim llNTRAmt As Long
    Dim slLastBillDate As String
    Dim llLastBillDate As Long
    Dim llSbfBillDate As Long
    Dim llTax1CalcAmt As Long
    Dim llTax2CalcAmt As Long
    Dim llInstallBilling(0 To 13) As Long   'Index zero ignored
    Dim ilMonthLoop As Integer
    Dim ilFound As Integer
    Dim ilSelectedLoop As Integer
    Dim ilNTRBillLoop As Integer
    Dim ilFoundNTRBill As Integer
    Dim llNTRNet As Long
    Dim llNTRComm As Long
    ReDim tlntrbillsummary(0 To 0) As NTRBILLSUMMARY

    If tgChfCT.sNTRDefined = "Y" Then        'Billed & booked needs to get the SBF (NTR Item billing) for the future if Item billing defined
        If (ilListIndex = CNT_INSERTION) And (Not RptSelCt!ckcSelC12(0).Value = vbChecked) Then     '8-21-18 insertion order and not including NTR, exit out
            Exit Sub
        End If
        mSetupBrHdr ilWhichSort                 'setup all the header information required
        ilRet = gObtainSBF(RptSelCt, hmSbf, tgChfCT.lCode, slStart, slEnd, tlSBFType, tlSbf(), 0)   '11-28-06 add last parm to indicate which key to use
        If ilRet = True Then
            gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slLastBillDate
            If slLastBillDate = "" Then
                slLastBillDate = "1/1/1970"
            End If
            llLastBillDate = gDateValue(slLastBillDate)

            igBR_NTRDefined = True
            'accumulate taxes for IN NTR only thru the end of the last bill date, NTR future will be processed later
            llProjectedTax1 = 0
            llProjectedTax2 = 0
            llTax1CalcAmt = 0
            llTax2CalcAmt = 0
            If tgChfCT.iAgfCode > 0 Then        'get agy comm in case taxes need to be obtained
                ilAgyComm = tmAgf.iComm
            Else
                ilAgyComm = 0                       'direct
            End If

            'create a CBF record for each SBF found
            For llSbf = LBound(tlSbf) To UBound(tlSbf) - 1
                tmCbf.iVefCode = tlSbf(llSbf).iBillVefCode       'vehicle code for sorting
                tmCbf.iDtFrstBkt(0) = tlSbf(llSbf).iDate(0)     'Transaction date
                tmCbf.iDtFrstBkt(1) = tlSbf(llSbf).iDate(1)
                tmCbf.sDysTms = tlSbf(llSbf).sDescr             'NTR description
                tmCbf.iPctDist = tlSbf(llSbf).iMnfItem          'NTR Item Type
                tmCbf.lRate = tlSbf(llSbf).lGross               'Rate
                tmCbf.sPriceType = tlSbf(llSbf).sAgyComm
                '6/8/15: Replaced Acquisition with NTR Acquisition
                ''3-7-11 Only show the acq costs if they are using them
                ''3-13-14 If insertion order, show acq cost vs item rate.  by option, override with item rate if acq cost is 0
                If ilListIndex = CNT_INSERTION And ((Asc(tgSpf.sOverrideOptions) And SPNTRACQUISITION) = SPNTRACQUISITION) Then
                    If tlSbf(llSbf).lAcquisitionCost = 0 Then
                        If ((Asc(tgSaf(0).sFeatures1) And SHOWPRICEONINSERTIONWITHACQUISTION) <> SHOWPRICEONINSERTIONWITHACQUISTION) Then 'Show Spot Prices on Insertion Orders if Acquistion Exist
                            tmCbf.lRate = tlSbf(llSbf).lAcquisitionCost
                            tmCbf.sPriceType = ""            'force to show blank on $0
                        End If
                    Else
                        tmCbf.lRate = tlSbf(llSbf).lAcquisitionCost
                        tmCbf.sPriceType = ""            'force to show blank on $0
                    End If
                End If
                tmCbf.iProdPct = tlSbf(llSbf).iNoItems          '# items per unit
                mCalcNetNet ilListIndex           '10-28-08 Calc net net for Insertion Order if applicable
                tmCbf.iExtra2Byte = 4                           'NTR detail flag
                 
                gUnpackDateLong tlSbf(llSbf).iDate(0), tlSbf(llSbf).iDate(1), llSbfBillDate
                llNTRAmt = tlSbf(llSbf).lGross * tlSbf(llSbf).iNoItems
                
                llTax1CalcAmt = 0           '12-15-11
                llTax2CalcAmt = 0

                If llSbfBillDate > llLastBillDate Then      '
                    'gGetAirTimeTaxRates tgChfCT.iAdfCode, tgChfCT.iAgfCode, tmCbf.iVefCode, llTax1Pct, llTax2Pct
                    gGetNTRTaxRates tlSbf(llSbf).iTrfCode, llTax1Pct, llTax2Pct, slGrossNet
                    If tlSbf(llSbf).iTrfCode = 0 Then       'is this ntr item taxable?
                        llTax1Pct = 0
                        llTax2Pct = 0
                        slGrossNet = ""
                    End If
                    gFutureTaxesForNTR llNTRAmt, llProjectedTax1, llProjectedTax2, ilAgyComm, tgChfCT.iPctTrade, llTax1Pct, llTax2Pct, slGrossNet
                Else            '12-15-11 process all the past receivables with each NTR
                    For illoop = LBound(tlRvf) To UBound(tlRvf) - 1
                        If tlRvf(illoop).iMnfItem > 0 And tlRvf(illoop).iBillVefCode = tlSbf(llSbf).iBillVefCode And tlRvf(illoop).lSbfCode = tlSbf(llSbf).lCode Then
                            llProjectedTax1 = tlRvf(illoop).lTax1
                            llProjectedTax2 = tlRvf(illoop).lTax2

                        End If
                    Next illoop
                End If
                '12/17/06-Change to tax by agency or vehicle
                llTax1CalcAmt = llTax1CalcAmt + llProjectedTax1
                llTax2CalcAmt = llTax2CalcAmt + llProjectedTax2
                tmCbf.lTax1 = llTax1CalcAmt
                tmCbf.lTax2 = llTax2CalcAmt
                
                '10/8/21 - JW - Fix TTP 10271: Insertion Orders report.
                '10/21/21 - JW - if line has Len(iLen), Rate (lRate) or NTR Qty (prodPct)
                If tmCbf.iLen > 0 Or tmCbf.lRate > 0 Or tmCbf.iProdPct > 0 Then RptSelCt.bmHasRecords = True
                ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
                
                mSaveEmailByCntVeh ilListIndex          'setup array of unique cnt & vehicles to create email pdfs
                'Create array of NTR vehicles for the billing summary to be merged with a subreport with air time billing summary
                ilFoundNTRBill = False
                For ilNTRBillLoop = LBound(tlntrbillsummary) To UBound(tlntrbillsummary) - 1
                    If tlntrbillsummary(ilNTRBillLoop).iVefCode = tmCbf.iVefCode Then
                        ilFoundNTRBill = True
                        Exit For
                    End If
                Next ilNTRBillLoop
                If Not ilFoundNTRBill Then
                    ilNTRBillLoop = UBound(tlntrbillsummary)
                    ReDim Preserve tlntrbillsummary(0 To UBound(tlntrbillsummary) + 1) As NTRBILLSUMMARY
                End If
                tlntrbillsummary(ilNTRBillLoop).iVefCode = tmCbf.iVefCode
                tlntrbillsummary(ilNTRBillLoop).lTax1 = tlntrbillsummary(ilNTRBillLoop).lTax1 + llProjectedTax1
                tlntrbillsummary(ilNTRBillLoop).lTax2 = tlntrbillsummary(ilNTRBillLoop).lTax2 + llProjectedTax2
                'calc agy comm
                If tmCbf.sPriceType = "Y" Then          'agy commissionable
                    llNTRComm = (llNTRAmt * CDbl(ilAgyComm)) / 10000        'round for proper decimals due to multiplication of agy comm
                Else
                    llNTRComm = 0       'no commission
                End If
                tlntrbillsummary(ilNTRBillLoop).lAgyComm = tlntrbillsummary(ilNTRBillLoop).lAgyComm + llNTRComm
                tlntrbillsummary(ilNTRBillLoop).lNet = tlntrbillsummary(ilNTRBillLoop).lNet + (llNTRAmt - llNTRComm)
                If llSbfBillDate >= llStdStartDates(13) Then    'over 12 months
                    tlntrbillsummary(ilNTRBillLoop).lMonth(13) = tlntrbillsummary(ilNTRBillLoop).lMonth(13) + llNTRAmt
                Else                    'determine what month the billing falls into
                    For ilMonthLoop = 1 To 12
                        If llSbfBillDate >= llStdStartDates(ilMonthLoop) And llSbfBillDate < llStdStartDates(ilMonthLoop + 1) Then
                            tlntrbillsummary(ilNTRBillLoop).lMonth(ilMonthLoop) = tlntrbillsummary(ilNTRBillLoop).lMonth(ilMonthLoop) + llNTRAmt
                            Exit For
                        End If
                    Next ilMonthLoop
                End If
                
                'see if the vehicle of this NTR was also an air time.  if not,
                'need to create a key record so the NTRs will be linked to Insertion order subreport and found for processing in subreport
                If ilListIndex = CNT_INSERTION Then
                    ilFound = False
                    For illoop = LBound(tlVehList) To UBound(tlVehList) - 1
                        If tlVehList(illoop).iVefCode = tmCbf.iVefCode Then
                            ilFound = True
                            Exit For
                        End If
                    Next illoop
                    If Not ilFound Then     'if none found, an NTR exists without an air time so create the record to link to subreports
                        'first see if vehicle selected for inclusion
                        'ilFound = false
                        For ilSelectedLoop = LBound(imSelectedVehicles) To UBound(imSelectedVehicles) - 1
                            If tmCbf.iVefCode = imSelectedVehicles(ilSelectedLoop) Then
                                ilFound = True
                                Exit For
                            End If
                        Next ilSelectedLoop
                        If ilFound Then         'insertion orders defined to see based on vehicle options
                            '8-21-18 add this vehicle into the list of ntr vehicles to be processed on separate pages, if not already in
                            ilFound = False
                            For illoop = LBound(tlVehList) To UBound(tlVehList) - 1
                                If tlVehList(illoop).iVefCode = tmCbf.iVefCode Then
                                    ilFound = True
                                    Exit For
                                End If
                            Next illoop
                            'if not found, add to list
                            If Not ilFound Then
                                
                                tlVehList(UBound(tlVehList)).iVefCode = tmCbf.iVefCode
                                ReDim Preserve tlVehList(LBound(tlVehList) To UBound(tlVehList) + 1) As INSERTINFO
                            End If
                            
                            'create a special record for the NTR as there wasnt an airtime vehicle
                            tmCbf.iExtra2Byte = -1
                            'tmCbf.ivefcode already has the NTR vehicle
                            ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
                        End If
                    End If
                End If

                If tgChfCT.sInstallDefined = "Y" Then   'if installment contract, show install $ on summary page
                    gBuildInstallMonths tlSbf(llSbf).iBillVefCode, ilVehiclesDone(), llStdStartDates(), llInstallBilling(), tlInstallSBF()
                    'find the vehicle this belongs to
                    If ilNTRBillLoop <= UBound(tlntrbillsummary) Then     'make sure not out of subscript range
                        For ilMonthLoop = 1 To 13
                            tlntrbillsummary(ilNTRBillLoop).lInstallment(ilMonthLoop) = tlntrbillsummary(ilNTRBillLoop).lInstallment(ilMonthLoop) + llInstallBilling(ilMonthLoop)
                        Next ilMonthLoop
                    End If
                    
                    'init monthly $ and units buckets for next flight
                    For ilMonthLoop = 1 To 13 Step 1
                        tmCbf.lMonth(ilMonthLoop - 1) = 0
                        tmCbf.lMonthUnits(ilMonthLoop - 1) = 0
                        tmCbf.lWeek(ilMonthLoop - 1) = 0
                        llInstallBilling(ilMonthLoop) = 0
                    Next ilMonthLoop
                End If
            Next llSbf
            
            If tgChfCT.sInstallDefined = "Y" Then       'if contract is installment billing, do not show the NTR as separate billing
                For ilNTRBillLoop = LBound(tlntrbillsummary) To UBound(tlntrbillsummary) - 1
                    tmCbf.iVefCode = tlntrbillsummary(ilNTRBillLoop).iVefCode
                    
                    For ilMonthLoop = 1 To 13
                        tmCbf.lMonth(ilMonthLoop - 1) = tlntrbillsummary(ilNTRBillLoop).lInstallment(ilMonthLoop)
                    Next ilMonthLoop
                    
                    tmCbf.lTax1 = tlntrbillsummary(ilNTRBillLoop).lTax1
                    tmCbf.lTax2 = tlntrbillsummary(ilNTRBillLoop).lTax2
                    tmCbf.lValue(0) = tlntrbillsummary(ilNTRBillLoop).lNet
                    tmCbf.lValue(1) = tlntrbillsummary(ilNTRBillLoop).lAgyComm
                    tmCbf.iExtra2Byte = 6               'ntr billing summary for subreport
                    ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
                Next ilNTRBillLoop
            Else

                'check to see if NTR should be merged with Air time as a separate section
                If imShowNTRBillSummary Then        'show the NTR billing summary?
                    For ilNTRBillLoop = LBound(tlntrbillsummary) To UBound(tlntrbillsummary) - 1
                        tmCbf.iVefCode = tlntrbillsummary(ilNTRBillLoop).iVefCode
                        
                        For ilMonthLoop = 1 To 13
                            If tgChfCT.sInstallDefined = "Y" Then
                                tmCbf.lMonth(ilMonthLoop - 1) = tlntrbillsummary(ilNTRBillLoop).lInstallment(ilMonthLoop)
                            Else
                                tmCbf.lMonth(ilMonthLoop - 1) = tlntrbillsummary(ilNTRBillLoop).lMonth(ilMonthLoop)
                            End If
                        Next ilMonthLoop
                        
                        tmCbf.lTax1 = tlntrbillsummary(ilNTRBillLoop).lTax1
                        tmCbf.lTax2 = tlntrbillsummary(ilNTRBillLoop).lTax2
                        
                        'tmCbf.lValue(1) = tlntrbillsummary(ilNTRBillLoop).lNet
                        'tmCbf.lValue(2) = tlntrbillsummary(ilNTRBillLoop).lAgyComm
                        tmCbf.lValue(0) = tlntrbillsummary(ilNTRBillLoop).lNet
                        tmCbf.lValue(1) = tlntrbillsummary(ilNTRBillLoop).lAgyComm
                        tmCbf.iExtra2Byte = 8               'ntr billing summary for subreport
                        ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
                    Next ilNTRBillLoop
                End If
            End If              'tgChf.sInstallDefined
            
        End If
    End If
    Erase tlSbf, tlntrbillsummary
End Sub

'           Create a report to produce the count of units in a vehicle regardless
'           of its avail type.  No dayparts are used, gather all avails defined
'           in the library.  Restrict the data to one week only.  Selling, Airing
'           and conventional vehicles are included
'
'       gCrVehUnitCount - count the number of units a vehicle contains regardless of
'                       the avail type.  Then, if Affiliate system is used, determine
'                       the number of active agreements between the requested week.
'
'                       The report will show the vehicle name, unit count, # affiliates,
'                       and total spot count (units * agreements)
'          12-11-03 Calc 30" units based on the length of the avails.  Use the calculated value or
'          the # units defined, whichever is less
'           7-19-04 Exclude network feed avails, 9-24-04 fix test for inclusion of avails
'           2-1-06 Add option to include manual, web based or marketron agreements
Public Sub gCrVehUnitCount()
    Dim ilVehicle As Integer
    Dim ilVpfIndex As Integer
    Dim ilVefCode As Integer
    Dim ilRet As Integer
    Dim illoop As Integer
    Dim slNameCode As String
    Dim slName As String
    Dim slCode As String
    Dim ilFound As Integer
    Dim llLoopDate As Long
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim slDate As String
    Dim llLatestDate As Long
    Dim ilWeekDay As Integer
    Dim ilUnits As Integer
    Dim llLen As Long
    Dim ilTemp As Integer
    Dim ilType As Integer
    Dim ilEvt As Integer
    Dim ilLoopTFN As Integer
    Dim ilCountATT As Integer   'count of active agreements
    Dim ilLoadCount As Integer  'count of extra load factor (i.e if load factor = 5, 4extra added to this count)
                                'the other 1 is added to the true count of agreements (ilCountATT)
    Dim hlAtt As Integer    'ATT handle
    ReDim ilDate(0 To 1) As Integer
    ReDim ilEvtType(0 To 14) As Integer
    Dim ilValue As Integer
    Dim ilVefIndex As Integer
    Dim ilInclManual As Integer     '2-1-06
    Dim ilInclWeb As Integer
    Dim ilInclMkt As Integer

    hmVef = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVef, "", sgDBPath & "Vef.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmVef)
        btrDestroy hmVef
        Exit Sub
    End If
    imVefRecLen = Len(tmVef)
    hmSsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSsf, "", sgDBPath & "Ssf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSsf)
        ilRet = btrClose(hmVef)
        btrDestroy hmSsf
        btrDestroy hmVef
        Exit Sub
    End If
    hmLcf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmLcf, "", sgDBPath & "Lcf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmLcf)
        ilRet = btrClose(hmSsf)
        ilRet = btrClose(hmVef)
        btrDestroy hmLcf
        btrDestroy hmSsf
        btrDestroy hmVef
        Exit Sub
    End If
    imLcfRecLen = Len(tmLcf)
    hmGrf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmGrf, "", sgDBPath & "Grf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmGrf)
        ilRet = btrClose(hmLcf)
        ilRet = btrClose(hmSsf)
        ilRet = btrClose(hmVef)
        btrDestroy hmGrf
        btrDestroy hmLcf
        btrDestroy hmSsf
        btrDestroy hmVef
        Exit Sub
    End If
    imGrfRecLen = Len(tmGrf)

    If tgSpf.sGUseAffSys = "Y" Then
        imATTExist = True
        hlAtt = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hlAtt, "", sgDBPath & "Att.mkd", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            ilRet = btrClose(hlAtt)
            ilRet = btrClose(hmGrf)
            ilRet = btrClose(hmLcf)
            ilRet = btrClose(hmSsf)
            ilRet = btrClose(hmVef)
            btrDestroy hlAtt
            btrDestroy hmGrf
            btrDestroy hmLcf
            btrDestroy hmSsf
            btrDestroy hmVef
            Exit Sub
        End If
    End If

    ilInclManual = gSetCheck(RptSelCt!ckcSelC3(0).Value)   '2-1-06   includ manual agreements
    ilInclWeb = gSetCheck(RptSelCt!ckcSelC3(1).Value)   '2-1-06   includ web based agreements
    ilInclMkt = gSetCheck(RptSelCt!ckcSelC3(2).Value)   '2-1-06   includ marketron agreements

    For illoop = LBound(ilEvtType) To UBound(ilEvtType) Step 1
        ilEvtType(illoop) = True        'include avails of any type
    Next illoop
    ilEvtType(0) = False                'exclude program
    ilEvtType(1) = False
    ilEvtType(10) = False                'exclude page eject
    ilEvtType(11) = False                'exclude line space 1
    ilEvtType(12) = False                'exclude line space 2
    ilEvtType(13) = False                'exclude line space 3
    ilEvtType(14) = False                'exclude other event types

    ilType = 0                        'use on-air programming

    tmGrf.iGenDate(0) = igNowDate(0)
    tmGrf.iGenDate(1) = igNowDate(1)
    gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
    tmGrf.lGenTime = lgNowTime

    slDate = RptSelCt!CSI_CalFrom.Text      'Date: 1/8/2020 added CSI calendar control for date entries -->  edcSelCFrom.Text
    llStartDate = gDateValue(slDate)
    slDate = RptSelCt!CSI_CalTo.Text        'Date: 1/8/2020 added CSI calendar control for date entries --> edcSelCFrom1.Text
    llEndDate = gDateValue(slDate)
    ilFound = False
    For ilVehicle = 0 To RptSelCt!lbcSelection(3).ListCount - 1 Step 1
        If (RptSelCt!lbcSelection(3).Selected(ilVehicle)) Then
            ilFound = False
            slNameCode = tgVehicle(ilVehicle).sKey
            ilRet = gParseItem(slNameCode, 1, "\", slName)
            ilRet = gParseItem(slName, 3, "|", slName)
            ilRet = gParseItem(slNameCode, 2, "\", slCode)
            ilVefCode = Val(slCode)
            ilVpfIndex = -1
            illoop = gBinarySearchVpf(ilVefCode)
            If illoop <> -1 Then
                ilVpfIndex = illoop
                ilFound = True
            End If
            ilVefIndex = gBinarySearchVef(ilVefCode)
            If ilVefIndex = -1 Then
                ilFound = False
            End If
            If ilFound Then
                llLatestDate = gGetLatestLCFDate(hmLcf, "C", ilVefCode)
                tmGrf.iVefCode = ilVefCode
                tmGrf.lDollars(0) = 0           'init the countof units
                For llLoopDate = llStartDate To llEndDate Step 1
                    slDate = Format$(llLoopDate, "m/d/yy")
                    gPackDate slDate, ilDate(0), ilDate(1)
                    imSsfRecLen = Len(tmSsf) 'Max size of variable length record
                    If tgMVef(ilVefIndex).sType <> "G" Then
                        tmSsfSrchKey.iType = ilType
                        tmSsfSrchKey.iVefCode = ilVefCode
                        tmSsfSrchKey.iDate(0) = ilDate(0)
                        tmSsfSrchKey.iDate(1) = ilDate(1)
                        tmSsfSrchKey.iStartTime(0) = 0
                        tmSsfSrchKey.iStartTime(1) = 0
                        ilRet = gSSFGetGreaterOrEqual(hmSsf, tmSsf, imSsfRecLen, tmSsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)
                    Else
                        tmSsfSrchKey2.iVefCode = ilVefCode
                        tmSsfSrchKey2.iDate(0) = ilDate(0)
                        tmSsfSrchKey2.iDate(1) = ilDate(1)
                        ilRet = gSSFGetGreaterOrEqualKey2(hmSsf, tmSsf, imSsfRecLen, tmSsfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)
                        ilType = tmSsf.iType
                    End If
                    If (ilRet <> BTRV_ERR_NONE) Or (tmSsf.iType <> ilType) Or (tmSsf.iVefCode <> ilVefCode Or (tmSsf.iDate(0) <> ilDate(0)) And (tmSsf.iDate(1) = ilDate(1))) Then
                        If llLoopDate > llLatestDate Then
                            ReDim tlLLC(0 To 0) As LLC  'Merged library names
                            If tgMVef(ilVefIndex).sType <> "G" Then
                                ilWeekDay = gWeekDayStr(slDate) + 1 '1=Monday TFN; 2=Tues,...7=Sunday TFN
                                If ilWeekDay = 1 Then
                                     ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNMO", "12M", "12M", ilEvtType(), tlLLC())
                                ElseIf ilWeekDay = 2 Then
                                     ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNTU", "12M", "12M", ilEvtType(), tlLLC())
                                ElseIf ilWeekDay = 3 Then
                                     ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNWE", "12M", "12M", ilEvtType(), tlLLC())
                                ElseIf ilWeekDay = 4 Then
                                     ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNTH", "12M", "12M", ilEvtType(), tlLLC())
                                ElseIf ilWeekDay = 5 Then
                                     ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNFR", "12M", "12M", ilEvtType(), tlLLC())
                                ElseIf ilWeekDay = 6 Then
                                     ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNSA", "12M", "12M", ilEvtType(), tlLLC())
                                ElseIf ilWeekDay = 7 Then
                                     ilRet = gBuildEventDay(ilType, "C", ilVefCode, "TFNSU", "12M", "12M", ilEvtType(), tlLLC())
                                End If
                            End If
                            'Accumulate the vehicles units
                            For ilLoopTFN = LBound(tlLLC) To UBound(tlLLC) - 1
                                'always exclude network feed only avails (test bits 10 & 11)
                                ilValue = tlLLC(ilLoopTFN).iAvailInfo
                                ilValue = ilValue And &HC00
                                If ilValue = 0 Or ilValue = &H400 Then      'contract or contr/feed avail (not feed only)
                                    llLen = CLng(gLengthToCurrency(tlLLC(ilLoopTFN).sLength))
                                    ilUnits = tlLLC(ilLoopTFN).iUnits       'units defined for avail
                                    If llLen < 30 And llLen <> 0 Then
                                        ilUnits = 1
                                    Else
                                        ilTemp = llLen \ 30         'calc # of 30" units
                                        If ilUnits > ilTemp Then        'avail units greater than the # of 30 that can actually fit
                                            ilUnits = ilTemp
                                        End If
                                    End If
                                    tmGrf.lDollars(0) = tmGrf.lDollars(0) + ilUnits '12-11-03 tlLLC(ilLoopTFN).iUnits
                                End If
                            Next ilLoopTFN
                        End If
                        ilRet = BTRV_ERR_KEY_NOT_FOUND          'force end of SSF read
                     End If

                     Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.iType = ilType) And (tmSsf.iVefCode = ilVefCode And (tmSsf.iDate(0) = ilDate(0)) And (tmSsf.iDate(1) = ilDate(1)))
                        ilEvt = 1
                        Do While ilEvt <= tmSsf.iCount              'Loop for all avails gathered
                           LSet tmAvail = tmSsf.tPas(ADJSSFPASBZ + ilEvt)
                            If tmAvail.iRecType >= 2 And tmAvail.iRecType <= 9 Then
                                ilUnits = tmAvail.iAvInfo And &H1F
                                llLen = tmAvail.iLen
                                If llLen < 30 And llLen <> 0 Then
                                    ilUnits = 1
                                Else        'determine 30 second units,but do no exceed # of units defined
                                    ilTemp = llLen \ 30
                                    If ilUnits > ilTemp Then
                                        ilUnits = ilTemp
                                    End If
                                End If

                                'tmGrf.lDollars(1) = tmGrf.lDollars(1) + ilUnits
                                tmGrf.lDollars(0) = tmGrf.lDollars(0) + ilUnits
                            End If
                            ilEvt = ilEvt + 1
                        Loop

                        imSsfRecLen = Len(tmSsf) 'Max size of variable length record
                        ilRet = gSSFGetNext(hmSsf, tmSsf, imSsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                        If tgMVef(ilVefIndex).sType = "G" Then
                            ilType = tmSsf.iType
                        End If
                    Loop

                Next llLoopDate         'For llLoopDate = llSTartDate to llEndDate
                mGetATTbyVef hlAtt, ilVefCode, llStartDate, llEndDate, ilCountATT, ilLoadCount, ilInclManual, ilInclWeb, ilInclMkt    'if affiliate system, get the count of agreements
                'Create the prepass record for Crystal
                tmGrf.lDollars(1) = ilCountATT      'count of actual agreements
                tmGrf.lDollars(2) = ilLoadCount     'count of extra load factor
                'combination of (ilCountATT & ilLoadCount) * # units = total spot load for the affiliate
                ilRet = btrInsert(hmGrf, tmGrf, imGrfRecLen, INDEXKEY0)
                If ilRet <> BTRV_ERR_NONE Then
                    'error with update
                End If
            End If                      'not ilFound
        End If
    Next ilVehicle

    ilRet = btrClose(hmGrf)
    ilRet = btrClose(hmLcf)
    ilRet = btrClose(hmSsf)
    ilRet = btrClose(hmVef)
    ilRet = btrClose(hlAtt)

    btrDestroy hmGrf
    btrDestroy hmLcf
    btrDestroy hmSsf
    btrDestroy hmVef
    btrDestroy hlAtt
End Sub

'           mCreateBRSportsComments - go thru each schedule line and determine
'           if its a sports vehicle, and user wants to show the vehicle, game #
'           teams, date & time of event in comments section of the printed contrct.
'           These 'type 5' records will be used in a subreport called from the
'           summary versions of the printed contract.
'           10-20-05
Public Sub mCreateBRSportsComments(ilWhichSort As Integer)
    Dim ilClf As Integer
    Dim ilRet As Integer
    
    For ilClf = LBound(tgClfCT) To UBound(tgClfCT) - 1 Step 1
        tmClf = tgClfCT(ilClf).ClfRec
            If tmClf.sGameLayout = "Y" Then     'show the games defined for this line
                mSetupBrHdr ilWhichSort
                tmCbf.iRdfDPSort = tmClf.iRdfCode   'daypart
                tmCbf.iExtra2Byte = 5           'Sports comments flag
                tmCbf.lChfCode = tmClf.lChfCode 'contrct code
                tmCbf.iVefCode = tmClf.iVefCode
                'get the game defined for this line
                tmCgfSrchKey1.lClfCode = tmClf.lCode
                ilRet = btrGetEqual(hmCgf, tmCgf, imCgfRecLen, tmCgfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)
                Do While (tmClf.lCode = tmCgf.lClfCode And ilRet = BTRV_ERR_NONE)
                    If tmCgf.iNoSpots <> 0 Then         '7-19-06 ignore games that dont have any spots defined
                        'tmCbf.lLineNo = tmClf.iLine
                        '12-24-12 change saving line code instead of line # for matching in subreport for game info
                        tmCbf.lLineNo = tmCgf.lCode
                        
                        tmCbf.iTotalWks = tmCgf.iGameNo
                        'loop and get all games for this
                        'gen date and time set previously and should still be in buffer
                        ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
                     End If
                    ilRet = btrGetNext(hmCgf, tmCgf, imCgfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop
            End If
    Next ilClf
End Sub

'           mGetUniquePkgVehPop - set the population to be used for package totals
'           not be to be used to calculate the detail schedue line package research
'           (see mGetPopPkgbyLine routine to set up that population because there
'           could be more than 1 package line for the same vehicle, with varying books
'           referenced)
'           <input> ilVehlist - array of list of unique vehicles
Private Sub mGetUniquePkgVehPop(ilVehList() As Integer)
    Dim ilVehicle As Integer
    Dim ilPkg As Integer
    Dim llFltStart As Long
    Dim llFltEnd As Long
    Dim ilQtr As Integer
    Dim slStr As String
    Dim ilfirstTime As Integer

    For ilVehicle = LBound(ilVehList) To UBound(ilVehList) - 1 Step 1
        If tmClf.iVefCode = ilVehList(ilVehicle) Then
            ilfirstTime = True                                  '3-1-11 need to get the package vehicles population.  if hidden lines have varying population, use 0; if all same use that pop
                                                                'ignore the CBS lines population
            'ilvehicle contains index to store package population
            '5-28-10 do not set the vehicle pop until a matching package vehicle is found so
            'that incase of CBS, it doesnt look like theres varying populations (by using 0 in the calculations)
            'lmPopPkg(ilVehicle) = -1    '11-24-04 pop for the pkg because of using same hidden vehicle reference as the pkg vehicle
            For ilPkg = 0 To UBound(tgClfCT) - 1 Step 1
                gUnpackDate tgClfCT(ilPkg).ClfRec.iStartDate(0), tgClfCT(ilPkg).ClfRec.iStartDate(1), slStr
                llFltStart = gDateValue(slStr)
                gUnpackDate tgClfCT(ilPkg).ClfRec.iEndDate(0), tgClfCT(ilPkg).ClfRec.iEndDate(1), slStr
                llFltEnd = gDateValue(slStr)
                If tmClf.iLine = tgClfCT(ilPkg).ClfRec.iPkLineNo And llFltEnd >= llFltStart Then    'find the assoc pkg vehicle name
                    '5-28-10 moved from above to avoid using wrong population of 0 when CBS involved
                    If ilfirstTime Then
                        lmPopPkg(ilVehicle) = -1    '11-24-04 pop for the pkg because of using same hidden vehicle reference as the pkg vehicle
                        ilfirstTime = False
                    End If
'                    For ilQtr = 1 To UBound(ilVehList)
                    For ilQtr = LBound(ilVehList) To UBound(ilVehList)      '11-24-17
                        If tgClfCT(ilPkg).ClfRec.iVefCode = ilVehList(ilQtr) Then
                            Exit For
                        End If
                    Next ilQtr
                    '3-16-12 Always on the first time, use the first population it finds
'10-23-17           adjust ilQtr for 0 based index
                    If lmPopPkg(ilVehicle) = -1 Then    'And lmPop(ilQtr) <> 0 Then          'first time
                        If lmPop(ilQtr) > 0 Then                        '3-13-19
                            lmPopPkg(ilVehicle) = lmPop(ilQtr)
                        End If
                    Else
                        If (lmPopPkg(ilVehicle) <> 0) And (lmPopPkg(ilVehicle) <> lmPop(ilQtr)) And (lmPop(ilQtr) <> 0) Then    'test to see if this pop is different that the prev one.
                            lmPopPkg(ilVehicle) = 0                                           'if different pops, calculate the contract  summary different
                        Else
                            'if current line has population, but there was already a different across
                            'lines in pop, dont save new one
                            If lmPop(ilQtr) <> 0 And (lmPopPkg(ilVehicle) <> 0 And lmPopPkg(ilVehicle) <> -1) Then  '2/1/99
                                lmPopPkg(ilVehicle) = lmPop(ilQtr)
                            End If
                        End If
                    End If

                End If
            Next ilPkg
            Exit For
        End If
    Next ilVehicle
End Sub

'           mGetPopPkgByLine - set up that population because there
'           could be more than 1 package line for the same vehicle, with varying books
'           referenced.  Build array of package populations by the package lines (ilPkgLineList)
'           <input> ilPkgLineList - array of all package lines
'                   llPopByLine - array of population by line
Private Sub mGetPopPkgByLine(ilPkgLineList() As Integer, llPopByLine() As Long)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  ilLoop                                                                                *
    '******************************************************************************************
    Dim ilLoopOnPkgLine As Integer
    Dim ilPkg As Integer
    Dim llFltStart As Long
    Dim llFltEnd As Long
    Dim slStr As String

    For ilLoopOnPkgLine = LBound(ilPkgLineList) To UBound(ilPkgLineList) - 1 Step 1
        lmPopPkgByLine(ilLoopOnPkgLine) = -1    '11-24-04 pop for the pkg because of using same hidden vehicle reference as the pkg vehicle
        For ilPkg = 0 To UBound(tgClfCT) - 1 Step 1
            gUnpackDate tgClfCT(ilPkg).ClfRec.iStartDate(0), tgClfCT(ilPkg).ClfRec.iStartDate(1), slStr
            llFltStart = gDateValue(slStr)
            gUnpackDate tgClfCT(ilPkg).ClfRec.iEndDate(0), tgClfCT(ilPkg).ClfRec.iEndDate(1), slStr
            llFltEnd = gDateValue(slStr)
            If ilPkgLineList(ilLoopOnPkgLine) = tgClfCT(ilPkg).ClfRec.iPkLineNo And llFltEnd >= llFltStart Then    'find the assoc pkg vehicle name
                If lmPopPkgByLine(ilLoopOnPkgLine) = -1 And llPopByLine(ilPkg + 1) <> 0 Then '11-24-04 pop for the pkg because of using same hidden vehicle reference as the pkg vehicle
                    lmPopPkgByLine(ilLoopOnPkgLine) = llPopByLine(ilPkg + 1)
                Else
                    If (lmPopPkgByLine(ilLoopOnPkgLine) <> 0) And (lmPopPkgByLine(ilLoopOnPkgLine) <> llPopByLine(ilPkg + 1)) And (llPopByLine(ilPkg + 1) <> 0) Then  'test to see if this pop is different that the prev one.
                        lmPopPkgByLine(ilLoopOnPkgLine) = 0                                           'if different pops, calculate the contract  summary different
                    Else
                        'if current line has population, but there was already a different across
                        'lines in pop, dont save new one
                        If llPopByLine(ilPkg + 1) <> 0 And (lmPopPkgByLine(ilLoopOnPkgLine) <> 0 And lmPopPkgByLine(ilLoopOnPkgLine) <> -1) Then '2/1/99
                            lmPopPkgByLine(ilLoopOnPkgLine) = llPopByLine(ilPkg + 1)
                        End If
                    End If
                End If
            End If
        Next ilPkg
    Next ilLoopOnPkgLine
End Sub

'       Create the record to show a CBS line
'       <input> ilListIndex - report type
'               tlSofList() array of slsp offices
'       2-24-06
Public Sub mShowCBS(ilListIndex As Integer, tlSofList() As SOFLIST, slDailyExists As String)
    Dim ilTemp As Integer
    Dim llLineRef As Long
    tmCbf.lRate = 0
    tmCbf.sPriceType = ""       '2-23-01
    tmCbf.sDysTms = "Cancel Before Start"
    'force extra options to unused so they wont show on report
    tmCbf.iOBBLen = 0
    tmCbf.iCBBLen = 0
    tmCbf.s1stPosition = "N"
    tmCbf.sSoloAvail = "N"
    tmCbf.sPrefDT = " "
    tmCbf.lLineNo = CLng((tmClf.iLine) * CLng(1000)) + tmClf.iCntRevNo
    tmCbf.iVefCode = tmClf.iVefCode
    tmCbf.lRafCode = tmClf.lRafCode '8-30-06
    llLineRef = tmClf.iLine
    If tmClf.sType = "H" Then
        llLineRef = tmClf.iPkLineNo
    End If
    mSetResortField tmClf.sType, llLineRef               '12-22-20
    
    'init all the fields that are shown on report
    tmCbf.lCPP = 0
    tmCbf.lCPM = 0
    tmCbf.lGrImp = 0
    tmCbf.iAvgRate = 0
    tmCbf.lAvgAud = 0
    tmCbf.lGRP = 0
    If ilListIndex = CNT_INSERTION Then 'Insertion orders needs to separate daily/weekly by vehicle not contract
        For ilTemp = LBound(tlSofList) To UBound(tlSofList) - 1
            If tmClf.iVefCode = tlSofList(ilTemp).iMnfSSCode Then
                If tlSofList(ilTemp).iSofCode = True Then   'at least one daily exists for this vehicle
                    tmCbf.sDailyExists = "Y"            '12-9-03 make sure the Insertion Order shows the CBS on dailies
                    tmCbf.sDailyWkly = "2"
                Else
                    tmCbf.sDailyWkly = "0"          'all weekly
                    tmCbf.sDailyExists = "N"
                End If
                Exit For
            End If
        Next ilTemp
    Else
        'tmCbf.sDailyWkly: 0 = no dailies, 1 = daily line, 2 = wkly line but there are dailies on this order
        If slDailyExists = "Y" Then       '5-21-03
            tmCbf.sDailyWkly = "2"
        Else
            tmCbf.sDailyWkly = "0"
        End If
    End If
End Sub

'       Read advertiser to see if the Political flag is set
'
'       <input>  adfcode
'       <return> true if political, else false
'       5-26-06
Public Function mCheckAdvPolitical(ilAdfCode As Integer) As Integer
    Dim ilIsItPolitical As Integer
    Dim ilIndex As Integer
    
    ilIsItPolitical = False
    ilIndex = gBinarySearchAdf(ilAdfCode)
    If ilIndex <> -1 Then               'advt found
        If tgCommAdf(ilIndex).sPolitical = "Y" Then 'see if political flag is set
            ilIsItPolitical = True
        End If
    End If
    mCheckAdvPolitical = ilIsItPolitical
End Function

'           mBobSSCodeRVFSelect - Billed & Booked reports: find the sales source and office;
'                     obtain vehicle group if applicable, see if sales source is the selected
'           <input> tlSlf - array of slsp
'                   tlSofList - array of sls offices
'           <output> ilMatchSSCode - Sales source mnf code
'                    ilMatchSofCode - sales office mnf code
'           <return> true if transaction passes filters
'
Public Function mBOBSSCodeRVFSelect(tlSlf() As SLF, tlSofList() As SOFLIST, ilMatchSSCode As Integer, ilMatchSOFCode As Integer, ilUsePkg As Integer) As Integer
    Dim ilSearchSlf As Integer
    Dim ilTemp As Integer
    Dim ilFoundOption As Integer
    'Determine Office and Sales Source for later filtering if option by SS/Market
    ilMatchSSCode = 0
    '7-1-14 replace search of internal table to use binarysearch of SLF
    ilSearchSlf = gBinarySearchSlf(tmRvf.iSlfCode)
    If ilSearchSlf = -1 Then                'not found
        ilMatchSOFCode = 0
    Else
        For ilTemp = 0 To UBound(tlSofList) Step 1
            'If tlSofList(ilTemp).iSofCode = tlSlf(ilSearchSlf).iSofCode Then
            If tlSofList(ilTemp).iSofCode = tgMSlf(ilSearchSlf).iSofCode Then       '7-1-14
                ilMatchSSCode = tlSofList(ilTemp).iMnfSSCode
                ilMatchSOFCode = tlSofList(ilTemp).iSofCode
                Exit For
            End If
        Next ilTemp
    End If
    
    '10-04-02Detrmine the vehicle group for the airing vehicle
    gGetVehGrpSets tmRvf.iAirVefCode, imMinorSet, imMajorSet, tmGrf.iPerGenl(2), tmGrf.iPerGenl(3)   'Genl(3) = minor sort code, genl(4) = major sort code
    ilFoundOption = mBobRvfSelect(ilUsePkg, ilMatchSSCode, ilMatchSOFCode)                 '6/14/99 see if this is a valid transaction to process
    mBOBSSCodeRVFSelect = ilFoundOption        'return the results
End Function

'           mBobNTRTestRVF - Billed and Booked reports:  test NTR/Hard Cost selectivity
'           <input>  tlMnf - array of NTR items
'           <output> ilIsItHardCost : true if hard cost NTR item
'           <Return> true if include transaction
'
Public Function mBOBNTRTestRVF(tlMnf() As MNF, ilIsItHardCost As Integer) As Integer
    Dim ilValidTran As Integer
    ilValidTran = False
    'test for inclusion/exclusion of ntrs, hard cost & air time transactions
    ilIsItHardCost = False
    ilIsItHardCost = gIsItHardCost(tmRvf.iMnfItem, tlMnf())
    If tmRvf.iMnfItem > 0 Then          'ntr of some kind
        If ilIsItHardCost Then          'hard cost, Include?
            If imHardCost Then
                ilValidTran = True
            End If
        Else                            'non-hard cost
            If imNTR Then               'include non-hard cost?
                ilValidTran = True
            End If
        End If
    Else                                'air time
        If imAirTime Then               'include air time?
            ilValidTran = True
        End If
    End If
    '2-7-17 ignore all transactions that have been undone (rvfInvoiceUndone = "Y")
    If tmRvf.sInvoiceUndone = "Y" Then
        ilValidTran = False
    End If
    mBOBNTRTestRVF = ilValidTran
End Function

'       mBobFormatGRFFromRVF - build fields into GRF prepass record
'       <input> ilUsePkg - true if use package vehicles; otherwise hidden vehicles
'               ilIsItHardCost - true if item is a hard cost item
Public Sub mBOBFormatGrfFromRVF(ilUsePkg As Integer, ilIsItHardCost As Integer)
    Dim ilNTRLoop As Integer
    'format remainder of record
    tmGrf.iGenDate(0) = igNowDate(0)        'todays date used for removal of records
    tmGrf.iGenDate(1) = igNowDate(1)
    gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
    tmGrf.lGenTime = lgNowTime
    tmGrf.lChfCode = tmChf.lCode           'contr internal code
    tmGrf.iPerGenl(12) = 0                 'flag to indicate data from contracts (vs budget info for B & B Comparison)
    tmGrf.iDateGenl(0, 0) = tmRvf.iTranDate(0)    'date billed or paid
    tmGrf.iDateGenl(1, 0) = tmRvf.iTranDate(1)

    If ilUsePkg Then                        '6/14/99
        tmGrf.iVefCode = tmRvf.iBillVefCode
    Else
        tmGrf.iVefCode = tmRvf.iAirVefCode
    End If
    tmGrf.iAdfCode = tmChf.iAdfCode
    tmGrf.sDateType = tmRvf.sCashTrade          'Type field used for C = Cash, T = Trade
    If tmRvf.sCashTrade = "M" Or tmRvf.sCashTrade = "P" Then        'merch and promotions are for the adjustments, they
                                                                    'wont be categorized on the report by merch or promotions.
        tmGrf.sDateType = "C"
    End If

    tmGrf.iPerGenl(9) = 0               '11-06-06assume not an NTR
    'Billed & Booked Recap uses the agency vs direct and NTR subsorts
    'Sales Comparison will use political flag to keep separate
    If mCheckAdvPolitical(tmRvf.iAdfCode) Then          'its a political, include this contract?
        tmGrf.iPerGenl(10) = 4                  'political, keep seperate from direct, agy, ntr and H/C
        tmGrf.iPerGenl(9) = 0                  'NTR subsort doesnt apply
    Else            'not political, check for agency, direct, etc.
        If tmRvf.iAgfCode = 0 Then
            tmGrf.iPerGenl(10) = 0          'direct
            tmGrf.iPerGenl(9) = 0          'subsorts dont apply for direct contracts (not NTR or HC)
        Else
            tmGrf.iPerGenl(10) = 1          'agency
            tmGrf.iPerGenl(9) = 0          'subsorts dont apply for agency contracts (not NTR or HC)
        End If
        'if NTR of some sort, it gets separated from the directs & agency
        If ilIsItHardCost Then                      'if this is a hard cost item, override the cash/trade flag so hard costs fall at end of report
            tmGrf.sDateType = "Z"                   'force hard costs to end fo report
            tmGrf.iPerGenl(10) = 4                  '11-06-06 flag to indicate hard cost
            tmGrf.iPerGenl(9) = tmRvf.iMnfItem     'hard cost type for subtotals on B & B Recap
        Else
            If tmRvf.iMnfItem > 0 Then              'is this an NTR?
                tmGrf.iPerGenl(10) = 2           '11-06-06 For Billed & Booked Recap, this is to keep NTR separate from Direct/Agy/Polits
                tmGrf.iPerGenl(9) = tmRvf.iMnfItem

                'For NTR, determine if its flagged as direct or agy sales.  If so, place with agy or direct and not with NTRs
                For ilNTRLoop = LBound(tlMMnf) To UBound(tlMMnf) - 1
                    If (tmRvf.iMnfItem = tlMMnf(ilNTRLoop).iCode) Then
                        If (Trim(tlMMnf(ilNTRLoop).sUnitType) = "A") Then     'Agency sales
                            tmGrf.iPerGenl(10) = 1
                            tmGrf.iPerGenl(9) = 0          'no NTR item, force to agency sales
                        ElseIf (Trim(tlMMnf(ilNTRLoop).sUnitType) = "D") Then 'direct sales
                            tmGrf.iPerGenl(10) = 0
                            tmGrf.iPerGenl(9) = 0          'no NTR item, force to direct sales
                        Else
                            tmGrf.iPerGenl(10) = 2      'normal NTR
                            tmGrf.iPerGenl(9) = tmRvf.iMnfItem
                        End If
                        Exit For
                    End If
                Next ilNTRLoop
            End If
        End If
    End If
End Sub

'           mBobChkSlspInfo - For Billed and Booked Slsp or Owner (participant) option, check if
'           slsp or participant has been selected
'           <input> ilSlfCode() - array of slsp for the contract
'           <return> true if valid slsp
Public Function mBobChkSlspInfo(ilSlfCode() As Integer, ilMnfGroup() As Integer, illoop As Integer) As Integer
    Dim ilFoundOne As Integer
    Dim ilLoopSlsp As Integer
    Dim ilLoopOnPart As Integer
    Dim slNameCode As String
    Dim ilRet As Integer
    Dim slCode As String

    ilFoundOne = False
    'check for selective in list if:  slsp or owner and All not selected,
    'check ofr selective in list if: vehicle and participant split option and all participants not selected
    If (imSlsp Or imOwner) Or (imVehicle And imTrikIfOwner) Then
        '8-6-10 If swapping from vehicle w/slsp split subtotals to split slsp w/vehicle subtotals, include all slsp
        If igSwapBOBOption Then
            ilFoundOne = True
        Else
            If imSlsp Or imOwner Then
                 For ilLoopSlsp = 0 To RptSelCt!lbcSelection(2).ListCount - 1 Step 1
                    If RptSelCt!lbcSelection(2).Selected(ilLoopSlsp) Then              'selected slsp
                        slNameCode = tgSalesperson(ilLoopSlsp).sKey    'Traffic!lbcSalesperson.List(ilLoopSlsp)         'pick up slsp code
                        ilRet = gParseItem(slNameCode, 2, "\", slCode)
                        If imSlsp Then
                             If Val(slCode) = ilSlfCode(illoop) Then  '7-10-00
                                ilFoundOne = True
                                Exit For
                            End If
                        Else                                        'selected this owner?
                            If ilMnfGroup(illoop + 1) = 0 Then      '4-6-16 handle case where Sales source/vehicle group isnt defined with vehicle
                                ilFoundOne = True
                            Else
                                If Val(slCode) = ilMnfGroup(illoop + 1) Then    '7-26-07
                                    ilFoundOne = True
                                    Exit For
                                End If
                            End If
                        End If
                    End If
                Next ilLoopSlsp
            Else
                If RptSelCt!rbcSelCInclude(4).Value = True Then     'selection was vehicle/participant
                    For ilLoopOnPart = 0 To RptSelCt!lbcSelection(2).ListCount - 1 Step 1
                        If RptSelCt!lbcSelection(2).Selected(ilLoopOnPart) Then
                            slNameCode = tgSalesperson(ilLoopOnPart).sKey
                            ilRet = gParseItem(slNameCode, 2, "\", slCode)
                            
                            If ilMnfGroup(illoop + 1) = 0 Then      '4-6-16 handle case where Sales source/vehicle group isnt defined with vehicle
                                ilFoundOne = True
                                Exit For
                            Else
                                If Val(slCode) = ilMnfGroup(illoop + 1) Then
                                    ilFoundOne = True
                                    Exit For
                                End If
                            End If
                    
                        End If
                        If ilFoundOne Then
                            Exit For
                        End If
                    Next ilLoopOnPart
                Else
                    ilFoundOne = True
                End If
            End If
        End If
    Else                                                'all other options the record has already been filtered
        ilFoundOne = True
    End If
    mBobChkSlspInfo = ilFoundOne
End Function

'           mBobPastSetupKeyForReport - update the key field for common sorting in Crystal reports
'       <input> ilListIndex - report type
'               ilSlfCode() - array of slsp codes for splits
'               ilMnfGroup() - arry of participant splits
'               ilLoop - index to slsp or participant that is being processed
'               ilUsePkg - using package or hidden lines
'       <return>  first index of slsp or participant being processed (i.e. if participants,
'               there may be several sales sources, so the first participant of the sales
'               source may not be 1 the first in the list.
Public Function mBobPastSetupKeyForReport(ilListIndex As Integer, ilSlfCode() As Integer, ilMnfGroup() As Integer, illoop As Integer, ilUsePkg As Integer) As Integer
    Dim ilRet As Integer
    Dim ilRelativeIndex As Integer
    Dim ilVefCode As Integer
        
    ilRelativeIndex = illoop                    '2-15-00
    '8-12-08 retrieval of vehicle placed in common code so that the vehicle code is always available
    If ilUsePkg Then            '6/14/99 use pkg lines (vs hidden)
        '7-1-14 not using anything in the veftable
        ilVefCode = tmRvf.iBillVefCode
    Else                    'hidden lines (vs pkg lines)
        ilVefCode = tmRvf.iAirVefCode
    End If

    If imSlsp Then
        '4-20-00 tmGrf.islfCode = tmChf.islfCode(ilLoop) 'slsp code
        tmGrf.iSlfCode = ilSlfCode(illoop) '4-20-00 slsp code
        tmGrf.lCode4 = tmChf.lComm(illoop)      'slsp commission
    ElseIf imBusCat Then                        'bus category
        tmGrf.iCode2 = tmChf.iMnfBus
    ElseIf imProdProt Then                      'product protection
        tmGrf.iCode2 = tmChf.iMnfComp(0)
    ElseIf imAgency Then                        'agency
        tmGrf.iCode2 = tmChf.iAgfCode
    ElseIf imOwner Or imTrikIfOwner Then
        tmGrf.iCode2 = ilMnfGroup(illoop + 1)      '7-6-05 vehicle group
    ElseIf imVehicle Or imVehGroup Then
        'move retreival of vehicle to common code
         tmGrf.iCode2 = ilMnfGroup(1)             'pick up first veh group
         If imTrikIfOwner Then                   '8-4-00
             tmGrf.iCode2 = ilMnfGroup(illoop + 1)           '5-2-07
         End If
         'for billed and booked, allow subsort by slsp within vehicle    '10-18-06
         tmGrf.iSlfCode = tmRvf.iSlfCode     'primary slsp in RVF
    End If

    If ilListIndex = CNT_SALESCOMPARE And igRptCallType = CONTRACTSJOB Then
        '7-1-14 use common variable of which type of line its accessing
        tmGrf.iVefCode = ilVefCode          'its billing or airing vehicle from rvf
        'selection is always set to slsp in case the minor sort needs to be split by the slsp
        'setup all fields sort fields for major and minor selection
        If imPrimSort = 2 Then      'bus category
            tmGrf.iCode2 = tmChf.iMnfBus
        ElseIf imPrimSort = 3 Then                      'product protection
            tmGrf.iCode2 = tmChf.iMnfComp(0)
        ElseIf imPrimSort = 1 Then                       'agency
            tmGrf.iCode2 = tmChf.iAgfCode
        ElseIf imPrimSort = 6 Then                      'vehicle group
            gGetVehGrpSets tmGrf.iVefCode, 0, imMajorSet, ilRet, tmGrf.iCode2     'setup vehicle group as major sort
        End If

        If imSubSort > 0 Then      'subsort defined
            If imSubSort = 1 Or imSubSort = 5 Or imSubSort = 6 Then 'advt, slsp & vehicle already exists

            ElseIf imSubSort = 2 Then       'agy
                tmGrf.iPerGenl(11) = tmChf.iAgfCode
            ElseIf imSubSort = 3 Then       'bus cat
                tmGrf.iPerGenl(11) = tmChf.iMnfBus
            ElseIf imSubSort = 4 Then       'prod prot
                tmGrf.iPerGenl(11) = tmChf.iMnfComp(0)
            ElseIf imSubSort = 7 Then       'veh group
                gGetVehGrpSets tmGrf.iVefCode, imMinorSet, 0, tmGrf.iPerGenl(11), ilRet     'setup vehicle group as minor sort
            End If
        End If
    End If
    
    If RptSelCt!lbcRptType.ListIndex = CNT_BOBCOMPARE And igRptCallType = CONTRACTSJOB Then
        If Not imVehicle Then           'not vehicle, need some fields setup for prepass
            '7-1-14 vehicle has been retrieved at beginning of routine from either rvfbillvef or rvfairvef
            tmGrf.iVefCode = ilVefCode              '7-1-14
            gGetVehGrpSets tmGrf.iVefCode, imMinorSet, imMajorSet, tmGrf.iPerGenl(2), tmGrf.iPerGenl(3)     'setup vehicle group as minor sort
        End If              'not vehicle
        tmGrf.iPerGenl(13) = igBSelectedIndex       'Budget mnf code
    End If
    mBobPastSetupKeyForReport = ilRelativeIndex
End Function

'           mBobConvertAndSplitPast - convert Receivables packed decimal to string for
'           math computations
'           <input>  llProcessPct - revenue share %
'                    slCommPct - comm. slsp % share
'                    llGrossDollars - running total of gross $ split
'                    llNetDollars - running total of net $ split
'                    ilRelativeIndex -
'                    ilHowManyDefined - # of splits defined
'                    ilReverseFlag - true to negate and subtract $
'           <oupput> llGrossDollars - running total of gross $ split
'                    llNetDollars - running total of net $ split
'                    llcommDollars - calc. $ for slsp comm
Public Sub mBobConvertAndSplitPast(llProcessPct As Long, slCommPct As String, llTransGross As Long, llTransNet As Long, llGrossDollar As Long, llNetDollar As Long, llCommDollar As Long, ilRelativeIndex As Integer, ilHowManyDefined As Integer, ilReverseFlag As Integer)
    Dim slPct As String
    Dim slAmount As String
    Dim slAcquisitionCost As String
    Dim slDollar As String
    Dim llAcquisitionCost As Long
    Dim llAcqNet As Long
    Dim llAcqComm As Long

    slPct = gLongToStrDec(llProcessPct, 4)           'slsp split share in % or Owner pct.  If advt or vehicle
                                                                                    'options, slsp is force to100%
    slAmount = mBOBWhichAmtToStr(tmRvf.sGross, 2)     'determine whether to use the net value from rvf/phf or acquisition cost

    slDollar = gMulStr(slPct, slAmount)                 'slsp gross portion of possible split
    llGrossDollar = Val(gRoundStr(slDollar, "01.", 0))
    llTransGross = llTransGross - llGrossDollar          'take away the split amount from the total to see whats remaining.
    If ilRelativeIndex = ilHowManyDefined - 1 Then       'last slsp or participant processed?  Handle
                                                'extra pennies.
                                                                                            'extra pennies.
        If (imTrikIfOwner) And Not (RptSelCt!ckcAll.Value = vbChecked) Then   '8-24-00 When running selective participants for vehicle& participant option, dont
                                                            'bother to get last records extra pennies or dollars for balancing
            llGrossDollar = llGrossDollar + llTransGross    'last recd gets left over pennies
        End If

    End If

    slAmount = mBOBWhichAmtToStr(tmRvf.sNet, 2)     'determine whether to use the net value from rvf/phf or acquisition cost
    slDollar = gMulStr(slPct, slAmount)                 'slsp net portion of possible split
    llNetDollar = Val(gRoundStr(slDollar, "01.", 0))
    llTransNet = llTransNet - llNetDollar

    If imAdjustAcquisition Then                     'tnet, subtract out the acquisition costs
        gCalcAcqComm imAcqCommPct, tmRvf.lAcquisitionCost, llAcqNet, llAcqComm

        slAmount = gLongToStrDec(llAcqNet, 2)
        slAcquisitionCost = gMulStr(slPct, slAmount)
        llAcquisitionCost = Val(gRoundStr(slAcquisitionCost, "01.", 0))
        If llAcquisitionCost < 0 Then  '1-9-08 need to handle negative numbers
            llTransNet = llTransNet + llAcquisitionCost
            llNetDollar = llNetDollar + llAcquisitionCost
            slDollar = gAddStr(slDollar, slAcquisitionCost)
        Else
            llTransNet = llTransNet - llAcquisitionCost
            llNetDollar = llNetDollar - llAcquisitionCost
            slDollar = gSubStr(slDollar, slAcquisitionCost)
        End If
    End If

    If (imVehicle And smGrossOrNet = "B" And igRptCallType = CONTRACTSJOB) Then        'Net-Net version of B & B
        llCommDollar = Val(slCommPct * 100)         'maintain owner share in pct , not $ of share; report calculates
        tmGrf.iYear = 1                 'reset flag for "Split" notation on report
    Else
        'calc slsp comm amount
        slDollar = gRoundStr(gDivStr(gMulStr(slDollar, slCommPct), "100.00"), ".01", 0)
        llCommDollar = Val(gRoundStr(slDollar, "01.", 0))
        If imUseAcquisitionCost And smGrossOrNet = "N" Then         'using acq and need net value for possible varying commissions.  If not using varying, it will be 0
            llNetDollar = llGrossDollar - llCommDollar
        End If
    End If

    'Keep track of total net $ to calc Commission Overage in Billed &booked Comm report
    'tmGrf.lDollars(18) = tmGrf.lDollars(18) + llGrossDollar     'accum total years gross
    'Change from calc overage with net $, rather than gross $
    If ilReverseFlag Then
        tmGrf.lDollars(17) = tmGrf.lDollars(17) - llNetDollar
    Else
        tmGrf.lDollars(17) = tmGrf.lDollars(17) + llNetDollar     'accum total years net
    End If
End Sub

Public Function mBobReverseSign(llTransNet As Long, llTransGross As Long) As Integer
    Dim ilReverseFlag As Integer
    Dim slAmount As String
    
    ilReverseFlag = False
    If imAdjustAcquisition Then
        If (tmRvf.sCashTrade = "M" Or tmRvf.sCashTrade = "P") Then
            'Reverse the sign on the gross & net fields, then store it back into the RVf record
            'so it properly subtracts this amount from commissions
            'If the transaction is negative, need to give commision back, so add it in.
            'if the transaction is positive, its not counted as commissionable
            ilReverseFlag = True
        End If
        If llTransNet < 0 Then      'always work with positive amounts (if already positive, leave it)
            'retain reversal flag if its an adjustment (AN)
            If tmRvf.sCashTrade = "M" Or tmRvf.sCashTrade = "P" Then
                ilReverseFlag = False   'make sure that the merchandise/promotion amt is added back in
            Else
                ilReverseFlag = True
            End If
            llTransGross = -llTransGross
            slAmount = gLongToStrDec(llTransGross, 2)
            tmRvf.sGross = mBOBWhichAmtToPDN(slAmount, 2, 6)
    
            llTransNet = -llTransNet
            slAmount = gLongToStrDec(llTransNet, 2)
            tmRvf.sNet = mBOBWhichAmtToPDN(slAmount, 2, 6)
        End If
    Else
        If llTransNet < 0 Then          'billed & booked adjustment, subtract it out
            If imUseAcquisitionCost Then            '10-9-13 if using acq only, do nothing as it will be adjusted again
                ilReverseFlag = ilReverseFlag
            Else
                ilReverseFlag = True        'reverse gross & net signs to always work with positive values
                llTransGross = -llTransGross
                slAmount = gLongToStrDec(llTransGross, 2)
                tmRvf.sGross = mBOBWhichAmtToPDN(slAmount, 2, 6)
    
                llTransNet = -llTransNet
                slAmount = gLongToStrDec(llTransNet, 2)
                tmRvf.sNet = mBOBWhichAmtToPDN(slAmount, 2, 6)
            End If
        End If
    End If
    mBobReverseSign = ilReverseFlag
End Function

'           Billed & Booked - determine whether to use gross or net from RVF (PHF),
'           or use the Acquisition cost
'           <input> slAmt - gross or net value from RVF/PHF
'           <return> gross or net value from RVF/PHF or the acquistion cost as Long
Public Function mBOBWhichAmtToLong(slAmt As String) As Long
    Dim llAmt As Long
    If imUseAcquisitionCost = True Then         'use acquisition cost checked on
        llAmt = tmRvf.lAcquisitionCost
    Else
        gPDNToLong slAmt, llAmt
    End If
    mBOBWhichAmtToLong = llAmt
End Function

'           Billed & Booked - determine whether to use gross or net from RVF (PHF),
'           or use the Acquisition cost
'           <input> slAmt - Gross or net from rvf/phf
'           <return> gross or net value from RVF/PHF or the acquistion cost as a String
Public Function mBOBWhichAmtToStr(slAmt As String, ilDecPlaces As Integer) As String
    Dim slAmount As String
    If imUseAcquisitionCost = True Then         'use acquisition cost checked on
        slAmount = gLongToStrDec(tmRvf.lAcquisitionCost, ilDecPlaces)
    Else
        gPDNToStr slAmt, ilDecPlaces, slAmount
    End If
    mBOBWhichAmtToStr = slAmount
End Function

'
'           Billed & Booked - determine whether to use gross or net from RVF (PHF),
'           or use the Acquisition cost
'           <input> slAmt - gross or net value from RVF/PHF
'           <return> gross or net value from RVF/PHF or the acquistion cost as a String
Public Function mBOBWhichAmtToPDN(slAmt As String, ilDecPlaces As Integer, ilPositions As Integer) As String
    Dim slAmount As String
    If imUseAcquisitionCost = True Then         'use acquisition cost checked on
        slAmount = gLongToStrDec(tmRvf.lAcquisitionCost, ilDecPlaces)
    Else
        gStrToPDN slAmt, ilDecPlaces, ilPositions, slAmount
    End If
    mBOBWhichAmtToPDN = slAmount
End Function

'               gGetParticipantSplits - build the table of participant splits
'               for the Billed and Booked
'           <input> llstdStartDate - effective start date to gather from PIF
'                   blOwnerOnly - when building the table of participants, if by Vehicle Group Participants for Vehicle option,
'                   force to 100% to for owners share; optional parameters and default to false if not present
'           <output> tmPifKey() - array of vehicles and indices into tmPifPct array
'                   tmPifPct() - array of participant percentages by vehicle
'
Public Sub gGetAllParticipantSplits(llStdStartDate As Long, Optional blOwnerOnly As Boolean = False)
    gCreatePIFForRpts llStdStartDate, tmPifKey(), tmPifPct(), RptSelCt, blOwnerOnly
End Sub

'          mGetNTRProjData
'          <input>  slSTartDate - earliest date to gather
'                   slEndDate - latest date to gather
'                   ilFilter - kind of selectivty 0= none, 1 = advt, 2 = contract, 3= slsp
'                   slGrossNet - User selection, G = gross, N = Net
'                   ilNumberPeriods = User selection, # periods to gather & print
'          Gather NTR from contracts and use the NTR bill date to determine period to accumulate
'           Determine if NTR/Hard Cost included
Public Sub mGetNTRProjData(ilSelectedVefCodes() As Integer, slStartDate As String, slEndDate As String, ilfilter As Integer, slGrossNet As String, ilNumberPeriods As Integer)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  llStartDate                   llEndDate                     llTemp                    *
    '*                                                                                        *
    '*                                                                                        *
    '* Local Labels (Marked)                                                                  *
    '*  mGetNTRProjDataErr                                                                    *
    '******************************************************************************************
    Dim ilRet As Integer
    Dim llDate As Long
    Dim slSpotOrNTR As String * 1
    Dim ilIndex As Integer
    Dim ilOk As Integer
    Dim illoop As Integer
    Dim ilOKVef As Integer
    Dim ilVehicle As Integer
    ReDim tlSbf(0 To 0) As SBF
    Dim llSbf As Long
    Dim tlSBFType As SBFTypes
    Dim slNTRComm As String * 1
    
    tlSBFType.iImport = False
    tlSBFType.iInstallment = False
    tlSBFType.iNTR = True

    ilRet = gObtainSBF(RptSelCt, hmSbf, 0, slStartDate, slEndDate, tlSBFType, tlSbf(), 0)
    For llSbf = LBound(tlSbf) To UBound(tlSbf)
        tmSbf = tlSbf(llSbf)
        ilOKVef = False
        For ilVehicle = LBound(ilSelectedVefCodes) To UBound(ilSelectedVefCodes) - 1
            If ilSelectedVefCodes(ilVehicle) = tmSbf.iAirVefCode Then
                ilOKVef = True
                Exit For
            End If
        Next ilVehicle
        If ilOKVef Then             'vehicle has been selected
            ilOk = True

            If tmSbf.lChfCode <> tmChf.lCode Then
                tmChfSrchKey.lCode = tmSbf.lChfCode
                ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation

            Else
                ilRet = BTRV_ERR_NONE
            End If
            If ilRet <> BTRV_ERR_NONE Then
                ilOk = False
            Else
                slSpotOrNTR = "N"           'NTR 4-6-15 need to separate NTR that is comm vs non-comm
                slNTRComm = tmSbf.sAgyComm  '
                ilOk = mFilterProjData(tmSbf.iAirVefCode, ilfilter, slSpotOrNTR, ilIndex, slNTRComm)       'test contract types, advt/cntr/slsp selectivity
            End If
            If ilOk Then
                gUnpackDateLong tmSbf.iDate(0), tmSbf.iDate(1), llDate
                'Determine bucket
                For illoop = 1 To 13 Step 1
                    If (llDate >= lmSProjDates(illoop)) And (llDate <= lmEProjDates(illoop)) Then
                        'determine if agy commissionable
                        If tmChf.iAgfCode > 0 And tmSbf.sAgyComm = "Y" Then
                            tmJsr(ilIndex).iAgfCode = tmChf.iAgfCode
                        Else
                            tmJsr(ilIndex).iAgfCode = 0
                        End If
                        tmJsr(ilIndex).lMCHDollars(illoop - 1) = tmJsr(ilIndex).lMCHDollars(illoop - 1) + (tmSbf.lGross * tmSbf.iNoItems)

                        Exit For
                    End If
                Next illoop
            End If
        End If
    Next llSbf
    mWriteJSRProj slGrossNet, ilNumberPeriods
    Exit Sub
mGetNTRProjDataErr: 'VBC NR
    Exit Sub
End Sub

'           gBobCalBySpots - Gather Spots for Billed and Booked by Calendar (Spots option)
'           This subroutine has been duplicated from mBobBuildProjCT subroutine.
'           All references to other reports have been removed; altho some code
'           may not apply because it only goes thru this code for B & B by Cal spots
'
'   GRF fields:
'   grfgenDate - generation date
'   grfGenTime - generation time
'   grfChfCode - contract code
'   grfDateGenl - Date billed or paid
'   grfVefCode - vehicle code (airing or billing)
'   grfAdfCode = advertiser code
'   grfSlfCode = salesperson code
'   grfSofCode = Sales Source
'   grfCode2 - Sales Comparison:  (major or primary sort selection) business category or production cod or agency code or vehicle goup
'   grfCode4 - Sales Commission
'   grfYear - split salesperson/owner flag
'   grfDateType = C = cash, T = trade
'   grfDollars(1-12) 12 months $
'   grfDollars(13) total year $ (gross or net)
'   grsDollars(14-17) Q1 - Q4 $
'   grfDollars(18) - year total $ always net
'   grfPerGenl(1) - 0 = no comparisons , 1 = base date, 2 = comparison date
'   grfPerGenl(2) - new/return flag
'   GrfPerGenl(3) - Minor vehicle group
'   GrfPerGenl(4) - major vehicle group
'   grfPerGenl(5) - Flag for sorting (Net/Net Billed & Booked) 1 = gross, 2 = net, 3= comm
'   grfPerGenl(7) -Participant %
'   grfPerGenl(8) - # periods
'   grfPerGenl(9)-  Is it hard cost (true/false) 3-22-05
'   grfPerGenl(10) - 4-20-05 subsort field for B & B Recap:  1 = airtime, 2 = NTR , 3 = hard cost NTR
'   grfPerGenl(10) - 11-06-06 changed to:  0 = not NTR or Hard cost, > 0 = MNF item code for NTR
'   grfPerGenl(11) - B & B recap 11-06-06 0 = direct, 1 = airtime, 2 = NTR, 3 = political, 4 = Hard cost
'   grfPerGenl(12) - Sales Comparison:  (minor or sub sort selection) business category or production cod or agency code or vehicle goup
'   grfPerGenl(13) - For B & B Comparison: 0 = data from rvf/phf & contracts, 1 = budgets
'   grfPerGenl(14) - Budget mnfcode selected for BOB Comparisons
'   grfPerGenl(18) - # periods to print
'Sales Comparison selection:
'   (imPrimSort) cbcSet1 Index: 0 = Advt, 1 = Agy, 2 = Bus Cat, 3 = Prod Prot, 4 = Slsp, 5 = VEhicle, 6 = Vehicle group
'   (imSubSort) cbcSet2 Index:  0 = none, 1 = Advt, 2 = Agy, 3 = Bus Cat, 4 = Prod Prot, 5 = Slsp, 6 = VEhicle, 7 = Vehicle group
'   lbcSelection(1)= agency,  lbcSelection(2) = Slsp, lbcSelection(3) = Bus Cat, lbcSelection(12) = Vehicle group (single select), 3-18-16 chged from lbcselection(4)
'   lbcSelection(5) = Advt, lbcSelection(6) = vehicle, lbcSelection(7) = prod protection
Public Function gBOBCalBySpots(llStdStartDates() As Long, llLastBilled As Long, ilLastBilledInx As Integer, ilHowManyPer As Integer, ilDateFlag As Integer, tlBillCycle As BILLCYCLE) As Integer
    '           <input>  llStdStartDates() array of start dates (collLastBilleduld be std or calendar) to project across
    '                    llLastBilled - last billed date to start picking up spots
    '                    ilLastBilledInx - index to start/stop projecting; used for Billing method option
    '                    ilHowManyPer - # of periods to gather
    '                    ilDateFlag
    '                    tlBillCycle - if requesting bill cycle method, array of calendar start dates (whereas llStdStartDates array contain the std start date array), plus other flags
    Dim ilRet As Integer
    Dim slStdStart As String            'start date to gather (std start)
    Dim slStdEnd As String              'end date to gather (end of std year)
    Dim slCalStart As String
    Dim slCalEnd As String
    Dim slBillCycleStart As String   '1-20-21 start date of cal if using bill cycle method
    Dim slBillCycleEnd As String     '1-20-21 end date of cal if using bill cycle method
    Dim slTempStart As String           'Start date of period requested (minus 1 month) to handle makegoods outside
                                        'end date of contrct
    Dim slCntrStatus As String          'list of contract status to gather (working, order, hold, etc)
    Dim slCntrType As String            'list of contract types to gather (Per inq, Direct Response, Remnants, etc)
    Dim ilHOState As Integer            'which type of HO cntr states to include (whether revisions should be included)
    Dim llContrCode As Long
    Dim ilCurrentRecd As Integer
    Dim ilFound As Integer
    Dim ilFoundOption As Integer
    Dim illoop As Integer
    Dim ilHowMany As Integer            '# times to loop and process line (up to 10 times for split slsp),
                                        'up to 3 times for 3 diff. owners per vehicle, else loop once per
                                        'flight (or sch line)
    Dim ilHowManyDefined As Integer     '# of percentages (slsp for each contract, or participants for each vehicle)
    Dim ilMatchSSCode As Integer        'Sales Source code to process for participants
    Dim ilClf As Integer                'loop count for lines
    Dim slCode As String
    Dim ilTemp As Integer
    Dim ilScratch As Integer
    Dim llStdStart As Long              'requested start date to gather
    Dim llStdEnd As Long                'requested end date to gather
    Dim llCalStart As Long
    Dim llCalEnd As Long
    Dim llBillCycleStart As Long              '1-21 requested start cal date to gather if using bill cycle option
    Dim llBillCycleEnd As Long                '1-20-21 requested end date cal date to gather if using bill cycle option
    ReDim llBillCycleStartDates(0 To 13) As Long     '1-20-21 start dates of the billing cycle to process
    Dim llBillCycleLastBilled As Long
    Dim ilCorT As Integer
    Dim ilStartCorT As Integer
    Dim ilEndCorT As Integer
    Dim slCashAgyComm As String
    Dim slPctTrade As String
    Dim ilFoundOne As Integer
    Dim llProcessPct As Long             'percent of slsp split, ownership, else 100.0000%
    Dim ilFirstProjInx As Integer
    Dim slCommPct As String                 'for comm proj only - slsp comm % xx.xxxx
    Dim ilSubMissed As Integer             'subtract misses (misses, cancel, hidden)
    Dim ilCountMGs As Integer                'count mgs where they air
    Dim ilAdjust As Integer
    Dim ilUsePkg As Integer                 'true if use package, false if use hidden
    Dim ilVehLoop As Integer                'loop for MGs by vehicle
    ReDim llTempProject(0 To 12) As Long      '12 months projection or MG $. Index zero ignored
    ReDim llTempAcquisition(0 To 12) As Long    'Index zero ignored
    Dim ilNewCode As Integer                    'Revenue area "New" mnf code to show designation on report
    ReDim tlSlf(0 To 0) As SLF                  '4-20-00
    Dim ilUseSlsComm As Integer             'true to use slsp share % for commission reports,
    Dim ilListIndex As Integer                  '3-2-02
    Dim tlSBFType As SBFTypes
    Dim tlSplitInfo As splitinfo
    ReDim tlSbf(0 To 0) As SBF                '9-30-02
    Dim ilOKtoSeeVeh As Integer                 '11-13-03 flag to detrmine if user allowed to see vehicle
                        'else false to use revenue share to split sls $
    Dim ilAdjustDays As Integer             '11-21-05
    Dim llChfCode As Long
    Dim ilVefCode As Integer
    Dim ilWhichKey As Integer
    ReDim ilValidDays(0 To 6) As Integer
    Dim tlPriceTypes As PRICETYPES
    ReDim llSdfCodes(0 To 0) As Long
    ReDim tmSdfInfo(0 To 0) As SDFSORTBYLINE
    Dim ilfirstTime As Integer
    Dim llSpotInx As Long
    Dim llPrevLine As Long
    Dim llUpper As Long
    Dim llLoInx As Long
    Dim llHiInx As Long
    Dim ilAdjustMissedForMG As Integer  'flag to adjust the missed spots for makegoods.
                                        'for all B & B options except Cal (spots), the
                                        'missed part of the mg is subtracted.  When
                                        'gathering spots, ignore the missed part
    Dim llAcquisition(0 To 13) As Long  'Index zero ignored
    Dim llProject(0 To 13) As Long  'Index zero ignored
    Dim ilSlfRecd As Integer
    Dim slNameCode As String
    Dim ilLoopSlsp As Integer
    ReDim tlRvf(0 To 0) As RVF
    Dim slPastStart As String           '1-21-21 earliest and latest search dates to gather CPM podcast actuals from rvf/phf
    Dim slPastEnd As String
    Dim blAllOK As Boolean
    Dim ilWhichPeriod As Integer        '0 = corp, 1 = std, 2 = calendar (if bill method selected, this parameter may get altered with each contract)
    Dim slRvfStart As String            'earliest date to retrieve receivables/history for bill method option
    Dim slRvfEnd As String
    Dim llLastBilledCal As Long
    Dim ilFirstProjCalInx As Integer
    
    'TTP 10666
    Dim tlPcf As PCF                    'TTP 10666
    Dim lDIGITALLINEAVERAGE As DIGITALLINEAVERAGE
    Dim slYear As String
    Dim slMonth As String
    Dim slDay As String
    Dim ilLoop2 As Integer
    Dim llExtAmount As Long
    Dim ilPCFLoop As Integer
    Dim blValidVehicle As Boolean
    Dim slTemp As String
    Dim blFound As Boolean
    Dim slStr As String
    Dim ilDoe As Integer
    
    ilListIndex = RptSelCt!lbcRptType.ListIndex     '3-2-02
    tlSBFType.iNTR = True           'this applies to Billed & Booked only to retrieve future $
    tlSBFType.iInstallment = False
    tlSBFType.iImport = False
    ilUsePkg = False
    If RptSelCt!rbcSelCSelect(0).Value Then     'use pkg, not hidden
        ilUsePkg = True
    End If
    '4-2-00 Prepare for the different slsp commissions by vehicle if applicable
    hmScf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmScf, "", sgDBPath & "Scf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        If tgSpf.sSubCompany = "Y" Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            ilRet = MsgBox("SCF Error # " & str$(ilRet), vbOKOnly + vbExclamation, "mBobBuildProjCt")
            ilRet = btrClose(hmScf)
            btrDestroy hmScf
            btrDestroy hmVef
            btrDestroy hmCHF
            btrDestroy hmSlf
            btrDestroy hmRvf
            btrDestroy hmGrf
            Exit Function
        End If
    End If
    imScfRecLen = Len(tmScf)
    ReDim tlScf(0 To 0) As SCF      '4-2-00
    ReDim tlSlfIndex(0 To 0) As SLFINDEX    '4-2-00
    ilRet = gObtainVef()                  '4-2-00 buildglobal vehicle table
    If ilRet = 0 Then
        btrDestroy hmScf
        btrDestroy hmVef
        btrDestroy hmCHF
        btrDestroy hmSlf
        btrDestroy hmRvf
        btrDestroy hmGrf
        btrDestroy hmVef
        Exit Function
    End If
    ilRet = gObtainSlf(RptSelCt, hmSlf, tlSlf())
    ilUseSlsComm = False            'use revenue share if by slsp (not comm share %)
    If Not tlBillCycle.blBillCycle Then         '1-14-21 not getting receivables by billing method.  There is an extra set of dates that contain the cal dates if by bill cycle
                                                'when those dates are not used, make them the same as the std set
        For illoop = 0 To 13
            tlBillCycle.lBillCycleStartDates(illoop) = llStdStartDates(illoop)
        Next illoop
        'set the remaining fields with a default
        tlBillCycle.lBillCycleLastBilled = llLastBilled
        tlBillCycle.iBillCycleLastBilledInx = 1         'everything in the future
    End If
    
    If tgSpf.sSubCompany = "Y" Then         'using commission by vehicle (sub-company)?
        '4-24-00 Build  slsp commission table
        ilRet = gObtainScf(RptSelCt, hmScf, tlScf(), llStdStartDates(1), tlBillCycle.lBillCycleStartDates(13), tlSlfIndex())     '1-20-21 use the widest start and end date span just in case using the bill cycle method
    End If
    imMajorSet = 0
    If imVehicle Then
        illoop = RptSelCt!cbcSet1.ListIndex             'retrieve the vehicle set selected (applies to vehicle option)
        imMajorSet = tgVehicleSets1(illoop).iCode
    End If
    'build array of selling office codes and their sales sources.  This is the most major sort
    'in the Business Booked reports
    ilTemp = 0
    ilRet = btrGetFirst(hmSof, tmSof, imSofRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
    Do While ilRet = BTRV_ERR_NONE
        ReDim Preserve tlSofList(0 To ilTemp) As SOFLIST
        tlSofList(ilTemp).iSofCode = tmSof.iCode
        tlSofList(ilTemp).iMnfSSCode = tmSof.iMnfSSCode
        ilRet = btrGetNext(hmSof, tmSof, imSofRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        ilTemp = ilTemp + 1
    Loop

    sgDemoMnfStamp = ""             'insure that the revenue sets are read
    ReDim tlMnf(0 To 0) As MNF
    'Get the revenue sets and find "New" code
    ilRet = gObtainMnfForType("R", sgDemoMnfStamp, tlMnf())
    ilNewCode = 0
    For illoop = LBound(tlMnf) To UBound(tlMnf) - 1 Step 1
        tmMnf = tlMnf(illoop)
        If Trim$(tmMnf.sName) = "New" Then
            ilNewCode = tmMnf.iCode
            Exit For
        End If
    Next illoop

    '------------------------------------------------
    ilAdjust = True
    ilSubMissed = False
    ilCountMGs = False
    ilAdjustMissedForMG = False
    
    tmSpotTypes.iCancel = True
    tmSpotTypes.iClose = False          '1-18-11 ignore close bb
    tmSpotTypes.iFill = False
    tmSpotTypes.iHidden = False             '3-5-15 alway exclude hidden
    tmSpotTypes.iMissed = True
    tmSpotTypes.iMG = False
    tmSpotTypes.iOpen = False           '1-18-11 ignore open bb
    tmSpotTypes.iOutside = False
    tmSpotTypes.iSched = True
    
    'ilSubMissed = gSetCheck(RptSelCt!ckcSelC8(0).Value) 'For standard lines- subtract unresolved missed
    If RptSelCt!ckcSelC8(0).Value = vbChecked Then      'For standard lines- subtract unresolved missed
        ilSubMissed = True
        tmSpotTypes.iCancel = False
    End If
    
    'ilCountMGs = gSetCheck(RptSelCt!ckcSelC8(1).Value)  'Count MGs where they air
    If RptSelCt!ckcSelC8(1).Value = vbChecked Then      'Count MGs where they air
        ilCountMGs = True
    End If
    
    smAirOrder = tgSpf.sInvAirOrder         'bill as ordred, aired
    ilWhichPeriod = 2                       'default to Calendar option ;  may change if bill method selected
    
    '1-20-21 used to gather contracts and sbf records
    'if requesting bill method, get the earliest based on std (it will always be earlier or same as calendar), and get the lastest using calendar
    If tlBillCycle.blBillCycle Then             'using bill cycle
'        ilFirstProjInx = ilLastBilledInx + 1            'if all in the future, this needs to be 1
        ilFirstProjCalInx = 1
        ilFirstProjInx = 1
        'determine which months to project for both cal and std

        'std
        If llLastBilled < llStdStartDates(1) Then
            ilLastBilledInx = 1                     'everything in the future
        Else
            'determine what month, if any, is in the past.  Set ilLastBilledInx to the last month billed
            For illoop = 1 To 12 Step 1
                If llLastBilled > llStdStartDates(illoop) And llLastBilled < llStdStartDates(illoop + 1) Then
                    ilLastBilledInx = illoop + 1
                    Exit For
                End If
            Next illoop
        End If
        
        'cal
        If tlBillCycle.lBillCycleLastBilled < tlBillCycle.lBillCycleStartDates(1) Then
            ilFirstProjCalInx = 1                     'everything in the future
        Else
            'determine what month, if any, is in the past.  Set ilLastBilledInx to the last month billed
            For illoop = 1 To 12 Step 1
                If tlBillCycle.lBillCycleLastBilled > tlBillCycle.lBillCycleStartDates(illoop) And tlBillCycle.lBillCycleLastBilled < tlBillCycle.lBillCycleStartDates(illoop + 1) Then
                    ilFirstProjCalInx = illoop + 1
                    Exit For
                End If
            Next illoop
        End If

        slCalStart = Format$(llStdStartDates(1), "m/d/yy")
        slCalEnd = Format$(tlBillCycle.lBillCycleStartDates(ilHowManyPer + 1), "m/d/yy")
        llCalStart = tlBillCycle.lBillCycleStartDates(ilFirstProjInx)                'first date to project
        llCalEnd = tlBillCycle.lBillCycleStartDates(ilHowManyPer + 1)                'end date to project
        llLastBilledCal = tlBillCycle.lBillCycleLastBilled
        slStdStart = Format$(llStdStartDates(1), "m/d/yy")      'get the earliest and latest dates to retrieve contracts based on the earliest std date (earliest date to report,and latest cal date (last month to report)
        slBillCycleEnd = Format$(llCalEnd, "m/d/yy")
        slStdEnd = Format$(llStdStartDates(ilHowManyPer + 1), "m/d/yy")
    Else
        slStdStart = Format$(llStdStartDates(1), "m/d/yy")
        slStdEnd = Format$(llStdStartDates(ilHowManyPer + 1), "m/d/yy")
        slBillCycleEnd = slStdEnd
        ilFirstProjInx = 1
    End If
    
    'v81 TTP 10666 - new issue Wed 5/3/23 4:01 PM
    gUnpackDate tgSpf.iBLastCalMnth(0), tgSpf.iBLastCalMnth(1), slStr
    If Trim$(slStr) = "" Then
        slStr = "1/1/1975"
    End If
    llLastBilledCal = gDateValue(slStr)
    'the Tran typs are to retrieve receivables for past billing. the remaining $ on adserver IDs will be averaged (TTP 10666)
    'TTP 10844 - RAB and Billed and Booked report: digital line invoice adjustments were being included even if the "include adjustments" checkbox was not checked
    'tmTranTypes.iAdj = True
    tmTranTypes.iAdj = False
    tmTranTypes.iAirTime = True
    tmTranTypes.iCash = True
    tmTranTypes.iInv = True
    tmTranTypes.iMerch = False
    tmTranTypes.iNTR = False
    tmTranTypes.iPromo = False
    tmTranTypes.iPymt = False
    tmTranTypes.iTrade = False
    tmTranTypes.iWriteOff = False
    
    '3-2-02 if Billed and Booked use the entered #periods, otherwise force to 12 for all other options
    'igPeriods = Val(RptSelCt!edcSelCTo1.Text)
    '3-2-02 if Billed and Booked use the entered #periods, otherwise force to 12 for all other options
    igPeriods = Val(RptSelCt!edcSelCTo1.Text)

    'tmGrf.iPerGenl(8) = igPeriods                   '3-4-02 show # periods requestd on report
    If igPeriods < 1 Or igPeriods > 12 Then
        igPeriods = 12              'if errors in input, get normal report of 12 months
    End If
    tmGrf.iPerGenl(7) = igPeriods                   '3-4-02 show # periods requestd on report
    
    llStdStart = llStdStartDates(ilFirstProjInx)                'first date to project
    llStdEnd = llStdStartDates(ilHowManyPer + 1)                'end date to project

    ReDim llCalSpots(0 To 0) As Long        'init buckets for daily calendar values
    ReDim llCalAmt(0 To 0) As Long
    ReDim llCalAcqAmt(0 To 0) As Long

    ilAdjustDays = (llStdStartDates(ilHowManyPer + 1) - llStdStartDates(1)) + 1
    ReDim llCalSpots(0 To ilAdjustDays) As Long        'init buckets for daily calendar values
    ReDim llCalAmt(0 To ilAdjustDays) As Long
    ReDim llCalAcqAmt(0 To ilAdjustDays) As Long
    For illoop = 0 To 6                         'days of the week
        ilValidDays(illoop) = True              'force alldays as valid
    Next illoop
    
    'dont bother trying to calculate rates that are 0, since this report doesnt need spot counts
    tlPriceTypes.iCharge = True     'Chargeable lines
    tlPriceTypes.iZero = False      '.00 lines
    tlPriceTypes.iADU = False     'adu lines
    tlPriceTypes.iBonus = False          'bonus lines
    tlPriceTypes.iNC = False          'N/C lines
    tlPriceTypes.iRecap = False        'recapturable
    tlPriceTypes.iSpinoff = False      'spinoff

    If Not imNTR And Not imHardCost Then           '3-22-05 is ntr or hard cost selected?
        tlSBFType.iNTR = False           'no, ignore NTR projected $
    End If

    'build array of misses reasons and their billing rules so it doesn't have to be read with each missed spot
    ilTemp = 0
    ilRet = btrGetFirst(hmMnf, tmMnf, imMnfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
    Do While ilRet = BTRV_ERR_NONE
        If tmMnf.sType = "M" Then
            ReDim Preserve tmMnfList(0 To ilTemp) As MNFLIST
            tmMnfList(ilTemp).iMnfCode = tmMnf.iCode
            tmMnfList(ilTemp).iBillMissMG = tmMnf.iGroupNo
            ilTemp = ilTemp + 1
        End If
        ilRet = btrGetNext(hmMnf, tmMnf, imMnfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    slCntrStatus = ""                 'statuses: hold, order, unsch hold, uns order
    If imHold Then                  'exclude holds and uns holds
        slCntrStatus = "H"             ' 11-21-13 should get scheduled holds, not unsch as this is by spot
    End If
    If imOrder Then                  'exclude holds and uns holds
        slCntrStatus = slCntrStatus & "O"           '11-21-13 should get scheduled orders, not unsch as this is by spot
    End If
    slCntrType = ""
    If RptSelCt!ckcSelC5(0).Value = vbChecked Then
        slCntrType = "C"
    End If
    If RptSelCt!ckcSelC5(1).Value = vbChecked Then
        slCntrType = slCntrType & "V"
    End If
    If RptSelCt!ckcSelC5(2).Value = vbChecked Then
        slCntrType = slCntrType & "T"
    End If
    If RptSelCt!ckcSelC5(3).Value = vbChecked Then
        slCntrType = slCntrType & "R"
    End If
    If RptSelCt!ckcSelC5(4).Value = vbChecked Then
        slCntrType = slCntrType & "Q"
    End If
    If RptSelCt!ckcSelC5(5).Value = vbChecked Then
        slCntrType = slCntrType & "S"
    End If
    If RptSelCt!ckcSelC5(1).Value = vbChecked Then
        slCntrType = slCntrType & "M"
    End If
    If slCntrType = "CVTRQSM" Then          'all types: PI, DR, etc.  except PSA(p) and Promo(m)
        slCntrType = ""                     'blank out string for "All"
    End If
    ilHOState = 1                       '11-21-13  everything should be a scheduled hold or order since this is getting spots
    'build table (into tlchfadvtext) of all contracts that fall within the dates required
    'Back up the start date for gathering of contracts by one month.  This will include
    'the case where the contract has ended, but makegood spots are in the next month.
    'If the contract spanned the first quarter requested, the makegood spot outside the
    'end date of the contract was gathered.  but if the contract was outside the requested
    'first quarter, the makegood was not gathered.

    ilAdjustDays = 30       'adjustment for the days back to retrieve contracts
    '11-21-05 get effective pacing date by option
    lmPacingDate = 0
    'only bill & booked and b & b Recap can be pacing reports
    If RptSelCt!edcText.Text <> "" Then
        slCode = RptSelCt!edcText.Text
        lmPacingDate = gDateValue(slCode)
        ilAdjustDays = 90
    End If

    ReDim tmCntAllYear(0 To 0) As ALLPIFPCTYEAR

    slTempStart = Format$((gDateValue(slStdStart) - ilAdjustDays), "m/d/yy")
    ilRet = gObtainCntrForDate(RptSelCt, slTempStart, slBillCycleEnd, slCntrStatus, slCntrType, ilHOState, tlChfAdvtExt())            '1-20-21 use the widest span possible when using bill cycle option
    For illoop = 1 To 13 Step 1
        lmProject(illoop) = 0
        lmAcquisition(illoop) = 0
    Next illoop

    'Create array of agy, advt, vehicle (etc) codes to include or exclude to
    'avoid parsing the list boxes for each contract/line
    If imAdvt Then
        gObtainCodesForMultipleLists 5, tgAdvertiser(), imInclAdfCodes, imUseAdfCodes(), RptSelCt
    ElseIf imAgency Then
        gObtainCodesForMultipleLists 1, tgAgency(), imInclAgfCodes, imUseAgfCodes(), RptSelCt
    ElseIf imBusCat Then
        gObtainCodesForMultipleLists 3, tgMNFCodeRpt(), imInclCatCodes, imUseCatCodes(), RptSelCt
    ElseIf imProdProt Then
        gObtainCodesForMultipleLists 7, tgMnfCodeCT(), imInclProdCodes, imUseProdCodes(), RptSelCt
    ElseIf imVehicle Then
        gObtainCodesForMultipleLists 6, tgCSVNameCode(), imInclVefCodes, imUsevefcodes(), RptSelCt
        gAddDormantVefToExclList imInclVefCodes, tgMVef(), imUsevefcodes()          '8-4-17 if excluding vehicles, make sure dormant ones exluded since                                                                                'they wont be in original list
    End If

    For ilCurrentRecd = LBound(tlChfAdvtExt) To UBound(tlChfAdvtExt) - 1 Step 1                                          'loop while llCurrentRecd < llRecsRemaining
        ilDoe = ilDoe + 1
        If ilDoe > 500 Then
            ilDoe = 0
            DoEvents
        End If
        'check for valid slsp selection
        ilFound = True          'assume found something to report until selectivity checking

        If imAdvt Then          'advertiser selectivity
            If (Not RptSelCt!ckcAll.Value = vbChecked) Then
                ilFound = False                             'assume nothing found until match in advt selection table
                'If gFilterLists(tlChfAdvtExt(ilCurrentRecd).iAdfCode, imIncludeCodes, imUseCodes()) Then
                If gFilterLists(tlChfAdvtExt(ilCurrentRecd).iAdfCode, imInclAdfCodes, imUseAdfCodes()) Then
                    ilFound = True
                End If
            End If
        'cant test for exclusion of business category or product protection yet since contract not read in
        ElseIf imAgency Then
            If Not RptSelCt!ckcAll.Value = vbChecked Then
               ilFound = False
               'If gFilterLists(tlChfAdvtExt(ilCurrentRecd).iAgfCode, imIncludeCodes, imUseCodes()) Then
                If gFilterLists(tlChfAdvtExt(ilCurrentRecd).iAgfCode, imInclAgfCodes, imUseAgfCodes()) Then
                    ilFound = True
                End If
            End If
        End If

        If lmSingleCntr > 0 And lmSingleCntr <> tlChfAdvtExt(ilCurrentRecd).lCntrNo Then
            ilFound = False
        End If

        '5-26-06 Check for political only option on Sales Comparison
        If (ilFound) Then
            'if the record is valid for inclusion, see if Sales Comparison asks for Political only
            If mCheckAdvPolitical(tlChfAdvtExt(ilCurrentRecd).iAdfCode) Then          'its a political, include this contract?
                 If Not imInclPolit Then
                    ilFound = False
                End If
            Else                                                'not a political advt, include this contract?
                 If Not imInclNonPolit Then
                    ilFound = False
                End If
            End If
        End If

        If (ilFound) Then
            If lmPacingDate > 0 Then        'get the proper contract revision for this pacing date
                llContrCode = gPaceCntr(tlChfAdvtExt(ilCurrentRecd).lCntrNo, lmPacingDate, hmCHF, tmChf)
            Else
                llContrCode = tlChfAdvtExt(ilCurrentRecd).lCode
            End If
            
            ilRet = gObtainCntr(hmCHF, hmClf, hmCff, llContrCode, False, tgChfCT, tgClfCT(), tgCffCT(), False)  '8-28-12 do not sort by special dp order
            ilFoundOption = True
            If Not RptSelCt!ckcAll.Value = vbChecked Then 'passed all filters so far and selecting all entries?
                If imBusCat Or imSubSort = 3 Then       'imSubsort used for SalesComparison minor sort and subtotals
                    ilFoundOption = False
                    If gFilterLists(tgChfCT.iMnfBus, imInclCatCodes, imUseCatCodes()) Then

                        ilFoundOption = True
                    End If
                ElseIf imProdProt Or imSubSort = 4 Then      'imSubsort used for SalesComparison minor sort and subtotals
                    ilFoundOption = False
                    If gFilterLists(tgChfCT.iMnfComp(0), imInclProdCodes, imUseProdCodes()) Then
                        ilFoundOption = True
                    End If
                End If
            End If

            If ((tgChfCT.iPctTrade < 100) Or (tgChfCT.iPctTrade = 100 And imTrade)) And (ilFoundOption) Then        'all trade contr, include?
                'obtain agency for commission
                If (tgChfCT.iAgfCode > 0) And (Not imUseAcquisitionCost) Then  'if direct advert or showing acquisition costs, dont take any agency comm out
                    tmAgfSrchKey.iCode = tgChfCT.iAgfCode
                    ilRet = btrGetEqual(hmAgf, tmAgf, imAgfRecLen, tmAgfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'get matching agy recd
                    If ilRet = BTRV_ERR_NONE Then
                        slCashAgyComm = gIntToStrDec(tmAgf.iComm, 2)
                    End If          'ilret = btrv_err_none
                Else
                    slCashAgyComm = ".00"
                End If              'iagfcode > 0

                slPctTrade = gIntToStrDec(tgChfCT.iPctTrade, 0)
                If tgChfCT.iPctTrade = 0 Then                     'setup loop to do cash & trade
                    ilStartCorT = 1
                    ilEndCorT = 1
                ElseIf tgChfCT.iPctTrade = 100 Then
                    ilStartCorT = 2
                    ilEndCorT = 2
                Else
                    ilStartCorT = 1
                    If imTrade Then             'Include trades?
                        ilEndCorT = 2
                    Else
                        ilEndCorT = 1
                    End If
                End If

                '9-30-02 this code was moved from inside line processing to outside of line processing
                 'obtain the sales source for major sort of business booked reports
                If tgChfCT.iSlfCode(0) <> tmSlf.iCode Then        'only read slsp recd if not in mem already
                    tmSlfSrchKey.iCode = tgChfCT.iSlfCode(0)         'find the slsp to obtain the sales source code
                    ilRet = btrGetEqual(hmSlf, tmSlf, imSlfRecLen, tmSlfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                    slCommPct = gIntToStrDec(tmSlf.iUnderComm, 2)
                    If tgChfCT.sType = "T" Then                   'if remnant, differ commission
                        slCommPct = gIntToStrDec(tmSlf.iRemUnderComm, 2)
                    End If
                End If                                          'table of selling offices built into memory with its
                                                            'associated sales source
                For illoop = LBound(tlSofList) To UBound(tlSofList)
                    If tlSofList(illoop).iSofCode = tmSlf.iSofCode Then
                        ilMatchSSCode = tlSofList(illoop).iMnfSSCode          'Sales source
                        Exit For
                    End If
                Next illoop

                ReDim tmAdjust(0 To 0) As ADJUSTLIST             'prepare list of mgs
                imUpperAdjust = 0
                
                'setup the calendar dates same as standard start dates in case not using calendar (make 2 date arrays the same)
                For illoop = 0 To 13
                    llBillCycleStartDates(illoop) = llStdStartDates(illoop)
                Next illoop
                '1-20-21 setup the start/end dates to use based on the billing cycle so common fields can be used for testing
                If tlBillCycle.blBillCycle Then
                    If tgChfCT.sBillCycle = "S" Then            'std bill
                        slBillCycleStart = slStdStart
                        slBillCycleEnd = slStdEnd
                        llBillCycleStart = llStdStart
                        llBillCycleEnd = llStdEnd
                        ilWhichPeriod = -1                       'send adserver routine standard calendar computation; negative indicator to routine to include receivables
                        llBillCycleLastBilled = llLastBilled
                        ilFirstProjInx = ilLastBilledInx
                    Else                                        'cal bill
                        slBillCycleStart = slCalStart
                        slBillCycleEnd = slCalEnd
                        llBillCycleStart = llCalStart
                        llBillCycleEnd = llCalEnd
                        For illoop = 0 To 13
                            llBillCycleStartDates(illoop) = tlBillCycle.lBillCycleStartDates(illoop)
                        Next illoop
                        ilWhichPeriod = -2                   'send ad server routine calendar option computation; negative indicator to routine to include receivables
                        llBillCycleLastBilled = llLastBilledCal
                        ilFirstProjInx = ilFirstProjCalInx
                    End If
                Else
                    slBillCycleStart = slStdStart
                    slBillCycleEnd = slStdEnd
                    llBillCycleStart = llStdStart
                    llBillCycleEnd = llStdEnd
                End If

                'only go thru SBF if NTR should be included and the contract header has it flagged as an NTR order
                '1-27-07 implement NTR/hard cost into Sales Comparison
                If ((tgChfCT.sNTRDefined = "Y") And (imNTR = True Or imHardCost = True)) Then          ' get the SBF (NTR Item billing) for the future if Item billing defined
                    ReDim tmSBFAdjust(0 To 0) As ADJUSTLIST             'build new for every contract
                    '1-20-21 use the common date fields used if running by Bill cycle method
                    ilRet = gObtainSBF(RptSelCt, hmSbf, tgChfCT.lCode, slBillCycleStart, slBillCycleEnd, tlSBFType, tlSbf(), 0) '11-28-06 add last parm to indicate which key to use
                    'Build array of the vehicles and their NTR $ into tmSBFAdjust array
                    '1-20-21 if using bill cycle method, use the proper dates based on how its billed
                    mBobSbfAdjustForNTR tlSbf(), llBillCycleStartDates(), ilFirstProjInx, llBillCycleStart, llBillCycleEnd, ilHowManyPer, ilListIndex, tlMnf()
                    'loop on sbf to process each $
                    For ilVehLoop = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1      '11-06-06 chg to ubound -1
                        ilDoe = ilDoe + 1
                        If ilDoe > 500 Then
                            ilDoe = 0
                            DoEvents
                        End If
                        ilFoundOption = True                    'assume everything included
                        If imVehicle And Not RptSelCt!ckcAll.Value = vbChecked Then   'vehicle option and selected vehicles
                            ilFoundOption = False
                            If gFilterLists(tmSBFAdjust(ilVehLoop).iVefCode, imInclVefCodes, imUsevefcodes()) Then
                                ilFoundOption = True
                            End If
                        End If
                        '12-6-07 changed to use gCntrOKForUser instead of testing vehicle
                        'ilOKtoSeeVeh = gUserAllowedVehicle(Val(slCode))     '11-13-03 user allowed to see vehicle?
                        ilOKtoSeeVeh = True             '12-05-06 force to be ok since it already passed contract test
                        
                        If ilOKtoSeeVeh Then
                            mBobSelectVeh tmSBFAdjust(ilVehLoop).iVefCode, ilFoundOption, ilListIndex 'if slsp (with veh subtotals) or vehicle option, see if this vehicle is selected

                            If ilFoundOption Then
                                tlSplitInfo.iMatchSSCode = ilMatchSSCode
                                tlSplitInfo.iStartCorT = ilStartCorT
                                tlSplitInfo.iEndCorT = ilEndCorT
                                tlSplitInfo.iFirstProjInx = ilFirstProjInx
                                tlSplitInfo.iUseSlsComm = ilUseSlsComm
                                tlSplitInfo.iVefCode = tmSBFAdjust(ilVehLoop).iVefCode
                                tlSplitInfo.iDateFlag = ilDateFlag
                                tlSplitInfo.iNewCode = ilNewCode
                                tlSplitInfo.sPctTrade = slPctTrade
                                tlSplitInfo.sTradeAgyComm = tmSBFAdjust(ilVehLoop).sAgyComm
                                If tmSBFAdjust(ilVehLoop).sAgyComm = "Y" Then
                                    tlSplitInfo.sCashAgyComm = slCashAgyComm
                                Else
                                    tlSplitInfo.sCashAgyComm = "00.00"
                                End If
                                tlSplitInfo.iNTRSlspComm = tmSBFAdjust(ilVehLoop).iSlsCommPct      '2-2-04 NTR slsp comm if not using sub-companies.
                                tlSplitInfo.sNTR = "Y"
                                tlSplitInfo.iHardCost = tmSBFAdjust(ilVehLoop).iIsItHardCost      'true false if hard cost
                                tlSplitInfo.iMnfNTRItemCode = tmSBFAdjust(ilVehLoop).iMnfItem       '11-06-06 NTR Item type from MNF
                                For illoop = 1 To 12
                                    lmProject(illoop) = tmSBFAdjust(ilVehLoop).lProject(illoop)
                                    lmAcquisition(illoop) = tmSBFAdjust(ilVehLoop).lAcquisitionCost(illoop)
                                Next illoop
                                '2-3-03 fake out the schedule line since there isnt a schedule line that contains vefcode
                                tmClf.iVefCode = tlSplitInfo.iVefCode   'other subrtn use the vehicle code from line (SBF doesnt have sch lines)
                                tmClf.sType = "S"       'standard line
                                '1-20-21 if using bill cycle option, need to use the correct set of dates to project
                                mBobSetupPctOfSplit tlSplitInfo, llBillCycleStartDates(), tlSlf(), tlScf(), tlSlfIndex(), tmCntAllYear(), tmOneVehAllYear()
                            End If
                        End If
                    Next ilVehLoop
                End If  '--End of NTR
                
                'AD Server
                'TTP 10306: Billed and Booked: Cal spots - ad server lines included, which is inconsistent with cal spots versions of revenue exports (RAB, Matrix, etc.)
                'TTP 10955 - Billed and Booked Cal Spots: slowness reported, possibly due to including digital lines
                'If RptSelCt!rbcSelC9(3).Value = False Then 'Cal (Spots)=False
                If RptSelCt!ckcSelC3(10).Value = vbChecked And RptSelCt!rbcSelC9(3).Value = False Then 'Digital Checked and Cal (Spots)=False
                    'Insure the common monthly buckets are initialized for the adserver data
                    For illoop = 1 To 12
                        lmProject(illoop) = 0
                        lmAcquisition(illoop) = 0
                        lmAcquisitionNet(illoop) = 0
                    Next illoop
    
                    '1-21-21 For CPM podcast, take the overall $ ordered (pcf), subtract the billed(rvf/phf), and average the remaining across the overall months ordered  (total ordered - total billed)
                    If (tgChfCT.sAdServerDefined = "Y") And (ilListIndex = CNT_BOB) Then
                        gUnpackDate tgChfCT.iStartDate(0), tgChfCT.iStartDate(1), slRvfStart
                        If tlBillCycle.blBillCycle Then
                            If tgChfCT.sBillCycle = "S" Then
                               slRvfEnd = Format(llLastBilled, "ddddd")
                            Else
                                slRvfEnd = Format(tlBillCycle.lBillCycleLastBilled, "ddddd")
                            End If
                        End If
    
                        ReDim tmSBFAdjust(0 To 0) As ADJUSTLIST             'build new for every contract
                        blAllOK = gObtainPcf(hmPcf, tgChfCT.lCode, tmPcf())       'obtain all pcm for matching contract code
                        If blAllOK Then
                            'gather all the receivables that exist for this contract
                            If Abs(ilWhichPeriod) = 1 Or ilWhichPeriod = -2 Then        'std and cal bill cycle method needs receivables
                                ilRet = gObtainPhfRvfbyCntr(RptSelCt, tgChfCT.lCntrNo, slRvfStart, slRvfEnd, tmTranTypes, tlRvf())
                            Else
                                ReDim tlRvf(0 To 0) As RVF
                                ilRet = True
                            End If
                            If ilRet = True Then          'got data , OK
    '                            mBobAdjustForAdServer tmPcf(), tlRvf(), llBillCycleStartDates(), ilFirstProjInx, ilHowManyPer, ilWhichPeriod
                                mBobAdjustForAdServer tmPcf(), tlRvf(), llBillCycleStartDates(), llBillCycleLastBilled, ilHowManyPer, ilWhichPeriod, tgChfCT.lCntrNo
                                'loop on sbf to process each $
                                For ilVehLoop = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1      '11-06-06 chg to ubound -1
                                    ilDoe = ilDoe + 1
                                    If ilDoe > 500 Then
                                        ilDoe = 0
                                        DoEvents
                                    End If
                                    ilFoundOption = True                    'assume everything included
                                    If imVehicle And Not RptSelCt!ckcAll.Value = vbChecked Then   'vehicle option and selected vehicles
                                        ilFoundOption = False
                                        If gFilterLists(tmSBFAdjust(ilVehLoop).iVefCode, imInclVefCodes, imUsevefcodes()) Then
                                            ilFoundOption = True
                                        End If
                                    End If
    
                                    mBobSelectVeh tmSBFAdjust(ilVehLoop).iVefCode, ilFoundOption, ilListIndex 'if slsp (with veh subtotals) or vehicle option, see if this vehicle is selected
    
                                    If ilFoundOption Then
                                        tlSplitInfo.iMatchSSCode = ilMatchSSCode
                                        tlSplitInfo.iStartCorT = ilStartCorT
                                        tlSplitInfo.iEndCorT = ilEndCorT
                                        tlSplitInfo.iFirstProjInx = ilFirstProjInx
                                        tlSplitInfo.iUseSlsComm = ilUseSlsComm
                                        tlSplitInfo.iVefCode = tmSBFAdjust(ilVehLoop).iVefCode
                                        tlSplitInfo.iDateFlag = ilDateFlag
                                        tlSplitInfo.iNewCode = ilNewCode
                                        tlSplitInfo.sPctTrade = slPctTrade
                                        tlSplitInfo.sCashAgyComm = slCashAgyComm
                                        tlSplitInfo.sTradeAgyComm = tgChfCT.sAgyCTrade        '12-23-02
                                        tlSplitInfo.iNTRSlspComm = 0
                                        tlSplitInfo.sNTR = "N"
                                        tlSplitInfo.iHardCost = False
                                        tlSplitInfo.iMnfNTRItemCode = 0         '11-06-06 not an NTR
    
                                        For illoop = 1 To 12
                                            lmProject(illoop) = tmSBFAdjust(ilVehLoop).lProject(illoop)
                                            lmAcquisition(illoop) = tmSBFAdjust(ilVehLoop).lAcquisitionCost(illoop)
                                        Next illoop
                                        '2-3-03 fake out the schedule line since there isnt a schedule line that contains vefcode
                                        tmClf.iVefCode = tlSplitInfo.iVefCode   'other subrtn (mFoundSelection) use the vehicle code from line (PCF doesnt have sch lines)
                                        tmClf.sType = "S"       'standard line
                                        '1-20-21 if using bill cycle option, need to use the correct set of dates to project
                                        mBobSetupPctOfSplit tlSplitInfo, llBillCycleStartDates(), tlSlf(), tlScf(), tlSlfIndex(), tmCntAllYear(), tmOneVehAllYear()
                                    End If
                                Next ilVehLoop
                            End If '--End of Obtain PhfRvf ok
                        End If '--End of Obtain PCF Ok
                    End If '--End of AD Server
                End If
                
                '-------------------------------------------------------------------------------------------
                'TTP 10666 - daily avg Digital lines in RAB & B&B Cal Spots
                'TTP 10955 - Billed and Booked Cal Spots: slowness reported, possibly due to including digital lines
                'If RptSelCt!rbcSelC9(3).Value = True And (tgChfCT.sAdServerDefined = "Y") And (ilListIndex = CNT_BOB) Then 'Cal (Spots)=True
                If RptSelCt!ckcSelC3(10).Value = vbChecked And RptSelCt!rbcSelC9(3).Value = True And (tgChfCT.sAdServerDefined = "Y") And (ilListIndex = CNT_BOB) Then 'Digital Checked, Cal (Spots)=True
                    'Insure the common monthly buckets are initialized for the adserver data
                    For illoop = 1 To 12
                        lmProject(illoop) = 0
                        lmAcquisition(illoop) = 0
                        lmAcquisitionNet(illoop) = 0
                    Next illoop
                    
                    gUnpackDate tgChfCT.iStartDate(0), tgChfCT.iStartDate(1), slRvfStart
                    If tgChfCT.sBillCycle = "S" Then
                       slRvfEnd = Format(llLastBilled, "ddddd")
                    Else
                        'slRvfEnd = Format(tlBillCycle.lBillCycleLastBilled, "ddddd")
                        slRvfEnd = Format(llLastBilledCal, "ddddd")
                    End If
                
                    ReDim tmSBFAdjust(0 To 0) As ADJUSTLIST             'build new for every contract
                    blAllOK = gObtainPcf(hmPcf, tgChfCT.lCode, tmPcf())       'obtain all pcm for matching contract code
                    If blAllOK Then
                        'gather all the receivables that exist for this contract
                        ReDim tlRvf(0 To 0) As RVF 'RE: WWO B&B by CAL Spots TTP 10760
                        If DateDiff("d", slRvfStart, slRvfEnd) > -1 Then
                            ilRet = gObtainPhfRvfbyCntr(RptSelCt, tgChfCT.lCntrNo, slRvfStart, slRvfEnd, tmTranTypes, tlRvf())
                        Else
                            ilRet = -1
                        End If
                        
                        If ilRet = True Then          'got data , OK
                            '-------------------------------------
                            'create entry into tmSBFAdjust, for all Lines ORDERED from PCF
                            For ilPCFLoop = LBound(tmPcf) To UBound(tmPcf) - 1
                                ilDoe = ilDoe + 1
                                  If ilDoe > 60 Then
                                      ilDoe = 0
                                      DoEvents
                                  End If
                                tlPcf = tmPcf(ilPCFLoop)
                                blValidVehicle = True
                                'If gFilterLists(tmSBFAdjust(ilVehLoop).iVefCode, imInclVefCodes, imUsevefcodes()) Then
                                If imVehicle Then
                                    If Not gFilterLists(tlPcf.iVefCode, imInclVefCodes, imUsevefcodes()) Then
                                        blValidVehicle = False        'not a selected vehicle; bypass
                                    End If
                                End If
                                If blValidVehicle And tlPcf.sType <> "P" Then            'get only the hidden lines or standard line IDs, ignore Pkg
                                    blFound = False
                                    For illoop = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1 Step 1
                                        If tmSBFAdjust(illoop).lPodCode = tlPcf.lCode Then
                                            tmSBFAdjust(illoop).lOrderedCPMCost = tmSBFAdjust(illoop).lOrderedCPMCost + tlPcf.lTotalCost
                                            blFound = True
                                            Exit For
                                        End If
                                    Next illoop
                                    If Not (blFound) Then
                                        illoop = UBound(tmSBFAdjust)
                                        tmSBFAdjust(illoop).iVefCode = tlPcf.iVefCode
                                        tmSBFAdjust(illoop).lOrderedCPMCost = tlPcf.lTotalCost
                                        tmSBFAdjust(illoop).lPodCode = tlPcf.lCode
                                        ReDim Preserve tmSBFAdjust(0 To UBound(tmSBFAdjust) + 1) As ADJUSTLIST
                                    End If
                                End If
                            Next ilPCFLoop
                            
                            '-------------------------------------
                            'get the amounts of adserver Ordered (PCF)
                            'TTP 10955 - Billed and Booked Cal Spots: slowness reported, possibly due to including digital lines
                            gObtainPcfByCntrNo tgChfCT.lCntrNo, tmPcf2
                            
                            For ilPCFLoop = LBound(tmPcf) To UBound(tmPcf) - 1
                                ilDoe = ilDoe + 1
                                If ilDoe > 500 Then
                                    ilDoe = 0
                                    DoEvents
                                End If
                                tlPcf = tmPcf(ilPCFLoop)
                                'v81 TTP 10666 - new issue Wed 5/3/23 4:01 PM - added Last billed Cal date parm
                                lDIGITALLINEAVERAGE = gBuildDigitalLineAverage(tgChfCT.sBillCycle, llLastBilled, llLastBilledCal, tlPcf, tlRvf(), tmPcf2)
                                If lDIGITALLINEAVERAGE.lPcfCode <> 0 Then
                                    For ilAdjust = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1
                                        If tmSBFAdjust(ilAdjust).lPodCode = lDIGITALLINEAVERAGE.lPcfCode Then
                                            tlSplitInfo.iMatchSSCode = ilMatchSSCode
                                            tlSplitInfo.iStartCorT = ilStartCorT
                                            tlSplitInfo.iEndCorT = ilEndCorT
                                            tlSplitInfo.iFirstProjInx = ilFirstProjInx
                                            tlSplitInfo.iUseSlsComm = ilUseSlsComm
                                            'tlSplitInfo.iVefCode = tmSBFAdjust(ilVehLoop).iVefCode
                                            tlSplitInfo.iVefCode = tmSBFAdjust(ilAdjust).iVefCode 'WWO B&B by CAL Spots TTP 10760
                                            tlSplitInfo.iDateFlag = ilDateFlag
                                            tlSplitInfo.iNewCode = ilNewCode
                                            'TTP 10753 - Billed and Booked Cal Spots: net and t-net version showing gross dollars for digital lines
                                            tlSplitInfo.sCashAgyComm = slCashAgyComm
                                            tlSplitInfo.sTradeAgyComm = tgChfCT.sAgyCTrade
                                            tlSplitInfo.sPctTrade = slPctTrade
                                            'tlSplitInfo.sTradeAgyComm = tmSBFAdjust(ilAdjust).sAgyComm
                                            'If tmSBFAdjust(ilVehLoop).sAgyComm = "Y" Then
                                            '    tlSplitInfo.sCashAgyComm = slCashAgyComm
                                            'Else
                                            '    tlSplitInfo.sCashAgyComm = "00.00"
                                            'End If
                                            'tlSplitInfo.iNTRSlspComm = tmSBFAdjust(ilVehLoop).iSlsCommPct      '2-2-04 NTR slsp comm if not using sub-companies.
                                            tlSplitInfo.iNTRSlspComm = tmSBFAdjust(ilAdjust).iSlsCommPct      '2-2-04 NTR slsp comm if not using sub-companies; 'WWO B&B by CAL Spots TTP 10760
                                            tlSplitInfo.sNTR = "N"
                                            'tlSplitInfo.iHardCost = tmSBFAdjust(ilVehLoop).iIsItHardCost      'true false if hard cost
                                            tlSplitInfo.iHardCost = tmSBFAdjust(ilAdjust).iIsItHardCost      'true false if hard cost; 'WWO B&B by CAL Spots TTP 10760
                                            'tlSplitInfo.iMnfNTRItemCode = tmSBFAdjust(ilAdjust).iMnfItem       '11-06-06 NTR Item type from MNF
                                            tlSplitInfo.iMnfNTRItemCode = 0
                                            tlSplitInfo.iVefCode = tlPcf.iVefCode
                                                            
                                            'Match the period Amounts from lDIGITALLINEAVERAGE into the reported periods
                                            For illoop = 1 To 12
                                                slTemp = gObtainEndStd(Format(llBillCycleStartDates(illoop), "ddddd"))
                                                gObtainYearMonthDayStr slTemp, True, slYear, slMonth, slDay
                                                For ilLoop2 = 0 To lDIGITALLINEAVERAGE.iLastInx
                                                    If lDIGITALLINEAVERAGE.iMonths(ilLoop2) = Val(slMonth) And lDIGITALLINEAVERAGE.iYears(ilLoop2) = Val(slYear) Then
                                                        llExtAmount = CLng(lDIGITALLINEAVERAGE.dExtAmountGross(ilLoop2) * 100)
                                                        'tlMatrixINfo.sComment(illoop) = lDIGITALLINEAVERAGE.sComment(ilLoop2) 'TTP 10666
                                                        tmSBFAdjust(ilAdjust).lProject(illoop) = llExtAmount
                                                        'TTP 10724 - Billed and Booked report: T-Net Cal Spots - not including digital lines
                                                        'lmAcquisition(illoop) = lmAcquisition(illoop) + llExtAmount
                                                        lmProject(illoop) = lmProject(illoop) + llExtAmount
                                                        Exit For
                                                    End If
                                                Next ilLoop2
                                            Next illoop
                                        End If
                                    Next ilAdjust
                                End If
        
                                '-------------------------------------
                                'Apply Amounts and Write line
                                tmClf.iVefCode = tlPcf.iVefCode
                                'tmGrf.iRemoteID = 1 'Use this to "Ignore" the contract's NTR Flag for this Digital Line - 5/1/23 - JW - Revert hiding NTR per Jason email
                                mBobSetupPctOfSplit tlSplitInfo, llBillCycleStartDates(), tlSlf(), tlScf(), tlSlfIndex(), tmCntAllYear(), tmOneVehAllYear()
                                'tmGrf.iRemoteID = 0 'Reset the "Ignore" contract NTR Flag
                                '-------------------------------------
                                'init the projected gross & net values
                                For illoop = 1 To 12
                                    lmProject(illoop) = 0
                                    lmAcquisition(illoop) = 0
                                Next illoop
                            Next ilPCFLoop
                        End If '--End of Obtain PhfRvf ok
                    End If '--End of Obtain PCF Ok
                End If
                
                '-------------------------------------------------------------------------------------------
                'Insure the common monthly buckets are initialized for the schedule lines
                For illoop = 1 To 12
                    lmProject(illoop) = 0
                    lmAcquisition(illoop) = 0
                Next illoop
                
                If imAirTime Then                   '11-25-02 include air time (vs NTR)?
                    'build the vehicles participant tables for this contract only into tmCntAllYear, if by owner
                    gInitCntPartYear hmVsf, tgChfCT, ilMatchSSCode, llStdStartDates(), tmCntAllYear(), tmPifKey(), tmPifPct()
                    gInitCntPartYear hmVsf, tgChfCT, ilMatchSSCode, llBillCycleStartDates(), tmCntAllYear(), tmPifKey(), tmPifPct()
                    'Gather the spots for the entire contract.  Sort by schedule line for efficiency.
                    ilVefCode = 0           'retrieve spots for all vehicles for single contract
                    llChfCode = tgChfCT.lCode           'single contract
                    ilWhichKey = INDEXKEY5              'use key 5 (chfcode) for search
                    'return array of entire spot records in tlsdf(); llsdfcodes() not used  here
'Debug.Print "getting SDF ByKey, CHFCode:" & llChfCode & "; start:" & slBillCycleStart & " ,End:" & slBillCycleEnd
                    gObtainSDFByKey hmSdf, ilVefCode, slBillCycleStart, slBillCycleEnd, llChfCode, ilWhichKey, llSdfCodes(), tmSdfInfo(), tmSpotTypes 'gObtainSDFByKey: Line#|Date
                    If UBound(tmSdfInfo) - 1 > 1 Then
                        ArraySortTyp fnAV(tmSdfInfo(), 0), UBound(tmSdfInfo), 0, LenB(tmSdfInfo(0)), 0, LenB(tmSdfInfo(0).sKey), 0
                    End If

                    'loop thru the spot array and setup the lowest/highest index for each schedule line
                    'each entry has the line ID and low/high index
                    ReDim tlspotsbylineinx(0 To 0) As SPOTSBYLINEINX
                    llUpper = 0
                    ilfirstTime = True
                    For llSpotInx = LBound(tmSdfInfo) To UBound(tmSdfInfo) - 1
                        If ilfirstTime Then
                            ilfirstTime = False
                            tlspotsbylineinx(llUpper).lLoInx = llSpotInx
                            tlspotsbylineinx(llUpper).lHiInx = llSpotInx
                            tlspotsbylineinx(llUpper).iLine = tmSdfInfo(llSpotInx).tSdf.iLineNo
                            llPrevLine = tmSdfInfo(llSpotInx).tSdf.iLineNo
                        Else
                            'does current spot record line # equal the previous?
                            If tmSdfInfo(llSpotInx).tSdf.iLineNo = llPrevLine Then
                                tlspotsbylineinx(llUpper).lHiInx = llSpotInx
                            Else
                                llUpper = llUpper + 1
                                ReDim Preserve tlspotsbylineinx(0 To llUpper) As SPOTSBYLINEINX
                                tlspotsbylineinx(llUpper).lLoInx = llSpotInx
                                tlspotsbylineinx(llUpper).lHiInx = llSpotInx
                                tlspotsbylineinx(llUpper).iLine = tmSdfInfo(llSpotInx).tSdf.iLineNo
                                llPrevLine = tmSdfInfo(llSpotInx).tSdf.iLineNo
                            End If
                        End If
                    Next llSpotInx

                    For ilClf = LBound(tgClfCT) To UBound(tgClfCT) - 1 Step 1
                        ilDoe = ilDoe + 1
                        If ilDoe > 2000 Then
                            ilDoe = 0
                            DoEvents
                        End If
                        tmClf = tgClfCT(ilClf).ClfRec
                        llLoInx = 0
                        llHiInx = 0
                        'find the line to be process and determine which span of spots to process
                        For llUpper = LBound(tlspotsbylineinx) To UBound(tlspotsbylineinx)
                            If tlspotsbylineinx(llUpper).iLine = tmClf.iLine Then
                                llLoInx = tlspotsbylineinx(llUpper).lLoInx
                                llHiInx = tlspotsbylineinx(llUpper).lHiInx
                                Exit For
                            End If
                        Next llUpper

                        ilFoundOption = True            'assume the vehicle should be included
                        mBobSelectVeh tmClf.iVefCode, ilFoundOption, ilListIndex 'if slsp (with veh subtotals) or vehicle option, see if this vehicle is selected

                        If (ilFoundOption) Then      'And (ilOKtoSeeVeh) Then
                            '1-20-21 use the common dates setup to project when using bill cycle method
                            gAccumSpotsbyFlight llBillCycleStartDates(), ilFirstProjInx, ilHowManyPer + 1, lmProject(), lmAcquisition(), lmAcquisitionNet(), 1, tgClfCT(ilClf), tgCffCT(), tmSdfInfo(), llLoInx, llHiInx, hmSmf, imUseAcquisitionCost
                            'lmProject - gross actual spot cost or gross acquisition costs
                            'lmAcquisition - gross acquisition costs
                            'lmAcquisitionNet - net acquisition costs if varying acq commissions; otherwise 0
                            gSetAcqFieldsForOutput imAdjustAcquisition, imUseAcquisitionCost, smGrossOrNet, lmProject(), lmAcquisition(), lmAcquisitionNet()
                            
                            'Adjust with misses and makegoods?
                            If ilAdjust Then
                                '1-20-21 use the common dates setup to project when using bill cycle method
                                mBOBAdjust llBillCycleStartDates(), ilFirstProjInx, llBillCycleStart, llBillCycleEnd, True, ilSubMissed, ilCountMGs, ilHowManyPer, ilAdjustMissedForMG
                            End If
                        End If
                        
                        '4-20-00 If (imOwner) Or (imVehicle) Or (ilClf = UBound(tgClfCt) - 1) Or (imSlsp And imVehSub) Then   'option by owner and vehicle must write out for each schline
                        If (imOwner) Or (imVehicle) Or (ilClf = UBound(tgClfCT) - 1) Or (imSlsp) Then      'option by owner and vehicle must write out for each schline
                                                   'all others write out for contract if last line has been processed
                            ilFoundOption = True                    'assume everything included
                            If imVehicle And Not RptSelCt!ckcAll.Value = vbChecked Then   'vehicle option and selected vehicles
                                ilFoundOption = False
                                'If gFilterLists(tmClf.iVefCode, imIncludeCodes, imUseCodes()) Then
                                If gFilterLists(tmClf.iVefCode, imInclVefCodes, imUsevefcodes()) Then
                                    ilFoundOption = True
                                End If
                            End If

                            If ilFoundOption Then             'matching vehicle or owner found
                                tlSplitInfo.iMatchSSCode = ilMatchSSCode
                                tlSplitInfo.iStartCorT = ilStartCorT
                                tlSplitInfo.iEndCorT = ilEndCorT
                                tlSplitInfo.iFirstProjInx = ilFirstProjInx
                                tlSplitInfo.iUseSlsComm = ilUseSlsComm
                                tlSplitInfo.iVefCode = tmClf.iVefCode
                                tlSplitInfo.iDateFlag = ilDateFlag
                                tlSplitInfo.iNewCode = ilNewCode
                                tlSplitInfo.sPctTrade = slPctTrade
                                tlSplitInfo.sCashAgyComm = slCashAgyComm
                                tlSplitInfo.sTradeAgyComm = tgChfCT.sAgyCTrade        '12-23-02
                                tlSplitInfo.iNTRSlspComm = 0            '2-2-04
                                tlSplitInfo.sNTR = "N"
                                tlSplitInfo.iHardCost = False
                                tlSplitInfo.iMnfNTRItemCode = 0         '11-06-06 not an NTR
'                                mBobSetupPctOfSplit tlSplitInfo, llStdStartDates(), tlSlf(), tlScf(), tlSlfIndex, tmCntAllYear(), tmOneVehAllYear()
                                '1-20-21 use the common dates setup to project when using bill cycle method
                                mBobSetupPctOfSplit tlSplitInfo, llBillCycleStartDates(), tlSlf(), tlScf(), tlSlfIndex, tmCntAllYear(), tmOneVehAllYear()
                             End If                         'ilfoundoption

                            'process the makegoods for this line - there can be multiple vehicles that spots were moved  to.  Each
                            'new vehicle must be retrieved and it's splits determined
                            For ilVehLoop = 0 To imUpperAdjust - 1 Step 1
                                ilDoe = ilDoe + 1
                                If ilDoe > 500 Then
                                    ilDoe = 0
                                    DoEvents
                                End If
                                ilFoundOption = True                    'assume everything included
                                If imVehicle And Not RptSelCt!ckcAll.Value = vbChecked Then   'vehicle option and selected vehicles
                                    ilFoundOption = False                    'assume everything included
                                    'If gFilterLists(tmAdjust(ilVehLoop).iVefCode, imIncludeCodes, imUseCodes()) Then
                                    If gFilterLists(tmAdjust(ilVehLoop).iVefCode, imInclVefCodes, imUsevefcodes()) Then
                                        ilFoundOption = True
                                    End If
                                End If

                                If tmAdjust(ilVehLoop).iVefCode > 0 And ilFoundOption Then
                                    ilHowMany = 0
                                    ilHowManyDefined = 0
                                    '1-20-21 use the common dates setup to project when using bill cycle method
                                    mBobGetHowManyFuture tmAdjust(ilVehLoop).iVefCode, ilHowMany, ilHowManyDefined, ilMatchSSCode, imSlfCode(), lmSlfSplit(), llBillCycleStartDates()         '8-4-00 determine the number of owner or slsp splits
                                    For illoop = 0 To ilHowMany - 1 Step 1
                                        If imSlsp Then
                                            For ilSlfRecd = LBound(tlSlf) To UBound(tlSlf) - 1
                                               If imSlfCode(illoop) = tlSlf(ilSlfRecd).iCode Then
                                                   tmSlf = tlSlf(ilSlfRecd)
                                                   '7-23-07 when slsp sort, need to make sure the correct sales source is being used;
                                                    'some split slsp are coming from different sales sources
                                                    'A Slsp recd has been read in even tho its not a slsp option.  If not by slsp, using the
                                                    'sales source from the first salesperson
                                                    For ilTemp = LBound(tlSofList) To UBound(tlSofList)
                                                        If tlSofList(ilTemp).iSofCode = tmSlf.iSofCode Then
                                                            ilMatchSSCode = tlSofList(ilTemp).iMnfSSCode          'Sales source
                                                            Exit For
                                                        End If
                                                    Next ilTemp
                                                   Exit For
                                               End If
                                           Next ilSlfRecd
                                           '7-10-00
                                           ilFoundOne = True
                                        
                                            '8-6-10 If swapping from vehicle w/slsp split subtotals to slsp split w/vehicle subtotals, take all slsp
                                           If (Not RptSelCt!ckcAll.Value = vbChecked) And (igSwapBOBOption = False) Then
                                                ilFoundOne = False
                                                For ilLoopSlsp = 0 To RptSelCt!lbcSelection(2).ListCount - 1 Step 1
                                                    If RptSelCt!lbcSelection(2).Selected(ilLoopSlsp) Then              'selected slsp
                                                        slNameCode = tgSalesperson(ilLoopSlsp).sKey    'Traffic!lbcSalesperson.List(ilLoopSlsp)         'pick up slsp code
                                                        ilRet = gParseItem(slNameCode, 2, "\", slCode)
                                                        If Val(slCode) = imSlfCode(illoop) Then  '7-10-00
                                                            ilFoundOne = True
                                                            Exit For
                                                        End If
                                                    End If
                                                Next ilLoopSlsp
                                           End If
                                           If ilFoundOne Then
                                               '4-20-00 llProcessPct = tgChfCt.lComm(ilLoop)          'slsp split % or 100%
                                               llProcessPct = lmSlfSplit(illoop)                '4-20-00
                                               lmSlfDiffComm = lmSlfSplitRev(illoop)       '1-31-04
                                           Else
                                               llProcessPct = 0
                                           End If
                                        ElseIf imOwner Or imTrikIfOwner Then            '8-4-00
                                            If tmOneVehAllYear(illoop).AllYear.iSSMnfCode = ilMatchSSCode Then
                                                llProcessPct = -1
                                                tmGrf.iCode2 = tmOneVehAllYear(illoop).AllYear.iMnfGroup 'participant
                                            Else
                                                llProcessPct = 0
                                            End If
                                        ElseIf (imVehicle And smGrossOrNet = "B") Then      '4-5-01  need the participant share for net-net option
                                            If tmOneVehAllYear(illoop).AllYear.iSSMnfCode = ilMatchSSCode Then
                                                llProcessPct = 1000000
                                            Else
                                                llProcessPct = 0
                                                'tmGrf.iPerGenl(7) = 0
                                            End If
                                        Else
                                            llProcessPct = 1000000              'if advt or vehicle, just use slsp since there will always be one
                                                                                'and only one pass will be processed
                                        End If

                                        If llProcessPct <> 0 Then               '-1 indicates owner where the % must be retrieved by date
                                            ilFoundOne = mFoundSelection(illoop, tmAdjust(ilVehLoop).iVefCode, imSlfCode(), lmSlfSplit())         '8-4-00 see if selective slsp, owner, vehicle chosen
                                            If ilFoundOne Then
                                                For ilCorT = ilStartCorT To ilEndCorT Step 1
                                                    For ilTemp = 1 To 12
                                                        llTempProject(ilTemp) = tmAdjust(ilVehLoop).lProject(ilTemp)
                                                        llTempAcquisition(ilTemp) = tmAdjust(ilVehLoop).lAcquisitionCost(ilTemp)
                                                    Next ilTemp
                                                    tmGrf.iVefCode = tmAdjust(ilVehLoop).iVefCode
                                                    If imOwner Or (imVehicle And imTrikIfOwner) Then
                                                        tmOnePartAllYear = tmOneVehAllYear(illoop).AllYear
                                                    Else
                                                        tmOnePartAllYear = tmOneVehAllYear(0).AllYear
                                                    End If
                                                    mBOBLoopOnMonth llTempProject(), llTempAcquisition(), ilCorT, llProcessPct, slPctTrade, slCashAgyComm, slCommPct, smGrossOrNet, ilHowManyDefined, ilMatchSSCode, ilDateFlag, ilNewCode, 1, igPeriods, tmOnePartAllYear, tgChfCT.sAgyCTrade
                                                Next ilCorT
                                            End If              'ilfoundOne
                                        End If                  'llprocesspct >0
                                        If imVehicle And smGrossOrNet = "B" Then        '4-5-01 net-net option only by vehicle
                                            illoop = ilHowMany
                                        End If
                                    Next illoop                 '0 to ilhowmany-1 step 1
                                End If
                            Next ilVehLoop                  '0 To imUpperAdjust - 1
                            
                            '4-20-00 If (imVehicle) Or (imOwner) Or (imSlsp And imVehSub) Then     'vehicle or owners need to init the projection buckets after each sch line
                            If (imVehicle) Or (imOwner) Or (imVehicle And imTrikIfOwner) Or (imSlsp) Then         '8-4-00 vehicle or owners need to init the projection buckets after each sch line
                                For ilScratch = 1 To 13 Step 1    'init projection buckets for next line or contract
                                    lmProject(ilScratch) = 0
                                    lmAcquisition(ilScratch) = 0
                                    llProject(ilScratch) = 0
                                    llAcquisition(ilScratch) = 0
                                    lmAcquisitionNet(ilScratch) = 0
                                Next ilScratch
                                 ReDim tmAdjust(0 To 0) As ADJUSTLIST             'prepare list of mgs
                                imUpperAdjust = 0
                            End If
                        End If                          'if (owner), slsp,  or (vehicle) or end of contract
                        
                        '5-12-09 always init the temp projection buckets for next line
                        For ilScratch = 1 To 13
                            llProject(ilScratch) = 0
                            llAcquisition(ilScratch) = 0
                            lmAcquisitionNet(ilScratch) = 0
                        Next ilScratch
                    Next ilClf                          'next schedule line - for advt & slsp the entire contr is accumulated before writing to GRF
                End If '--End of Air Time             'include Air Time vs NTR
            End If                                  'exclude all promotions, merchandising - only include trade if requested
        End If                                      'ilfound
        
        If (imAdvt) Or (imAgency) Or (imBusCat) Or (imProdProt) Or (imSlsp) Then                'these options have processed by contract, not lines.  Contract complete, init $
            For ilScratch = 1 To 13 Step 1          'init projection buckets for next or contract
                lmProject(ilScratch) = 0
                lmAcquisition(ilScratch) = 0
            Next ilScratch
        End If
        
    Next ilCurrentRecd
    
    Erase tlSofList, tmMnfList, tlScf, tlSlf, tlSlfIndex, tlSbf
    Erase llTempProject, llTempAcquisition, tlMnf, tmAdjust, tmSBFAdjust
    Erase lmSlfSplit, imSlfCode, imslfcomm, imslfremnant
    Erase imUsevefcodes, imUseAdfCodes, imUseAgfCodes, imUseCatCodes, imUseProdCodes
    Erase llSdfCodes, tmSdfInfo
    Erase tlRvf, tmPcf
    ilRet = btrClose(hmScf)
    btrDestroy hmScf
End Function

Function mObtainSmfCodes(slTypeFlag As String, slMissedStartDate As String, slMissedEndDate As String, slAirStartDate As String, slAirEndDate As String, slVehicleFlag As String, llContrCode As Long, ilVefCode() As Integer, llSmfCode() As Long) As Integer
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  llTemp                        slNameCode                    slCode                    *
    '*  llMDate                                                                               *
    '******************************************************************************************
    'slTypeFlag(I)- M=MG only; O=Outside only; B=Both
    'slMissedStartDate(I)-  Missed start date or blank, test missed date (smfMissedDate) in extended call
    'slMissedEndDate(I)- Missed End date or blank, test missed date  (smfMissedDate) in extended call
    'slAirStartDate(I)-  Aired start date or blank, test schedule date (sdfDate)
    'slAirEndDate(I)_ Aired End date or blank, test schedule date (sdfDate)
    'slVehicleFlag(I)- M-Check Missed Vehicle; A=Check airing vehicle; B=Both; E=Either; Blank means all vehicles selected and test is not required
    'llContrCode (I) - selective contr code or 0 if all
    'ilVefCode()(I)- Array of vehicle codes; Used for all cases of slVehicleFlag except blank
    '                slVehicleFlag: M- Check if smfOrigSchVef match one within array
    '                               A- check if sdfVefCode match one within array
    '                               B- check if smfOrigSchVef and sdfVefCode match one within array
    '                               E- check if smfOrigSchVef or sdfVefCode match one within array
    'llSmfCode(O)-  Array of smfCodes that meet the selection criteria
    Dim ilExtLen As Integer
    Dim llNoRec As Long
    Dim ilRet As Integer
    Dim ilOffSet As Integer
    Dim ilOk As Integer
    Dim ilVOk As Integer
    Dim ilMOk As Integer
    Dim ilSOk As Integer
    Dim llRecPos As Long
    Dim tlDateTypeBuff As POPDATETYPE   'Type field record

    Dim llADate As Long
    Dim ilVehicle As Integer
    Dim llAirStartDate As Long
    Dim llAirEndDate As Long

    llAirStartDate = gDateValue(slAirStartDate)
    llAirEndDate = gDateValue(slAirEndDate)

    ReDim llSmfCode(0 To 0) As Long
    hmSmf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSmf, "", sgDBPath & "Smf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSmf)
        btrDestroy hmSmf
        mObtainSmfCodes = False
        Exit Function
    End If
    imSmfRecLen = Len(tmSmf)
    hmSdf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSdf, "", sgDBPath & "Sdf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSmf)
        btrDestroy hmSmf
        ilRet = btrClose(hmSdf)
        btrDestroy hmSdf
        mObtainSmfCodes = False
        Exit Function
    End If
    imSdfRecLen = Len(tmSdf)
    btrExtClear hmSmf   'Clear any previous extend operation
    ilExtLen = Len(tmSmf)
    llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlSdf) 'Obtain number of records
    btrExtClear hmSmf   'Clear any previous extend operation
    gPackDate slMissedStartDate, tmSmfSrchKey4.iMissedDate(0), tmSmfSrchKey4.iMissedDate(1)
    tmSmfSrchKey4.lChfCode = 0
    ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    If ilRet <> BTRV_ERR_END_OF_FILE Then
        If ilRet <> BTRV_ERR_NONE Then
            Exit Function
        End If
        Call btrExtSetBounds(hmSmf, llNoRec, -1, "UC", "SMF", "") 'Set extract limits (all records)
        If slMissedStartDate <> "" Then
            gPackDate slMissedStartDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
            ilOffSet = gFieldOffset("Smf", "SmfMissedDate")
            If slMissedEndDate <> "" Then
                ilRet = btrExtAddLogicConst(hmSmf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_GTE, BTRV_EXT_AND, tlDateTypeBuff, 4)
            Else
                ilRet = btrExtAddLogicConst(hmSmf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_GTE, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)
            End If
        End If
        If slMissedEndDate <> "" Then
            gPackDate slMissedEndDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
            ilOffSet = gFieldOffset("Smf", "SmfMissedDate")
            ilRet = btrExtAddLogicConst(hmSmf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_LTE, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)
        End If
        ilRet = btrExtAddField(hmSmf, 0, ilExtLen)  'Extract Name
        If ilRet <> BTRV_ERR_NONE Then
            Exit Function
        End If
        ilRet = btrExtGetNext(hmSmf, tmSmf, ilExtLen, llRecPos)
        If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
            If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                Exit Function
            End If
            Do While ilRet = BTRV_ERR_REJECT_COUNT
                ilRet = btrExtGetNext(hmSmf, tmSmf, ilExtLen, llRecPos)
            Loop
            Do While ilRet = BTRV_ERR_NONE
                'Get Sdf
                tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
                If ilRet = BTRV_ERR_NONE Then
                    'ilOk = True
                    'Rick-  Check Air Dates
                    'Rick-  Check Vehicle

                    ilSOk = False ' Check the SpotField
                    If tmSdf.sSpotType <> "X" And tmSdf.sPriceType <> "N" Then
                        ilSOk = True
                    End If

                    ilMOk = False ' Check the TypeFlag
                    If slTypeFlag = "B" Then
                        If tmSdf.sSchStatus = "G" Or tmSdf.sSchStatus = "O" Then
                            ilMOk = True
                        End If
                    ElseIf slTypeFlag = tmSdf.sSchStatus Then
                        ilMOk = True
                    End If

                    If slVehicleFlag <> "" Then ' Check the VehicleFlag

                        ilOk = False  ' Check the AirDate
                        gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llADate
                        If llADate >= llAirStartDate And llADate <= llAirEndDate Then
                             ilOk = True
                        End If

                        If slVehicleFlag = "M" Then
                            ilVOk = False
                            For ilVehicle = LBound(ilVefCode) To UBound(ilVefCode) - 1
                                If ilVefCode(ilVehicle) = tmSmf.iOrigSchVef Then
                                    ilVOk = True
                                    Exit For
                                End If
                            Next ilVehicle
                        End If
                        If slVehicleFlag = "A" Then
                            ilVOk = False
                            For ilVehicle = LBound(ilVefCode) To UBound(ilVefCode) - 1
                                If ilVefCode(ilVehicle) = tmSdf.iVefCode Then
                                    ilVOk = True
                                    Exit For
                                End If
                            Next ilVehicle
                        End If

                        If slVehicleFlag = "B" Then
                            ilVOk = False
                            For ilVehicle = LBound(ilVefCode) To UBound(ilVefCode) - 1
                                If ilVefCode(ilVehicle) = tmSdf.iVefCode Then
                                    ilVOk = True
                                    Exit For
                                End If
                            Next ilVehicle
                            If ilVOk Then
                                ilVOk = False
                                For ilVehicle = LBound(ilVefCode) To UBound(ilVefCode) - 1
                                    If ilVefCode(ilVehicle) = tmSmf.iOrigSchVef Then
                                        ilVOk = True
                                        Exit For
                                    End If
                                Next ilVehicle
                            End If
                        End If
                        If slVehicleFlag = "E" Then
                            ilVOk = False
                            For ilVehicle = LBound(ilVefCode) To UBound(ilVefCode) - 1
                                If ilVefCode(ilVehicle) = tmSdf.iVefCode Then
                                    ilVOk = True
                                    Exit For
                                End If
                            Next ilVehicle

                            For ilVehicle = LBound(ilVefCode) To UBound(ilVefCode) - 1
                                If ilVefCode(ilVehicle) = tmSmf.iOrigSchVef Then
                                    ilVOk = True
                                    Exit For
                                End If
                            Next ilVehicle

                        End If

                    Else

                        ilOk = False  ' Check the AirDate
                        gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llADate
                        If llADate >= llAirStartDate And llADate <= llAirEndDate Then
                             ilOk = True
                        End If

                        ilVOk = True

                    End If
                End If
                If ((llContrCode = 0) Or (llContrCode = tmSmf.lChfCode)) Then       'test for all contracts or selective
                    If ilVOk And ilMOk And ilOk And ilSOk Then
                        llSmfCode(UBound(llSmfCode)) = tmSmf.lCode
                        ReDim Preserve llSmfCode(0 To UBound(llSmfCode) + 1) As Long
                    End If
                End If
                ilRet = btrExtGetNext(hmSmf, tmSmf, ilExtLen, llRecPos)
                Do While ilRet = BTRV_ERR_REJECT_COUNT
                    ilRet = btrExtGetNext(hmSmf, tmSmf, ilExtLen, llRecPos)
                Loop
            Loop
        End If
    End If
    ilRet = btrClose(hmSmf)
    btrDestroy hmSmf
    ilRet = btrClose(hmSdf)
    btrDestroy hmSdf
    mObtainSmfCodes = True
End Function

Function mObtainSdfSmfCodes(slTypeFlag As String, slAirStartDate As String, slAirEndDate As String, slVehicleFlag As String, llContrCode As Long, ilVefCode() As Integer, llSmfCode() As Long) As Integer
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Variables (Removed)                                                              *
    '*  llTemp                        slNameCode                    slCode                    *
    '*  llMDate                       llADate                                                 *
    '******************************************************************************************
    'slTypeFlag(I)- M=MG only; O=Outside only; B=Both
    'slAirStartDate(I)-  Aired start date or blank, test schedule date (sdfDate)
    'slAirEndDate(I)_ Aired End date or blank, test schedule date (sdfDate)
    'slVehicleFlag(I)- M-Check Missed Vehicle; A=Check airing vehicle; B=Both; E=Either; Blank means all vehicles selected and test is not required
    'llContrCode (I) - selective contr code or 0 if all
    'ilVefCode()(I)- Array of vehicle codes; Used for all cases of slVehicleFlag except blank
    '                slVehicleFlag: M- Check if smfOrigSchVef match one within array
    '                               A- check if sdfVefCode match one within array
    '                               B- check if smfOrigSchVef and sdfVefCode match one within array
    '                               E- check if smfOrigSchVef or sdfVefCode match one within array
    'llSmfCode(O)-  Array of smfCodes that meet the selection criteria
    Dim ilExtLen As Integer
    Dim llNoRec As Long
    Dim ilRet As Integer
    Dim ilOffSet As Integer
    Dim ilVOk As Integer
    Dim ilMOk As Integer
    Dim llRecPos As Long
    Dim tlDateTypeBuff As POPDATETYPE   'Type field record
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record

    Dim ilVehicle As Integer
    Dim llAirStartDate As Long
    Dim llAirEndDate As Long

    llAirStartDate = gDateValue(slAirStartDate)
    llAirEndDate = gDateValue(slAirEndDate)

    ReDim llSmfCode(0 To 0) As Long
    hmSmf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSmf, "", sgDBPath & "Smf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSmf)
        btrDestroy hmSmf
        mObtainSdfSmfCodes = False
        Exit Function
    End If
    imSmfRecLen = Len(tmSmf)
    hmSdf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSdf, "", sgDBPath & "Sdf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilRet = btrClose(hmSmf)
        btrDestroy hmSmf
        ilRet = btrClose(hmSdf)
        btrDestroy hmSdf
        mObtainSdfSmfCodes = False
        Exit Function
    End If
    imSdfRecLen = Len(tmSdf)

    btrExtClear hmSdf   'Clear any previous extend operation
    ilExtLen = Len(tmSdf)
    llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlSdf) 'Obtain number of records
    btrExtClear hmSdf   'Clear any previous extend operation
    gPackDate slAirStartDate, tmSdfSrchKey4.iDate(0), tmSdfSrchKey4.iDate(1)
    tmSdfSrchKey4.lChfCode = 0
    ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    If ilRet <> BTRV_ERR_END_OF_FILE Then
        If ilRet <> BTRV_ERR_NONE Then
            Exit Function
        End If
        Call btrExtSetBounds(hmSdf, llNoRec, -1, "UC", "SDF", "") 'Set extract limits (all records)
        If slAirStartDate <> "" Then
            gPackDate slAirStartDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
            ilOffSet = gFieldOffset("Sdf", "SdfDate")
            ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_GTE, BTRV_EXT_AND, tlDateTypeBuff, 4)
        End If
        If slAirEndDate <> "" Then
            gPackDate slAirEndDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
            ilOffSet = gFieldOffset("Sdf", "SdfDate")
            ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_LTE, BTRV_EXT_AND, tlDateTypeBuff, 4)
        End If
        tlCharTypeBuff.sType = "X"    'Extract all matching records
        ilOffSet = gFieldOffset("Sdf", "SdfSpotType")
        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)

        tlCharTypeBuff.sType = "N"    'Extract all matching records
        ilOffSet = gFieldOffset("Sdf", "SdfPriceType")
        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)

        tlCharTypeBuff.sType = "G"    'Extract all matching records
        ilOffSet = gFieldOffset("Sdf", "SdfSchStatus")
        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_OR, tlCharTypeBuff, 1)

        tlCharTypeBuff.sType = "O"    'Extract all matching records
        ilOffSet = gFieldOffset("Sdf", "SdfSchStatus")
        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_LAST_TERM, tlCharTypeBuff, 1)


        ilRet = btrExtAddField(hmSdf, 0, ilExtLen)  'Extract Name
        If ilRet <> BTRV_ERR_NONE Then
            Exit Function
        End If
        ilRet = btrExtGetNext(hmSdf, tmSdf, ilExtLen, llRecPos)
        If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
            If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                Exit Function
            End If
            Do While ilRet = BTRV_ERR_REJECT_COUNT
                ilRet = btrExtGetNext(hmSdf, tmSdf, ilExtLen, llRecPos)
            Loop
            Do While ilRet = BTRV_ERR_NONE
                'Get Sdf
                ilMOk = False ' Check the TypeFlag
                If slTypeFlag = "B" Then
                    If tmSdf.sSchStatus = "G" Or tmSdf.sSchStatus = "O" Then
                        ilMOk = True
                    End If
                ElseIf slTypeFlag = tmSdf.sSchStatus Then
                    ilMOk = True
                End If

                If slVehicleFlag <> "" Then ' Check the VehicleFlag

                    If slVehicleFlag <> "A" Then
                        tmSmfSrchKey1.lCode = tmSdf.lSmfCode
                        ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
                    Else
                        ilRet = BTRV_ERR_NONE
                    End If
                    If ilRet = BTRV_ERR_NONE Then

                        If slVehicleFlag = "M" Then
                            ilVOk = False
                            For ilVehicle = LBound(ilVefCode) To UBound(ilVefCode) - 1
                                If ilVefCode(ilVehicle) = tmSmf.iOrigSchVef Then
                                    ilVOk = True
                                    Exit For
                                End If
                            Next ilVehicle
                        End If
                        If slVehicleFlag = "A" Then
                            ilVOk = False
                            For ilVehicle = LBound(ilVefCode) To UBound(ilVefCode) - 1
                                If ilVefCode(ilVehicle) = tmSdf.iVefCode Then
                                    ilVOk = True
                                    Exit For
                                End If
                            Next ilVehicle
                        End If

                        If slVehicleFlag = "B" Then
                            ilVOk = False
                            For ilVehicle = LBound(ilVefCode) To UBound(ilVefCode) - 1
                                If ilVefCode(ilVehicle) = tmSdf.iVefCode Then
                                    ilVOk = True
                                    Exit For
                                End If
                            Next ilVehicle
                            If ilVOk Then
                                ilVOk = False
                                For ilVehicle = LBound(ilVefCode) To UBound(ilVefCode) - 1
                                    If ilVefCode(ilVehicle) = tmSmf.iOrigSchVef Then
                                        ilVOk = True
                                        Exit For
                                    End If
                                Next ilVehicle
                            End If
                        End If
                        If slVehicleFlag = "E" Then
                            ilVOk = False
                            For ilVehicle = LBound(ilVefCode) To UBound(ilVefCode) - 1
                                If ilVefCode(ilVehicle) = tmSdf.iVefCode Then
                                    ilVOk = True
                                    Exit For
                                End If
                            Next ilVehicle

                            For ilVehicle = LBound(ilVefCode) To UBound(ilVefCode) - 1
                                If ilVefCode(ilVehicle) = tmSmf.iOrigSchVef Then
                                    ilVOk = True
                                    Exit For
                                End If
                            Next ilVehicle

                        End If
                    End If

                Else
                    ilVOk = True
                End If
                If ((llContrCode = 0) Or (llContrCode = tmSmf.lChfCode)) Then       'test for all contracts or selective
                    If ilVOk And ilMOk Then
                        llSmfCode(UBound(llSmfCode)) = tmSdf.lSmfCode
                        ReDim Preserve llSmfCode(0 To UBound(llSmfCode) + 1) As Long
                    End If
                End If

                ilRet = btrExtGetNext(hmSdf, tmSdf, ilExtLen, llRecPos)
                Do While ilRet = BTRV_ERR_REJECT_COUNT
                    ilRet = btrExtGetNext(hmSdf, tmSdf, ilExtLen, llRecPos)
                Loop
            Loop
        End If
    End If
    ilRet = btrClose(hmSmf)
    btrDestroy hmSmf
    ilRet = btrClose(hmSdf)
    btrDestroy hmSdf
    mObtainSdfSmfCodes = True
End Function

Sub gCreateMGRpt()
    Dim slMissedStartDate As String
    Dim slAirStartDate As String
    Dim slMissedEndDate As String
    Dim slAirEndDate As String
    Dim slTypeFlag As String
    Dim slVehicleFlag As String
    Dim llTemp As Long
    Dim slNameCode As String
    Dim slCode As String
    Dim ilRet As Integer
    Dim ilError As Integer
    Dim slStartDate As String
    Dim ilCallType As Integer   '0=mObatinSmfCode; 1=mObtainSdfSmfCode (requires missed date not defined)
    Dim llContrCode As Long
    ReDim llSmfCode(0 To 0) As Long
    Dim slContrNumber As String

    slContrNumber = RptSelCt!edcText.Text
    llContrCode = 0
    If Trim$(slContrNumber <> "") Then
        hmCHF = CBtrvTable(ONEHANDLE) 'CBtrvObj()
        ilRet = btrOpen(hmCHF, "", sgDBPath & "Chf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        If ilRet <> BTRV_ERR_NONE Then
            ilRet = btrClose(hmCHF)
            btrDestroy hmCHF
        Else
            imCHFRecLen = Len(tmChf)
            'obtain the contract number to retrieve selective contract
            tmChfSrchKey1.lCntrNo = Val(slContrNumber)
            tmChfSrchKey1.iCntRevNo = 32000
            tmChfSrchKey1.iPropVer = 32000
            ilRet = btrGetGreaterOrEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)
            If ilRet = BTRV_ERR_NONE Then
                llContrCode = tmChf.lCode
            End If
            ilRet = btrClose(hmCHF)
            btrDestroy hmCHF
        End If
    End If

    If RptSelCt!ckcSelC3(0).Value = vbChecked And RptSelCt!ckcSelC3(1).Value = vbChecked Then
        slTypeFlag = "B"
    ElseIf RptSelCt!ckcSelC3(0).Value <> vbChecked And RptSelCt!ckcSelC3(1).Value = vbChecked Then
        slTypeFlag = "O"
    Else
        slTypeFlag = "G"
    End If

    If RptSelCt!ckcAll.Value = vbChecked Then    'check for all vehicles
            slVehicleFlag = ""
    Else
        If RptSelCt!rbcSelCSelect(0).Value Then
            slVehicleFlag = "M"
        ElseIf RptSelCt!rbcSelCSelect(1).Value Then
            slVehicleFlag = "A"
        ElseIf RptSelCt!rbcSelCSelect(2).Value Then
            slVehicleFlag = "E"
        Else
            slVehicleFlag = "B"
        End If
    End If

    ReDim ilVefCode(0 To 0) As Integer
    If Not RptSelCt!ckcAll.Value = vbChecked Then
        For llTemp = 0 To RptSelCt!lbcSelection(6).ListCount - 1 Step 1
            If RptSelCt!lbcSelection(6).Selected(llTemp) Then              'selected slsp
                slNameCode = tgCSVNameCode(llTemp).sKey    'RptSelCt!lbcCSVNameCode.List(llTemp)         'pick up slsp code
                ilRet = gParseItem(slNameCode, 2, "\", slCode)
                ilVefCode(UBound(ilVefCode)) = Val(slCode)
                ReDim Preserve ilVefCode(0 To UBound(ilVefCode) + 1)
            End If
        Next llTemp
    End If

    ilCallType = 1
    slStartDate = RptSelCt!CSI_CalFrom.Text     'Date: 1/7/2020 added CSI controls for date entries --> edcSelCFrom.Text   'Start date
    If slStartDate = "" Then
        slStartDate = "1/5/1970" 'Monday
    Else
        ilCallType = 0
    End If
    slMissedStartDate = slStartDate
    slStartDate = RptSelCt!CSI_CalTo.Text       'Date: 1/7/2020 added CSI controls for date entries --> edcSelCFrom1.Text   'End date
    If (StrComp(slStartDate, "TFN", 1) = 0) Or (Len(slStartDate) = 0) Then
        slMissedEndDate = "12/29/2069"  'Sunday
    Else
        slMissedEndDate = slStartDate
        ilCallType = 0
    End If
    slStartDate = RptSelCt!CSI_From1.Text       'Date: 1/7/2020 added CSI controls for date entries --> edcSelCTo.Text   'Start date
    If slStartDate = "" Then
        slStartDate = "1/5/1970" 'Monday
        ilCallType = 0
    End If
    slAirStartDate = slStartDate
    slStartDate = RptSelCt!CSI_To1.Text         'Date: 1/7/2020 added CSI controls for date entries --> edcSelCTo1.Text   'End date
    If (StrComp(slStartDate, "TFN", 1) = 0) Or (Len(slStartDate) = 0) Then
        slAirEndDate = "12/29/2069"    'Sunday
        ilCallType = 0
    Else
        slAirEndDate = slStartDate
    End If

    If ilCallType = 0 Then
        ilRet = mObtainSmfCodes(slTypeFlag, slMissedStartDate, slMissedEndDate, slAirStartDate, slAirEndDate, slVehicleFlag, llContrCode, ilVefCode(), llSmfCode())
    Else
        ilRet = mObtainSdfSmfCodes(slTypeFlag, slAirStartDate, slAirEndDate, slVehicleFlag, llContrCode, ilVefCode(), llSmfCode())
    End If
    If ilRet = 0 Then
        Exit Sub
    End If

    hmGrf = CBtrvTable(TEMPHANDLE)  '(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmGrf, "", sgDBPath & "Grf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        ilError = ilRet
    End If
    imGrfRecLen = Len(tmGrf)

    For llTemp = LBound(llSmfCode) To UBound(llSmfCode) - 1
        tmGrf.iGenDate(0) = igNowDate(0)        'todays date used for removal of records
        tmGrf.iGenDate(1) = igNowDate(1)
        gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime
        tmGrf.lGenTime = lgNowTime
        tmGrf.lLong = llSmfCode(llTemp)
        ilRet = btrInsert(hmGrf, tmGrf, imGrfRecLen, INDEXKEY0)
    Next llTemp
End Sub

'       Process Adjustments from RVF/PHF for Spot Business Booked report
'          <input>  ilSelectedVefCodes() - array of vehicles to process
'                   slSTartDate - earliest date to gather
'                   slEndDate - latest date to gather
'                   ilFilter - kind of selectivty 0= none, 1 = advt, 2 = contract, 3= slsp, 4 = agency
'                   slGrossNet - User selection, G = gross, N = Net
'                   ilNumberPeriods = User selection, # periods to gather & print
Public Sub mGetAdjProjData(ilSelectedVefCodes() As Integer, slStartDate As String, slEndDate As String, ilfilter As Integer, slGrossNet As String, ilNumberPeriods As Integer)
    '******************************************************************************************
    '* Note: VBC id'd the following unreferenced items and handled them as described:         *
    '*                                                                                        *
    '* Local Labels (Marked)                                                                  *
    '*  mGetAdjProjDataErr                                                                    *
    '******************************************************************************************
    Dim ilRet As Integer
    Dim ilOKVef As Integer
    Dim ilVehicle As Integer
    ReDim tlRvf(0 To 0) As RVF
    Dim llRvf As Long
    Dim ilOk As Integer
    Dim slSpotOrNTR As String * 1
    Dim ilIndex As Integer
    Dim llDate As Long
    Dim illoop As Integer
    Dim llAmt As Long
    Dim ilNetPct As Integer
    Dim llTemp As Long
    Dim slNTRComm As String * 1

    ilRet = gObtainPhfRvf(RptSelCt, slStartDate, slEndDate, tmTranTypes, tlRvf(), 0)
    For llRvf = LBound(tlRvf) To UBound(tlRvf) - 1
        tmRvf = tlRvf(llRvf)
        ilOKVef = False
        If tmRvf.iAirVefCode > 0 Then
            For ilVehicle = LBound(ilSelectedVefCodes) To UBound(ilSelectedVefCodes) - 1
                If ilSelectedVefCodes(ilVehicle) = tmRvf.iAirVefCode Then
                    ilOKVef = True
                    Exit For
                End If
            Next ilVehicle
        Else                    'include the adjustment when no vehicle exists
            ilOKVef = True
        End If

        If ilOKVef Then             'vehicle has been selected
            ilOk = True
            If tmRvf.lCntrNo <> tmChf.lCntrNo Then
                'get contract from history or rec file
                tmChfSrchKey1.lCntrNo = tmRvf.lCntrNo
                tmChfSrchKey1.iCntRevNo = 32000
                tmChfSrchKey1.iPropVer = 32000
                ilRet = btrGetGreaterOrEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE) 'get matching contr recd

                Do While (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tmRvf.lCntrNo) And (tmChf.sSchStatus <> "F" And tmChf.sSchStatus <> "M" And tmChf.sSchStatus <> "N")
                     ilRet = btrGetNext(hmCHF, tmChf, imCHFRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop

                gFakeChf tmRvf, tmChf           'create phoney cntr header if it doesnt exist

            ElseIf tmRvf.lCntrNo = 0 Then       'always set up a fake contract header if no contract # exists in receivables
                gFakeChf tmRvf, tmChf
            Else
                ilRet = BTRV_ERR_NONE
            End If
            If ilRet <> BTRV_ERR_NONE Then
                ilOk = False
            Else
                'determine if air time or NTR
                If tmRvf.iMnfItem > 0 Then          'NTR
                    tmSbfSrchKey.lCode = tmRvf.lSbfCode
                    ilRet = btrGetEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)
                    If ilRet <> BTRV_ERR_NONE Then          '7-28-03 insure the previous % isnt used
                        tmSbf.iCommPct = 0
                        tmSbf.sAgyComm = "N"
                    End If

                    slSpotOrNTR = "N"           'NTR
                    slNTRComm = tmSbf.sAgyComm
                Else
                    slSpotOrNTR = "A"
                    slNTRComm = "Y"
                End If

                ilOk = mFilterProjData(tmRvf.iAirVefCode, ilfilter, slSpotOrNTR, ilIndex, slNTRComm)      'test contract types, advt/cntr/slsp selectivity
                If Trim$(tmRvf.sType) <> "" And tmRvf.sType <> "A" Then
                    ilOk = False
                End If
            End If
            If ilOk Then
                gUnpackDateLong tmRvf.iTranDate(0), tmRvf.iTranDate(1), llDate
                'Determine bucket
                For illoop = 1 To 13 Step 1
                    If (llDate >= lmSProjDates(illoop)) And (llDate <= lmEProjDates(illoop)) Then
                        'determine if agy commissionable
                        If tmChf.iAgfCode > 0 Then
                            tmJsr(ilIndex).iAgfCode = tmChf.iAgfCode
                        Else
                            tmJsr(ilIndex).iAgfCode = 0
                        End If
                        gPDNToLong tmRvf.sGross, llAmt
                        'if AN gross is 0, backcompute from net
                        If tmChf.iAgfCode = 0 Then          'direct
                            gPDNToLong tmRvf.sNet, llAmt
                        Else
                            If llAmt = 0 Then
                                If slGrossNet = "N" Then        'if net, need to get a gross amt so it will be processed in the update routine
                                                                'because the update rtn checked to see if gross is non-zero or not to process
                                                                'if gross and zero, leave it that way as its intended not to have a gross
                                    'back compute gross
                                    gPDNToLong tmRvf.sNet, llTemp
                                    tmAgfSrchKey.iCode = tmChf.iAgfCode
                                    ilRet = btrGetEqual(hmAgf, tmAgf, Len(tmAgf), tmAgfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'get matching agy recd
                                    ilNetPct = 8500         'default 85% net
                                    If ilRet = BTRV_ERR_NONE Then
                                        ilNetPct = (10000 - tmAgf.iComm)
                                    End If          'ilret = btrv_err_none
                                    llAmt = CDbl(llTemp) * 10000 / ilNetPct
                                End If
                            End If
                        End If
                        tmJsr(ilIndex).lMCHDollars(illoop - 1) = tmJsr(ilIndex).lMCHDollars(illoop - 1) + llAmt

                        Exit For
                    End If
                Next illoop
            End If
        End If
    Next llRvf
    mWriteJSRProj slGrossNet, ilNumberPeriods
    Exit Sub
mGetAdjProjDataErr: 'VBC NR
    Exit Sub
End Sub

'           mCreateKeyForInsertions - create a record type for each vehicle in the air time
'           This wil be the record to link to for the subreports
'           <input> tlInsertVehList() array of airtimevehicles
Public Sub mCreateKeyForInsertions(tlInsertVehList() As INSERTINFO, ilWhichSort As Integer)
    Dim illoop As Integer
    Dim ilRet As Integer
    Dim ilSelectedLoop As Integer
    Dim ilFound As Integer
    For illoop = LBound(tlInsertVehList) To UBound(tlInsertVehList) - 1
        ilFound = False
'6-30-15 setup all vehicles on the order
'            'only create the link records for Insertion Order for the selected vehicles
        If imAllVehicles Then
            ilFound = True
        Else
            For ilSelectedLoop = LBound(imSelectedVehicles) To UBound(imSelectedVehicles) - 1
                If tlInsertVehList(illoop).iVefCode = imSelectedVehicles(ilSelectedLoop) Then
                    ilFound = True
                    Exit For
                End If
            Next ilSelectedLoop
        End If
        If ilFound Then
            mSetupBrHdr ilWhichSort
            tmCbf.iExtra2Byte = -1
            tmCbf.iVefCode = tlInsertVehList(illoop).iVefCode
            tmCbf.lBarterCefCode = tlInsertVehList(illoop).lBarterCefCode
            tmCbf.sSnapshot = smSnapshot
            tmCbf.iDtFrstBkt(0) = tlInsertVehList(illoop).iDtFrstBkt(0)
            tmCbf.iDtFrstBkt(1) = tlInsertVehList(illoop).iDtFrstBkt(1)
            ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
        End If
    Next illoop
End Sub

'           Test if vehicle groups used;  If it is, test to see if the
'           item selected matches the vehicle processing
'           return - true to process record
Public Function mTestVGItem() As Integer
    Dim ilIncludeVehicleGroup As Integer
    Dim ilLoopOnVG As Integer
    Dim slStr As String
    Dim ilRet As Integer
    Dim ilVGListBox As Integer

    ilIncludeVehicleGroup = True
    '4-10-10 Billed and Booked is only report option that needs to test for the vehicle group selectivity
    If igRptCallType = CONTRACTSJOB Then
        If RptSelCt!lbcRptType.ListIndex = CNT_BOB Or RptSelCt!lbcRptType.ListIndex = CNT_SALESCOMPARE Then
            If RptSelCt!lbcRptType.ListIndex = CNT_BOB Then
                ilVGListBox = 7
            Else
                ilVGListBox = 8
            End If
            If RptSelCt!lbcSelection(ilVGListBox).SelCount > 0 Then
                ilIncludeVehicleGroup = False
                For ilLoopOnVG = 0 To RptSelCt!lbcSelection(ilVGListBox).ListCount - 1 Step 1
                    If RptSelCt!lbcSelection(ilVGListBox).Selected(ilLoopOnVG) Then
                        If ilVGListBox = 7 Then
                            slStr = tgMnfCodeCT(ilLoopOnVG).sKey        'b & b
                        Else
                            slStr = tgMnfCodeCB(ilLoopOnVG).sKey            'sales comparison
                        End If
                        ilRet = gParseItem(slStr, 2, "\", slStr)
                        'Determine which vehicle set to test and whether major or minor sort
                        If imMajorSet > 0 Then
                            If tmGrf.iPerGenl(3) = Val(slStr) Then
                                ilIncludeVehicleGroup = True
                                Exit For
                            End If
                        Else
                            If imMinorSet > 0 Then
                                If tmGrf.iPerGenl(2) = Val(slStr) Then
                                    ilIncludeVehicleGroup = True
                                    Exit For
                                End If
                            End If
                        End If
                    End If
                Next ilLoopOnVG
            End If
        End If
    End If
    mTestVGItem = ilIncludeVehicleGroup
End Function

'           mUpdateInsertVehList - see if the vehicle for air time line is a unique
'           one stored in array so that it can be linked for the subreport to print it
'           <input> ilListIndex - report type (insertion or contract/proposal)
'                   tlInsertVehList() array of unique vehicles to print for insertion order
'                   some CBS lines are ignored (those with 0 spots defined, not really
'                   cancel before start by user).  Those are the ones that should not print
'                   because there are no air time lines to link to.  Dont want a page with
'                   just header info.
Public Sub mUpdateInsertVehList(ilListIndex As Integer, tlInsertVehList() As INSERTINFO)
    Dim ilFound As Integer
    Dim illoop As Integer
    Dim ilUpper As Integer
    Dim ilIndex As Integer
    Dim blSelectedVehicle As Boolean

    blSelectedVehicle = mTestVehicleList(ilListIndex)
    If blSelectedVehicle Then
        If tmCbf.iExtra2Byte = 0 Then           'detail line info for air time line
            ilFound = False
            ilUpper = UBound(tlInsertVehList)
            For illoop = LBound(tlInsertVehList) To ilUpper - 1
                If tmCbf.iVefCode = tlInsertVehList(illoop).iVefCode And tmCbf.iDtFrstBkt(0) = tlInsertVehList(illoop).iDtFrstBkt(0) And tmCbf.iDtFrstBkt(1) = tlInsertVehList(illoop).iDtFrstBkt(1) Then
                    ilFound = True
                    'see if theres already a barter comment; if not, update it for this vehicle
                    If tlInsertVehList(illoop).lBarterCefCode = 0 Then
                        tlInsertVehList(illoop).lBarterCefCode = tmCbf.lBarterCefCode
                    End If
                    Exit For
                End If
            Next illoop
            If Not ilFound Then
                 tlInsertVehList(ilUpper).iVefCode = tmCbf.iVefCode
                 tlInsertVehList(ilUpper).iDtFrstBkt(0) = tmCbf.iDtFrstBkt(0)
                 tlInsertVehList(ilUpper).iDtFrstBkt(1) = tmCbf.iDtFrstBkt(1)
                 tlInsertVehList(ilUpper).lBarterCefCode = tmCbf.lBarterCefCode
                 ilUpper = ilUpper + 1
                 ReDim Preserve tlInsertVehList(LBound(tlInsertVehList) To ilUpper) As INSERTINFO
            End If
            
            mSaveEmailByCntVeh ilListIndex  'setup array of unique cnt & vehicles to create email pdfs
        End If
    End If
End Sub

'for Insertion Orders, user can select vehicles, as well as only certain vehicles can be included
'based on vehicle option for Selling, conventional and NTR
Public Function mTestVehicleList(ilListIndex As Integer) As Boolean
    Dim ilVehicle As Integer
    Dim blVEhicleSelected As Boolean
    Dim blOneFound As Boolean
    
    blOneFound = False
    blVEhicleSelected = True
    If (ilListIndex = CNT_INSERTION) Then
        If (tmClf.sType = "S" Or tmClf.sType = "H") Then  'only standard and hidden lines allowed for insertions
            For ilVehicle = 0 To UBound(imSelectedVehicles) - 1 Step 1
                If imSelectedVehicles(ilVehicle) = tmClf.iVefCode Then
                    blOneFound = True
                    Exit For
                End If
            Next ilVehicle
        End If
    End If
    If Not blOneFound Then
        blVEhicleSelected = False
    End If
    mTestVehicleList = blVEhicleSelected
End Function

'           mSaveEmailByCntVeh - setup array ( named tgEmail_Pdfs) of unique cnt & vehicles to create email pdfs
'           <input> ilListIndex - flag to indicate the report (Insertions)
Public Sub mSaveEmailByCntVeh(ilListIndex As Integer)
    Dim ilFound As Integer
    Dim illoop As Integer
    Dim ilUpper As Integer
    Dim ilIndex As Integer
    Dim blSelectedVehicle As Boolean

    If ilListIndex = CNT_INSERTION And RptSelCt!rbcOutput(3).Value = True Then
        'keep track of unique vehicles by contract & vehicle for the entire run
        ilFound = False
        ilUpper = UBound(tgEmail_PDFs)
        For illoop = LBound(tgEmail_PDFs) To ilUpper - 1
            If tmCbf.iVefCode = tgEmail_PDFs(illoop).iVefCode And tgChfCT.lCntrNo = tgEmail_PDFs(illoop).lCntrNo Then
                ilFound = True
                Exit For
            End If
        Next illoop
        If Not ilFound Then
            tgEmail_PDFs(ilUpper).iVefCode = tmCbf.iVefCode
            tgEmail_PDFs(ilUpper).lCntrNo = tgChfCT.lCntrNo
            tgEmail_PDFs(ilUpper).iCntRevNo = tgChfCT.iCntRevNo
            tgEmail_PDFs(ilUpper).lChfCode = tgChfCT.lCode
            tgEmail_PDFs(ilUpper).sVefName = ""
            ilIndex = gBinarySearchVef(tmCbf.iVefCode)
            If ilIndex >= 0 Then
                tgEmail_PDFs(ilUpper).sVefName = Trim$(tgMVef(ilIndex).sName)
            End If
            tgEmail_PDFs(ilUpper).sAdvtName = ""
            ilIndex = gBinarySearchAdf(tgChfCT.iAdfCode)
            If ilIndex <> -1 Then
                tgEmail_PDFs(ilUpper).sAdvtName = Trim$(tgCommAdf(ilIndex).sName)
            End If
            tgEmail_PDFs(ilUpper).sProduct = Trim$(tgChfCT.sProduct)
            tgEmail_PDFs(ilUpper).sAgyEstNo = Trim$(tgChfCT.sAgyEstNo) + Trim$(tgChfCT.sTitle)      '8-20-15
            tgEmail_PDFs(ilUpper).lEmfCode = lmEmfCode
            tgEmail_PDFs(ilUpper).sResponseDate = Trim$(smResponseDate)
            gUnpackDate tgChfCT.iStartDate(0), tgChfCT.iStartDate(1), tgEmail_PDFs(ilUpper).sStartDate
            gUnpackDate tgChfCT.iEndDate(0), tgChfCT.iEndDate(1), tgEmail_PDFs(ilUpper).sEndDate
            ilUpper = ilUpper + 1
            ReDim Preserve tgEmail_PDFs(LBound(tgEmail_PDFs) To ilUpper) As EMAIL_PDFS
        End If
    Else                'Order email not fully implemented yet (Save to Email has been hidden)
        'keep track of unique vehicles by contract & vehicle for the entire run
        ilFound = False
        ilUpper = UBound(tgEmail_PDFs)
        For illoop = LBound(tgEmail_PDFs) To ilUpper - 1
            If tgChfCT.lCntrNo = tgEmail_PDFs(illoop).lCntrNo Then
                ilFound = True
                Exit For
            End If
        Next illoop
        If Not ilFound Then
            tgEmail_PDFs(ilUpper).lCntrNo = tgChfCT.lCntrNo
            tgEmail_PDFs(ilUpper).iCntRevNo = tgChfCT.iCntRevNo
            tgEmail_PDFs(ilUpper).lChfCode = tgChfCT.lCode
            tgEmail_PDFs(ilUpper).sVefName = ""
            tgEmail_PDFs(ilUpper).sAdvtName = ""
            ilIndex = gBinarySearchAdf(tgChfCT.iAdfCode)        '3-7-18 was using wrong binary search
            If ilIndex >= 0 Then
                tgEmail_PDFs(ilUpper).sAdvtName = Trim$(tgCommAdf(ilIndex).sName)
            End If
            tgEmail_PDFs(ilUpper).sProduct = Trim$(tgChfCT.sProduct)
            tgEmail_PDFs(ilUpper).sAgyEstNo = Trim$(tgChfCT.sAgyEstNo) + Trim$(tgChfCT.sTitle)
            tgEmail_PDFs(ilUpper).lEmfCode = lmEmfCode
            tgEmail_PDFs(ilUpper).sResponseDate = Trim$(smResponseDate)
            gUnpackDate tgChfCT.iStartDate(0), tgChfCT.iStartDate(1), tgEmail_PDFs(ilUpper).sStartDate
            gUnpackDate tgChfCT.iEndDate(0), tgChfCT.iEndDate(1), tgEmail_PDFs(ilUpper).sEndDate
            ilUpper = ilUpper + 1
            ReDim Preserve tgEmail_PDFs(LBound(tgEmail_PDFs) To ilUpper) As EMAIL_PDFS
        End If
    End If
End Sub

'           mGetPkgCommentForInsert:  if line is a hidden line of package, see if theres a comment on the package line.
'           if so, bring down to hidden line and show if it applies
Public Sub mGetPkgCommentForInsertion(ilListIndex As Integer)
    Dim ilClf As Integer
    Dim tlClf As CLF
    
    tmCbf.lPkLnComment = 0
    If tmClf.sType = "H" And ilListIndex = CNT_INSERTION Then
        'see if theres a package comment to be applied to the hidden lines
        For ilClf = LBound(tgClfCT) To UBound(tgClfCT) - 1 Step 1
            tlClf = tgClfCT(ilClf).ClfRec
            If tmClf.iPkLineNo = tlClf.iLine Then           'matching line
                mGetComment tmCbf.lPkLnComment, tlClf.lCxfCode
                Exit For
            End If
        Next ilClf
    End If
End Sub

Private Sub mProcessBR(slStartDate As String, slEndDate As String, llDate As Long, llDate2 As Long, tlInstallSBFType As SBFTypes, tlSbf() As SBF, ilUpperPrint As Integer, ilShowStdQtr As Integer, slLastBillDate As String, llLastBillDate As Long, ilStdQtrLess13 As Integer, tlInsertVehList() As INSERTINFO, tlRvf() As RVF, ilListIndex As Integer, ilSocEcoMnfCode As Integer, ilShowMods As Integer, ilDiffOnly As Integer, ilThisCntMod As Integer, ilCurrTotalWks As Integer, llPrevSpots As Long, llPrevGross As Long, ilCurrAirWks As Integer, ilGot1ToPrint As Integer, ilLoopOnDiff As Integer, ilOption1 As Integer, ilOption2 As Integer, tlSBFType As SBFTypes)
    Dim ilRet As Integer
    ReDim ilCurrStartQtr(0 To 1) As Integer   'start date of first qtr processing (to be stored in cbf)
    Dim ilCurrTotalMonths As Integer        'total months of order processing (to be stored in cbf)
    Dim ilDemo As Integer
    ReDim llInstallBilling(0 To 13) As Long 'Index zero ignored
    ReDim ilVehiclesDone(0 To 1) As Integer       'array of installment vehicles processed
    Dim llCurrMod As Long                      'total contrct $ for current mod
    Dim llCurrModSpots As Long              'total contract spots for current mod
    Dim ilLineRate As Integer               'count of # of line items due to unique rates
    Dim ilLineSpots As Integer              'count by line & rate of # spots per week
    Dim ilLineSpotsInx As Integer           'index to entry of unique line in table
    Dim ilUpperDnf As Integer               'number of different demo research codes form contr
    Dim ilUpperClf As Integer
    Dim llResearchPop As Long               'pop to use for Research Totals (if different across lines, send 0 and pop will be calc based on grimps)
                                            'otherwise send the pop from the book
    Dim illoop As Integer
    Dim llChfStart As Long
    Dim llChfEnd As Long
    ReDim llStdStartDates(0 To 37) As Long  '12-29-06 chg from 13 bkts to 3 yrs + 1 ; start date of each std month, starting with start date or current
                                            'order, then each months start date for max 13.  Calc for each contr processing. Index zero ignored
    Dim ilCorpStdYear As Integer            'corp or std year that contracts belongs in
    Dim ilStartMonth As Integer             'starting month of corp or std year that contract belongs in
    Dim llTaxDate As Long
    Dim ilLastBilledInx As Integer
    ReDim llPopByLine(0 To 1) As Long           '11-23-99. Index zero ignored
    Dim slDailyExists As String * 1      '5-20-03 "Y" if at least 1 daily line exist for the contract
    Dim slSpotCount As String        '5-21-03
    Dim ilSpots As Integer                  'total spots for the flight week
    Dim ilAgyComm As Integer
    Dim ilClf As Integer
    Dim ilCff As Integer
    Dim llFltStart As Long                  'serial flight start date
    Dim llFltEnd As Long                    'serial flight end date
    Dim ilRealTotalWks As Integer           'total number of weeks based on contr start/end dates
    Dim ilTotalWks As Integer               'Total weeks of contract start to end
    Dim slMonth As String
    Dim slDay As String
    Dim slYear As String
    Dim slValidDays As String * 40           '5-20-03 chged frm 20 to 30 for 4 char / day (plus blank) for dailies
                                             '11-19-02 chged to 20 (from 10)represents days of the week airing string (without blanks & commas)
    Dim slTempDays As String                 'represents days of the week airing string (with blanks & commas)
    ReDim ilVehList(0 To 0) As Integer        'list of unique vehicles
    ReDim ilPkgVehList(0 To 0) As Integer        'list of unique packages (vehicles)  ie - more than one package line of the same name
    ReDim ilPkgLineList(0 To 0) As Integer    'list of line #s that are packages
    Dim llTax1CalcAmt As Long
    Dim llTax2CalcAmt As Long
    ReDim llProjectedTax1(0 To 37) As Long  'Index zero ignored
    ReDim llProjectedTax2(0 To 37) As Long  'Index zero ignored
    ReDim llProjectedFlights(0 To 37) As Long   'Index zero ignored
    Dim tlPkgVehicleForSurveyList() As PKGVEHICLEFORSURVEYLIST  '12-19-13  List of unique pakcage vehicles and book references.  i.e. 1 package vehicle may be defined for multiple lines.,
                                                                'the same hidden vehicle name name be across those 2 pkg lines and each have different book references
                                                                'i.e. Line 1 pkg: Acme pkg, hidden line Billy Crystal using book spring 2015; Line 2 pkg:  Acme, hidden line Billy Crystal using book Fall 2015
    Dim llTax1Pct As Long           'tax 1 pct from tax table
    Dim llTax2Pct As Long           'tax 2 pct from tax table
    Dim slGrossNet As String
    Dim ilFoundLine As Integer
    Dim ilTemp As Integer
    Dim slStr As String
    Dim ilCBS As Integer             '5-24-03
    Dim ilPkg As Integer
    Dim ilSavePkVeh As Integer
    Dim ilVehicle As Integer
    Dim llPop As Long                       'population from gDemoPOP
    Dim ilManyFlts As Integer               'true if more than 1 flt for a line, otherwise false.
                                            'This is so Crytal knows to show the package research totals when theres only 1 flt, and
                                            'not to put it on the total line only
    Dim ilVefIndex As Integer
    Dim ilVefInxForCallLetters As Integer
    Dim slPriceType As String * 1       '9-21-05 price type from line, except if insertion orders using acquisition cost, $0 will show blank
    Dim ilfirstTime As Integer
    ReDim ilInputDays(0 To 6) As Integer      'valid days of the week for gGetAvgAud
    Dim ilDemoAvgAudDays(0 To 6) As Integer     '11-19-02, rquired for valid days sent to audienc rtn
    Dim ilDay As Integer
    Dim ilWeekInx As Integer
    Dim llOvStartTime As Long               'override start time for Get Avg Aud
    Dim llOvEndTime As Long                 'overrride end time for gGetAvgAud
    Dim llAvgAud As Long
    Dim llPopEst As Long
    Dim ilAudFromSource As Integer
    Dim llAudFromCode As Long
    Dim ilCmpny As Integer
    Dim slSurvey As String                  'string of research books from lines
    Dim ilLoop3 As Integer
    Dim llCntGrimps As Long                    'contract total grimps calculated before each line written todisk so tha                                               'the % distribution can be obtained
    Dim ilRchQtr As Integer
    Dim ilQtr As Integer
    Dim llOverallPopEst As Long             '6-1-04 contract pop estimates for all lines
    
    ReDim llWklyspots(0 To MAXWEEKSFOR2YRS - 1) As Long   'arrays set up for each line to pass wkly research data to subrtn
    ReDim llWklyRates(0 To MAXWEEKSFOR2YRS - 1) As Long      'arrays set up for each line to pass wkly research data to subrtn
    ReDim llWklyAvgAud(0 To MAXWEEKSFOR2YRS - 1) As Long         'arrays set up for each line to pass wkly research data to subrtn
    ReDim ilWklyRtg(0 To MAXWEEKSFOR2YRS - 1) As Integer     'arrays set up for each line to return contracts research data
    ReDim llWklyGrimp(0 To MAXWEEKSFOR2YRS - 1) As Long      'arrays set up for each line to return contracts research data
    ReDim llWklyGRP(0 To MAXWEEKSFOR2YRS - 1) As Long        'arrays set up for each line to return contracts research data
    ReDim llWklyPopEst(0 To MAXWEEKSFOR2YRS - 1) As Long     'array set up for each line
   
    'Dim llTemp As Long
    Dim dlTemp As Double 'TTP 10439 - Rerate 21,000,000
    Dim llLnSpots As Long                   'total spots to pass to Research routines
    Dim ilFoundVeh As Integer               'include the vehicle for processing (only possibly excluded if Insertion Orders)
    Dim blSelectedVehicle As Boolean
    Dim ilPkgOrSpot As Integer
    Dim blAcqOK As Boolean
    Dim llTempStart As Long
    Dim llTempEnd As Long
    Dim llPrevCntGrimps As Long                 'contr total grimps calculated o previous order before each line written to disk so that
                                                'the % distr can be obtained
    Dim slNameCode As String
    Dim slCode As String
    Dim ilVaryingQtrs As Integer
    Dim llAccumSpotCount As Long            '3-25-05
    Dim llAcqNet As Long
    Dim llAcqComm As Long
    Dim ilMonthLoop As Integer
    Dim ilHiddenAndConv As Integer
    Dim ilVpfIndex As Integer               '3-9-18
    Dim blPodExists As Boolean
    Dim blNonPodExists As Boolean
    Dim llLoopOnQtr As Long             '4-10-19 replace ilQTr subscript out of range issue
    Dim llRchQtr As Long              '4-10-19 replace ilRchQtr subscript out of range issue
    Dim llTempLRch As Long              '4-10-19 replace ilTemp subscript out of range issue
    Dim blDefaultToQtr As Boolean       '1-7-21
    Dim ilWhichSort As Integer          '1-7-20  0 = advt, 1 = agy, 2 = slsp
    Dim ilShowProof As Integer          '1-7-20
    Dim slTempGrimp As String
    Dim tmPkgCbf As CBF '8410 - Holds package vehicle information for gathering hidden vehicle data
    Dim ilClfInx As Integer '8410
    '1-7-21 variables to send sort and proofing (hidden lines) request
    If RptSelCt!rbcSelCSelect(0).Value Then     'which sort - adv
        ilWhichSort = 0
    ElseIf RptSelCt!rbcSelCSelect(1).Value Then 'agy
        ilWhichSort = 1
    Else
        ilWhichSort = 2                         'slsp
    End If
    
    If RptSelCt!ckcSelC6(2).Value = vbChecked Then          'hidden selected, proof which includes hidden lines for package
        ilShowProof = True
    Else
        ilShowProof = False
    End If
    
    'retrieve R/C, items, and DP info for the rate card that contract uses
    gRCRead RptSelCt, tgChfCT.iRcfCode, tmRcf, tmMRif(), tmMRDF()

    ilCurrStartQtr(0) = 0                       'init to place start date of starting qtr of order
    ilCurrStartQtr(1) = 0
    ilCurrTotalMonths = 0
    'Set up earliest/latest dates of contr, set to std dates.  Set array of starting bdcst months for summary page
    'mFindMaxDates slStartDate, slEndDate, llChfStart, llChfEnd, ilCurrStartQtr(), ilCurrTotalMonths, llStdStartDates()
    'get the Installment records, if applicable
    ReDim tlSbf(0 To 0) As SBF
    ilRet = gObtainSBF(RptSelCt, hmSbf, tgChfCT.lCode, slStartDate, slEndDate, tlInstallSBFType, tlSbf(), 0)

    For ilDemo = 0 To 3 Step 1                  'user input Entered and Active dates
        If tgChfCT.iMnfDemo(ilDemo) > 0 Or ilDemo = 0 Then
            tmCbf = tmZeroCbf
            'initalize for installment info
            ReDim Preserve ilVehiclesDone(0 To 0) As Integer    'installmentvehicles gathered for monthly summary
            'ReDim Preserve llInstallBilling(1 To 13) As Long    '12 months max of installment billing, anything over is accum in one bucket
            ReDim Preserve llInstallBilling(0 To 13) As Long    '12 months max of installment billing, anything over is accum in one bucket. Index zero ignored
    
            tmCbf.iVehSort = ilDemo             '8-21-15 for sorting of multiple demos, to keep in same order as entered
            tmCbf.sHiddenOverride = "N"         '3-10-06 assume not using hidden override feature from Site
            llCurrMod = 0                       'init total $ this version
            llCurrModSpots = 0                  'init total spot count this version
            imDiffExceeds104Wks = False         '3-9-06 this is for difference only version
            ReDim Preserve lgPrintedCnts(0 To ilUpperPrint) As Long
            lgPrintedCnts(ilUpperPrint) = tgChfCT.lCode
            ilUpperPrint = ilUpperPrint + 1

            ReDim lmWklyspots(0 To MAXWEEKSFOR2YRS, 0 To 0) As Long          'array of spots by week for one sched line, reqd for research results
            ReDim lmWklyRates(0 To MAXWEEKSFOR2YRS, 0 To 0) As Long             'array of rates by week for one sch line, reqd for research results
            ReDim lmAvgAud(0 To MAXWEEKSFOR2YRS, 0 To 0) As Long                'array of avg aud by week for one sch line, reqd for research
            ReDim lmPopEst(0 To MAXWEEKSFOR2YRS, 0 To 0) As Long
            ReDim lmPop(0 To 0) As Long                              'population bh vehicle
            ReDim lmPopPkg(0 To 0) As Long                          '11-24-04 pop for the pkg because of using same hidden vehicle reference as the pkg vehicle
            ReDim tmLRch(0 To 1) As RESEARCHINFO    'Index zero ignored
            ReDim lmSpotsByWk(0 To MAXWEEKSFOR2YRS, 0 To 1) As Long  'array of 105 weeks (2 yrs) containing spot counts for unique spot rate
                                                            'each one of these 104 week arrays correspond to one tmLnr entry. Index zero ignored
            ReDim lmratesbywk(0 To MAXWEEKSFOR2YRS, 0 To 1) As Long  'array of 105 weeks (2 yrs) containing spot rates per week
                                                            'each one of these 104 week arrays correspond to one tmLnr entry. Index zero ignored
            ReDim tmLnr(0 To 1) As LNR                        'array of unique spot rates for a line.  One line can vary in
                                                            'rates from week to week.  By building all lines in memory at once,
                                                            'we can get the actual # of airing weeks.  For Differences option,
                                                            'previous versions schedule lines are also built; for non-differences
                                                            'option, only the current lines are built
                                                            'i.e.  Line #       Rate
                                                            '        1           25000
                                                            '        1           27500
                                                            '        2           25000
                                                            '        3           40000
                                                            'Index zero ignored
            ReDim imDnfCodes(0 To 1) As Integer               'array of Demo Research names used from contr. Index zero ignored
            ReDim imProcessFlag(0 To UBound(tgClfCT)) As Integer          'flags to indicate how to process line (show current vs mods, differences)
            ilLineRate = 1
            ilLineSpots = 1
            ilUpperClf = 0                                  'no lines in research table
            
            '3-31-21 initialize the variables to combine air time and adserver Impressions and cost to calculate CPM on the Research Summary page
            sgAirTimeGrimp = ""
            lgAirTimeGross = 0
            ilUpperDnf = 1
            illoop = 0
            llResearchPop = -1                       'pop from book if all same books across lines, else
                                                    'its zero
            '11-30-07 make generalized routine
            gChfDatesToLong tgChfCT.iStartDate(), tgChfCT.iEndDate(), llDate, llDate2, slStartDate, slEndDate  'convert contract header start & end dates to long
    
            blDefaultToQtr = True
            gFindMaxDates slStartDate, slEndDate, llChfStart, llChfEnd, ilCurrStartQtr(), ilCurrTotalMonths, llStdStartDates(), ilShowStdQtr, ilCorpStdYear, ilStartMonth, blDefaultToQtr       '1-7-21
            
            'determine first month in the future (after last billing date)
            llTaxDate = gDateValue(slLastBillDate)
            If llTaxDate < llStdStartDates(1) Then        'everything is in the future
                ilLastBilledInx = 1
            ElseIf llTaxDate >= llStdStartDates(37) Then       'everything in past
                ilLastBilledInx = 1
            Else
                'contract spans the last bill date
                ilLastBilledInx = 1
                For illoop = 1 To 36
                    If llTaxDate > llStdStartDates(illoop) And llTaxDate < llStdStartDates(illoop + 1) Then
                        ilLastBilledInx = illoop
                        Exit For
                    End If
                Next illoop
            End If
            
            '11-14-11 Some quarters may be 12 or 14 week qtrs; default all to 13 week qtrs and set the quarter than is non-std
            For illoop = 1 To 8
                imWeeksPerQtr(illoop) = 13
            Next illoop
    
            'build table of how to process the lines for the CBF file and output shown on BR
            'for differences, gather the current lines and most recent mod
            'for Full BR, gather only current lines
            'array corresponds to the lines built in tgClfCt:
            '0 = ignore altogether, old mod.
            '1 = previous mod, process for BR
            '2 = don't show on BR but use to calc flights because its a current line from an older mod,
            '    and need to figure out # of active weeks vs actual weeks
            '3 = current, same revision # as header, need to show and process
            '4 = hidden line shown on proof. Show it, but don't use in any calculations of flights
            If UBound(tgClfCT) > UBound(llPopByLine) Then                 '12-14-99
                'ReDim llPopByLine(1 To UBound(tgClfCT)) As Long               '11-23-99
                ReDim llPopByLine(0 To UBound(tgClfCT)) As Long               '11-23-99. Index zero ignored
            End If
    
            slDailyExists = "N"           '5-20-30 assume no dailys on this order
            ReDim tlSofList(0 To 0) As SOFLIST  'make use of existing table to store the vehicle and flag if there is at least one day for the vehicle.
                                                'this is for Insertion Orders only because one vehicle may be only weekly and another daily; but
                                                'dont want to show dotted vertical lines for the weekly only vehicles
    
            ReDim tmPodcast_Info(0 To 0) As PODCAST_INFO         '3-9-18
            mSetupBrHdr ilWhichSort                       'build the advt, agy, slsp and sort fields specs that ned to be built
                                                'only once per contract
    
            If tgChfCT.iAgfCode > 0 Then        'get agy comm in case taxes need to be obtained
                ilAgyComm = tmAgf.iComm
            Else
                ilAgyComm = 0                       'direct
            End If
        
            tmCbf.sRschColHdr = ""                  'init to show column headers for avg rtg, grp and cpp
            tmCbf.sMixTypes = ""                    'init to show field values for avg rtg, grp & cpp
            
            For ilClf = LBound(tgClfCT) To UBound(tgClfCT) - 1 Step 1
                tmClf = tgClfCT(ilClf).ClfRec
                '3-18-19 see if the demo exist, if not, use default book if different than the current one stored in line
                'if same default book, 0 the book reference
                tmDnfSrchKey.iCode = tmClf.iDnfCode

                ilRet = btrGetEqual(hmDnf, tmDnf, imDnfRecLen, tmDnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                If ilRet <> BTRV_ERR_NONE Then
                    'book doesnt exist, find the default book
                    ilRet = gBinarySearchVef(tmClf.iVefCode)
                    If ilRet <> -1 Then
                        If tmClf.iDnfCode <> tgMVef(ilRet).iDnfCode Then
                            tgClfCT(ilClf).ClfRec.iDnfCode = tgMVef(ilRet).iDnfCode
                            
                        Else                'same invalid reference
                            tgClfCT(ilClf).ClfRec.iDnfCode = 0
                        End If
                    End If
                Else            'book exists
                    ilRet = ilRet
                End If
                
                ilVefIndex = gBinarySearchVef(tmClf.iVefCode)
                If ilVefIndex <> -1 Then        '10-23-06 if new package vehicle entered for proposal, the index wont exist.  The vehicle
                    '3-9-18 determine if podcast vehicles to show rating info or not
                    'determine if combination of podcast cast vs no podcast vehicles for output to show avgrtg, grp or ccp
                    ilVpfIndex = gBinarySearchVpf(tmClf.iVefCode)
                    If ilVpfIndex <> -1 Then
                        'Build array from sch lines that contain the type of line (podcast, non podcast, package , non package) to
                        'help determine if the line should show grp,cpp or avg rtg on the contract
                        tmPodcast_Info(UBound(tmPodcast_Info)).iLine = tmClf.iLine
                        If tgVpf(ilVpfIndex).sGMedium = "P" Then
                            If bmShowAudIfPodcast Then              '4-18-18 show Aud % for Podcast vehicles?
                                'override the feature and show all Aud % for this podcast vehicle
                                If tmClf.sType = "H" Then
                                    tmPodcast_Info(UBound(tmPodcast_Info)).sType = "L"      'force to other non-pkg hidden line
                                Else
                                    If tmClf.sType = "O" Or tmClf.sType = "A" Then          'pkg line?
                                        tmPodcast_Info(UBound(tmPodcast_Info)).sType = "K"      'force to other non-pkg hidden line
                                    Else
                                        tmPodcast_Info(UBound(tmPodcast_Info)).sType = "L"      'force to other non-pkg hidden line
                                    End If
                                End If
                            Else                                    '4-18-18 do not show aud % for Podcast vehicle
                                'podcast:  is it a hidden line of package or not
                                If tmClf.sType = "H" Then
                                    'type of line:  P = Podcast, K = package line, H = Podcast Hidden Line, L = Other, not podcast Hidden Line, O = other, not poscast (conventional, selling)
                                    tmPodcast_Info(UBound(tmPodcast_Info)).sType = "H"
                                Else
                                    If tmClf.sType = "O" Or tmClf.sType = "A" Then      'package line?
                                        tmPodcast_Info(UBound(tmPodcast_Info)).sType = "K"
                                    Else
                                        tmPodcast_Info(UBound(tmPodcast_Info)).sType = "P"      'podcast vehicle, not within a package
                                    End If
                                End If
                            End If
                        Else            'not podcast
                            If tmClf.sType = "H" Then
                                tmPodcast_Info(UBound(tmPodcast_Info)).sType = "L"      'not podcast, hidden line
                            Else
                                If tmClf.sType = "O" Or tmClf.sType = "A" Then          'package line?
                                    tmPodcast_Info(UBound(tmPodcast_Info)).sType = "K"
                                Else                                                    'standard line, not a podcast
                                    tmPodcast_Info(UBound(tmPodcast_Info)).sType = "O"
                                End If
                            End If
                        End If
                        tmPodcast_Info(UBound(tmPodcast_Info)).iPkgRefLine = tmClf.iPkLineNo
                        tmPodcast_Info(UBound(tmPodcast_Info)).bShowResearch = True             'assume to show research fields
                        tmPodcast_Info(UBound(tmPodcast_Info)).iVefCode = tmClf.iVefCode
                        ReDim Preserve tmPodcast_Info(0 To UBound(tmPodcast_Info) + 1) As PODCAST_INFO
                    End If
                End If
            
                gUnpackDate tmClf.iStartDate(0), tmClf.iStartDate(1), slStartDate
                gUnpackDate tmClf.iEndDate(0), tmClf.iEndDate(1), slEndDate

                'test for cancel before start which is always start date one day later that end date
                'This is code to fix up schedule lines that had bad start & end dates in them.  They didnt coincide with the flights or header
                If ((gDateValue(slStartDate) - gDateValue(slEndDate)) <> 1) Then      'not cancel before start
                    If gDateValue(slStartDate) < llChfStart Or gDateValue(slStartDate) > llChfEnd Then
                        slStartDate = Format$(llChfStart, "m/d/yy")
                    End If
                    If gDateValue(slEndDate) < llChfStart Or gDateValue(slEndDate) > llChfEnd Then
                        slEndDate = Format$(llChfEnd, "m/d/yy")
                    End If
                End If
                If slStartDate = "" Then
                    llFltStart = 0
                Else
                    llFltStart = gDateValue(slStartDate)
                End If
                If slEndDate = "" Then
                    llFltEnd = 0
                Else
                    llFltEnd = gDateValue(slEndDate)
                End If
                imProcessFlag(ilClf) = 3
            Next ilClf
            'Adjust dates to Monday and to start of the quarter.  Just obtained the earliest and latest
            'dtes of the contract.  If differences, considered all past lines for earliest and latest dates
            '
            'backup start date of contract to Monday, then decide how many quarters to process for this contract.
            'Always show data from a start quarter unless the total # of weeks is less than 13.
            '
            'llDate = gDateValue(slStartDate)
            'llDate contains earliest start date of sch lines
    
            illoop = gWeekDayLong(llDate)
            Do While illoop <> 0
                llDate = llDate - 1
                illoop = gWeekDayLong(llDate)
            Loop
            slStartDate = Format$(llDate, "m/d/yy")
            slEndDate = Format$(llDate2, "m/d/yy")
            
            ilRealTotalWks = (gDateValue(slEndDate) - gDateValue(slStartDate)) \ 7 + 1
            If ilRealTotalWks < 0 Then          'this condition only for Cancel Before start contracts
                                                'where there isn't a start & end date in header
                ilRealTotalWks = 1
            End If
            ilTotalWks = ilRealTotalWks         'this will be the total number of weeks including the start of the qtr
            If (ilTotalWks > 13) Or (ilStdQtrLess13) Then          'only show complete quarters on BR if the schedule lasts longers
                                                'than 13 weeks, or site is set up to always show on start of std qtrs
                slStartDate = gObtainEndStd(slStartDate)        'get std bdcst end date
                gObtainYearMonthDayStr slStartDate, True, slYear, slMonth, slDay
                Do While (slMonth <> "01") And (slMonth <> "04") And (slMonth <> "07") And (slMonth <> "10")
                    slMonth = str$((Val(slMonth) - 1))
                    slDay = "15"
                    slStartDate = slMonth & "/" & slDay & "/" & slYear
                    gObtainYearMonthDayStr slStartDate, True, slYear, slMonth, slDay
                    slStartDate = gObtainEndStd(slStartDate)        'get std bdcst end date
                Loop
                'slStartDate now contains the end date of a quarter
                slStartDate = gObtainStartStd(slStartDate)      'start date of the quarter for this cnt
                'recalculate the totals wks because the start date was pushed back to the start of the qtr
                ilTotalWks = (gDateValue(slEndDate) - gDateValue(slStartDate)) \ 7 + 1
                
                slTempDays = slStartDate
                llDate = gDateValue(slTempDays)
                
                'determine if any quarter has 14 weeks to set the array of weeks per qtr for 8 quarters
                For illoop = 1 To 8
                    slTempDays = Format$((llDate + 75), "m/d/yy")
                    slTempDays = gObtainEndStd(slTempDays)
                    llDate2 = gDateValue(slTempDays)
                    If (llDate2 - llDate) = 83 Then          '12 week qtr
                        imWeeksPerQtr(illoop) = 12
                    ElseIf (llDate2 - llDate) > 90 Then            '14 week qtr
                        imWeeksPerQtr(illoop) = 14
                    End If
                    llDate = llDate2 + 1        'start of next qtr
                    slTempDays = Format$(llDate, "m/d/yy")
            
                 Next illoop
            End If                                              'if ilTotalsWks > 13
            'slStartDate contains the start of quarter or week that is to being on BR
    
            '4-12-19 2 years (8 qtrs is the max to process for any contract).  Process only the number of quarters on a contract to speed up processing.
            imMaxQtrs = 8
            'llTemp = gDateValue(slStartDate)
            dlTemp = gDateValue(slStartDate)
            For illoop = 1 To 8
                dlTemp = (7 * imWeeksPerQtr(illoop)) + dlTemp
                If dlTemp > gDateValue(slEndDate) Then
                    imMaxQtrs = illoop
                    Exit For
                End If
            Next illoop
            If imMaxQtrs > 8 Then
                imMaxQtrs = 8
            End If
            
            ReDim Preserve ilVehList(0 To 0) As Integer
            ReDim Preserve tlInsertVehList(0 To 0) As INSERTINFO   '12-12-08
            ReDim Preserve ilPkgVehList(0 To 0) As Integer
            ReDim Preserve ilPkgLineList(0 To 0) As Integer
            ReDim lmPopPkgByLine(0 To 0) As Long                '11-11-05
    
            If ((Asc(tgSpf.sUsingFeatures3) And TAXONAIRTIME) = TAXONAIRTIME) Or ((Asc(tgSpf.sUsingFeatures3) And TAXONNTR) = TAXONNTR) Then        '12-22-11 test for ntr only taxes
                'if taxes apply, find all IN receivables prior to last billing date.  Add up tax1 and tax2 amounts
                'When going thru each line, calc the taxes after last billing date
                ilRet = gObtainPhfRvfbyCntr(RptSelCt, tgChfCT.lCntrNo, "1/1/1970", slLastBillDate, tmTranTypes, tlRvf())
                llTax1CalcAmt = 0
                llTax2CalcAmt = 0
                'accumulate taxes for IN airtime only thru the end of the last bill date, NTR will be processed later
                For illoop = LBound(tlRvf) To UBound(tlRvf) - 1
                    gUnpackDateLong tlRvf(illoop).iTranDate(0), tlRvf(illoop).iTranDate(1), llDate
                    If tlRvf(illoop).iMnfItem = 0 And llDate <= llLastBillDate Then
                        llTax1CalcAmt = llTax1CalcAmt + tlRvf(illoop).lTax1
                        llTax2CalcAmt = llTax2CalcAmt + tlRvf(illoop).lTax2
                    End If
                Next illoop
    
                For illoop = LBound(llProjectedTax1) To UBound(llProjectedTax2) - 1
                    llProjectedTax1(illoop) = 0
                    llProjectedTax2(illoop) = 0
                Next illoop
            End If

            'cycle thru all the lines and build arrays that have same line, vehicle, daypart, length, & rate.  Each of these unique entries
            'shows on a separate line on the printed contract.
            ReDim tlPkgVehicleForSurveyList(0 To 0) As PKGVEHICLEFORSURVEYLIST          '12-19-13
            
            For ilClf = LBound(tgClfCT) To UBound(tgClfCT) - 1 Step 1
                '3-15-19 adjust for 0 based array, index 0 ignored
                ReDim Preserve lmWklyspots(0 To MAXWEEKSFOR2YRS, 0 To ilUpperClf) As Long         'array of spots by week for one sched line, reqd for research results
                ReDim Preserve lmWklyRates(0 To MAXWEEKSFOR2YRS, 0 To ilUpperClf) As Long            'array of rates by week for one sch line, reqd for research results
                ReDim Preserve lmAvgAud(0 To MAXWEEKSFOR2YRS, 0 To ilUpperClf) As Long               'array of avg aud by week for one sch line, reqd for research
                ReDim Preserve lmPopEst(0 To MAXWEEKSFOR2YRS, 0 To ilUpperClf) As Long
                tmClf = tgClfCT(ilClf).ClfRec
    
                If ((Asc(tgSpf.sUsingFeatures3) And TAXONAIRTIME) = TAXONAIRTIME) Then
                    'determine the tax amt for future dates (after last billing date)
                    'a contract can be max 3 years
                    gGetAirTimeTaxRates tgChfCT.iAdfCode, tgChfCT.iAgfCode, tmClf.iVefCode, llTax1Pct, llTax2Pct, slGrossNet
                    gBuildFlights ilClf, llStdStartDates(), ilLastBilledInx, 36, llProjectedFlights(), 1, tgClfCT(), tgCffCT()
                    gFutureTaxes ilLastBilledInx, llProjectedFlights(), llProjectedTax1(), llProjectedTax2(), ilAgyComm, tgChf.iPctTrade, llTax1Pct, llTax2Pct, slGrossNet
                End If
                'Build table of unique vehicles and whether they have at least one daily schedule line (for Insertion Orders) to show dotted vertical lines
                'use existing variable from another report
                ilFoundLine = False
                For ilTemp = LBound(tlSofList) To UBound(tlSofList) - 1
                    If tlSofList(ilTemp).iMnfSSCode = tmClf.iVefCode Then
                        ilFoundLine = True
                        Exit For
                    End If
                Next ilTemp
                If Not ilFoundLine Then
                    tlSofList(UBound(tlSofList)).iMnfSSCode = tmClf.iVefCode         'setup unqiue vehicle and assume not dailies yet
                    tlSofList(UBound(tlSofList)).iSofCode = False       'assume no daily exists yet for this vehicle
                    ReDim Preserve tlSofList(UBound(tlSofList) + 1) As SOFLIST
                End If
    
                gUnpackDate tmClf.iStartDate(0), tmClf.iStartDate(1), slStr
                llFltStart = gDateValue(slStr)
                gUnpackDate tmClf.iEndDate(0), tmClf.iEndDate(1), slStr
                llFltEnd = gDateValue(slStr)
    
                If (llFltStart >= gDateValue(slStartDate)) Or (llFltStart < gDateValue(slStartDate) And ilListIndex = CNT_INSERTION And RptSelCt!ckcSelC6(1).Value = vbUnchecked) Then         '6-15-04 ignore the CBS lines that are outside the contract dates
                                                                    'including the CBS line outside the contract dates causes problems in research numbers
                                                                    '5-29-09 - include if Insertion Order without Research numbers.  Client needs to send to affiliate to let them know
                                                                    'parts of the order has cancelled.
    
                    If llFltEnd >= llFltStart Then
                        ilCBS = False
                        'Build array of the unique package vehicle names
                        '11-11-05 build array of the package vehicle pops (lmpoppkgbyLine) associated with the package line line (ilPkgLineList)
                        If tmClf.sType = "O" Or tmClf.sType = "A" Or tmClf.sType = "E" Then      'pkg line
    
                            'build array of the Package line #s
                            ilFoundLine = False
                            For ilPkg = LBound(ilPkgLineList) To UBound(ilPkgLineList) - 1 Step 1
                                If tmClf.iLine = ilPkgLineList(ilPkg) Then
                                    ilFoundLine = True
                                    Exit For
                                End If
                            Next ilPkg
                            If Not ilFoundLine Then
                                ilPkgLineList(UBound(ilPkgLineList)) = tmClf.iLine
                                ReDim Preserve ilPkgLineList(LBound(ilPkgLineList) To UBound(ilPkgLineList) + 1)
                                ReDim Preserve lmPopPkgByLine(LBound(lmPopPkgByLine) To UBound(lmPopPkgByLine) + 1)      '11-11-05 package pop (not by unqiue packages vehicle names, but each individual pkg)
                                '4/9/99
                                ilPkgVehList(UBound(ilPkgVehList)) = tmClf.iVefCode                 'unique package vehicle list
                                ReDim Preserve ilPkgVehList(LBound(ilPkgVehList) To UBound(ilPkgVehList) + 1)
                            End If
                        Else                        '12-19-13 not package; build association with package vehicle if hidden
                            If tmClf.sType = "H" Then
                                If tmClf.iDnfCode > 0 Then
                                    'got a hidden line, find the associated package line to get the vehicle code
                                    ilSavePkVeh = -1
                                    For ilPkg = LBound(tgClfCT) To UBound(tgClfCT) - 1 Step 1
                                        If tmClf.iPkLineNo = tgClfCT(ilPkg).ClfRec.iLine Then   'found the associated pkg line
                                            ilSavePkVeh = tgClfCT(ilPkg).ClfRec.iVefCode        'save the associated pkg vehicle code
                                            Exit For
                                        End If
                                    Next ilPkg
                                    
                                    
                                    ilFoundLine = False
                                    For ilPkg = 0 To UBound(tlPkgVehicleForSurveyList) - 1 Step 1
                                        If ilSavePkVeh = tlPkgVehicleForSurveyList(ilPkg).iPkgVefCode And tmClf.iDnfCode = tlPkgVehicleForSurveyList(ilPkg).iHiddenDnfCode Then
                                            ilFoundLine = True
                                            Exit For
                                        End If
                                    Next ilPkg
                                    If (Not ilFoundLine) And (ilSavePkVeh > 0) Then
                                        tlPkgVehicleForSurveyList(UBound(tlPkgVehicleForSurveyList)).iPkgVefCode = ilSavePkVeh
                                        tlPkgVehicleForSurveyList(UBound(tlPkgVehicleForSurveyList)).iHiddenDnfCode = tmClf.iDnfCode
                                        ReDim Preserve tlPkgVehicleForSurveyList(0 To UBound(tlPkgVehicleForSurveyList) + 1) As PKGVEHICLEFORSURVEYLIST
                                    End If
                                End If
                            End If
                        End If
    
                        ilFoundLine = False
                        For ilVehicle = LBound(ilVehList) To UBound(ilVehList) - 1 Step 1
                            If tmClf.iVefCode = ilVehList(ilVehicle) Then
                                ilFoundLine = True
                                Exit For
                            End If
                        Next ilVehicle
                        If Not ilFoundLine Then
                            ilVehList(UBound(ilVehList)) = tmClf.iVefCode
                            ilVehicle = UBound(ilVehList)
                            ReDim Preserve ilVehList(LBound(ilVehList) To UBound(ilVehList) + 1)
                            ReDim Preserve lmPop(0 To UBound(lmPop) + 1)
                            ReDim Preserve lmPopPkg(0 To UBound(lmPopPkg) + 1)  '11-24-04 pop for the pkg because of using same hidden vehicle reference as the pkg vehicle
                        End If
                           
                        'Build population table by vehicle
                        ilRet = gGetDemoPop(hmDrf, hmMnf, hmDpf, tmClf.iDnfCode, ilSocEcoMnfCode, tgChfCT.iMnfDemo(ilDemo), llPop)
                        If tmClf.iDnfCode = 0 Then                      '3-12-19 if no book assigned to line, ignore the population
                            llPop = 0
                        End If
    
                        If tmClf.sType = "H" Or tmClf.sType = "S" Then      '11-24-04 exclude packages
                            If tgSpf.sDemoEstAllowed <> "Y" Then
                                llPopByLine(ilClf + 1) = llPop    '11-23-99 save the pop by line (each linemay have different survey books)
                                If lmPop(ilVehicle) = 0 Then            'same vehicle found more than once, if pop already stored,
                                                                        'dont wipe out with a possible non-population value
                                    lmPop(ilVehicle) = llPop            'associate the population with the vehicle
                                End If
                                If llResearchPop = -1 And llPop <> 0 Then          'first time, llResearchPop is for the summary records (-1 first time thru, 0 = different books across vehicles)
                                    llResearchPop = llPop
                                Else
                                    If (llResearchPop <> 0) And (llResearchPop <> llPop) And (llPop <> 0) Then      'test to see if this pop is different that the prev one.
                                        If tmClf.iDnfCode > 0 Then                      '3-12-19 ignore this line pop if no book defined
                                            llResearchPop = 0                                           'if different pops, calculate the contract  summary different
                                        End If
                                        If llPop <> lmPop(ilVehicle) Then  '11-30-99
                                            lmPop(ilVehicle) = -1          '11-30-99
                                        End If                             '11-30-99
                                    Else
                                        'if current line has population, but there was already a different across
                                        'lines in pop, dont save new one
                                        If llPop <> 0 And (llResearchPop <> 0 And llResearchPop <> -1) Then   '2/1/99
                                            llResearchPop = llPop
                                        Else        '5-8-02
                                            If lmPop(ilVehicle) <> llPop And lmPop(ilVehicle) <> -1 Then
                                                lmPop(ilVehicle) = -1
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        End If
    
    
'                        If tmClf.iDnfCode > 0 Then        '3-12-19  remove test, need to show those lines without a book assigned
                            ilFoundLine = False
                            For illoop = LBound(imDnfCodes) To ilUpperDnf - 1 Step 1
                                If imDnfCodes(illoop) = tmClf.iDnfCode Then
                                    ilFoundLine = True
                                End If
                            Next illoop
                            If Not (ilFoundLine) Then
                                'ReDim Preserve imDnfCodes(1 To ilUpperDnf) As Integer
                                ReDim Preserve imDnfCodes(0 To ilUpperDnf) As Integer
                                imDnfCodes(ilUpperDnf) = tmClf.iDnfCode
                                ilUpperDnf = ilUpperDnf + 1
                            End If
'                        End If
                    Else            'cancel before start
                        ilCBS = True
                    End If
                    ilManyFlts = False
                    ilCff = tgClfCT(ilClf).iFirstCff
                    Do While ilCff <> -1
                        tmCff = tgCffCT(ilCff).CffRec
                        ilVefIndex = gBinarySearchVef(tmClf.iVefCode)
                        If tgMVef(ilVefIndex).sType = "G" Then          'sports vehicle
                            tmCff.sDyWk = "W"
                        End If
    
                        '6/9/15: replaced acquisition from site override with Barter in system options
                        ''8-23-05 use the acquisition cost only if running insertion orders and Research is not requested and the
                        ''acquisition cost has a value
                        lmActPrice = tmCff.lActPrice
                        slPriceType = tmCff.sPriceType  '9-21-05
                        'If (ilListIndex = CNT_INSERTION) And ((Asc(tgSpf.sOverrideOptions) And SPACQUISITION) = SPACQUISITION) And (RptSelCt!ckcSelC6(1).Value = vbUnchecked) Then
                        If (ilListIndex = CNT_INSERTION) And ((Asc(tgSpf.sUsingFeatures2) And BARTER) = BARTER) And (RptSelCt!ckcSelC6(1).Value = vbUnchecked) Then
                            slPriceType = ""                    'never calc comm on Insertion order, it is done in code and passed in field
                            If tmClf.lAcquisitionCost = 0 Then
                                If ((Asc(tgSaf(0).sFeatures1) And SHOWPRICEONINSERTIONWITHACQUISTION) <> SHOWPRICEONINSERTIONWITHACQUISTION) Then 'Show Spot Prices on Insertion Orders if Acquistion Exist
                                    lmActPrice = tmClf.lAcquisitionCost
                                    'slPriceType = ""            'force to show blank on $0
                                End If
                            Else
                                lmActPrice = tmClf.lAcquisitionCost
                                'slPriceType = ""            'force to show blank on $0
                            End If
                        End If
    
                        ilfirstTime = True                  'set to calc avg aud one time only for this flight
                        If tmCff.sDyWk = "W" Or ilCBS Then
                            slTempDays = gDayNames(tmCff.iDay(), tmCff.sXDay(), 2, slStr)            'slstr not needed when returned
                            slStr = ""
                            For illoop = 1 To Len(slTempDays) Step 1
                                slYear = Mid$(slTempDays, illoop, 1)
                                If slYear <> " " And slYear <> "," Then
                                    slStr = Trim$(slStr) & Trim$(slYear)
                                End If
                            Next illoop
                        Else                '11-19-02
                            'Setup # spots/day
                            If tmCff.sDyWk = "D" Then            '5-20-03 daily
                                slDailyExists = "Y"
                                For ilTemp = LBound(tlSofList) To UBound(tlSofList) - 1
                                    If tlSofList(ilTemp).iMnfSSCode = tmClf.iVefCode Then
                                        tlSofList(ilTemp).iSofCode = True       'set flag to indicate at least 1 daily for this vehicle
                                        Exit For
                                    End If
                                Next ilTemp
                            End If
                            slStr = ""
                            For illoop = 0 To 6
                                slSpotCount = Trim$(str$(tmCff.iDay(illoop)))
                                Do While Len(slSpotCount) < 4
                                    slSpotCount = " " & slSpotCount
                                Loop
                                'slStr = slStr + " " + Format$(Str(tmCff.iDay(ilLoop)), "   0")  '5-20-03
                                slStr = slStr & " " & slSpotCount
                            Next illoop
                        End If
                        slValidDays = ""
                        slValidDays = slStr
                        For illoop = 0 To 6                 'init all days to not airing, setup for research results later
                            ilInputDays(illoop) = False
                            ilDemoAvgAudDays(illoop) = False        'initalize to 0
                        Next illoop
                        ilFoundLine = False
                        'ilManyFlts = False
                        For ilLineSpotsInx = 1 To ilLineRate - 1 Step 1
                            If (tmLnr(ilLineSpotsInx).iLineInx = ilClf) Then            'same lines
                                '8-23-05
                                If ((lmActPrice = tmLnr(ilLineSpotsInx).lRate) And (slValidDays = tmLnr(ilLineSpotsInx).sValidDays)) Then
                                'If ((tmCff.lActPrice = tmLnr(ilLineSpotsInx).lRate) And (slValidDays = tmLnr(ilLineSpotsInx).sValidDays)) Then
                                    ilFoundLine = True
                                    'tmLnr(ilLineSpotsInx).iManyFlts = True
                                    Exit For
                                Else
                                    ilManyFlts = True
                                End If
                            End If
                        Next ilLineSpotsInx
                        'maintain ilLineSpotsInx (if found) so that we can get back to the data in that entry
                        If Not ilFoundLine Then                         'create the 2 year buffer for spot counts
                            'ReDim Preserve tmLnr(1 To ilLineRate) As LNR
                            ReDim Preserve tmLnr(0 To ilLineRate) As LNR
                            'ReDim Preserve lmSpotsByWk(1 To MAXWEEKSFOR2YRS, 1 To ilLineSpots) As Long
                            ReDim Preserve lmSpotsByWk(0 To MAXWEEKSFOR2YRS, 0 To ilLineSpots) As Long
                            'ReDim Preserve lmratesbywk(1 To MAXWEEKSFOR2YRS, 1 To ilLineSpots) As Long
                            ReDim Preserve lmratesbywk(0 To MAXWEEKSFOR2YRS, 0 To ilLineSpots) As Long
                            tmLnr(ilLineRate).iLineInx = ilClf
                            tmLnr(ilLineRate).lRate = lmActPrice    '8-23-05 tmCff.lActPrice
                            'tmLnr(ilLineRate).sPriceType = tmCff.sPriceType     '2-23-01
                            tmLnr(ilLineRate).sPriceType = slPriceType          '9-21-05
                            tmLnr(ilLineRate).sValidDays = slValidDays
                            tmLnr(ilLineRate).iManyFlts = ilManyFlts            'true if more than 1 flt this sched line
                            ilLineSpotsInx = ilLineSpots            'need to get to this entry to accum spots later
                            ilLineRate = ilLineRate + 1
                            ilLineSpots = ilLineSpots + 1
                        End If
    
                        gUnpackDate tmCff.iStartDate(0), tmCff.iStartDate(1), slStr
                        llFltStart = gDateValue(slStr)
                        'backup start date to Monday
                        illoop = gWeekDayLong(llFltStart)
                        Do While illoop <> 0
                            llFltStart = llFltStart - 1
                            illoop = gWeekDayLong(llFltStart)
                        Loop
                        gUnpackDate tmCff.iEndDate(0), tmCff.iEndDate(1), slStr
                        llFltEnd = gDateValue(slStr)
                        '
                        'Loop thru the flight by week and build the number of spots for each week
                        '
    
                        For llDate2 = llFltStart To llFltEnd Step 7
                            If tmCff.sDyWk = "W" Then            'weekly
                                ilSpots = tmCff.iSpotsWk + tmCff.iXSpotsWk
                                For ilDay = 0 To 6 Step 1
                                    If (llDate2 + ilDay >= llFltStart) And (llDate2 + ilDay <= llFltEnd) Then
                                        If tmCff.iDay(ilDay) > 0 Or tmCff.sXDay(ilDay) = "1" Then
                                            ilInputDays(ilDay) = True
                                            ilDemoAvgAudDays(ilDay) = True      '11-19-02 for weekly, each day is indicated by true false as a valid airing day of week
                                        End If
                                    End If
                                Next ilDay
                            Else                                        'daily
                                If illoop + 6 < llFltEnd Then           'we have a whole week
                                    ilSpots = tmCff.iDay(0) + tmCff.iDay(1) + tmCff.iDay(2) + tmCff.iDay(3) + tmCff.iDay(4) + tmCff.iDay(5) + tmCff.iDay(6)    'got entire week
                                    For ilDay = 0 To 6 Step 1
                                        If tmCff.iDay(ilDay) > 0 Then
                                            ilInputDays(ilDay) = tmCff.iDay(ilDay)          '11-19-02 chged from true/false to # spots/day
                                            ilDemoAvgAudDays(ilDay) = True      '11-19-02 for daily, each day is indicated by # spots per day as a valid airing day
                                        End If
                                    Next ilDay
                                Else                                    'do partial week
                                    For llDate = llDate2 To llFltEnd Step 1
                                        ilDay = gWeekDayLong(llDate)
                                        ilSpots = ilSpots + tmCff.iDay(ilDay)
                                        If tmCff.iDay(ilDay) > 0 Then
                                            ilInputDays(ilDay) = tmCff.iDay(ilDay)  '11-19-02 chged from true/false to # spots/day
                                            ilDemoAvgAudDays(ilDay) = True      '11-19-02 for daily, each day is indicated by # spots per day as a valid airing day
                                        End If
                                    Next llDate
                                End If
                            End If
                            'Days of week from flight - saved to compare against daypart days for overrides
                            tmLnr(ilLineSpotsInx).sDailyWkly = tmCff.sDyWk          '5-20-03 daily  vs weekly flag
                            For illoop = 0 To 6 Step 1
                                tmLnr(ilLineSpotsInx).iCffDays(illoop) = ilInputDays(illoop)
                            Next illoop
    
                            ilWeekInx = (llDate2 - gDateValue(slStartDate)) / 7 + 1
                            If ilWeekInx > 0 And ilWeekInx < 105 Then           ' < 1, its a CBS .  3-9-06 cant exceed 2 yrs or subscript error
                                lmSpotsByWk(ilWeekInx, ilLineSpotsInx) = lmSpotsByWk(ilWeekInx, ilLineSpotsInx) + ilSpots
                                lmratesbywk(ilWeekInx, ilLineSpotsInx) = lmActPrice    '8-23-05  tmCff.lActPrice
'                                lmWklySpots(ilWeekInx - 1, ilUpperClf) = lmWklySpots(ilWeekInx - 1, ilUpperClf) + ilSpots
'                                lmWklyRates(ilWeekInx - 1, ilUpperClf) = lmActPrice '8-23-05 tmCff.lActPrice
                                '3-15-19 remove -1 from target field and source field
                                lmWklyspots(ilWeekInx, ilUpperClf) = lmWklyspots(ilWeekInx, ilUpperClf) + ilSpots
                                lmWklyRates(ilWeekInx, ilUpperClf) = lmActPrice  '8-23-05 tmCff.lActPrice
                                'Accum previous modifications $ and spot count
                                If imProcessFlag(ilClf) = 2 Or imProcessFlag(ilClf) = 3 And (tmClf.sType <> "E" And tmClf.sType <> "A" And tmClf.sType <> "O") Then    '10-7-08 only get the pop estimates for conventional& hidden lines                 '2=current line, but not on same rev, 3 = current line, same rev#
                                    llCurrModSpots = llCurrModSpots + ilSpots
                                    If tmClf.sType = "E" Then
                                        If ilSpots <> 0 Then            'insure this week has spots, dont just add in the weekly package amt
                                            llCurrMod = llCurrMod + lmActPrice  '8-23-05 tmCff.lActPrice
                                        End If
                                    Else
                                        llCurrMod = llCurrMod + (CLng(ilSpots) * lmActPrice)   '8-23-05 (ilSpots * tmCff.lActPrice)
                                    End If
                                End If
                                If ilfirstTime Then
                                    If tgSpf.sDemoEstAllowed <> "Y" Then
                                        ilfirstTime = False
                                    End If
                                    If tmClf.iStartTime(0) = 1 And tmClf.iStartTime(1) = 0 Then
                                        llOvStartTime = 0
                                        llOvEndTime = 0
                                    Else
                                        'override times exist
    
                                        gUnpackTimeLong tmClf.iStartTime(0), tmClf.iStartTime(1), False, llOvStartTime
                                        gUnpackTimeLong tmClf.iEndTime(0), tmClf.iEndTime(1), True, llOvEndTime
                                    End If
                                    '11-19-02 ilRet = gGetDemoAvgAud(hmDrf, hmMnf, hmDpf, tmClf.idnfCode, tmClf.iVefCode, 0, tgChfCT.iMnfDemo(ilDemo), tmClf.iRdfcode, llOvStartTime, llOvEndTime, ilInputdays(), llAvgAud)
                                    '11-19-02 Daily and weekly need the valid airing day, not the spots per day if daily (ilDemoAvgAudDays)
                                    ilRet = gGetDemoAvgAud(hmDrf, hmMnf, hmDpf, hmDef, hmRaf, tmClf.iDnfCode, tmClf.iVefCode, ilSocEcoMnfCode, tgChfCT.iMnfDemo(ilDemo), llDate2, llDate2, tmClf.iRdfCode, llOvStartTime, llOvEndTime, ilDemoAvgAudDays(), tmClf.sType, tmClf.lRafCode, llAvgAud, llPopEst, ilAudFromSource, llAudFromCode)
                                End If
'                                lmAvgAud(ilWeekInx - 1, ilUpperClf) = llAvgAud
'                                lmPopEst(ilWeekInx - 1, ilUpperClf) = llPopEst
'                               '3-15-19 remove the -1 from index
                                lmAvgAud(ilWeekInx, ilUpperClf) = llAvgAud
                                lmPopEst(ilWeekInx, ilUpperClf) = llPopEst
                            ElseIf ilWeekInx > 104 And (ilShowMods Or ilDiffOnly) Then
                                imDiffExceeds104Wks = True      '3-9-06 set flag to show message in header
                            End If
                        Next llDate2
                        ilCff = tgCffCT(ilCff).iNextCff               'get next flight record from mem
                    Loop                                            'while ilcff <> -1
                    'Set flag to send to Crystal for:  Multiple flights this line, or single flight this line.
                    'If multiple flights, the Research totals will go on separate total line.  If single flight,
                    'the research cpp/cpm will go on same line as spot data.
                    For ilLineSpotsInx = 1 To ilLineRate - 1 Step 1
                        If (tmLnr(ilLineSpotsInx).iLineInx = ilClf) Then            'same lines
                            tmLnr(ilLineSpotsInx).iManyFlts = ilManyFlts
                        End If
                    Next ilLineSpotsInx
                End If                                          'llFltStart >= gDateValue(slStartDate
                ilUpperClf = ilUpperClf + 1
            Next ilClf                                          'for ilclf = lbound(tmclf) to ubound(tmclf)
            
            For ilClf = 0 To UBound(tmPodcast_Info) - 1
                'type of line:  P = Podcast, K = package line, H = Podcast Hidden Line, L = Other, not podcast Hidden Line, O = other not in pkg, not poscast (conventional, selling)
                If tmPodcast_Info(ilClf).sType = "P" Then
                    tmPodcast_Info(ilClf).bShowResearch = False
                ElseIf tmPodcast_Info(ilClf).sType = "O" Then
                    tmPodcast_Info(ilClf).bShowResearch = True
                ElseIf tmPodcast_Info(ilClf).sType = "H" Then       'hidden podcast line in pkg
                    tmPodcast_Info(ilClf).bShowResearch = False
                ElseIf tmPodcast_Info(ilClf).sType = "L" Then       'other type of vehicle in package, not a podcast vehicle
                    tmPodcast_Info(ilClf).bShowResearch = True
                Else
                    If tmPodcast_Info(ilClf).sType = "K" Then       'package, loop thru all the lines to find the references to see if all podcast, mixture
                        blPodExists = False
                        blNonPodExists = False
                        For ilTemp = 0 To UBound(tmPodcast_Info) - 1
                            If ilClf <> ilTemp Then                 'ignore itself
                                If tmPodcast_Info(ilClf).iLine = tmPodcast_Info(ilTemp).iPkgRefLine Then    'test for associated hidden lines to the package
                                    If tmPodcast_Info(ilTemp).sType = "H" Then           'hidden lineis podcast
                                        blPodExists = True
                                    End If
                                    If tmPodcast_Info(ilTemp).sType = "L" Then       'hidden line is not  a podcase=t
                                        blNonPodExists = True
                                    End If
                                End If
                            End If
                        Next ilTemp
                        'set how the package line should show for research info
                        If blPodExists And blNonPodExists Then
                            tmPodcast_Info(ilClf).bShowResearch = True          'mixture of podcast and non podcast, show research for package
                        ElseIf blPodExists And Not (blNonPodExists) Then        'all podcast hidden lines
                            tmPodcast_Info(ilClf).bShowResearch = False
                        Else
                            tmPodcast_Info(ilClf).bShowResearch = True          'no podcast, show research
                        End If
                        'now set how the hidden lines should show for research info
                        For ilTemp = 0 To UBound(tmPodcast_Info) - 1
                            If tmPodcast_Info(ilTemp).sType = "H" Then       'podcast vehicle in the pkg
                                 tmPodcast_Info(ilTemp).bShowResearch = False
                             ElseIf tmPodcast_Info(ilTemp).sType = "L" Then
                                 tmPodcast_Info(ilTemp).bShowResearch = True
'                                If blPodExists And blNonPodExists Then
'                                    tmPodcast_Info(ilTemp).bShowResearch = True          'mixture of podcast and non podcast, show research for package
'                                ElseIf blPodExists And Not (blNonPodExists) Then        'all podcast hidden lines
'                                    tmPodcast_Info(ilTemp).bShowResearch = False
'                                Else
'                                    tmPodcast_Info(ilTemp).bShowResearch = True          'no podcast, show research
                             End If
                        Next ilTemp
                    End If
                End If
            Next ilClf
            
            
            blPodExists = False
            blNonPodExists = False
            'determine if any podcast hidden lines within package, whether research header titles should be shown or not.
            'if all podcast within package, do not show research.  If mixed podcast and non-podcast, show them all so the research info
            'type of line:  P = Podcast, K = package line, H = Podcast Hidden Line, L = Other, not podcast Hidden Line, O = other, not poscast (conventional, selling)
            For ilClf = 0 To UBound(tmPodcast_Info) - 1
                If tmPodcast_Info(ilClf).sType = "P" Or tmPodcast_Info(ilClf).sType = "H" Then      'std line that is podcast, or hidden line that is podcast
                    blPodExists = True
                ElseIf tmPodcast_Info(ilClf).sType <> "K" Then          'ignore package lines to determine if showing column header
                    blNonPodExists = True
                End If
            Next ilClf
            If blPodExists And blNonPodExists Then
                tmCbf.sRschColHdr = ""          'mixture of podcast and non podcast, blnak indicates to show research hdr
            ElseIf blPodExists And Not (blNonPodExists) Then        'all podcast hidden lines, do not show research hdr
                tmCbf.sRschColHdr = "H"                                  'hide research hdr column
            Else
                tmCbf.sRschColHdr = ""           'no podcast, show research (blank indicates to show research hdr)
            End If
            
            
            'create CBF record from contract just gathered
            '11-23-99
            If tgSpf.sDemoEstAllowed <> "Y" Then
                For illoop = LBound(lmPop) To UBound(lmPop) - 1
                    If lmPop(illoop) < 0 Then       'neg was to indicate there was different
                                    'books/pop across vehicles.  Use 0 pop for TotalResearch
                        lmPop(illoop) = 0
                    End If
                Next illoop
            End If
    
            'tmCbf.iGenTime(0) = igNowTime(0)
            'tmCbf.iGenTime(1) = igNowTime(1)
            'gUnpackTimeLong igNowTime(0), igNowTime(1), False, lgNowTime       '9-14-09 lgnowtime has been converted to milliseconds in rptvfy module
            '9-14-09 help prevent multiple users generating at exact same time
        
'            tmCbf.lGenTime = lgNowTime
'            tmCbf.iGenDate(0) = igNowDate(0)
'            tmCbf.iGenDate(1) = igNowDate(1)
'            tmCbf.lChfCode = tgChfCT.lCode                'contract internal code
            tmCbf.lCxfComment = 0               'comment code from Site for either BR or Insertion Orders
            'tmCbf.sDailyExists = slDailyExists      '5-21-03  at least one day line exists flag (Y/N)
            If ilListIndex = CNT_INSERTION Then
                'If tgSpf.lCxfInsertComment > 2 Then         '2-12-03 comments to show on all Insrtion order
                If tgSpf.lCxfInsertComment > 0 Then         '9-17-12 comments to show on all Insrtion order, dont know why it was testing code > 2
                   tmCbf.lCxfComment = tgSpf.lCxfInsertComment
                End If
            Else
                tmCbf.sDailyExists = slDailyExists      '5-21-03  at least one day line exists flag (Y/N)
                'If tgSpf.lCxfContrComment > 2 Then         '2-12-03 comments to show on all printed contrcts
                If tgSpf.lCxfContrComment > 0 Then         '9-17-12 comments to show on all printed contrcts, dont know why it was testing code > 2
    
                    tmCbf.lCxfComment = tgSpf.lCxfContrComment
                End If
            End If
    
            If ilTotalWks > 0 Then
                tmCbf.iTotalWks = ilRealTotalWks            'overall contract span in weeks
            End If
            If ilThisCntMod Then
                tmCbf.iTotalWks = ilCurrTotalWks        'differences only, use the Totl weeks determined from gGenDiff rtn from
                                                        'the current revision
            End If
    
            tmCbf.iExtra2Byte = 0                   'flag to include for Detail version only, ignore other types
            tmCbf.lExtra4Byte = 0                   'if corp summary totals, set flag to place legend on summart page
            tmCbf.iAffMktCode = -1                  '2-21-18 init mkt code for station market code reference (-1 = dont show mkt name, ignore; 0 = use vehicle group market name from vehicle; non zero = use affiliate mkt name
            tmCbf.lPop = 0                          '2-27-18 This is NOT population, field used to point to CLF to retrieve the Act1 Line Up code
            'Year and month is concatenated in the long field - Crystal uses to print out quarter headings on summary page
            'get start month of the contract start date
            slStr = Format$(llStdStartDates(1) + 15, "m/d/yy")
            gObtainYearMonthDayStr slStr, True, slYear, slMonth, slDay
            'xxxx = year, + x = start qtr + x = corp or std flag  (0 =std, 1= corp)
            ilTemp = Val(slMonth)
            If ilTemp < ilStartMonth Then
                ilTemp = ilTemp + 12
            End If
    
            'ilTemp-ilstartMonth/3+1 gets the starting qtr for the corp or std year based on the first qtr to be shown
            tmCbf.lExtra4Byte = (CLng(ilCorpStdYear) * 100) + (((ilTemp - ilStartMonth) / 3 + 1) * 10)
'           If Not ilShowStdQtr Then
            If ilShowStdQtr = 2 Then            '12-19-20  for BR legend output
                tmCbf.lExtra4Byte = tmCbf.lExtra4Byte + 1
            End If
            tmCbf.iDnfCode = tgChfCT.iMnfDemo(ilDemo)   '4-30-14 need demo code, not the index      'ilDemo  demo version xx of possible 4
            'Setup % of budget for our station
            For illoop = 0 To 6 Step 1
                If ilCmpny = tgChfCT.iMnfCmpy(illoop) Then
                    tmCbf.iOurShare = tgChfCT.iCmpyPct(illoop)
                End If
            Next illoop
            'setup comment fields only if to be shown on contract.  Update record with
            'the comment pointer if it should be shown, else leave it 0
            '
            mGetComment tmCbf.lOtherComment, tgChfCT.lCxfCode
            mGetComment tmCbf.lCancComment, tgChfCT.lCxfCanc
            If tgChfCT.iExtRevNo > 0 Then                     'print cance, merch & promo clause on props & orders, not on revisions
                tmCbf.lMerchComment = 0
                tmCbf.lPromoComment = 0
                mGetComment tmCbf.lChgRComment, tgChfCT.lCxfChgR  'print mod reasons on all changes
            Else
                'mGetComment tmCbf.lCancComment, tgChfCt.lcxfCanc
                mGetComment tmCbf.lMerchComment, tgChfCT.lCxfMerch
                mGetComment tmCbf.lPromoComment, tgChfCT.lCxfProm
                tmCbf.lChgRComment = 0
            End If
    
            'put in the calculated taxes (if applicable) into the prepass record
            tmCbf.lTax1 = llTax1CalcAmt
            tmCbf.lTax2 = llTax2CalcAmt
            For illoop = 1 To 36
                tmCbf.lTax1 = tmCbf.lTax1 + llProjectedTax1(illoop)
                tmCbf.lTax2 = tmCbf.lTax2 + llProjectedTax2(illoop)
            Next illoop
    
            'Obtain all the books used for this contract, string out the demoresearch names
            'if there are multiple books, precede the description with an *.  Crystal report
            'will test for this flag and specify book name as "See Summary".  Then on the summary
            'page, the book name will be extracted from the line data and shown next to the line summary.
            '
            slSurvey = ""
            tmCbf.sSurvey = ""
            If RptSelCt!ckcSelC6(1).Value = vbChecked Then              'research requsted, show survey in headr
                For illoop = LBound(imDnfCodes) To ilUpperDnf - 1 Step 1
                    If imDnfCodes(illoop) > 0 Then
                        tmDnfSrchKey.iCode = imDnfCodes(illoop)
                        ilRet = btrGetEqual(hmDnf, tmDnf, imDnfRecLen, tmDnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                        If ilRet <> BTRV_ERR_NONE Then
                            tmDnf.sBookName = " "
                        End If
                        If slSurvey = "" Then
                            slSurvey = RTrim$(tmDnf.sBookName)
                        Else
                            slSurvey = slSurvey & ", " & RTrim$(tmDnf.sBookName)
                        End If
                    End If
                Next illoop
                If ilUpperDnf > 1 Then
                    tmCbf.sSurvey = "*"     '& slSurvey      'flag to denote multiple book names
                Else
                    tmCbf.sSurvey = slSurvey
                End If
            End If
    
            mDemoDesc ilDemo                                'format demo description string
            'mSetupBrHdr                                     'build the advt, agy, slsp and sort fields specs that ned to be built
            '                                                'only once per contract
            If ilThisCntMod Then                            'differences option for this cnt (either printables & show all mods as diff,
                                                            'or requesting diff only on selective cnt)
                tmCbf.lCurrModSpots = llPrevSpots            'total spot count for the previous version - used for differences option
                tmCbf.lCurrMod = llPrevGross                 'total $ for the previous version - used for differences option
            Else
                tmCbf.lCurrModSpots = llCurrModSpots            'total spot count for the current version - used for differences option
                tmCbf.lCurrMod = llCurrMod                      'total $ for the current version - used for differences option
            End If
            tmCbf.iTotalMonths = ilCurrTotalMonths          'total airing months of this order
            tmCbf.iStartQtr(0) = ilCurrStartQtr(0)              'start month of current qtr
            tmCbf.iStartQtr(1) = ilCurrStartQtr(1)
            'Calculate total number of actual airing weeks
            'first go thru and find unique airing weeks, then go accum those
            'unique airing weeks
            'i.e.  The contract may have a 52 week start & end date span, but only air
            'every other week.  The report will show 26/52 (26 airing weeks across 52 week span)
            Erase imAirWks                                      'initialize true airing weeks for this cnt
    
    
            For illoop = 1 To ilLineRate - 1 Step 1             'loop for # of lines gathered, there may be more than
                                                                'one entry for a line due to different rates in the flights for a line
                'first decide which lines gathered shouldbe included to calc the actual number of weeks airing.  If modification option,
                'all history lines have been gathered
                ilLoop3 = tmLnr(illoop).iLineInx
                If imProcessFlag(ilLoop3) = 2 Or imProcessFlag(ilLoop3) = 3 Then      'flags 2 = current line, dont show line but process for flights,
                                                                    'flag 3 = current line, show on Br and process for flight
                    For ilDay = 1 To MAXWEEKSFOR2YRS Step 1                     'loop for the line entry for 2 yrs (104 wks)
                        If lmSpotsByWk(ilDay, illoop) <> 0 Then
                            imAirWks(ilDay) = 1
                        End If
                    Next ilDay
                ElseIf imProcessFlag(ilLoop3) = 1 Then          'from previous revsion, gather $ and spot count
                    For ilDay = 1 To MAXWEEKSFOR2YRS Step 1                     'loop for the line entry for 2 yrs (104 wks)
                        If lmSpotsByWk(ilDay, illoop) <> 0 Then          'valid airing week
    
                        End If
                    Next ilDay
                End If
            Next illoop                                         'go to next line entry
            tmCbf.iAirWks = 0
            For illoop = 1 To MAXWEEKSFOR2YRS
                If imAirWks(illoop) > 0 Then
                    tmCbf.iAirWks = tmCbf.iAirWks + 1
                End If
            Next illoop
            If ilThisCntMod Then
                tmCbf.iAirWks = ilCurrAirWks        'differences only, use the airing weeks determined from gGenDiff rtn from
                                                    'the current revision
            End If
            'Cycle through all the line records built (some lines may have multiples records due to
            'different flights for the same line.  Calculate total GRIMPs to place in each record so
            'that the % Distribution can be calculated in Crystal.
            'Need to do this in a single prepass because the overall Grimps need to be stored in each qtr's recd
            'Get Research data for individual lines by unique rates
            llCntGrimps = 0
            For illoop = 1 To ilLineSpots - 1
                If imProcessFlag(tmLnr(illoop).iLineInx) = 1 Or imProcessFlag(tmLnr(illoop).iLineInx) = 3 Or imProcessFlag(tmLnr(illoop).iLineInx) = 4 Then  'show current and prev lines depending
                    ilLoop3 = tmLnr(illoop).iLineInx            'line index to process
                    tmClf = tgClfCT(ilLoop3).ClfRec
                    '4-11-19 change to long index due to subscript out of range
                    tmLnr(illoop).lLRchInx = UBound(tmLRch)     'index to start of this lines 8 quarters - When differences
                                                                'report is run, lines are built in LNR and not shown on BR,
                                                                'so this is index to where the Research data exists for this line
                    ilSavePkVeh = 0                             'init in case its not a hidden line
                    If tmClf.sType = "H" Then                   'hidden line, find assoc. pkg vehicle
                        For ilPkg = 0 To UBound(tgClfCT) - 1 Step 1
                            If tmClf.iPkLineNo = tgClfCT(ilPkg).ClfRec.iLine Then    'find the assoc pkg vehicle name
                                ilSavePkVeh = tgClfCT(ilPkg).ClfRec.iVefCode
                                Exit For
                            End If
                        Next ilPkg
                    ElseIf tmClf.sType = "E" Or tmClf.sType = "O" Or tmClf.sType = "A" Then     'package
                        mGetUniquePkgVehPop ilVehList()      'update the package vehicles population from all the hidden lines for unique pkg vehicles
    
                    End If
                    'find the vehicle and associated population
                    llPop = 0
                    For ilVehicle = LBound(ilVehList) To UBound(ilVehList) - 1 Step 1
                        If tmClf.iVefCode = ilVehList(ilVehicle) Then
                            'llpop = lmPop(ilVehicle)
                            llPop = llPopByLine(ilLoop3 + 1)      '11-23-99
                            Exit For
                        End If
                    Next ilVehicle
                    
                    '4-10-19 replace with Long due to subscript out of range
                    'replace ilQtr with llLoopOnQtr
                    'replace ilTemp with llTempLRch
                    'replace ilRchQtr with llRchQtr
                    llRchQtr = 0            '11-14-11
                    For llLoopOnQtr = 1 To 8 Step 1             'retain 8  max quarters here
    'ilRchQtr = (ilQtr - 1) * 13         'index to source array (moving from)
    
                        llTempLRch = UBound(tmLRch)
                        tmLRch(llTempLRch).lQSpots = 0
    'For ilSpots = 1 To 13
                        For ilSpots = 1 To imWeeksPerQtr(llLoopOnQtr)
                            tmLRch(llTempLRch).lSpots(ilSpots - 1) = lmSpotsByWk(llRchQtr + ilSpots, illoop)
                            tmLRch(llTempLRch).lQSpots = tmLRch(llTempLRch).lQSpots + tmLRch(llTempLRch).lSpots(ilSpots - 1)
'                            tmLRch(ilTemp).lRates(ilSpots - 1) = lmWklyRates(ilRchQtr + ilSpots - 1, ilLoop3)
'                            tmLRch(ilTemp).lAvgAud(ilSpots - 1) = lmAvgAud(ilRchQtr + ilSpots - 1, ilLoop3)
'                            tmLRch(ilTemp).lPopEst(ilSpots - 1) = lmPopEst(ilRchQtr + ilSpots - 1, ilLoop3)
                            '3-15-19 remove -1 from source field
                            tmLRch(llTempLRch).lRates(ilSpots - 1) = lmWklyRates(llRchQtr + ilSpots, ilLoop3)
                            tmLRch(llTempLRch).lAvgAud(ilSpots - 1) = lmAvgAud(llRchQtr + ilSpots, ilLoop3)
                            tmLRch(llTempLRch).lPopEst(ilSpots - 1) = lmPopEst(llRchQtr + ilSpots, ilLoop3)

                        Next ilSpots
                        mBuildLRch tmLRch(), llTempLRch, ilSavePkVeh, llCntGrimps, llPop        '4-10-19 remove ilLoopOnQtr parameter
    
                        'mBuildLRch tmLRch(), ilTemp, ilSavePkVeh, llCntGrimps, lmPop(ilLoop3)
                        llRchQtr = llRchQtr + imWeeksPerQtr(llLoopOnQtr)
                    Next llLoopOnQtr
                End If
            Next illoop

            '6-1-04 Need to get average pop estimates for each line for all the quarterly calc if Demo Estimates allowed
            llOverallPopEst = -1
            If tgSpf.sDemoEstAllowed = "Y" Then
                For illoop = 1 To ilLineSpots - 1
                    If imProcessFlag(tmLnr(illoop).iLineInx) = 1 Or imProcessFlag(tmLnr(illoop).iLineInx) = 3 Or imProcessFlag(tmLnr(illoop).iLineInx) = 4 Then  'show current and prev lines depending
                        ilLoop3 = tmLnr(illoop).iLineInx            'line index to process
                                                                    'on the option selected.  Mods show current & prev, Full BR shows curent only
                                                                    'Move spots, $ and aud to single dimension array for gAvgAudToLnResearch routine
                        tmClf = tgClfCT(ilLoop3).ClfRec
                        If tmClf.sType <> "E" And tmClf.sType <> "A" And tmClf.sType <> "O" Then    'only get the pop estimates for conventional& hidden lines
    
                            For ilSpots = 1 To MAXWEEKSFOR2YRS
                                llWklyspots(ilSpots - 1) = lmSpotsByWk(ilSpots, illoop)
'                                llWklyRates(ilSpots - 1) = lmWklyRates(ilSpots - 1, ilLoop3)
'                                llWklyAvgAud(ilSpots - 1) = lmAvgAud(ilSpots - 1, ilLoop3)
'                                llWklyPopEst(ilSpots - 1) = lmPopEst(ilSpots - 1, ilLoop3)
                                '3-15-19 remove -1 from source field
                                llWklyRates(ilSpots - 1) = lmWklyRates(ilSpots, ilLoop3)
                                llWklyAvgAud(ilSpots - 1) = lmAvgAud(ilSpots, ilLoop3)
                                llWklyPopEst(ilSpots - 1) = lmPopEst(ilSpots, ilLoop3)
                            Next ilSpots
                            'gAvgAudToLnResearch sm1or2PlaceRating, True, llPop, llWklyPopEst(), llWklyspots(), llWklyRates(), llWklyAvgAud(), llTemp, tmCbf.lAvgAud, ilWklyRtg(), tmCbf.iAvgRate, llWklyGrimp(), tmCbf.lGrImp, llWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, llPopEst
                            gAvgAudToLnResearch sm1or2PlaceRating, True, llPop, llWklyPopEst(), llWklyspots(), llWklyRates(), llWklyAvgAud(), dlTemp, tmCbf.lAvgAud, ilWklyRtg(), tmCbf.iAvgRate, llWklyGrimp(), tmCbf.lGrImp, llWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, llPopEst 'TTP 10439 - Rerate 21,000,000
    
                            If llOverallPopEst = -1 Then      '6-1-04
                                llOverallPopEst = llPopEst
                            Else
                                If llOverallPopEst <> llPopEst And llOverallPopEst <> 0 Then
                                    llOverallPopEst = 0
                                End If
                            End If
                        End If                      'tmclf.stype
                    End If                          'imProcessFlag(tmLnr(ilLoop).iLineInx) = 1
                Next illoop
            End If

            mGetPopPkgByLine ilPkgLineList(), llPopByLine()      '11-11-05 update the pkg vehicles by line # (reqd if more than 1 line for the same package vehicle)
    
            'For Packages Only........
            'Create array of grps, weekly rating, grimps and rates to pass to routine to generate qtrly totals for individual
            'line packages.  (combination of all hidden lines for 1 package line)
            mBRPkgQtrTotals ilPkgLineList(), ilVehList(), ilPkgVehList()
            'Create array of grps, wkly rating, grimps and rates to pass to routine to generate qtrly totals for all vehicles (detail version)
            'Store the qtr totals in all detail records - it's the only way to get the accurate figures
            ReDim tmQGRP(0 To 0) As Long
            ReDim tmQCPP(0 To 0) As Long
            ReDim tmQCPM(0 To 0) As Long
            ReDim tmQGrimp(0 To 0) As Long
            llPop = -1                          '6-1-04
            For llLoopOnQtr = 1 To imMaxQtrs Step 1
                ReDim tmVRtg(0 To 0) As Integer
                ReDim tmVCost(0 To 0) As Long
                ReDim tmVGRP(0 To 0) As Long
                ReDim tmVGrimp(0 To 0) As Long
                '3/13/04- moved llLnSpots = 0 here
                llLnSpots = 0
                If tgSpf.sDemoEstAllowed = "Y" Then     '6-1-04
                    llResearchPop = -1
                End If
                For llRchQtr = llLoopOnQtr To UBound(tmLRch) - 1 Step 8
                    'bypass the Package lines, the quarterly totals will be obtained from the individual hidden lines because
                    'each package line can contain the same data repeated in each flight.  Exclude package lines to avoid
                    'duplicating results.
    '                    llLnSpots = 0
                    If (tmLRch(llRchQtr).sType <> "A" And tmLRch(llRchQtr).sType <> "O" And tmLRch(ilRchQtr).sType <> "E") Then    'not a package of any kind
                        If (tmLRch(llRchQtr).lQSpots <> 0) Then 'And (tmLRch(llRchQtr).lTotalGrimps <> 0) Then            'only process if spots exist in the qtr
                            llLnSpots = llLnSpots + tmLRch(llRchQtr).lQSpots
                            If llResearchPop = -1 Then      '6-1-04
                                llResearchPop = tmLRch(llRchQtr).lSatelliteEst
                            Else
                                '9-27-04 ignore if satelliteest is 0, dont count as different pop
                                If (llResearchPop <> tmLRch(llRchQtr).lSatelliteEst And tmLRch(llRchQtr).lSatelliteEst <> 0) And llResearchPop <> 0 Then
                                    llResearchPop = 0
                                End If
                            End If
    
                            tmVRtg(UBound(tmVRtg)) = tmLRch(llRchQtr).iTotalAvgRating
                            tmVCost(UBound(tmVCost)) = tmLRch(llRchQtr).dTotalCost 'TTP 10439 - Rerate 21,000,000
                            tmVGRP(UBound(tmVGRP)) = tmLRch(llRchQtr).lTotalGRP
                            tmVGrimp(UBound(tmVGrimp)) = tmLRch(llRchQtr).lTotalGrimps
                            ReDim Preserve tmVRtg(0 To UBound(tmVRtg) + 1) As Integer
                            ReDim Preserve tmVCost(0 To UBound(tmVCost) + 1) As Long
                            ReDim Preserve tmVGRP(0 To UBound(tmVGRP) + 1) As Long
                            ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) + 1) As Long
                        End If
                    End If
                Next llRchQtr
                'If UBound(tmVRtg) > 1 Then
                If UBound(tmVRtg) > LBound(tmVRtg) Then
                    'dimensions must be exact sizes
                    ReDim Preserve tmVRtg(0 To UBound(tmVRtg) - 1) As Integer
                    ReDim Preserve tmVCost(0 To UBound(tmVCost) - 1) As Long
                    ReDim Preserve tmVGRP(0 To UBound(tmVGRP) - 1) As Long
                    ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) - 1) As Long
                    'gResearchTotals True, llResearchPop, tmVCost(), tmVRtg(), tmVGrimp(), tmVGRP(), llTemp, tmCbf.iAvgRate, tmQGrimp(UBound(tmQGrimp)), tmQGRP(UBound(tmQGRP)), tmQCPP(UBound(tmQCPP)), tmQCPM(UBound(tmQCPM))
                    '4/7/99
                    'gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, llTemp, tmCbf.iAvgRate, tmQGrimp(UBound(tmQGrimp)), tmQGRP(UBound(tmQGRP)), tmQCPP(UBound(tmQCPP)), tmQCPM(UBound(tmQCPM)), tmCbf.lAvgAud
                    gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, dlTemp, tmCbf.iAvgRate, tmQGrimp(UBound(tmQGrimp)), tmQGRP(UBound(tmQGRP)), tmQCPP(UBound(tmQCPP)), tmQCPM(UBound(tmQCPM)), tmCbf.lAvgAud
                End If
                ReDim Preserve tmQGRP(0 To UBound(tmQGRP) + 1) As Long
                ReDim Preserve tmQCPP(0 To UBound(tmQCPP) + 1) As Long
                ReDim Preserve tmQCPM(0 To UBound(tmQCPM) + 1) As Long
                ReDim Preserve tmQGrimp(0 To UBound(tmQGrimp) + 1) As Long
            Next llLoopOnQtr
            '8 Quarter research totals are stored in tmVRtg, tmVCost, tmVGRP and tmVGrimp to store in each detail record
            'ReDim tmWkCntGrps(1 To 1) As WEEKLYGRPS
            ReDim tmWkCntGrps(0 To 0) As WEEKLYGRPS
    
            If tgSpf.sDemoEstAllowed = "Y" Then     '6-1-04
                mGetCntWkGrps llOverallPopEst
            Else
                mGetCntWkGrps llResearchPop   '2-10-00
            End If
            'Create array of grps, wkly rating, grimps and rates to pass to routine to generate qtrly unique vehicle totals  (detail version)
            'Store the qtr totals in all detail records - it's the only way to get the accurate figures
            'ReDim tmVehQtrList(1 To 1) As VEHQTRLIST
            ReDim tmVehQtrList(0 To 0) As VEHQTRLIST
            '4-10-19 replace ilQtr with llLoopOnQtr
            For ilVehicle = LBound(ilVehList) To UBound(ilVehList) - 1 Step 1
                llPop = lmPop(ilVehicle)            '11-23'99??     'associated vehicles pop
                For llLoopOnQtr = 1 To imMaxQtrs Step 1
                    ReDim tmVRtg(0 To 0) As Integer
                    ReDim tmVCost(0 To 0) As Long
                    ReDim tmVGRP(0 To 0) As Long
                    ReDim tmVGrimp(0 To 0) As Long
    
                    'get each vehicle for a quarter at a time (detail option)
                    '3/13/04- moved llLnSpots = 0 here
                    llLnSpots = 0
                    If tgSpf.sDemoEstAllowed = "Y" Then     '6-1-04
                        llResearchPop = -1
                    End If
                    For llRchQtr = llLoopOnQtr To UBound(tmLRch) - 1 Step 8
    '                        llLnSpots = 0
                        If tmLRch(llRchQtr).sType <> "H" Then    '6-6-00 not a package of any kind
                            If tmLRch(llRchQtr).lQSpots <> 0 And tmLRch(llRchQtr).iVefCode = ilVehList(ilVehicle) Then
                                llLnSpots = llLnSpots + tmLRch(llRchQtr).lQSpots
                                If llPop = -1 Then      '6-1-04
                                    llPop = tmLRch(llRchQtr).lSatelliteEst
                                Else
                                    If llPop <> tmLRch(llRchQtr).lSatelliteEst And llPop <> 0 Then
                                        llPop = 0
                                    End If
                                End If
    
                                tmVRtg(UBound(tmVRtg)) = tmLRch(llRchQtr).iTotalAvgRating
                                tmVCost(UBound(tmVCost)) = tmLRch(llRchQtr).dTotalCost 'TTP 10439 - Rerate 21,000,000
                                tmVGRP(UBound(tmVGRP)) = tmLRch(llRchQtr).lTotalGRP
                                tmVGrimp(UBound(tmVGrimp)) = tmLRch(llRchQtr).lTotalGrimps
                                ReDim Preserve tmVRtg(0 To UBound(tmVRtg) + 1) As Integer
                                ReDim Preserve tmVCost(0 To UBound(tmVCost) + 1) As Long
                                ReDim Preserve tmVGRP(0 To UBound(tmVGRP) + 1) As Long
                                ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) + 1) As Long
                            End If
                        End If
                    Next llRchQtr
    
                    'If UBound(tmVRtg) > 1 Then
                    If UBound(tmVRtg) > LBound(tmVRtg) Then
                        'dimensions must be exact sizes
                        ReDim Preserve tmVRtg(0 To UBound(tmVRtg) - 1) As Integer
                        ReDim Preserve tmVCost(0 To UBound(tmVCost) - 1) As Long
                        ReDim Preserve tmVGRP(0 To UBound(tmVGRP) - 1) As Long
                        ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) - 1) As Long
                        'gResearchTotals True, llPop, tmVCost(), tmVRtg(), tmVGrimp(), tmVGRP(), llTemp, tmCbf.iAvgRate, tmCbf.lVQGrimp, tmCbf.lVQGRP, tmCbf.lVQCPP, tmCbf.lVQCPM
                        '4/7/99
                        'gResearchTotals sm1or2PlaceRating, True, llPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, llTemp, tmCbf.iAvgRate, tmCbf.lVQGrimp, tmCbf.lVQGRP, tmCbf.lVQCPP, tmCbf.lVQCPM, tmCbf.lAvgAud
                        gResearchTotals sm1or2PlaceRating, True, llPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, dlTemp, tmCbf.iAvgRate, tmCbf.lVQGrimp, tmCbf.lVQGRP, tmCbf.lVQCPP, tmCbf.lVQCPM, tmCbf.lAvgAud 'TTP 10439 - Rerate 21,000,000
                        tmVehQtrList(ilVehicle).lVQGrimp(llLoopOnQtr) = tmCbf.lVQGrimp
                        tmVehQtrList(ilVehicle).lVQGRP(llLoopOnQtr) = tmCbf.lVQGRP
                        tmVehQtrList(ilVehicle).lVQCPP(llLoopOnQtr) = tmCbf.lVQCPP
                        tmVehQtrList(ilVehicle).lVQCPM(llLoopOnQtr) = tmCbf.lVQCPM
                    End If
                Next llLoopOnQtr
                'ReDim Preserve tmVehQtrList(1 To UBound(tmVehQtrList) + 1) As VEHQTRLIST
                ReDim Preserve tmVehQtrList(0 To UBound(tmVehQtrList) + 1) As VEHQTRLIST
            Next ilVehicle
            '8 Quarter research totals are stored in tmVRtg, tmVCost, tmVGRP and tmVGrimp to store in each detail record
    
            If tgSpf.sDemoEstAllowed = "Y" Then
                mGetCntWkVGrps llOverallPopEst, ilVehList()  '2-11-00
                mGetHiddenWkVGrps llOverallPopEst, ilVehList(), ilPkgLineList() '1-24-03
            Else
                mGetCntWkVGrps llResearchPop, ilVehList()  '2-11-00
                mGetHiddenWkVGrps llResearchPop, ilVehList(), ilPkgLineList() '1-24-03
            End If
            'Obtain package totals by line
            '2-20-00
            mBRPkgVehTotals ilPkgLineList(), ilVehList(), ilPkgVehList()
    
            'Create the CBF quarterly records for as many lines as there are
            'improcessflag = 4 are the hidden lines to packages.  Show them for proof.
            For illoop = 1 To ilLineSpots - 1
                If imProcessFlag(tmLnr(illoop).iLineInx) = 1 Or imProcessFlag(tmLnr(illoop).iLineInx) = 3 Or imProcessFlag(tmLnr(illoop).iLineInx) = 4 Then  'show current and prev lines depending
                'If imProcessFlag(tmLnr(ilLoop).iLineInx) = 3 Or imProcessFlag(tmLnr(ilLoop).iLineInx) = 4 Then   'show current and prev lines depending
                    ilLoop3 = tmLnr(illoop).iLineInx            'line index to process
                    tmClf = tgClfCT(ilLoop3).ClfRec
    
                    ilFoundVeh = True
                    'If Insertion orders only use standard/hidden lines, exclude all types of packages
'                    If (ilListIndex = CNT_INSERTION) And (tmClf.sType <> "S" And tmClf.sType <> "H") Then
'                        ilFoundVeh = False
'                    End If
'                    If (ilListIndex = CNT_INSERTION) Then
'                        ilFoundVeh = False
'                        For ilVehicle = 0 To UBound(imSelectedVehicles) - 1 Step 1
'                            If imSelectedVehicles(ilVehicle) = tmClf.iVefCode Then
'                                ilFoundVeh = True
'                                Exit For
'                            End If
'                        Next ilVehicle
'                    End If

                    If ilListIndex = CNT_INSERTION Then
                        blSelectedVehicle = mTestVehicleList(ilListIndex)
                        ilFoundVeh = blSelectedVehicle
                    End If
                    'include line if proof or not proof and not hidden line and not Insertion Orders,
                    'or its insertion order and a hidden line
                    'If (RptSelCt!ckcSelC6(2).Value = vbChecked) Or (Not RptSelCt!ckcSelC6(2).Value = vbChecked And tmClf.sType <> "H" And ilListIndex <> CNT_INSERTION) Or ((ilListIndex = CNT_INSERTION) And (tmClf.sType = "S" Or tmClf.sType = "H") And (ilFoundVeh)) Then
                    'tests for Insertion order and vehicles made in subroutine; take out the extra testing
                    'If (RptSelCt!ckcSelC6(2).Value = vbChecked) Or ilFoundVeh Then
                    
                    '8410 - allow Install Contracts to be processed here
                    'If (RptSelCt!ckcSelC6(2).Value = vbChecked) Or (Not RptSelCt!ckcSelC6(2).Value = vbChecked And tmClf.sType <> "H" And ilListIndex <> CNT_INSERTION) Or ((ilListIndex = CNT_INSERTION) And (tmClf.sType = "S" Or tmClf.sType = "H") And (ilFoundVeh)) Then
                    If (RptSelCt!ckcSelC6(2).Value = vbChecked) Or (Not RptSelCt!ckcSelC6(2).Value = vbChecked And tmClf.sType <> "H" And ilListIndex <> CNT_INSERTION) Or ((ilListIndex = CNT_INSERTION) And (tmClf.sType = "S" Or tmClf.sType = "H") And (ilFoundVeh)) Or (ilListIndex <> CNT_INSERTION And tgChfCT.sInstallDefined = "Y") Then
                        'on the option selected.  Mods show current & prev, Full BR shows curent only
                        'Loop thru the array containing type of schedule lines to determine if podcast or not.
                        'if podcast vehicle, do not show avg rtg, cpp or grp column.  Show a hidden line podcast reserach
                        'info only if a mixture of podcast and non podcast vehicle
                        For ilTemp = 0 To UBound(tmPodcast_Info) - 1
                            If tmPodcast_Info(ilTemp).iLine = tmClf.iLine Then
                                If tmPodcast_Info(ilTemp).bShowResearch Then
                                    tmCbf.sMixTypes = ""                'show the research info
                                Else
                                    tmCbf.sMixTypes = "H"               'hide the research info; its podcast
                                End If
                            End If
                        Next ilTemp
                        ilGot1ToPrint = True

                        '3-28-05 tmcbf.lpop not used in printing of contract, replace
                        'with close bb len
                        'tmCbf.lPop = 0
                        'For ilVehicle = 1 To UBound(ilVehList) - 1 Step 1
                        '    If tmClf.iVefCode = ilVehList(ilVehicle) Then
                        '        tmCbf.lPop = lmPop(ilVehicle)
                        '        Exit For
                        '    End If
                        'Next ilVehicle
    
                        'If Not ilGetAll Then

                        '7-1-15 Adjust for 2 different types of records for ii
                        tmCbf.iPctDist = 0              'Pct dist field replaced by Difference flag (0=full)
                        If ilThisCntMod And ((ilListIndex = CNT_BR) Or (ilListIndex = CNT_INSERTION And ilLoopOnDiff = 1)) Then  'flag with diff indicator for crystal if BR differences or Insertion Order Diff portion
                            tmCbf.iPctDist = 1              '1 = difference only (used to print legend on BR for diff. option)
                        End If
                        tmCbf.sLineSurvey = ""
                        If tmClf.sType = "E" Or tmClf.sType = "A" Or tmClf.sType = "O" Then 'for packages, show all the books that make up the package
                                '12-19-13 Get the book references for this package line.  While processing each demo reference for this package, flag it with a -1 so not to look at it again
                                'Create a txr for each unique package vehicle to show on summary
                                slSurvey = ""
                                For ilPkgOrSpot = LBound(tlPkgVehicleForSurveyList) To UBound(tlPkgVehicleForSurveyList) - 1
                                    If tlPkgVehicleForSurveyList(ilPkgOrSpot).iPkgVefCode = tmClf.iVefCode Then 'got matching package vehicle; determine the books for all the hidden lines
                                        tmDnfSrchKey.iCode = tlPkgVehicleForSurveyList(ilPkgOrSpot).iHiddenDnfCode
                                        ilRet = btrGetEqual(hmDnf, tmDnf, imDnfRecLen, tmDnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                        If ilRet <> BTRV_ERR_NONE Then
                                            tmDnf.sBookName = " "
                                        End If
                                        If Trim$(slSurvey) = "" Then            'first time for this package
                                            slSurvey = RTrim$(tmDnf.sBookName)
                                        Else
                                            slSurvey = Trim$(slSurvey) & ", " & RTrim$(tmDnf.sBookName)
                                        End If
                                        tlPkgVehicleForSurveyList(ilPkgOrSpot).iPkgVefCode = -1         'flag processed
                                    End If
                                Next ilPkgOrSpot
                                If Trim$(slSurvey) <> "" Then
                                    tmTxr.lGenTime = lgNowTime
                                    tmTxr.iGenDate(0) = igNowDate(0)
                                    tmTxr.iGenDate(1) = igNowDate(1)
                                    tmTxr.lCsfCode = tgChfCT.lCode                'contract internal code
                                    tmTxr.lSeqNo = -1                             'distinguish this from the Split Network data that may be created into TXR
                                    tmTxr.iGeneric1 = tgChfCT.iMnfDemo(ilDemo)      '4-30-14
                                    tmTxr.iType = tmClf.iVefCode
                                    tmTxr.sText = Trim$(slSurvey)
                                    ilRet = btrInsert(hmTxr, tmTxr, Len(tmTxr), INDEXKEY0)
                                End If
    '                                Else
    '                                    tmCbf.sLineSurvey = slSurvey
    '                                End If
    '                            End If
                        Else
                            tmDnfSrchKey.iCode = tmClf.iDnfCode
                            ilRet = btrGetEqual(hmDnf, tmDnf, imDnfRecLen, tmDnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY) 'find matching advt recd
                            If ilRet = BTRV_ERR_NONE Then
                                tmCbf.sLineSurvey = tmDnf.sBookName
                            Else                                '8-17-19 no book name exists, init output field
                                tmCbf.sLineSurvey = ""
                            End If
                        End If
                        mGetComment tmCbf.lLineComment, tmClf.lCxfCode      'line comment
                        mGetPkgCommentForInsertion ilListIndex
    
                        tmCbf.lBarterCefCode = 0
                        'If ilListIndex = CNT_INSERTION And imUsingBarters Then
                        If (ilListIndex = CNT_INSERTION) And imUsingBarters And (RptSelCt!ckcSelC6(1).Value = vbUnchecked) Then     'w/research not checked
                            blAcqOK = gGetAcqCommInfoByVehicle(tmClf.iVefCode, imAcqLoInx, imAcqHiInx) 'determine the starting and ending indices of acq percents for this lines vehicle
                            gUnpackDateLong tmClf.iEndDate(0), tmClf.iEndDate(1), llDate
                            tmVbfSrchKey1.iVefCode = tmClf.iVefCode
                            tmVbfSrchKey1.iStartDate(0) = tmClf.iStartDate(0)
                            tmVbfSrchKey1.iStartDate(1) = tmClf.iStartDate(1)
                            '6-18-06 station barter comment
                            ilRet = btrGetLessOrEqual(hmVbf, tmVbf, imVBfRecLen, tmVbfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get last current record to obtain date
                            Do While ((ilRet = BTRV_ERR_NONE) And (tmVbf.iVefCode = tmClf.iVefCode) And (tmVbf.sMethod <> "I" And tmVbf.sMethod <> "N"))            '10-16-15 ignore vbfmethod for "I" (acq ind) and "N" (acq comm pct) records
                                'convert dates to test
                                gUnpackDateLong tmVbf.iStartDate(0), tmVbf.iStartDate(1), llTempStart
                                gUnpackDateLong tmVbf.iEndDate(0), tmVbf.iEndDate(1), llTempEnd
                                If llDate >= llTempStart Then          'if line end date is after the start date of the agreement, its OK
                                    tmCbf.lBarterCefCode = tmVbf.lInsertionCefCode
                                    'found the associated bater comment, save with the vehicle table when creating the special
                                    'record to link up records for the combined ntr and air time Insertion order
                                    'update when creating the vehicle in tlInsertVehList
                                    Exit Do
                                End If
                                ilRet = btrGetNext(hmVbf, tmVbf, imVBfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
                            Loop
                        End If
                        
                        tmCbf.sLineType = tmClf.sType       'in reports - if type "E", then the rate is the weekly rate, not spot rate
                        tmCbf.lIntComment = 0               'in place of internal comment code, use for hidden line reference to pkg line
                        If tmClf.sType = "H" And ilListIndex <> CNT_INSERTION Then   'hidden line, reference the line # for proof
                            tmCbf.lIntComment = tmClf.iPkLineNo
                        ElseIf tmClf.sType = "A" Or tmClf.sType = "O" Or tmClf.sType = "E" Then
                            tmCbf.lIntComment = -2                  'let crystal know its a package line. Show research totals on same line as spots
                            If (tmLnr(illoop).iManyFlts) Then
                                tmCbf.lIntComment = -1              'multiple flights for same sche line, show package research totals on "total line"
                            End If
                        End If
                        If ilDiffOnly Then                      'grimps to calculate % of distibution in Crystal
                            tmCbf.lCntGrimps = llCntGrimps - llPrevCntGrimps
                        Else
                            tmCbf.lCntGrimps = llCntGrimps          'cnt total grimps so % distribution can be obtained in Crystal
                        End If
                        slStr = slStartDate                     'don't destroy start date of this order
                        gUnpackDate tmClf.iStartDate(0), tmClf.iStartDate(1), slNameCode
                        gUnpackDate tmClf.iEndDate(0), tmClf.iEndDate(1), slCode
                        'test for cancel before start which is always start date one day later that end date
                        'This is code to fix up schedule lines that had bad start & end dates in them.  They didnt coincide with the flights or header
                        If ((gDateValue(slNameCode) - gDateValue(slCode)) <> 1) Then      'not cancel before start
                            If gDateValue(slNameCode) < llChfStart Or gDateValue(slNameCode) > llChfEnd Then
                                slNameCode = Format$(llChfStart, "m/d/yy")
                            End If
                            If gDateValue(slCode) < llChfStart Or gDateValue(slCode) > llChfEnd Then
                                slCode = Format$(llChfEnd, "m/d/yy")
                            End If
                        End If
                        '7-8-05 determine if using solo avails, 1st position and preferred days & times
                        tmCbf.s1stPosition = "N"
                        tmCbf.sSoloAvail = "N"
                        tmCbf.sPrefDT = ""
                        If (Asc(tmClf.sOV2DefinedBits) And &H4) = &H4 Then  '1St pos.
                            If tmClf.iPosition > 0 Then
                                tmCbf.s1stPosition = "Y"
                            End If
                        End If
                        If tmClf.sSoloAvail = "Y" Then          'solo avails
                            tmCbf.sSoloAvail = "Y"
                        End If
                        
                        '1-10-14 Audio type from line override
                        If ((Asc(tgSaf(0).sFeatures1) And SHOWAUDIOTYPEONBR) = SHOWAUDIOTYPEONBR) Then      'yes, show audio type on lines
                            tmCbf.sAudioType = tmClf.sLiveCopy
                        Else
                           tmCbf.sAudioType = ""
                        End If
    
                        'Handle the Cancel Before Start case- where contract end date is prior to contract start date or the dates
                        'are all zero
                        tmCbf.sWeeksInQtr = "3"             '11-14-11 default to 13 week qtr
                        If gDateValue(slEndDate) < gDateValue(slStartDate) Or (gDateValue(slStartDate) = 0 And gDateValue(slEndDate) = 0) Then             'test for cancel before start
                            gPackDate slStr, tmCbf.iDtFrstBkt(0), tmCbf.iDtFrstBkt(1)
                            'ilLoop3 = tmLnr(ilLoop).iLineInx
                            tmCbf.iTotalWks = 0
                            If tmClf.sHideCBS <> "Y" Then
                                mShowCBS ilListIndex, tlSofList(), slDailyExists       '2-24-06, format the CBS line
                                '2-24-06 If this line is the last line to print for the quarter, the quarterly
                                'research numbers need to be updated because crystal will put print these fields
                                 'setup quarterly  Research values for all vehicles
                                tmCbf.lQGRP = tmQGRP(0) 'tmQGRP(1)
                                tmCbf.lQCPP = tmQCPP(0) 'tmQCPP(1)
                                tmCbf.lQCPM = tmQCPM(0) 'tmQCPM(1)
                                tmCbf.lQGrimp = tmQGrimp(0) 'tmQGrimp(1)
                                mPutCntWkGrps 1                 'update the quarters weekly grps
    
                                igBR_SchLinesExist = True      '12-13-02
                                mUpdateInsertVehList ilListIndex, tlInsertVehList()
                                If imWeeksPerQtr(1) = 14 Then       '9-28-17 handle CBS and qtr not 13 weeks
                                    tmCbf.sWeeksInQtr = "4"
                                ElseIf imWeeksPerQtr(1) = 12 Then
                                    tmCbf.sWeeksInQtr = "2"
                                End If
                                tmCbf.sSnapshot = smSnapshot
                                ilVefInxForCallLetters = gBinarySearchVef(tmCbf.iVefCode)
                                If ilVefInxForCallLetters <> -1 Then        '10-23-06 if new package vehicle entered for proposal, the index wont exist.  The vehicle
                                    gFindStationMkt ilVefInxForCallLetters, tmCbf            '2-21-18 show market name?
                                End If
                                ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
                            End If
                        ElseIf gDateValue(slCode) < gDateValue(slNameCode) Then  'test cancel before start on line dates
                            slTempDays = slStr      'cancel before start line, put out at least 1 qtr to show CBS
                            gPackDate slTempDays, tmCbf.iDtFrstBkt(0), tmCbf.iDtFrstBkt(1)
                            gPackDate slTempDays, tmCbf.iDtFrstBkt(0), tmCbf.iDtFrstBkt(1)
                            If tmCbf.iAirWks = 0 Then
                                tmCbf.iTotalWks = 0
                            End If
                            If tmClf.sHideCBS <> "Y" Then
                                mShowCBS ilListIndex, tlSofList(), slDailyExists       '2-24-06, format the CBS line
                                '2-24-06 If this line is the last line to print for the quarter, the quarterly
                                'research numbers need to be updated because crystal will put print these fields
                                 'setup quarterly  Research values for all vehicles
                                tmCbf.lQGRP = tmQGRP(0) 'tmQGRP(1)
                                tmCbf.lQCPP = tmQCPP(0) 'tmQCPP(1)
                                tmCbf.lQCPM = tmQCPM(0) 'tmQCPM(1)
                                tmCbf.lQGrimp = tmQGrimp(0) 'tmQGrimp(1)
                                
                                '4-29-10 place the vehicle qtr totals in each record for CBS line
                                'so that totals will be shown properly.  Depending on where the CBS
                                'line is sorted for output, it may get incorrect values if not udpated
                                For ilVehicle = LBound(ilVehList) To UBound(ilVehList) - 1 Step 1
                                    If tmClf.iVefCode = ilVehList(ilVehicle) Then
                                        Exit For
                                    End If
                                Next ilVehicle
                                'setup quarterly  Research values by vehicles
                                tmCbf.lVQGRP = tmVehQtrList(ilVehicle).lVQGRP(1)
                                tmCbf.lVQCPP = tmVehQtrList(ilVehicle).lVQCPP(1)
                                tmCbf.lVQCPM = tmVehQtrList(ilVehicle).lVQCPM(1)
                                tmCbf.lVQGrimp = tmVehQtrList(ilVehicle).lVQGrimp(1)
                                
                                mPutCntWkGrps 1             'update the quarters weekly grps
    
                                igBR_SchLinesExist = True      '12-13-02
                                mUpdateInsertVehList ilListIndex, tlInsertVehList()
                                tmCbf.sSnapshot = smSnapshot
                                If imWeeksPerQtr(1) = 14 Then       '9-28-17 handle CBS and qtr not 13 weeks
                                    tmCbf.sWeeksInQtr = "4"
                                ElseIf imWeeksPerQtr(1) = 12 Then
                                    tmCbf.sWeeksInQtr = "2"
                                End If
                                ilVefInxForCallLetters = gBinarySearchVef(tmCbf.iVefCode)
                                If ilVefInxForCallLetters <> -1 Then        '10-23-06 if new package vehicle entered for proposal, the index wont exist.  The vehicle
                                    gFindStationMkt ilVefInxForCallLetters, tmCbf             '2-21-18 show market name?
                                End If
                                ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
                            End If
                        Else
                            '4-10-19 replace ilRch with llRchQtr due to subscript out of range
                            llRchQtr = tmLnr(illoop).lLRchInx          '4-11-19 change to long; get starting index to research data for this line/rate event
                            ilVaryingQtrs = 0                       '11-14-11 handle varying qtrs (12,13,14)
                            For ilQtr = 1 To imMaxQtrs Step 1              'create 8 qtrs max
                                'ilDay = 0                           'gather # spots in qtr
                                llAccumSpotCount = 0                '3-25-05 gather # spots in qtr
                                dlTemp = 0                          'total $ in qtr
                                ilTemp = 0                          'flag to determine of mod with $0 and change of spots
                                'For ilWeekInx = 1 To 13 Step 1
                                '11-14-11 handle varying qtrs
                                For ilWeekInx = 1 To imWeeksPerQtr(ilQtr)
                                'llAccumSpotCount = lmSpotsByWk((ilQtr - 1) * 13 + ilWeekInx, ilLoop) + llAccumSpotCount
                                    llAccumSpotCount = lmSpotsByWk(ilVaryingQtrs + ilWeekInx, illoop) + llAccumSpotCount
                                    'If lmSpotsByWk((ilQtr - 1) * 13 + ilWeekInx, ilLoop) < 0 Then
                                    If lmSpotsByWk(ilVaryingQtrs + ilWeekInx, illoop) < 0 Then
                                        ilTemp = 1              '3/4/99 (if there a decrease in spots, it has to be show on diff output
                                    End If
                                    'llTemp = lmratesbywk((ilQtr - 1) * 13 + ilWeekInx, ilLoop) + llTemp
                                    dlTemp = lmratesbywk(ilVaryingQtrs + ilWeekInx, illoop) + dlTemp 'TTP 10439 - Rerate 21,000,000
                                    'tmCbf.lWeek(ilWeekInx) = lmSpotsByWk((ilQtr - 1) * 13 + ilWeekInx, ilLoop)
                                    tmCbf.lWeek(ilWeekInx - 1) = lmSpotsByWk(ilVaryingQtrs + ilWeekInx, illoop)
                                    tmCbf.lValue(ilWeekInx - 1) = tmLRch(llRchQtr + ilQtr - 1).lWklyGRP(ilWeekInx - 1)
                                 Next ilWeekInx
    
                                'Build all 13 week buckets in the standard month buckets
                                gPackDate slStr, tmCbf.iDtFrstBkt(0), tmCbf.iDtFrstBkt(1)
                                llDate = gDateValue(slStr)
                                
                                If tgChfCT.sInstallDefined <> "Y" Then           'installment contract, dont gather from sched lines, need the monthly install $ from SBF
                                    'For ilWeekInx = 1 To 13 Step 1              'detrmine which month bucket the weekly values belong in
                                    tmCbf.lCashCommAmt = 0
                                    tmCbf.lTradeCommAmt = 0
                                    llAcqNet = 0
                                    llAcqComm = 0
                                    For ilWeekInx = 1 To imWeeksPerQtr(ilQtr)       '11-14-11
                                        For ilMonthLoop = 1 To 12 Step 1
                                            imAcqCommPct = gGetEffectiveAcqComm(llDate, imAcqLoInx, imAcqHiInx)     'if varying commissions for acq costs on Insertion order, get the % to be used to calc.
                                           
                                            '9-22-15 if insertion orders and using acquisitions, is the spot cost to be shown if acq cost is $0?
                                            'if so, fake out the acq commission calculation with the normal agency comm
                                            If (ilListIndex = CNT_INSERTION) And (bmUseAcq) And (((Asc(tgSaf(0).sFeatures1) And SHOWPRICEONINSERTIONWITHACQUISTION) = SHOWPRICEONINSERTIONWITHACQUISTION)) And (tmClf.lAcquisitionCost = 0) Then
                                                imAcqCommPct = ilAgyComm
                                            End If
                                            
                                            'if this qtr is beyond 12 months of data, everything goes into Over 12 months bucket
                                            ilPkgOrSpot = tmCbf.lWeek(ilWeekInx - 1) 'set the # of spots this week
                                            If tmClf.sType = "E" Then               'if package is "equal", then the rate is the weekly rate, not spot rate
                                                If ilPkgOrSpot < 0 Then
                                                    ilPkgOrSpot = -1
                                                ElseIf ilPkgOrSpot > 0 Then
                                                    ilPkgOrSpot = 1
                                                End If
                                            End If
                                            If llDate >= llStdStartDates(13) Then
                                                If tmClf.sType = "E" Then               'if package type is "E", then the rate is the weekly rate, not spot rate
                                                    If tmCbf.lWeek(ilWeekInx - 1) < 0 And tmLnr(illoop).lRate < 0 Then    'decrease in $ and spots, keep it negative
                                                       'tmCbf.lMonth(13) = tmCbf.lMonth(13) + (-((ilPkgOrSpot * tmLnr(ilLoop).lRate)))
                                                       tmCbf.lMonth(12) = tmCbf.lMonth(12) + (-((ilPkgOrSpot * tmLnr(illoop).lRate)))
                                                       gCalcAcqComm imAcqCommPct, (-((ilPkgOrSpot * tmLnr(illoop).lRate))), llAcqNet, llAcqComm
                                                    Else
                                                        'tmCbf.lMonth(13) = tmCbf.lMonth(13) + ((ilPkgOrSpot * tmLnr(ilLoop).lRate))
                                                        tmCbf.lMonth(12) = tmCbf.lMonth(12) + ((ilPkgOrSpot * tmLnr(illoop).lRate))
                                                        gCalcAcqComm imAcqCommPct, ((ilPkgOrSpot * tmLnr(illoop).lRate)), llAcqNet, llAcqComm
                                                    End If
                                                Else
                                                    If tmCbf.lWeek(ilWeekInx - 1) < 0 And tmLnr(illoop).lRate < 0 Then    'decrease in $ getand spots, keep it negative
                                                        'tmCbf.lMonth(13) = tmCbf.lMonth(13) + (-((tmCbf.lWeek(ilWeekInx - 1) * tmLnr(ilLoop).lRate)))
                                                        tmCbf.lMonth(12) = tmCbf.lMonth(12) + (-((tmCbf.lWeek(ilWeekInx - 1) * tmLnr(illoop).lRate)))
                                                        gCalcAcqComm imAcqCommPct, (-((tmCbf.lWeek(ilWeekInx - 1) * tmLnr(illoop).lRate))), llAcqNet, llAcqComm
                                                    Else
                                                        'tmCbf.lMonth(13) = tmCbf.lMonth(13) + ((tmCbf.lWeek(ilWeekInx - 1) * tmLnr(ilLoop).lRate))
                                                        tmCbf.lMonth(12) = tmCbf.lMonth(12) + ((tmCbf.lWeek(ilWeekInx - 1) * tmLnr(illoop).lRate))
                                                        gCalcAcqComm imAcqCommPct, ((tmCbf.lWeek(ilWeekInx - 1) * tmLnr(illoop).lRate)), llAcqNet, llAcqComm
                                                    End If
                                                End If
                                                'add monthly spot counts
                                                'tmCbf.lMonthUnits(13) = tmCbf.lMonthUnits(13) + tmCbf.lWeek(ilWeekInx - 1)
                                                tmCbf.lMonthUnits(12) = tmCbf.lMonthUnits(12) + tmCbf.lWeek(ilWeekInx - 1)
                                                ilMonthLoop = 12            'end loop
                                            Else
                                                If llDate >= llStdStartDates(ilMonthLoop) And llDate < llStdStartDates(ilMonthLoop + 1) Then
                                                    If tmClf.sType = "E" Then       'if package type is "E", then the rate is the weekly rate, not spot rate
                                                        If tmCbf.lWeek(ilWeekInx - 1) < 0 And tmLnr(illoop).lRate < 0 Then    'decrease in $ and spots, keep it negative
                                                            tmCbf.lMonth(ilMonthLoop - 1) = tmCbf.lMonth(ilMonthLoop - 1) + (-((ilPkgOrSpot * tmLnr(illoop).lRate)))
                                                            gCalcAcqComm imAcqCommPct, (-((ilPkgOrSpot * tmLnr(illoop).lRate))), llAcqNet, llAcqComm
                                                        Else
                                                            tmCbf.lMonth(ilMonthLoop - 1) = tmCbf.lMonth(ilMonthLoop - 1) + ((ilPkgOrSpot * tmLnr(illoop).lRate))
                                                            gCalcAcqComm imAcqCommPct, ((ilPkgOrSpot * tmLnr(illoop).lRate)), llAcqNet, llAcqComm
                                                        End If
                                                    Else
                                                        If tmCbf.lWeek(ilWeekInx - 1) < 0 And tmLnr(illoop).lRate < 0 Then    'decrease in $ and spots, keep it negative
                                                            tmCbf.lMonth(ilMonthLoop - 1) = tmCbf.lMonth(ilMonthLoop - 1) + (-((tmCbf.lWeek(ilWeekInx - 1) * tmLnr(illoop).lRate)))
                                                            gCalcAcqComm imAcqCommPct, (-((tmCbf.lWeek(ilWeekInx - 1) * tmLnr(illoop).lRate))), llAcqNet, llAcqComm
                                                        Else
                                                            tmCbf.lMonth(ilMonthLoop - 1) = tmCbf.lMonth(ilMonthLoop - 1) + ((tmCbf.lWeek(ilWeekInx - 1) * tmLnr(illoop).lRate))
                                                            gCalcAcqComm imAcqCommPct, ((tmCbf.lWeek(ilWeekInx - 1) * tmLnr(illoop).lRate)), llAcqNet, llAcqComm
                                                        End If
                                                    End If
                                                    'Add monthly spot counts
                                                    'tmCbf.lMonthUnits(ilMonthLoop) = tmCbf.lMonthUnits(ilMonthLoop) + tmCbf.lWeek(ilWeekInx - 1)
                                                    tmCbf.lMonthUnits(ilMonthLoop - 1) = tmCbf.lMonthUnits(ilMonthLoop - 1) + tmCbf.lWeek(ilWeekInx - 1)
                                                    ilMonthLoop = 12            'end loop
                                                End If
                                            End If
                                            'tmCbf.lCashCommAmt = tmCbf.lCashCommAmt + llAcqComm
    
                                        Next ilMonthLoop
                                        llDate = llDate + 7
                                        tmCbf.lCashCommAmt = tmCbf.lCashCommAmt + llAcqComm
    
                                    Next ilWeekInx
                                End If
                                'Output a quarter record if its a mod (where either the spot count or dollars are non-zero), or it a fullcontract
                                'and there has to be spots in the quarter ($ could be zero)
    
                                'If ((ilTemp <> 0 Or llTemp <> 0 Or llAccumSpotCount <> 0) And (ilThisCntMod)) Or (llAccumSpotCount <> 0 And Not ilThisCntMod) Then    '3/4/99 if mod: need rate chg, spot chg or if net result of spot is 0 then new flag set
                                If ((ilTemp <> 0 Or dlTemp <> 0 Or llAccumSpotCount <> 0) And (ilThisCntMod)) Or (llAccumSpotCount <> 0 And Not ilThisCntMod) Then    '3/4/99 if mod: need rate chg, spot chg or if net result of spot is 0 then new flag set'TTP 10439 - Rerate 21,000,000
                                    'ilLoop3 = tmLnr(ilLoop).iLineInx
                                    mBRDaysTimes illoop, slDailyExists, tlSofList(), ilListIndex   'format days and times for the line
                                    mCalcNetNet ilListIndex                     'determine owners share
                                    tmCbf.lCPP = tmLRch(llRchQtr + ilQtr - 1).lTotalCPP
                                    tmCbf.lCPM = tmLRch(llRchQtr + ilQtr - 1).lTotalCPM
                                    tmCbf.lGrImp = tmLRch(llRchQtr + ilQtr - 1).lTotalGrimps
                                    tmCbf.iAvgRate = tmLRch(llRchQtr + ilQtr - 1).iTotalAvgRating
                                    tmCbf.lAvgAud = tmLRch(llRchQtr + ilQtr - 1).lTotalAvgAud
                                    tmCbf.lGRP = tmLRch(llRchQtr + ilQtr - 1).lTotalGRP
                                    'setup quarterly  Research values for all vehicles
                                    tmCbf.lQGRP = tmQGRP(ilQtr - 1) 'tmQGRP(ilQtr)
                                    tmCbf.lQCPP = tmQCPP(ilQtr - 1) 'tmQCPP(ilQtr)
                                    tmCbf.lQCPM = tmQCPM(ilQtr - 1) 'tmQCPM(ilQtr)
                                    tmCbf.lQGrimp = tmQGrimp(ilQtr - 1) 'tmQGrimp(ilQtr)
    
                                    For ilVehicle = LBound(ilVehList) To UBound(ilVehList) - 1 Step 1
                                        If tmCbf.iVefCode = ilVehList(ilVehicle) Then
                                            Exit For
                                        End If
                                    Next ilVehicle
                                    'setup quarterly  Research values by vehicles
                                    tmCbf.lVQGRP = tmVehQtrList(ilVehicle).lVQGRP(ilQtr)
                                    tmCbf.lVQCPP = tmVehQtrList(ilVehicle).lVQCPP(ilQtr)
                                    tmCbf.lVQCPM = tmVehQtrList(ilVehicle).lVQCPM(ilQtr)
                                    tmCbf.lVQGrimp = tmVehQtrList(ilVehicle).lVQGrimp(ilQtr)
    
                                    mPutCntWkGrps ilQtr
                                    igBR_SchLinesExist = True      '12-13-02
                                    If tgChfCT.sInstallDefined = "Y" Then   'if installment contract, show install $ on summary page
                                        'TTP 8410 - Ignore Repeat check on Installement hidden vehicles, so we can get the $ amounts
                                        'gBuildInstallMonths tmClf.iVefCode, ilVehiclesDone(), llStdStartDates(), llInstallBilling(), tlSbf()
                                        gBuildInstallMonths tmClf.iVefCode, ilVehiclesDone(), llStdStartDates(), llInstallBilling(), tlSbf(), tmClf.iPkLineNo > 0
                                        For ilMonthLoop = 1 To 13
                                            tmCbf.lMonth(ilMonthLoop - 1) = llInstallBilling(ilMonthLoop)
                                        Next ilMonthLoop
                                    End If

                                    tmCbf.sWeeksInQtr = "3"                 '11-14-11 flag in crystal to tell how many week columns to show
                                    If imWeeksPerQtr(ilQtr) = 14 Then
                                        tmCbf.sWeeksInQtr = "4"
                                    ElseIf imWeeksPerQtr(ilQtr) = 12 Then
                                        tmCbf.sWeeksInQtr = "2"
                                    End If
                                    tmCbf.sSnapshot = smSnapshot            'blank = Not differences on an insertion order or contract, D = Differences for Insertion order
                                    ilVefInxForCallLetters = gBinarySearchVef(tmCbf.iVefCode)
                                    If ilVefInxForCallLetters <> -1 Then        '10-23-06 if new package vehicle entered for proposal, the index wont exist.  The vehicle
                                        gFindStationMkt ilVefInxForCallLetters, tmCbf            '2-21-18 show market name?
                                    End If
                                    If ((Asc(tgSaf(0).sFeatures4) And ACT1CODES) = ACT1CODES) Then      '2-27-18 using Act1 Codes?, if so, show lineup code reference.  Set the clfcode
                                                                                                        'using cbfPop field .  cbfPop not used anywhere else in contract print report
                                        tmCbf.lPop = 0
                                        'TTP 10230 - 7/7/21 - JW - Act 1 lineup codes and settings
                                        'If tmClf.sType <> "H" Then                                  'hidden lines of package should not show the lineup to avoid too many lines printed
                                        'TTP 10382 - Contract report: Option To not show Act1 codes on PDF
                                        If bmShowACT1Codes = True Then
                                            tmCbf.lPop = tmClf.lCode                                'schedule line reference
                                        End If
                                    End If
                                    'TTP 10271: Insertion Orders report: add option to create a separate PDF file for each vehicle;'10/8/21 - JW - Fix TTP 10271: Insertion Orders report.
                                    If tmCbf.iLen > 0 Or tmCbf.lRate > 0 Or tmCbf.iProdPct > 0 Then RptSelCt.bmHasRecords = True

                                    '8410 - For installment Contracts, insert a Dummy record of the hidden vehicles so that the amounts can be included in the total
                                    If ilListIndex <> CNT_INSERTION And tgChfCT.sInstallDefined = "Y" And tmClf.iPkLineNo > 0 Then
                                        tmPkgCbf = tmCbf
                                        ilClfInx = mGetPkgLineNoFromHiddenLine(tmClf.iPkLineNo)
                                        tmPkgCbf.iVefCode = tgClfCT(ilClfInx).ClfRec.iVefCode
                                        tmPkgCbf.lLineNo = tgClfCT(ilClfInx).ClfRec.iLine
                                        'tmPkgCbf.iVefCode = 15
                                        tmPkgCbf.iExtra2Byte = 0 '0=Details or airtime, 2=Vehicle Totals, 3=Cntr Totals
                                        tmPkgCbf.lIntComment = 1
                                        tmPkgCbf.sLineType = "Y"
                                        
                                        'TTP 8410 - Ignore Repeat check on Installement hidden vehicles, so we can get the $ amounts
                                        'gBuildInstallMonths tmClf.iVefCode, ilVehiclesDone(), llStdStartDates(), llInstallBilling(), tlSbf()
                                        gBuildInstallMonths tmClf.iVefCode, ilVehiclesDone(), llStdStartDates(), llInstallBilling(), tlSbf(), tmClf.iPkLineNo > 0
                                        For ilMonthLoop = 1 To 13
                                            tmPkgCbf.lMonth(ilMonthLoop - 1) = llInstallBilling(ilMonthLoop)
                                        Next ilMonthLoop
                                        ilRet = btrInsert(hmCbf, tmPkgCbf, imCbfRecLen, INDEXKEY0)
                                        
                                        If RptSelCt!ckcSelC6(2).Value <> vbChecked Then
                                            tmCbf.sLineType = "X" 'A,O,E=Pkg, H=Hidden, S=Standard, X & Y Excluded from Br.rpt & used in BRSum.Rpt and BRSumZer.Rpt to exclude from totals
                                        End If
                                    End If
                                    
                                    'If RptSelCt!ckcSelC6(2).Value = vbUnchecked And tmClf.sType = "H" And ilListIndex <> CNT_INSERTION And tgChfCT.sInstallDefined = "Y" Then
                                        'Dont insert Hidden
                                    'Else
                                    ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
                                    'End If

                                    'init monthly $ and units buckets for next flight
                                    'For ilMonthLoop = 1 To 13 Step 1
                                    For ilMonthLoop = 1 To 14 Step 1        '11-14-11 adjust for 12 or 14 week qtr
                                        If ilMonthLoop = 14 Then            'weekly buckets, adjust for 14 weeks in qtr
                                            tmCbf.lWeek(ilMonthLoop - 1) = 0
                                            tmCbf.lValue(ilMonthLoop - 1) = 0
                                        End If
                                        If ilMonthLoop <= 13 Then                'monthly bkts
                                            tmCbf.lMonth(ilMonthLoop - 1) = 0
                                            tmCbf.lMonthUnits(ilMonthLoop - 1) = 0
                                            tmCbf.lWeek(ilMonthLoop - 1) = 0
                                        End If
                                    Next ilMonthLoop
                                    mUpdateInsertVehList ilListIndex, tlInsertVehList()
                                    
                                End If
                                'prepare start date of next quarter
                                gUnpackDate tmCbf.iDtFrstBkt(0), tmCbf.iDtFrstBkt(1), slStr
    
                                'llDate = gDateValue(slStr) + (13 * 7)       'add 13 weeks for next quarter start date
                                llDate = gDateValue(slStr) + (imWeeksPerQtr(ilQtr) * 7)   '11-14-11 get to start of next qtr
                                slStr = Format$(llDate, "m/d/yy")
                                ilVaryingQtrs = ilVaryingQtrs + imWeeksPerQtr(ilQtr)
    
                            Next ilQtr                          'process next quarter
                        End If                              'llfltend < llfltstart
                    Else                        '3-10-06 if ignoring hidden overrides and its a hidden lines, need to flag if applicable
                        If (imHiddenOverride And HIDDENOVERRIDE) = HIDDENOVERRIDE And tmClf.sType = "H" Then
                            mBRDaysTimes illoop, slDailyExists, tlSofList(), ilListIndex   'the hidden line is not shown, but need to flag at least
                                                        'one output record so research disclaimer can be shown if applicable
                        End If
                    End If                          'Rptselct!ckcSelC6(2).Value
                End If                              'if imProcessFlag = 1 or 3
            Next illoop                             '1 to ilLinespots

            If Not ilGot1ToPrint Then   '6-30-04 allow no changes insertion order to show on differnce option   ' And ilListIndex <> CNT_INSERTION Then               'write out the header only - for a difference option when changing the header,
                                                    'nothing gets shown for lines -  at least show header so that the change reason is printed
    
                'If Not ilGetAll Then
                If Not ilThisCntMod Then
                    tmCbf.iPctDist = 0              'Pct dist field replaced by Difference flag (0=full)
                    tmCbf.iMnfGroup = 0             'Normal BR (not differences), init flag for Crystal
                Else
                    tmCbf.iPctDist = 1              '1 = difference only (used to print legend on BR for diff. option)
                    tmCbf.iMnfGroup = 1             '1 = nothing found to print; do special eliminating of showing fields in Crystal
                    igBR_SchLinesExist = True      '12-13-02 force output
                End If
                mUpdateInsertVehList ilListIndex, tlInsertVehList()
                tmCbf.sSnapshot = smSnapshot
                'TTP 10271: Insertion Orders report: add option to create a separate PDF file for each vehicle;'10/8/21 - JW - Fix TTP 10271: Insertion Orders report.
                If tmCbf.iLen > 0 Or tmCbf.lRate > 0 Or tmCbf.iProdPct > 0 Then RptSelCt.bmHasRecords = True
                ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
            End If

            '3-15-19 process only package vehicles, combining all hidden lines for each packages vehicles with same name
            'ie a package may be used more than once, maybe for different dp or spot lengths
            mGatherPkgVehSummary ilLineSpots, ilPkgVehList(), ilVehList(), llOverallPopEst, llLnSpots, llPopByLine(), llWklyspots(), llWklyRates(), llWklyAvgAud(), llWklyPopEst(), lmSpotsByWk(), lmWklyRates(), lmAvgAud(), lmPopEst(), ilWklyRtg(), llWklyGrimp(), llWklyGRP()
            
            'Create array of grps, wkly rating, grimps and rates to pass to routine to generate vehicle totals for summary
            '3-15-19 hidden and std vehicle summary
            For ilVehicle = LBound(ilVehList) To UBound(ilVehList) - 1 Step 1
                llLnSpots = 0
                'llPop = lmPop(ilVehicle)     '11-23-99
                'ReDim Preserve tmLRch(1 To 1) As RESEARCHINFO
                'ReDim tmLRch(1 To 1) As RESEARCHINFO
                ReDim tmLRch(0 To 1) As RESEARCHINFO    'Index zero ignored
                For illoop = 1 To ilLineSpots - 1
                    If imProcessFlag(tmLnr(illoop).iLineInx) = 1 Or imProcessFlag(tmLnr(illoop).iLineInx) = 3 Or imProcessFlag(tmLnr(illoop).iLineInx) = 4 Then  'show current and prev lines depending
                        ilLoop3 = tmLnr(illoop).iLineInx            'line index to process
                                                                    'on the option selected.  Mods show current & prev, Full BR shows curent only
                                                                    'Move spots, $ and aud to single dimension array for gAvgAudToLnResearch routine
                        tmClf = tgClfCT(ilLoop3).ClfRec
                        llPop = llPopByLine(ilLoop3 + 1)    '11-23-99
                        ilFoundLine = False
                        '4-10-19 change ilTemp to llTempLrch
                        llTempLRch = UBound(tmLRch)
                        If tmClf.sType = "H" Then                   'hidden line to a package
                            If RptSelCt!ckcSelC6(2).Value = vbChecked And ilVehList(ilVehicle) = tmClf.iVefCode Then
                                ilFoundLine = True
                            Else
                                '11-29-04 if not showing hidden lines, see if this hidden vehicle is also a package vehicle to process. if so, it needs to be processed
                                If RptSelCt!ckcSelC6(2).Value = vbUnchecked And ilVehList(ilVehicle) = tmClf.iVefCode Then
                                    For ilHiddenAndConv = LBound(ilPkgVehList) To UBound(ilPkgVehList) - 1
                                        If ilPkgVehList(ilHiddenAndConv) = tmClf.iVefCode Then
                                            ilFoundLine = True
                                            Exit For
                                        End If
                                    Next ilHiddenAndConv
                                End If
                            End If
                            '8410 - if It's an Installement contract and iPkLineNo > 0 and this is the right vehicle, indicate we found a Line
                            If ilListIndex <> CNT_INSERTION And RptSelCt!ckcSelC6(2).Value = vbUnchecked And tgChfCT.sInstallDefined = "Y" And tmClf.iPkLineNo > 0 And ilVehList(ilVehicle) = tmClf.iVefCode Then
                                ilFoundLine = True
                            End If
                        ElseIf tmClf.sType = "S" Then
                            If tmClf.iVefCode = ilVehList(ilVehicle) Then
                                ilFoundLine = True
                            End If
                        Else
                        End If
                        
                        If ilFoundLine Then
                            tmCbf.sLineType = tmClf.sType '8410
                            For ilSpots = 1 To MAXWEEKSFOR2YRS Step 1
                                If tmClf.sType = "E" Then   'Equal pkg: the spot cost is equal to the weekly cost (not rate * # spots)
                                    llWklyspots(ilSpots - 1) = 1
                                Else
                                    llWklyspots(ilSpots - 1) = lmSpotsByWk(ilSpots, illoop)
                                End If
                                llLnSpots = llLnSpots + llWklyspots(ilSpots - 1)
                                
                                tmLRch(llTempLRch).lQSpots = tmLRch(llTempLRch).lQSpots + llWklyspots(ilSpots - 1)
'                                llWklyRates(ilSpots - 1) = lmWklyRates(ilSpots - 1, ilLoop3)
'                                llWklyAvgAud(ilSpots - 1) = lmAvgAud(ilSpots - 1, ilLoop3)
'                                llWklyPopEst(ilSpots - 1) = lmPopEst(ilSpots - 1, ilLoop3)
                                '3-15-19 remove -1 from index on source field
                                llWklyRates(ilSpots - 1) = lmWklyRates(ilSpots, ilLoop3)
                                llWklyAvgAud(ilSpots - 1) = lmAvgAud(ilSpots, ilLoop3)
                                llWklyPopEst(ilSpots - 1) = lmPopEst(ilSpots, ilLoop3)
                            Next ilSpots
                            'gAvgAudToLnResearch sm1or2PlaceRating, True, llPop, llWklyPopEst(), llWklyspots(), llWklyRates(), llWklyAvgAud(), llTemp, tmCbf.lAvgAud, ilWklyRtg(), tmCbf.iAvgRate, llWklyGrimp(), tmCbf.lGrImp, llWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, llPopEst
                            gAvgAudToLnResearch sm1or2PlaceRating, True, llPop, llWklyPopEst(), llWklyspots(), llWklyRates(), llWklyAvgAud(), dlTemp, tmCbf.lAvgAud, ilWklyRtg(), tmCbf.iAvgRate, llWklyGrimp(), tmCbf.lGrImp, llWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, llPopEst 'TTP 10439 - Rerate 21,000,000
                                tmLRch(llTempLRch).iVefCode = ilVehList(ilVehicle)
                            'mRchSameData llTempLRch, llTemp
                            mRchSameData llTempLRch, CLng(dlTemp)  'TTP 10439 - Rerate 21,000,000 - Fix TTP 10439 per Jason email v81 Contract report overflow error - Wed 11/16/22 9:42 AM
                        End If
                    End If                          'imProcessFlag(tmLnr(ilLoop).iLineInx) = 1
                Next illoop
    
                'Gather all weeks of each line individually, which is required for the overall contract totals
                'Line totals generated for max 2 years each, total all lines from results of each line
                'For Summary Page (1 line per vehicle)
                ReDim tmVRtg(0 To 0) As Integer
                ReDim tmVCost(0 To 0) As Long
                ReDim tmVGRP(0 To 0) As Long
                ReDim tmVGrimp(0 To 0) As Long
    
                '4-10-19 change ilRchQtr to llRchQTr due to subscript out of range
                For llRchQtr = LBONE To UBound(tmLRch) - 1 Step 1
                    'If tmLRch(ilRchQtr).iQspots <> 0 Then
                    If llLnSpots <> 0 Then
                        'llLnSpots = llLnSpots + tmLRch(ilRchQtr).iQspots
                        tmVRtg(UBound(tmVRtg)) = tmLRch(llRchQtr).iTotalAvgRating
                        tmVCost(UBound(tmVCost)) = tmLRch(llRchQtr).dTotalCost 'TTP 10439 - Rerate 21,000,000
                        tmVGRP(UBound(tmVGRP)) = tmLRch(llRchQtr).lTotalGRP
                        tmVGrimp(UBound(tmVGrimp)) = tmLRch(llRchQtr).lTotalGrimps
                        ReDim Preserve tmVRtg(0 To UBound(tmVRtg) + 1) As Integer
                        ReDim Preserve tmVCost(0 To UBound(tmVCost) + 1) As Long
                        ReDim Preserve tmVGRP(0 To UBound(tmVGRP) + 1) As Long
                        ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) + 1) As Long
                    End If
                Next llRchQtr
                'If UBound(tmVRtg) > 1 Then
                If UBound(tmVRtg) > LBound(tmVRtg) Then
                    'dimensions must be exact sizes
                    ReDim Preserve tmVRtg(0 To UBound(tmVRtg) - 1) As Integer
                    ReDim Preserve tmVCost(0 To UBound(tmVCost) - 1) As Long
                    ReDim Preserve tmVGRP(0 To UBound(tmVGRP) - 1) As Long
                    ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) - 1) As Long
                    'If UBound(tmVRtg) >= 1 Then
                    If UBound(tmVRtg) >= LBound(tmVRtg) Then
                        'gResearchTotals True, llPop, tmVCost(), tmVRtg(), tmVGrimp(), tmVGRP(), llTemp, tmCbf.iAvgRate, tmCbf.lGrimp, tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM
                        '4/7/99
                        llPop = lmPop(ilVehicle)   '11-23-99
                        'gResearchTotals sm1or2PlaceRating, True, llPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, llTemp, tmCbf.iAvgRate, tmCbf.lGrImp, tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, tmCbf.lAvgAud
                        gResearchTotals sm1or2PlaceRating, True, llPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, dlTemp, tmCbf.iAvgRate, tmCbf.lGrImp, tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, tmCbf.lAvgAud 'TTP 10439 - Rerate 21,000,000
                    Else
                        tmCbf.lCPP = 0
                        tmCbf.lCPM = 0
                        tmCbf.lGRP = 0
                        tmCbf.lGrImp = 0
                    End If
                    
                    '3-31-21 Save the total air time gross impressions and cost to combine with any adserver lines.  The CPM and gross impressions will be shown on the Research Summary page
                    'convert the gross impressions to units (to be same with the adserver base) based on the Site Aud feature
                    If tgSpf.sSAudData = "H" Then     'hundreds
                        slStr = "100"
                    ElseIf tgSpf.sSAudData = "N" Then   'tens
                        slStr = "10"
                    ElseIf tgSpf.sSAudData = "U" Then   'units
                        slStr = "1"
                    Else        'tgspf.sSAudData = "T"   'thousands
                        slStr = "1000"
                    End If
    
                    'lgAirTimeGross = lgAirTimeGross + llTemp      'total cost of air time gross
                    lgAirTimeGross = lgAirTimeGross + dlTemp      'total cost of air time gross'TTP 10439 - Rerate 21,000,000
                    slTempGrimp = gLongToStrDec(tmCbf.lGrImp, 0)    'grimps for line
                    slTempGrimp = gMulStr(slTempGrimp, slStr)          'adjust to be by units
                    sgAirTimeGrimp = gAddStr(sgAirTimeGrimp, slTempGrimp)       'accum total unit grimps for air time

                    tmCbf.iExtra2Byte = 2               'vehicle summary totals
                    tmCbf.iVefCode = ilVehList(ilVehicle)
                    tmCbf.lQGRP = 0
                    tmCbf.lQCPP = 0
                    tmCbf.lQCPM = 0
                    tmCbf.lQGrimp = 0
                    tmCbf.lVQGRP = 0
                    tmCbf.lVQCPP = 0
                    tmCbf.lVQCPM = 0
                    tmCbf.lVQGrimp = 0
                    igBR_SchLinesExist = True      '12-13-02
                    tmCbf.sSnapshot = smSnapshot
                    tmCbf.sMixTypes = ""                'default to show vehicle grp, cpp field
                    For ilTemp = 0 To UBound(tmPodcast_Info) - 1
                        If tmPodcast_Info(ilTemp).iVefCode = tmCbf.iVefCode Then
                            'type of line:  P = Podcast, K = package line, H = Podcast Hidden Line, L = Other, not podcast Hidden Line, O = other, not podcast (conventional, selling)
                            'look for package vehicles to determine how to show the vehicle cpp, grp columns
                            If tmPodcast_Info(ilTemp).sType = "K" Then
                                If Not tmPodcast_Info(ilTemp).bShowResearch Then
                                    tmCbf.sMixTypes = "H"
                                End If
                                Exit For
                            Else
                                If tmPodcast_Info(ilTemp).sType = "P" Or tmPodcast_Info(ilTemp).sType = "H" Then        'podcast vehicle not in hidden line (P), or in pkg (H)
                                    tmCbf.sMixTypes = "H"
                                End If
                                Exit For
                            End If
                        End If
                    Next ilTemp
                    ilVefInxForCallLetters = gBinarySearchVef(tmCbf.iVefCode)
                    If ilVefInxForCallLetters <> -1 Then        '10-23-06 if new package vehicle entered for proposal, the index wont exist.  The vehicle
                        gFindStationMkt ilVefInxForCallLetters, tmCbf            '2-21-18 show market name?
                    End If
                    'TTP 10271: Insertion Orders report: add option to create a separate PDF file for each vehicle;'10/8/21 - JW - Fix TTP 10271: Insertion Orders report.
                    If tmCbf.iLen > 0 Or tmCbf.lRate > 0 Or tmCbf.iProdPct > 0 Then RptSelCt.bmHasRecords = True
                    ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
                End If
            Next ilVehicle
            'setup general vehicle table for the packages
    
            'Create array of grps, wkly rating, grimps and rates to pass to routine to generate contract totals for summary
            'ReDim Preserve tmLRch(1 To 1) As RESEARCHINFO
            ilfirstTime = True
            'ReDim tmLRch(1 To 1) As RESEARCHINFO
            ReDim tmLRch(0 To 1) As RESEARCHINFO    'Index zero ignored
            For illoop = 1 To ilLineSpots - 1
                If imProcessFlag(tmLnr(illoop).iLineInx) = 1 Or imProcessFlag(tmLnr(illoop).iLineInx) = 3 Or imProcessFlag(tmLnr(illoop).iLineInx) = 4 Then  'show current and prev lines depending
                    ilLoop3 = tmLnr(illoop).iLineInx            'line index to process
                    tmClf = tgClfCT(ilLoop3).ClfRec
                    'on the option selected.  Mods show current & prev, Full BR shows curent only
                    'Move spots, $ and aud to single dimension array for gAvgAudToLnResearch routine
                    'ignore the package lines for summary totals, generate contract research totals on hidden and std lines
                    If tmClf.sType <> "A" And tmClf.sType <> "O" And tmClf.sType <> "E" Then
                        If ilfirstTime Then
                            ilfirstTime = False
                            '4-10-19 replace ilTemp with ilTempLRch due to subscript out of range
                            llTempLRch = UBound(tmLRch)
                            tmLRch(llTempLRch).lQSpots = 0
                            For ilSpots = 1 To MAXWEEKSFOR2YRS Step 1
                                llWklyspots(ilSpots - 1) = 0
                                llWklyRates(ilSpots - 1) = 0
                                llWklyAvgAud(ilSpots - 1) = 0
                                llWklyPopEst(ilSpots - 1) = 0
                            Next ilSpots
                            ilFoundLine = tmClf.iLine
                            ilFoundVeh = tmClf.iVefCode
                        End If
                        If ilFoundLine = tmClf.iLine Then
                            llPop = llPopByLine(ilLoop3 + 1)                     '11-23-99    'on the option selected.  Mods show current & prev, Full BR shows curent only
                            For ilSpots = 1 To MAXWEEKSFOR2YRS Step 1
                                llWklyspots(ilSpots - 1) = llWklyspots(ilSpots - 1) + lmSpotsByWk(ilSpots, illoop)
                                tmLRch(llTempLRch).lQSpots = tmLRch(llTempLRch).lQSpots + lmSpotsByWk(ilSpots, illoop)
                                If llWklyRates(ilSpots - 1) = 0 Then
'                                    llWklyRates(ilSpots - 1) = lmWklyRates(ilSpots - 1, ilLoop3)
                                    llWklyRates(ilSpots - 1) = lmWklyRates(ilSpots, ilLoop3)             '3-15-19 remove -1 on source field
                                End If
                                If llWklyAvgAud(ilSpots - 1) = 0 Then
'                                    llWklyAvgAud(ilSpots - 1) = lmAvgAud(ilSpots - 1, ilLoop3)
'                                    llWklyPopEst(ilSpots - 1) = lmPopEst(ilSpots - 1, ilLoop3)
'                                   '3-15-19 remove -1 from index on source field
                                    llWklyAvgAud(ilSpots - 1) = lmAvgAud(ilSpots, ilLoop3)
                                    llWklyPopEst(ilSpots - 1) = lmPopEst(ilSpots, ilLoop3)
                                End If
                            Next ilSpots
                        Else
                            'gAvgAudToLnResearch sm1or2PlaceRating, True, llPop, llWklyPopEst(), llWklyspots(), llWklyRates(), llWklyAvgAud(), llTemp, tmCbf.lAvgAud, ilWklyRtg(), tmCbf.iAvgRate, llWklyGrimp(), tmCbf.lGrImp, llWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, llPopEst
                            gAvgAudToLnResearch sm1or2PlaceRating, True, llPop, llWklyPopEst(), llWklyspots(), llWklyRates(), llWklyAvgAud(), dlTemp, tmCbf.lAvgAud, ilWklyRtg(), tmCbf.iAvgRate, llWklyGrimp(), tmCbf.lGrImp, llWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, llPopEst 'TTP 10439 - Rerate 21,000,000
                            'gAvgAudToLnResearch True, lmPop(ilLoop3), llWklyspots(), llWklyRates(), llWklyAvgAud(), llTemp, tmCbf.lAvgAud, ilWklyRtg(), tmCbf.iAvgRate, llWklyGrimp(), tmCbf.lGrimp, llWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM
                            'Update array with results of research routine (didn't use the actual field names in the subroutine call because
                            'the total parameters were too long
                            'tmLRch(ilTemp).ivefCode = tmClf.ivefCode
'3-19-19  remove  and replace
'                            tmLRch(ilTemp).iVefCode = ilFoundVeh
'                            mRchSameData ilTemp, llTemp
'                            ilTemp = UBound(tmLRch)
'                            tmLRch(ilTemp).lQSpots = 0
'3-19-19 replaced code
                            tmLRch(llTempLRch).iVefCode = ilFoundVeh
                            'tmLRch(llTempLRch).lTotalCost = llTemp
                            tmLRch(llTempLRch).dTotalCost = dlTemp 'TTP 10439 - Rerate 21,000,000
                            tmLRch(llTempLRch).lTotalCPP = tmCbf.lCPP
                            tmLRch(llTempLRch).lTotalCPM = tmCbf.lCPM
                            tmLRch(llTempLRch).lTotalGRP = tmCbf.lGRP
                            tmLRch(llTempLRch).lTotalGrimps = tmCbf.lGrImp
                            tmLRch(llTempLRch).iTotalAvgRating = tmCbf.iAvgRate
                            tmLRch(llTempLRch).lTotalAvgAud = tmCbf.lAvgAud
                            'ReDim Preserve tmLRch(1 To UBound(tmLRch) + 1)
                            ReDim Preserve tmLRch(0 To UBound(tmLRch) + 1)  'Index zero ignored
                            llTempLRch = UBound(tmLRch)
                            tmLRch(llTempLRch).lQSpots = 0
'
                            'initialize arrays for next sched line
                            For ilSpots = 1 To MAXWEEKSFOR2YRS Step 1
                                llWklyspots(ilSpots - 1) = 0
                                tmLRch(llTempLRch).lQSpots = 0
                                llWklyRates(ilSpots - 1) = 0
                                llWklyAvgAud(ilSpots - 1) = 0
                                llWklyPopEst(ilSpots - 1) = 0
                            Next ilSpots
                            For ilSpots = 1 To MAXWEEKSFOR2YRS Step 1
                                llWklyspots(ilSpots - 1) = llWklyspots(ilSpots - 1) + lmSpotsByWk(ilSpots, illoop)
                                tmLRch(llTempLRch).lQSpots = tmLRch(llTempLRch).lQSpots + lmSpotsByWk(ilSpots, illoop)
                                If llWklyRates(ilSpots - 1) = 0 Then
                                    '3-19-19
'                                    llWklyRates(ilSpots - 1) = lmWklyRates(ilSpots - 1, ilLoop3)
                                    llWklyRates(ilSpots - 1) = lmWklyRates(ilSpots, ilLoop3)
                                End If
                                If llWklyAvgAud(ilSpots - 1) = 0 Then
'                                    llWklyAvgAud(ilSpots - 1) = lmAvgAud(ilSpots - 1, ilLoop3)
'                                    llWklyPopEst(ilSpots - 1) = lmPopEst(ilSpots - 1, ilLoop3)
                                    '3-13-19 remove -1 on source field
                                    llWklyAvgAud(ilSpots - 1) = lmAvgAud(ilSpots, ilLoop3)
                                    llWklyPopEst(ilSpots - 1) = lmPopEst(ilSpots, ilLoop3)
                                End If
                            Next ilSpots
                            ilFoundLine = tmClf.iLine
                            ilFoundVeh = tmClf.iVefCode
                            'for next lines population
                            llPop = llPopByLine(ilLoop3 + 1)   '11-23-99    'on the option selected.  Mods show current & prev, Full BR shows curent only
                        End If
                    End If
                End If
            Next illoop
            'gAvgAudToLnResearch sm1or2PlaceRating, True, llPop, llWklyPopEst(), llWklyspots(), llWklyRates(), llWklyAvgAud(), llTemp, tmCbf.lAvgAud, ilWklyRtg(), tmCbf.iAvgRate, llWklyGrimp(), tmCbf.lGrImp, llWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, llPopEst
            gAvgAudToLnResearch sm1or2PlaceRating, True, llPop, llWklyPopEst(), llWklyspots(), llWklyRates(), llWklyAvgAud(), dlTemp, tmCbf.lAvgAud, ilWklyRtg(), tmCbf.iAvgRate, llWklyGrimp(), tmCbf.lGrImp, llWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, llPopEst 'TTP 10439 - Rerate 21,000,000
            'gAvgAudToLnResearch True, lmPop(ilLoop3), llWklyspots(), llWklyRates(), llWklyAvgAud(), llTemp, tmCbf.lAvgAud, ilWklyRtg(), tmCbf.iAvgRate, llWklyGrimp(), tmCbf.lGrimp, llWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM
            'Update array with results of research routine (didn't use the actual field names in the subroutine call because
            'the total parameters were too long
            'tmLRch(ilTemp).ivefCode = tmClf.ivefCode
            If UBound(tmLRch) >= llTempLRch Then
                tmLRch(llTempLRch).iVefCode = ilFoundVeh
                'mRchSameData llTempLRch, llTemp
                mRchSameData llTempLRch, CLng(dlTemp)  'TTP 10439 - Rerate 21,000,000 - Fix TTP 10439 per Jason email v81 Contract report overflow error - Wed 11/16/22 9:42 AM
            End If
            'Line totals generated for max 2 years each, total all lines from results of each line
            ReDim tmVRtg(0 To 0) As Integer
            ReDim tmVCost(0 To 0) As Long
            ReDim tmVGRP(0 To 0) As Long
            ReDim tmVGrimp(0 To 0) As Long
            '3/13/04- moved llLnSpots = 0 here
            llLnSpots = 0
            '4-10-19 change ilRchQtr to llRchQtr due to subscript out of range
            For llRchQtr = 1 To UBound(tmLRch) - 1 Step 1
    '                llLnSpots = 0
                If tmLRch(llRchQtr).lQSpots <> 0 Then   'And tmLRch(ilRchQtr).lTotalGrimps Then
                    llLnSpots = llLnSpots + tmLRch(llRchQtr).lQSpots
                    tmVRtg(UBound(tmVRtg)) = tmLRch(llRchQtr).iTotalAvgRating
                    tmVCost(UBound(tmVCost)) = tmLRch(llRchQtr).dTotalCost 'TTP 10439 - Rerate 21,000,000
                    tmVGRP(UBound(tmVGRP)) = tmLRch(llRchQtr).lTotalGRP
                    tmVGrimp(UBound(tmVGrimp)) = tmLRch(llRchQtr).lTotalGrimps
                    ReDim Preserve tmVRtg(0 To UBound(tmVRtg) + 1) As Integer
                    ReDim Preserve tmVCost(0 To UBound(tmVCost) + 1) As Long
                    ReDim Preserve tmVGRP(0 To UBound(tmVGRP) + 1) As Long
                    ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) + 1) As Long
                End If
            Next llRchQtr
            
            If UBound(tmVRtg) > LBound(tmVRtg) Then
                'dimensions must be exact sizes
                ReDim Preserve tmVRtg(0 To UBound(tmVRtg) - 1) As Integer
                ReDim Preserve tmVCost(0 To UBound(tmVCost) - 1) As Long
                ReDim Preserve tmVGRP(0 To UBound(tmVGRP) - 1) As Long
                ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) - 1) As Long
                '4/7/99
                'gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, llTemp, tmCbf.iAvgRate, tmCbf.lGrImp, tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, tmCbf.lAvgAud
                gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, dlTemp, tmCbf.iAvgRate, tmCbf.lGrImp, tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, tmCbf.lAvgAud 'TTP 10439 - Rerate 21,000,000
                tmCbf.iExtra2Byte = 3               'contract totals
                tmCbf.lQGRP = 0
                tmCbf.lQCPP = 0
                tmCbf.lQCPM = 0
                tmCbf.lQGrimp = 0
                tmCbf.lVQGRP = 0
                tmCbf.lVQCPP = 0
                tmCbf.lVQCPM = 0
                tmCbf.lVQGrimp = 0
                igBR_SchLinesExist = True      '12-13-02
                tmCbf.sSnapshot = smSnapshot
                
                'TTP 10271: Insertion Orders report: add option to create a separate PDF file for each vehicle;'10/8/21 - JW - Fix TTP 10271: Insertion Orders report.
                If tmCbf.iLen > 0 Or tmCbf.lRate > 0 Or tmCbf.iProdPct > 0 Then RptSelCt.bmHasRecords = True
                ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
                If ilListIndex = CNT_BR Then            '6-30-15 ignore the comments on Insertion order for now
                    '10-20-05 contract total record just created, create any sports comments if they exist
                    mCreateBRSportsComments ilWhichSort
                    '6-20-07 Create List of Split Network stations for footer
                    gBuildSplitNetStations hmRaf, hmSef, hmTxr, hmShf, hmMkt, hmVLF, hmAtt, tgClfCT(), tgChfCT
                End If
            End If
        End If                                      'tgChfCt.imnfDemo(ilDemo) > 0
        If RptSelCt!rbcSelC7(0).Value Then            'use primary demo only
            ilDemo = 4                              'force to get out of demo loop
        End If
    Next ilDemo

    If ilListIndex = CNT_INSERTION Then     '10-24-08 Insertion order needs special record so that
'                                                'airtime & NTR can be combined on the same page
'                                                'this record created so the subreports can link to them
        mCreateKeyForInsertions tlInsertVehList(), ilWhichSort
    End If

    'create a special record for the NTR as there wasnt an airtime vehicle
    'Process NTR if applicable
    'retrieve all NTR records for this contract as long as its not insertion orders
    If (ilListIndex = CNT_BR) Or (ilListIndex = CNT_INSERTION And RptSelCt!ckcSelC12(0).Value = vbChecked) Then
        mProcessBrNTR "1/1/1970", "12/31/2069", tlSBFType, tlRvf(), tlSbf(), ilVehiclesDone(), llStdStartDates(), ilListIndex, tlInsertVehList(), ilWhichSort
    End If
    If (ilListIndex = CNT_BR) Then          '1-7-21 process cpm  podcast only for contract not Insertion order
        blPodExists = gBuildCPMIDs(hmPcf, tgChfCT, llStdStartDates(), tmCPM_IDs(), tmCPMSummary())
        If blPodExists Then
            igBR_CPMDefined = True
            mProcessBR_CPM ilWhichSort, ilShowProof, tmCPM_IDs(), tmCPMSummary()      'create the detail IDs, summary by vehicle Research, and vehicle billing vehicle
        End If
    End If
End Sub

'           mSetResortField - tmCbf.sResort is used in sorting the output in the proposal/contract print.
'           This has to be set for all lines, including Cancel Before start lines
Public Sub mSetResortField(slType As String, llLineRef As Long)
    Dim slStr As String
    tmCbf.sResort = ""
    tmCbf.sResortType = ""          '5-31-05
    If Trim$(slType) = "H" Then             'hidden
        slStr = Trim$(str$(llLineRef))
        Do While Len(slStr) < 4         '5-31-05 use 4 digit line #s (vs 3 digit line #s)
        slStr = "0" & slStr
        Loop
        tmCbf.sResort = slStr '& "C"
        tmCbf.sResortType = "C"         '5-31-05
    ElseIf Trim$(slType) = "A" Or Trim$(slType) = "O" Or Trim$(slType) = "E" Or Trim$(slType) = "P" Then     'packages: P = package for cpm; all others package for spots
        slStr = Trim$(str$(llLineRef))
        Do While Len(slStr) < 4         '5-31-05
        slStr = "0" & slStr
        Loop
        tmCbf.sResort = slStr '& "A"
        tmCbf.sResortType = "A"         '5-31-05
    Else                                    'conventionals, all others (fall after package/hiddens)
        tmCbf.sResort = "9999"  '~"
        tmCbf.sResortType = "~"         '5-31-05
    End If
End Sub

'           3-15-19 Gather all the hidden lines for each unique package (1 pkg may be used more than once)
Public Sub mGatherPkgVehSummary(ilLineSpots As Integer, ilPkgVehList() As Integer, ilVehList() As Integer, llOverallPopEst As Long, llLnSpots As Long, llPopByLine() As Long, llWklyspots() As Long, llWklyRates() As Long, llWklyAvgAud() As Long, llWklyPopEst() As Long, lmSpotsByWk() As Long, lmWklyRates() As Long, lmAvgAud() As Long, lmPopEst() As Long, ilWklyRtg() As Integer, llWklyGrimp() As Long, llWklyGRP() As Long)
    Dim illoop As Integer
    Dim ilLoop3 As Integer
    Dim ilFoundLine As Integer
    Dim ilTemp As Integer
    Dim llPop As Long
    Dim ilVehicle As Integer
    Dim ilSavePkgVeh As Integer
    Dim ilPkg As Integer
    Dim ilSpots As Integer
    Dim ilLoopOnPkgVehList As Integer
    Dim ilLoopOnVehList As Integer
    Dim ilPkgLines() As Integer
    Dim ilLoopOnPkgLines As Integer
    Dim blGotHiddenLineForPkg As Boolean
    'Dim llTemp As Long
    Dim dlTemp As Double 'TTP 10439 - Rerate 21,000,000
    Dim llPopEst As Long
    Dim llResearchPop As Long
    Dim blItsAPkg As Boolean
    Dim ilVefInxForCallLetters As Integer
    Dim ilRet As Integer
    Dim llTempLRch As Long          '4-10-19 replace ilTemp due to subscript out of range
    Dim llRchQtr As Long            '4-01-19
    
    For ilLoopOnVehList = 0 To UBound(ilVehList) - 1        'loop on unique vehicle codes
        blItsAPkg = False
        For ilLoopOnPkgVehList = 0 To UBound(ilPkgVehList) - 1        'tet to see if the vehicle is a package.  if not, ignore it
            If ilVehList(ilLoopOnVehList) = ilPkgVehList(ilLoopOnPkgVehList) Then
                blItsAPkg = True
                Exit For
            End If
        Next ilLoopOnPkgVehList                     'ilLoopOnPkgVehList = 0 To UBound(ilPkgVehList) - 1

        If blItsAPkg Then          'bypass vehicles that are not packages
            ReDim ilPkgLines(0 To 0) As Integer
            ReDim tmLRch(0 To 1) As RESEARCHINFO        '10-30-01. Index zero ignored
            llLnSpots = 0
            llResearchPop = -1
            For ilPkg = 0 To UBound(tgClfCT) - 1 Step 1       'determine which line #s are using the same pkg vehicle
                If ilPkgVehList(ilLoopOnPkgVehList) = tgClfCT(ilPkg).ClfRec.iVefCode Then    'find the assoc pkg vehicle name
                    ilPkgLines(UBound(ilPkgLines)) = tgClfCT(ilPkg).ClfRec.iLine              'save the line #s for this matching package vehicle, could be used more than one and need to combine them all
                    ReDim Preserve ilPkgLines(0 To UBound(ilPkgLines) + 1) As Integer
                End If
            Next ilPkg
            'Now search for all the matching hidden lines using this package name and process its line for the package vehicle summary
            For illoop = 1 To ilLineSpots - 1
                If imProcessFlag(tmLnr(illoop).iLineInx) = 1 Or imProcessFlag(tmLnr(illoop).iLineInx) = 3 Or imProcessFlag(tmLnr(illoop).iLineInx) = 4 Then  'show current and prev lines depending
                    'on the option selected.  Mods show current & prev, Full BR shows curent only
                    'Move spots, $ and aud to single dimension array for gAvgAudToLnResearch routine
                    ilLoop3 = tmLnr(illoop).iLineInx            'line index to process
                    tmClf = tgClfCT(ilLoop3).ClfRec

                    ilFoundLine = False
                    llTempLRch = UBound(tmLRch)
                    blGotHiddenLineForPkg = False
                    For ilLoopOnPkgLines = 0 To UBound(ilPkgLines) - 1
                        If tmClf.iPkLineNo = ilPkgLines(ilLoopOnPkgLines) Then
                            blGotHiddenLineForPkg = True
                            Exit For
                        End If
                    Next ilLoopOnPkgLines

                    If blGotHiddenLineForPkg Then
                        'find the hidden vehicle for its population
                        llPop = 0
                        For ilVehicle = LBound(ilVehList) To UBound(ilVehList) - 1 Step 1
                            If tmClf.iVefCode = ilVehList(ilVehicle) Then
                                llPop = llPopByLine(ilLoop3 + 1)    '11-23-99
                                If tgSpf.sDemoEstAllowed <> "Y" Then            'this if for the researchtotal population
                                    If llResearchPop = -1 Then
                                        If llPop <> 0 Then
                                            llResearchPop = llPop
                                        End If
                                    Else                                    'population already set with at least 1 lines population
                                        If llResearchPop <> llPop And llPop <> 0 Then
                                            llResearchPop = 0                   'found at least 1 vehicle with diff pop
                                        End If
                                    End If
                                End If
                                Exit For
                            End If
                        Next ilVehicle
                        
                        'Need overall vehicle population based on if there were different books across the package
                        ilSavePkgVeh = ilVehList(ilLoopOnVehList)
                       
                        'create the array for all schedule lines
                        For ilSpots = 1 To MAXWEEKSFOR2YRS
                            llWklyspots(ilSpots - 1) = lmSpotsByWk(ilSpots, illoop)
                            llLnSpots = llLnSpots + lmSpotsByWk(ilSpots, illoop)        'accum for research total pkg vehicle
                            tmLRch(llTempLRch).lQSpots = tmLRch(llTempLRch).lQSpots + llWklyspots(ilSpots - 1)
                            llWklyRates(ilSpots - 1) = lmWklyRates(ilSpots, ilLoop3)
                            llWklyAvgAud(ilSpots - 1) = lmAvgAud(ilSpots, ilLoop3)
                            llWklyPopEst(ilSpots - 1) = lmPopEst(ilSpots, ilLoop3)
                        Next ilSpots
                        'gAvgAudToLnResearch sm1or2PlaceRating, True, llPop, llWklyPopEst(), llWklyspots(), llWklyRates(), llWklyAvgAud(), llTemp, tmCbf.lAvgAud, ilWklyRtg(), tmCbf.iAvgRate, llWklyGrimp(), tmCbf.lGrImp, llWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, llPopEst
                        gAvgAudToLnResearch sm1or2PlaceRating, True, llPop, llWklyPopEst(), llWklyspots(), llWklyRates(), llWklyAvgAud(), dlTemp, tmCbf.lAvgAud, ilWklyRtg(), tmCbf.iAvgRate, llWklyGrimp(), tmCbf.lGrImp, llWklyGRP(), tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, llPopEst 'TTP 10439 - Rerate 21,000,000
                        tmLRch(llTempLRch).iVefCode = tmClf.iVefCode
                        tmLRch(llTempLRch).iLineNo = tmClf.iLine
                        tmLRch(llTempLRch).sType = tmClf.sType          's = std, O = order, a=air, H = hidden
                        tmLRch(llTempLRch).iPkLineNo = tmClf.iPkLineNo  'pkg line reference if hidden
                        tmLRch(llTempLRch).iPkvefCode = ilSavePkgVeh     'associ pkg vehicle code if hidden line
                        'mRchSameData llTempLRch, llTemp
                        mRchSameData llTempLRch, CLng(dlTemp)  'TTP 10439 - Rerate 21,000,000 - Fix TTP 10439 per Jason email v81 Contract report overflow error - Wed 11/16/22 9:42 AM
    
                        '5-28-04 If using research estimates, see if different estimates across line and or vehicle
                        If tgSpf.sDemoEstAllowed = "Y" Then
                            llPopByLine(ilLoop3 + 1) = llPopEst
                            If lmPop(ilVehicle) = 0 Then            'same vehicle found more than once, if pop already stored,
                                                                    'dont wipe out with a possible non-population value
                                lmPop(ilVehicle) = llPopEst           'associate the population with the vehicle
                            End If
                            If llResearchPop = -1 And llPopEst <> 0 Then          'first time, llResearchPop is for the summary records (-1 first time thru, 0 = different books across vehicles)
                                llResearchPop = llPopEst
                            Else
                                If (llResearchPop <> 0) And (llResearchPop <> llPopEst) And (llPopEst <> 0) Then      'test to see if this pop is different that the prev one.
                                    llResearchPop = 0                                           'if different pops, calculate the contract  summary different
                                    If llPopEst <> lmPop(ilVehicle) Then  '11-30-99
                                        lmPop(ilVehicle) = -1          '11-30-99
                                    End If                             '11-30-99
                                Else
                                    'if current line has population, but there was already a different across
                                    'lines in pop, dont save new one
                                    If llPopEst <> 0 And (llResearchPop <> 0 And llResearchPop <> -1) Then   '2/1/99
                                        llResearchPop = llPopEst
                                    Else        '5-8-02
                                        If lmPop(ilVehicle) <> llPopEst And lmPop(ilVehicle) <> -1 Then
                                            lmPop(ilVehicle) = -1
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    End If                      'blGotHiddenLineForPkg
                End If                          'imProcessFlag(tmLnr(ilLoop).iLineInx) = 1
            Next illoop                         'loop on all line entries
            
            'Line totals generated for max 2 years each, total all lines from results of each line
            'For Summary Page (1 line per vehicle)
            ReDim tmVRtg(0 To 0) As Integer
            ReDim tmVCost(0 To 0) As Long
            ReDim tmVGRP(0 To 0) As Long
            ReDim tmVGrimp(0 To 0) As Long
            For llRchQtr = LBONE To UBound(tmLRch) - 1 Step 1
                tmVRtg(UBound(tmVRtg)) = tmLRch(llRchQtr).iTotalAvgRating
                tmVCost(UBound(tmVCost)) = tmLRch(llRchQtr).dTotalCost 'TTP 10439 - Rerate 21,000,000
                tmVGRP(UBound(tmVGRP)) = tmLRch(llRchQtr).lTotalGRP
                tmVGrimp(UBound(tmVGrimp)) = tmLRch(llRchQtr).lTotalGrimps
                ReDim Preserve tmVRtg(0 To UBound(tmVRtg) + 1) As Integer
                ReDim Preserve tmVCost(0 To UBound(tmVCost) + 1) As Long
                ReDim Preserve tmVGRP(0 To UBound(tmVGRP) + 1) As Long
                ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) + 1) As Long
            Next llRchQtr
            
            If UBound(tmVRtg) > 0 Then
                'dimensions must be exact sizes
                ReDim Preserve tmVRtg(0 To UBound(tmVRtg) - 1) As Integer
                ReDim Preserve tmVCost(0 To UBound(tmVCost) - 1) As Long
                ReDim Preserve tmVGRP(0 To UBound(tmVGRP) - 1) As Long
                ReDim Preserve tmVGrimp(0 To UBound(tmVGrimp) - 1) As Long
                If UBound(tmVRtg) >= 0 Then
                    If tgSpf.sDemoEstAllowed = "Y" Then         '6-1-04
                        'gResearchTotals sm1or2PlaceRating, True, llOverallPopEst, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, llTemp, tmCbf.iAvgRate, tmCbf.lGrImp, tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, tmCbf.lAvgAud
                        gResearchTotals sm1or2PlaceRating, True, llOverallPopEst, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, dlTemp, tmCbf.iAvgRate, tmCbf.lGrImp, tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, tmCbf.lAvgAud 'TTP 10439 - Rerate 21,000,000
                    Else
                        'gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, llTemp, tmCbf.iAvgRate, tmCbf.lGrImp, tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, tmCbf.lAvgAud
                        gResearchTotals sm1or2PlaceRating, True, llResearchPop, tmVCost(), tmVGrimp(), tmVGRP(), llLnSpots, dlTemp, tmCbf.iAvgRate, tmCbf.lGrImp, tmCbf.lGRP, tmCbf.lCPP, tmCbf.lCPM, tmCbf.lAvgAud 'TTP 10439 - Rerate 21,000,000
                    End If
                Else
                    tmCbf.lCPP = 0
                    tmCbf.lCPM = 0
                    tmCbf.lGRP = 0
                    tmCbf.lGrImp = 0
                End If

                tmCbf.iVefCode = ilVehList(ilLoopOnVehList)
                tmCbf.lQGRP = 0
                tmCbf.lQCPP = 0
                tmCbf.lQCPM = 0
                tmCbf.lQGrimp = 0
                tmCbf.lVQGRP = 0
                tmCbf.lVQCPP = 0
                tmCbf.lVQCPM = 0
                tmCbf.lVQGrimp = 0
                igBR_SSLinesExist = True      '12-16-03 force output
                tmCbf.iExtra2Byte = 2               'vehicle summary totals
                tmCbf.sMixTypes = ""            'default to show vehicle grp, cpp because not a podcast
                For ilTemp = 0 To UBound(tmPodcast_Info) - 1
                    If tmPodcast_Info(ilTemp).iVefCode = tmCbf.iVefCode Then
                        'type of line:  P = Podcast, K = package line, H = Podcast Hidden Line, L = Other, not podcast Hidden Line, O = other, not podcast (conventional, selling)
                        'look for package vehicles to determine how to show the vehicle cpp, grp columns
                        If tmPodcast_Info(ilTemp).sType = "K" Then
                            If Not tmPodcast_Info(ilTemp).bShowResearch Then
                                tmCbf.sMixTypes = "H"
                            End If
                            Exit For
                        Else
                            If tmPodcast_Info(ilTemp).sType = "P" Or tmPodcast_Info(ilTemp).sType = "H" Then        'podcast vehicle not in hidden line (P), or in pkg (H)
                                tmCbf.sMixTypes = "H"
                            End If
                            Exit For
                        End If
                    End If
                Next ilTemp
                ilVefInxForCallLetters = gBinarySearchVef(tmCbf.iVefCode)
                If ilVefInxForCallLetters <> -1 Then        '10-23-06 if new package vehicle entered for proposal, the index wont exist.  The vehicle
                    gFindStationMkt ilVefInxForCallLetters, tmCbf            '2-21-18 show market name?
                End If
                ilRet = btrInsert(hmCbf, tmCbf, imCbfRecLen, INDEXKEY0)
            End If                              'UBound(tmVRtg) > 0
        End If                                  'blItsAPkg
    Next ilLoopOnVehList                            'ilLoopOnVehList = 0 To UBound(ilVehList) - 1
End Sub

Public Sub mProcessBR_CPM(ilWhichSort As Integer, ilShowProof As Integer, tlCPM_IDs() As CPM_BR, tlCPMSummary() As CPM_BR)
    Dim ilRet As Integer
    If tgChfCT.sAdServerDefined = "Y" Then
        mSetupBrHdr ilWhichSort                                     'build the advt, agy, slsp and sort fields specs that ned to be built
        
        gWriteBR_CPM hmCbf, hmRdf, tgChf, tmCbf, ilShowProof, tlCPM_IDs(), tmCPMSummary()
    End If
End Sub

'                   mBobAdjustForAdServer -  determine where avg CPM $ goes (Billed & Booked)
'                   <input> tlPCF() - array of PCF (podcast cpm) records to process
'                           tlRvf() - array of PCF items billed
'                           llBillCyclestartDates() - array of 13 start dates of the 12 months to gather
'                           llLastBilledDate - last billed date - test to detrmine what buckets to place future calc $ into
'                           ilHowManyPer - # of periods to gather
'                                           (for billed & booked its 12,
'                                           for Sales Comparisons its max 3)
'                           ilWhichPeriod - type of calendar requested: 0 = corp, 1 = std, 2 = calendar; if Negative #, its by the bill method (if billing method, need to go thru receivables; otherwise bypass)
'TTP 10955 - Billed and Booked Cal Spots: slowness reported, possibly due to including digital lines
'Sub mBobAdjustForAdServer(tlPcfArray() As PCF, tlRvf() As RVF, llBillCycleStartDates() As Long, llLastBilledDate As Long, ilHowManyPer As Integer, ilWhichPeriod As Integer)
Sub mBobAdjustForAdServer(tlPcfArray() As PCF, tlRvf() As RVF, llBillCycleStartDates() As Long, llLastBilledDate As Long, ilHowManyPer As Integer, ilWhichPeriod As Integer, llCntrNo As Long)
    Dim slDate As String
    Dim llCPMStartDate As Long
    Dim llCPMEndDate As Long
    Dim ilMonthInx As Integer
    Dim blFoundVef As Boolean
    Dim ilAdjust As Integer
    Dim ilPCFLoop As Integer
    Dim ilFoundOption As Integer
    Dim tlPcf As PCF
    Dim llAvgCost As Long
    Dim ilLoopOnPast As Integer
    Dim llTotalCost As Long
    Dim llTemp As Long
    Dim ilTotalMonths As Integer
    Dim ilRemainMonths As Integer
    Dim ilTempRemainMonths As Integer
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim blFoundRvf As Boolean
    Dim TempAdServerStart As Long
    Dim TempAdServerEnd As Long
    Dim slAdServerStart As String
    Dim slAdServerEnd As String
    Dim llLoopOnMonths As Long
    Dim llTempAdServerStart As Long
    Dim llTempAdServerEnd As Long
    Dim llMonthStart As Long
    Dim llMonthEnd As Long
    Dim slCalType As String * 1
    Dim ilTempFirstProjInx As Integer
    Dim llTempLastBilledDate As Long
    Dim llBilledAmt As Long 'Boostr Phase 2 (Billed and Booked std broadcast: update to use new daily or monthly method depending on Site setting for future periods)
    Dim llOrderedAmt As Long 'Boostr Phase 2
    Dim llMonthlyAmt As Long 'Boostr Phase 2
    Dim tlDIGITALLINEAVERAGE As DIGITALLINEAVERAGE
    Dim llRemainingAmt As Long
    Dim llTempStartDate As Long
    Dim llTempEndDate As Long
    
    Dim tlPcf2() As PCF 'TTP 10955 - All PCF records accociated with the Contract (All revisions)
    Dim ilDoe As Integer
    
    If Abs(ilWhichPeriod) = 1 Then
        slCalType = "S"
    ElseIf Abs(ilWhichPeriod) = 2 Or ilWhichPeriod = 3 Then
        slCalType = "C"
    End If
    
    'get the amounts of adserver Ordered amts
    For ilPCFLoop = LBound(tlPcfArray) To UBound(tlPcfArray) - 1
        tlPcf = tlPcfArray(ilPCFLoop)
        If tlPcf.sType <> "P" Then            'get only the hidden lines or standard line IDs, ignore Pkg
            blFoundVef = False
            'create vehicle entry all vehicles ORDERED from PCF
            For ilAdjust = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1 Step 1
                If tmSBFAdjust(ilAdjust).lPodCode = tlPcf.lCode Then       '8-10-06
                    tmSBFAdjust(ilAdjust).lOrderedCPMCost = tmSBFAdjust(ilAdjust).lOrderedCPMCost + tlPcf.lTotalCost
                    blFoundVef = True
                    Exit For
                End If
            Next ilAdjust
            If Not (blFoundVef) Then
                ilAdjust = UBound(tmSBFAdjust)
                tmSBFAdjust(ilAdjust).iVefCode = tlPcf.iVefCode
                tmSBFAdjust(ilAdjust).lOrderedCPMCost = tlPcf.lTotalCost
                tmSBFAdjust(ilAdjust).lPodCode = tlPcf.lCode
                tmSBFAdjust(ilAdjust).iMnfItem = 0
                 'JW 5/18/23 - Fixed RAB and B&B for V81 TTP 10725  new issue 5-17-23.zip
                tmSBFAdjust(ilAdjust).iPodCPMID = tlPcf.iPodCPMID 'PodCPMID (Line #)
                ReDim Preserve tmSBFAdjust(0 To UBound(tmSBFAdjust) + 1) As ADJUSTLIST
            End If
        End If
    Next ilPCFLoop
            
    'TTP 10955 - Billed and Booked Cal Spots: slowness reported, possibly due to including digital lines
    'get the adserver billed amts (only if std, and bill method options).  If not bill cycle method, or its calendar, average the entire amount; no need to gets any receivables
    'If ilWhichPeriod < 0 Or ilWhichPeriod = 1 Then              '-1 = bill method by std, -2 = bill method by cal, 1 = std
    '    For ilLoopOnPast = LBound(tlRvf) To UBound(tlRvf) - 1
    '        For ilAdjust = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1
    '            'JW 5/18/23 - Fixed RAB and B&B for V81 TTP 10725  new issue 5-17-23.zip
    '            'If tlRvf(ilLoopOnPast).lPcfCode = tmSBFAdjust(ilAdjust).lPodCode Then
    '            If gObtainPcfCPMID(tlRvf(ilLoopOnPast).lPcfCode) = tmSBFAdjust(ilAdjust).iPodCPMID Then
    '                'accumulate the billing so far
    '                gPDNToLong tlRvf(ilLoopOnPast).sGross, llTemp
    '                tmSBFAdjust(ilAdjust).lBilledCPMCost = tmSBFAdjust(ilAdjust).lBilledCPMCost + llTemp
    '                Debug.Print tmSBFAdjust(ilAdjust).iPodCPMID & ", " & llTemp
    '                Exit For
    '            End If
    '        Next ilAdjust
    '    Next ilLoopOnPast
    'End If
    
    gObtainPcfByCntrNo llCntrNo, tlPcf2
    If ilWhichPeriod < 0 Or ilWhichPeriod = 1 Then              '-1 = bill method by std, -2 = bill method by cal, 1 = std
        For ilLoopOnPast = LBound(tlRvf) To UBound(tlRvf) - 1
            For ilAdjust = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1
                For ilPCFLoop = 0 To UBound(tlPcf2) - 1
                    If tlPcf2(ilPCFLoop).lCode = tlRvf(ilLoopOnPast).lPcfCode And tlPcf2(ilPCFLoop).iPodCPMID = tmSBFAdjust(ilAdjust).iPodCPMID Then
                        'accumulate the billing so far
                        gPDNToLong tlRvf(ilLoopOnPast).sGross, llTemp
                        tmSBFAdjust(ilAdjust).lBilledCPMCost = tmSBFAdjust(ilAdjust).lBilledCPMCost + llTemp
                        'Debug.Print tlPcf2(ilPCFLoop).iPodCPMID & ", " & llTemp
                        ilDoe = ilDoe + 1
                        If ilDoe > 1000 Then
                            ilDoe = 0
                            DoEvents
                        End If
                    End If
                Next ilPCFLoop
            Next ilAdjust
        Next ilLoopOnPast
    End If

    For ilPCFLoop = LBound(tlPcfArray) To UBound(tlPcfArray) - 1
        tlPcf = tlPcfArray(ilPCFLoop)
        gUnpackDateLong tlPcf.iStartDate(0), tlPcf.iStartDate(1), llCPMStartDate
        gUnpackDateLong tlPcf.iEndDate(0), tlPcf.iEndDate(1), llCPMEndDate
        If ilWhichPeriod = 1 Or ilWhichPeriod < 0 Then                      'std, billmethod by std, billmethod by cal
            If llCPMStartDate > llLastBilledDate Then               'if everything is in the future of last billed date, detrmine # months remaining from start of the adserver ID
                ilRemainMonths = gObtainMonthsOfCPMID(llCPMStartDate, llCPMEndDate, slCalType)
            Else
                ilRemainMonths = gObtainMonthsOfCPMID(llLastBilledDate + 1, llCPMEndDate, slCalType)
            End If
            llTempLastBilledDate = llLastBilledDate
        Else                    '2 = calendar, everything from contract; no last billed required
            ilRemainMonths = gObtainMonthsOfCPMID(llCPMStartDate, llCPMEndDate, slCalType)
            'get the earliest date of the calendar month from this adserver start date (ie if 11/30/15, need to get 11/1/15) for the start date of the month
            llTempLastBilledDate = gDateValue(gObtainStartCal(Format$(llCPMStartDate, "ddddd")))
            llTempLastBilledDate = llTempLastBilledDate - 1
        End If
        
        '---------------------------------------------
        'Boostr Phase 2 (Billed and Booked Std broadcast/Cal Cntr : update to use new daily or monthly method depending on Site setting for future periods)
        If tgSpfx.iLineCostType = 1 And tlPcf.sPriceType = "F" Then
            'Flat Rate Calculation using Daily Amount * Days per period
            llBilledAmt = 0
            llOrderedAmt = 0
            For ilAdjust = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1
                If tmSBFAdjust(ilAdjust).lPodCode = tlPcf.lCode Then
                    llBilledAmt = tmSBFAdjust(ilAdjust).lBilledCPMCost
                    llOrderedAmt = tmSBFAdjust(ilAdjust).lOrderedCPMCost
                    llRemainingAmt = llOrderedAmt - llBilledAmt
                    llMonthlyAmt = 0
                    For ilMonthInx = 1 To ilHowManyPer
                        llTempStartDate = llBillCycleStartDates(ilMonthInx)
                        llTempEndDate = llBillCycleStartDates(ilMonthInx + 1) - 1
                        If ilWhichPeriod < 0 Or ilWhichPeriod = 1 Then '1=Std, 2=Cal, -1=Bill Method
                            If llTempStartDate > llLastBilledDate Then
                                'future
                                llMonthlyAmt = mDeterminePeriodAmountByDaily(Format(llLastBilledDate, "ddddd"), Format(llBillCycleStartDates(ilMonthInx), "ddddd"), Format(llBillCycleStartDates(ilMonthInx + 1) - 1, "ddddd"), Format$(llCPMStartDate, "ddddd"), Format$(llCPMEndDate, "ddddd"), llBilledAmt, llOrderedAmt) * 100
                            End If
                        Else
                            'Cal Contract (fake the last billed date to the day before Line starts)
                            llMonthlyAmt = mDeterminePeriodAmountByDaily(Format$(llCPMStartDate - 1, "ddddd"), Format(llBillCycleStartDates(ilMonthInx), "ddddd"), Format(llBillCycleStartDates(ilMonthInx + 1) - 1, "ddddd"), Format$(llCPMStartDate, "ddddd"), Format$(llCPMEndDate, "ddddd"), llBilledAmt, llOrderedAmt) * 100
                        End If
                        tmSBFAdjust(ilAdjust).lProject(ilMonthInx) = llMonthlyAmt
                        If llBillCycleStartDates(ilMonthInx) > llCPMEndDate Then Exit For
                    Next ilMonthInx
                End If
            Next ilAdjust
        Else
            'Calc Monthly Amount
            For ilAdjust = LBound(tmSBFAdjust) To UBound(tmSBFAdjust) - 1
                If tmSBFAdjust(ilAdjust).lPodCode = tlPcf.lCode Then
                    If ilRemainMonths > 0 Then
                        llAvgCost = (tmSBFAdjust(ilAdjust).lOrderedCPMCost - tmSBFAdjust(ilAdjust).lBilledCPMCost) / ilRemainMonths
                        gObtainPeriodDates Abs(ilWhichPeriod), llCPMStartDate, llCPMEndDate, llTempAdServerStart, llTempAdServerEnd  'obtain total line ID start and end dates
                        'calculate the average remaining to be invoiced across all CPM months defined
                        Do While llTempAdServerStart <= llTempAdServerEnd           'loop on the months for the entire length of the line ID
                            For ilMonthInx = 1 To ilHowManyPer
                                If llTempAdServerStart >= llBillCycleStartDates(ilMonthInx) And llTempAdServerStart < llBillCycleStartDates(ilMonthInx + 1) And llTempAdServerStart > llTempLastBilledDate Then
                                    tmSBFAdjust(ilAdjust).lProject(ilMonthInx) = llAvgCost
                                    Exit For
                                End If
                            Next ilMonthInx
                            'increment the month by 1 month based on the type of calendar
                            gObtainPeriodDates Abs(ilWhichPeriod), llTempAdServerStart, llTempAdServerStart, llMonthStart, llMonthEnd
                            gObtainPeriodDates Abs(ilWhichPeriod), llMonthEnd + 1, llCPMEndDate, llTempAdServerStart, llTempAdServerEnd
                        Loop
                    End If
                End If
            Next ilAdjust
        End If
    Next ilPCFLoop
End Sub

'8410 - get the Package Line # from a Hidden Line #
Function mGetPkgLineNoFromHiddenLine(ilHiddenLineNo As Integer) As Integer
    Dim illoop As Integer
    Dim ilClfInx As Integer
    mGetPkgLineNoFromHiddenLine = 0
    For illoop = 0 To UBound(tgClfCT) - 1
        If tgClfCT(illoop).ClfRec.iLine = ilHiddenLineNo Then
            mGetPkgLineNoFromHiddenLine = illoop
            Exit For
        End If
    Next illoop
End Function

'Boostr Phase 2: Billed and Booked std broadcast: update to use new daily or monthly method depending on Site setting for future periods
'mDeterminePeriodAmountByDaily
'   Inputs:
'       slPeriodStart   - Start date of the month being reported (string Date MM/DD/YYYY)
'       slPeriodEnd     - End date of the month being reported (string Date MM/DD/YYYY)
'       slLineStartDate - Start Date of the PCF Line (string Date MM/DD/YYYY)
'       slLineEndDate   - End Date of the PCF Line (string Date MM/DD/YYYY)
'       slRemainingAmount - The Remaining amount (Line Total minus whats already been Invoiced) (string Amount ####.##)
'   Output:
'       Month Amount (double precision number ####.##)
Public Function mDeterminePeriodAmountByDaily(slLastBilledDate As String, slPeriodStart As String, slPeriodEnd As String, slLineStartDate As String, slLineEndDate As String, llBilledAmount, llTotalAmount As Long) As Double
    Dim dlDailyAmount As Double 'The daily $ Amount
    Dim ilNumberOfDaysRemaining As Integer 'How many days from Invoice Start Date to Line EndDate
    Dim ilNumberOfDaysInPeriod As Integer 'How many days are in this period
    Dim dStartDate As Date 'Temp Start Date
    Dim dEndDate As Date 'Temp End
    
    'Determine how many days remain of this line (beyond what's been billed)
    If DateValue(slLastBilledDate) + 1 > DateValue(slLineStartDate) Then
        dStartDate = DateValue(slLastBilledDate) + 1
    Else
        dStartDate = DateValue(slLineStartDate)
    End If
    dEndDate = DateValue(slLineEndDate)
    ilNumberOfDaysRemaining = DateDiff("d", dStartDate, dEndDate) + 1
    If ilNumberOfDaysRemaining <= 0 Then Exit Function
    
    'Determine how many days of this Line are being invoiced
    dStartDate = IIF(DateValue(slLineStartDate) > gDateValue(slPeriodStart), gDateValue(slLineStartDate), gDateValue(slPeriodStart))
    dEndDate = IIF(DateValue(slLineEndDate) < gDateValue(slPeriodEnd), gDateValue(slLineEndDate), gDateValue(slPeriodEnd))
    ilNumberOfDaysInPeriod = DateDiff("d", dStartDate, dEndDate) + 1
    If ilNumberOfDaysInPeriod <= 0 Then Exit Function
    
    'Determine the daily amount
    dlDailyAmount = ((llTotalAmount - llBilledAmount) / 100) / ilNumberOfDaysRemaining
    
    'Determine the amount to apply to this Period (slPeriodStart - slPeriodEnd)
    mDeterminePeriodAmountByDaily = dlDailyAmount * ilNumberOfDaysInPeriod
    
    Debug.Print "mDeterminePeriodAmountByDaily: "
    Debug.Print " -> Line Dates: " & slLineStartDate & " to " & slLineEndDate
    Debug.Print " -> RemainingAmount: " & Format((llTotalAmount - llBilledAmount) / 100, "#.00")
    Debug.Print " -> NumberOfDaysRemaining: " & ilNumberOfDaysRemaining
    Debug.Print " -> Period: " & slPeriodStart & " to " & slPeriodEnd & " = " & ilNumberOfDaysInPeriod
    Debug.Print " -> DailyAmount: " & dlDailyAmount
    Debug.Print " -> Month Amount: " & mDeterminePeriodAmountByDaily
End Function
