VERSION 5.00
Object = "{0ECD9B60-23AA-11D0-B351-00A0C9055D8E}#6.0#0"; "MSHFLXGD.OCX"
Object = "{F9043C88-F6F2-101A-A3C9-08002B2F49FB}#1.2#0"; "comdlg32.ocx"
Object = "{6B7E6392-850A-101B-AFC0-4210102A8DA7}#1.5#0"; "comctl32.ocx"
Begin VB.Form Invoice 
   Appearance      =   0  'Flat
   BorderStyle     =   1  'Fixed Single
   Caption         =   "CSI Invoices"
   ClientHeight    =   7035
   ClientLeft      =   495
   ClientTop       =   2085
   ClientWidth     =   12435
   ControlBox      =   0   'False
   BeginProperty Font 
      Name            =   "Arial"
      Size            =   8.25
      Charset         =   0
      Weight          =   700
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   ForeColor       =   &H80000008&
   Icon            =   "Invoice.frx":0000
   LinkMode        =   1  'Source
   LinkTopic       =   "DoneMsg"
   MaxButton       =   0   'False
   MinButton       =   0   'False
   PaletteMode     =   1  'UseZOrder
   ScaleHeight     =   7035
   ScaleWidth      =   12435
   Begin ComctlLib.ListView lbcView 
      Height          =   420
      Left            =   45
      TabIndex        =   72
      TabStop         =   0   'False
      Top             =   6390
      Width           =   9210
      _ExtentX        =   16245
      _ExtentY        =   741
      View            =   3
      LabelWrap       =   0   'False
      HideSelection   =   0   'False
      _Version        =   327682
      ForeColor       =   -2147483640
      BackColor       =   -2147483643
      BorderStyle     =   1
      Appearance      =   1
      NumItems        =   4
      BeginProperty ColumnHeader(1) {0713E8C7-850A-101B-AFC0-4210102A8DA7} 
         Key             =   ""
         Object.Tag             =   ""
         Text            =   "Highlight"
         Object.Width           =   0
      EndProperty
      BeginProperty ColumnHeader(2) {0713E8C7-850A-101B-AFC0-4210102A8DA7} 
         SubItemIndex    =   1
         Key             =   ""
         Object.Tag             =   ""
         Text            =   "Vehicle Name"
         Object.Width           =   1235
      EndProperty
      BeginProperty ColumnHeader(3) {0713E8C7-850A-101B-AFC0-4210102A8DA7} 
         SubItemIndex    =   2
         Key             =   ""
         Object.Tag             =   ""
         Text            =   "Dates"
         Object.Width           =   1411
      EndProperty
      BeginProperty ColumnHeader(4) {0713E8C7-850A-101B-AFC0-4210102A8DA7} 
         SubItemIndex    =   3
         Key             =   ""
         Object.Tag             =   ""
         Text            =   "Code"
         Object.Width           =   0
      EndProperty
   End
   Begin VB.TextBox edcUpdating 
      BackColor       =   &H00C0FFFF&
      Height          =   930
      Left            =   3375
      Locked          =   -1  'True
      MultiLine       =   -1  'True
      TabIndex        =   68
      Top             =   2115
      Visible         =   0   'False
      Width           =   4770
   End
   Begin VB.Timer tmcStart 
      Enabled         =   0   'False
      Interval        =   300
      Left            =   8760
      Top             =   5535
   End
   Begin VB.ListBox lbcKey 
      Height          =   270
      Left            =   7620
      Sorted          =   -1  'True
      TabIndex        =   62
      Top             =   -30
      Visible         =   0   'False
      Width           =   645
   End
   Begin VB.CommandButton cmcClearPsf 
      Appearance      =   0  'Flat
      Caption         =   "Cl&ear"
      Height          =   285
      Left            =   6870
      TabIndex        =   43
      Top             =   6645
      Width           =   945
   End
   Begin VB.ListBox lbcSortVehicle 
      Appearance      =   0  'Flat
      Height          =   240
      Left            =   3645
      Sorted          =   -1  'True
      TabIndex        =   59
      TabStop         =   0   'False
      Top             =   30
      Visible         =   0   'False
      Width           =   1995
   End
   Begin VB.PictureBox plcUnbilled 
      Appearance      =   0  'Flat
      BackColor       =   &H000000FF&
      BorderStyle     =   0  'None
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00000000&
      Height          =   4050
      Left            =   10200
      ScaleHeight     =   4050
      ScaleWidth      =   6945
      TabIndex        =   56
      Top             =   5640
      Visible         =   0   'False
      Width           =   6945
      Begin VB.Timer tmcPrt 
         Enabled         =   0   'False
         Interval        =   5000
         Left            =   300
         Top             =   3510
      End
      Begin VB.PictureBox pbcPrinting 
         Appearance      =   0  'Flat
         BackColor       =   &H00FFFF80&
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000008&
         Height          =   1230
         Left            =   1575
         ScaleHeight     =   1200
         ScaleWidth      =   3825
         TabIndex        =   69
         Top             =   1230
         Visible         =   0   'False
         Width           =   3855
      End
      Begin VB.CommandButton cmcUnbilledOk 
         Appearance      =   0  'Flat
         Caption         =   "&Ok"
         Height          =   285
         Left            =   2985
         TabIndex        =   58
         Top             =   3645
         Width           =   945
      End
      Begin VB.ListBox lbcUnbilled 
         Appearance      =   0  'Flat
         Height          =   2970
         Left            =   150
         Sorted          =   -1  'True
         TabIndex        =   57
         Top             =   285
         Width           =   6630
      End
      Begin VB.Image imcPrt 
         Appearance      =   0  'Flat
         Height          =   480
         Left            =   6240
         Picture         =   "Invoice.frx":08CA
         Top             =   3495
         Width           =   480
      End
   End
   Begin VB.CommandButton cmcSaleHist 
      Appearance      =   0  'Flat
      Caption         =   "&Backlog"
      Height          =   285
      Left            =   5820
      TabIndex        =   42
      Top             =   6645
      Width           =   945
   End
   Begin VB.CommandButton cmcReport 
      Appearance      =   0  'Flat
      Caption         =   "&Report"
      Height          =   285
      Left            =   7920
      TabIndex        =   44
      Top             =   6645
      Width           =   945
   End
   Begin VB.ListBox lbcLnCode 
      Appearance      =   0  'Flat
      Height          =   240
      Left            =   1935
      Sorted          =   -1  'True
      TabIndex        =   52
      TabStop         =   0   'False
      Top             =   -15
      Visible         =   0   'False
      Width           =   1035
   End
   Begin VB.CommandButton cmcAdj 
      Appearance      =   0  'Flat
      Caption         =   "&Adj Post"
      Enabled         =   0   'False
      Height          =   285
      Left            =   8430
      TabIndex        =   41
      Top             =   6240
      Visible         =   0   'False
      Width           =   945
   End
   Begin VB.CommandButton cmcItem 
      Appearance      =   0  'Flat
      Caption         =   "&Item Post"
      Enabled         =   0   'False
      Height          =   285
      Left            =   7380
      TabIndex        =   40
      Top             =   6240
      Visible         =   0   'False
      Width           =   945
   End
   Begin VB.PictureBox plcScreen 
      Appearance      =   0  'Flat
      BorderStyle     =   0  'None
      ForeColor       =   &H00000000&
      Height          =   240
      Left            =   30
      ScaleHeight     =   240
      ScaleWidth      =   1410
      TabIndex        =   0
      TabStop         =   0   'False
      Top             =   -15
      Visible         =   0   'False
      Width           =   1410
   End
   Begin VB.CommandButton cmcGenerate 
      Appearance      =   0  'Flat
      Caption         =   "&Generate"
      Enabled         =   0   'False
      Height          =   285
      Left            =   3720
      TabIndex        =   38
      Top             =   6645
      Width           =   945
   End
   Begin VB.CommandButton cmcCancel 
      Appearance      =   0  'Flat
      Caption         =   "&Cancel"
      Height          =   285
      Left            =   4770
      TabIndex        =   39
      Top             =   6645
      Width           =   945
   End
   Begin VB.PictureBox plcFromLine 
      ForeColor       =   &H00000000&
      Height          =   6000
      Left            =   60
      ScaleHeight     =   5940
      ScaleWidth      =   12210
      TabIndex        =   1
      TabStop         =   0   'False
      Top             =   255
      Width           =   12270
      Begin VB.CheckBox ckcAll 
         Caption         =   "All Vehicles"
         Enabled         =   0   'False
         ForeColor       =   &H80000008&
         Height          =   315
         Left            =   615
         TabIndex        =   30
         Top             =   3795
         Visible         =   0   'False
         Width           =   1335
      End
      Begin VB.ComboBox cbcWeek 
         Height          =   330
         Left            =   5160
         Style           =   2  'Dropdown List
         TabIndex        =   95
         Top             =   1200
         Visible         =   0   'False
         Width           =   2295
      End
      Begin VB.ComboBox cbcDates 
         Height          =   330
         Left            =   1320
         Style           =   2  'Dropdown List
         TabIndex        =   94
         Top             =   1200
         Visible         =   0   'False
         Width           =   2295
      End
      Begin VB.Frame frcBillCycle 
         Caption         =   "Bill Cycle"
         Height          =   1350
         Left            =   6855
         TabIndex        =   14
         Top             =   30
         Width           =   1380
         Begin VB.CheckBox ckcBillCycle 
            Caption         =   "Week"
            Height          =   240
            Index           =   2
            Left            =   120
            TabIndex        =   83
            Top             =   795
            Width           =   1110
         End
         Begin VB.CheckBox ckcBillCycle 
            Caption         =   "Calendar"
            Height          =   240
            Index           =   1
            Left            =   120
            TabIndex        =   82
            Top             =   510
            Width           =   1080
         End
         Begin VB.CheckBox ckcBillCycle 
            Caption         =   "Std B'cast"
            Height          =   240
            Index           =   0
            Left            =   120
            TabIndex        =   81
            Top             =   240
            Value           =   1  'Checked
            Width           =   1155
         End
      End
      Begin VB.PictureBox plcInvSpotTimeZone 
         Appearance      =   0  'Flat
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   240
         Left            =   45
         ScaleHeight     =   240
         ScaleWidth      =   6105
         TabIndex        =   73
         Top             =   3885
         Visible         =   0   'False
         Width           =   6105
         Begin VB.OptionButton rbcInvSpotTimeZone 
            Caption         =   "ET"
            Height          =   210
            Index           =   0
            Left            =   2760
            TabIndex        =   78
            Top             =   0
            Width           =   570
         End
         Begin VB.OptionButton rbcInvSpotTimeZone 
            Caption         =   "CT"
            Height          =   210
            Index           =   1
            Left            =   3390
            TabIndex        =   77
            Top             =   0
            Width           =   570
         End
         Begin VB.OptionButton rbcInvSpotTimeZone 
            Caption         =   "MT"
            Height          =   210
            Index           =   2
            Left            =   4020
            TabIndex        =   76
            Top             =   0
            Width           =   570
         End
         Begin VB.OptionButton rbcInvSpotTimeZone 
            Caption         =   "PT"
            Height          =   210
            Index           =   3
            Left            =   4650
            TabIndex        =   75
            Top             =   0
            Width           =   570
         End
         Begin VB.OptionButton rbcInvSpotTimeZone 
            Caption         =   "N/A"
            Height          =   210
            Index           =   4
            Left            =   5280
            TabIndex        =   74
            Top             =   0
            Width           =   570
         End
      End
      Begin VB.Frame frcType 
         Caption         =   "Type "
         ForeColor       =   &H00000000&
         Height          =   1350
         Left            =   120
         TabIndex        =   2
         Top             =   30
         Width           =   3135
         Begin VB.CheckBox ckcType 
            Caption         =   "Gen Rep A/R"
            Height          =   210
            Index           =   4
            Left            =   1665
            TabIndex        =   63
            Top             =   240
            Width           =   1440
         End
         Begin VB.CheckBox ckcType 
            Caption         =   "NTR"
            Height          =   210
            Index           =   3
            Left            =   1500
            TabIndex        =   6
            Top             =   795
            Width           =   630
         End
         Begin VB.CheckBox ckcType 
            Caption         =   "Installment"
            Enabled         =   0   'False
            Height          =   210
            Index           =   2
            Left            =   120
            TabIndex        =   5
            Top             =   795
            Visible         =   0   'False
            Width           =   1425
         End
         Begin VB.CheckBox ckcType 
            Caption         =   "Print Rep Invoices"
            Height          =   210
            Index           =   1
            Left            =   120
            TabIndex        =   4
            Top             =   510
            Width           =   1875
         End
         Begin VB.CheckBox ckcType 
            Caption         =   "Commercial"
            Height          =   210
            Index           =   0
            Left            =   120
            TabIndex        =   3
            Top             =   240
            Width           =   1305
         End
      End
      Begin VB.Frame frcBilling 
         Caption         =   "Dates to be Billed"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000008&
         Height          =   1305
         Left            =   120
         TabIndex        =   45
         Top             =   4650
         Visible         =   0   'False
         Width           =   10800
         Begin VB.CommandButton cmcView 
            Appearance      =   0  'Flat
            Caption         =   "&View"
            Height          =   285
            Left            =   9660
            TabIndex        =   66
            Top             =   165
            Visible         =   0   'False
            Width           =   945
         End
         Begin VB.Label lacWkDates 
            BackColor       =   &H00C0FFFF&
            BorderStyle     =   1  'Fixed Single
            Height          =   240
            Left            =   2460
            TabIndex        =   80
            Top             =   720
            Width           =   7005
         End
         Begin VB.Label lacWeekly 
            Appearance      =   0  'Flat
            Caption         =   "Weekly Billing"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000008&
            Height          =   225
            Left            =   120
            TabIndex        =   79
            Top             =   750
            Width           =   1500
         End
         Begin VB.Label lacNTR 
            Appearance      =   0  'Flat
            Caption         =   "NTR Billing"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000008&
            Height          =   225
            Left            =   120
            TabIndex        =   65
            Top             =   1020
            Width           =   1065
         End
         Begin VB.Label lacNTRDates 
            BackColor       =   &H00C0FFFF&
            BorderStyle     =   1  'Fixed Single
            Height          =   240
            Left            =   2460
            TabIndex        =   64
            Top             =   990
            Width           =   4830
         End
         Begin VB.Label lacCalDates 
            BackColor       =   &H00C0FFFF&
            BorderStyle     =   1  'Fixed Single
            Height          =   240
            Left            =   2460
            TabIndex        =   61
            Top             =   450
            Width           =   7005
         End
         Begin VB.Label lacStdDates 
            BackColor       =   &H00C0FFFF&
            BorderStyle     =   1  'Fixed Single
            Height          =   240
            Left            =   2460
            TabIndex        =   60
            Top             =   180
            Width           =   7005
         End
         Begin VB.Label lacCal 
            Appearance      =   0  'Flat
            Caption         =   "Calendar Billing"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000008&
            Height          =   225
            Left            =   120
            TabIndex        =   47
            Top             =   480
            Width           =   1500
         End
         Begin VB.Label lacStd 
            Appearance      =   0  'Flat
            Caption         =   "Standard Broadcast Billing"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000008&
            Height          =   225
            Left            =   120
            TabIndex        =   46
            Top             =   195
            Width           =   2265
         End
      End
      Begin VB.ListBox lbcVehicle 
         Appearance      =   0  'Flat
         Height          =   2130
         Left            =   120
         MultiSelect     =   2  'Extended
         TabIndex        =   28
         Top             =   1590
         Visible         =   0   'False
         Width           =   2310
      End
      Begin VB.ListBox lbcDates 
         Appearance      =   0  'Flat
         Height          =   2340
         Left            =   120
         TabIndex        =   29
         Top             =   1620
         Visible         =   0   'False
         Width           =   1245
      End
      Begin VB.Frame frcPrtType 
         Caption         =   "Printer Type"
         ForeColor       =   &H00000000&
         Height          =   1065
         Left            =   10035
         TabIndex        =   53
         Top             =   1470
         Visible         =   0   'False
         Width           =   1815
         Begin VB.OptionButton rbcPrtType 
            Caption         =   "Laser"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   0
            Left            =   90
            TabIndex        =   55
            Top             =   255
            Value           =   -1  'True
            Width           =   795
         End
         Begin VB.OptionButton rbcPrtType 
            Caption         =   "Impact"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   1
            Left            =   885
            TabIndex        =   54
            TabStop         =   0   'False
            Top             =   255
            Width           =   900
         End
      End
      Begin VB.Frame frcInvoice 
         Caption         =   "Generate"
         ForeColor       =   &H00000000&
         Height          =   1350
         Left            =   3450
         TabIndex        =   7
         Top             =   30
         Width           =   3315
         Begin VB.CheckBox ckcSuppressNTRDetails 
            Caption         =   "Suppress NTR Details"
            ForeColor       =   &H80000008&
            Height          =   240
            Left            =   90
            TabIndex        =   93
            TabStop         =   0   'False
            Top             =   1030
            Visible         =   0   'False
            Width           =   2790
         End
         Begin VB.OptionButton rbcType 
            Caption         =   "Archive"
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   5
            Left            =   1920
            TabIndex        =   91
            TabStop         =   0   'False
            Top             =   495
            Width           =   1065
         End
         Begin VB.OptionButton rbcType 
            Caption         =   "Undo"
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   4
            Left            =   90
            TabIndex        =   11
            TabStop         =   0   'False
            Top             =   495
            Width           =   765
         End
         Begin VB.OptionButton rbcType 
            Caption         =   "Aff"
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   3
            Left            =   2310
            TabIndex        =   10
            TabStop         =   0   'False
            Top             =   240
            Visible         =   0   'False
            Width           =   540
         End
         Begin VB.CheckBox ckcShowPrel 
            Caption         =   "Show ""Preliminary"" on Invoice"
            Enabled         =   0   'False
            ForeColor       =   &H80000008&
            Height          =   240
            Left            =   90
            TabIndex        =   13
            TabStop         =   0   'False
            Top             =   790
            Visible         =   0   'False
            Width           =   2790
         End
         Begin VB.OptionButton rbcType 
            Caption         =   "Reprint"
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   2
            Left            =   870
            TabIndex        =   12
            TabStop         =   0   'False
            Top             =   495
            Width           =   1065
         End
         Begin VB.OptionButton rbcType 
            Caption         =   "Final "
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   1
            Left            =   1470
            TabIndex        =   9
            TabStop         =   0   'False
            Top             =   240
            Width           =   735
         End
         Begin VB.OptionButton rbcType 
            Caption         =   "Preliminary"
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   0
            Left            =   90
            TabIndex        =   8
            TabStop         =   0   'False
            Top             =   240
            Width           =   1260
         End
      End
      Begin VB.PictureBox plcCntr 
         Appearance      =   0  'Flat
         BorderStyle     =   0  'None
         ForeColor       =   &H00000000&
         Height          =   255
         Left            =   4800
         ScaleHeight     =   255
         ScaleWidth      =   5940
         TabIndex        =   31
         TabStop         =   0   'False
         Top             =   3840
         Visible         =   0   'False
         Width           =   5940
         Begin VB.OptionButton rbcCntr 
            Caption         =   "Posted"
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   3
            Left            =   4725
            TabIndex        =   90
            TabStop         =   0   'False
            Top             =   0
            Visible         =   0   'False
            Width           =   930
         End
         Begin VB.OptionButton rbcCntr 
            Caption         =   "W/O Expired"
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   2
            Left            =   3375
            TabIndex        =   34
            TabStop         =   0   'False
            Top             =   0
            Visible         =   0   'False
            Width           =   1335
         End
         Begin VB.OptionButton rbcCntr 
            Caption         =   "Selective"
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   1
            Left            =   1440
            TabIndex        =   33
            TabStop         =   0   'False
            Top             =   0
            Width           =   1935
         End
         Begin VB.OptionButton rbcCntr 
            Caption         =   "All"
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   0
            Left            =   900
            TabIndex        =   32
            Top             =   0
            Value           =   -1  'True
            Width           =   540
         End
      End
      Begin VB.Frame frcOutput 
         Caption         =   "Report Destination"
         ForeColor       =   &H00000000&
         Height          =   1350
         Left            =   8520
         TabIndex        =   15
         Top             =   30
         Width           =   2385
         Begin VB.CheckBox ckcArchive 
            Caption         =   "Archive"
            Height          =   210
            Left            =   1320
            TabIndex        =   92
            Top             =   825
            Visible         =   0   'False
            Width           =   960
         End
         Begin VB.CheckBox ckcIncludeEDI 
            Caption         =   "Print EDI"
            Height          =   210
            Left            =   120
            TabIndex        =   89
            Top             =   825
            Visible         =   0   'False
            Width           =   1080
         End
         Begin VB.CommandButton cmcAlign 
            Appearance      =   0  'Flat
            Caption         =   "Align"
            Height          =   285
            Left            =   2550
            TabIndex        =   19
            Top             =   900
            Visible         =   0   'False
            Width           =   720
         End
         Begin VB.CommandButton cmcSetup 
            Appearance      =   0  'Flat
            Caption         =   "Printer Setup"
            Height          =   285
            Left            =   990
            TabIndex        =   18
            Top             =   495
            Width           =   1275
         End
         Begin VB.OptionButton rbcOutput 
            Caption         =   "Display"
            ForeColor       =   &H80000008&
            Height          =   255
            Index           =   0
            Left            =   120
            TabIndex        =   16
            TabStop         =   0   'False
            Top             =   255
            Width           =   885
         End
         Begin VB.OptionButton rbcOutput 
            Caption         =   "Print"
            ForeColor       =   &H80000008&
            Height          =   255
            Index           =   1
            Left            =   120
            TabIndex        =   17
            TabStop         =   0   'False
            Top             =   525
            Value           =   -1  'True
            Width           =   735
         End
      End
      Begin VB.Frame frcReprint 
         Caption         =   "Reprint"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000008&
         Height          =   1320
         Left            =   2460
         TabIndex        =   20
         Top             =   1695
         Visible         =   0   'False
         Width           =   4215
         Begin VB.OptionButton rbcDupl 
            Caption         =   "No"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   195
            Index           =   1
            Left            =   3450
            TabIndex        =   27
            Top             =   960
            Value           =   -1  'True
            Width           =   630
         End
         Begin VB.OptionButton rbcDupl 
            Caption         =   "Yes"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   195
            Index           =   0
            Left            =   2805
            TabIndex        =   26
            TabStop         =   0   'False
            Top             =   960
            Width           =   660
         End
         Begin VB.TextBox edcEReprint 
            Appearance      =   0  'Flat
            BackColor       =   &H00FFFF00&
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   285
            Left            =   2295
            TabIndex        =   24
            Top             =   570
            Width           =   1230
         End
         Begin VB.TextBox edcSReprint 
            Appearance      =   0  'Flat
            BackColor       =   &H00FFFF00&
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   285
            Left            =   2310
            TabIndex        =   22
            Top             =   225
            Width           =   1230
         End
         Begin VB.Label lacDupl 
            Appearance      =   0  'Flat
            Caption         =   "Show ""Duplicate"" on Invoices"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000008&
            Height          =   195
            Left            =   135
            TabIndex        =   25
            Top             =   945
            Width           =   2640
         End
         Begin VB.Label lbcSReprint 
            Appearance      =   0  'Flat
            Caption         =   "Starting Invoice Number"
            ForeColor       =   &H80000008&
            Height          =   225
            Left            =   120
            TabIndex        =   21
            Top             =   255
            Width           =   2160
         End
         Begin VB.Label lbcEReprint 
            Appearance      =   0  'Flat
            Caption         =   "Ending Invoice Number"
            ForeColor       =   &H80000008&
            Height          =   225
            Left            =   135
            TabIndex        =   23
            Top             =   600
            Width           =   2055
         End
      End
      Begin VB.PictureBox plcAdvt 
         Appearance      =   0  'Flat
         BorderStyle     =   0  'None
         ForeColor       =   &H00000000&
         Height          =   255
         Left            =   4515
         ScaleHeight     =   255
         ScaleWidth      =   2670
         TabIndex        =   35
         TabStop         =   0   'False
         Top             =   4305
         Visible         =   0   'False
         Width           =   2670
         Begin VB.OptionButton rbcAdvt 
            Caption         =   "All"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   0
            Left            =   1035
            TabIndex        =   36
            Top             =   0
            Value           =   -1  'True
            Width           =   540
         End
         Begin VB.OptionButton rbcAdvt 
            Caption         =   "Selective"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   240
            Index           =   1
            Left            =   1590
            TabIndex        =   37
            TabStop         =   0   'False
            Top             =   0
            Width           =   1140
         End
      End
      Begin MSHierarchicalFlexGridLib.MSHFlexGrid grdAirTime 
         Height          =   2130
         Left            =   3450
         TabIndex        =   84
         TabStop         =   0   'False
         Top             =   1470
         Visible         =   0   'False
         Width           =   8715
         _ExtentX        =   15372
         _ExtentY        =   3757
         _Version        =   393216
         Cols            =   10
         FixedCols       =   0
         ForeColorFixed  =   -2147483640
         BackColorBkg    =   16777215
         BackColorUnpopulated=   -2147483634
         AllowBigSelection=   0   'False
         ScrollTrack     =   -1  'True
         FocusRect       =   0
         HighLight       =   0
         ScrollBars      =   2
         Appearance      =   0
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         _NumberOfBands  =   1
         _Band(0).Cols   =   10
         _Band(0).GridLinesBand=   1
         _Band(0).TextStyleBand=   0
         _Band(0).TextStyleHeader=   0
      End
      Begin MSHierarchicalFlexGridLib.MSHFlexGrid grdRevenue 
         Height          =   2730
         Left            =   2850
         TabIndex        =   85
         TabStop         =   0   'False
         Top             =   1470
         Visible         =   0   'False
         Width           =   9315
         _ExtentX        =   16431
         _ExtentY        =   4815
         _Version        =   393216
         Cols            =   14
         FixedCols       =   0
         ForeColorFixed  =   -2147483640
         BackColorBkg    =   16777215
         BackColorUnpopulated=   -2147483634
         AllowBigSelection=   0   'False
         ScrollTrack     =   -1  'True
         FocusRect       =   0
         HighLight       =   0
         ScrollBars      =   2
         Appearance      =   0
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Arial"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         _NumberOfBands  =   1
         _Band(0).Cols   =   14
         _Band(0).GridLinesBand=   1
         _Band(0).TextStyleBand=   0
         _Band(0).TextStyleHeader=   0
      End
      Begin VB.ListBox lbcWeek 
         Appearance      =   0  'Flat
         Height          =   2340
         Left            =   1485
         TabIndex        =   86
         Top             =   1620
         Visible         =   0   'False
         Width           =   1245
      End
      Begin VB.Label lacWeek 
         Alignment       =   2  'Center
         Appearance      =   0  'Flat
         Caption         =   "Billed Week"
         ForeColor       =   &H80000008&
         Height          =   225
         Left            =   3780
         TabIndex        =   88
         Top             =   1425
         Visible         =   0   'False
         Width           =   1260
      End
      Begin VB.Label lacMonth 
         Alignment       =   2  'Center
         Appearance      =   0  'Flat
         Caption         =   "Billed Month"
         ForeColor       =   &H80000008&
         Height          =   225
         Left            =   120
         TabIndex        =   87
         Top             =   1440
         Visible         =   0   'False
         Width           =   1260
      End
      Begin VB.Label lacUndoReconc 
         Alignment       =   2  'Center
         BackColor       =   &H000000FF&
         BorderStyle     =   1  'Fixed Single
         ForeColor       =   &H00FFFFFF&
         Height          =   1335
         Left            =   8400
         TabIndex        =   71
         Top             =   105
         Visible         =   0   'False
         Width           =   2655
         WordWrap        =   -1  'True
      End
      Begin VB.Label lacUndoReason 
         Alignment       =   2  'Center
         BackColor       =   &H00C0FFFF&
         BorderStyle     =   1  'Fixed Single
         Height          =   240
         Left            =   1035
         TabIndex        =   70
         Top             =   4635
         Visible         =   0   'False
         Width           =   6900
      End
   End
   Begin VB.PictureBox pbcClickFocus 
      Appearance      =   0  'Flat
      BorderStyle     =   0  'None
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H80000008&
      Height          =   165
      Left            =   300
      ScaleHeight     =   165
      ScaleWidth      =   120
      TabIndex        =   48
      TabStop         =   0   'False
      Top             =   6750
      Width           =   120
   End
   Begin VB.TextBox edcLinkSrceDoneMsg 
      Appearance      =   0  'Flat
      Height          =   285
      Left            =   5295
      TabIndex        =   50
      TabStop         =   0   'False
      Top             =   30
      Visible         =   0   'False
      Width           =   525
   End
   Begin VB.TextBox edcLinkDestHelpMsg 
      Appearance      =   0  'Flat
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Left            =   5490
      TabIndex        =   49
      TabStop         =   0   'False
      Top             =   -60
      Visible         =   0   'False
      Width           =   570
   End
   Begin VB.TextBox edcLinkSrceHelpMsg 
      Appearance      =   0  'Flat
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Left            =   4140
      TabIndex        =   51
      TabStop         =   0   'False
      Top             =   30
      Visible         =   0   'False
      Width           =   525
   End
   Begin MSComDlg.CommonDialog cdcSetup 
      Left            =   6525
      Top             =   45
      _ExtentX        =   847
      _ExtentY        =   847
      _Version        =   393216
      DefaultExt      =   ".Txt"
      Filter          =   "*.Txt|*.Txt|*.Doc|*.Doc|*.Asc|*.Asc"
      FilterIndex     =   1
      FontSize        =   0
      MaxFileSize     =   256
   End
   Begin VB.ListBox lbcSortAgyAdvtDir 
      Appearance      =   0  'Flat
      Height          =   240
      Left            =   5100
      Sorted          =   -1  'True
      TabIndex        =   67
      TabStop         =   0   'False
      Top             =   0
      Visible         =   0   'False
      Width           =   1995
   End
   Begin VB.Image imcHelp 
      Appearance      =   0  'Flat
      Height          =   345
      Left            =   60
      Top             =   6570
      Visible         =   0   'False
      Width           =   360
   End
   Begin VB.Menu mnuTools 
      Caption         =   "Tools"
      Visible         =   0   'False
      Begin VB.Menu mnuTestPDFEmail 
         Caption         =   "Test PDF Email (not really sent)"
      End
   End
End
Attribute VB_Name = "Invoice"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
' Copyright 1993 Counterpoint Software, Inc. All rights reserved.
' Proprietary Software, Do not copy
'
' File Name: Invoice.Frm
'
' Release: 1.0
'
' Description:
'   This file contains the Invoice input screen code
Option Explicit
Option Compare Text
Dim imFirstActivate As Integer

Dim hmUnposted As Integer
Dim hmExport As Integer
Dim smExportCntrName As String
Dim imCntrExported As Integer 'Contract exported (True/False)
Dim imGenCntrExport As Integer  'True if any Sales Source is "E" or "F"
Dim imChkHistory As Integer 'Check History when looking at receivable- Set to True if updating into history
Dim bmIncludeMG As Boolean
Dim imInvGenType As Integer '0=Broadcast; 1=Remote

Dim tmSpeedSortParse() As SPEEDSORTPARSE
Dim tmReadClf() As READCLF
Dim lmRecCount As Long
Dim smTime1 As String
Dim smTime2 As String

Dim smStdDateMsg As String
Dim smCalDateMsg As String
Dim bmPrelByFull As Boolean
Dim smWkDateMsg As String

'tgSort- As Aired Billing: Schedule, Missed and cancelled spots create one record
'                          MG spots create two records if not package line or if package line it is Billed as Aired
'                          MG spots create one record if Hidden line and Package line is Billed as Ordered
'        As Order Billing: Create one record for all record spot types
'
Dim imLbcKeyIndex As Integer
Dim imTerminate As Integer  'True = terminating task, False= OK
Dim imFirstTime As Integer
Dim imVirtBillMethod As Integer 'Code not fixed when package added. 1=Show total price at top and all spots (plus vehicle name)
                                'Code not fixed when package added. 2=Show total price at top and only spots for first vehicle
                                '3=Show spots only for first vehicle and spots prices on each spot
'Vehicle
Dim hmVef As Integer            'Vehicle file handle
Dim tmVef As VEF                'VEF record image
Dim tmInvRptVef As VEF
Dim tmVefSrchKey As INTKEY0         'VEF record image
Dim imVefRecLen As Integer          'VEF record length
Dim imBypassVehSelect As Integer    'Indicates if ignore vehicle selection
Dim imBypassAll As Integer          'Indicates to ignore ckcAll change
Dim tmVVef As VEF
Dim tmPkVef As VEF
Dim tmLnVef As VEF
Dim smBlkVefName As String
Dim imMnfVehGp3Mkt As Integer   'Market
Dim tmMVef() As VEF

Dim imExportCntr As Integer     'Export contract flag
Dim imRemoteCntr As Integer     'Remote contract flag (contract to be invoiced via import)
Dim lmPrevCombineCntrNo As Long
Dim tmRepMatch() As REPMATCH
Dim lmANAddedRvf() As Long      'rvfCode records to ber ignored as just added
Dim lmANAddedPhf() As Long

Public hmClf As Integer         'Contract line file handle
Dim tmClfSrchKey As CLFKEY0     'CLF record image
Dim tmClfSrchKey2 As LONGKEY0   'CLF key record image
Dim imClfRecLen As Integer      'CLF record length
Dim tmClf As CLF                'Line being processed
Dim tmPkClf As CLF              'Line being processed
Dim tmSpotClf As CLF            'Line associated with spots (this will be the same as tmClf except when processing bill as aired for package lines)
Public hmCff As Integer         'Contract line flight file handle
Dim tmCffSrchKey As CFFKEY0     'CFF record image
Dim tmCffSrchKey1 As LONGKEY0   'CFF record image
Dim imCffRecLen As Integer      'CFF record length
Dim tmCff As CFF
Dim tmWkDef() As WKDEF
Dim smCffPrice As String
'Contract games
Public hmCgf As Integer
Dim tmCgf As CGF                'Current flights for the line
Dim tmCGFSort() As CGFSORT
Dim imCgfRecLen As Integer
Dim tmCgfSrchKey1 As CGFKEY1
Dim tmCgfCff() As CFF
'Multi-Media Sold
Dim hmMsf As Integer
Dim tmMsf As MSF
Dim imMsfRecLen As Integer
Dim tmMsfSrchKey2 As MSFKEY2
'Multi-Media Events
Dim hmMgf As Integer
Dim tmMgf As MGF
Dim imMgfRecLen As Integer
Dim tmMgfSrchKey1 As MGFKEY1
'Game Schedule
Dim hmGsf As Integer
Dim tmGsf As GSF
Dim tmGsfSrchKey1 As GSFKEY1
Dim tmGsfSrchKey3 As GSFKEY3
Dim imGsfRecLen As Integer

Dim hmPif As Integer
Dim tmPif() As PIF

Dim hmIsr As Integer            'Invoice Sort file handle
Dim tmIsrSrchKey0 As ISRKEY0    'ISR record image
Dim tmIsrSrchKey1 As ISRKEY1    'ISR record image
Dim imIsrRecLen As Integer      'ISR record length
Dim tmIsr As ISR
Dim hmPsf As Integer            'Spot Detail file handle
Dim tmPsf As SDF                'SDF record image
Dim tmPsfSrchKey As SDFKEY0     'SDF record image
Dim imPsfRecLen As Integer      'SDF record length
Dim lmPSFCode() As Long         'PSF Record Position for clear and obtain
Dim tmPsfInfo() As PSFINFO      'Used for advertiser separation
Dim hmSdf As Integer            'Spot Detail file handle
Dim tmSdf As SDF                'SDF record image
Dim tmSdfSrchKey1 As SDFKEY1
Dim tmSdfSrchKey3 As LONGKEY0
Dim tmSdfSrchKey4 As SDFKEY4
Dim tmSdfSrchKey5 As LONGKEY0
Dim tmSdfSrchKey6 As SDFKEY6
Dim imSdfRecLen As Integer      'SDF record length
Dim hmSsf As Integer
Dim tmSsf As SSF                'SSF record image
Dim tmSsfSrchKey As SSFKEY0     'SSF key record image
Dim imSsfRecLen As Integer
Dim tmProg As PROGRAMSS
Dim tmAvail As AVAILSS
Dim tmSpot As CSPOTSS

'Gather Info file (Used to communicate to stand alone program that invoiced spots should be sent)
Dim tmGif As GIF                'GIF record image
Dim hmGif As Integer            'GIF Handle
Dim imGifRecLen As Integer      'GIF record length

Dim hmRhf As Integer            'RHF Handle
Dim imRhfRecLen As Integer      'RHF record length
Dim tmRhf As RHF                'RHF record image

Dim tmEff As EFF
Dim imEffRecLen As Integer
Dim hmEff As Integer
Dim tmEffSrchKey As LONGKEY0
Dim smEDIClientCode As String
Dim smEDIProductCode As String

Dim hmRlf As Integer
Dim lmLockRecCode As Long

Dim hmCef As Integer            'CEF Handle
Dim imCefRecLen As Integer      'CEF record length
Dim tmCef As CEF                'CEF record image
Dim smXferRepDBID() As String
Dim smXferChfCode() As String

Dim hmUaf As Integer
Dim tmUaf As UAF                'GSF record image
Dim tmUafSrchKey3 As UAFKEY3    'GSF key record image
Dim imUafRecLen As Integer      'GSF record length

Dim hmUrf As Integer
Dim tmUrf As URF                'URF record image
Dim tmUrfSrchKey As INTKEY0     'URF key record image
Dim imUrfRecLen As Integer      'URF record length

Dim hmIihf As Integer
Dim tmIihf As IIHF              'IIHF record image
Dim tmIihfSrchKey0 As LONGKEY0  'IIHF key record image
Dim tmIihfSrchKey1 As IIHFKEY1  'IIHF key record image
Dim tmIihfSrchKey2 As IIHFKEY2  'IIHF key record image
Dim tmIihfSrchKey3 As IIHFKEY3  'IIHF key record image
Dim imIihfRecLen As Integer     'IIHF record length
Dim smPostLogSource As String
Dim smSvPostLogSource As String
Dim bmUnpostedVehicleExist As Boolean

Dim hmApf As Integer
Dim tmApf As APF                'APF record image
Dim tmApfSrchKey0 As LONGKEY0   'APF key record image
Dim imApfRecLen As Integer      'APF record length

Dim lmGenDate As Long
Public smGenDate As String
Dim lmGenTime As Long
Public smGenTime As String

Public lmRemoteGenDate As Long
Public smRemoteGenDate As String
Public lmRemoteGenTime As Long
Public smRemoteGenTime As String
Dim smRepPrintDate As String    'Last Rep Print date, this is used to get new SBF records
Dim imPrintRepInv As Integer    'True=In Print Rep Invoice pass

'Market Information
Dim tmMktCode() As SORTCODE
Dim tmMktVefCode() As Integer
Dim tmInvVehicle() As SORTCODE
Dim smInvVehicleTag As String

Dim smTerms As String
Dim smTeamTag As String
Dim tmTeam() As MNF
Dim smVisitTeam As String
Dim smHomeTeam As String
Dim smAbbrVisitTeam As String
Dim smAbbrHomeTeam As String

Dim smUpdateMsg As String
Dim tmNTRCntStatus() As INVCNTRSTATUS
Dim imNTRStatusConflict As Integer
Dim tmAirCntStatus() As INVCNTRSTATUS
Dim imAirStatusConflict As Integer

'Statistic buckets
'Line being scheduled statistics
Dim imHour() As Integer         'Hour count (Index 1 for 12m-1a; Index 2 for 1a-2a;...)
Dim imDay() As Integer          'Day count (Index 1 for monday; Index 2 for tuesday;..)
Dim imQH() As Integer           'Quarter hour count (Index 1 for 0min to 15min; Index 2 for 15min to 30min;..)
                                    'time periods of the rate card program
                                    '(-1 if time period not defined).  This is used
                                    'to distribute the spots according to % defined
                                    'with each time period (% are normalized to the
                                    'smallest percent. i.e. 20%, 20%, 60% => 1.0, 1.0, 3.0)
Dim lmTBStartTime(0 To 7) As Long  'Allowed times if time buy. Index zero ignored
Dim lmTBEndTime(0 To 7) As Long    'Index zero ignored

'EDI
'Donovan (required fields only except address fields 2, 3 & 4 which are optional)
'   Record Type      Fields
'   Agency           21;;Name;Address 1;Address 2;Address 3;Address4;
'   Station          22;Call Letters;Media Type;Band;Station Name;Address 1;Address 2;
'                      Address 3;Address 4;CSI;
'   Payee            23;Name;Address 1;Address 2;Address 3;Address 4;
'   Invoice Header   31;;Salesperson;Advertiser Name;Product Name;Invoice Date;;Estimate #;
'                      Invoice #;Broadcast Month;Invoice Start Date;Invoice End Date;;;Contract Start Date;
'                      Contract End Date;;;Commissionable;
'   Schedule Line    41;Line #;Days of Week;StartT Time;End Time;;Rate (no dec point);# Spots;Line Start Date; Line End date;;;
'   Broadcast Detail 51;Aired Flag;Air Date;;Air Time;Length;ISCI;Rate (no dec point);
'   :
'   Spot Comment     52;Comment;
'   :
'   Broadcase Detail ....
'   Invoice Comment  33,Comment;
'   Invoice Total    34;;Gross Billed (no dec point);Agency Commission (no dec point);Net Due (no dec point);
'   Agency           ....
'   .
'   .
'   Invoice Total    ....
'   Transamission Total 12;# of Invoices;Gross Total;
'

Dim imXMidHandle As Integer 'How to handle spots that cross the last date of the billing period:
                            '0=Leave spot on airing date;
                            '1= changing airing date to last date of period and add messages;
                            '2=Bill spot in next period
Dim bmAddXMidMessage As String  'If true include message stored into smXMidMsgBottom
Dim smXMidMsgBottom As String
Dim smXMidMsgReconc As String

Dim smForm2Key As String * 124
Dim smNowDate As String
Dim lmNowDate As Long
Dim lmSpfStdDate As Long
Dim lmSpfCalDate As Long
Dim lmSafWkDate As Long

Dim bmCalCntrExist As Boolean    'Calendar billing cycle defined for a contract

'12/15/12
Dim bmCalBillExist As Boolean
Dim bmWeeklyBillExist As Boolean

Dim lmUndoInvDate As Long
Dim lmUndoInvWeek As Long
Dim imButtonIndex As Integer
Dim imRollbackReconcRequired As Integer

Dim imFullStd As Integer    'True = Full month invoicing
Dim imFullCal As Integer    'True = Full month invoicing
Dim imFullWk As Integer    'True = Full month invoicing
Dim imSvFullStd As Integer    'True = Full month invoicing
Dim imSvFullCal As Integer    'True = Full month invoicing
Dim imSvFullWk As Integer    'True = Full month invoicing

Public imBuildingAdvt As Integer 'Flag that indicates advteriser/invoice list box being build or sorted, ignore sort request
Dim lmAddItemLen As Long
Dim imShowMsg As Integer
Dim imGenInv As Integer 'True=Generating Invoices
Dim imUsingCrystal As Integer
Dim smDisclaimer As String
Dim smSyncDate As String
Dim smSyncTime As String
Dim smLogUserCode As String
Dim smFileName As String * 80
Dim tmSvSort() As TYPESORTKEY
Dim tmSortISR As TYPESORTISR
Dim imShowHelpMsg As Integer    'True=Show help message; False=Ignore help message system
Dim imUpdateAllowed As Integer
Dim lmTax1 As Long
Dim lmTax2 As Long

Dim imIgnoreSelAdvtRequest As Integer

Dim smStartInvTime As String
Dim smStartInvRpt As String
Dim smEndInvRpt As String
Dim smEndInvTime As String

Dim imFromCallRadioButton As Integer
Dim imObtainDateCalled As Integer

Dim tmRepSdf() As TYPESORTREPSPOTS

Dim tmViewListInfo() As VIEWLISTINFO
Dim imSeparateVefCode As Integer    'If tgSpf.sBCombine is N, retain vefcode is this field.  Used in mGetVefLockBox

Dim fmAdjFactorH As Single  'Width adjustment factor
Dim fmAdjFactorW As Single

'TTP 10622 - Invoice: exclude trade portion from "pay this amount" value shown on the final invoice page
Dim bmLastTradeSuppressNetAmount As Boolean
Dim smLastAgyAdvTradeSuppressNetAmount As String

Private imCtrlKey As Integer
Private imShiftKey As Integer
Private lmScrollTop As Long
Private lmLastClickedRow As Long
Private imLastAirTimeColSorted As Integer
Private imLastAirTimeSort As Integer
Private imLastRevenueColSorted As Integer
Private imLastRevenueSort As Integer

'10016
Private bmToggleAirAndNTR As Boolean
Private bmToggleTempSuppress As Boolean
Private imPDFEmailAllowed As PDFEmailAllowed
Private Enum PDFEmailAllowed
    combine
    AirOnly
    NtrOnly
End Enum
Const LBONE = 1

'Air Time selective
Const ATBILLINDEX = 0
Const ATADVTINDEX = 1
Const ATSPERSONINDEX = 2
Const ATCNTRNOINDEX = 3
Const ATCYCLEINDEX = 4
Const ATENDDATEINDEX = 5
Const ATSORTINDEX = 6
Const ATNAMESORTINDEX = 7
Const ATCHFCODEINDEX = 8
Const ATSELECTEDINDEX = 9   '-1=>Not allowed to be selected; 0=Allowed to be selected; 1=Selected

'Reprint/Undo selective
'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
Const EMAILINDEX = 0
Const AGYINDEX = 1
Const ADVTINDEX = 2
Const SOFFICEINDEX = 3
Const SPERSONINDEX = 4
Const CNTRNOINDEX = 5
Const INVNOINDEX = 6
Const CASHTRADEINDEX = 7
Const CYCLEINDEX = 8
Const TRANDATEINDEX = 9
Const SORTINDEX = 10
Const INDEXCODEINDEX = 11
Const SELECTEDINDEX = 12
Const EMAILSELECTEDINDEX = 13

'Prevent tooltip from flickering
Dim imLastCol As Integer
Dim imLastRow As Integer
Dim imPDFEmailArf As Integer 'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
'Dim bmSelectedEmail As Boolean 'TTP 1080 / TTP 10826 / TTP 10813
'*******************************************************
'*                                                     *
'*      Procedure Name:mNonAirTime_InvEnd              *
'*                                                     *
'*             Created:3/01/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: End of invoice processing      *
'*          ilCallFrom: 1=NTR; 3=Installment; 4=CPM    *
'*******************************************************
Private Sub mNonAirTime_InvEnd(ilCallFrom As Integer)
    Dim slStr As String
    Dim slDisplay As String
    Dim ilRet As Integer
    If rbcType(INVGEN_Final).Value Then
        ilRet = mUpdateInv(ilCallFrom)
    End If
    If rbcOutput(0).Value Then
        slDisplay = "D"
    Else
        slDisplay = "P"
    End If
    igRptCallType = INVOICESJOB
    igRptType = 2
    'Start Crystal report
    igChildDone = False 'edcLinkDestDoneMsg.Text = ""
    edcLinkSrceDoneMsg.Text = ""
    If (Not igStdAloneMode) And (imShowHelpMsg) Then
        If igTestSystem Then
            slStr = "Invoice^Test\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & smRemoteGenDate & "\" & smRemoteGenTime & "\" & slDisplay
        Else
            slStr = "Invoice^Prod\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & smRemoteGenDate & "\" & smRemoteGenTime & "\" & slDisplay
        End If
    Else
        If igTestSystem Then
            slStr = "Invoice^Test^NOHELP\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & smRemoteGenDate & "\" & smRemoteGenTime & "\" & slDisplay
        Else
            slStr = "Invoice^Prod^NOHELP\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & smRemoteGenDate & "\" & smRemoteGenTime & "\" & slDisplay
        End If
    End If
    If imCombineAirAndNTR Then
        slStr = slStr & "\6"    '6=Air+NTR invoice
    Else
        'TTP 10462 - Invoices: separate commerical and NTR setting results in blank air time invoices on version 8.1 - Pt. 2
        If ilCallFrom = 4 Then 'ilCallFrom - 1=NTR; 3=Installment; 4=CPM
            slStr = slStr & "\0"    '0=Air invoice?
        Else
            slStr = slStr & "\4"    '4=NTR invoice
        End If
    End If
    sgCommandStr = slStr & "\" & sgInvMonthYear & "\"
    If imCombineAirAndNTR Then
        gUserActivityLog "S", "Invoice: Output Air Time+NTR"
    Else
        gUserActivityLog "S", "Invoice: Output NTR"
    End If
    RptSelIn.Show vbModal
    If imCombineAirAndNTR Then
        gUserActivityLog "E", "Invoice: Output Air Time+NTR"
    Else
        gUserActivityLog "E", "Invoice: Output NTR"
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mNTR_GenIvr                     *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Generate IVR records for NTR    *
'*                                                     *
'*      1-24-05 If agency has tax1 off & tax 2 on,
'*          dont apply tax1 on NTR invoice when taxes
'*          apply
'*******************************************************
Sub mNTR_GenIvr(llInvoiceNo As Long)
    Dim ilSbf As Integer
    Dim ilImpactPrt As Integer
    Dim ilPass As Integer
    Dim ilFound As Integer
    Dim slPctTrade As String
    Dim ilVeh As Integer
    Dim slForm2Key As String
    Dim ilONoSpots As Integer
    Dim ilANoSpots As Integer
    Dim llOGross As Long
    Dim llAGross As Long
    Dim llANet As Long
    Dim slTGross As String
    Dim slTNet As String
    Dim slProduct As String
    Dim ilRvf As Integer
    Dim ilSRvf As Integer
    Dim slAgyRate As String
    Dim slGross As String
    Dim slNet As String
    Dim slAmount As String
    Dim slStr As String
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim llChfCode As Long
    Dim llSDate As Long
    Dim llEDate As Long
    Dim llInvNo As Long
    Dim llSbfDate As Long
    Dim llTax1 As Long
    Dim llTax2 As Long
    Dim slSDate As String
    Dim slEDate As String
    Dim ilIncInvNo As Integer
    Dim llReprintInvNo As Long
    Dim ilNowTime(0 To 1) As Integer        '10-31-01
    Dim ilTax1 As Integer                   '1-24-05
    Dim ilTax2 As Integer                   '1-24-05
    Dim llTax1Rate As Long
    Dim llTax2Rate As Long
    Dim slGrossNet As String
    Dim llAirNTRInvNo As Long
    Dim llIvrCode As Long
    Dim ilTest As Integer
    Dim ilEDIFlag As Integer
    Dim llUB As Long
    Dim tlIvr As IVR
    Dim ilAirNTRCombineIndex As Integer

    If Not imCombineAirAndNTR Then
        smRemoteGenDate = Format$(Now, "m/d/yy")
        lmRemoteGenDate = gDateValue(smRemoteGenDate)
        smRemoteGenTime = Format$(Now, "h:mm:ssAM/PM")
        lmRemoteGenTime = gTimeToLong(smRemoteGenTime, False)
        gPackDate smRemoteGenDate, tmIvr.iGenDate(0), tmIvr.iGenDate(1)
        gPackTime smRemoteGenTime, ilNowTime(0), ilNowTime(1)
        gUnpackTimeLong ilNowTime(0), ilNowTime(1), False, tmIvr.lGenTime
    Else
        smRemoteGenDate = smGenDate
        lmRemoteGenDate = gDateValue(smRemoteGenDate)
        smRemoteGenTime = smGenTime
        lmRemoteGenTime = gTimeToLong(smRemoteGenTime, False)
        gPackDate smGenDate, tmIvr.iGenDate(0), tmIvr.iGenDate(1)
        gPackTime smGenTime, ilNowTime(0), ilNowTime(1)
        gUnpackTimeLong ilNowTime(0), ilNowTime(1), False, tmIvr.lGenTime
    End If

    'Remove disclaimer from NTR
    'tmIvr.lDisclaimer = tgSpf.lBCxfDisclaimer

    ilIncInvNo = False
    ilEDIFlag = False
    imArfPDFEMailCode = -1

    tmIvr.lDisclaimer = 0
    ilImpactPrt = False
    tmIvr.lSpotKeyNo = 0
    ilSbf = LBound(tgSbfCntr)
    Do While ilSbf <= UBound(tgSbfCntr) - 1
        llChfCode = tgSbfCntr(ilSbf).tSbf.lChfCode
        llReprintInvNo = tgSbfCntr(ilSbf).lInvNo
        'Jim 1/19/07: Use sbf bill date unless it is less then last closing date
        ''Use todays date so that all sbf records for the contract will be on same invoice
        'llSbfDate = lmNTRDate   'lmNowDate    'tgSbfCntr(ilSbf).lSDate
        'gUnpackDateLong tgSbfCntr(ilSbf).tSbf.iDate(0), tgSbfCntr(ilSbf).tSbf.iDate(1), llSbfDate
        gUnpackDateLongError tgSbfCntr(ilSbf).tSbf.iDate(0), tgSbfCntr(ilSbf).tSbf.iDate(1), llSbfDate, "1:mNTR_GenIvr " & tgSbfCntr(ilSbf).tSbf.lCode
        tmChfSrchKey.lCode = llChfCode
        ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If ilRet = BTRV_ERR_NONE Then
            'See if the dates can be avoided- if not then set to earliest and latest date of sbf
            If tgChfInv.sBillCycle = "C" Then
                'NTR always billed as Std Broadcast period because of Billed and Booked Report
                'Jim 1/19/07: For transaction date use the sbd bill date unless it is prior to last closing period, then use one day after closing period
                'gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slSDate
                gUnpackDate tgSpf.iRPRP(0), tgSpf.iRPRP(1), slSDate
                slSDate = gIncOneDay(slSDate)
                slEDate = gObtainEndStd(slSDate)
                llSDate = gDateValue(slSDate)
                llEDate = gDateValue(slEDate)
                If llSbfDate < llSDate Then
                    llSbfDate = llSDate
                    If rbcType(INVGEN_Final).Value Then    'Final Invoice
                        Do
                            tmSbfSrchKey1.lCode = tgSbfCntr(ilSbf).tSbf.lCode
                            ilRet = btrGetEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                            If ilRet = BTRV_ERR_NONE Then
                                gPackDateLong llSDate, tgSbfCntr(ilSbf).tSbf.iDate(0), tgSbfCntr(ilSbf).tSbf.iDate(1)
                                ilRet = btrUpdate(hmSbf, tmSbf, imSbfRecLen)
                            End If
                        Loop While ilRet = BTRV_ERR_CONFLICT
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            Print #hmMsg, "mNTR_GenIvr: btrUpdate-Point 1, Sbf Error # " & Trim$(str$(ilRet))
                        End If
                    End If
                End If
                smEndCal = Format$(llSbfDate, "m/d/yy")
                lmEndCal = llSbfDate
                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then     '11-15-16 reprint, aff, undo or archive Determine invoice number
                    lmEndCal = tgSbfCntr(ilSbf).lInvDate
                    smEndCal = Format$(lmEndCal, "m/d/yy")
                    llSbfDate = lmEndCal
                End If
            ElseIf tgChfInv.sBillCycle = "W" Then
                gUnpackDate tgSpf.iRPRP(0), tgSpf.iRPRP(1), slSDate
                slSDate = gIncOneDay(slSDate)
                slEDate = gObtainNextSunday(slSDate)
                llSDate = gDateValue(slSDate)
                llEDate = gDateValue(slEDate)
                If llSbfDate < llSDate Then
                    llSbfDate = llSDate
                    If rbcType(INVGEN_Final).Value Then    'Final Invoice
                        Do
                            tmSbfSrchKey1.lCode = tgSbfCntr(ilSbf).tSbf.lCode
                            ilRet = btrGetEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                            If ilRet = BTRV_ERR_NONE Then
                                gPackDateLong llSDate, tgSbfCntr(ilSbf).tSbf.iDate(0), tgSbfCntr(ilSbf).tSbf.iDate(1)
                                ilRet = btrUpdate(hmSbf, tmSbf, imSbfRecLen)
                            End If
                        Loop While ilRet = BTRV_ERR_CONFLICT
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            Print #hmMsg, "mNTR_GenIvr: btrUpdate-Point 1, Sbf Error # " & Trim$(str$(ilRet))
                        End If
                    End If
                End If
                smEndWk = Format$(llSbfDate, "m/d/yy")
                lmEndWk = llSbfDate
                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then     '11-15-16 reprint, aff, undo or archive Determine invoice number
                    lmEndWk = tgSbfCntr(ilSbf).lInvDate
                    smEndWk = Format$(lmEndWk, "m/d/yy")
                    llSbfDate = lmEndWk
                End If
            Else
                'Jim 1/19/07: For transaction date use the sbd bill date unless it is prior to last closing period, then use one day after closing period
                'gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slSDate
                gUnpackDate tgSpf.iRPRP(0), tgSpf.iRPRP(1), slSDate
                slSDate = gIncOneDay(slSDate)
                slEDate = gObtainEndStd(slSDate)
                llSDate = gDateValue(slSDate)
                llEDate = gDateValue(slEDate)
                'Jim 1/19/07: For transaction date use the sbd bill date unless it is prior to last closing period, then use one day after closing period
                If llSbfDate < llSDate Then
                    llSbfDate = llSDate
                    If rbcType(INVGEN_Final).Value Then    'Final Invoice
                        Do
                            tmSbfSrchKey1.lCode = tgSbfCntr(ilSbf).tSbf.lCode
                            ilRet = btrGetEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                            If ilRet = BTRV_ERR_NONE Then
                                gPackDateLong llSDate, tgSbfCntr(ilSbf).tSbf.iDate(0), tgSbfCntr(ilSbf).tSbf.iDate(1)
                                ilRet = btrUpdate(hmSbf, tmSbf, imSbfRecLen)
                            End If
                        Loop While ilRet = BTRV_ERR_CONFLICT
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            Print #hmMsg, "mNTR_GenIvr: btrUpdate-Point 2, Sbf Error # " & Trim$(str$(ilRet))
                        End If
                    End If
                End If
                smEndStd = Format$(llSbfDate, "m/d/yy")
                lmEndStd = llSbfDate
                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then     '11-15-16 reprint,aff, undo, archuve Determine invoice number
                    lmEndStd = tgSbfCntr(ilSbf).lInvDate
                    smEndStd = Format$(lmEndStd, "m/d/yy")
                    llSbfDate = lmEndStd
                End If
            End If
            tgSortKey(UBound(tgSortKey)).lCntrNo = tgChfInv.lCntrNo
            tgSortKey(UBound(tgSortKey)).lChfCode = tgChfInv.lCode
            'Use todays date so that all sbf records show on same invoice
            tgSortKey(UBound(tgSortKey)).lSbfDate = llSbfDate
            tgSortKey(UBound(tgSortKey)).iType = 10
            'Moved to create rvf records
            'If rbcType(INVGEN_Final).Value Then
            '    tgSortKey(UBound(tgSortKey)).iBilled = True
            'Else
                tgSortKey(UBound(tgSortKey)).iBilled = False
            'End If
            ReDim Preserve tgSortKey(0 To UBound(tgSortKey) + 1) As TYPESORTKEY
            slPctTrade = gIntToStrDec(tgChfInv.iPctTrade, 0)
            slProduct = Trim$(tgChfInv.sProduct)
            For ilPass = 1 To 2 Step 1
                ilFound = False
                If (ilPass = 1) And (tgChfInv.iPctTrade <> 100) Then
                    ilFound = True
                End If
                If (ilPass = 2) And (tgChfInv.iPctTrade <> 0) Then
                    ilFound = True
                End If
                
                'L.Bianchi 07/07/2021
                If rbcType(INVGEN_Reprint).Value And ilPass = 1 Then
                    If tgSbfCntr(ilSbf).sCashTrade <> "C" Then
                        ilFound = False
                     End If
                End If
                If rbcType(INVGEN_Reprint).Value And ilPass = 2 Then
                    If tgSbfCntr(ilSbf).sCashTrade <> "T" Then
                        ilFound = False
                    End If
                End If
                
                If ilFound Then
                    'Determine Aired Gross, Ordered number of spots, Aired number of Spots
                    llOGross = 0
                    llAGross = 0
                    llANet = 0
                    ilONoSpots = 0
                    ilANoSpots = 0
                    llChfCode = tgChfInv.lCode
                    ilFound = True
                    ilIncInvNo = False
                    ilEDIFlag = False
                    imArfPDFEMailCode = -1
                    ilAirNTRCombineIndex = -1
                    If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then      '11-15-16 repirnt, aff, undo, archive Determine invoice number
                        ilFound = True
                        llInvoiceNo = llReprintInvNo
                        llAirNTRInvNo = llReprintInvNo
                        llIvrCode = 0
                        If imCombineAirAndNTR Then
                            For ilTest = LBound(tmAirNTRCombine) To UBound(tmAirNTRCombine) - 1 Step 1
                                If tmAirNTRCombine(ilTest).lChfCode = tgSbfCntr(ilSbf).tSbf.lChfCode Then
                                    If ((ilPass = 1) And (tmAirNTRCombine(ilTest).sCashTrade = "C")) Or ((ilPass = 2) And (tmAirNTRCombine(ilTest).sCashTrade = "T")) Then
                                        llIvrCode = tmAirNTRCombine(ilTest).lIvrCode
                                        ilEDIFlag = tmAirNTRCombine(ilTest).iEDIFlag
                                        imArfPDFEMailCode = tmAirNTRCombine(ilTest).iArfPDFEMailCode
                                        ilAirNTRCombineIndex = ilTest
                                        Exit For
                                    End If
                                End If
                            Next ilTest
                        End If
                    Else
                        'Determine invoice number
                        llAirNTRInvNo = -1
                        llIvrCode = 0
                        If imCombineAirAndNTR Then
                            For ilTest = LBound(tmAirNTRCombine) To UBound(tmAirNTRCombine) - 1 Step 1
                                If tmAirNTRCombine(ilTest).lChfCode = tgSbfCntr(ilSbf).tSbf.lChfCode Then
                                    If ((ilPass = 1) And (tmAirNTRCombine(ilTest).sCashTrade = "C")) Or ((ilPass = 2) And (tmAirNTRCombine(ilTest).sCashTrade = "T")) Then
                                        llAirNTRInvNo = tmAirNTRCombine(ilTest).lInvNo
                                        llIvrCode = tmAirNTRCombine(ilTest).lIvrCode
                                        ilEDIFlag = tmAirNTRCombine(ilTest).iEDIFlag
                                        imArfPDFEMailCode = tmAirNTRCombine(ilTest).iArfPDFEMailCode
                                        ilAirNTRCombineIndex = ilTest
                                        Exit For
                                    End If
                                End If
                            Next ilTest
                        End If
                        If ilPass = 1 Then
                            ilFound = Not mRvfExist(llInvNo, 1, tgSbfCntr(ilSbf).tSbf.lCode, "C")
                        Else
                            ilFound = Not mRvfExist(llInvNo, 1, tgSbfCntr(ilSbf).tSbf.lCode, "T")
                        End If
                        If ilFound Then
                            If llAirNTRInvNo = -1 Then
                                ilIncInvNo = True
                                llAirNTRInvNo = llInvoiceNo
                            End If
                        End If
                    End If

                    If ilFound Then
                        tmChf = tgChfInv
                        mGetComment
                        mGetAdfAgfSlf
                        ''mGenHeader ilImpactPrt, llInvoiceNo, ilPageNo, ilPass, slPctTrade, 1, True
                        llUB = UBound(tmAirNTRCombine)
                        'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81; Add Contract # so that the contract can be checked for AirTime/CPM & NTR to determine if Header should show NTR
                        mGenHeader ilImpactPrt, llAirNTRInvNo, ilPass, slPctTrade, 1, True, ilEDIFlag, tgChfInv.lCntrNo
                        If llUB <> UBound(tmAirNTRCombine) Then
                            For ilTest = LBound(tmAirNTRCombine) To UBound(tmAirNTRCombine) - 1 Step 1
                                If tmAirNTRCombine(ilTest).lChfCode = tmPcf.lChfCode Then
                                    If ((ilPass = 1) And (tmAirNTRCombine(ilTest).sCashTrade = "C")) Or ((ilPass = 2) And (tmAirNTRCombine(ilTest).sCashTrade = "T")) Then
                                        llIvrCode = tmAirNTRCombine(ilTest).lIvrCode
                                        ilEDIFlag = tmAirNTRCombine(ilTest).iEDIFlag
                                        imArfPDFEMailCode = tmAirNTRCombine(ilTest).iArfPDFEMailCode
                                        ilAirNTRCombineIndex = ilTest
                                        Exit For
                                    End If
                                End If
                            Next ilTest
                        End If

                        slForm2Key = mRepInv_BuildKey()
                        slTNet = ".00"
                        slTGross = ".00"
                        llTax1 = 0
                        llTax2 = 0
                        ilTax1 = False      '1-24-05 assume no taxes apply
                        ilTax2 = False
                        If tmChf.iAgfCode > 0 Then      'agency applies, overrides the advt
                            'see if the taxes apply on the agy
                            '12/17/06-Change to tax by agency or vehicle
                            'If tmAgf.sSlsTax(0) = "Y" Then
                            '    ilTax1 = True
                            'End If
                            'If tmAgf.sSlsTax(1) = "Y" Then
                            '    ilTax2 = True
                            'End If
                        Else
                            'see if the taxes apply on direct adv
                            '12/17/06-Change to tax by agency or vehicle
                            'If tmAdf.sSlsTax(0) = "Y" Then
                            '    ilTax1 = True
                            'End If
                            'If tmAdf.sSlsTax(1) = "Y" Then
                            '    ilTax2 = True
                            'End If
                        End If
                        For ilLoop = ilSbf To UBound(tgSbfCntr) - 1 Step 1
                                'Fix Invoices per Jason Email Wed 6/15/22 - RE: v71 NTR/Installment reprint testing
                            If tgSbfCntr(ilLoop).tSbf.iNoItems <> 0 Then
                            If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then      '11-15-16 reprint, aff, undo, archive Determine invoice number
                                If (llChfCode <> tgSbfCntr(ilLoop).tSbf.lChfCode) Or (llReprintInvNo <> tgSbfCntr(ilLoop).lInvNo) Then
                                    Exit For
                                End If
                            Else
                                If (llChfCode <> tgSbfCntr(ilLoop).tSbf.lChfCode) Then
                                    Exit For
                                End If
                            End If
                            If (tmChf.iAgfCode > 0) And (tgSbfCntr(ilLoop).tSbf.sAgyComm = "Y") And (ilPass = 1) Then   '(Val(slPctTrade) <> 100) Then
                                'gPDNToStr tmAgf.sComm, 2, slAgyRate
                                slAgyRate = gIntToStrDec(tmAgf.iComm, 2)
                                tmIvr.iPctComm = tmAgf.iComm
                            'ElseIf (tmChf.iAgfCode > 0) And (tmChf.sAgyCTrade = "Y") And (tgSbfCntr(ilLoop).tSbf.sAgyComm = "Y") And (ilPass = 2) Then   '(Val(slPctTrade) <> 100) Then
                            ElseIf (tmChf.iAgfCode > 0) And (tgSbfCntr(ilLoop).tSbf.sAgyComm = "Y") And (ilPass = 2) Then    '(Val(slPctTrade) <> 100) Then
                                'gPDNToStr tmAgf.sComm, 2, slAgyRate
                                slAgyRate = gIntToStrDec(tmAgf.iComm, 2)
                                tmIvr.iPctComm = tmAgf.iComm
                            Else
                                slAgyRate = ""
                                tmIvr.iPctComm = 0
                            End If
                            'TTP 10517 - Invoices: if "ad server" option is not checked on, and "commercial and NTR" invoices are set to be separate, the air time portion of the invoice does not print
                            'If imCombineAirAndNTR Then
                            '    tmIvr.iType = IVRTYPE_TotalNTR
                            'Else
                            '    tmIvr.iType = IVRTYPE_TotalVefMkt
                            'End If
                            tmIvr.iType = IVRTYPE_NTR 'NTR Item
                            tmIvr.iLineNo = 0           '1-12-05
                            tmIvr.iRdfCode = 0          '4/14/11
                            tmIvr.sADayDate = ""
                            tmIvr.iPrgEnfCode = 0
                            tmIvr.sOVehName = "Vehicle Name Missing"
                            'For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                            '    If (tgSbfCntr(ilLoop).tSbf.iBillVefCode = tgMVef(ilVeh).iCode) Then
                                ilVeh = gBinarySearchVef(tgSbfCntr(ilLoop).tSbf.iBillVefCode)
                                If ilVeh <> -1 Then
                                    tmIvr.sOVehName = tgMVef(ilVeh).sName
                            '        Exit For
                                End If
                            'Next ilVeh
                            'Description will be obtained directly from the sbf record
                            tmIvr.lSpotKeyNo = tgSbfCntr(ilLoop).tSbf.lCode
                            'Amount/item
                            llAGross = tgSbfCntr(ilLoop).tSbf.lGross
                            slGross = gLongToStrDec(llAGross, 2)
                            'Moved because trade/cash split on amount/item and total amount (amount/item times # Items)
                            'gFormatStr slGross, FMTCOMMA, 2, tmIvr.sORate
                            'slGross = gMulStr(slGross, Trim$(Str$(tgSbfCntr(ilLoop).tSbf.iNoItems)))
                            'slAmount = slGross  'gMulStr(slGross, Trim$(Str$(tmIvr.iOTotalSpots)))
                            'gFormatStr slAmount, FMTCOMMA, 2, tmIvr.sRAmount
                            If ilPass = 1 Then
                                If Val(slPctTrade) <> 100 Then
                                    slGross = gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100")
                                End If
                                gFormatStr slGross, FMTCOMMA, 2, tmIvr.sORate
                                slGross = gMulStr(slGross, Trim$(str$(tgSbfCntr(ilLoop).tSbf.iNoItems)))
                                If slAgyRate = "" Then
                                    slStr = slGross
                                Else
                                    slStr = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                                End If
                            ElseIf ilPass = 2 Then
                                If Val(slPctTrade) <> 100 Then
                                    slGross = gSubStr(slGross, gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100"))
                                End If
                                gFormatStr slGross, FMTCOMMA, 2, tmIvr.sORate
                                slGross = gMulStr(slGross, Trim$(str$(tgSbfCntr(ilLoop).tSbf.iNoItems)))
                                If slAgyRate = "" Then
                                    slStr = slGross
                                Else
                                    slStr = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                                End If
                            End If
                            slNet = slStr
                            slTNet = gAddStr(slTNet, slStr)

                            tgSbfCntr(ilLoop).lNTRNet = gStrDecToLong(slStr, 2)
                            '12/17/06-Change to tax by agency or vehicle
                            'If (tgSpf.iBTax(0) <> 0) And (tgSbfCntr(ilLoop).tSbf.sSlsTax = "Y") And (ilTax1 = True) Then
                            If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then      '11-15-16 reprint, aff, archive Determine invoice number
                                llTax1 = llTax1 + tgSbfCntr(ilLoop).lTax1
                                llTax2 = llTax2 + tgSbfCntr(ilLoop).lTax2
                            Else
                                tgSbfCntr(ilLoop).lTax1 = 0
                                tgSbfCntr(ilLoop).lTax2 = 0
                                If ilPass = 1 Then
                                    If ((Asc(tgSpf.sUsingFeatures3) And TAXONAIRTIME) = TAXONAIRTIME) Or ((Asc(tgSpf.sUsingFeatures3) And TAXONNTR) = TAXONNTR) Then
                                        If ((ilPass = 1) And ((Asc(tgSpf.sUsingFeatures4) And TAXBYUSA) = TAXBYUSA)) Or ((Asc(tgSpf.sUsingFeatures4) And TAXBYCANADA) = TAXBYCANADA) Then
                                            gGetNTRTaxRates tgSbfCntr(ilLoop).tSbf.iTrfCode, llTax1Rate, llTax2Rate, slGrossNet
                                            If llTax1Rate > 0 Then
                                                '12/17/06-Change to tax by agency or vehicle
                                                'tgSbfCntr(ilLoop).tSbf.lTax1 = gStrDecToLong(gRoundStr(gMulStr(slStr, gIntToStrDec(tgSpf.iBTax(0), 4)), ".01", 2), 2)
                                                'llTax1 = llTax1 + tgSbfCntr(ilLoop).tSbf.lTax1
                                                ''Don't set tax amount into sbf because only one record and cash/trade might not be 50% so tax amount would be different
                                                ''tgSbfCntr(ilLoop).tSbf.lTax1 = 0
                                                'If (Asc(tgSpf.sUsingFeatures4) And TAXBYUSA) = TAXBYUSA Then
                                                If slGrossNet = "G" Then
                                                    'Compute from Gross amount
                                                    slStr = slGross
                                                'ElseIf (Asc(tgSpf.sUsingFeatures4) And TAXBYCANADA) = TAXBYCANADA Then
                                                ElseIf slGrossNet = "N" Then
                                                    'Compute from Net amount
                                                    slStr = slNet
                                                End If
                                                tgSbfCntr(ilLoop).lTax1 = gStrDecToLong(gRoundStr(gDivStr(gMulStr(slStr, gLongToStrDec(llTax1Rate, 4)), "100."), ".01", 2), 2)
                                                llTax1 = llTax1 + tgSbfCntr(ilLoop).lTax1
                                            Else
                                                '12/17/06-Change to tax by agency or vehicle
                                                'tgSbfCntr(ilLoop).tSbf.lTax1 = 0
                                            End If
                                            '12/17/06-Change to tax by agency or vehicle
                                            'If (tgSpf.iBTax(1) <> 0) And (tgSbfCntr(ilLoop).tSbf.sSlsTax = "Y") And (ilTax2 = True) Then
                                            If llTax2Rate > 0 Then
                                                '12/17/06-Change to tax by agency or vehicle
                                                'tgSbfCntr(ilLoop).tSbf.lTax2 = gStrDecToLong(gRoundStr(gMulStr(slStr, gIntToStrDec(tgSpf.iBTax(1), 4)), ".01", 2), 2)
                                                'llTax2 = llTax2 + tgSbfCntr(ilLoop).tSbf.lTax2
                                                ''tgSbfCntr(ilLoop).tSbf.lTax2 = 0
                                                'If (Asc(tgSpf.sUsingFeatures4) And TAXBYUSA) = TAXBYUSA Then
                                                If slGrossNet = "G" Then
                                                    'Compute from Gross amount
                                                    slStr = slGross
                                                'ElseIf (Asc(tgSpf.sUsingFeatures4) And TAXBYCANADA) = TAXBYCANADA Then
                                                ElseIf slGrossNet = "N" Then
                                                    'Compute from Net amount
                                                    slStr = slNet
                                                End If
                                                tgSbfCntr(ilLoop).lTax2 = gStrDecToLong(gRoundStr(gDivStr(gMulStr(slStr, gLongToStrDec(llTax2Rate, 4)), "100."), ".01", 2), 2)
                                                llTax2 = llTax2 + tgSbfCntr(ilLoop).lTax2
                                            Else
                                                '12/17/06-Change to tax by agency or vehicle
                                                'tgSbfCntr(ilLoop).tSbf.lTax2 = 0
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                            slTGross = gAddStr(slTGross, slGross)
                            tgSbfCntr(ilLoop).lNTRGross = gStrDecToLong(slGross, 2)
                            'Units/Item
                            tmIvr.sRRemark = ""
                            For ilVeh = LBound(tgNTRMnf) To UBound(tgNTRMnf) - 1 Step 1
                                If (tgSbfCntr(ilLoop).tSbf.iMnfItem = tgNTRMnf(ilVeh).iCode) Then
                                    tmIvr.sRRemark = tgNTRMnf(ilVeh).sUnitsPer
                                    Exit For
                                End If
                            Next ilVeh
                            '# Items
                            tmIvr.lOTotalSpots = tgSbfCntr(ilLoop).tSbf.iNoItems
                            slAmount = slGross  'gMulStr(slGross, Trim$(Str$(tmIvr.iOTotalSpots)))
                            gFormatStr slAmount, FMTCOMMA, 2, tmIvr.sRAmount
                            tmIvr.lATotalGross = 0
                            tmIvr.lATotalNet = 0
                            If imCombineAirAndNTR Then
                                tmIvr.sKey = slForm2Key & "4" & tmIvr.sOVehName
                            Else
                                tmIvr.sKey = slForm2Key & "2" & tmIvr.sOVehName
                            End If
                            If imCombineAirAndNTR Then
                                If tgChfInv.sBillCycle = "C" Then
                                    gPackDateLong lmSvStartCal, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
                                    gPackDateLong lmSvEndCal, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
                                ElseIf tgChfInv.sBillCycle = "W" Then
                                    gPackDateLong lmSvStartWk, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
                                    gPackDateLong lmSvEndWk, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
                                Else
                                    gPackDateLong lmSvStartStd, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
                                    gPackDateLong lmSvEndStd, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
                                End If
                            End If
                            tmIvr.iFormType = 1  'Force to Air
                            tmIvr.lCode = 0
                            tmIvr.lClfCxfCode = 0
                            tmIvr.lClfCode = 0
                            mGetInstallmentCounts tmChf ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
                            tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
                            tmIvr.iTotalInstallInvs = imTotalInstallInvs
                            tmIvr.sInstallCntr = tmChf.sInstallDefined
                            tmIvr.sEDIComment = ""
                            tmIvr.lDisclaimer = 0
                            ilRet = mDetermineIfEDIRequired()
                            ilRet = mInsertIVRandClearDollars(ilEDIFlag, tmIvr)
                            If imCombineAirAndNTR Then
                                'TTP 10517 - Invoices: if "ad server" option is not checked on, and "commercial and NTR" invoices are set to be separate, the air time portion of the invoice does not print
                                If (tmIvr.iType = IVRTYPE_TotalAirtimeRep) Or (tmIvr.iType = IVRTYPE_TotalAdServer) Or (tmIvr.iType = IVRTYPE_TotalNTR) Or (tmIvr.iType = IVRTYPE_TotalInstallment) Or (tmIvr.iType = IVRTYPE_TotalCntr) Then
                                    LSet tmImr = tmIvr
                                    tmImr.lIvrCode = tmIvr.lCode
                                    tmImr.sUnused = ""
                                    'ilRet = btrInsert(hmImr, tmImr, imImrRecLen, INDEXKEY0)
                                    ilRet = mWriteImr(ilEDIFlag, tmImr)
                                    If ilRet <> BTRV_ERR_NONE Then
                                        If ilRet >= 30000 Then
                                            ilRet = csiHandleValue(0, 7)
                                        End If
                                        Print #hmMsg, "mNTR_GenIvr: btrInsert-Point 1, Imr Error # " & Trim$(str$(ilRet))
                                    End If
                                End If
                            End If
                             End If ' Fix Invoices per Jason Email Wed 6/15/22 - RE: v71 NTR/Installment reprint testing
                        Next ilLoop
                        'Now form type 3 record
                        'TTP 10517 - Invoices: if "ad server" option is not checked on, and "commercial and NTR" invoices are set to be separate, the air time portion of the invoice does not print
                        'If imCombineAirAndNTR Then
                        '    tmIvr.iType = IVRTYPE_TotalInstallment 'Installment Total?
                        'Else
                        '    tmIvr.iType = IVRTYPE_TotalAirtimeRep 'AirTime or REP Total
                        'End If
                        tmIvr.iType = IVRTYPE_TotalNTR '7=NTR Total

                        tmIvr.sOVehName = ""
                        tmIvr.sORate = ""
                        tmIvr.sRRemark = ""
                        tmIvr.sRAmount = ""
                        tmIvr.lOTotalSpots = 0  'ilONoSpots
                        tmIvr.lOTotalGross = 0  'llOGross
                        tmIvr.lATotalSpots = 0  'ilANoSpots
                        tmIvr.lATotalGross = gStrDecToLong(slTGross, 2)
                        tmIvr.lRTotalGross = 0
                        tmIvr.lATotalNet = gStrDecToLong(slTNet, 2)
                        tmIvr.lTax1 = llTax1
                        tmIvr.lTax2 = llTax2
                        tmIvr.lSpotKeyNo = 0
                        If imCombineAirAndNTR Then
                            tmIvr.sKey = slForm2Key & "5"
                        Else
                            tmIvr.sKey = slForm2Key & "3"
                        End If
                        If imCombineAirAndNTR Then
                            If tgChfInv.sBillCycle = "C" Then
                                gPackDateLong lmSvStartCal, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
                                gPackDateLong lmSvEndCal, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
                            ElseIf tgChfInv.sBillCycle = "W" Then
                                gPackDateLong lmSvStartWk, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
                                gPackDateLong lmSvEndWk, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
                            Else
                                gPackDateLong lmSvStartStd, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
                                gPackDateLong lmSvEndStd, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
                            End If
                        End If
                        tmIvr.lClfCxfCode = 0
                        tmIvr.lClfCode = 0
                        tmIvr.iFormType = 1  'Force to Air
                        tmIvr.lCode = 0
                        mGetInstallmentCounts tmChf ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
                        tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
                        tmIvr.iTotalInstallInvs = imTotalInstallInvs
                        tmIvr.sInstallCntr = tmChf.sInstallDefined
                        tmIvr.sEDIComment = ""
                        tmIvr.lDisclaimer = 0
                        ilRet = mInsertIVRandClearDollars(ilEDIFlag, tmIvr)
                        If imCombineAirAndNTR Then
                            'TTP 10517 - Invoices: if "ad server" option is not checked on, and "commercial and NTR" invoices are set to be separate, the air time portion of the invoice does not print
                            If (tmIvr.iType = IVRTYPE_TotalAirtimeRep) Or (tmIvr.iType = IVRTYPE_TotalAdServer) Or (tmIvr.iType = IVRTYPE_TotalNTR) Or (tmIvr.iType = IVRTYPE_TotalInstallment) Or (tmIvr.iType = IVRTYPE_TotalCntr) Then
                                LSet tmImr = tmIvr
                                tmImr.lIvrCode = tmIvr.lCode
                                tmImr.sUnused = ""
                                'ilRet = btrInsert(hmImr, tmImr, imImrRecLen, INDEXKEY0)
                                ilRet = mWriteImr(ilEDIFlag, tmImr)
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    Print #hmMsg, "mNTR_GenIvr: btrInsert-Point 2, Imr Error # " & Trim$(str$(ilRet))
                                End If
                            End If
                            tmIvr.iType = IVRTYPE_TotalCntr 'Contract Total
                            If llIvrCode > 0 Then
                                tmIvrSrchKey1.lCode = llIvrCode
                                ilRet = btrGetEqual(hmIvr, tlIvr, imIvrRecLen, tmIvrSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)
                                If ilRet = BTRV_ERR_NONE Then
                                    tmIvr.lATotalGross = tmIvr.lATotalGross + tlIvr.lATotalGross
                                    tmIvr.lATotalNet = tmIvr.lATotalNet + tlIvr.lATotalNet
                                    tmIvr.lTax1 = tmIvr.lTax1 + tlIvr.lTax1
                                    tmIvr.lTax2 = tmIvr.lTax2 + tlIvr.lTax2
                                    tmIvr.lDisclaimer = tlIvr.lDisclaimer
                                    'tmIvr.lComment(1) = tlIvr.lComment(1)
                                    'tmIvr.lComment(2) = tlIvr.lComment(2)
                                    'tmIvr.lComment(3) = tlIvr.lComment(3)
                                    'tmIvr.lComment(4) = tlIvr.lComment(4)
                                    tmIvr.lComment(0) = tlIvr.lComment(0)
                                    tmIvr.lComment(1) = tlIvr.lComment(1)
                                    tmIvr.lComment(2) = tlIvr.lComment(2)
                                    tmIvr.lComment(3) = tlIvr.lComment(3)
                                    tmIvr.sEDIComment = tlIvr.sEDIComment
                                    tmIvr.lClfCxfCode = tlIvr.lClfCxfCode
                                    tmIvr.lClfCode = tlIvr.lClfCode
                                End If
                            End If
                            tmIvr.lCode = 0
                            mGetInstallmentCounts tmChf ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
                            tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
                            tmIvr.iTotalInstallInvs = imTotalInstallInvs
                            tmIvr.sInstallCntr = tmChf.sInstallDefined
                            'Replace totals with Installment amounts
                            mResetIVRForInstallment tmIvr, ilPass
                            ''ilRet = btrInsert(hmIvr, tmIvr, imIvrRecLen, INDEXKEY1)
                            'ilRet = mWriteIvr(ilEDIFlag, tmIvr, tmChf)
                            If (ilAirNTRCombineIndex = -1) Or (ilAirNTRCombineIndex >= 0 And tlIvr.iType = IVRTYPE_TotalAirtimeRep And llIvrCode > 0) Or (llIvrCode <= 0) Then
                                ilRet = mWriteIvr(ilEDIFlag, tmIvr, tmChf)
                                If ((ilAirNTRCombineIndex >= 0 And tlIvr.iType = IVRTYPE_TotalAirtimeRep) And llIvrCode > 0) Or ((ilAirNTRCombineIndex >= 0) And (llIvrCode <= 0)) Then
                                    tmAirNTRCombine(ilAirNTRCombineIndex).lIvrCode = tmIvr.lCode
                                End If
                            
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    Print #hmMsg, "mNTR_GenIvr: btrInsert-Point 3, Ivr Error # " & Trim$(str$(ilRet))
                                End If
                                'TTP 10517 - Invoices: if "ad server" option is not checked on, and "commercial and NTR" invoices are set to be separate, the air time portion of the invoice does not print
                                If (tmIvr.iType = IVRTYPE_TotalAirtimeRep) Or (tmIvr.iType = IVRTYPE_TotalAdServer) Or (tmIvr.iType = IVRTYPE_TotalNTR) Or (tmIvr.iType = IVRTYPE_TotalInstallment) Or (tmIvr.iType = IVRTYPE_TotalCntr) Then
                                    LSet tmImr = tmIvr
                                    tmImr.lIvrCode = tmIvr.lCode
                                    tmImr.sUnused = ""
                                    'ilRet = btrInsert(hmImr, tmImr, imImrRecLen, INDEXKEY0)
                                    ilRet = mWriteImr(ilEDIFlag, tmImr)
                                    If ilRet <> BTRV_ERR_NONE Then
                                        If ilRet >= 30000 Then
                                            ilRet = csiHandleValue(0, 7)
                                        End If
                                        Print #hmMsg, "mNTR_GenIvr: btrInsert-Point 4, Imr Error # " & Trim$(str$(ilRet))
                                    End If
                                End If
                            Else
                                tmIvr.lCode = tlIvr.lCode
                                ilRet = btrUpdate(hmIvr, tmIvr, imIvrRecLen)
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    Print #hmMsg, "mNTR_GenIvr: btrInsert-Point 3, Ivr Error # " & Trim$(str$(ilRet))
                                End If
                            End If
                        End If
                        'Create RVF record
                        If rbcType(INVGEN_Final).Value Then

                            tgSortKey(UBound(tgSortKey) - 1).iBilled = True

                            ilRvf = UBound(tgRvf)
                            ilSRvf = ilRvf
                            tgRvf(ilRvf).lCode = 0
                            'Product- update prf now instead of after all invoices generated
                            tgRvf(ilRvf).lPrfCode = 0
                            If (Trim$(slProduct) <> "") Then
                                ilFound = False
                                tmPrfSrchKey.iAdfCode = tmChf.iAdfCode
                                ilRet = btrGetGreaterOrEqual(hmPrf, tmPrf, imPrfRecLen, tmPrfSrchKey, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point
                                Do While (ilRet = BTRV_ERR_NONE) And (tmPrf.iAdfCode = tmChf.iAdfCode) 'tmRvf.iAdfCode)
                                    If StrComp(Trim$(Trim$(slProduct)), Trim$(tmPrf.sName), 1) = 0 Then
                                        ilFound = True
                                        tgRvf(ilRvf).lPrfCode = tmPrf.lCode
                                        Exit Do
                                    End If
                                    ilRet = btrGetNext(hmPrf, tmPrf, imPrfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                                Loop
                                If (Not ilFound) And (rbcType(INVGEN_Final).Value) Then
                                    Do  'Loop until record updated or added
                                        tmPrf.lCode = 0
                                        tmPrf.iAdfCode = tmChf.iAdfCode
                                        tmPrf.sName = Trim$(slProduct)
                                        tmPrf.iMnfComp(0) = 0
                                        tmPrf.iMnfComp(1) = 0
                                        tmPrf.iMnfExcl(0) = 0
                                        tmPrf.iMnfExcl(1) = 0
                                        tmPrf.iUrfCode = tgUrf(0).iCode
                                        tmPrf.iRemoteID = tgUrf(0).iRemoteUserID
                                        tmPrf.lAutoCode = tmPrf.lCode
                                        ilRet = btrInsert(hmPrf, tmPrf, imPrfRecLen, INDEXKEY0)
                                    Loop While ilRet = BTRV_ERR_CONFLICT
                                    If ilRet <> BTRV_ERR_NONE Then
                                        If ilRet >= 30000 Then
                                            ilRet = csiHandleValue(0, 7)
                                        End If
                                        Print #hmMsg, "mNTR_GenIvr: btrInsert-Point 5, Prf Error # " & Trim$(str$(ilRet))
                                    End If
                                    If ilRet = BTRV_ERR_NONE Then
                                        tgRvf(ilRvf).lPrfCode = tmPrf.lCode
                                        Do
                                            tmPrf.iRemoteID = tgUrf(0).iRemoteUserID
                                            tmPrf.lAutoCode = tmPrf.lCode
                                            tmPrf.iSourceID = tgUrf(0).iRemoteUserID
                                            gPackDate smSyncDate, tmPrf.iSyncDate(0), tmPrf.iSyncDate(1)
                                            gPackTime smSyncTime, tmPrf.iSyncTime(0), tmPrf.iSyncTime(1)
                                            ilRet = btrUpdate(hmPrf, tmPrf, imPrfRecLen)
                                        Loop While ilRet = BTRV_ERR_CONFLICT
                                        If ilRet <> BTRV_ERR_NONE Then
                                            If ilRet >= 30000 Then
                                                ilRet = csiHandleValue(0, 7)
                                            End If
                                            Print #hmMsg, "mNTR_GenIvr: btrUpdate-Point 3, Prf Error # " & Trim$(str$(ilRet))
                                        End If
                                    Else
                                        tgRvf(ilRvf).lPrfCode = 0
                                    End If
                                End If
                            End If
                            tgRvf(ilRvf).iAgfCode = tmChf.iAgfCode
                            tgRvf(ilRvf).iAdfCode = tmChf.iAdfCode
                            tgRvf(ilRvf).iSlfCode = tmChf.iSlfCode(0)
                            tgRvf(ilRvf).lCntrNo = tmChf.lCntrNo
                            tgRvf(ilRvf).lInvNo = llAirNTRInvNo
                            tgRvf(ilRvf).lRefInvNo = 0
                            '6/7/15: Check number changed to string
                            'tgRvf(ilRvf).lCheckNo = llSbfDate   'should be 0 but temporary store llSbfDate so that RVF can be tied to tgSortKey
                            tgRvf(ilRvf).sCheckNo = Trim$(str$(llSbfDate))   'should be 0 but temporary store llSbfDate so that RVF can be tied to tgSortKey
                            If tmChf.sBillCycle = "C" Then
                                gPackDate smEndCal, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                            ElseIf tmChf.sBillCycle = "W" Then
                                gPackDate smEndWk, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                            Else
                                gPackDate smEndStd, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                            End If
                            tgRvf(ilRvf).sTranType = "IN"
                            tgRvf(ilRvf).sAction = " "
                            If tmChf.sBillCycle = "C" Then
                                tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndCal))
                                tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndCal))
                            ElseIf tmChf.sBillCycle = "W" Then
                                tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndWk))
                                tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndWk))
                            Else
                                slStr = gObtainEndStd(smEndStd)
                                tgRvf(ilRvf).iAgePeriod = Month(gDateValue(slStr))
                                tgRvf(ilRvf).iAgingYear = Year(gDateValue(slStr))
                            End If
                            gPackDate "", tgRvf(ilRvf).iPurgeDate(0), tgRvf(ilRvf).iPurgeDate(1)
                            'If Val(slPctTrade) = 100 Then
                            If ilPass = 2 Then
                                tgRvf(ilRvf).sCashTrade = "T"
                            Else
                                tgRvf(ilRvf).sCashTrade = "C"
                            End If
                            tgRvf(ilRvf).iPkLineNo = 0
                            tgRvf(ilRvf).iInvDate(0) = tgRvf(ilRvf).iTranDate(0)
                            tgRvf(ilRvf).iInvDate(1) = tgRvf(ilRvf).iTranDate(1)
                            gPackDate smNowDate, tgRvf(ilRvf).iDateEntrd(0), tgRvf(ilRvf).iDateEntrd(1)
                            tgRvf(ilRvf).iUrfCode = tgUrf(0).iCode
                            tgRvf(ilRvf).iRemoteID = 0
                            tgRvf(ilRvf).iMnfGroup = 0  'Participant MnfCode, set in mUpdateRvf if Sales Source is Ask
                            tgRvf(ilRvf).lCefCode = 0
                            tgRvf(ilRvf).sInCollect = "N"
                            tgRvf(ilRvf).iRemoteID = 0
                            tgRvf(ilRvf).iBacklogTrfCode = 0
                            '1/17/09: Added buyer
                            'tgRvf(ilRvf).sUnused = ""
                            tgRvf(ilRvf).iPnfBuyer = tmChf.iPnfBuyer
                            For ilLoop = ilSbf To UBound(tgSbfCntr) - 1 Step 1
                                ilRvf = UBound(tgRvf)
                                tgRvf(ilRvf).iBillVefCode = tgSbfCntr(ilLoop).tSbf.iBillVefCode
                                tgRvf(ilRvf).iAirVefCode = tgSbfCntr(ilLoop).tSbf.iAirVefCode
                                tgRvf(ilRvf).lRefInvNo = 0  'tgSbfCntr(ilLoop).tSbf.lRefInvNo
                                tgRvf(ilRvf).iMnfItem = tgSbfCntr(ilLoop).tSbf.iMnfItem
                                tgRvf(ilRvf).lSbfCode = tgSbfCntr(ilLoop).tSbf.lCode
                                tgRvf(ilRvf).lPcfCode = 0
                                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then      '11-15-16 reprint, aff, undo , archive Determine invoice number
                                    If (llChfCode <> tgSbfCntr(ilLoop).tSbf.lChfCode) Or (llReprintInvNo <> tgSbfCntr(ilLoop).lInvNo) Then
                                        Exit For
                                    End If
                                Else
                                    If (llChfCode <> tgSbfCntr(ilLoop).tSbf.lChfCode) Then
                                        Exit For
                                    End If
                                End If
                                'If (llChfCode <> tgSbfCntr(ilLoop).tSbf.lChfCode) Then
                                '    Exit For
                                'Else
                                    'Determine if same vehicle already created a rvf image- No since sbfcode stored into each record
                                    'ilFound = False
                                    'For ilLoop1 = ilSRvf To UBound(tgRvf) - 1 Step 1
                                    '    If (tgRvf(ilLoop1).lCntrNo = tmChf.lCntrNo) And (tgRvf(ilLoop1).iAirVefCode = tgRvf(ilRvf).iAirVefCode) And (tgRvf(ilLoop1).iBillVefCode = tgRvf(ilRvf).iBillVefCode) And (tgRvf(ilLoop1).sCashTrade = tgRvf(ilRvf).sCashTrade) Then
                                    '        If (tgRvf(ilLoop1).iTranDate(0) = tgRvf(ilRvf).iTranDate(0)) And (tgRvf(ilLoop1).iTranDate(1) = tgRvf(ilRvf).iTranDate(1)) Then
                                    '            ilFound = True
                                    '            Exit For
                                    '        End If
                                    '    End If
                                    'Next ilLoop1
                                    'If Not ilFound Then
                                    '    If (ilPass = 1) And (tmChf.iPctTrade <> 100) Then
                                    '        llAGross = tgSbfCntr(ilLoop).lAGross
                                    '        For ilLoop1 = ilLoop + 1 To UBound(tgSbfCntr) - 1 Step 1
                                    '            If (llChfCode <> tgSbfCntr(ilLoop1).tSbf.lChfCode) Then
                                    '                Exit For
                                    '            Else
                                    '                If (tgSbfCntr(ilLoop).tSbf.iAirVefCode = tgSbfCntr(ilLoop1).tSbf.iAirVefCode) And (tgSbfCntr(ilLoop).tSbf.iBillVefCode = tgSbfCntr(ilLoop1).tSbf.iBillVefCode) Then
                                    '                    llAGross = llAGross + tgSbfCntr(ilLoop1).lAGross
                                    '                End If
                                    '            End If
                                    '        Next ilLoop1
                                    '        slGross = gLongToStrDec(llAGross, 2)
                                    '        If Val(slPctTrade) <> 0 Then
                                    '            slGross = gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100")
                                    '        End If
                                    '        gStrToPDN slGross, 2, 6, tgRvf(ilRvf).sGross
                                    '        If slAgyRate = "" Then
                                    '            slStr = slGross
                                    '        Else
                                    '            slStr = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                                    '        End If
                                    '        gStrToPDN slStr, 2, 6, tgRvf(ilRvf).sNet
                                    '        ReDim Preserve tgRvf(0 To UBound(tgRvf) + 1) As RVF
                                    '        tgRvf(ilRvf + 1) = tgRvf(ilRvf)
                                    '    End If
                                    '    If (ilPass = 2) And (tmChf.iPctTrade <> 0) Then
                                    '        llAGross = tgSbfCntr(ilLoop).lAGross
                                    '        For ilLoop1 = ilLoop + 1 To UBound(tgSbfCntr) - 1 Step 1
                                    '            If (llChfCode <> tgSbfCntr(ilLoop1).tSbf.lChfCode) Then
                                    '                Exit For
                                    '            Else
                                    '                If (tgSbfCntr(ilLoop).tSbf.iAirVefCode = tgSbfCntr(ilLoop1).tSbf.iAirVefCode) And (tgSbfCntr(ilLoop).tSbf.iBillVefCode = tgSbfCntr(ilLoop1).tSbf.iBillVefCode) Then
                                    '                    llAGross = llAGross + tgSbfCntr(ilLoop1).lAGross
                                    '                End If
                                    '            End If
                                    '        Next ilLoop1
                                    '        slGross = gLongToStrDec(llAGross, 2)
                                    '        If Val(slPctTrade) <> 100 Then
                                    '            slGross = gSubStr(slGross, gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100"))
                                    '        End If
                                    '        gStrToPDN slGross, 2, 6, tgRvf(ilRvf).sGross
                                    '        If slAgyRate = "" Then
                                    '            slStr = slGross
                                    '        Else
                                    '            slStr = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                                    '        End If
                                    '        gStrToPDN slStr, 2, 6, tgRvf(ilRvf).sNet
                                    '        ReDim Preserve tgRvf(0 To UBound(tgRvf) + 1) As RVF
                                    '        tgRvf(ilRvf + 1) = tgRvf(ilRvf)
                                    '    End If
                                    'End If
                                    slGross = gLongToStrDec(tgSbfCntr(ilLoop).lNTRGross, 2)
                                    slNet = gLongToStrDec(tgSbfCntr(ilLoop).lNTRNet, 2)
                                    gStrToPDN slGross, 2, 6, tgRvf(ilRvf).sGross
                                    gStrToPDN slNet, 2, 6, tgRvf(ilRvf).sNet
                                    '12/17/06-Change to tax by agency or vehicle
                                    'tgRvf(ilRvf).lTax1 = tgSbfCntr(ilLoop).tSbf.lTax1
                                    'tgRvf(ilRvf).lTax2 = tgSbfCntr(ilLoop).tSbf.lTax2   '2-24-04
                                    'tgSbfCntr(ilLoop).tSbf.lTax1 = 0
                                    'tgSbfCntr(ilLoop).tSbf.lTax2 = 0
                                    tgRvf(ilRvf).lTax1 = tgSbfCntr(ilLoop).lTax1
                                    tgRvf(ilRvf).lTax2 = tgSbfCntr(ilLoop).lTax2
                                    tgSbfCntr(ilLoop).lTax1 = 0
                                    tgSbfCntr(ilLoop).lTax2 = 0
                                    tgRvf(ilRvf).lAcquisitionCost = 0
                                    'If tgSbfCntr(ilLoop).tSbf.lAcquisitionCost > 0 Then
                                        mBuildAcqWithCommInfo "NTR", tgRvf(ilRvf), tgSbfCntr(ilLoop).tSbf.lAcquisitionCost
                                        tgRvf(ilRvf).lAcquisitionCost = tgSbfCntr(ilLoop).tSbf.lAcquisitionCost * tgSbfCntr(ilLoop).tSbf.iNoItems
                                        If ilPass = 1 Then
                                            If Val(slPctTrade) <> 100 Then
                                                tgRvf(ilRvf).lAcquisitionCost = ((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100
                                            End If
                                        ElseIf ilPass = 2 Then
                                            If Val(slPctTrade) <> 100 Then
                                                tgRvf(ilRvf).lAcquisitionCost = tgRvf(ilRvf).lAcquisitionCost - (((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100)
                                            End If
                                        End If
                                    'End If

                                    ReDim Preserve tgRvf(0 To UBound(tgRvf) + 1) As RVF
                                    tgRvf(ilRvf + 1) = tgRvf(ilRvf)
                                'End If
                            Next ilLoop
                        End If
                        'llInvoiceNo = llInvoiceNo + 1
                        'If llInvoiceNo > tgSpf.lBHighestNo Then
                        '    llInvoiceNo = tgSpf.lBLowestNo
                        'End If
                        If ilIncInvNo Then
                            llInvoiceNo = llInvoiceNo + 1
                            'If llInvoiceNo > tgSpf.lBHighestNo Then
                            '    llInvoiceNo = tgSpf.lBLowestNo
                            'End If
                            mCheckNextInvNo llInvoiceNo
                        End If
                    End If
                End If
            Next ilPass
            'Advance ilSbf to next contract
            Do
                'If (llChfCode <> tgSbfCntr(ilSbf).tSbf.lChfCode) Then
                '    Exit Do
                'End If
                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then     '11-15-16 reprint, aff, undo, archive, Determine invoice number
                    If (llChfCode <> tgSbfCntr(ilSbf).tSbf.lChfCode) Or (llReprintInvNo <> tgSbfCntr(ilSbf).lInvNo) Then
                        Exit Do
                    End If
                Else
                    If (llChfCode <> tgSbfCntr(ilSbf).tSbf.lChfCode) Then
                        Exit Do
                    End If
                End If
                ilSbf = ilSbf + 1
            Loop While ilSbf <= UBound(tgSbfCntr) - 1
        End If
    Loop
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mNTR_ReadRec                    *
'*                                                     *
'*             Created:9/04/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Read NTR records               *
'*                                                     *
'*******************************************************
Function mNTR_ReadRec() As Integer
'
'   iRet = mRepInv_ReadRec
'   Where:
'       iRet (O)- True if record read,
'                 False if not read
'
    Dim ilRet As Integer    'Return status
    Dim slKey As String
    Dim slDate As String
    Dim ilAdd As Integer
    Dim ilLoop As Integer
    Dim ilIndex As Integer
    Dim ilFound As Integer
    Dim llEarliestDate As Long
    Dim ilIncludeNTR As Integer
    Dim ilBillCycle As Integer
    Dim llNTRDate As Long

    ReDim tgSbfCntr(0 To 0) As SBFCNTR
    ReDim tmNTRCntStatus(0 To 0) As INVCNTRSTATUS
    imNTRStatusConflict = False
    imSbfRecLen = Len(tmSbf)
    If (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Archive).Value) Then        '11-15-16 reprint or archive
        'Need to have created an array of sbf records to reprint
        ilRet = mNTR_BuildReprint()
    ElseIf (rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value) Then
        'ilBillCycle: 0=Std, 1=Calendar, 2=Weekly
        For ilBillCycle = 0 To 2 Step 1
            tmSbfSrchKey2.sTranType = "I"
            ilFound = False
            If ilBillCycle = 1 And ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked Then
                slDate = smStartCal
                For ilLoop = 1 To 3 Step 1
                    slDate = gDecOneDay(slDate)
                    slDate = gObtainStartCal(slDate)
                Next ilLoop
                ilFound = True
            ElseIf ilBillCycle = 2 And ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked Then
                slDate = DateAdd("d", -21, smStartWk)
                ilFound = True
            ElseIf ilBillCycle = 0 And ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked Then
                slDate = smStartStd
                For ilLoop = 1 To 3 Step 1
                    slDate = gDecOneDay(slDate)
                    slDate = gObtainStartStd(slDate)
                Next ilLoop
                ilFound = True
            End If
            If ilFound Then
                gPackDate slDate, tmSbfSrchKey2.iDate(0), tmSbfSrchKey2.iDate(1)
                ilRet = btrGetGreaterOrEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tmSbf.sTranType = "I")
                    If tmSbf.sBilled <> "Y" Then
                        If ((Asc(tgSpf.sUsingFeatures3) And USINGHUB) = USINGHUB) And (tgUrf(0).iMnfHubCode > 0) Then
                            ilRet = gBinarySearchVef(tmSbf.iBillVefCode)
                            If ilRet <> -1 Then
                                ilAdd = True
                            Else
                                ilAdd = False
                            End If
                        Else
                            ilAdd = True
                        End If
                        If ilAdd Then
                            If rbcCntr(INVCNTR_Selective).Value Or rbcCntr(INVCNTR_WOExpired).Value Or rbcCntr(INVCNTR_Posted).Value Then
                                ilAdd = False
                                For ilLoop = 0 To UBound(lmSelCntrCode) - 1 Step 1
                                    If tmSbf.lChfCode = lmSelCntrCode(ilLoop) Then
                                        ilAdd = True
                                        Exit For
                                    End If
                                Next ilLoop
                            End If
                        End If
                        If ilAdd Then
                            If (tgSpf.sInvVehSel = "Y") And (ckcAll.Value = vbUnchecked) Then
                                'ilAdd = False
                                'For ilIndex = 0 To UBound(tgInvVehCode) - 1 Step 1
                                '    If tgInvVehCode(ilIndex).iCode = tmSbf.iBillVefCode Then
                                '        ilAdd = True
                                '        Exit For
                                '    End If
                                'Next ilIndex
                                If Not mAllVehSel("F", tmSbf.lChfCode) Then
                                    ilAdd = False
                                End If
                            End If
                        End If
                        If ilAdd Then
                            If (ckcType(INVTYPE_Commercial).Value = vbUnchecked) And (ckcType(INVTYPE_NTR).Value = vbChecked) Then
                                'Only allow contract if no air time
                                ilRet = gObtainChfClf(hmCHF, hmClf, tmSbf.lChfCode, False, tgChfInv, tgClfInv())
                                If ((Asc(tgSpf.sUsingFeatures5) And COMBINEAIRNTR) = COMBINEAIRNTR) And (tgSpf.sUsingNTR = "Y") Then
                                    If UBound(tgClfInv) > LBound(tgClfInv) Then
                                        ilAdd = False
                                    End If
                                End If
                                If tgChfInv.sInstallDefined = "Y" Then
                                    ilAdd = False
                                End If
                            End If
                        End If
                        If ilAdd Then
                            If mSetNTRBillFlagIfMissing() Then
                                ilAdd = False
                            End If
                        End If
                        If ilAdd Then
                            slKey = Trim$(str$(tmSbf.lChfCode))
                            Do While Len(slKey) < 8
                                slKey = "0" & slKey
                            Loop
        
                            tmChfSrchKey.lCode = tmSbf.lChfCode
                            ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                            If (ilRet = BTRV_ERR_NONE) And (tgChfInv.sDelete = "N") And (tgChfInv.iCntRevNo = 0) And ((tgChfInv.sStatus = "W") Or (tgChfInv.sStatus = "C")) Then
                                tgChfInv.sDelete = "Y"
                            Else
                                If ilBillCycle = 1 And tgChfInv.sBillCycle <> "C" Then
                                    tgChfInv.sDelete = "Y"
                                ElseIf ilBillCycle = 2 And tgChfInv.sBillCycle <> "W" Then
                                    tgChfInv.sDelete = "Y"
                                ElseIf ilBillCycle = 0 And tgChfInv.sBillCycle <> "S" Then
                                    tgChfInv.sDelete = "Y"
                                End If
                            End If
                            If (ilRet = BTRV_ERR_NONE) And (tgChfInv.sDelete = "N") And (tgChfInv.sStatus <> "D") Then
                                ilFound = False
                                For ilIndex = 0 To UBound(tmNTRCntStatus) - 1 Step 1
                                    If tmNTRCntStatus(ilIndex).lCntrNo = tgChfInv.lCntrNo Then
                                        ilFound = True
                                        'gUnpackDateLong tmSbf.iDate(0), tmSbf.iDate(1), llEarliestDate
                                        gUnpackDateLongError tmSbf.iDate(0), tmSbf.iDate(1), llEarliestDate, "2:mNTR_ReadRec " & tmSbf.lCode
                                        If llEarliestDate < tmNTRCntStatus(ilIndex).lEarliestDate Then
                                            tmNTRCntStatus(ilIndex).lEarliestDate = llEarliestDate
                                        End If
                                        If (tgChfInv.sSchStatus = "F") Or (tgChfInv.sSchStatus = "M") Then
                                            tmNTRCntStatus(ilIndex).lChfCodeSchd = tgChfInv.lCode
                                            'If tmNTRCntStatus(ilIndex).lChfCodeAltered <> 0 Then
                                            '    imNTRStatusConflict = True
                                            'End If
                                        Else
                                            tmNTRCntStatus(ilIndex).lChfCodeAltered = tgChfInv.lCode
                                            tmNTRCntStatus(ilIndex).sSchStatus = tgChfInv.sSchStatus
                                            'If tmNTRCntStatus(ilIndex).lChfCodeSchd <> 0 Then
                                            '    imNTRStatusConflict = True
                                            'End If
                                        End If
                                    End If
                                Next ilIndex
                                If Not ilFound Then
                                    ilIndex = UBound(tmNTRCntStatus)
                                    tmNTRCntStatus(ilIndex).lCntrNo = tgChfInv.lCntrNo
                                    tmNTRCntStatus(ilIndex).iAdfCode = tgChfInv.iAdfCode
                                    tmNTRCntStatus(ilIndex).sSchStatus = ""
                                    'gUnpackDateLong tmSbf.iDate(0), tmSbf.iDate(1), tmNTRCntStatus(ilIndex).lEarliestDate
                                    gUnpackDateLongError tmSbf.iDate(0), tmSbf.iDate(1), tmNTRCntStatus(ilIndex).lEarliestDate, "3:mNTR_ReadRec " & tmSbf.lCode
                                    tmNTRCntStatus(ilIndex).sBillCycle = tgChfInv.sBillCycle
                                    If (tgChfInv.sSchStatus = "F") Or (tgChfInv.sSchStatus = "M") Then
                                        tmNTRCntStatus(ilIndex).lChfCodeSchd = tgChfInv.lCode
                                        tmNTRCntStatus(ilIndex).lChfCodeAltered = 0
                                    Else
                                        tmNTRCntStatus(ilIndex).lChfCodeSchd = 0
                                        tmNTRCntStatus(ilIndex).lChfCodeAltered = tgChfInv.lCode
                                        tmNTRCntStatus(ilIndex).sSchStatus = tgChfInv.sSchStatus
                                    End If
                                    ReDim Preserve tmNTRCntStatus(0 To ilIndex + 1) As INVCNTRSTATUS
                                End If
                            End If
                            If (ilRet = BTRV_ERR_NONE) And (tgChfInv.sDelete = "N") And (tgChfInv.sStatus <> "D") And ((tgChfInv.sSchStatus = "F") Or (tgChfInv.sSchStatus = "M")) Then
                                slKey = mCreateField1Key(tgChfInv) & slKey
                                gUnpackDate tmSbf.iDate(0), tmSbf.iDate(1), slDate
                                'If gDateValue(slDate) > lmNowDate Then
                                llNTRDate = lmNTRDate
                                If ilBillCycle = 1 Then
                                    llNTRDate = gDateValue(gObtainEndCal(Format(lmNTRDate, "m/d/yy")))
                                End If
                                If gDateValue(slDate) > llNTRDate Then  'lmNTRDate Then
                                    If Not rbcType(INVGEN_Final).Value Then
                                        Exit Do
                                    End If
                                Else
                                    ilIncludeNTR = True
                                    '7/24/12: Allow NTR to be billed thru today if not combining with contract
                                    If ((Asc(tgSpf.sUsingFeatures5) And COMBINEAIRNTR) = COMBINEAIRNTR) And (tgSpf.sUsingNTR = "Y") Then
                                        If tgChfInv.sBillCycle = "C" Then
                                            If (gDateValue(slDate) > lmEndCal) Or (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbUnchecked) Then 'Or (gDateValue(slDate) < lmStartCal) Then
                                                ilIncludeNTR = False
                                            End If
                                        ElseIf tgChfInv.sBillCycle = "W" Then
                                            If (gDateValue(slDate) > lmEndWk) Or (ckcBillCycle(INVBILLCYCLE_Week).Value = vbUnchecked) Then  'Or (gDateValue(slDate) < lmStartWk) Then
                                                ilIncludeNTR = False
                                            End If
                                        Else
                                            If (gDateValue(slDate) > lmEndStd) Or (ckcBillCycle(INVBILLCYCLE_STD).Value = vbUnchecked) Then 'Or (gDateValue(slDate) < lmStartStd) Then
                                                ilIncludeNTR = False
                                            End If
                                        End If
                                    End If
                                    If ilIncludeNTR Then
                                        For ilLoop = 1 To UBound(lmCPMBypassCntr) - 1 Step 1
                                            If lmCPMBypassCntr(ilLoop) = tgChfInv.lCode Then
                                                ilIncludeNTR = False
                                                Exit For
                                            End If
                                        Next ilLoop
                                    End If
                                    If ilIncludeNTR Then
                                        slDate = Trim$(str$(gDateValue(slDate)))
                                        Do While Len(slDate) < 5
                                            slDate = "0" & slDate
                                        Loop
                                        tgSbfCntr(UBound(tgSbfCntr)).sKey = slKey & "00000000" + slDate
                                        tgSbfCntr(UBound(tgSbfCntr)).lSDate = Val(slDate)
                                        tgSbfCntr(UBound(tgSbfCntr)).tSbf = tmSbf
                                        ReDim Preserve tgSbfCntr(0 To UBound(tgSbfCntr) + 1) As SBFCNTR
                                        'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81
                                        'Fix TTP 10826 / TTP 10813 - RE: v81 TTP 10826 - updated test results Issue #4
                                        mSetAirNTRStatus tgChfInv.lCntrNo, "NTR", IIF(tgChfInv.iAgfCode = 0, tgChfInv.iAdfCode, tgChfInv.iAgfCode)
                                    End If
                                End If
                            End If
                        End If
                    End If
                    ilRet = btrGetNext(hmSbf, tmSbf, imSbfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop
            End If
        Next ilBillCycle
    End If
    'Sort by Contract and date- process one contract/date at a time
    If UBound(tgSbfCntr) > 0 Then
        ArraySortTyp fnAV(tgSbfCntr(), 0), UBound(tgSbfCntr), 0, LenB(tgSbfCntr(0)), 0, LenB(tgSbfCntr(0).sKey), 0
    End If
    imNTRStatusConflict = False
    For ilIndex = 0 To UBound(tmNTRCntStatus) - 1 Step 1
        If mCompareChfInPast("N", tmNTRCntStatus(ilIndex).lChfCodeSchd, tmNTRCntStatus(ilIndex).lChfCodeAltered, tmNTRCntStatus(ilIndex).lEarliestDate, tmNTRCntStatus(ilIndex).sBillCycle) Then
            tmNTRCntStatus(ilIndex).lChfCodeSchd = 0
            tmNTRCntStatus(ilIndex).lChfCodeAltered = 0
        Else
            imNTRStatusConflict = True
        End If
    Next ilIndex
    mNTR_ReadRec = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mSetCommands                    *
'*                                                     *
'*             Created:6/04/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Set command buttons (enable or *
'*                      disabled)                      *
'*                                                     *
'*******************************************************
Private Sub mSetCommands()
'
'   mSetCommands
'   Where:
'
    If (ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_PrintRep).Value = vbChecked) Or (ckcType(INVTYPE_Installment).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked) Or (ckcType(INVTYPE_GenRepAR).Value = vbChecked) Then
        If (rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value) Or (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Aff).Value) Or (rbcType(INVGEN_Undo).Value) Or (rbcType(INVGEN_Archive).Value) Then            '11-15-16 archive
            cmcGenerate.Enabled = True
        Else
            cmcGenerate.Enabled = False
        End If
    Else
        cmcGenerate.Enabled = False
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mRepInv_GetCarry                *
'*                                                     *
'*             Created:7/19/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Get spots carried from previous*
'*                      month                          *
'*                                                     *
'*******************************************************
Private Sub mRepInv_GetCarry()
    Dim ilRet As Integer    'Return status
    Dim llDate As Long
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim slDate As String
    Dim ilRow As Integer
    Dim ilPass As Integer
    Dim llChfCode As Long
    Dim llSbfDate As Long
    Dim ilFound As Integer
    Dim ilSbf As Integer
    Dim ilMatch As Integer

    ilSbf = LBound(tgSbfCntr)
    Do While ilSbf <= UBound(tgSbfCntr) - 1
        llChfCode = tgSbfCntr(ilSbf).tSbf.lChfCode
        llSbfDate = tgSbfCntr(ilSbf).lSDate
        tmChfSrchKey.lCode = llChfCode
        ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If ilRet = BTRV_ERR_NONE Then
            gUnpackDate tgSbfCntr(ilSbf).tSbf.iDate(0), tgSbfCntr(ilSbf).tSbf.iDate(1), slDate
            'Get previous month
            If tgChfInv.sBillCycle = "C" Then
                slDate = gObtainStartCal(slDate)
                slDate = gDecOneDay(slDate)
                slDate = gObtainStartCal(slDate)
                llStartDate = gDateValue(slDate)
                slDate = gObtainEndCal(slDate)
                llEndDate = gDateValue(slDate)
            ElseIf tgChfInv.sBillCycle = "W" Then
                slDate = gObtainPrevMonday(slDate)
                slDate = gDecOneDay(slDate)
                slDate = gObtainPrevMonday(slDate)
                llStartDate = gDateValue(slDate)
                slDate = gObtainNextSunday(slDate)
                llEndDate = gDateValue(slDate)
            Else
                slDate = gObtainStartStd(slDate)
                slDate = gDecOneDay(slDate)
                slDate = gObtainStartStd(slDate)
                llStartDate = gDateValue(slDate)
                slDate = gObtainEndStd(slDate)
                llEndDate = gDateValue(slDate)
            End If
            tmSbfSrchKey0.lChfCode = llChfCode
            gPackDateLong llStartDate, tmSbfSrchKey0.iDate(0), tmSbfSrchKey0.iDate(1)
            tmSbfSrchKey0.sTranType = "T"
            'tmSbfSrchKey2.iDate(0) = 0
            'tmSbfSrchKey2.iDate(1) = 0
            ilRet = btrGetGreaterOrEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
            Do While (ilRet = BTRV_ERR_NONE) And (tmSbf.lChfCode = llChfCode)
                'gUnpackDateLong tmSbf.iDate(0), tmSbf.iDate(1), llDate
                gUnpackDateLongError tmSbf.iDate(0), tmSbf.iDate(1), llDate, "4:mRepInv_GetCarry " & tmSbf.lCode
                If llDate > llEndDate Then
                    Exit Do
                End If
                If (((tmSbf.iMissCarryOver < 0) Or (tgSpf.sPostCalAff = "C") And (tmSbf.iCalCarryOver > 0)) And (tmSbf.sTranType = "T")) Or (((Asc(tgSpf.sUsingFeatures8) And REPBYDT) = REPBYDT) And (tmSbf.iLineNo > 0) And ((tmSbf.iCalCarryOver > 0) Or (tmSbf.iCalCarryBonus > 0)) And (tmSbf.sTranType = "T")) Then
                    ilFound = False
                    For ilPass = 0 To 1 Step 1
                        For ilRow = ilSbf To UBound(tgSbfCntr) - 1 Step 1
                            If (tgSbfCntr(ilRow).tSbf.lChfCode = llChfCode) And (tgSbfCntr(ilRow).lSDate = llSbfDate) Then
                                ilMatch = False
                                If ((Asc(tgSpf.sUsingFeatures8) And REPBYDT) <> REPBYDT) Or ((tmSbf.iLineNo <= 0) And (tgSbfCntr(ilRow).tSbf.iLineNo <= 0)) Then
                                    If (tmSbf.iAirVefCode = tgSbfCntr(ilRow).tSbf.iAirVefCode) And (tmSbf.sCashTrade = tgSbfCntr(ilRow).tSbf.sCashTrade) And ((tmSbf.lSpotPrice = tgSbfCntr(ilRow).tSbf.lSpotPrice) Or (ilPass = 1)) Then
                                        ilMatch = True
                                    End If
                                Else
                                    If (tmSbf.iAirVefCode = tgSbfCntr(ilRow).tSbf.iAirVefCode) And (tmSbf.sCashTrade = tgSbfCntr(ilRow).tSbf.sCashTrade) And (tmSbf.lSpotPrice = tgSbfCntr(ilRow).tSbf.lSpotPrice) And (tmSbf.iLineNo = tgSbfCntr(ilRow).tSbf.iLineNo) Then
                                        ilMatch = True
                                    End If
                                End If
                                If ilMatch Then
                                    'If tgSpf.sPostCalAff <> "D" Then
                                    If ((Asc(tgSpf.sUsingFeatures8) And REPBYDT) <> REPBYDT) Or ((tmSbf.iLineNo <= 0) And (tgSbfCntr(ilRow).tSbf.iLineNo <= 0)) Then
                                        If (tgSpf.sPostCalAff = "C") And (tmSbf.iCalCarryOver > 0) Then
                                            tgSbfCntr(ilRow).tSbf.iAirNoSpots = tgSbfCntr(ilRow).tSbf.iAirNoSpots + tmSbf.iCalCarryOver
                                        End If
                                        tgSbfCntr(ilRow).iCarry = tgSbfCntr(ilRow).iCarry + Abs(tmSbf.iMissCarryOver)
                                    Else
                                        tgSbfCntr(ilRow).tSbf.iAirNoSpots = tgSbfCntr(ilRow).tSbf.iAirNoSpots + tmSbf.iCalCarryOver
                                        tgSbfCntr(ilRow).tSbf.iBonusNoSpots = tgSbfCntr(ilRow).tSbf.iBonusNoSpots + tmSbf.iCalCarryBonus
                                    End If
                                    ilFound = True
                                    Exit For
                                End If
                            End If
                        Next ilRow
                        If ilFound Then
                            Exit For
                        End If
                    Next ilPass
                End If
                ilRet = btrGetNext(hmSbf, tmSbf, imSbfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
            'Advance ilSbf to next contract
            Do
                If (llChfCode <> tgSbfCntr(ilSbf).tSbf.lChfCode) Or (llSbfDate <> tgSbfCntr(ilSbf).lSDate) Then
                    Exit Do
                End If
                ilSbf = ilSbf + 1
            Loop While ilSbf <= UBound(tgSbfCntr) - 1
        End If
    Loop
    Exit Sub

    On Error GoTo 0
    Exit Sub
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mRepInv_GenIvr                *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Initiate fields                 *
'*                                                     *
'*******************************************************
Function mRepAR_GenRvf(ilTestBilled As Integer, llInvoiceNo As Long) As Integer
'       ilTestBilled(I)- 0=Gather and update rvf;
'                        1=Test That all contracts invoiced
'       ilRet (O)- True if OK; False if error
    Dim ilPass As Integer
    Dim ilFound As Integer
    Dim slPctTrade As String
    Dim slProduct As String
    Dim ilRvf As Integer
    Dim ilSRvf As Integer
    Dim slAgyRate As String
    Dim slGross As String
    Dim slStr As String
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim ilLoop1 As Integer
    Dim llChfCode As Long
    Dim ilChf As Integer
    Dim ilClf As Integer
    Dim ilClf1 As Integer
    Dim ilCff As Integer
    Dim ilIncludeFlight As Integer
    Dim ilCreateRvf As Integer
    Dim slSFlightDate As String
    Dim slEFlightDate As String
    Dim slTotalNoPerWk As String
    Dim slTotalRate As String
    Dim ilRvfCreated As Integer
    Dim slSpotRate As String
    Dim llInvNo As Long
    Dim ilSetReturn As Integer
    Dim llAcquisitionCost As Long
    Dim ilVef As Integer
    Dim ilIncludeClf As Integer
    Dim ilTotalNoPerWk As Integer

    ilSetReturn = True
    For ilChf = 0 To UBound(tgSelSort) - 1 Step 1
        llChfCode = tgSelSort(ilChf).lChfCode
        ilRet = gObtainCntr(hmCHF, hmClf, hmCff, llChfCode, False, tgChfInv, tgClfInv(), tgCffInv())
        If ilRet Then
            ilFound = mRvfExist(llInvNo, 0, 0, "")
            If ilTestBilled = 0 Then
                If ((Not ilFound) And (rbcType(INVGEN_Final).Value)) Or ((ilFound) And (rbcType(INVGEN_Undo).Value)) Then
                    ilRvfCreated = False
                    slPctTrade = gIntToStrDec(tgChfInv.iPctTrade, 0)
                    slProduct = Trim$(tgChfInv.sProduct)
                    For ilPass = 1 To 2 Step 1
                        ilFound = False
                        If (ilPass = 1) And (tgChfInv.iPctTrade <> 100) Then
                            ilFound = True
                        End If
                        If (ilPass = 2) And (tgChfInv.iPctTrade <> 0) Then
                            ilFound = True
                        End If
                        If ilFound Then
                            ilFound = True
                            If rbcType(INVGEN_Undo).Value Then     'Determine invoice number
                                ilFound = False
                                For ilLoop = 0 To UBound(tmRPInfo) - 1 Step 1
                                    If (tgChfInv.lCntrNo = tmRPInfo(ilLoop).lCntrNo) And (tmRPInfo(ilLoop).iMnfItem = 0) Then
                                        If ilPass = 1 Then
                                            If (tmRPInfo(ilLoop).sCashTrade = "C") Then
                                                llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                                                ilFound = True
                                                Exit For
                                            End If
                                        Else
                                            If (tmRPInfo(ilLoop).sCashTrade = "T") Then
                                                llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                                                ilFound = True
                                                Exit For
                                            End If
                                        End If
                                    End If
                                Next ilLoop

                            End If
                            If ilFound Then

                                tmChf = tgChfInv
                                mGetAdfAgfSlf
                                If (tmChf.iAgfCode > 0) And (ilPass = 1) Then   '(Val(slPctTrade) <> 100) Then
                                    slAgyRate = gIntToStrDec(tmAgf.iComm, 2)
                                ElseIf (tmChf.iAgfCode > 0) And (tmChf.sAgyCTrade = "Y") And (ilPass = 2) Then   '(Val(slPctTrade) <> 100) Then
                                    slAgyRate = gIntToStrDec(tmAgf.iComm, 2)
                                Else
                                    slAgyRate = ""
                                End If

                                'Create RVF record
                                If rbcType(INVGEN_Final).Value Then
                                    ilRvf = UBound(tgRvf)
                                    ilSRvf = ilRvf
                                    tgRvf(ilRvf).lCode = 0
                                    'Product- update prf now instead of after all invoices generated
                                    tgRvf(ilRvf).lPrfCode = 0
                                    If (Trim$(slProduct) <> "") Then
                                        ilFound = False
                                        tmPrfSrchKey.iAdfCode = tmChf.iAdfCode
                                        ilRet = btrGetGreaterOrEqual(hmPrf, tmPrf, imPrfRecLen, tmPrfSrchKey, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point
                                        Do While (ilRet = BTRV_ERR_NONE) And (tmPrf.iAdfCode = tmChf.iAdfCode) 'tmRvf.iAdfCode)
                                            If StrComp(Trim$(Trim$(slProduct)), Trim$(tmPrf.sName), 1) = 0 Then
                                                ilFound = True
                                                tgRvf(ilRvf).lPrfCode = tmPrf.lCode
                                                Exit Do
                                            End If
                                            ilRet = btrGetNext(hmPrf, tmPrf, imPrfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                                        Loop
                                        If (Not ilFound) And (rbcType(INVGEN_Final).Value) Then
                                            Do  'Loop until record updated or added
                                                tmPrf.lCode = 0
                                                tmPrf.iAdfCode = tmChf.iAdfCode
                                                tmPrf.sName = Trim$(slProduct)
                                                tmPrf.iMnfComp(0) = 0
                                                tmPrf.iMnfComp(1) = 0
                                                tmPrf.iMnfExcl(0) = 0
                                                tmPrf.iMnfExcl(1) = 0
                                                tmPrf.iUrfCode = tgUrf(0).iCode
                                                tmPrf.iRemoteID = tgUrf(0).iRemoteUserID
                                                tmPrf.lAutoCode = tmPrf.lCode
                                                ilRet = btrInsert(hmPrf, tmPrf, imPrfRecLen, INDEXKEY0)
                                            Loop While ilRet = BTRV_ERR_CONFLICT
                                            If ilRet <> BTRV_ERR_NONE Then
                                                If ilRet >= 30000 Then
                                                    ilRet = csiHandleValue(0, 7)
                                                End If
                                                Print #hmMsg, "mRepAR_GenRvf: btrInsert-Point 1, Prf Error # " & Trim$(str$(ilRet))
                                            End If
                                            If ilRet = BTRV_ERR_NONE Then
                                                tgRvf(ilRvf).lPrfCode = tmPrf.lCode
                                                Do
                                                    tmPrf.iRemoteID = tgUrf(0).iRemoteUserID
                                                    tmPrf.lAutoCode = tmPrf.lCode
                                                    tmPrf.iSourceID = tgUrf(0).iRemoteUserID
                                                    gPackDate smSyncDate, tmPrf.iSyncDate(0), tmPrf.iSyncDate(1)
                                                    gPackTime smSyncTime, tmPrf.iSyncTime(0), tmPrf.iSyncTime(1)
                                                    ilRet = btrUpdate(hmPrf, tmPrf, imPrfRecLen)
                                                Loop While ilRet = BTRV_ERR_CONFLICT
                                                If ilRet <> BTRV_ERR_NONE Then
                                                    If ilRet >= 30000 Then
                                                        ilRet = csiHandleValue(0, 7)
                                                    End If
                                                    Print #hmMsg, "mRepAR_GenRvf: btrUpdate-Point 1, Prf Error # " & Trim$(str$(ilRet))
                                                End If
                                            Else
                                                tgRvf(ilRvf).lPrfCode = 0
                                            End If
                                        End If
                                    End If
                                    tgRvf(ilRvf).iAgfCode = tmChf.iAgfCode
                                    tgRvf(ilRvf).iAdfCode = tmChf.iAdfCode
                                    tgRvf(ilRvf).iSlfCode = tmChf.iSlfCode(0)
                                    tgRvf(ilRvf).lCntrNo = tmChf.lCntrNo
                                    tgRvf(ilRvf).lInvNo = llInvoiceNo
                                    tgRvf(ilRvf).lRefInvNo = 0
                                    '6/7/15: Check number changed to string
                                    tgRvf(ilRvf).sCheckNo = ""
                                    If tmChf.sBillCycle = "C" Then
                                        gPackDate smEndCal, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                                    ElseIf tmChf.sBillCycle = "W" Then
                                        gPackDate smEndWk, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                                    Else
                                        gPackDate smEndStd, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                                    End If
                                    tgRvf(ilRvf).sTranType = "IN"
                                    tgRvf(ilRvf).sAction = " "
                                    If tmChf.sBillCycle = "C" Then
                                        tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndCal))
                                        tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndCal))
                                    ElseIf tmChf.sBillCycle = "W" Then
                                        tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndWk))
                                        tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndWk))
                                    Else
                                        tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndStd))
                                        tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndStd))
                                    End If
                                    gPackDate "", tgRvf(ilRvf).iPurgeDate(0), tgRvf(ilRvf).iPurgeDate(1)
                                    If ilPass = 2 Then
                                        tgRvf(ilRvf).sCashTrade = "T"
                                    Else
                                        tgRvf(ilRvf).sCashTrade = "C"
                                    End If
                                    tgRvf(ilRvf).iPkLineNo = 0
                                    tgRvf(ilRvf).iInvDate(0) = tgRvf(ilRvf).iTranDate(0)
                                    tgRvf(ilRvf).iInvDate(1) = tgRvf(ilRvf).iTranDate(1)
                                    gPackDate smNowDate, tgRvf(ilRvf).iDateEntrd(0), tgRvf(ilRvf).iDateEntrd(1)
                                    tgRvf(ilRvf).iUrfCode = tgUrf(0).iCode
                                    tgRvf(ilRvf).iMnfGroup = 0  'Participant MnfCode, set in mUpdateRvf if Sales Source is Ask
                                    tgRvf(ilRvf).lTax1 = 0
                                    tgRvf(ilRvf).lTax2 = 0
                                    tgRvf(ilRvf).iMnfItem = 0
                                    tgRvf(ilRvf).lCefCode = 0
                                    tgRvf(ilRvf).lSbfCode = 0
                                    tgRvf(ilRvf).lPcfCode = 0
                                    tgRvf(ilRvf).sInCollect = "N"
                                    tgRvf(ilRvf).iRemoteID = 0
                                    tgRvf(ilRvf).lAcquisitionCost = 0
                                    tgRvf(ilRvf).iBacklogTrfCode = 0
                                    '1/17/09: Added buyer
                                    tgRvf(ilRvf).iPnfBuyer = tmChf.iPnfBuyer
                                    For ilClf = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                        ilIncludeClf = False
                                        ilVef = gBinarySearchVef(tgClfInv(ilClf).ClfRec.iVefCode)
                                        If ilVef <> -1 Then
                                            If tgMVef(ilVef).sType = "R" Then
                                                ilIncludeClf = True
                                            End If
                                        End If
                                        If (ilIncludeClf) And ((tgClfInv(ilClf).ClfRec.sType = "S") Or (tgClfInv(ilClf).ClfRec.sType = "H")) Then
                                            slTotalNoPerWk = "0"
                                            slTotalRate = "0"
                                            llAcquisitionCost = 0
                                            ilCreateRvf = False
                                            ilCff = tgClfInv(ilClf).iFirstCff
                                            Do While ilCff <> -1
                                                gUnpackDate tgCffInv(ilCff).CffRec.iStartDate(0), tgCffInv(ilCff).CffRec.iStartDate(1), slSFlightDate
                                                gUnpackDate tgCffInv(ilCff).CffRec.iEndDate(0), tgCffInv(ilCff).CffRec.iEndDate(1), slEFlightDate
                                                ilIncludeFlight = True
                                                If tgChfInv.sBillCycle = "C" Then
                                                    If (gDateValue(slSFlightDate) > lmEndCal) Or (gDateValue(slEFlightDate) < lmStartCal) Then
                                                        ilIncludeFlight = False
                                                    End If
                                                ElseIf tgChfInv.sBillCycle = "W" Then
                                                    If (gDateValue(slSFlightDate) > lmEndWk) Or (gDateValue(slEFlightDate) < lmStartWk) Then
                                                        ilIncludeFlight = False
                                                    End If
                                                Else
                                                    If (gDateValue(slSFlightDate) > lmEndStd) Or (gDateValue(slEFlightDate) < lmStartStd) Then
                                                        ilIncludeFlight = False
                                                    End If
                                                End If
                                                'Test if CBS
                                                If gDateValue(slEFlightDate) < gDateValue(slSFlightDate) Then
                                                    ilIncludeFlight = False
                                                End If
                                                If ilIncludeFlight Then
                                                    ilCreateRvf = True
                                                    ilTotalNoPerWk = Val(slTotalNoPerWk)
                                                    mRepAR_ProcFlight ilCff, slSFlightDate, slEFlightDate, ilPass, slPctTrade, slSpotRate, slTotalNoPerWk, slTotalRate
                                                    llAcquisitionCost = llAcquisitionCost + (Val(slTotalNoPerWk) - ilTotalNoPerWk) * tgClfInv(ilClf).ClfRec.lAcquisitionCost
                                                End If
                                                ilCff = tgCffInv(ilCff).iNextCff
                                            Loop
                                            If ilCreateRvf Then
                                                For ilClf1 = ilClf + 1 To UBound(tgClfInv) - 1 Step 1
                                                    If ((tgClfInv(ilClf1).ClfRec.sType = "S") Or (tgClfInv(ilClf1).ClfRec.sType = "H")) And (tgClfInv(ilClf1).ClfRec.iVefCode = tgClfInv(ilClf).ClfRec.iVefCode) Then
                                                        ilCff = tgClfInv(ilClf1).iFirstCff
                                                        Do While ilCff <> -1
                                                            gUnpackDate tgCffInv(ilCff).CffRec.iStartDate(0), tgCffInv(ilCff).CffRec.iStartDate(1), slSFlightDate
                                                            gUnpackDate tgCffInv(ilCff).CffRec.iEndDate(0), tgCffInv(ilCff).CffRec.iEndDate(1), slEFlightDate
                                                            ilIncludeFlight = True
                                                            If tgChfInv.sBillCycle = "C" Then
                                                                If (gDateValue(slSFlightDate) > lmEndCal) Or (gDateValue(slEFlightDate) < lmStartCal) Then
                                                                    ilIncludeFlight = False
                                                                End If
                                                            ElseIf tgChfInv.sBillCycle = "W" Then
                                                                If (gDateValue(slSFlightDate) > lmEndWk) Or (gDateValue(slEFlightDate) < lmStartWk) Then
                                                                    ilIncludeFlight = False
                                                                End If
                                                            Else
                                                                If (gDateValue(slSFlightDate) > lmEndStd) Or (gDateValue(slEFlightDate) < lmStartStd) Then
                                                                    ilIncludeFlight = False
                                                                End If
                                                            End If
                                                            'Test if CBS
                                                            If gDateValue(slEFlightDate) < gDateValue(slSFlightDate) Then
                                                                ilIncludeFlight = False
                                                            End If
                                                            If ilIncludeFlight Then
                                                                ilTotalNoPerWk = Val(slTotalNoPerWk)
                                                                mRepAR_ProcFlight ilCff, slSFlightDate, slEFlightDate, ilPass, slPctTrade, slSpotRate, slTotalNoPerWk, slTotalRate
                                                                llAcquisitionCost = llAcquisitionCost + (Val(slTotalNoPerWk) - ilTotalNoPerWk) * tgClfInv(ilClf1).ClfRec.lAcquisitionCost
                                                            End If
                                                            ilCff = tgCffInv(ilCff).iNextCff
                                                        Loop

                                                    End If
                                                Next ilClf1

                                            End If
                                            ilFound = False
                                            For ilLoop1 = ilSRvf To UBound(tgRvf) - 1 Step 1
                                                If (tgRvf(ilLoop1).lCntrNo = tmChf.lCntrNo) And (tgRvf(ilLoop1).iAirVefCode = tgClfInv(ilClf).ClfRec.iVefCode) And (tgRvf(ilLoop1).iBillVefCode = tgClfInv(ilClf).ClfRec.iVefCode) And (tgRvf(ilLoop1).sCashTrade = tgRvf(ilRvf).sCashTrade) Then
                                                    ilFound = True
                                                    Exit For
                                                End If
                                            Next ilLoop1
                                            If (ilCreateRvf) And (Not ilFound) Then
                                                ilRvfCreated = True
                                                ilRvf = UBound(tgRvf)
                                                tgRvf(ilRvf).iBillVefCode = tgClfInv(ilClf).ClfRec.iVefCode
                                                tgRvf(ilRvf).iAirVefCode = tgClfInv(ilClf).ClfRec.iVefCode
                                                tgRvf(ilRvf).lRefInvNo = 0
                                                tgRvf(ilRvf).lAcquisitionCost = llAcquisitionCost
                                                If (ilPass = 1) And (tmChf.iPctTrade <> 100) Then
                                                    slGross = slTotalRate
                                                    If Val(slPctTrade) <> 0 Then
                                                        slGross = gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100")
                                                    End If
                                                    gStrToPDN slGross, 2, 6, tgRvf(ilRvf).sGross
                                                    If slAgyRate = "" Then
                                                        slStr = slGross
                                                    Else
                                                        slStr = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                                                    End If
                                                    gStrToPDN slStr, 2, 6, tgRvf(ilRvf).sNet
                                                    tgRvf(ilRvf).lAcquisitionCost = ((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100
                                                    If Not ilFound Then
                                                        ReDim Preserve tgRvf(0 To UBound(tgRvf) + 1) As RVF
                                                        tgRvf(ilRvf + 1) = tgRvf(ilRvf)
                                                    End If
                                                End If
                                                If (ilPass = 2) And (tmChf.iPctTrade <> 0) Then
                                                    slGross = slTotalRate
                                                    If Val(slPctTrade) <> 100 Then
                                                        slGross = gSubStr(slGross, gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100"))
                                                    End If
                                                    gStrToPDN slGross, 2, 6, tgRvf(ilRvf).sGross
                                                    If slAgyRate = "" Then
                                                        slStr = slGross
                                                    Else
                                                        slStr = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                                                    End If
                                                    gStrToPDN slStr, 2, 6, tgRvf(ilRvf).sNet
                                                    tgRvf(ilRvf).lAcquisitionCost = tgRvf(ilRvf).lAcquisitionCost - (((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100)
                                                    ReDim Preserve tgRvf(0 To UBound(tgRvf) + 1) As RVF
                                                    tgRvf(ilRvf + 1) = tgRvf(ilRvf)
                                                End If
                                            End If
                                        End If
                                    Next ilClf
                                    If ilRvfCreated Then
                                        llInvoiceNo = llInvoiceNo + 1
                                        mCheckNextInvNo llInvoiceNo
                                    End If
                                End If
                            End If
                        End If
                    Next ilPass
                    If ilRvfCreated Then
                        tgSortKey(UBound(tgSortKey)).lCntrNo = tgChfInv.lCntrNo
                        tgSortKey(UBound(tgSortKey)).lChfCode = tgChfInv.lCode
                        tgSortKey(UBound(tgSortKey)).iType = 11
                        If rbcType(INVGEN_Final).Value Then
                            tgSortKey(UBound(tgSortKey)).iBilled = True
                        Else
                            tgSortKey(UBound(tgSortKey)).iBilled = False
                        End If
                        ReDim Preserve tgSortKey(0 To UBound(tgSortKey) + 1) As TYPESORTKEY
                    End If
                End If
            Else
                If Not ilFound Then
                    'Test if Contract should have been invoiced
                    For ilClf = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                        If (tgClfInv(ilClf).ClfRec.sType = "S") Or (tgClfInv(ilClf).ClfRec.sType = "H") Then
                            slTotalNoPerWk = "0"
                            slTotalRate = "0"
                            ilCreateRvf = False
                            ilCff = tgClfInv(ilClf).iFirstCff
                            Do While ilCff <> -1
                                gUnpackDate tgCffInv(ilCff).CffRec.iStartDate(0), tgCffInv(ilCff).CffRec.iStartDate(1), slSFlightDate
                                gUnpackDate tgCffInv(ilCff).CffRec.iEndDate(0), tgCffInv(ilCff).CffRec.iEndDate(1), slEFlightDate
                                ilIncludeFlight = True
                                If tgChfInv.sBillCycle = "C" Then
                                    If (gDateValue(slSFlightDate) > lmEndCal) Or (gDateValue(slEFlightDate) < lmStartCal) Then
                                        ilIncludeFlight = False
                                    End If
                                ElseIf tgChfInv.sBillCycle = "W" Then
                                    If (gDateValue(slSFlightDate) > lmEndWk) Or (gDateValue(slEFlightDate) < lmStartWk) Then
                                        ilIncludeFlight = False
                                    End If
                                Else
                                    If (gDateValue(slSFlightDate) > lmEndStd) Or (gDateValue(slEFlightDate) < lmStartStd) Then
                                        ilIncludeFlight = False
                                    End If
                                End If
                                'Test if CBS
                                If gDateValue(slEFlightDate) < gDateValue(slSFlightDate) Then
                                    ilIncludeFlight = False
                                End If
                                If ilIncludeFlight Then
                                    ilCreateRvf = True
                                    Exit Do
                                End If
                                ilCff = tgCffInv(ilCff).iNextCff
                            Loop
                            If ilCreateRvf Then
                                ilSetReturn = False
                                Print #hmMsg, "   Rep Contract " & Trim$(str$(tgChfInv.lCntrNo)) & " Not Invoiced"
                                Exit For
                            End If
                        End If
                    Next ilClf
                End If
            End If
        End If
    Next ilChf
    mRepAR_GenRvf = ilSetReturn
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mSelCntr                        *
'*                                                     *
'*             Created:9/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Show Contracts for selection   *
'*                                                     *
'*******************************************************
Private Sub mRepAR_GetCntr()
'
'   ilRepARCntr (I)- Find Rep contracts required for A/R generation
'
    Dim slStartDate As String
    Dim slEndDate As String
    Dim slStatus As String
    Dim slCntrType As String
    Dim ilHOType As Integer
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim ilVefCode As Integer
    Dim ilFound As Integer
    Dim llChf As Long 'TTP 10602 - Invoice overflow error in gCntrForActiveOHD, gObtainCntrForDate when count of contracts exceeds 32767
    Dim ilTest As Integer

    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    If (lmStartStd > 0) Or (lmStartCal > 0) Or (lmStartWk > 0) Then
        slStartDate = ""
        If lmStartStd > 0 Then
            slStartDate = smStartStd
        End If
        If (lmStartCal > 0) And ((lmStartCal < gDateValue(slStartDate)) Or (slStartDate = "")) Then
            slStartDate = smStartCal
        End If
        If (lmStartWk > 0) And ((lmStartWk < gDateValue(slStartDate)) Or (slStartDate = "")) Then
            slStartDate = smStartWk
        End If
        slEndDate = ""
        If lmEndStd > 0 Then
            slEndDate = smEndStd
        End If
        If (lmEndCal > 0) And ((lmEndCal > gDateValue(slEndDate)) Or (slEndDate = "")) Then
            slEndDate = smEndCal
        End If
        If (lmEndWk > 0) And ((lmEndWk > gDateValue(slEndDate)) Or (slEndDate = "")) Then
            slEndDate = smEndWk
        End If
        slStatus = "HO"
        slCntrType = ""
        ilHOType = 1
        sgCntrForDateStamp = ""
        ilRet = gObtainCntrForDate(Invoice, slStartDate, slEndDate, slStatus, slCntrType, ilHOType, tgChfAdvtExt())
    Else
        ReDim tgChfAdvtExt(0 To 0) As CHFADVTEXT
    End If
    ilRet = gObtainAdvt()
    ilRet = gObtainAgency()
    mClearAirTimeGrid
    ReDim tgSelSort(0 To 0) As SELTYPESORT
    For llChf = LBound(tgChfAdvtExt) To UBound(tgChfAdvtExt) - 1 Step 1 'TTP 10602 - Invoice overflow error in gCntrForActiveOHD, gObtainCntrForDate when count of contracts exceeds 32767
        ilFound = False
        If tgChfAdvtExt(llChf).lVefCode > 0 Then 'TTP 10602 - Invoice overflow error in gCntrForActiveOHD, gObtainCntrForDate when count of contracts exceeds 32767
            ilVefCode = tgChfAdvtExt(llChf).lVefCode 'TTP 10602 - Invoice overflow error in gCntrForActiveOHD, gObtainCntrForDate when count of contracts exceeds 32767
            ilTest = gBinarySearchVef(ilVefCode)
            If ilTest <> -1 Then
                If tgMVef(ilTest).sType = "R" Then
                    ilFound = True
                End If
            End If
        ElseIf tgChfAdvtExt(llChf).lVefCode < 0 Then 'TTP 10602 - Invoice overflow error in gCntrForActiveOHD, gObtainCntrForDate when count of contracts exceeds 32767
            tmVsfSrchKey.lCode = -tgChfAdvtExt(llChf).lVefCode 'TTP 10602 - Invoice overflow error in gCntrForActiveOHD, gObtainCntrForDate when count of contracts exceeds 32767
            ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
            Do While ilRet = BTRV_ERR_NONE
                For ilLoop = LBound(tmVsf.iFSCode) To UBound(tmVsf.iFSCode) Step 1
                    If tmVsf.iFSCode(ilLoop) > 0 Then
                        ilVefCode = tmVsf.iFSCode(ilLoop)
                        ilTest = gBinarySearchVef(ilVefCode)
                        If ilTest <> -1 Then
                            If tgMVef(ilTest).sType = "R" Then
                                ilFound = True
                            End If
                        End If
                        If ilFound Then
                            Exit For
                        End If
                    End If
                Next ilLoop
                If (ilFound) Or (tmVsf.lLkVsfCode <= 0) Then
                    Exit Do
                End If
                tmVsfSrchKey.lCode = tmVsf.lLkVsfCode
                ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
        End If
        If ilFound Then
            'TTP 10602 - Invoice overflow error in gCntrForActiveOHD, gObtainCntrForDate when count of contracts exceeds 32767
            tmChf.lCode = tgChfAdvtExt(llChf).lCode
            tmChf.iAgfCode = tgChfAdvtExt(llChf).iAgfCode
            tmChf.iAdfCode = tgChfAdvtExt(llChf).iAdfCode
            tmChf.sType = tgChfAdvtExt(llChf).sType
            tmChf.lCntrNo = tgChfAdvtExt(llChf).lCntrNo
            mSelCntrSort
        End If
    Next llChf 'TTP 10602 - Invoice overflow error in gCntrForActiveOHD, gObtainCntrForDate when count of contracts exceeds 32767
    
    If UBound(tgSelSort) > 0 Then
        ArraySortTyp fnAV(tgSelSort(), 0), UBound(tgSelSort), 0, LenB(tgSelSort(0)), 0, LenB(tgSelSort(0).sKey), 0
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mRepInv_InvEnd                  *
'*                                                     *
'*             Created:3/01/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: End of invoice processing      *
'*                                                     *
'*******************************************************
Private Sub mRepInv_InvEnd()
    Dim slStr As String
    Dim slDisplay As String
    Dim ilRet As Integer
    If rbcType(INVGEN_Final).Value Then
        ilRet = mUpdateInv(2)
    End If
    If rbcOutput(0).Value Then
        slDisplay = "D"
    Else
        slDisplay = "P"
    End If
    igRptCallType = INVOICESJOB
    igRptType = 2
    'Start Crystal report
    igChildDone = False 'edcLinkDestDoneMsg.Text = ""
    edcLinkSrceDoneMsg.Text = ""
    If (Not igStdAloneMode) And (imShowHelpMsg) Then
        If igTestSystem Then
            slStr = "Invoice^Test\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & smRemoteGenDate & "\" & smRemoteGenTime & "\" & slDisplay
        Else
            slStr = "Invoice^Prod\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & smRemoteGenDate & "\" & smRemoteGenTime & "\" & slDisplay
        End If
    Else
        '12-16-16 remove \ from end of line
        If igTestSystem Then
            slStr = "Invoice^Test^NOHELP\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & smRemoteGenDate & "\" & smRemoteGenTime & "\" & slDisplay
        Else
            slStr = "Invoice^Prod^NOHELP\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & smRemoteGenDate & "\" & smRemoteGenTime & "\" & slDisplay
        End If
    End If
    'slStr = slStr & "\1"    'invoice without spot
    'Add Air Column
    slStr = slStr & "\5" & "\" & sgInvMonthYear & "\"
    sgCommandStr = slStr
    gUserActivityLog "S", "Invoice: Output Rep"
    RptSelIn.Show vbModal
    gUserActivityLog "E", "Invoice: Output Rep"
End Sub

'           Obtain the Tax Amount based on the net value entered.
'           Determine if the agency or advt is taxable
'           <input> agency code of transaction
'                   advt code of transaction
'                   slInputNet - net value input, (tax excluded here)
'           <output> llTax1 - tax amount applied to Tax1
'                    llTax2 - tax amount aplied to Tax2
'           <Return>  None
Private Sub mCalcTaxes(ilStartRvf As Integer)
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilRet                         ilTrfVef                      ilVef                     *
'*                                                                                        *
'******************************************************************************************
    Dim ilTax1 As Integer
    Dim ilTax2 As Integer
    Dim slTax1Pct As String
    Dim slTax2Pct As String
    Dim llTax1Rate As Long
    Dim llTax2Rate As Long
    Dim slTax1Amt As String
    Dim ilAgfCode As Integer
    Dim ilAdfCode As Integer
    Dim slDollar As String
    Dim ilRvf As Integer
    Dim ilTrfAgyAdvt As Integer
    Dim ilTaxable As Integer
    Dim slGrossNet As String

    If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then        '11-15-16 reprint, aff or archive
        lmTax1 = lmRPTax1
        lmTax2 = lmRPTax2
        Exit Sub
    End If
    lmTax1 = 0
    lmTax2 = 0
    'Set Net & taxes if applicable
    '1-17-02 determine if taxes are applicable for this agency, then backcompute to get net and taxes
    '12/17/06-Change to tax by agency or vehicle
    'If tgSpf.iBTax(0) <> 0 Or tgSpf.iBTax(1) <> 0 Then
    If ((Asc(tgSpf.sUsingFeatures3) And TAXONAIRTIME) = TAXONAIRTIME) Or ((Asc(tgSpf.sUsingFeatures3) And TAXONNTR) = TAXONNTR) Then
        ilAgfCode = tgRvf(ilStartRvf).iAgfCode
        ilAdfCode = tgRvf(ilStartRvf).iAdfCode

        'get the agency or direct advertiser
        ilTaxable = False
        slTax1Pct = ".00"
        slTax2Pct = ".00"

        ilTrfAgyAdvt = gGetTrfIndexForAgyAdvt(ilAdfCode, ilAgfCode)

        'If (ilTax1) Or (ilTax2) Then       'both taxes apply
        If (ilTrfAgyAdvt <> -1) Then        'both taxes apply
            For ilRvf = ilStartRvf To UBound(tgRvf) - 1 Step 1
                ilTax1 = False
                ilTax2 = False
                If tgRvf(ilRvf).sCashTrade = "C" Then
                    gGetAirTimeTaxValues ilTrfAgyAdvt, tgRvf(ilRvf).iAirVefCode, llTax1Rate, llTax2Rate, slGrossNet
                    If llTax1Rate > 0 Or llTax2Rate > 0 Then
                        If llTax1Rate > 0 Then
                            ilTax1 = True
                        End If
                        slTax1Pct = gLongToStrDec(llTax1Rate, 4)    'Leave a 4 place as gMulStr is to 4 places, later div by 100
                        If llTax2Rate > 0 Then
                            ilTax2 = True
                        End If
                        slTax2Pct = gLongToStrDec(llTax2Rate, 4)
                        If ((Asc(tgSpf.sUsingFeatures4) And TAXBYUSA) = TAXBYUSA) Or ((Asc(tgSpf.sUsingFeatures4) And TAXBYCANADA) = TAXBYCANADA) Then
                            If slGrossNet <> "N" Then
                                gPDNToStr tgRvf(ilRvf).sGross, 2, slDollar
                            Else
                                gPDNToStr tgRvf(ilRvf).sNet, 2, slDollar
                            End If
                            If (ilTax1) And (ilTax2) Then       'both taxes apply
                                slTax1Amt = gRoundStr(gDivStr(gMulStr(slDollar, slTax1Pct), "100."), ".01", 2)
                                tgRvf(ilRvf).lTax1 = gStrDecToLong(slTax1Amt, 2)
                                lmTax1 = lmTax1 + tgRvf(ilRvf).lTax1
                                slTax1Amt = gRoundStr(gDivStr(gMulStr(slDollar, slTax2Pct), "100."), ".01", 2)
                                tgRvf(ilRvf).lTax2 = gStrDecToLong(slTax1Amt, 2)
                                lmTax2 = lmTax2 + tgRvf(ilRvf).lTax2
                            ElseIf ilTax1 Then                  'only sales tax1
                                slTax1Amt = gRoundStr(gDivStr(gMulStr(slDollar, slTax1Pct), "100."), ".01", 2)
                                tgRvf(ilRvf).lTax1 = gStrDecToLong(slTax1Amt, 2)
                                lmTax1 = lmTax1 + tgRvf(ilRvf).lTax1
                                tgRvf(ilRvf).lTax2 = 0
                            ElseIf ilTax2 Then                  'only sales tax2
                                tgRvf(ilRvf).lTax1 = 0
                                slTax1Amt = gRoundStr(gDivStr(gMulStr(slDollar, slTax2Pct), "100."), ".01", 2)
                                tgRvf(ilRvf).lTax2 = gStrDecToLong(slTax1Amt, 2)
                                lmTax2 = lmTax2 + tgRvf(ilRvf).lTax2
                            End If
                        End If
                    End If
                End If
            Next ilRvf
        End If
    End If
End Sub

Private Sub ckcAll_Click()
    'Code added because Value removed as parameter
    Dim Value As Integer
    Value = False
    If ckcAll.Value = vbChecked Then
        Value = True
    End If
    'End of coded added
    Dim llRet As Long
    Dim llRg As Long
    Dim ilValue As Integer
    If imBypassAll Then
        Exit Sub
    End If
    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    ilValue = Value
    If lbcVehicle.ListCount > 0 Then
        llRg = CLng(lbcVehicle.ListCount - 1) * &H10000 Or 0
        llRet = SendMessageByNum(lbcVehicle.HWnd, LB_SELITEMRANGE, ilValue, llRg)
    End If
    imObtainDateCalled = False
    mObtainDates

    Screen.MousePointer = vbDefault
    gSetMousePointer grdAirTime, grdRevenue, vbDefault
End Sub

Private Sub ckcAll_GotFocus()
    'plcUnbilled.Visible = False
End Sub

Private Sub ckcShowPrel_GotFocus()
    If imFirstTime Then
        imFirstTime = False
    End If
End Sub

Private Sub ckcType_Click(Index As Integer)
    Dim llSDate As Long
    Dim llEDate As Long
    Dim slSDate As String
    Dim slEDate As String

    If Index = 0 Then
        If ckcType(INVTYPE_Commercial).Value = vbUnchecked Then
            rbcCntr(0).Value = True ''07-26-22 - JW - Make sure ALL is selected when unchecking Commercial
            lbcVehicle.Visible = False
            grdAirTime.Visible = False
            ckcAll.Visible = False
            plcCntr.Visible = False
            If rbcType(INVGEN_Aff).Visible = True Then
                rbcType(INVGEN_Aff).Enabled = True
            End If
            lacStdDates.Caption = ""
            lacCalDates.Caption = ""
            lacWkDates.Caption = ""
            '10016
            If bmToggleAirAndNTR = False Then
                If rbcType(INVGEN_Undo).Value Then
                    ckcType(INVTYPE_NTR).Value = vbUnchecked
                End If
            End If
        Else
            If rbcType(INVGEN_Aff).Visible = True Then
                rbcType(INVGEN_Aff).Enabled = True
            End If
            '10016
            If bmToggleAirAndNTR Then
                If ckcType(INVTYPE_NTR).Value = vbChecked Then
                    ckcType(INVTYPE_NTR).Value = vbUnchecked
                End If
            Else
                If tgSpf.sUsingNTR = "Y" And ckcType(INVTYPE_NTR).Value = vbUnchecked Then
                    ckcType(INVTYPE_NTR).Value = vbChecked
                End If
            End If
            rbcType(INVGEN_Reprint).Enabled = True
            rbcType(INVGEN_Archive).Enabled = True       '11-15-16 archive
            If (rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value) Then
                lbcVehicle.Visible = True
                grdAirTime.Visible = True
                ckcAll.Visible = True   'False
                plcCntr.Visible = True  'False
                If (lbcVehicle.ListCount <= 0) Then
                    mVehPop
                End If
            Else
                lbcVehicle.Visible = False
                grdAirTime.Visible = False
                ckcAll.Visible = False
                plcCntr.Visible = False
            End If
            mObtainDates
            If ((rbcType(INVGEN_Preliminary).Value = True) Or (rbcType(INVGEN_Final).Value = True)) And (ckcAll.Value = vbUnchecked) Then
                ckcAll.Value = vbChecked
            End If
        End If
    ElseIf (Index = 3) Then
        If ckcType(INVTYPE_NTR).Value = vbChecked Then
            '10016
            If bmToggleAirAndNTR Then
                If ckcType(INVTYPE_Commercial).Value = vbChecked Then
                    ckcType(INVTYPE_Commercial).Value = vbUnchecked
                End If
            Else
                If rbcType(INVGEN_Undo).Value Then
                    ckcType(INVTYPE_Commercial).Value = vbChecked
                End If
            End If
            gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slSDate
            slSDate = gIncOneDay(slSDate)
            slEDate = gObtainEndStd(slSDate)
            llSDate = gDateValue(slSDate)
            llEDate = gDateValue(slEDate)
            If llEDate < lmNowDate Then
                lmNTRDate = llEDate
            Else
                lmNTRDate = lmNowDate
                slEDate = gObtainEndStd(smNowDate)
                If (lmNowDate + 2 >= gDateValue(slEDate)) And ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) Then
                    lmNTRDate = gDateValue(slEDate)
                End If
            End If
            If ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked Then
                lacNTRDates.Caption = "NTR Thru " & gObtainEndCal(Format$(lmNTRDate, "m/d/yy"))
            Else
                lacNTRDates.Caption = "NTR Thru " & Format$(lmNTRDate, "m/d/yy")
            End If
        Else
            lacNTRDates.Caption = ""
            '10016
            If bmToggleAirAndNTR = False Then
                If ((Asc(tgSpf.sUsingFeatures5) And COMBINEAIRNTR) = COMBINEAIRNTR) Or (rbcType(INVGEN_Undo).Value) Then
                    ckcType(INVTYPE_Commercial).Value = vbUnchecked
                End If
            End If
        End If
    ElseIf (Index = 4) Then
        If (ckcType(INVTYPE_GenRepAR).Value = vbChecked) Then
            If ckcType(INVTYPE_Commercial).Visible Then
                If ckcType(INVTYPE_Commercial).Value = vbUnchecked Then
                    'ckcType(INVTYPE_Commercial).Value = vbChecked
                    'Added- if above coded placed back in, then this line can be removed
                    mObtainDates
                Else
                '    mObtainDates
                End If
            Else
                mObtainDates
            End If
        End If
        If (ckcType(INVTYPE_GenRepAR).Value = vbUnchecked) Then
            If (ckcType(INVTYPE_Commercial).Visible) Then
            '    ckcType(INVTYPE_Commercial).Value = vbUnchecked
            End If
        End If
    End If
    If imUpdateAllowed Then
        If (ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_PrintRep).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked) Then
            If ckcType(INVTYPE_GenRepAR).Value = vbUnchecked Then
                rbcType(INVGEN_Preliminary).Enabled = True
            Else
                rbcType(INVGEN_Preliminary).Enabled = False
                rbcType(INVGEN_Preliminary).Value = False
                ckcShowPrel.Visible = False
                ckcSuppressNTRDetails.Visible = False 'TTP 10745
                ckcSuppressNTRDetails.Value = vbUnchecked
            End If
        Else
            If ckcType(INVTYPE_GenRepAR).Value = vbUnchecked Then
                rbcType(INVGEN_Preliminary).Enabled = True
            Else
                rbcType(INVGEN_Preliminary).Enabled = False
                rbcType(INVGEN_Preliminary).Value = False
                ckcShowPrel.Visible = False
                ckcSuppressNTRDetails.Visible = False 'TTP 10745
                ckcSuppressNTRDetails.Value = vbUnchecked
            End If
        End If
    End If
    If (ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_PrintRep).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked) Then
        If ckcType(INVTYPE_GenRepAR).Value = vbUnchecked Then
            rbcType(INVGEN_Reprint).Enabled = True
            rbcType(INVGEN_Archive).Enabled = True               '11-15-16 archive
        Else
            rbcType(INVGEN_Reprint).Enabled = False
            rbcType(INVGEN_Reprint).Value = False
            rbcType(INVGEN_Archive).Enabled = False              '11-15-16 archive
            rbcType(INVGEN_Archive).Value = False
            ckcShowPrel.Visible = False
            ckcSuppressNTRDetails.Visible = False 'TTP 10745
            ckcSuppressNTRDetails.Value = vbUnchecked
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'lbcDates.Visible = False
            cbcDates.Visible = False
            lacMonth.Visible = False
            'lbcWeek.Visible = False
            cbcWeek.Visible = False
            lacWeek.Visible = False
            grdRevenue.Visible = False
            plcAdvt.Visible = False
        End If
    Else
        If ckcType(INVTYPE_GenRepAR).Value = vbUnchecked Then
            rbcType(INVGEN_Reprint).Enabled = True
            rbcType(INVGEN_Archive).Enabled = True               '11-15-16 archive
        Else
            rbcType(INVGEN_Reprint).Enabled = False
            rbcType(INVGEN_Reprint).Value = False
            rbcType(INVGEN_Archive).Enabled = False              '11-15-16 archive
            rbcType(INVGEN_Archive).Value = False
            ckcShowPrel.Visible = False
            ckcSuppressNTRDetails.Visible = False 'TTP 10745
            ckcSuppressNTRDetails.Value = vbUnchecked
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'lbcDates.Visible = False
            cbcDates.Visible = False
            lacMonth.Visible = False
            'lbcWeek.Visible = False
            cbcWeek.Visible = False
            lacWeek.Visible = False
            grdRevenue.Visible = False
            plcAdvt.Visible = False
        End If
    End If
    If rbcType(INVGEN_Preliminary).Value Then
        ckcShowPrel.Caption = "Show " & """" & "Preliminary" & """" & " on Invoice"
        ckcShowPrel.Enabled = True
        ckcShowPrel.Visible = True
        ckcSuppressNTRDetails.Visible = False 'TTP 10745
        ckcSuppressNTRDetails.Value = vbUnchecked
    End If
    If rbcType(INVGEN_Reprint).Value Then
        ckcShowPrel.Caption = "Show " & """" & "Reprint" & """" & " on Invoice"
        ckcShowPrel.Enabled = True
        ckcShowPrel.Visible = True
        
        If rbcType(2).Value Then
            If ckcType(3).Value = vbChecked Then
                ckcSuppressNTRDetails.Visible = True 'TTP 10745
            End If
        Else
            ckcSuppressNTRDetails.Visible = False 'TTP 10745
            ckcSuppressNTRDetails.Value = vbUnchecked
        End If
        
    End If
    If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_GenRepAR).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked)) And ((rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value)) Then
        frcBilling.Visible = True
        If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_GenRepAR).Value = vbChecked)) Then
            If ckcBillCycle(INVBILLCYCLE_STD).Value Then
                lacStdDates.Caption = smStdDateMsg
            Else
                lacStdDates.Caption = ""
            End If
            If ckcBillCycle(INVBILLCYCLE_Calendar).Value Then
                lacCalDates.Caption = smCalDateMsg
            Else
                lacCalDates.Caption = ""
            End If
            If ckcBillCycle(INVBILLCYCLE_Week).Value Then
                lacWkDates.Caption = smWkDateMsg
            Else
                lacWkDates.Caption = ""
            End If
            'lacCalDates.Caption = smCalDateMsg
        Else
            lacStdDates.Caption = ""
            lacCalDates.Caption = ""
            lacWkDates.Caption = ""
        End If
    Else
        frcBilling.Visible = False
    End If
    If Not imIgnoreSelAdvtRequest Then
        If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked)) And ((rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value) And (rbcAdvt(1).Value)) Then      '11-15-16 test for reprint or archive
            mSelAdvt
        End If
        If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked)) And ((rbcType(INVGEN_Undo).Value) And (rbcAdvt(1).Value)) Then
            mSelAdvt
        End If
    End If
    'prelim or final, rep final
    If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or ((ckcType(INVTYPE_PrintRep).Value = vbChecked) And ((Asc(tgSpf.sUsingFeatures8) And REPBYDT) = REPBYDT))) And (rbcType(INVGEN_Final).Value) Then
        ckcIncludeEDI.Visible = True
        If Not ckcType(INVTYPE_Commercial).Value Then            '11-14-16, not air time
            ckcArchive.Visible = True
        End If
    Else
        ckcIncludeEDI.Visible = False
        ckcArchive.Visible = False
        ckcArchive.Value = vbUnchecked
    End If
    mCallRadioButtons
    'mSetCommands called in routine above as needed.
   ' mSetCommands
End Sub

Private Sub cmcAdj_Click()
    'If Not gWinRoom(igNoExeWinRes(POSTADJTEXE)) Then
    '    Exit Sub
    'End If
    'MousePointer = vbHourGlass  'Wait
    'PostAdjt.Show vbModal
    'MousePointer = vbDefault    'Default
End Sub

Private Sub cmcAdj_GotFocus()
    If plcUnbilled.Visible Then
        plcUnbilled.Visible = False
        plcFromLine.Enabled = True
    End If
End Sub

Private Sub cmcAlign_Click()
    '10-31-01 remove subroutine (Crystal used for all cases)
    'If Not imUsingCrystal Then
    '    If rbcPrtType(0).Value Then
    '        slFileName = sgRptPath & "InvoiceL.Lst" & Chr$(0)
    '        gInvoice True
    '    Else
    '        slFileName = sgRptPath & "InvoiceI.Lst" & Chr$(0)
    '        gInvoice False
    '    End If
    '    slLangText = "Printing..."
'VB6**  ilLLRet = LlPrintWithBoxStart(hdJob, LL_PROJECT_LIST, slFileName, LL_PRINT_NORMAL Or LL_PRINT_MULTIPLE_JOBS, LL_BOXTYPE_BRIDGEMETER, Invoice.hWnd, slLangText)
    '    DoEvents
    '    If (ilLLRet = 0) Then
'VB6**      ilLLRet = LLPrintEnableObject(hdJob, ":Ordered", True)
'VB6**      ilLLRet = LLPrintEnableObject(hdJob, ":Aired", True)
'VB6**      ilLLRet = LLPrintEnableObject(hdJob, ":Reconc", True)
'VB6**      ilLLRet = LLPrint(hdJob)
'VB6**      ilLLRet = LlPrintEnd(hdJob, 0)
     '   Else  ' LlPrintWithBoxStart
'VB6**      ilLLRet = LlPrintEnd(hdJob, 0)
'VB6**      slError = LlVBExprError(hdJob)
     '       slLangText = "Error"
     '       slLangText = slLangText & ": " & slError
     '       MsgBox slLangText, vbOkOnly, "XXXX"
     '   End If  ' LlPrintWithBoxStart
    'End If
End Sub

Private Sub cmcAlign_GotFocus()
    If plcUnbilled.Visible Then
        plcUnbilled.Visible = False
        plcFromLine.Enabled = True
    End If
End Sub

Private Sub cmcCancel_Click()
    Dim ilRes As Integer
    If imGenInv Then
        ilRes = MsgBox("Invoicing in Progress, Cancel", vbYesNo + vbQuestion, "Invoice")
        If ilRes = vbNo Then
            Exit Sub
        End If
    End If
    mTerminate
End Sub

Private Sub cmcCancel_GotFocus()
    If plcUnbilled.Visible Then
        plcUnbilled.Visible = False
        plcFromLine.Enabled = True
    End If
End Sub

Private Sub cmcClearPsf_Click()
    'If Not gWinRoom(igNoExeWinRes(POSTITEMEXE)) Then
    '    Exit Sub
    'End If
    'MousePointer = vbHourGlass  'Wait
    sgGenMsg = "This will cause Unbilled Package Spots to be Removed, Ok to Proceed?"
    sgCMCTitle(0) = "&Ok"
    sgCMCTitle(1) = "&Cancel"
    sgCMCTitle(2) = ""
    sgCMCTitle(3) = ""
    igDefCMC = 1
    GenMsg.Show vbModal
    If igAnsCMC = 0 Then
        'Remove all unbilled PSF records
        mClearPSF
    End If
    'MousePointer = vbDefault    'Default
End Sub

Private Sub cmcClearPsf_GotFocus()
    If plcUnbilled.Visible Then
        plcUnbilled.Visible = False
        plcFromLine.Enabled = True
    End If
End Sub

Private Sub cmcGenerate_Click()
    Dim ilRet As Integer
    Dim llRet As Long
    Dim llRg As Long
    Dim ilValue As Integer
    Dim ilPreview As Integer
    Dim ilUpper As Integer
    Dim ilVeh As Integer
    Dim slNameCode As String
    Dim ilLoop As Integer
    Dim slCode As String
    Dim slDate As String
    Dim ilNowTime(0 To 1) As Integer        '10-31-01
    Dim slMsgFile As String                 'd.s. 11/6/01
    Dim llInvoiceNo As Long
    Dim llSvInvoiceNo As Long
    Dim slStr As String
    Dim slUserName As String
    Dim slRPRPDate As String
    Dim slStdDate As String
    Dim ilStopUndo As Integer
    Dim tlRhf As RHF
    Dim hlSpf As Integer
    Dim ilSpfRecLen As Integer
    Dim ilUpdateRhf As Integer
    Dim slNowDate As String
    Dim ilStdCntrRolledBack As Integer
    Dim ilCalCntrRolledBack As Integer
    Dim ilWkCntrRolledBack As Integer
    Dim slCalDate As String
    Dim slWkDate As String
    ReDim tmInvAirNTRStatus(0 To 0) As INVAIRNTRSTATUS
    'TTP 10697 - Ad server tab and working proposals status triggering billing alert
    lbcUnbilled.Clear 'the list isnt being cleared inbetween attempts to run invoices

    '07-26-22 - JW - when in "Selective" mode, make sure a Invoice has been selected
    '04-20-23 - JW - this seems to cause issues with Reprint, so Limiting to Final
    If rbcType(INVGEN_Final).Value Then
        If rbcCntr(INVCNTR_Selective).Value = True Then
            ilRet = 0
            For ilLoop = grdAirTime.FixedRows To grdAirTime.rows - 1 Step 1
                If grdAirTime.TextMatrix(ilLoop, ATBILLINDEX) <> "" Then
                    If grdAirTime.TextMatrix(ilLoop, ATSELECTEDINDEX) = "1" Then
                        ilRet = 1
                        Exit For
                    End If
                End If
            Next ilLoop
            If ilRet = 0 Then
                Beep
                ilRet = MsgBox("Invoice has not been selected", vbOKOnly + vbExclamation, "Message")
                Exit Sub
            End If
        End If
    End If

    Dim olReportMaster As CReportHelper '11-20-08 for multiple reports and crxi
    Dim llTempTime As Long
    Dim ilAdvt As Integer
    Dim hlSaf As Integer
    Dim tlSafSrchKey0 As INTKEY0
    '6/5/12: Check that dates selected
    If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value Then            '11-15-16 archiving is same as a reprint
        'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
        'If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked)) And ((ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked) Or (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked)) And (lbcDates.ListIndex < 0) Then
        If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked)) And ((ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked) Or (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked)) And (cbcDates.ListIndex < 1) Then
            Beep
            ilRet = MsgBox("Reprint Month has not been selected", vbOKOnly + vbExclamation, "Message")
            Exit Sub
        End If
        'If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked)) And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked) And (lbcWeek.ListIndex < 0) Then
        If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked)) And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked) And (cbcWeek.ListIndex < 1) Then
            Beep
            ilRet = MsgBox("Reprint Week has not been selected", vbOKOnly + vbExclamation, "Message")
            Exit Sub
        End If
    End If
    lbcView.Visible = False
    ReDim tmViewListInfo(0 To 0) As VIEWLISTINFO
    If Not imUpdateAllowed Then
        If (Not rbcType(INVGEN_Reprint).Value) And (Not rbcType(INVGEN_Archive).Value) Then           '11-15-16 test for reprint, archive
            Exit Sub
        End If
    End If
    lmLockRecCode = 0
    If rbcType(INVGEN_Final).Value Then
        If mUserInPostLog(slUserName) Then
            Beep
            ilRet = MsgBox("Post Log being currently in use by " & slUserName & ", Final Invoicing disallowed", vbOKOnly + vbExclamation, "Message")
            Exit Sub
        End If
        If gFindLockRec(hmRlf, "R", "Z", -1, False, slUserName) Then
            ilRet = MsgBox("Zero-Purge currently being run by " & slUserName & ", Final Invoicing disallowed", vbOKOnly + vbInformation, "Block")
            Exit Sub
        ElseIf gFindLockRec(hmRlf, "R", "R", -1, False, slUserName) Then
            ilRet = MsgBox("Reconcile currently being run by " & slUserName & ", Final Invoicing disallowed", vbOKOnly + vbInformation, "Block")
            Exit Sub
        ElseIf gFindLockRec(hmRlf, "I", "U", -1, False, slUserName) Then
            ilRet = MsgBox("Undo currently being run by " & slUserName & ", Final Invoicing disallowed", vbOKOnly + vbInformation, "Block")
            Exit Sub
        End If
        lmLockRecCode = gCreateLockRec(hmRlf, "I", "F", lmStartStd, False, slUserName)
        If lmLockRecCode = 0 Then
            Beep
            ilRet = MsgBox("Final Invoices being currently run by " & slUserName, vbOKOnly + vbExclamation, "Message")
            Exit Sub
        End If
        'Test if any user is within Post Log
    End If
    If rbcType(INVGEN_Undo).Value Then    'Undo Invoices
        If mUserInPostLog(slUserName) Then
            Beep
            ilRet = MsgBox("Post Log being currently in use by " & slUserName & ", Undo Invoicing disallowed", vbOKOnly + vbInformation, "Message")
            Exit Sub
        End If
        If gFindLockRec(hmRlf, "R", "Z", -1, False, slUserName) Then
            ilRet = MsgBox("Zero-Purge currently being run by " & slUserName & ", Undo Invoicing disallowed", vbOKOnly + vbInformation, "Block")
            Exit Sub
        ElseIf gFindLockRec(hmRlf, "R", "R", -1, False, slUserName) Then
            ilRet = MsgBox("Reconcile currently being run by " & slUserName & ", Undo Invoicing disallowed", vbOKOnly + vbInformation, "Block")
            Exit Sub
        ElseIf gFindLockRec(hmRlf, "I", "F", -1, False, slUserName) Then
            ilRet = MsgBox("Final Invoices currently being run by " & slUserName & ", Undo Invoicing disallowed", vbOKOnly + vbInformation, "Block")
            Exit Sub
        End If
        lmLockRecCode = gCreateLockRec(hmRlf, "I", "U", 0, False, slUserName)
        If lmLockRecCode = 0 Then
            Beep
            ilRet = MsgBox("Undo Invoices being currently run by " & slUserName, vbOKOnly + vbInformation, "Message")
            Exit Sub
        End If

    End If
    smStartInvTime = Format$(Now, "h:mm:ssAM/PM")
    '2/23/12:  Allow End of Contract billing
    'If (Not imFullStd) And (rbcType(INVGEN_Final).Value) Then
    '    If (ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_GenRepAR).Value = vbChecked) Then
    '        MsgBox "Not at End of Broadcast Month, must be at the End of the Month to Generate Final Invoices", vbOkOnly, "Invoicing"
    '        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
    '        Exit Sub
    '    End If
    'End If
    ' Dan 8-14-09 hold off deleting prepass until after csiNetReporter2
    bgComingFromInvoice = True
    ReDim igPreviousTimes(0 To 1, 0 To 0) As Integer
    ReDim igPreviousDates(0 To 1, 0 To 0) As Integer

    lmInstallCntrNo = -1
    ReDim tgSbfInstall(0 To 0) As SBFCNTR
    ReDim tmInstallCntStatus(0 To 0) As INVCNTRSTATUS
    ReDim tgSbfCntr(0 To 0) As SBFCNTR
    ReDim tmNTRCntStatus(0 To 0) As INVCNTRSTATUS
    ReDim tgCPMCntr(0 To 0) As CPMCNTR
    ReDim tmCPMCntStatus(0 To 0) As INVCNTRSTATUS
    ReDim lmANAddedRvf(0 To 0) As Long
    ReDim lmANAddedPhf(0 To 0) As Long
    ReDim tmViewListInfo(0 To 0) As VIEWLISTINFO
    ReDim tmAirNTRCombine(0 To 0) As AIRNTRCOMBINE
    ReDim tgInvPDF_Info(0 To 0) As INVPDF_INFO      '9-28-16 init array of unique agy or direct adv codes to filter for pdf export
    ReDim tgInvPDF_DetailInfo(0 To 0) As InvPDF_DETAILINFO      '7-6-17 init array of pdf invoices created
    ReDim sgSetSelectionForFinals(0 To 0) As String       '12-27-16
    ReDim sgSetSelectionForAll(0 To 0) As String          '12-27-16
    ReDim tgInvPDFEmailer_ErrMsg(0 To 0) As InvPDFEmailer_ErrMsg  'error messages from send email operation
    
    If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value Then        '11-15-16 reprint, archive
        If rbcInvSpotTimeZone(0).Value Then
            smInvSpotTimeZone = "E"
        ElseIf rbcInvSpotTimeZone(1).Value Then
            smInvSpotTimeZone = "C"
        ElseIf rbcInvSpotTimeZone(2).Value Then
            smInvSpotTimeZone = "M"
        ElseIf rbcInvSpotTimeZone(3).Value Then
            smInvSpotTimeZone = "P"
        Else
            smInvSpotTimeZone = "N"
        End If
    End If
    If (ckcType(INVTYPE_Commercial).Value = vbChecked) And (ckcType(INVTYPE_NTR).Value = vbChecked) And ((tgSpf.sUsingNTR = "Y") Or ((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) = INSTALLMENT)) Then 'Commercial + NTR or INSTALLMENT
        If ((Asc(tgSpf.sUsingFeatures5) And COMBINEAIRNTR) = COMBINEAIRNTR) Or (((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) = INSTALLMENT)) Then
            imCombineAirAndNTR = True
        Else
            imCombineAirAndNTR = False
        End If
    Else
        imCombineAirAndNTR = False
    End If
    
    imArfPDFEMailCode = -1
    bmEDIInstallBypassed = False
    ReDim lmEDIInstallBypass(0 To 0) As Long
    bmEDINTRBypassed = False
    ReDim lmEDINTRBypass(0 To 0) As Long
    bmEDICPMBypassed = False
    ReDim lmEDICPMBypass(0 To 0) As Long
    
    'Reprint- set dates
    If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value Then        '11-15-16 reprint or archive
        '''If lbcDates.ListIndex < 0 Then
        ''If ((lbcDates.ListIndex < 0) And ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_PrintRep).Value = vbChecked))) Or ((lbcWeek.ListIndex < 0) And (ckcType(INVTYPE_Installment).Value = vbChecked)) Then
        'If (((lbcDates.ListIndex >= 0) Or (lbcWeek.ListIndex >= 0)) And ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_PrintRep).Value = vbChecked))) Then
        'Else
        'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
        'If ((lbcDates.ListIndex < 0) And (lbcWeek.ListIndex < 0)) Then
        'If ((cbcDates.ListIndex < 1) And (lbcWeek.ListIndex < 0)) Then
        If ((cbcDates.ListIndex < 1) And (lbcWeek.ListIndex < 1)) Then
            Exit Sub
        End If
        If Not rbcAdvt(1).Value Then
            mBuildDates
        End If
    End If
    
    'TTP 10960 - Invoice: digital lines will get partially invoiced if final invoices are run before the lines are expired/month is over
    'mCPM_BuildBypassCntr
    mCPM_BuildBypassCntr imFullCal, lmEndCal, imFullWk, lmEndWk, imFullStd, lmEndStd
    mSaveDates
    mClearDates
    
    'DL 6/19/03:  Bypass test if reprinting
    If rbcType(INVGEN_Reprint).Value = False And rbcType(INVGEN_Archive).Value = False Then       '11-15-16 not reprint and not archive
        'DL 10/28/02: Test in only part of month invoiced, if so disallow Print Rep Invoices.
        If ckcType(INVTYPE_PrintRep).Value = vbChecked Then
            gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slDate
            lmSpfStdDate = gDateValue(slDate)
            gPackDate lmSpfStdDate + 1, tmRvfSrchKey3.iTranDate(0), tmRvfSrchKey3.iTranDate(1)
            ilRet = btrGetGreaterOrEqual(hmRvf, tmRvf, imRvfRecLen, tmRvfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
            Do While (ilRet = BTRV_ERR_NONE)
                '9/20/06: Ignore Merchandising
                If (tmRvf.sTranType = "IN") And (tmRvf.iMnfItem = 0) And ((tmRvf.sCashTrade = "C") Or (tmRvf.sCashTrade = "T")) And (tmRvf.sInvoiceUndone <> "Y") Then
                    MsgBox "Partial Month Previously Invoiced, Unable to Run 'Print Rep Invoices' Until Entire Month Invoiced", vbOKOnly, "Invoicing"
                    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
                    Exit Sub
                End If
                ilRet = btrGetNext(hmRvf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
        End If

        'DL 10/11/02
        If ckcType(INVTYPE_PrintRep).Value = vbChecked Then
            gUnpackDate tgSpf.iRepPrintDate(0), tgSpf.iRepPrintDate(1), smRepPrintDate
            If Not gValidDate(smRepPrintDate) Then
                MsgBox "'Last Rep Print Date' is not valid in Site Option, Invoice tab", vbOKOnly, "Invoicing"
                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
                Exit Sub
            End If
            If gDateValue(smRepPrintDate) <= gDateValue("10/31/1999") Then
                MsgBox "'Last Rep Print Date' must be after 10/31/1999 in Site Option, Invoice tab", vbOKOnly, "Invoicing"
                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
                Exit Sub
            End If
        End If
    End If

    ilRet = mOpenMsgFile(slMsgFile)
    'Taken from below (after NTR check) and moved here
    If (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Aff).Value) Or (rbcType(INVGEN_Undo).Value) Or (rbcType(INVGEN_Archive).Value) Then     '11-15-16 Reprint; Affidavit; Revise, or archive
        rbcCntr(INVCNTR_All).Value = True
        'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
        'If ((lbcDates.ListIndex < 0) And (lbcWeek.ListIndex < 0)) Then
        If ((cbcDates.ListIndex < 1) And (lbcWeek.ListIndex < 1)) Then
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            imGenInv = False
            Invoice.Enabled = True
            DoEvents
            Beep
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'If (lbcDates.Enabled) And ((ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked) Or (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked)) Then
            If (cbcDates.Enabled) And ((ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked) Or (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked)) Then
                cbcDates.SetFocus
            'ElseIf (lbcWeek.Enabled) And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked) Then
            ElseIf (cbcWeek.Enabled) And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked) Then
                'lbcWeek.SetFocus
                cbcWeek.SetFocus
            End If
            'd.s. 11/6/01
            Print #hmMsg, "No date was selected."
            Close #hmMsg
            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
            Exit Sub
        End If

        If rbcType(INVGEN_Undo).Value Then
            'Check if Reconclie would have to be rolled back
            mRollbackReconcRequired
            gUnpackDate tgSpf.iRPRP(0), tgSpf.iRPRP(1), slRPRPDate
            slRPRPDate = gAdjYear(slRPRPDate)
            slStdDate = gAdjYear(smStartStd)
            ilStopUndo = False
            If imRollbackReconcRequired = 1 Then
                'Disallow
                ilStopUndo = True
                MsgBox gMonthName(slRPRPDate) & " closed before Billing " & gMonthName(slRPRPDate) & ", call Counterpoint", vbCritical + vbOKOnly, "Warning"
            ElseIf imRollbackReconcRequired = 2 Then
                ilStopUndo = True
                MsgBox "This feature has just been installed and can't be used until one month has been Reconciled, call Counterpoint", vbCritical + vbOKOnly, "Warning"
            ElseIf imRollbackReconcRequired = 3 Then
                'Roll back Ok
                ilRet = MsgBox("The Reconcile closing period " & gMonthName(slRPRPDate) & " and its Zero Purge will be Rolled Back, continue with Undo operation", vbQuestion + vbYesNo, "Warning")
                If ilRet = vbNo Then
                    ilStopUndo = True
                Else
                    ilRet = mRollbackZeroPurge()
                    If Not ilRet Then
                        ilStopUndo = True
                    End If
                End If
            End If
            If ilStopUndo Then
                imGenInv = False
                Invoice.Enabled = True
                DoEvents
                Beep
                'd.s. 11/6/01
                Print #hmMsg, "Undo stopped because of Reconcile date."
                Close #hmMsg
                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
                Exit Sub
            End If
        End If

        'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
        bsSelectedEmailInvoices = ""
        bgSendSelevtivePDF = False
        If (rbcType(INVGEN_Reprint).Value) Then 'Reprint Only
            If rbcAdvt(1).Value = True Then 'Selective Only
                If (tgSpfx.iInvExpFeature And INVEXP_SELECTIVEEMAIL) = INVEXP_SELECTIVEEMAIL Then  'Selective reprint only setting is enabled in Site
                    bgSendSelevtivePDF = True
                End If
            End If
        End If

        ReDim tgSortKey(0 To 0) As TYPESORTKEY
        ReDim tgSortNoKey(0 To 0) As TYPESORTNOKEY
        'Get all vehicles that could have been invoiced
        lbcVehicle.Clear
        ReDim tmInvVehicle(0 To 0) As SORTCODE
        smInvVehicleTag = ""
        ilRet = gPopUserVehicleBox(Invoice, VEHCONV_WO_FEED + VEHCONV_W_FEED + VEHSELLING + VEHVIRTUAL + ACTIVEVEH + DORMANTVEH, lbcVehicle, tmInvVehicle(), smInvVehicleTag)
        'Build lbcCntr and lbcCntrCode from invoice numbers to be generated
        imBypassVehSelect = True
        ilValue = False
        If lbcVehicle.ListCount > 0 Then
            llRg = CLng(lbcVehicle.ListCount - 1) * &H10000 Or 0
            llRet = SendMessageByNum(lbcVehicle.HWnd, LB_SELITEMRANGE, ilValue, llRg)
        End If
        imBypassVehSelect = False
        ReDim tgInvVehCode(0 To 0) As VEHSORT
        For ilVeh = 0 To lbcVehicle.ListCount - 1 Step 1
            slNameCode = Trim$(tmInvVehicle(ilVeh).sKey) 'Traffic!lbcVehicle.List(ilVeh)
            tgInvVehCode(UBound(tgInvVehCode)).sKey = slNameCode
            ilRet = gParseItem(Trim$(slNameCode), 2, "\", slCode)
            tgInvVehCode(UBound(tgInvVehCode)).iCode = Val(slCode)
            ReDim Preserve tgInvVehCode(0 To UBound(tgInvVehCode) + 1) As VEHSORT
        Next ilVeh
        '4/24/14: Undo invoicing does not blank out revenue rows.
        'If rbcAdvt(0).Value Then
        If (rbcAdvt(0).Value) And (Not rbcType(INVGEN_Undo).Value) Then
            mSelAdvt
            For ilLoop = grdRevenue.FixedRows To grdRevenue.rows - 1 Step 1
                If grdRevenue.TextMatrix(ilLoop, ADVTINDEX) <> "" Then
                    grdRevenue.TextMatrix(ilLoop, SELECTEDINDEX) = "1"
                End If
            Next ilLoop
        End If
        ReDim tmRPInfo(0 To 0) As RPINFO
        ilUpper = 0
        For ilLoop = grdRevenue.FixedRows To grdRevenue.rows - 1 Step 1
            If grdRevenue.TextMatrix(ilLoop, ADVTINDEX) <> "" Then
                If grdRevenue.TextMatrix(ilLoop, SELECTEDINDEX) = "1" Then
                    ilAdvt = Val(grdRevenue.TextMatrix(ilLoop, INDEXCODEINDEX))
                    'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                    tmRPInfo(ilUpper).iAdfCode = tmRPSelInfo(ilAdvt).iAdfCode
                    tmRPInfo(ilUpper).iAgfCode = tmRPSelInfo(ilAdvt).iAgfCode
                    tmRPInfo(ilUpper).lCntrNo = tmRPSelInfo(ilAdvt).lCntrNo
                    tmRPInfo(ilUpper).lInvNo = tmRPSelInfo(ilAdvt).lInvNo
                    tmRPInfo(ilUpper).iAirVefCode = tmRPSelInfo(ilAdvt).iAirVefCode
                    tmRPInfo(ilUpper).sCashTrade = tmRPSelInfo(ilAdvt).sCashTrade
                    tmRPInfo(ilUpper).iBillVefCode = tmRPSelInfo(ilAdvt).iBillVefCode
                    tmRPInfo(ilUpper).iPkLineNo = tmRPSelInfo(ilAdvt).iPkLineNo
                    tmRPInfo(ilUpper).iMnfItem = tmRPSelInfo(ilAdvt).iMnfItem
                    tmRPInfo(ilUpper).lAirTax1 = tmRPSelInfo(ilAdvt).lAirTax1
                    tmRPInfo(ilUpper).lAirTax2 = tmRPSelInfo(ilAdvt).lAirTax2
                    tmRPInfo(ilUpper).lNTRTax1 = tmRPSelInfo(ilAdvt).lNTRTax1
                    tmRPInfo(ilUpper).lNTRTax2 = tmRPSelInfo(ilAdvt).lNTRTax2
                    tmRPInfo(ilUpper).sBillCycle = tmRPSelInfo(ilAdvt).sBillCycle
                    tmRPInfo(ilUpper).lInvStartDate = tmRPSelInfo(ilAdvt).lInvStartDate
                    tmRPInfo(ilUpper).lInvEndDate = tmRPSelInfo(ilAdvt).lInvEndDate
                    'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                    If bgSendSelevtivePDF = True Then
                        tmRPInfo(ilUpper).iSelectiveEmail = grdRevenue.TextMatrix(ilLoop, EMAILSELECTEDINDEX) 'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                    Else
                        tmRPInfo(ilUpper).iSelectiveEmail = 0
                    End If
                    ilUpper = ilUpper + 1
                    ReDim Preserve tmRPInfo(0 To ilUpper) As RPINFO
                End If
            End If
        Next ilLoop
        
        'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
        'Make a Comma sep list of Contracts that will be emailed.  Used in a NOT IN [x,x] clause for the displayed/printed contracts
        If bgSendSelevtivePDF = True Then
            For ilLoop = 0 To UBound(tmRPInfo) - 1
                If tmRPInfo(ilLoop).iSelectiveEmail = 1 Then 'this invoice is selected to email
                    If bsSelectedEmailInvoices <> "" Then bsSelectedEmailInvoices = bsSelectedEmailInvoices & ","
                    bsSelectedEmailInvoices = bsSelectedEmailInvoices & tmRPInfo(ilLoop).lInvNo
                End If
            Next ilLoop
        End If
        If UBound(tmRPInfo) <= LBound(tmRPInfo) Then
            MsgBox "No Contract Selected", vbCritical + vbOKOnly, "Warning"
            imGenInv = False
            Invoice.Enabled = True
            DoEvents
            Beep
            'd.s. 11/6/01
            Close #hmMsg
            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
            Exit Sub
        End If
        
        bgSendPDF = False                    'default PDF email off
        '6-22-17 Has PDF Email feature been turned on
        If (Asc(tgSaf(0).sFeatures3) And INVEMAILINDEX) = INVEMAILINDEX Then
            '1-5-17 ; 6-22-17 if reprint, ask user if OK to send emails to agency if its auto send; otherwise they wont be sent anyway
            If (rbcType(INVGEN_Reprint).Value) Then
                '10016
                'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                'Selective reprint only setting is enabled in Site
                If (tgSpfx.iInvExpFeature And INVEXP_SELECTIVEEMAIL) = INVEXP_SELECTIVEEMAIL Then  'Selective reprint only setting is enabled in Site
                    If rbcAdvt(1).Value = True Then
                        'PDF emails will only be sent for selective invoices that have the email checkbox checked at the time of generating the reprint.
                        bgSendPDF = True
                    End If
                Else
                    If (imPDFEmailAllowed = combine) Or (imPDFEmailAllowed = AirOnly And ckcType(INVTYPE_Commercial).Value = vbChecked) Or (imPDFEmailAllowed = NtrOnly And ckcType(INVTYPE_NTR).Value = vbChecked) Then
                        ilRet = MsgBox("OK to create PDF Reprint Invoices to Agency?", vbYesNo)
                        If ilRet = vbYes Then
                            bgSendPDF = True
                        End If
                    End If
                End If
            '6-22 if finals
            'ElseIf (rbcType(INVGEN_Final).Value) And ((Asc(tgSaf(0).sFeatures3) And INVSENDEMAILINDEX) = INVSENDEMAILINDEX) Then
            ElseIf (rbcType(INVGEN_Final).Value) Then
                'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                'If Selective Invoice mode, don't email on Final
                If (tgSpfx.iInvExpFeature And INVEXP_SELECTIVEEMAIL) = INVEXP_SELECTIVEEMAIL Then  'Selective reprint only setting is enabled in Site
                    'Final Invoices: Don't send email if the Selective reprint only setting is enabled in Site
                Else
                    bgSendPDF = True
                End If
            End If
        End If
    Else 'Not INVGEN_Reprint, INVGEN_Aff, INVGEN_Undo, or INVGEN_Archive (this is INVGEN_Preliminary or INVGEN_Final)
        rbcAdvt(0).Value = True
        If rbcCntr(INVCNTR_Selective).Value Or rbcCntr(INVCNTR_WOExpired).Value Or rbcCntr(INVCNTR_Posted).Value Then
            ReDim lmSelCntrCode(0 To 0) As Long
            For ilLoop = grdAirTime.FixedRows To grdAirTime.rows - 1 Step 1
                If grdAirTime.TextMatrix(ilLoop, ATBILLINDEX) <> "" Then
                    If grdAirTime.TextMatrix(ilLoop, ATSELECTEDINDEX) = "1" Then
                        lmSelCntrCode(UBound(lmSelCntrCode)) = Val(grdAirTime.TextMatrix(ilLoop, ATCHFCODEINDEX))
                        ReDim Preserve lmSelCntrCode(0 To UBound(lmSelCntrCode) + 1) As Long
                    End If
                End If
            Next ilLoop
        End If
        ReDim tgInvVehCode(0 To 0) As VEHSORT
        For ilVeh = 0 To lbcVehicle.ListCount - 1 Step 1
            If lbcVehicle.Selected(ilVeh) Then
                slNameCode = Trim$(tmInvVehicle(ilVeh).sKey) 'Traffic!lbcVehicle.List(ilVeh)
                tgInvVehCode(UBound(tgInvVehCode)).sKey = slNameCode
                ilRet = gParseItem(Trim$(slNameCode), 2, "\", slCode)
                tgInvVehCode(UBound(tgInvVehCode)).iCode = Val(slCode)
                ReDim Preserve tgInvVehCode(0 To UBound(tgInvVehCode) + 1) As VEHSORT
            End If
        Next ilVeh

        bgSendPDF = False                    'default PDF email off
        '6-22-17 Has PDF Email feature been turned on
        If (Asc(tgSaf(0).sFeatures3) And INVEMAILINDEX) = INVEMAILINDEX Then
            '1-5-17 ; 6-22-17 if reprint, ask user if OK to send emails to agency if its auto send; otherwise they wont be sent anyway
            If (rbcType(INVGEN_Reprint).Value) Then
                'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                'Site switch for Selective Invoice mode
                If (tgSpfx.iInvExpFeature And INVEXP_SELECTIVEEMAIL) = INVEXP_SELECTIVEEMAIL Then  'Selective reprint only setting is enabled in Site
                    bgSendPDF = True
                Else
                    ilRet = MsgBox("OK to create PDF Reprint Invoices to Agency?", vbYesNo)
                    If ilRet = vbYes Then
                        bgSendPDF = True
                    End If
                End If
            '6-22 if finals
            'ElseIf (rbcType(INVGEN_Final).Value) And ((Asc(tgSaf(0).sFeatures3) And INVSENDEMAILINDEX) = INVSENDEMAILINDEX) Then
            ElseIf (rbcType(INVGEN_Final).Value) Then
                'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                'Site switch for Selective Invoice mode
                If (tgSpfx.iInvExpFeature And INVEXP_SELECTIVEEMAIL) = INVEXP_SELECTIVEEMAIL Then  'Selective reprint only setting is enabled in Site
                    bgSendPDF = False 'Dont email when Selected Invoice mode is enabled
                Else
                    bgSendPDF = True
                End If
            End If
        End If
    End If
    'Check if Scheduling conflict with NTR
    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    ilRet = gObtainAdvt()
    ilRet = gObtainAgency()
    ilRet = gObtainTrf()
    mInitEDIServices
    ReDim tmAcqWithCommInfo(0 To 0) As ACQWITHCOMMINFO

    'Moved here because ---_ReadRec will use the hmMsg handle
    igInvErrFlag = False
    'ilRet = mOpenMsgFile(slMsgFile)
    'Print #hmMsg, "Invoicing for "; Format$(Now, "m/d/yy") & " at " & Format$(Now, "h:mm:ssAM/PM")
    If rbcType(INVGEN_Undo).Value Then
        Print #hmMsg, "Invoicing Undo for "; Format$(Now, "m/d/yy") & " at " & Format$(Now, "h:mm:ssAM/PM")
        '7/31/19: Remove parameter as not used and was amount was over 21,000,000.00
        ilRet = gUndoInvoice(lmSvStartStd, lmSvEndStd, lmSvStartCal, lmSvEndCal, lmSvStartWk, lmSvEndWk, tmRPInfo(), hmRvf, hmPhf, hmSbf, hmSdf, hmSmf, hmPsf, hmVef, hmCHF, hmClf, hmMsf, hmMgf, hmGsf, hmApf, ilStdCntrRolledBack, ilCalCntrRolledBack, ilWkCntrRolledBack)   ', llReconcileAdjustment)
        Screen.MousePointer = vbDefault
        gSetMousePointer grdAirTime, grdRevenue, vbDefault
        If ilRet Then
            hlSpf = CBtrvTable(TWOHANDLES)
            ilRet = btrOpen(hlSpf, "", sgDBPath & "Spf.btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
            ilSpfRecLen = Len(tgSpf)
            ilRet = btrGetLast(hmRhf, tmRhf, imRhfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)
            If ilRet = BTRV_ERR_NONE Then
                If (imRollbackReconcRequired = 3) Or (imRollbackReconcRequired = 4) Then
                    '7/31/19: Remove parameter as not used and was amount was over 21,000,000.00
                    mReconcTextFile tmRhf, imRollbackReconcRequired ', gLongToStrDec(llReconcileAdjustment, 2)
                    'Roll back Closing period
                    If (imRollbackReconcRequired = 3) Then
                        ilUpdateRhf = True
                    Else
                        ilUpdateRhf = False
                    End If
                    Do
                        ilRet = btrGetFirst(hlSpf, tgSpf, ilSpfRecLen, 0, BTRV_LOCK_NONE, SETFORWRITE)  'Get first record as starting point of extend operation
                        If ilUpdateRhf Then
                            tlRhf.iCode = 0
                            tlRhf.sSourceType = "U"
                            tlRhf.sRRP = tgSpf.sRRP
                            gPDNToStr tgSpf.sRB, 2, slStr
                            gStrToPDN slStr, 2, 6, tlRhf.sRB
                            tlRhf.iRPRP(0) = tgSpf.iRPRP(0)
                            tlRhf.iRPRP(1) = tgSpf.iRPRP(1)
                            tlRhf.iRCRP(0) = tgSpf.iRCRP(0)
                            tlRhf.iRCRP(1) = tgSpf.iRCRP(1)
                            tlRhf.iRNRP(0) = tgSpf.iRNRP(0)
                            tlRhf.iRNRP(1) = tgSpf.iRNRP(1)
                            tlRhf.iUrfCode = tgUrf(0).iCode
                            slNowDate = Format$(gNow(), "m/d/yy")
                            gPackDate slNowDate, tlRhf.iDateEntered(0), tlRhf.iDateEntered(1)
                            tlRhf.sUnused = ""
                            ilRet = btrInsert(hmRhf, tlRhf, imRhfRecLen, INDEXKEY0)
                            If ilRet <> BTRV_ERR_NONE Then
                                If ilRet >= 30000 Then
                                    ilRet = csiHandleValue(0, 7)
                                End If
                                Print #hmMsg, "cmcGenerate: btrInsert-Point 1, Rhf Error # " & Trim$(str$(ilRet))
                            End If
                            ilUpdateRhf = False
                        End If
                        If (imRollbackReconcRequired = 3) Then
                            tgSpf.iRPRP(0) = tmRhf.iRPRP(0)
                            tgSpf.iRPRP(1) = tmRhf.iRPRP(1)
                            tgSpf.iRCRP(0) = tmRhf.iRCRP(0)
                            tgSpf.iRCRP(1) = tmRhf.iRCRP(1)
                            tgSpf.iRNRP(0) = tmRhf.iRNRP(0)
                            tgSpf.iRNRP(1) = tmRhf.iRNRP(1)
                            gPDNToStr tmRhf.sRB, 2, slStr
                            gStrToPDN slStr, 2, 6, tgSpf.sRB
                            ilRet = btrUpdate(hlSpf, tgSpf, ilSpfRecLen)
                        End If
                        'gPDNToStr tgSpf.sRB, 2, slStr
                        'slStr = gAddStr(slStr, gLongToStrDec(llReconcileAdjustment, 2))
                        'gStrToPDN slStr, 2, 6, tgSpf.sRB
                        'ilRet = btrUpdate(hlSpf, tgSpf, ilSpfRecLen)
                    Loop While ilRet = BTRV_ERR_CONFLICT
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        Print #hmMsg, "cmcGenerate: btrUpdate-Point 1, Spf Error # " & Trim$(str$(ilRet))
                    End If
                End If
            End If
            If ilStdCntrRolledBack Then
                Do
                    ilRet = btrGetFirst(hlSpf, tgSpf, ilSpfRecLen, 0, BTRV_LOCK_NONE, SETFORWRITE)  'Get first record as starting point of extend operation
                    If ilRet = BTRV_ERR_NONE Then
                        gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slDate
                        slDate = gAdjYear(slDate)
                        slStdDate = gAdjYear(smEndStd)
                        If (Year(slDate) = Year(slStdDate)) And (Month(slDate) = Month(slStdDate)) Then
                            slStdDate = gDecOneDay(gObtainStartStd(slStdDate))
                            gPackDate slStdDate, tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1)
                            ilRet = btrUpdate(hlSpf, tgSpf, ilSpfRecLen)
                        End If
                    End If
                Loop While ilRet = BTRV_ERR_CONFLICT
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    Print #hmMsg, "cmcGenerate: btrUpdate-Point 2, Spf Error # " & Trim$(str$(ilRet))
                End If
            End If
            If ilCalCntrRolledBack Then
                Do
                    ilRet = btrGetFirst(hlSpf, tgSpf, ilSpfRecLen, 0, BTRV_LOCK_NONE, SETFORWRITE)  'Get first record as starting point of extend operation
                    If ilRet = BTRV_ERR_NONE Then
                        gUnpackDate tgSpf.iBLastCalMnth(0), tgSpf.iBLastCalMnth(1), slDate
                        slDate = gAdjYear(slDate)
                        slCalDate = gAdjYear(smEndCal)
                        If (Year(slDate) = Year(slCalDate)) And (Month(slDate) = Month(slCalDate)) Then
                            slCalDate = gDecOneDay(gObtainStartCal(slCalDate))
                            gPackDate slCalDate, tgSpf.iBLastCalMnth(0), tgSpf.iBLastCalMnth(1)
                            ilRet = btrUpdate(hlSpf, tgSpf, ilSpfRecLen)
                        End If
                    End If
                Loop While ilRet = BTRV_ERR_CONFLICT
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    Print #hmMsg, "cmcGenerate: btrUpdate-Point 3, Spf Error # " & Trim$(str$(ilRet))
                End If
            End If
            If ilWkCntrRolledBack Then
                hlSaf = CBtrvTable(TWOHANDLES)
                ilRet = btrOpen(hlSaf, "", sgDBPath & "Saf.btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
                Do
                    tlSafSrchKey0.iCode = tgSaf(0).iCode
                    ilRet = btrGetEqual(hlSaf, tgSaf(0), Len(tgSaf(0)), tlSafSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                    If ilRet = BTRV_ERR_NONE Then
                        gUnpackDate tgSaf(0).iBLastWeeklyDate(0), tgSaf(0).iBLastWeeklyDate(1), slDate
                        slDate = gAdjYear(slDate)
                        slWkDate = gAdjYear(smEndWk)
                        If (Year(slDate) = Year(slWkDate)) And (Month(slDate) = Month(slWkDate)) Then
                            slWkDate = gDecOneDay(gObtainPrevMonday(slWkDate))
                            gPackDate slWkDate, tgSaf(0).iBLastWeeklyDate(0), tgSaf(0).iBLastWeeklyDate(1)
                            ilRet = btrUpdate(hlSaf, tgSaf(0), Len(tgSaf(0)))
                        End If
                    End If
                Loop While ilRet = BTRV_ERR_CONFLICT
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    Print #hmMsg, "cmcGenerate: btrUpdate-Point 3, Saf Error # " & Trim$(str$(ilRet))
                End If
                ilRet = btrClose(hlSaf)
                btrDestroy hlSaf
            End If
            ilRet = btrClose(hlSpf)
            btrDestroy hlSpf
        End If
        Print #hmMsg, "Undo Invoice completed."
        Close #hmMsg
        imRollbackReconcRequired = -1
        mRollbackReconcRequired
        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
        '4/24/14: Set to selective
        'mSelAdvt
        If rbcAdvt(0).Value Then
            rbcAdvt(1).Value = True
        Else
            mSelAdvt
        End If
        Exit Sub
    End If
    Print #hmMsg, "Invoicing for "; Format$(Now, "m/d/yy") & " at " & Format$(Now, "h:mm:ssAM/PM")
    If rbcType(INVGEN_Final).Value Then
        If (Asc(tgSaf(0).sFeatures2) And ACQUISITIONCOMMISSIONABLE) = ACQUISITIONCOMMISSIONABLE Then 'Acquisition Commissionable then
            ilRet = gBuildAcqCommInfo(Invoice)
        End If
    End If
    mBuildInvVehicleSort
    If (ckcType(INVTYPE_NTR).Value = vbChecked) And ((rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value)) Then    'NTR Invoices
        smUpdateMsg = "Checking for Rev Working or Unschedule NTR orders:  Invoices cannot be processed if any exist"
        edcUpdating.Text = smUpdateMsg
        edcUpdating.Visible = True
        DoEvents
        ilRet = mNTR_ReadRec()
        edcUpdating.Visible = False
        DoEvents
        If imNTRStatusConflict Then
            'Show Red screen
            For ilLoop = 0 To UBound(tmNTRCntStatus) - 1 Step 1
                If (tmNTRCntStatus(ilLoop).lChfCodeAltered <> 0) Or (tmNTRCntStatus(ilLoop).lChfCodeSchd <> 0) Then
                    slStr = Trim$(str$(tmNTRCntStatus(ilLoop).lCntrNo))
                    ilRet = gBinarySearchAdf(tmNTRCntStatus(ilLoop).iAdfCode)
                    If ilRet <> -1 Then
                        slStr = slStr & " " & Trim$(tgCommAdf(ilRet).sName)
                    End If
                    If (tmNTRCntStatus(ilLoop).sSchStatus = "N") Or (tmNTRCntStatus(ilLoop).sSchStatus = "A") Then
                        slStr = slStr & ": Unscheduled"
                    Else
                        slStr = slStr & ": Pending Rev"
                    End If
                    lbcUnbilled.AddItem slStr
                End If
            Next ilLoop
            Print #hmMsg, "User needs to Approve Proposals or Schedule Orders"
            Close #hmMsg
            lbcUnbilled.AddItem "Approve Proposals or Schedule Orders, then re-run invoicing", 0
            plcFromLine.Enabled = False
            plcUnbilled.ZOrder
            plcUnbilled.Visible = True
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            DoEvents
            Exit Sub
        End If
        mRestoreDates
        mClearDates
    End If
    If ((Asc(tgSaf(0).sFeatures8) And PODADSERVER) = PODADSERVER) And (ckcType(INVTYPE_Commercial).Value = vbChecked) And ((rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value)) Then    'AdServer + Commercial + Preliminary or Final
        smUpdateMsg = "Checking for Rev Working or Unschedule Digital orders:  Invoices cannot be processed if any exist"
        edcUpdating.Text = smUpdateMsg
        edcUpdating.Visible = True
        DoEvents
        ilRet = mCPM_ReadRec()
        
        edcUpdating.Visible = False
        DoEvents
        If imCPMStatusConflict Then
            'Show Red screen
            For ilLoop = 0 To UBound(tmCPMCntStatus) - 1 Step 1
                If (tmCPMCntStatus(ilLoop).lChfCodeAltered <> 0) Or (tmCPMCntStatus(ilLoop).lChfCodeSchd <> 0) Then
                    slStr = Trim$(str$(tmCPMCntStatus(ilLoop).lCntrNo))
                    ilRet = gBinarySearchAdf(tmCPMCntStatus(ilLoop).iAdfCode)
                    If ilRet <> -1 Then
                        slStr = slStr & " " & Trim$(tgCommAdf(ilRet).sName)
                    End If
                    If (tmCPMCntStatus(ilLoop).sSchStatus = "N") Or (tmCPMCntStatus(ilLoop).sSchStatus = "A") Then
                        slStr = slStr & ": Unscheduled"
                    Else
                        slStr = slStr & ": Pending Rev"
                    End If
                    lbcUnbilled.AddItem slStr
                End If
            Next ilLoop
            Print #hmMsg, "User needs to Approve Proposals or Schedule Orders"
            Close #hmMsg
            lbcUnbilled.AddItem "Approve Proposals or Schedule Orders, then re-run invoicing", 0
            plcFromLine.Enabled = False
            plcUnbilled.ZOrder
            plcUnbilled.Visible = True
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            DoEvents
            Exit Sub
        End If
        mRestoreDates
        mClearDates
    End If

    If (ckcType(INVTYPE_Commercial).Value = vbChecked) And ((rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value)) Then    'NTR Invoices
        smUpdateMsg = "Checking for Rev Working or Unschedule orders:  Invoices cannot be processed if any exist"
        edcUpdating.Text = smUpdateMsg
        edcUpdating.Visible = True
        DoEvents
        ilRet = mInstall_ReadRec()
        edcUpdating.Visible = False
        DoEvents
        If imInstallStatusConflict Then
            'Show Red screen
            For ilLoop = 0 To UBound(tmInstallCntStatus) - 1 Step 1
                If (tmInstallCntStatus(ilLoop).lChfCodeAltered <> 0) Or (tmInstallCntStatus(ilLoop).lChfCodeSchd <> 0) Then
                    slStr = Trim$(str$(tmInstallCntStatus(ilLoop).lCntrNo))
                    ilRet = gBinarySearchAdf(tmInstallCntStatus(ilLoop).iAdfCode)
                    If ilRet <> -1 Then
                        slStr = slStr & " " & Trim$(tgCommAdf(ilRet).sName)
                    End If
                    If (tmInstallCntStatus(ilLoop).sSchStatus = "N") Or (tmInstallCntStatus(ilLoop).sSchStatus = "A") Then
                        slStr = slStr & ": Unscheduled"
                    Else
                        slStr = slStr & ": Pending Rev"
                    End If
                    lbcUnbilled.AddItem slStr
                End If
            Next ilLoop
            Print #hmMsg, "User needs to Approve Proposals or Schedule Orders"
            Close #hmMsg
            lbcUnbilled.AddItem "Approve Proposals or Schedule Orders, then re-run invoicing", 0
            plcFromLine.Enabled = False
            plcUnbilled.ZOrder
            plcUnbilled.Visible = True
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            DoEvents
            Exit Sub
        End If
    End If
    If (ckcType(INVTYPE_Commercial).Value = vbChecked) And ((rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value)) Then    'Air time Invoices
        smUpdateMsg = "Checking for Rev Working or Unschedule Air Time orders:  Invoices cannot be processed if any exist"
        edcUpdating.Text = smUpdateMsg
        edcUpdating.Visible = True
        DoEvents
        mCheckAirCntr
        edcUpdating.Visible = False
        DoEvents
        If imAirStatusConflict Then
            'Show Red screen
            For ilLoop = 0 To UBound(tmAirCntStatus) - 1 Step 1
                If (tmAirCntStatus(ilLoop).lChfCodeAltered <> 0) Or (tmAirCntStatus(ilLoop).lChfCodeSchd <> 0) Then
                    slStr = Trim$(str$(tmAirCntStatus(ilLoop).lCntrNo))
                    ilRet = gBinarySearchAdf(tmAirCntStatus(ilLoop).iAdfCode)
                    If ilRet <> -1 Then
                        slStr = slStr & " " & Trim$(tgCommAdf(ilRet).sName)
                    End If
                    If (tmAirCntStatus(ilLoop).sSchStatus = "N") Or (tmAirCntStatus(ilLoop).sSchStatus = "A") Then
                        slStr = slStr & ": Unscheduled"
                    Else
                        slStr = slStr & ": Pending Rev"
                    End If
                    lbcUnbilled.AddItem slStr
                End If
            Next ilLoop
            Print #hmMsg, "User needs to Approve Proposals or Schedule Orders"
            Close #hmMsg
            lbcUnbilled.AddItem "Approve Proposals or Schedule Orders, then re-run invoicing", 0
            plcFromLine.Enabled = False
            plcUnbilled.ZOrder
            plcUnbilled.Visible = True
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            DoEvents
            Exit Sub
        End If
    End If
    If rbcType(INVGEN_Final).Value Then    'Final
        ilRet = gObtainPIF_ForDate(hmPif, smStartStd, tmPif())
    Else
        ReDim tmPif(0 To 0) As PIF
    End If
    imPrintRepInv = False
    ReDim tgClusterErr(0 To 0) As CLUSTERERR
    lmPrevCombineCntrNo = -1
    If rbcType(INVGEN_Final).Value Then
        Screen.MousePointer = vbDefault
        gSetMousePointer grdAirTime, grdRevenue, vbDefault
        ilRet = MsgBox("Ok to Generate Final Invoices and Update Receivables", vbYesNo + vbQuestion, "Invoice")
        If ilRet = vbNo Then       'd.s. 11/6/01
            Print #hmMsg, "User answered NO to Generate Final Invoices and Update Receivables"
            Close #hmMsg
            ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
            Exit Sub
        End If
    End If
    igUsedISR = False
    imCntrExported = False

    Invoice.Enabled = False
    DoEvents
    imGenInv = True
    imInvGenType = 0
    gGetSyncDateTime smSyncDate, smSyncTime
    smGenDate = Format$(gNow(), "m/d/yy")
    lmGenDate = gDateValue(smGenDate)
    smGenTime = Format$(gNow(), "h:mm:ssAM/PM")
    lmGenTime = gTimeToLong(smGenTime, False)

    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    DoEvents
    If Not ckcIncludeEDI.Visible Then
        ckcIncludeEDI.Value = vbChecked
    End If
    If (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Aff).Value) Or (rbcType(INVGEN_Undo).Value) Or (rbcType(INVGEN_Archive).Value) Then    '11-15-16 Reprint; Affidavit; Revise, or archive

        If (ckcType(INVTYPE_Commercial).Value = vbChecked) Then
            If ilUpper > 0 Then
                ilRet = mObtainCntrToInvoice(0)
            Else
                lbcVehicle.Clear
                'Traffic!lbcVehicle.Clear
                'Traffic!lbcVehicle.Tag = ""
                ReDim tmInvVehicle(0 To 0) As SORTCODE
                smInvVehicleTag = ""
                mVehPop
                'lbcCntr.Clear
                'lbcCntrCode.Clear
                mClearAirTimeGrid
                If ckcAll.Value = vbChecked Then    '10-31-01
                    ilValue = True
                    If lbcVehicle.ListCount > 0 Then
                        llRg = CLng(lbcVehicle.ListCount - 1) * &H10000 Or 0
                        llRet = SendMessageByNum(lbcVehicle.HWnd, LB_SELITEMRANGE, ilValue, llRg)
                    End If
                'Else
                '    ckcAll.Value = True
                End If
                rbcType(INVGEN_Preliminary).Value = True
                imGenInv = False
                Invoice.Enabled = True
                ReDim tgInvVehCode(0 To 0) As VEHSORT
                DoEvents
                Beep
                Screen.MousePointer = vbDefault
                gSetMousePointer grdAirTime, grdRevenue, vbDefault
                'd.s. 11/6/01
                Print #hmMsg, "No contracts to generate Affidavits for ."
                Close #hmMsg
                ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
                Exit Sub
            End If
            For ilLoop = grdAirTime.FixedRows To grdAirTime.rows - 1 Step 1
                If (grdAirTime.TextMatrix(ilLoop, ATBILLINDEX) <> "") Then
                    grdAirTime.TextMatrix(ilLoop, ATSELECTEDINDEX) = "1"
                End If
            Next ilLoop
        End If
    Else
        If (ckcType(INVTYPE_Commercial).Value = vbChecked) Then
            ilRet = mObtainCntrToInvoice(0)
            For ilLoop = grdAirTime.FixedRows To grdAirTime.rows - 1 Step 1
                If (grdAirTime.TextMatrix(ilLoop, ATBILLINDEX) <> "") And (grdAirTime.TextMatrix(ilLoop, ATSELECTEDINDEX) <> "-1") Then
                    grdAirTime.TextMatrix(ilLoop, ATSELECTEDINDEX) = "1"
                End If
            Next ilLoop
        End If
    End If

    If UBound(tgClusterErr) > LBound(tgClusterErr) Then
        lbcUnbilled.Clear
        For ilLoop = LBound(tgClusterErr) To UBound(tgClusterErr) - 1 Step 1
            If tgClusterErr(ilLoop).iFlag = 1 Then
                slStr = "Contract #" & str$(tgClusterErr(ilLoop).lCntrNo) & " with National Order # but Local Salesperson"
                lbcUnbilled.AddItem slStr
                Print #hmMsg, slStr
            ElseIf tgClusterErr(ilLoop).iFlag = 2 Then
                slStr = "Contract #" & str$(tgClusterErr(ilLoop).lCntrNo) & " with National Salesperson but Local Order #"
                lbcUnbilled.AddItem slStr
                Print #hmMsg, slStr
            End If
        Next ilLoop
        plcUnbilled.Move plcFromLine.Left + (plcFromLine.Width - plcUnbilled.Width) \ 2, plcFromLine.Top + (plcFromLine.Height - plcUnbilled.Height) \ 2
        plcUnbilled.BackColor = Red
        plcFromLine.Enabled = False
        plcUnbilled.ZOrder
        plcUnbilled.Visible = True
        DoEvents
        If igUsedISR Then
            Screen.MousePointer = vbHourglass
            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
            mDeleteISR
        End If
        imGenInv = False
        Invoice.Enabled = True
        ReDim tgInvVehCode(0 To 0) As VEHSORT
        DoEvents
        Beep
        Close #hmMsg
        imObtainDateCalled = False
        mObtainDates
        cmcCancel.Caption = "&Done"
        If ((Asc(tgSpf.sUsingFeatures6) And INVEXPORTPARAMETERS) = INVEXPORTPARAMETERS) And ((rbcType(INVGEN_Final).Value) Or (rbcType(INVGEN_Reprint).Value)) Then           '5-11-17, file closed only if it was created (site feature to export Inv set), and finals or reprint
            If hmInvExportSpots > 0 Then            'only close if something created
                Close #hmInvExportSpots
                Close #hmInvExportNTR
                gLogMsg "Invoice Export Completed" & sgCR & sgLF, "InvoiceExport.Txt", False
            End If
        End If

        Screen.MousePointer = vbDefault
        gSetMousePointer grdAirTime, grdRevenue, vbDefault
        ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
        Exit Sub
    End If

    If (Not rbcType(INVGEN_Reprint).Value) And (Not rbcType(INVGEN_Aff).Value) And (Not rbcType(INVGEN_Undo).Value) And (Not rbcType(INVGEN_Archive).Value) Then         '11-15-16 not reprint, not aff, not undo and not archive
        llInvoiceNo = tgSpf.lBNextNo
        If llInvoiceNo < tgSpf.lBLowestNo Then
            llInvoiceNo = tgSpf.lBLowestNo
        End If
        If llInvoiceNo > tgSpf.lBHighestNo Then
            llInvoiceNo = tgSpf.lBLowestNo
        End If
        mCheckNextInvNo llInvoiceNo
    End If
    'Get Installment transaction from SBF for Reprint; Revise and Affidavit
    If ckcType(INVTYPE_Commercial).Value = vbChecked Then
        If (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Aff).Value) Or (rbcType(INVGEN_Undo).Value) Or (rbcType(INVGEN_Archive).Value) Then    '11-15-16 Reprint; Affidavit; Revise, or archive
            ilRet = mInstall_ReadRec()
        End If
    End If
    'Dan multiple reports now print as one 11-20-08.  create a new report object and determine what will be the last report.  For each report before the last,
    'open normally, but hold in a collection.  When reach the last report, output the whole collection.  Because the logic below calls rptSelIn, and rptSelIn
    'already has a report object being manipulated (and destroyed), I have to create a distinct report object olReportMaster; I also have to manipulate
    'the last report number.  I set this number to 100X ckcType's index.  When that index has been reached, I set the number to 1 which allows output.
    'there is one assumption: igtype will always be between 0 and 6 inclusive.  It looks as if the old bridge reports had a different way of doing things,
    'and that this is now always true.  If not, I believe the reports would still print normally, and the second pass would just be ignored.
    Set olReportMaster = New CReportHelper
    'get last print job
    If ckcType(INVTYPE_PrintRep).Value = vbChecked Then 'Print Rep Invoices
        olReportMaster.iLastPrintJob = 100
    ElseIf ((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) = INSTALLMENT) And (ckcType(INVTYPE_Commercial).Value = vbChecked) Then 'Commercial
        olReportMaster.iLastPrintJob = 200  'ntr choice doesn't matter: install and air go here
    ElseIf ckcType(INVTYPE_NTR).Value = vbChecked Then 'NTR
        olReportMaster.iLastPrintJob = 300  'ntr and not above.
    End If  'default is 1, that is fine if none of above are true.  ckcType(INVTYPE_Installment) (Installment) doesn't appear to be used and ckcType(INVTYPE_GenRepAR) (Gen Rep A/R) doesn't output.

    gInvExportFileNameCreate hmInvExportSpots, hmInvExportNTR, hmMsg, lmGenDate, lmGenTime

    If ckcType(INVTYPE_Commercial).Value = vbChecked Then
        Set ogReport = olReportMaster       'set each time going to rptSelIn because rptSelIn will destroy ogreport(it doesn't know calling from invoice).
        'Set ogReport = New CReportHelper    'Dan 8-17-09 this is whilst NOT mulitple reports
        imInvGenType = 0
        gPackDate smGenDate, tmIvr.iGenDate(0), tmIvr.iGenDate(1)
        '10-31-01 gPackTime smGenTime, tmIvr.iGenTime(0), tmIvr.iGenTime(1)
        gPackTime smGenTime, ilNowTime(0), ilNowTime(1)
        gUnpackTimeLong ilNowTime(0), ilNowTime(1), False, tmIvr.lGenTime
        tmIvr.lDisclaimer = tgSpf.lBCxfDisclaimer

        If rbcOutput(0).Value Then
            ilPreview = True
        Else
            ilPreview = False
        End If
        gUserActivityLog "S", "Invoice: Prepass Air Time"
        If (rbcPrtType(0).Value) Then  'Laser
            mInvoiceRpt ilPreview, "InvoiceL.Lst", Val(smLogUserCode), False, llInvoiceNo
        Else    'Impact
            mInvoiceRpt ilPreview, "InvoiceI.Lst", Val(smLogUserCode), True, llInvoiceNo
        End If
        If igUsedISR Then
            Screen.MousePointer = vbHourglass
            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
            mDeleteISR
        End If
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    End If
    
    mRestoreDates
    mClearDates

    If ((Asc(tgSaf(0).sFeatures8) And PODADSERVER) = PODADSERVER) And (ckcType(INVTYPE_Commercial).Value = vbChecked) Then  'Commercial + AdServer
        'TTP 10462 - Invoices: separate commerical and NTR setting results in blank air time invoices on version 8.1 - Pt. 1
        'If olReportMaster.iLastPrintJob = 400 Then  'this is last report
        If ckcType(INVTYPE_NTR).Value = vbUnchecked Then 'NTR
            olReportMaster.TreatAsLastReport = True       'allow output
        End If
        Set ogReport = olReportMaster
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        imInvGenType = 1
        ReDim tgSortKey(0 To 0) As TYPESORTKEY
        ReDim tgRvf(0 To 0) As RVF
        'Get contracts-move to top area so conflicts can be checked
        'Screen.MousePointer = vbHourglass
        gUserActivityLog "S", "Invoice: Prepass Digital Contracts"
        If (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Aff).Value) Or (rbcType(INVGEN_Undo).Value) Or (rbcType(INVGEN_Archive).Value) Then    '11-15-16 Reprint; Affidavit; Revise, archive
            ilRet = mCPM_ReadRec()
        End If
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        mCPM_GenIvr llInvoiceNo
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        gUserActivityLog "E", "Invoice: Prepass Digital Contracts"
        If ((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) <> INSTALLMENT) Or (ckcType(INVTYPE_NTR).Value <> vbChecked) Then
            If Not imCombineAirAndNTR Then
                mNonAirTime_InvEnd 4
            Else
                'TTP 10885 - Digital invoices: final invoices fail to get billed if installment is not enabled and combine air time and NTR is checked on
                If rbcType(INVGEN_Final).Value Then
                    ilRet = mUpdateInv(4)
                End If
            End If
        Else
            If rbcType(INVGEN_Final).Value Then
                ilRet = mUpdateInv(4)
            End If
        End If
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        mRestoreDates
        mClearDates
    End If
    
    If ckcType(INVTYPE_NTR).Value = vbChecked Then    'NTR Invoices
        If olReportMaster.iLastPrintJob = 300 Then  'this is last report
            olReportMaster.TreatAsLastReport = True       'allow output
        End If
        Set ogReport = olReportMaster
       ' Set ogReport = New CReportHelper    'Dan 8-17-09 this is whilst NOT mulitple reports

        'Dan 8-14-09 new prepass date/time 9/24/09 only create new prepass if ntr separate from airtime
        If Not imCombineAirAndNTR Then
            gPackDate smGenDate, tmIvr.iGenDate(0), tmIvr.iGenDate(1)
            llTempTime = gTimeToLong(smGenTime, False)
            smGenTime = gFormatTimeLong(llTempTime + 1, "A", "1")
            gPackTime smGenTime, ilNowTime(0), ilNowTime(1)
            gUnpackTimeLong ilNowTime(0), ilNowTime(1), False, tmIvr.lGenTime
        End If
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        imInvGenType = 1
        ReDim tgSortKey(0 To 0) As TYPESORTKEY
        ReDim tgRvf(0 To 0) As RVF
        'Get contracts-move to top area so conflicts can be checked
        'Screen.MousePointer = vbHourglass
        gUserActivityLog "S", "Invoice: Prepass NTR"
        If (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Aff).Value) Or (rbcType(INVGEN_Undo).Value) Or (rbcType(INVGEN_Archive).Value) Then    '11-15-16 Reprint; Affidavit; Revise, archive
            ilRet = mNTR_ReadRec()
        End If
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        mNTR_GenIvr llInvoiceNo
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        gUserActivityLog "E", "Invoice: Prepass NTR"
        If ((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) <> INSTALLMENT) Or (ckcType(INVTYPE_Commercial).Value <> vbChecked) Then
            mNonAirTime_InvEnd 1
        Else
            If rbcType(INVGEN_Final).Value Then
                ilRet = mUpdateInv(1)
            End If
        End If
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        mRestoreDates
        mClearDates
    End If
    
    If ((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) = INSTALLMENT) And (ckcType(INVTYPE_Commercial).Value = vbChecked) Then
        gUserActivityLog "S", "Invoice: Prepass Installment"
        If olReportMaster.iLastPrintJob = 200 Then  'this is last report
            olReportMaster.TreatAsLastReport = True       'allow output
        End If
        Set ogReport = olReportMaster
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        imInvGenType = 1
        ReDim tgSortKey(0 To 0) As TYPESORTKEY
        ReDim tgRvf(0 To 0) As RVF
        'Get contracts-move to top area so conflicts can be checked
        'Screen.MousePointer = vbHourglass
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        mInstall_GenIvr llInvoiceNo
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        gUserActivityLog "E", "Invoice: Prepass Installment"
        mNonAirTime_InvEnd 3
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        mRestoreDates
        mClearDates
    End If
    If (ckcType(INVTYPE_PrintRep).Value = vbChecked) And (ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked) Then     'Print Rep Invoices
        gUserActivityLog "S", "Invoice: Prepass Rep"
        If olReportMaster.iLastPrintJob = 100 Then  'this is last report
            olReportMaster.TreatAsLastReport = True       'allow output
        End If
        'Set ogReport = olReportMaster
       ' Set ogReport = New CReportHelper    'Dan 8-17-09 this is whilst NOT mulitple reports
'12-16-16  *****
    Set ogReport = olReportMaster
        'Dan 8-14-09 new prepass date/time
        gPackDate smGenDate, tmIvr.iGenDate(0), tmIvr.iGenDate(1)
        llTempTime = gTimeToLong(smGenTime, False)
        smGenTime = gFormatTimeLong(llTempTime + 1, "A", "1")
        gPackTime smGenTime, ilNowTime(0), ilNowTime(1)
        gUnpackTimeLong ilNowTime(0), ilNowTime(1), False, tmIvr.lGenTime

        imPrintRepInv = True
        llSvInvoiceNo = llInvoiceNo
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        imInvGenType = 1
        ReDim tgSortKey(0 To 0) As TYPESORTKEY
        ReDim tgRvf(0 To 0) As RVF
        'Get contracts
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        ilRet = mRepInv_ReadRec()
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        mRepInv_GetCarry
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        mRepInv_GenIvr
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        gUserActivityLog "E", "Invoice: Prepass Rep"
        mRepInv_InvEnd
        imPrintRepInv = False
        llInvoiceNo = llSvInvoiceNo
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        mRestoreDates
        If rbcType(INVGEN_Final).Value Then    'Final
            ilRet = gObtainPIF_ForDate(hmPif, smStartStd, tmPif())
        Else
            ReDim tmPif(0 To 0) As PIF
        End If
    Else
        mRestoreDates
    End If
    Set olReportMaster = Nothing
    If (ckcType(INVTYPE_GenRepAR).Value = vbChecked) And (ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked) Then    'Generate Rep A/R
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        imInvGenType = 1
        ReDim tgSortKey(0 To 0) As TYPESORTKEY
        ReDim tgRvf(0 To 0) As RVF
        mRepAR_GetCntr
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        ilRet = mRepAR_GenRvf(0, llInvoiceNo)
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        If rbcType(INVGEN_Final).Value Then
            ilRet = mUpdateInv(2)
        End If
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    End If

    smEndInvTime = Format$(Now, "h:mm:ssAM/PM")
    'If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_GenRepAR).Value = vbChecked)) And (rbcType(INVGEN_Final).Value) Then
    If (rbcType(INVGEN_Final).Value) And ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_PrintRep).Value = vbChecked) Or (ckcType(INVTYPE_GenRepAR).Value = vbChecked)) Then
        Screen.MousePointer = vbHourglass
        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
        ilRet = mUpdateDates(llInvoiceNo)
    End If
    If Trim$(smExportCntrName) <> "" Then
        Print #hmMsg, "Export generated to " & smExportCntrName & ", send to main office."
        Close #hmExport
        If imCntrExported Then
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            ilRet = MsgBox("Send " & smExportCntrName & " and Affidavits of Performance to main office", vbOKOnly + vbExclamation, "Invoice")
        End If
    End If

    'D.S. 11/6/01
    Close #hmMsg
    If igInvErrFlag Then
        Screen.MousePointer = vbDefault
        gSetMousePointer grdAirTime, grdRevenue, vbDefault
        ilRet = MsgBox("Not all contracts invoiced. See " & slMsgFile, vbOKOnly + vbExclamation, "Invoice")
    End If
    'D.S. end

    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    bmUnpostedVehicleExist = False
    If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then            '11-15-16 reprint, aff, or archive
        lbcVehicle.Clear
        ReDim tmInvVehicle(0 To 0) As SORTCODE
        smInvVehicleTag = ""
        mVehPop
        mClearAirTimeGrid
        mClearRevenueGrid
        If ckcAll.Value = vbChecked Then    '10-31-01
            ilValue = True
            If lbcVehicle.ListCount > 0 Then
                llRg = CLng(lbcVehicle.ListCount - 1) * &H10000 Or 0
                llRet = SendMessageByNum(lbcVehicle.HWnd, LB_SELITEMRANGE, ilValue, llRg)
            End If
        End If
        ReDim tgInvVehCode(0 To 0) As VEHSORT
        Screen.MousePointer = vbDefault
        gSetMousePointer grdAirTime, grdRevenue, vbDefault
    Else
        If rbcCntr(INVCNTR_All).Value Then    'All
            mClearAirTimeGrid
        Else
            If rbcCntr(INVCNTR_Selective).Value Or rbcCntr(INVCNTR_WOExpired).Value Or rbcCntr(INVCNTR_Posted).Value Then
                mClearAirTimeGrid
                mSelCntr
            End If
        End If
    End If
    
    mAddViewListMsgForPDFEmail      '11-18-16 place any error messages found from PDF emailer into list for user to see onscreen
    mPopViewList 1
    smTime2 = "End of cmcGenerate " & Format$(gNow(), "h:mm:ssAM/PM")
    gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slDate
    lmSpfStdDate = gDateValue(slDate)
    gUnpackDate tgSpf.iBLastCalMnth(0), tgSpf.iBLastCalMnth(1), slDate
    lmSpfCalDate = gDateValue(slDate)
    gUnpackDate tgSaf(0).iBLastWeeklyDate(0), tgSaf(0).iBLastWeeklyDate(1), slDate
    lmSafWkDate = gDateValue(slDate)
    If lmSafWkDate = gDateValue("1/1/1990") Then
        lmSafWkDate = 0
    End If
    ReDim lmCPMBypassCntr(0 To 0) As Long
    imObtainDateCalled = False
    mObtainDates
    If ckcType(INVTYPE_NTR).Value = vbChecked Then
        ckcType_Click 3 'Get NTR date
    End If
    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)
    Invoice.Enabled = True
    DoEvents
    cmcCancel.Caption = "&Done"
    If ((Asc(tgSpf.sUsingFeatures6) And INVEXPORTPARAMETERS) = INVEXPORTPARAMETERS) And ((rbcType(INVGEN_Final).Value) Or (rbcType(INVGEN_Reprint).Value)) Then           '5-11-17, file closed only if it was created (site feature to export Inv set), and finals or reprint
        If hmInvExportSpots > 0 Then            'only close if something created
            Close #hmInvExportSpots
            Close #hmInvExportNTR
            gLogMsg "Invoice Export Completed" & sgCR & sgLF, "InvoiceExport.Txt", False
        End If
    End If

    If (bmEDIInstallBypassed) Or (bmEDINTRBypassed) Or (bmEDICPMBypassed) Then
        gMsgBox "EDI Not Generated: See " & slMsgFile & " in Message folder for list of Contracts printed instead of sent to EDI", vbCritical
    End If

    Screen.MousePointer = vbDefault
    gSetMousePointer grdAirTime, grdRevenue, vbDefault
    bgComingFromInvoice = False
    Erase igPreviousTimes
    Erase igPreviousDates
    Erase tgInvPDF_Info, tgInvPDF_DetailInfo, tgInvPDFEmailer_ErrMsg
    If Not ckcIncludeEDI.Visible Then
        If (Asc(tgSpf.sUsingFeatures9) And PRINTEDI) = PRINTEDI Then
            ckcIncludeEDI.Value = vbChecked
        Else
            ckcIncludeEDI.Value = vbUnchecked
        End If
    End If

    imGenInv = False
End Sub

Private Sub cmcGenerate_GotFocus()
    'plcUnbilled.Visible = False
End Sub

Private Sub cmcItem_Click()
    'If Not gWinRoom(igNoExeWinRes(POSTITEMEXE)) Then
    '    Exit Sub
    'End If
    'MousePointer = vbHourGlass  'Wait
    'PostItem.Show vbModal
    'MousePointer = vbDefault    'Default
End Sub

Private Sub cmcItem_GotFocus()
    If plcUnbilled.Visible Then
        plcUnbilled.Visible = False
        plcFromLine.Enabled = True
    End If
End Sub

Private Sub cmcReport_Click()
    Dim slStr As String
    Dim slDisplay As String
    'Unload IconTraf
    'If Not gWinRoom(igNoExeWinRes(RPTSELEXE)) Then
    '    Exit Sub
    'End If
    igRptCallType = INVOICESJOB
    'If tgSpf.sInvAirOrder = "2" Then
    If tgSpf.sBLaserForm = "2" Then
        igRptType = 2
    Else
        igRptType = 0
    End If
    If rbcOutput(0).Value Then
        slDisplay = "D"
    Else
        slDisplay = "P"
    End If
    If igTestSystem Then
        slStr = "Invoice^Test\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & slDisplay
    Else
        slStr = "Invoice^Prod\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & slDisplay
    End If
    sgCommandStr = slStr
    RptList.Show vbModal
    slStr = sgDoneMsg
End Sub

Private Sub cmcReport_GotFocus()
    If plcUnbilled.Visible Then
        plcUnbilled.Visible = False
        plcFromLine.Enabled = True
    End If
End Sub

Private Sub cmcSaleHist_Click()
    'If Not gWinRoom(igNoExeWinRes(POSTITEMEXE)) Then
    '    Exit Sub
    'End If
    'MousePointer = vbHourGlass  'Wait
    SaleHist.Show vbModal
    'MousePointer = vbDefault    'Default
End Sub

Private Sub cmcSaleHist_GotFocus()
    If plcUnbilled.Visible Then
        plcUnbilled.Visible = False
        plcFromLine.Enabled = True
    End If
End Sub

Private Sub cmcSetup_Click()
    cdcSetup.flags = cdlPDPrintSetup
    cdcSetup.ShowPrinter
End Sub

Private Sub cmcSetup_GotFocus()
    If plcUnbilled.Visible Then
        plcUnbilled.Visible = False
        plcFromLine.Enabled = True
    End If
End Sub

Private Sub cmcUnbilledOk_Click()
    If Invoice.Enabled = False Then
        Exit Sub
    End If
    lacUndoReason.Visible = False
    plcUnbilled.Visible = False
    plcFromLine.Enabled = True
End Sub

Private Sub cmcView_Click()
    ViewList.Show vbModal
End Sub

Private Sub edcEReprint_KeyPress(KeyAscii As Integer)
    If (KeyAscii <> KEYBACKSPACE) And ((KeyAscii < KEY0) Or (KeyAscii > KEY9)) Then
        Beep
        KeyAscii = 0
        Exit Sub
    End If
End Sub

Private Sub edcLinkDestHelpMsg_Change()
    igParentRestarted = True
End Sub

Private Sub edcSReprint_KeyPress(KeyAscii As Integer)
    If (KeyAscii <> KEYBACKSPACE) And ((KeyAscii < KEY0) Or (KeyAscii > KEY9)) Then
        Beep
        KeyAscii = 0
        Exit Sub
    End If
End Sub

Private Sub Form_Activate()
    If Not imFirstActivate Then
        DoEvents    'Process events so pending keys are not sent to this
                    'form when keypreview turn on
        'gShowBranner imUpdateAllowed
        Me.KeyPreview = True  'To get Alt J and Alt L keys
        Exit Sub
    End If
    imFirstActivate = False
    If (igWinStatus(INVOICESJOB) = 1) And (Trim$(tgUrf(0).sName) <> sgCPName) And (Trim$(tgUrf(0).sName) <> sgSUName) Then
        imUpdateAllowed = False
    Else
        If tgUrf(0).iSlfCode > 0 Then
            imUpdateAllowed = False
        Else
            imUpdateAllowed = True
        End If
    End If
    If (Not imUpdateAllowed) Then
        rbcType(INVGEN_Preliminary).Enabled = False  'Preliminary
        rbcType(INVGEN_Final).Enabled = False  'Final
        rbcType(INVGEN_Aff).Enabled = False  'Aff
        rbcType(INVGEN_Undo).Enabled = False  'Undo
        rbcType(INVGEN_Reprint).Value = True     'Reprint
        ckcType(INVTYPE_Installment).Enabled = False  'Installment
        ckcType(INVTYPE_GenRepAR).Enabled = False  'Gen Rep A/R
        '3/21/17: Allow archive, similar to Reprint
        'ckcType(5).Enabled = True          '11-15-16 ok to archive
        rbcType(INVGEN_Archive).Enabled = True   'Archive       '11-15-16 ok to reprint
    End If
    If ((Asc(tgSpf.sUsingFeatures3) And USINGHUB) = USINGHUB) And (tgUrf(0).iMnfHubCode > 0) Then
        rbcType(INVGEN_Final).Enabled = False  'Final
        rbcType(INVGEN_Aff).Enabled = False  'Aff
        rbcType(INVGEN_Undo).Enabled = False  'Undo
        rbcType(INVGEN_Archive).Enabled = True   'Archive       '11-15-16 ok to reprint
    End If
    
    'Fix per Jason Email - v81 TTP 10804 testing Fri 8/11/23 9:53 AM - Issue 5: How about we just hide or gray out the suppress NTR details checkbox if air time and NTR are set to be separate in Site Options
    If ((Asc(tgSpf.sUsingFeatures5) And COMBINEAIRNTR) = COMBINEAIRNTR) Then
        ckcSuppressNTRDetails.Enabled = True
    Else
        ckcSuppressNTRDetails.Enabled = False
        ckcSuppressNTRDetails.Value = vbUnchecked
    End If

    ''Disallow Undo until it is fixed
    'If ((Len(Trim$(sgSpecialPassword)) = 4) And (Val(sgSpecialPassword) >= 1) And (Val(sgSpecialPassword) < 10000)) Then
    'Else
    '    rbcType(INVGEN_Undo).Enabled = False
    'End If
    'gShowBranner imUpdateAllowed
    DoEvents    'Process events so pending keys are not sent to this
                'form when keypreview turn on
    'Invoice.KeyPreview = True  'To get Alt J and Alt L keys
    Me.KeyPreview = True
    Me.ZOrder 0 'Send to front
    Invoice.Refresh
End Sub

Private Sub Form_Click()
    pbcClickFocus.SetFocus
End Sub

Private Sub Form_Deactivate()
    Invoice.KeyPreview = False
End Sub

Private Sub Form_GotFocus()
    If plcUnbilled.Visible Then
        plcUnbilled.Visible = False
        plcFromLine.Enabled = True
    End If
End Sub

Private Sub Form_KeyUp(KeyCode As Integer, Shift As Integer)
    If (KeyCode = KEYF1) Or (KeyCode = KEYF4) Or (KeyCode = KEYF5) Then
        gFunctionKeyBranch KeyCode
    End If
End Sub

Private Sub Form_LinkExecute(CmdStr As String, Cancel As Integer)
    sgDoneMsg = CmdStr
    igChildDone = True
    Cancel = 0
End Sub

Private Sub Form_Load()
    lgPercentAdjW = 95
    lgPercentAdjH = 95
    If Screen.Width * 15 = 640 Then
        fmAdjFactorH = 1#
    Else
        fmAdjFactorH = ((lgPercentAdjH * ((800) / (480 * 15 / Me.Height))) / 100) / Me.Height
        Me.Height = (lgPercentAdjH * ((600 * 15) / (480 * 15 / (Me.Height)))) / 100
    End If

    mInit
    If imTerminate Then
        tmcStart.Enabled = True
    End If
End Sub

Private Sub Form_Unload(Cancel As Integer)
    Dim ilRet As Integer
    '10016
    bgPDFEmailTestMode = False
    On Error Resume Next
    If igLogActivityStatus = 32123 Then
        igLogActivityStatus = -32123
        gUserActivityLog "", ""
    End If
    
    Erase smXferRepDBID
    Erase smXferChfCode
    Erase tmRepSdf
    Erase tmTeam
    Erase tmRepMatch
    Erase lmANAddedRvf
    Erase lmANAddedPhf
    Erase tmReadClf
    Erase tmSpeedSortParse
    'Erase lmRPCntrNo
    'Erase lmRPInvNo
    'Erase smRPCashTrade
    Erase tmRPSelInfo
    Erase tmRPInfo
    Erase tmWkDef
    Erase tmSvSort
    Erase tmPkRvf
    Erase lmSelCntrCode
    Erase tmMktCode
    Erase tmMktVefCode
    Erase tmMVef
    Erase tmPif
    Erase lmPSFCode
    Erase tmPsfInfo
    Erase tmAirNTRCombine
    Erase tmNTRCntStatus
    Erase tmInstallCntStatus
    Erase tmAirCntStatus
    Erase tmInvVehicle
    smInvVehicleTag = ""
    Erase tgClusterErr
    Erase tgChfAdvtExt
    Erase tgSortKey
    Erase tgSortNoKey
    Erase tgSelSort
    Erase tgRvf
    Erase tgRvfByVef
    Erase tgInvVehCode
    Erase tgUpdateAgf
    Erase tgUpdateAdf
    Erase tgPkLnGen
    Erase tgSdfExtIn
    Erase tgSdfExtIn32
    Erase tgMGSdfExt
    Erase tgSSMnf
    Erase tgMRMnf
    Erase tgNTRMnf
    Erase tgMkMnf
    Erase tgLnSdfExtSort
    Erase tgLnSdfExt
    Erase tgClfInv
    Erase tgCffInv
    Erase tmCGFSort
    Erase tmCgfCff
    Erase tmVlf0
    Erase tmVlf6
    Erase tmVlf7
    Erase tmVlf
    Erase tgMktTotal
    Erase tgExportCount
    Erase tgSbfCntr
    Erase tmSchClf
    Erase tmSchCff
    Erase tmSchCgf
    Erase tmSchMsf
    Erase tmAlterClf
    Erase tmAlterCff
    Erase tmAlterCgf
    Erase tmAlterMsf
    Erase tmViewListInfo
    Erase tgInvPDF_Info                         '11-17-16
    Erase sgSetSelectionForAll
        Erase sgSetSelectionForFinals
        Erase tgAcqComm
    Erase tgAcqCommInx
    Erase tmAcqWithCommInfo
    
    'PECloseEngine
    ilRet = btrClose(hmEff)
    btrDestroy hmEff
    ilRet = btrClose(hmRhf)
    btrDestroy hmRhf
    If ((Asc(tgSpf.sAutoType2) And RN_NET) = RN_NET) Then
        btrDestroy hmGif
        btrDestroy hmCef
    End If
    ilRet = btrClose(hmVef)
    btrDestroy hmVef
    ilRet = btrClose(hmVff)
    btrDestroy hmVff
    ilRet = btrClose(hmVsf)
    btrDestroy hmVsf
    ilRet = btrClose(hmCHF)
    btrDestroy hmCHF
    ilRet = btrClose(hmClf)
    btrDestroy hmClf
    ilRet = btrClose(hmCff)
    btrDestroy hmCff
    ilRet = btrClose(hmCgf)
    btrDestroy hmCgf
    ilRet = btrClose(hmMgf)
    btrDestroy hmMgf
    ilRet = btrClose(hmMsf)
    btrDestroy hmMsf
    ilRet = btrClose(hmGsf)
    btrDestroy hmGsf
    ilRet = btrClose(hmCxf)
    btrDestroy hmCxf
    ilRet = btrClose(hmRdf)
    btrDestroy hmRdf
    ilRet = btrClose(hmAdf)
    btrDestroy hmAdf
    ilRet = btrClose(hmAgf)
    btrDestroy hmAgf
    ilRet = btrClose(hmPnf)
    btrDestroy hmPnf
    ilRet = btrClose(hmPDF)
    btrDestroy hmPDF                    '11-17-16
    ilRet = btrClose(hmSlf)
    btrDestroy hmSlf
    ilRet = btrClose(hmSof)
    btrDestroy hmSof
    ilRet = btrClose(hmPrf)
    btrDestroy hmPrf
    ilRet = btrClose(hmCif)
    btrDestroy hmCif
    ilRet = btrClose(hmCrf)
    btrDestroy hmCrf
    ilRet = btrClose(hmCnf)
    btrDestroy hmCnf
    '5/5/15
    ilRet = btrClose(hmCvf)
    btrDestroy hmCvf
    ilRet = btrClose(hmCcf)
    btrDestroy hmCcf
    ilRet = btrClose(hmCpf)
    btrDestroy hmCpf
    ilRet = btrClose(hmTzf)
    btrDestroy hmTzf
    ilRet = btrClose(hmPif)
    btrDestroy hmPif
    ilRet = btrClose(hmApf)
    btrDestroy hmApf
    ilRet = btrClose(hmIihf)
    btrDestroy hmIihf
    ilRet = btrClose(hmMnf)
    btrDestroy hmMnf
    ilRet = btrClose(hmArf)
    btrDestroy hmArf
    ilRet = btrClose(hmRvf)
    btrDestroy hmRvf
    ilRet = btrClose(hmPhf)
    btrDestroy hmPhf
    ilRet = btrClose(hmSmf)
    btrDestroy hmSmf
    ilRet = btrClose(hmPsf)
    btrDestroy hmPsf
    ilRet = btrClose(hmSdf)
    btrDestroy hmSdf
    ilRet = btrClose(hmSsf)
    btrDestroy hmSsf
    ilRet = btrClose(hmLcf)
    btrDestroy hmLcf
    ilRet = btrClose(hmLef)
    btrDestroy hmLef
    ilRet = btrClose(hmIsr)
    btrDestroy hmIsr
    ilRet = btrClose(hmIvr)
    btrDestroy hmIvr
    ilRet = btrClose(hmImr)
    btrDestroy hmImr
    ilRet = btrClose(hmSbf)
    btrDestroy hmSbf
    ilRet = btrClose(hmSbfVehCheck)
    btrDestroy hmSbfVehCheck
    ilRet = btrClose(hmPcf)
    btrDestroy hmPcf
    ilRet = btrClose(hmIbf)
    btrDestroy hmIbf
    ilRet = btrClose(hmRlf)
    btrDestroy hmRlf
    ilRet = btrClose(hmUaf)
    btrDestroy hmUaf
    ilRet = btrClose(hmUrf)
    btrDestroy hmUrf
    ilRet = btrClose(hmVLF)
    btrDestroy hmVLF
    ilRet = btrClose(hmLvf)
    btrDestroy hmLvf
    
    igJobShowing(INVOICESJOB) = False
    Set Invoice = Nothing   'Remove data segment
    End
End Sub

Private Sub imcHelp_Click()
    'Traffic!cdcSetup.HelpFile = sgHelpPath & "traffic.hlp"
    'Traffic!cdcSetup.HelpCommand = cdlHelpIndex
    'Traffic!cdcSetup.Action = 6
End Sub

Private Sub lbcDates_Click()
    Dim ilIndex As Integer
    If (rbcAdvt(1).Value) And (Not imIgnoreSelAdvtRequest) Then
        mSelAdvt
    End If
    ilIndex = lbcDates.ListIndex
'    sgInvMonthYear = lbcDates.List(ilIndex)         '11-16-16 ,save the month and year generated for pdf filenames
End Sub

'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
Private Sub cbcDates_Click()
    Dim ilIndex As Integer
    ilIndex = cbcDates.ListIndex
    If (rbcAdvt(1).Value) And ilIndex >= 0 And Not imIgnoreSelAdvtRequest Then
        mSelAdvt
    End If
    ilIndex = cbcDates.ListIndex
End Sub

Private Sub lbcVehicle_Click()
    If imBypassVehSelect Then
        Exit Sub
    End If
    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    imBypassAll = True
    ckcAll.Value = vbUnchecked  '10-31-01 False
    imBypassAll = False
    imObtainDateCalled = False
    mObtainDates
    'lbcCntr.Clear
    'lbcCntrCode.Clear
    mClearAirTimeGrid
    If rbcCntr(INVCNTR_Selective).Value Or rbcCntr(INVCNTR_WOExpired).Value Or rbcCntr(INVCNTR_Posted).Value Then
        'ReDim tgInvVehCode(0 To 0) As String
        'For ilVeh = 0 To lbcVehicle.ListCount - 1 Step 1
        '    slNameCode = Trim$(tmInvVehicle(ilVeh).sKey) 'Traffic!lbcVehicle.List(ilVeh)
        '    tgInvVehCode(UBound(tgInvVehCode)) = slNameCode
        '    ReDim Preserve tgInvVehCode(0 To UBound(tgInvVehCode) + 1) As String
        'Next ilVeh
        'ilRet = mObtainCntrToInvoice(0)
        mSelCntr
    End If
    Screen.MousePointer = vbDefault
    gSetMousePointer grdAirTime, grdRevenue, vbDefault
End Sub

Private Sub lbcVehicle_GotFocus()
    'plcUnbilled.Visible = False
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mAdjAirTime                     *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Adjust air time so if two or   *
'*                      more spots in same avail then  *
'*                      adjust air time by adding the  *
'*                      spot length                    *
'*                                                     *
'*******************************************************
Private Function mAdjAirTime(llStartSortIndex As Long, llEndSortIndex As Long, llSdfIndex As Long, llInTime As Long, ilPrevLen As Integer) As Long
    Dim llLoop As Long
    Dim llTime As Long
    Dim slStr As String
    ReDim slField(0 To 2) As String

    llTime = llInTime
    If (tmSdf.sSpotType <> "O") And (tmSdf.sSpotType <> "C") Then
        If tgSortKey(llSdfIndex).iType = 0 Then
            If (tgSortKey(llSdfIndex).sSchStatus = "S") Or (tgSortKey(llSdfIndex).sSchStatus = "G") Or (tgSortKey(llSdfIndex).sSchStatus = "O") Then
                'ilRet = gParseItem(tgSortKey(llSdfIndex).sKey, 9, "|", slField(0))
                'ilRet = gParseItem(tgSortKey(llSdfIndex).sKey, 11, "|", slField(1))
                'ilRet = gParseItem(tgSortKey(llSdfIndex).sKey, 12, "|", slField(2))
                slField(0) = Trim$(tmSpeedSortParse(llSdfIndex).sVehName)
                slField(1) = Trim$(tmSpeedSortParse(llSdfIndex).sSdfDate)
                slField(2) = Trim$(tmSpeedSortParse(llSdfIndex).sSdfTime)
                For llLoop = llStartSortIndex To llEndSortIndex Step 1
                    If llLoop <> llSdfIndex Then
                        If tgSortKey(llLoop).iType = 0 Then
                            If (tgSortKey(llLoop).sSchStatus = "S") Or (tgSortKey(llLoop).sSchStatus = "G") Or (tgSortKey(llLoop).sSchStatus = "O") Then
                                'ilRet = gParseItem(tgSortKey(llLoop).sKey, 9, "|", slStr)
                                slStr = Trim$(tmSpeedSortParse(llLoop).sVehName)
                                If slStr = slField(0) Then
                                    'ilRet = gParseItem(tgSortKey(llLoop).sKey, 11, "|", slStr)
                                    slStr = Trim$(tmSpeedSortParse(llLoop).sSdfDate)
                                    If slStr = slField(1) Then
                                        'ilRet = gParseItem(tgSortKey(llLoop).sKey, 12, "|", slStr)
                                        slStr = Trim$(tmSpeedSortParse(llLoop).sSdfTime)
                                        If slStr = slField(2) Then
                                            'llTime = llTime + tgSortKey(llLoop).iLen
                                            llTime = mGetAirTime(llTime, ilPrevLen)
                                            slStr = Trim$(str$(llTime))
                                            Do While Len(slStr) < 6
                                                slStr = "0" & slStr
                                            Loop
                                            tgSortKey(llSdfIndex).sAdjAirTime = slStr
                                            Exit For
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    End If
                Next llLoop
            End If
        End If
    End If
    mAdjAirTime = llTime
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mAdvtPop                        *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Populate box with advertiser    *
'*                     previously invoiced             *
'*                                                     *
'*******************************************************
Private Sub mAdvtPop(llStartStd As Long, llEndStd As Long, llStartCal As Long, llEndCal As Long, llStartWk As Long, llEndWk As Long)
    'Dim tlRvf As RVF
    Dim llNoRec As Long         'Number of records in Sof
    Dim llRecPos As Long        'Record location
    Dim ilRet As Integer
    Dim ilExtLen As Integer
    Dim ilOffSet As Integer
    Dim slName As String
    'Dim slDate As String
    Dim slInvNo As String
    Dim ilFound As Integer
    'Dim slNameSort As String
    'Dim slNameCode As String
    'Dim slCode As String
    'Dim tlLTypeBuff As POPLCODE   'Type field record
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
    Dim tlDateTypeBuff As POPDATETYPE   'Type field record
    Dim ilUpper As Integer
    'Dim ilVeh As Integer
    'Dim ilVefCode As Integer
    Dim hlFile As Integer
    Dim ilPass As Integer
    Dim ilLoop As Integer
    Dim slCntrNo As String
    Dim slStr As String
    Dim llDate As Long
    Dim ilVef As Integer
    Dim slVefType As String
    Dim slSumNet As String
    Dim slNet As String
    Dim llRow As Long
    Dim ilAgf As Integer
    Dim ilAdf As Integer
    Dim ilSlf As Integer
    Dim llCol As Long
    Dim llChfEndDate As Long
    Dim blAdjDate As Boolean
    Dim ilTest As Integer
    '8/8/12: TTP 5559: Get latest Transaction Date as Invoice date
    Dim slTranDate As String
    '12/31/17: Advance billing merge
    Dim llMergeInvNo As Long
    Dim ilMerge As Integer

    'lbcAdvt.Clear
    'pbcLbcAdvt.Cls
    If imIgnoreSelAdvtRequest Then
        Exit Sub
    End If
    mClearRevenueGrid
    mSetGridColumns 'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
    gGetAdvanceBillMergeInfo llStartStd, llEndStd
    grdRevenue.Redraw = False
    ReDim tmRPSelInfo(0 To 0) As RPSELINFO
    ilUpper = 0
    imBuildingAdvt = True
    For ilPass = 1 To 3 Step 1
        If ilPass = 1 Then
            hlFile = hmRvf
        Else
            hlFile = hmPhf
        End If
        ilExtLen = Len(tmRvf)  'Extract operation record size
        llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlRvf) 'Obtain number of records
        btrExtClear hlFile   'Clear any previous extend operation
        ilRet = btrGetFirst(hlFile, tmRvf, imRvfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_END_OF_FILE Then
            Call btrExtSetBounds(hlFile, llNoRec, -1, "UC", "RVF", "") 'Set extract limits (all records)
            If (ilPass = 1) Or (ilPass = 2) Then
                tlCharTypeBuff.sType = "I"
                ilOffSet = gFieldOffset("Rvf", "RvfTranType")
                ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
                If ilRet <> BTRV_ERR_NONE Then
                    imBuildingAdvt = False
                    Exit Sub
                End If
                tlCharTypeBuff.sType = "N"
                ilOffSet = gFieldOffset("Rvf", "RvfTranType") + 1
                ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
                If ilRet <> BTRV_ERR_NONE Then
                    imBuildingAdvt = False
                    Exit Sub
                End If
            Else
                tlCharTypeBuff.sType = "H"
                ilOffSet = gFieldOffset("Rvf", "RvfTranType")
                ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
                If ilRet <> BTRV_ERR_NONE Then
                    imBuildingAdvt = False
                    Exit Sub
                End If
                tlCharTypeBuff.sType = "I"
                ilOffSet = gFieldOffset("Rvf", "RvfTranType") + 1
                ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
                If ilRet <> BTRV_ERR_NONE Then
                    imBuildingAdvt = False
                    Exit Sub
                End If
            End If
'            gPackDate slEndCal, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
'            ilOffset = gFieldOffset("Rvf", "RvfTranDate")
'            ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_DATE, ilOffset, 4, BTRV_EXT_EQUAL, BTRV_EXT_OR, tlDateTypeBuff, 4)
'            If ilRet <> BTRV_ERR_NONE Then
'                imBuildingAdvt = False
'                Exit Sub
'            End If
'            gPackDate slEndStd, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
'            ilOffset = gFieldOffset("Rvf", "RvfTranDate")
'            ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_DATE, ilOffset, 4, BTRV_EXT_EQUAL, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)
'            If ilRet <> BTRV_ERR_NONE Then
'                imBuildingAdvt = False
'                Exit Sub
'            End If
            'If llStartStd < llStartCal Then
            '    gPackDateLong llStartStd, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
            'Else
            '    gPackDateLong llStartCal, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
            'End If
            llDate = 0
            If llStartStd > 0 Then
                llDate = llStartStd
            End If
            If (llStartCal > 0) And ((llStartCal < llDate) Or (llDate = 0)) Then
                llDate = llStartCal
            End If
            If (llStartWk > 0) And ((llStartWk < llDate) Or (llDate = 0)) Then
                llDate = llStartWk
            End If
            gPackDateLong llDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
            ilOffSet = gFieldOffset("Rvf", "RvfTranDate")
            ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_GTE, BTRV_EXT_AND, tlDateTypeBuff, 4)
            If ilRet <> BTRV_ERR_NONE Then
                imBuildingAdvt = False
                Exit Sub
            End If
            'If llEndStd > llEndCal Then
            '    gPackDateLong llEndStd, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
            'Else
            '    gPackDateLong llEndCal, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
            'End If
            llDate = 0
            If llEndStd > 0 Then
                llDate = llEndStd
            End If
            If (llEndCal > 0) And ((llEndCal > llDate) Or (llDate = 0)) Then
                llDate = llEndCal
            End If
            If (llEndWk > 0) And ((llEndWk > llDate) Or (llDate = 0)) Then
                llDate = llEndWk
            End If
            gPackDateLong llDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
            ilOffSet = gFieldOffset("Rvf", "RvfTranDate")
            ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_LTE, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)
            If ilRet <> BTRV_ERR_NONE Then
                imBuildingAdvt = False
                Exit Sub
            End If
            ilOffSet = 0
            ilRet = btrExtAddField(hlFile, ilOffSet, ilExtLen)  'Extract First Name field
            If ilRet <> BTRV_ERR_NONE Then
                imBuildingAdvt = False
                Exit Sub
            End If
            'ilRet = btrExtGetNextExt(hlRvf)    'Extract record
            ilRet = btrExtGetNext(hlFile, tmRvf, ilExtLen, llRecPos)
            If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
                If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                    imBuildingAdvt = False
                    Exit Sub
                End If
                ilExtLen = Len(tmRvf)  'Extract operation record size
                Do While ilRet = BTRV_ERR_REJECT_COUNT
                    ilRet = btrExtGetNext(hlFile, tmRvf, ilExtLen, llRecPos)
                Loop
                Do While ilRet = BTRV_ERR_NONE
                    'Determine invoice dates
                    If (tmRvf.sCashTrade = "M") Or (tmRvf.sCashTrade = "P") Then
                        'Ignore Merchandizing and Promotional transactions
                        ilFound = False
                    Else
                        ilFound = False
                        tmChfSrchKey1.lCntrNo = tmRvf.lCntrNo
                        tmChfSrchKey1.iCntRevNo = 32000
                        tmChfSrchKey1.iPropVer = 32000
                        ilRet = btrGetGreaterOrEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                        Do While (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tmRvf.lCntrNo) And (tmChf.sSchStatus = "A")
                            ilRet = btrGetNext(hmCHF, tmChf, imCHFRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        Loop
                        If (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tmRvf.lCntrNo) Then
                            'gUnpackDateLong tmRvf.iTranDate(0), tmRvf.iTranDate(1), llDate
                            gUnpackDateLongError tmRvf.iTranDate(0), tmRvf.iTranDate(1), llDate, "5:AdvtPop " & tmRvf.lCode
                            gUnpackDateLongError tmChf.iEndDate(0), tmChf.iEndDate(1), llChfEndDate, "7:AdvtPop " & tmRvf.lCode
                            If tmChf.sBillCycle = "C" Then
                                If tmRvf.iMnfItem > 0 Then  'NTR
                                    If (llDate >= llStartCal) And (llDate <= llEndCal) Then
                                        ilFound = True
                                    End If
                                Else
                                    If llDate = llEndCal Then
                                        ilFound = True
                                    Else
                                        If tmRvf.sType = "I" Then   'Installment
                                            If (llDate >= llStartCal) And (llDate <= llEndCal) Then
                                                ilFound = True
                                            End If
                                        Else
                                            If (llChfEndDate >= llStartCal) And (llChfEndDate <= llEndCal) And (llDate >= llStartCal) And (llDate <= llEndCal) Then
                                                ilFound = True
                                            End If
                                        End If
                                    End If
                                End If
                            ElseIf tmChf.sBillCycle = "W" Then
                                'check all week
                                If tmRvf.iMnfItem > 0 Then  'NTR
                                    If (llDate >= llStartWk) And (llDate <= llEndWk) Then
                                        ilFound = True
                                    End If
                                Else
                                    If llDate = llEndWk Then
                                        ilFound = True
                                    Else
                                        'If (llChfEndDate >= llStartWk) And (llChfEndDate <= llEndWk) Then
                                        If tmRvf.sType = "I" Then   'Installment
                                            If (llDate >= llStartWk) And (llDate <= llEndWk) Then
                                                ilFound = True
                                            End If
                                        Else
                                            If (llChfEndDate >= llStartWk) And (llChfEndDate <= llEndWk) And (llDate >= llStartWk) And (llDate <= llEndWk) Then
                                                ilFound = True
                                            End If
                                        End If
                                    End If
                                End If
                            Else
                                If tmRvf.iMnfItem > 0 Then  'NTR
                                    If (llDate >= llStartStd) And (llDate <= llEndStd) Then
                                        ilFound = True
                                    End If
                                Else
                                    If llDate = llEndStd Then
                                        ilFound = True
                                    Else
                                        If (tmRvf.sType = "I") Or (tmRvf.lSbfCode > 0) Then   'Installment
                                            If (llDate >= llStartStd) And (llDate <= llEndStd) Then
                                                ilFound = True
                                            End If
                                        Else
                                            If (llChfEndDate >= llStartStd) And (llChfEndDate <= llEndStd) And (llDate >= llStartStd) And (llDate <= llEndStd) Then
                                                ilFound = True
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    End If
                    If (Not rbcType(INVGEN_Undo).Value) And (tmRvf.sInvoiceUndone = "Y") Then
                        ilFound = False
                    End If
                    If ilFound Then
                        'If ilPass = 2 Then
                        If tgSpf.sBCombine = "N" Then
                            For ilLoop = 0 To ilUpper - 1 Step 1
                                If tmRvf.iPkLineNo > 0 Then
                                    If (tmRPSelInfo(ilLoop).lCntrNo = tmRvf.lCntrNo) And (tmRPSelInfo(ilLoop).lInvNo = tmRvf.lInvNo) And (tmRPSelInfo(ilLoop).iPkLineNo = tmRvf.iPkLineNo) And (tmRPSelInfo(ilLoop).sCashTrade = tmRvf.sCashTrade) Then
                                        ilFound = False
                                        If tmRvf.iMnfItem > 0 Then
                                            tmRPSelInfo(ilLoop).lNTRTax1 = tmRPSelInfo(ilLoop).lNTRTax1 + tmRvf.lTax1
                                            tmRPSelInfo(ilLoop).lNTRTax2 = tmRPSelInfo(ilLoop).lNTRTax2 + tmRvf.lTax2
                                        Else
                                            tmRPSelInfo(ilLoop).lAirTax1 = tmRPSelInfo(ilLoop).lAirTax1 + tmRvf.lTax1
                                            tmRPSelInfo(ilLoop).lAirTax2 = tmRPSelInfo(ilLoop).lAirTax2 + tmRvf.lTax2
                                        End If
                                        If (tmRvf.sInvoiceUndone <> "Y") And (rbcType(INVGEN_Undo).Value) Then
                                            tmRPSelInfo(ilLoop).iSelAllowed = True
                                            tmRPSelInfo(ilLoop).sReason = ""
                                        End If
                                        '8/8/12: TTP 5559, Get latest Transaction Date as Invoice date
                                        gUnpackDate tmRvf.iTranDate(0), tmRvf.iTranDate(1), slTranDate
                                        If tmRPSelInfo(ilLoop).lInvEndDate < gDateValue(slTranDate) Then
                                            tmRPSelInfo(ilLoop).sTranDate = slTranDate
                                            tmRPSelInfo(ilLoop).lInvEndDate = gDateValue(tmRPSelInfo(ilLoop).sTranDate)
                                        End If
                                        Exit For
                                    End If
                                Else
                                    If (tmRPSelInfo(ilLoop).lCntrNo = tmRvf.lCntrNo) And (tmRPSelInfo(ilLoop).lInvNo = tmRvf.lInvNo) And (tmRPSelInfo(ilLoop).iAirVefCode = tmRvf.iAirVefCode) And (tmRPSelInfo(ilLoop).sCashTrade = tmRvf.sCashTrade) Then
                                        ilFound = False
                                        If tmRvf.iMnfItem > 0 Then
                                            tmRPSelInfo(ilLoop).lNTRTax1 = tmRPSelInfo(ilLoop).lNTRTax1 + tmRvf.lTax1
                                            tmRPSelInfo(ilLoop).lNTRTax2 = tmRPSelInfo(ilLoop).lNTRTax2 + tmRvf.lTax2
                                        Else
                                            tmRPSelInfo(ilLoop).lAirTax1 = tmRPSelInfo(ilLoop).lAirTax1 + tmRvf.lTax1
                                            tmRPSelInfo(ilLoop).lAirTax2 = tmRPSelInfo(ilLoop).lAirTax2 + tmRvf.lTax2
                                        End If
                                        If (tmRvf.sInvoiceUndone <> "Y") And (rbcType(INVGEN_Undo).Value) Then
                                            tmRPSelInfo(ilLoop).iSelAllowed = True
                                            tmRPSelInfo(ilLoop).sReason = ""
                                        End If
                                        '8/8/12: TTP 5559, Get latest Transaction Date as Invoice date
                                        gUnpackDate tmRvf.iTranDate(0), tmRvf.iTranDate(1), slTranDate
                                        If tmRPSelInfo(ilLoop).lInvEndDate < gDateValue(slTranDate) Then
                                            tmRPSelInfo(ilLoop).sTranDate = slTranDate
                                            tmRPSelInfo(ilLoop).lInvEndDate = gDateValue(tmRPSelInfo(ilLoop).sTranDate)
                                        End If
                                        Exit For
                                    End If
                                End If
                            Next ilLoop
                        Else
                            llMergeInvNo = -1
                            If ilPass > 1 Then
                                For ilMerge = 0 To UBound(tgAdvanceBillMergeInfo) - 1 Step 1
                                    If tmRvf.lInvNo = tgAdvanceBillMergeInfo(ilMerge).lPhfInvNo Then
                                        llMergeInvNo = tgAdvanceBillMergeInfo(ilMerge).lRvfInvNo
                                        Exit For
                                    End If
                                Next ilMerge
                            End If
                            For ilLoop = 0 To ilUpper - 1 Step 1
                                If (tmRPSelInfo(ilLoop).lCntrNo = tmRvf.lCntrNo) And ((tmRPSelInfo(ilLoop).lInvNo = tmRvf.lInvNo) Or (tmRPSelInfo(ilLoop).lInvNo = llMergeInvNo)) And (tmRPSelInfo(ilLoop).sCashTrade = tmRvf.sCashTrade) Then
                                    ilFound = False
                                    If (tmRPSelInfo(ilLoop).iMnfItem = 0) And (tmRvf.iMnfItem > 0) Then
                                        tmRPSelInfo(ilLoop).iMnfItem = -1
                                    End If
                                    If (tmRPSelInfo(ilLoop).iMnfItem > 0) And (tmRvf.iMnfItem = 0) Then
                                        tmRPSelInfo(ilLoop).iMnfItem = -1
                                    End If
                                    If tmRvf.iMnfItem > 0 Then
                                        tmRPSelInfo(ilLoop).lNTRTax1 = tmRPSelInfo(ilLoop).lNTRTax1 + tmRvf.lTax1
                                        tmRPSelInfo(ilLoop).lNTRTax2 = tmRPSelInfo(ilLoop).lNTRTax2 + tmRvf.lTax2
                                    Else
                                        tmRPSelInfo(ilLoop).lAirTax1 = tmRPSelInfo(ilLoop).lAirTax1 + tmRvf.lTax1
                                        tmRPSelInfo(ilLoop).lAirTax2 = tmRPSelInfo(ilLoop).lAirTax2 + tmRvf.lTax2
                                    End If
                                    If (tmRvf.sInvoiceUndone <> "Y") And (rbcType(INVGEN_Undo).Value) Then
                                        tmRPSelInfo(ilLoop).iSelAllowed = True
                                        tmRPSelInfo(ilLoop).sReason = ""
                                    End If
                                    '8/8/12: TTP 5559, Get latest Transaction Date as Invoice date
                                    gUnpackDate tmRvf.iTranDate(0), tmRvf.iTranDate(1), slTranDate
                                    If tmRPSelInfo(ilLoop).lInvEndDate < gDateValue(slTranDate) Then
                                        tmRPSelInfo(ilLoop).sTranDate = slTranDate
                                        tmRPSelInfo(ilLoop).lInvEndDate = gDateValue(tmRPSelInfo(ilLoop).sTranDate)
                                    End If
                                    Exit For
                                End If
                            Next ilLoop
                        End If
                        'End If
                        'Filter out invoice types
                        If ilFound Then
                            ilVef = gBinarySearchVef(tmRvf.iBillVefCode)
                            If ilVef <> -1 Then
                                slVefType = tgMVef(ilVef).sType
                            Else
                                slVefType = ""
                            End If
                            If ckcType(INVTYPE_Commercial).Value = vbUnchecked Then
                                If (tmRvf.iMnfItem = 0) And (slVefType <> "R") Then
                                    ilFound = False
                                End If
                            End If
                            If ckcType(INVTYPE_PrintRep).Value = vbUnchecked Then
                                If (tmRvf.iMnfItem = 0) And (slVefType = "R") Then
                                    ilFound = False
                                End If
                            End If
                            If ckcType(INVTYPE_NTR).Value = vbUnchecked Then
                                If tmRvf.iMnfItem > 0 Then
                                    ilFound = False
                                End If
                            End If
                        End If
                        If ilFound Then
                            tmRPSelInfo(ilUpper).lCntrNo = tmRvf.lCntrNo
                            tmRPSelInfo(ilUpper).lInvNo = tmRvf.lInvNo
                            tmRPSelInfo(ilUpper).sCashTrade = tmRvf.sCashTrade
                            tmRPSelInfo(ilUpper).iAdfCode = tmRvf.iAdfCode
                            tmRPSelInfo(ilUpper).iAgfCode = tmRvf.iAgfCode
                            tmRPSelInfo(ilUpper).iSlfCode = tmRvf.iSlfCode
                            tmRPSelInfo(ilUpper).iBillVefCode = tmRvf.iBillVefCode
                            tmRPSelInfo(ilUpper).iAirVefCode = tmRvf.iAirVefCode
                            tmRPSelInfo(ilUpper).iPkLineNo = tmRvf.iPkLineNo
                            tmRPSelInfo(ilUpper).iMnfItem = tmRvf.iMnfItem
                            If tmRvf.iMnfItem > 0 Then
                                tmRPSelInfo(ilUpper).lNTRTax1 = tmRvf.lTax1
                                tmRPSelInfo(ilUpper).lNTRTax2 = tmRvf.lTax2
                            Else
                                tmRPSelInfo(ilUpper).lAirTax1 = tmRvf.lTax1
                                tmRPSelInfo(ilUpper).lAirTax2 = tmRvf.lTax2
                            End If
                            If (tmRvf.sInvoiceUndone = "Y") And (rbcType(INVGEN_Undo).Value) Then
                                tmRPSelInfo(ilUpper).iSelAllowed = False
                                tmRPSelInfo(ilUpper).sReason = "Previously Undone"
                            Else
                                tmRPSelInfo(ilUpper).iSelAllowed = True
                                tmRPSelInfo(ilUpper).sReason = ""
                            End If
                            tmRPSelInfo(ilUpper).sBillCycle = tmChf.sBillCycle
                            gUnpackDate tmRvf.iTranDate(0), tmRvf.iTranDate(1), tmRPSelInfo(ilUpper).sTranDate
                            If tmChf.sBillCycle = "C" Then
                                tmRPSelInfo(ilUpper).lInvStartDate = gDateValue(gObtainStartCal(tmRPSelInfo(ilUpper).sTranDate))
                                tmRPSelInfo(ilUpper).lInvEndDate = gDateValue(tmRPSelInfo(ilUpper).sTranDate)
                            ElseIf tmChf.sBillCycle = "W" Then
                                tmRPSelInfo(ilUpper).lInvStartDate = gDateValue(gObtainPrevMonday(tmRPSelInfo(ilUpper).sTranDate))
                                tmRPSelInfo(ilUpper).lInvEndDate = gDateValue(tmRPSelInfo(ilUpper).sTranDate)
                            Else
                                tmRPSelInfo(ilUpper).lInvStartDate = gDateValue(gObtainStartStd(tmRPSelInfo(ilUpper).sTranDate))
                                tmRPSelInfo(ilUpper).lInvEndDate = gDateValue(tmRPSelInfo(ilUpper).sTranDate)
                            End If
                            ilUpper = ilUpper + 1
                            ReDim Preserve tmRPSelInfo(0 To ilUpper) As RPSELINFO
                        End If
                    End If
                    ilRet = btrExtGetNext(hlFile, tmRvf, ilExtLen, llRecPos)
                    Do While ilRet = BTRV_ERR_REJECT_COUNT
                        ilRet = btrExtGetNext(hlFile, tmRvf, ilExtLen, llRecPos)
                    Loop
                Loop
            End If
        End If
    Next ilPass
    'Change start date of matching contract if one invoice is for expired contract. Start date set to expired end date plus 1
    For ilLoop = 0 To UBound(tmRPSelInfo) - 1 Step 1
        'Determine if partial period billed
        blAdjDate = False
        If tmChf.sBillCycle = "C" Then
            If tmRPSelInfo(ilLoop).lInvEndDate <> gDateValue(gObtainEndCal(tmRPSelInfo(ilLoop).sTranDate)) Then
                blAdjDate = True
            End If
        ElseIf tmChf.sBillCycle = "W" Then
            If tmRPSelInfo(ilLoop).lInvEndDate <> gDateValue(gObtainPrevSunday(tmRPSelInfo(ilLoop).sTranDate)) Then
                blAdjDate = True
            End If
        Else
            If tmRPSelInfo(ilLoop).lInvEndDate <> gDateValue(gObtainEndStd(tmRPSelInfo(ilLoop).sTranDate)) Then
                blAdjDate = True
            End If
        End If
        If blAdjDate Then
            For ilTest = 0 To UBound(tmRPSelInfo) - 1 Step 1
                If (ilLoop <> ilTest) And (tmRPSelInfo(ilLoop).lCntrNo = tmRPSelInfo(ilTest).lCntrNo) And (tmRPSelInfo(ilLoop).sCashTrade = tmRPSelInfo(ilTest).sCashTrade) And (tmRPSelInfo(ilLoop).lInvStartDate = tmRPSelInfo(ilTest).lInvStartDate) And (tmRPSelInfo(ilLoop).lInvNo = tmRPSelInfo(ilTest).lInvNo) Then
                    tmRPSelInfo(ilTest).lInvStartDate = tmRPSelInfo(ilLoop).lInvEndDate + 1
                End If
            Next ilTest
        End If
    Next ilLoop
    For ilLoop = 0 To UBound(tmRPSelInfo) - 1 Step 1
        If tmRPSelInfo(ilLoop).iAdfCode <> tmAdf.iCode Then
            tmAdfSrchKey.iCode = tmRPSelInfo(ilLoop).iAdfCode
            ilRet = btrGetEqual(hmAdf, tmAdf, imAdfRecLen, tmAdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                tmAdf.sName = "Missing" & str$(tmRPSelInfo(ilLoop).iAdfCode)
                tmAdf.sBillAddr(0) = "Missing"
                tmAdf.sBillAddr(1) = " "
                tmAdf.sBillAddr(2) = " "
                tmAdf.sBillAgyDir = ""
            End If
        End If
        slCntrNo = Trim$(str$(tmRPSelInfo(ilLoop).lCntrNo))
        Do While Len(slCntrNo) < 8
            slCntrNo = "0" & slCntrNo
        Loop
        slInvNo = Trim$(str$(tmRPSelInfo(ilLoop).lInvNo))
        Do While Len(slInvNo) < 8
            slInvNo = "0" & slInvNo
        Loop
        If (tmAdf.sBillAgyDir = "D") And (Trim$(tmAdf.sAddrID) <> "") Then
            tmRPSelInfo(ilLoop).sKey = Trim$(tmAdf.sName) & ", " & Trim$(tmAdf.sAddrID) & "|" & slCntrNo & "|" & slInvNo
        Else
            tmRPSelInfo(ilLoop).sKey = tmAdf.sName & "|" & slCntrNo & "|" & slInvNo
        End If
    Next ilLoop
    ilUpper = UBound(tmRPSelInfo)
    If ilUpper > 0 Then
        'ArraySortTyp fnAV(tgSortKey(),0), ilUpper, 0, LenB(tgSortKey(0)), 0, -9, 0
        ArraySortTyp fnAV(tmRPSelInfo(), 0), ilUpper, 0, LenB(tmRPSelInfo(0)), 0, LenB(tmRPSelInfo(0).sKey), 0
    End If
    If rbcType(INVGEN_Undo).Value Then        'Undo
        'Determine if allowed to select
        For ilLoop = 0 To UBound(tmRPSelInfo) - 1 Step 1
            If tmRPSelInfo(ilLoop).iSelAllowed Then
                'Check receivables:  Sum All transaction sum (ignoring and "IN" transaction).  If don't sum to zero, then disallow Undo
                tmRvfSrchKey5.lInvNo = tmRPSelInfo(ilLoop).lInvNo
                ilRet = btrGetEqual(hmRvf, tmRvf, imRvfRecLen, tmRvfSrchKey5, INDEXKEY5, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                If ilRet = BTRV_ERR_NONE Then
                    slSumNet = "0.00"
                    Do While ilRet = BTRV_ERR_NONE
                        If tmRvf.lInvNo <> tmRPSelInfo(ilLoop).lInvNo Then
                            Exit Do
                        End If
                        If (tmRvf.sTranType <> "IN") Then
                            If (tmRvf.lSbfCode <= 0) Then
                                tmVefSrchKey.iCode = tmRvf.iBillVefCode
                                ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                If ilRet = BTRV_ERR_NONE Then
                                    If (tmVef.sType <> "R") Or ((tmVef.sType = "R") And (tmRvf.sTranType <> "AN")) Or ((tmVef.sType = "R") And (tmRvf.sTranType = "AN") And (tmRvf.lRefInvNo <> 0)) Then
                                        gPDNToStr tmRvf.sNet, 2, slNet
                                        slSumNet = gAddStr(slSumNet, slNet)
                                    End If
                                End If
                            Else
                                gPDNToStr tmRvf.sNet, 2, slNet
                                slSumNet = gAddStr(slSumNet, slNet)
                            End If
                        End If
                        ilRet = btrGetNext(hmRvf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                    Loop
                    If gCompNumberStr(slSumNet, "0.00") <> 0 Then
                        tmRPSelInfo(ilLoop).iSelAllowed = False
                        tmRPSelInfo(ilLoop).sReason = "Reverse Receivable Adjustments to UNDO"
                    End If
                End If
                If tmRPSelInfo(ilLoop).iSelAllowed Then
                    'Check history: If any transaction was the result of zero purged, disallow undo.
                    '               Sum all revenue installment adjustments.  If don't sum to zero disallow undo
                    slSumNet = "0.00"
                    tmRvfSrchKey5.lInvNo = tmRPSelInfo(ilLoop).lInvNo
                    ilRet = btrGetEqual(hmPhf, tmRvf, imRvfRecLen, tmRvfSrchKey5, INDEXKEY5, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    Do While ilRet = BTRV_ERR_NONE
                        If tmRvf.lInvNo <> tmRPSelInfo(ilLoop).lInvNo Then
                            Exit Do
                        End If
                        If (tmRvf.sCashTrade <> "T") Or (tgSpf.sRUseTrade = "Y") Then
                            'gUnpackDateLong tmRvf.iPurgeDate(0), tmRvf.iPurgeDate(1), llDate
                            gUnpackDateLongError tmRvf.iPurgeDate(0), tmRvf.iPurgeDate(1), llDate, "6:AdvtPop " & tmRvf.lCode
                            If (tmRvf.sTranType <> "HI") And (llDate <> 0) Then
                                tmRPSelInfo(ilLoop).iSelAllowed = False
                                tmRPSelInfo(ilLoop).sReason = "Restore from History to UNDO"
                                Exit Do
                            ElseIf (tmRvf.sTranType <> "HI") And (llDate = 0) Then
                                gPDNToStr tmRvf.sNet, 2, slNet
                                slSumNet = gAddStr(slSumNet, slNet)
                            End If
                        End If
                        ilRet = btrGetNext(hmPhf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                    Loop
                    If (gCompNumberStr(slSumNet, "0.00") <> 0) And (tmRPSelInfo(ilLoop).iSelAllowed) Then
                        tmRPSelInfo(ilLoop).iSelAllowed = False
                        tmRPSelInfo(ilLoop).sReason = "Reverse History Adjustments to UNDO"
                    End If
                End If
            End If
        Next ilLoop
    End If
    'TTP 10476 - Installment NTR invoice reprint: not all NTR items are being included
    grdRevenue.Redraw = False
    llRow = grdRevenue.FixedRows
    For ilLoop = 0 To UBound(tmRPSelInfo) - 1 Step 1
        ilRet = gParseItem(tmRPSelInfo(ilLoop).sKey, 1, "|", slName)    'Get application name
        ilRet = gParseItem(tmRPSelInfo(ilLoop).sKey, 2, "|", slCntrNo)    'Get application name
        ilRet = gParseItem(tmRPSelInfo(ilLoop).sKey, 3, "|", slInvNo)    'Get application name
        'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
        'slStr = Trim$(slName) & "|" & Trim$(str$(Val(slCntrNo))) & "|" & Trim$(str$(Val(slInvNo)))
        'TTP 10813 - add Salesperson
        slStr = "|" & Trim$(slName) & "|" & Trim$(str$(Val(slCntrNo))) & "|" & Trim$(str$(Val(slInvNo)))
        If tmRPSelInfo(ilLoop).sCashTrade = "C" Then
            slStr = slStr & "|C"
        Else
            slStr = slStr & "|T"
        End If
        If tmRPSelInfo(ilLoop).iMnfItem > 0 Then
            slStr = slStr & "-NTR"
        ElseIf tmRPSelInfo(ilLoop).iMnfItem = -1 Then
            slStr = slStr & "-Both"
        End If
        If tgSpf.sBCombine = "N" Then
            If tmRPSelInfo(ilLoop).iPkLineNo > 0 Then
                tmVefSrchKey.iCode = tmRPSelInfo(ilLoop).iBillVefCode
            Else
                tmVefSrchKey.iCode = tmRPSelInfo(ilLoop).iAirVefCode
            End If
            ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet = BTRV_ERR_NONE Then
                slStr = slStr & "|" & Trim$(tmVef.sName)
            End If
        End If
        'lbcAdvt.AddItem slStr
        'lbcAdvt.ItemData(lbcAdvt.NewIndex) = 0
        If llRow >= grdRevenue.rows Then
            grdRevenue.AddItem ""
        End If
        grdRevenue.RowHeight(llRow) = fgBoxGridH + 15
        grdRevenue.Row = llRow
        If tmRPSelInfo(ilLoop).iSelAllowed = False Then
            For llCol = AGYINDEX To TRANDATEINDEX Step 1
                grdRevenue.Col = llCol
                If grdRevenue.CellForeColor <> vbRed Then grdRevenue.CellForeColor = vbRed
            Next llCol
        End If
        grdRevenue.TextMatrix(llRow, EMAILINDEX) = ""
        
        If tmRPSelInfo(ilLoop).iAgfCode > 0 Then
            ilAgf = gBinarySearchAgf(tmRPSelInfo(ilLoop).iAgfCode)
            If ilAgf <> -1 Then
                grdRevenue.TextMatrix(llRow, AGYINDEX) = Trim$(tgCommAgf(ilAgf).sName) & "/" & Trim$(tgCommAgf(ilAgf).sCityID)
                
                'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                If tgCommAgf(ilAgf).iArfInvCode <> imPDFEmailArf Then
                    'This Agency does not use PDF Email
                    grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) = "-1"
                    grdRevenue.Row = llRow
                    grdRevenue.Col = EMAILINDEX
                    grdRevenue.CellFontName = "Monotype Sorts"
                    If grdRevenue.CellForeColor <> RGB(220, 220, 220) Then grdRevenue.CellForeColor = RGB(220, 220, 220)
                    grdRevenue.TextMatrix(llRow, EMAILINDEX) = "7" 'Show an X
                End If
            End If
        Else
            grdRevenue.TextMatrix(llRow, AGYINDEX) = "Direct"
        End If
        ilAdf = gBinarySearchAdf(tmRPSelInfo(ilLoop).iAdfCode)
        If ilAdf <> -1 Then
            grdRevenue.TextMatrix(llRow, ADVTINDEX) = Trim$(tgCommAdf(ilAdf).sName)
            
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                If grdRevenue.TextMatrix(llRow, AGYINDEX) = "Direct" Then
                    If tgCommAdf(ilAdf).iArfInvCode <> imPDFEmailArf Then
                        'This Direct Adv. does not use PDF Email
                        grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) = "-1"
                        grdRevenue.Row = llRow
                        grdRevenue.Col = EMAILINDEX
                        grdRevenue.CellFontName = "Monotype Sorts"
                        If grdRevenue.CellForeColor <> RGB(220, 220, 220) Then grdRevenue.CellForeColor = RGB(220, 220, 220)
                        grdRevenue.TextMatrix(llRow, EMAILINDEX) = "7" 'Show an X
                    End If
                End If
        End If
        ilSlf = gBinarySearchSlf(tmRPSelInfo(ilLoop).iSlfCode)
        If ilSlf <> -1 Then
            If tgMSlf(ilSlf).iSofCode > 0 Then
                If tgMSlf(ilSlf).iSofCode <> tmSof.iCode Then
                    tmSofSrchKey.iCode = tgMSlf(ilSlf).iSofCode
                    ilRet = btrGetEqual(hmSof, tmSof, imSofRecLen, tmSofSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        tmSof.sName = ""
                    End If
                End If
            End If
        Else
            tmSof.sName = ""
        End If
        grdRevenue.TextMatrix(llRow, SOFFICEINDEX) = Trim$(tmSof.sName)
        grdRevenue.TextMatrix(llRow, SPERSONINDEX) = Trim$(tgMSlf(ilSlf).sLastName) & ", " & Trim$(tgMSlf(ilSlf).sFirstName)
        grdRevenue.TextMatrix(llRow, CNTRNOINDEX) = Trim$(str$(tmRPSelInfo(ilLoop).lCntrNo))
        grdRevenue.TextMatrix(llRow, INVNOINDEX) = Trim$(str$(tmRPSelInfo(ilLoop).lInvNo))
        For ilMerge = 0 To UBound(tgAdvanceBillMergeInfo) - 1 Step 1
            If tmRPSelInfo(ilLoop).lInvNo = tgAdvanceBillMergeInfo(ilMerge).lRvfInvNo Then
                grdRevenue.TextMatrix(llRow, INVNOINDEX) = grdRevenue.TextMatrix(llRow, INVNOINDEX) + "/" + Trim$(str$(tgAdvanceBillMergeInfo(ilMerge).lPhfInvNo))
                Exit For
            End If
        Next ilMerge
        
        grdRevenue.TextMatrix(llRow, CASHTRADEINDEX) = Trim$(tmRPSelInfo(ilLoop).sCashTrade)
        Select Case tmRPSelInfo(ilLoop).sBillCycle
            Case "C"
                grdRevenue.TextMatrix(llRow, CYCLEINDEX) = "Calendar"
            Case "W"
                grdRevenue.TextMatrix(llRow, CYCLEINDEX) = "Weekly"
            Case Else
                grdRevenue.TextMatrix(llRow, CYCLEINDEX) = "Std B'cast"
        End Select
        grdRevenue.TextMatrix(llRow, TRANDATEINDEX) = Trim$(tmRPSelInfo(ilLoop).sTranDate)
        grdRevenue.TextMatrix(llRow, INDEXCODEINDEX) = Trim$(str$(ilLoop))
        llRow = llRow + 1
    Next ilLoop
    'pbcLbcAdvt_Paint
    'lbcAdvt.Enabled = True
    grdRevenue.Redraw = True
    imBuildingAdvt = False
End Sub

'*************************************************************************************
'*                                                                                   *
'*      Procedure Name: mAllVehSel                                                    *
'*                                                                                   *
'*             Created: 10/6/01       By:D. LeVine                                    *
'*            Modified:               By:                                             *
'*                                                                                   *
'*            Comments: Selective vehicles were chosen on the invoice screen.        *
'*                      Here we verify that for any given contract that all of the   *
'*                      vehicles that make up the contract were selected.            *
'*                      If not then we don't process that contract.  We output and   *
'*                      an error message and write the message to a file.            *
'*                                                                                   *
'*************************************************************************************
'
Function mAllVehSel(slFrom As String, llChfCode As Long) As Integer
    Dim ilClf As Integer
    Dim ilTstVefCode As Integer
    Dim ilLoop As Integer
    Dim ilVefOK As Integer
    Dim ilRet As Integer
    Dim NumLineInErr As Integer
    Dim NumLineProc As Integer
    Dim ilSbfInErr As Integer
    Dim ilAnySbfOk As Integer
    Dim ilPcfInErr As Integer
    Dim ilAnyPcfOk As Integer
    Dim tlSbf As SBF
    Dim tlPcf As PCF

    NumLineProc = 0
    NumLineInErr = 0
    ilSbfInErr = False
    ilAnySbfOk = False
    ilPcfInErr = False
    ilAnyPcfOk = False
    mAllVehSel = True

    If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then     '11-15-16 reprint, aff or archive
        Exit Function
    End If
    If (tgSpf.sInvVehSel <> "Y") Or ((tgSpf.sInvVehSel = "Y") And (ckcAll.Value = vbChecked)) Then
        Exit Function
    End If
    If (slFrom = "C") Or (((Asc(tgSpf.sUsingFeatures5) And COMBINEAIRNTR) = COMBINEAIRNTR) And (ckcType(INVTYPE_Commercial).Value = vbChecked)) Then
        If (slFrom <> "C") Then
            ilRet = gObtainChfClf(hmCHF, hmClf, llChfCode, False, tgChfInv, tgClfInv())
        End If
        For ilClf = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
            tmClf = tgClfInv(ilClf).ClfRec
            If (tmClf.sType <> "O") And (tmClf.sType <> "A") And (tmClf.sType <> "E") Then
                NumLineProc = NumLineProc + 1
                ilTstVefCode = tmClf.iVefCode
            Else
                ilTstVefCode = 0
            End If

            If ilTstVefCode <> 0 Then
                'this is where we check ilTstVefCode agaisnt the selected vehicles
                'if it is not  one of the selected veh then set the fuction to true
                ilVefOK = False
                'For ilLoop = 0 To lbcVehicle.ListCount - 1 Step 1
                '    If lbcVehicle.Selected(ilLoop) Then
                '        slNameCode = tmInvVehicle(ilLoop).sKey
                '        ilRet = gParseItem(slNameCode, 2, "\", slCode)
                '        ilVefCode = Val(slCode)
                '        If ilTstVefCode = ilVefCode Then
                '            ilVefOK = True
                '            Exit For
                '        End If
                '    End If
                'Next ilLoop
                For ilLoop = 0 To UBound(tgInvVehCode) - 1 Step 1
                    If tgInvVehCode(ilLoop).iCode = ilTstVefCode Then
                        ilVefOK = True
                        Exit For
                    End If
                Next ilLoop

                If Not ilVefOK Then
                    mAllVehSel = False
                    NumLineInErr = NumLineInErr + 1
                End If
            End If
        Next ilClf
    End If
    tmSbfSrchKey0.lChfCode = llChfCode
    tmSbfSrchKey0.iDate(0) = 0
    tmSbfSrchKey0.iDate(1) = 0
    tmSbfSrchKey0.sTranType = " "
    ilRet = btrGetGreaterOrEqual(hmSbfVehCheck, tlSbf, imSbfRecLen, tmSbfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tlSbf.lChfCode = llChfCode)
        If (tlSbf.sBilled <> "Y") Then
            ilVefOK = False
            For ilLoop = 0 To UBound(tgInvVehCode) - 1 Step 1
                If tgInvVehCode(ilLoop).iCode = tlSbf.iBillVefCode Then
                    ilVefOK = True
                    Exit For
                End If
            Next ilLoop

            If Not ilVefOK Then
                mAllVehSel = False
                ilSbfInErr = True
            Else
                ilAnySbfOk = True
            End If
        End If
        ilRet = btrGetNext(hmSbfVehCheck, tlSbf, imSbfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    tmPcfSrchKey2.lChfCode = llChfCode
    tmPcfSrchKey2.iVefCode = 0
    ilRet = btrGetGreaterOrEqual(hmPcfVehCheck, tlPcf, imPcfRecLen, tmPcfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tlPcf.lChfCode = llChfCode)
        If (tlPcf.sType <> "P") Then
            ilVefOK = False
            For ilLoop = 0 To UBound(tgInvVehCode) - 1 Step 1
                If tgInvVehCode(ilLoop).iCode = tlPcf.iVefCode Then
                    ilVefOK = True
                    Exit For
                End If
            Next ilLoop

            If Not ilVefOK Then
                mAllVehSel = False
                ilPcfInErr = True
            Else
                ilAnyPcfOk = True
            End If
        End If
        ilRet = btrGetNext(hmPcfVehCheck, tlPcf, imPcfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    If (NumLineInErr <> NumLineProc) And (NumLineInErr <> 0) Or ((ilSbfInErr) And (ilAnySbfOk)) Or ((ilPcfInErr) And (ilAnyPcfOk)) Then
        Print #hmMsg, " Vehicle: " & " Contract: " & Trim$(str$(tgChfInv.lCntrNo)) & " had a mixture of selected and non-selected vehicles."
        igInvErrFlag = True
    End If
 End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mAssignCopyToSpot               *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Assign copy to Spot records     *
'*                                                     *
'*******************************************************
Private Sub mAssignCopyToSpot(ilType As Integer, hlSpot As Integer, tlSdf As SDF, tlSmf As SMF)
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilVpf                         ilVef                                                   *
'******************************************************************************************
'
'   ilType(I)- 0=Sdf; 1=Smf (Assign to mg within smf- order only)
'   hlSpot(I)- either hmPsf or hmSdf or hmSmf (if SchStatus = O or G)
'   tlSdf(I)- either tmPsf or tmSdf
'   tlSmf(I)- required if tlSdf.sSchStatus = O or G and ivoicing by Order
'
    Dim ilRet As Integer
    Dim ilCRet As Integer
    Dim llDate As Long
    Dim slDate As String
    Dim slTime As String
    Dim llSpotTime As Long
    Dim llSAsgnDate As Long
    Dim llEAsgnDate As Long
    Dim llSAsgnTime As Long
    Dim llEAsgnTime As Long
    Dim ilAsgnDate0 As Integer
    Dim ilAsgnDate1 As Integer
    'Dim ilAsgnTime0 As Integer
    'Dim ilAsgnTime1 As Integer
    'Dim ilTime0 As Integer
    'Dim ilTime1 As Integer
    'Dim ilLoop As Integer
    'Dim llRecPos As Long
    Dim slType As String
    Dim llCrfRecPos As Long
    Dim llCifRecPos As Long
    Dim llSdfRecPos As Long
    Dim llTzfRecPos As Long
    Dim ilDay As Integer
    Dim ilSpotAsgn As Integer
    Dim ilAllZones As Integer    'All zones assigned
    Dim ilZone As Integer
    Dim ilFound As Integer
    Dim slNowDate As String
    Dim slNowTime As String
    'Dim slAssgDate As String
    Dim ilPFAsgn As Integer
    Dim ilVefCode As Integer
    Dim slPtType As String
    Dim llCopyCode As Long
    Dim ilRotNo As Integer
    Dim ilTestAssg As Integer
    Dim tlClfSrchKey As CLFKEY0 'CLF key record image
    Dim tlClf As CLF            'CLF record image
    Dim slLive As String
    Dim ilBypassCrf As Integer

    ilPFAsgn = 1    'Final
    slNowDate = Format$(gNow(), "m/d/yy")
    slNowTime = Format$(gNow(), "h:mm:ssAM/PM")

    If ilType = 1 Then
        If (tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") And (tgSpf.sInvAirOrder <> "2") Then
            Exit Sub
        End If
        If (tgSpf.sInvAirOrder = "O") And (tgSpf.sBLaserForm = "2") Then
            Exit Sub
        End If

        'gUnpackDateLong tlSmf.iMissedDate(0), tlSmf.iMissedDate(1), llDate
        gUnpackDateLongError tlSmf.iMissedDate(0), tlSmf.iMissedDate(1), llDate, "7:mAssignCopyToSpot " & tlSmf.lCode
        ilDay = gWeekDayLong(llDate)
        ilAsgnDate0 = tlSmf.iMissedDate(0)
        ilAsgnDate1 = tlSmf.iMissedDate(1)
        gUnpackTime tlSmf.iMissedTime(0), tlSmf.iMissedTime(1), "A", "1", slTime
        ilVefCode = tlSmf.iOrigSchVef
        slPtType = tlSmf.sPtType
        llCopyCode = tlSmf.lCopyCode
        ilRotNo = tlSmf.iRotNo
    Else
        'gUnpackDateLong tlSdf.iDate(0), tlSdf.iDate(1), llDate
        gUnpackDateLongError tlSdf.iDate(0), tlSdf.iDate(1), llDate, "8:mAssignCopyToSpot " & tlSdf.lCode
        ilDay = gWeekDayLong(llDate)
        ilAsgnDate0 = tlSdf.iDate(0)
        ilAsgnDate1 = tlSdf.iDate(1)
        gUnpackTime tlSdf.iTime(0), tlSdf.iTime(1), "A", "1", slTime
        ilVefCode = tlSdf.iVefCode
        slPtType = tlSdf.sPtType
        llCopyCode = tlSdf.lCopyCode
        ilRotNo = tlSdf.iRotNo
    End If
    llSpotTime = CLng(gTimeToCurrency(slTime, False)) '- 1

    tlClfSrchKey.lChfCode = tlSdf.lChfCode
    tlClfSrchKey.iLine = tlSdf.iLineNo
    tlClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
    tlClfSrchKey.iPropVer = 32000 ' Plug with very high number
    imClfRecLen = Len(tlClf)
    ilRet = btrGetGreaterOrEqual(hmClf, tlClf, imClfRecLen, tlClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)
    Do While (ilRet = BTRV_ERR_NONE) And (tlClf.lChfCode = tlSdf.lChfCode) And (tlClf.iLine = tlSdf.iLineNo) And ((tlClf.sSchStatus <> "M") And (tlClf.sSchStatus <> "F"))  'And (tlClf.sSchStatus = "A")
        ilRet = btrGetNext(hmClf, tlClf, imClfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    If (ilRet = BTRV_ERR_NONE) And (tlClf.lChfCode = tlSdf.lChfCode) And (tlClf.iLine = tlSdf.iLineNo) Then
        slLive = tlClf.sLiveCopy
    Else
        slLive = "R"
    End If

    'Find rotation to assign
    'Code later- test spot type to determine which rotation type
    ilSpotAsgn = False
    ilAllZones = False
    ilTestAssg = True
    slType = "A"
    '5/5/15: Handle multi-vehicle copy rotations
    'tmCrfSrchKey1.sRotType = slType
    'tmCrfSrchKey1.iEtfCode = 0
    'tmCrfSrchKey1.iEnfCode = 0
    'tmCrfSrchKey1.iadfCode = tlSdf.iadfCode
    'tmCrfSrchKey1.lChfCode = tlSdf.lChfCode
    'tmCrfSrchKey1.lFsfCode = 0
    'tmCrfSrchKey1.iVefCode = ilVefCode
    'tmCrfSrchKey1.iRotNo = 32000
    'ilRet = btrGetGreaterOrEqual(hmCrf, tmCrf, imCrfRecLen, tmCrfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get last current record to obtain date
    'Do While (ilRet = BTRV_ERR_NONE) And (tmCrf.sRotType = slType) And (tmCrf.iEtfCode = 0) And (tmCrf.iEnfCode = 0) And (tmCrf.iadfCode = tlSdf.iadfCode) And (tmCrf.lChfCode = tlSdf.lChfCode) And (tmCrf.iVefCode = ilVefCode)
    tmCrfSrchKey4.sRotType = slType
    tmCrfSrchKey4.iEtfCode = 0
    tmCrfSrchKey4.iEnfCode = 0
    tmCrfSrchKey4.iAdfCode = tlSdf.iAdfCode
    tmCrfSrchKey4.lChfCode = tlSdf.lChfCode
    tmCrfSrchKey4.lFsfCode = tlSdf.lFsfCode         'feed code
    tmCrfSrchKey4.iRotNo = 32000
    ilRet = btrGetGreaterOrEqual(hmCrf, tmCrf, imCrfRecLen, tmCrfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)   'Get last current record to obtain date
    Do While (ilRet = BTRV_ERR_NONE) And (tmCrf.sRotType = slType) And (tmCrf.iEtfCode = 0) And (tmCrf.iEnfCode = 0) And (tmCrf.iAdfCode = tlSdf.iAdfCode) And (tmCrf.lChfCode = tlSdf.lChfCode) And (tmCrf.lFsfCode = tlSdf.lFsfCode)
        'Test date, time, day and zone
        ilSpotAsgn = False
        ilBypassCrf = False
        'Test if looking for Live or Recorded rotations
        If tmCrf.sState <> "D" Then
            If slLive = "L" Then
                If tmCrf.sLiveCopy <> "L" Then
                    ilBypassCrf = True
                End If
            ElseIf slLive = "M" Then
                If tmCrf.sLiveCopy <> "M" Then
                    ilBypassCrf = True
                End If
            ElseIf slLive = "S" Then
                If tmCrf.sLiveCopy <> "S" Then
                    ilBypassCrf = True
                End If
            ElseIf slLive = "P" Then
                If tmCrf.sLiveCopy <> "P" Then
                    ilBypassCrf = True
                End If
            ElseIf slLive = "Q" Then
                If tmCrf.sLiveCopy <> "Q" Then
                    ilBypassCrf = True
                End If
            Else
                If (tmCrf.sLiveCopy = "L") Or (tmCrf.sLiveCopy = "M") Or (tmCrf.sLiveCopy = "S") Or (tmCrf.sLiveCopy = "P") Or (tmCrf.sLiveCopy = "Q") Then
                    ilBypassCrf = True
                End If
            End If
            '5/5/15: Handle multi-vehicle copy rotations
            If Not ilBypassCrf Then
                If Not gCheckCrfVehicle(ilVefCode, tmCrf, hmCvf) Then
                    ilBypassCrf = True
                End If
            End If
            If Not ilBypassCrf Then
                If (tmCrf.lRafCode > 0) And (Trim$(tmCrf.sZone) = "R") Then
                    ilBypassCrf = True
                    'If (Asc(tgSpf.sUsingFeatures2) And SPLITCOPY) = SPLITCOPY Then
                    '    'ilVpf = gBinarySearchVpf(tmCrf.iVefCode)
                    '    'If ilVpf <> -1 Then
                    '    '    If tgVpf(ilVpf).sAllowSplitCopy <> "Y" Then
                    '    '        ilBypassCrf = True
                    '    '    End If
                    '    'Else
                    '    '    ilBypassCrf = True
                    '    'End If
                    '    ilVef = gBinarySearchVef(tmCrf.iVefCode)
                    '    If ilVef <> -1 Then
                    '        If (tgMVef(ilVef).sType = "C") Or (tgMVef(ilVef).sType = "A") Or (tgMVef(ilVef).sType = "G") Then
                    '            ilVpf = gBinarySearchVpf(tmCrf.iVefCode)
                    '            If ilVpf <> -1 Then
                    '                If tgVpf(ilVpf).sAllowSplitCopy <> "Y" Then
                    '                    ilBypassCrf = True
                    '                End If
                    '            Else
                    '                ilBypassCrf = True
                    '            End If
                    '        ElseIf (tgMVef(ilVef).sType = "S") Or (tgMVef(ilVef).sType = "P") Then
                    '            ilBypassCrf = False
                    '        Else
                    '            ilBypassCrf = True
                    '        End If
                    '    Else
                    '        ilBypassCrf = True
                    '    End If
                    'End If
                End If
            End If
        Else
            ilBypassCrf = True
        End If
        If (tmCrf.sDay(ilDay) = "Y") And (tlSdf.iLen = tmCrf.iLen) And (Not ilBypassCrf) Then
            gUnpackDate tmCrf.iStartDate(0), tmCrf.iStartDate(1), slDate
            llSAsgnDate = gDateValue(slDate)
            gUnpackDate tmCrf.iEndDate(0), tmCrf.iEndDate(1), slDate
            llEAsgnDate = gDateValue(slDate)
            If (llDate >= llSAsgnDate) And (llDate <= llEAsgnDate) Then
                gUnpackTime tmCrf.iStartTime(0), tmCrf.iStartTime(1), "A", "1", slTime
                llSAsgnTime = CLng(gTimeToCurrency(slTime, False))
                gUnpackTime tmCrf.iEndTime(0), tmCrf.iEndTime(1), "A", "1", slTime
                llEAsgnTime = CLng(gTimeToCurrency(slTime, True)) - 1
                If (llSpotTime >= llSAsgnTime) And (llSpotTime <= llEAsgnTime) Then
                    'Check if rotation previously assign
                    'and requires replacing
                    If slPtType = "3" Then 'Time zone
                        tmTzfSrchKey.lCode = llCopyCode
                        ilRet = btrGetEqual(hmTzf, tmTzf, imTzfRecLen, tmTzfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If ilRet = BTRV_ERR_NONE Then
                            If Trim$(tmCrf.sZone) = "" Then 'All zones (note zone copy superseded by all zones will be check when assigning)
                                'For ilZone = 1 To 6 Step 1
                                For ilZone = 0 To 5 Step 1
                                    If ((Trim$(tmTzf.sZone(ilZone)) = "") Or (StrComp(tmTzf.sZone(ilZone), "Oth", 1) = 0)) And (tmTzf.lCifZone(ilZone) <> 0) Then
                                        If (tmTzf.iRotNo(ilZone) >= tmCrf.iRotNo) And (ilTestAssg) Then
                                            'Zone copy must be Ok because of way rot # assigned
                                            ilAllZones = True
                                            ilSpotAsgn = True
                                            Exit Do
                                        End If
                                    End If
                                Next ilZone
                            Else
                                'For ilZone = 1 To 6 Step 1
                                For ilZone = 0 To 5 Step 1
                                    If tmTzf.sZone(ilZone) = tmCrf.sZone Then
                                        If (tmTzf.iRotNo(ilZone) >= tmCrf.iRotNo) And (ilTestAssg) Then
                                            'Zone copy Ok- All Zone must be OK because of way rot # assigned
                                            'The above statement isn't true if the user defines superseding zone
                                            'copy (same zone) before the first is assigned
                                            'ilAllZones = True
                                            ilSpotAsgn = True
                                            Exit For
                                        End If
                                    End If
                                Next ilZone
                            End If
                        End If
                    Else
                        If (slPtType = "1") Or (slPtType = "2") Then
                            If (ilRotNo >= tmCrf.iRotNo) And (ilTestAssg) Then
                                ilAllZones = True
                                ilSpotAsgn = True
                                Exit Do
                            End If
                        End If
                    End If
                    If Not ilSpotAsgn Then
                        'Assign copy, find next instruction to be assigned
                        tmCnfSrchKey.lCrfCode = tmCrf.lCode
                        If ilPFAsgn = 1 Then    'Final
                            tmCnfSrchKey.iInstrNo = tmCrf.iNextFinal
                        Else
                            tmCnfSrchKey.iInstrNo = tmCrf.iNextPrelim
                        End If
                        ilRet = btrGetEqual(hmCnf, tmCnf, imCnfRecLen, tmCnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If ilRet <> BTRV_ERR_NONE Then
                            tmCnfSrchKey.lCrfCode = tmCrf.lCode
                            tmCnfSrchKey.iInstrNo = 1
                            ilRet = btrGetEqual(hmCnf, tmCnf, imCnfRecLen, tmCnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        End If
                        If ilRet = BTRV_ERR_NONE Then
                            'One inventory per instruction
                            If tmCnf.lCifCode > 0 Then
                                tmCifSrchKey.lCode = tmCnf.lCifCode
                                ilRet = btrGetEqual(hmCif, tmCif, imCifRecLen, tmCifSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                            Else
                                'Not coded
                                ilRet = Not BTRV_ERR_NONE
                            End If
                            If ilRet = BTRV_ERR_NONE Then
                                ilRet = btrGetPosition(hmCrf, llCrfRecPos)
                                Do
                                    'tmRec = tmCrf
                                    'ilRet = gGetByKeyForUpdate("CRF", hmCrf, tmRec)
                                    'tmCrf = tmRec
                                    If ilPFAsgn = 1 Then    'Final
                                        tmCrf.iNextFinal = tmCnf.iInstrNo + 1
                                        tmCrf.iNextPrelim = tmCrf.iNextFinal
                                    Else
                                        tmCrf.iNextPrelim = tmCnf.iInstrNo + 1
                                    End If
                                    If (tmCrf.iEarliestDateAssg(0) = 0) And (tmCrf.iEarliestDateAssg(1) = 0) Then
                                        tmCrf.iEarliestDateAssg(0) = ilAsgnDate0
                                        tmCrf.iEarliestDateAssg(1) = ilAsgnDate1
                                        tmCrf.iLatestDateAssg(0) = ilAsgnDate0
                                        tmCrf.iLatestDateAssg(1) = ilAsgnDate1
                                    Else
                                        If (ilAsgnDate1 < tmCrf.iEarliestDateAssg(1)) Or ((ilAsgnDate1 = tmCrf.iEarliestDateAssg(1)) And (ilAsgnDate0 < tmCrf.iEarliestDateAssg(0))) Then
                                            tmCrf.iEarliestDateAssg(0) = ilAsgnDate0
                                            tmCrf.iEarliestDateAssg(1) = ilAsgnDate1
                                        End If
                                        If (ilAsgnDate1 > tmCrf.iLatestDateAssg(1)) Or ((ilAsgnDate1 = tmCrf.iLatestDateAssg(1)) And (ilAsgnDate0 > tmCrf.iLatestDateAssg(0))) Then
                                            tmCrf.iLatestDateAssg(0) = ilAsgnDate0
                                            tmCrf.iLatestDateAssg(1) = ilAsgnDate1
                                        End If
                                    End If
                                    tmCrf.iLastDateAssg(0) = ilAsgnDate0
                                    tmCrf.iLastDateAssg(1) = ilAsgnDate1
                                    gPackDate slNowDate, tmCrf.iDateAssgDone(0), tmCrf.iDateAssgDone(1)
                                    gPackTime slNowTime, tmCrf.iTimeAssgDone(0), tmCrf.iTimeAssgDone(1)
                                    ilRet = btrUpdate(hmCrf, tmCrf, imCrfRecLen)
                                    If ilRet = BTRV_ERR_CONFLICT Then
                                        'ilCRet = btrGetDirect(hmCrf, tmCrf, imCrfRecLen, llCrfRecPos, INDEXKEY1, BTRV_LOCK_NONE)
                                        tmCrfSrchKey0.lCode = tmCrf.lCode
                                        ilCRet = btrGetEqual(hmCrf, tmCrf, imCrfRecLen, tmCrfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                    End If
                                Loop While ilRet = BTRV_ERR_CONFLICT
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    Print #hmMsg, "mAssignCopyToSpot: btrUpdate-Point 1, Crf Error # " & Trim$(str$(ilRet))
                                End If
                                If ilPFAsgn = 1 Then    'Final
                                    ilRet = btrGetPosition(hmCif, llCifRecPos)
                                    Do
                                        'tmRec = tmCif
                                        'ilRet = gGetByKeyForUpdate("CIF", hmCif, tmRec)
                                        'tmCif = tmRec
                                        If (tmCif.iUsedDate(0) = 0) And (tmCif.iUsedDate(1) = 0) Then
                                            tmCif.iUsedDate(0) = ilAsgnDate0
                                            tmCif.iUsedDate(1) = ilAsgnDate1
                                        Else
                                            gUnpackDate tmCif.iUsedDate(0), tmCif.iUsedDate(1), slDate
                                            If llDate > gDateValue(slDate) Then
                                                tmCif.iUsedDate(0) = ilAsgnDate0
                                                tmCif.iUsedDate(1) = ilAsgnDate1
                                            'Else
                                            '    Exit Do 'Don't update date
                                            End If
                                        End If
                                        tmCif.iNoTimesAir = tmCif.iNoTimesAir + 1
                                        'DL:7/1/03, Wrap value around to avoid overflow error
                                        If tmCif.iNoTimesAir > 32000 Then
                                            tmCif.iNoTimesAir = 0
                                        End If
                                        ilRet = btrUpdate(hmCif, tmCif, imCifRecLen)
                                        If ilRet = BTRV_ERR_CONFLICT Then
                                            'ilCRet = btrGetDirect(hmCif, tmCif, imCifRecLen, llCifRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                            tmCifSrchKey.lCode = tmCif.lCode
                                            ilCRet = btrGetEqual(hmCif, tmCif, imCifRecLen, tmCifSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                        End If
                                    Loop While ilRet = BTRV_ERR_CONFLICT
                                    If ilRet <> BTRV_ERR_NONE Then
                                        If ilRet >= 30000 Then
                                            ilRet = csiHandleValue(0, 7)
                                        End If
                                        Print #hmMsg, "mAssignCopyToSpot: btrUpdate-Point 2, Cif Error # " & Trim$(str$(ilRet))
                                    End If
                                End If
                                'slPtType = tlSdf.sPtType
                                If slPtType = "3" Then 'Time zone copy- determine if supersede or add to tzf
                                    If Trim$(tmCrf.sZone) = "" Then 'All zone copy- test if add or superseded
                                        'Determine if all previous Zone and Other copy superseded
                                        ilFound = False
                                        'For ilZone = 1 To 6 Step 1
                                        For ilZone = 0 To 5 Step 1
                                            If (tmTzf.lCifZone(ilZone) <> 0) And (tmCrf.iRotNo > tmTzf.iRotNo(ilZone)) Then
                                                tmTzf.sZone(ilZone) = ""
                                                tmTzf.lCifZone(ilZone) = 0
                                                tmTzf.iRotNo(ilZone) = 0
                                            ElseIf tmTzf.lCifZone(ilZone) <> 0 Then
                                                ilFound = True  'Instruction not superseded
                                            End If
                                        Next ilZone
                                        If ilFound Then
                                            'Insert into first hold
                                            'For ilZone = 1 To 6 Step 1
                                            For ilZone = 0 To 5 Step 1
                                                If tmTzf.lCifZone(ilZone) = 0 Then
                                                    ilRet = btrGetPosition(hmTzf, llTzfRecPos)
                                                    Do
                                                        'tmRec = tmTzf
                                                        'ilRet = gGetByKeyForUpdate("TZF", hmTzf, tmRec)
                                                        'tmTzf = tmRec
                                                        If tmCnf.lCifCode > 0 Then
                                                            tmTzf.lCifZone(ilZone) = tmCnf.lCifCode
                                                        ElseIf tmCnf.lCifCode < 0 Then
                                                            tmTzf.lCifZone(ilZone) = -tmCnf.lCifCode
                                                        End If
                                                        If ilPFAsgn = 1 Then    'Final
                                                            tmTzf.iRotNo(ilZone) = tmCrf.iRotNo
                                                        Else
                                                            tmTzf.iRotNo(ilZone) = 0
                                                        End If
                                                        tmTzf.sZone(ilZone) = "Oth"
                                                        ilRet = btrUpdate(hmTzf, tmTzf, imTzfRecLen)
                                                        If ilRet = BTRV_ERR_CONFLICT Then
                                                            'ilCRet = btrGetDirect(hmTzf, tmTzf, imTzfRecLen, llTzfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                            tmTzfSrchKey.lCode = tmTzf.lCode
                                                            ilCRet = btrGetEqual(hmTzf, tmTzf, imTzfRecLen, tmTzfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                        End If
                                                    Loop While ilRet = BTRV_ERR_CONFLICT
                                                    If ilRet <> BTRV_ERR_NONE Then
                                                        If ilRet >= 30000 Then
                                                            ilRet = csiHandleValue(0, 7)
                                                        End If
                                                        Print #hmMsg, "mAssignCopyToSpot: btrUpdate-Point 3, Tzf Error # " & Trim$(str$(ilRet))
                                                    End If
                                                    Exit For
                                                End If
                                            Next ilZone
                                        Else
                                            'Remove Tzf
                                            ilRet = btrGetPosition(hmTzf, llTzfRecPos)
                                            Do
                                                'tmRec = tmTzf
                                                'ilRet = gGetByKeyForUpdate("TZF", hmTzf, tmRec)
                                                'tmTzf = tmRec
                                                ilRet = btrDelete(hmTzf)
                                                If ilRet = BTRV_ERR_CONFLICT Then
                                                    'ilCRet = btrGetDirect(hmTzf, tmTzf, imTzfRecLen, llTzfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                    tmTzfSrchKey.lCode = tmTzf.lCode
                                                    ilCRet = btrGetEqual(hmTzf, tmTzf, imTzfRecLen, tmTzfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                End If
                                            Loop While ilRet = BTRV_ERR_CONFLICT
                                            If ilRet <> BTRV_ERR_NONE Then
                                                If ilRet >= 30000 Then
                                                    ilRet = csiHandleValue(0, 7)
                                                End If
                                                Print #hmMsg, "mAssignCopyToSpot: btrDelete-Point 1, Tzf Error # " & Trim$(str$(ilRet))
                                            End If
                                            slPtType = ""
                                        End If
                                    Else
                                        ilFound = False
                                        'For ilZone = 1 To 6 Step 1
                                        For ilZone = 0 To 5 Step 1
                                            If tmCrf.sZone = tmTzf.sZone(ilZone) Then
                                                'Replace zone
                                                ilRet = btrGetPosition(hmTzf, llTzfRecPos)
                                                Do
                                                    'tmRec = tmTzf
                                                    'ilRet = gGetByKeyForUpdate("TZF", hmTzf, tmRec)
                                                    'tmTzf = tmRec
                                                    If tmCnf.lCifCode > 0 Then
                                                        tmTzf.lCifZone(ilZone) = tmCnf.lCifCode
                                                    ElseIf tmCnf.lCifCode < 0 Then
                                                        tmTzf.lCifZone(ilZone) = -tmCnf.lCifCode
                                                    End If
                                                    If ilPFAsgn = 1 Then    'Final
                                                        tmTzf.iRotNo(ilZone) = tmCrf.iRotNo
                                                    Else
                                                        tmTzf.iRotNo(ilZone) = 0
                                                    End If
                                                    ilRet = btrUpdate(hmTzf, tmTzf, imTzfRecLen)
                                                    If ilRet = BTRV_ERR_CONFLICT Then
                                                        'ilCRet = btrGetDirect(hmTzf, tmTzf, imTzfRecLen, llTzfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                        tmTzfSrchKey.lCode = tmTzf.lCode
                                                        ilCRet = btrGetEqual(hmTzf, tmTzf, imTzfRecLen, tmTzfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                    End If
                                                Loop While ilRet = BTRV_ERR_CONFLICT
                                                If ilRet <> BTRV_ERR_NONE Then
                                                    If ilRet >= 30000 Then
                                                        ilRet = csiHandleValue(0, 7)
                                                    End If
                                                    Print #hmMsg, "mAssignCopyToSpot: btrUpdate-Point 4, Tzf Error # " & Trim$(str$(ilRet))
                                                End If
                                                ilFound = True
                                                Exit For
                                            End If
                                        Next ilZone
                                        'Add copy to tzf
                                        If Not ilFound Then
                                            'For ilZone = 1 To 6 Step 1
                                            For ilZone = 0 To 5 Step 1
                                                If tmTzf.lCifZone(ilZone) = 0 Then
                                                    ilRet = btrGetPosition(hmTzf, llTzfRecPos)
                                                    Do
                                                        'tmRec = tmTzf
                                                        'ilRet = gGetByKeyForUpdate("TZF", hmTzf, tmRec)
                                                        'tmTzf = tmRec
                                                        If tmCnf.lCifCode > 0 Then
                                                            tmTzf.lCifZone(ilZone) = tmCnf.lCifCode
                                                        ElseIf tmCnf.lCifCode < 0 Then
                                                            tmTzf.lCifZone(ilZone) = -tmCnf.lCifCode
                                                        End If
                                                        If ilPFAsgn = 1 Then    'Final
                                                            tmTzf.iRotNo(ilZone) = tmCrf.iRotNo
                                                        Else
                                                            tmTzf.iRotNo(ilZone) = 0
                                                        End If
                                                        tmTzf.sZone(ilZone) = tmCrf.sZone
                                                        ilRet = btrUpdate(hmTzf, tmTzf, imTzfRecLen)
                                                        If ilRet = BTRV_ERR_CONFLICT Then
                                                            'ilCRet = btrGetDirect(hmTzf, tmTzf, imTzfRecLen, llTzfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                            tmTzfSrchKey.lCode = tmTzf.lCode
                                                            ilCRet = btrGetEqual(hmTzf, tmTzf, imTzfRecLen, tmTzfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                        End If
                                                    Loop While ilRet = BTRV_ERR_CONFLICT
                                                    If ilRet <> BTRV_ERR_NONE Then
                                                        If ilRet >= 30000 Then
                                                            ilRet = csiHandleValue(0, 7)
                                                        End If
                                                        Print #hmMsg, "mAssignCopyToSpot: btrUpdate-Tzf Point 5, Error # " & Trim$(str$(ilRet))
                                                    End If
                                                    Exit For
                                                End If
                                            Next ilZone
                                        End If
                                    End If
                                Else
                                    If Trim$(tmCrf.sZone) <> "" Then    'Create time zone copy
                                        'For ilZone = 1 To 6 Step 1
                                        For ilZone = 0 To 5 Step 1
                                            tmTzf.lCifZone(ilZone) = 0
                                            tmTzf.iRotNo(ilZone) = 0
                                            tmTzf.sZone(ilZone) = ""
                                        Next ilZone
                                        If tmCnf.lCifCode > 0 Then
                                            'tmTzf.lCifZone(1) = tmCnf.lCifCode
                                            tmTzf.lCifZone(0) = tmCnf.lCifCode
                                        ElseIf tmCnf.lCifCode < 0 Then
                                            'tmTzf.lCifZone(1) = -tmCnf.lCifCode
                                            tmTzf.lCifZone(0) = -tmCnf.lCifCode
                                        End If
                                        If ilPFAsgn = 1 Then    'Final
                                            'tmTzf.iRotNo(1) = tmCrf.iRotNo
                                            tmTzf.iRotNo(0) = tmCrf.iRotNo
                                        Else
                                            'tmTzf.iRotNo(1) = 0
                                            tmTzf.iRotNo(0) = 0
                                        End If
                                        'tmTzf.sZone(1) = tmCrf.sZone
                                        tmTzf.sZone(0) = tmCrf.sZone
                                        If (slPtType = "1") Or (slPtType = "2") Then
                                            'tmTzf.lCifZone(2) = llCopyCode
                                            tmTzf.lCifZone(1) = llCopyCode
                                            If ilPFAsgn = 1 Then    'Final
                                                'tmTzf.iRotNo(2) = ilRotNo
                                                tmTzf.iRotNo(1) = ilRotNo
                                            Else
                                                'tmTzf.iRotNo(2) = 0
                                                tmTzf.iRotNo(1) = 0
                                            End If
                                            'tmTzf.sZone(2) = "Oth"
                                            tmTzf.sZone(1) = "Oth"
                                        End If
                                        tmTzf.lCode = 0
                                        ilRet = btrInsert(hmTzf, tmTzf, imTzfRecLen, INDEXKEY0)
                                        If ilRet <> BTRV_ERR_NONE Then
                                            If ilRet >= 30000 Then
                                                ilRet = csiHandleValue(0, 7)
                                            End If
                                            Print #hmMsg, "mAssignCoptToSpot: btrInsert-Point 1, Tzf Error # " & Trim$(str$(ilRet))
                                        End If
                                    End If
                                End If
                                ilRet = btrGetPosition(hlSpot, llSdfRecPos)
                                Do
                                    If Trim$(tmCrf.sZone) = "" Then
                                        If slPtType <> "3" Then
                                            If ilPFAsgn = 1 Then    'Final
                                                ilRotNo = tmCrf.iRotNo
                                            Else
                                                ilRotNo = 0
                                            End If
                                            If tmCnf.lCifCode > 0 Then
                                                slPtType = "1"
                                                llCopyCode = tmCnf.lCifCode
                                            ElseIf tmCnf.lCifCode < 0 Then
                                                slPtType = "2"
                                                llCopyCode = -tmCnf.lCifCode
                                            End If
                                        Else
                                            slPtType = "3"
                                            llCopyCode = tmTzf.lCode
                                        End If
                                    Else
                                        slPtType = "3"
                                        llCopyCode = tmTzf.lCode
                                    End If
                                    If ilType = 1 Then
                                        'tmRec = tlSmf
                                        'ilRet = gGetByKeyForUpdate("SMF", hlSpot, tmRec)
                                        'tlSmf = tmRec
                                        tlSmf.sPtType = slPtType
                                        tlSmf.lCopyCode = llCopyCode
                                        tlSmf.iRotNo = ilRotNo
                                        ilRet = btrUpdate(hlSpot, tlSmf, imSmfRecLen)
                                        If ilRet = BTRV_ERR_CONFLICT Then
                                            'ilCRet = btrGetDirect(hlSpot, tlSmf, imSmfRecLen, llSdfRecPos, INDEXKEY1, BTRV_LOCK_NONE)
                                            tmSmfSrchKey1.lCode = tlSmf.lCode
                                            ilCRet = btrGetEqual(hlSpot, tlSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                        End If
                                    Else
                                        'tmRec = tlSdf
                                        'ilRet = gGetByKeyForUpdate("SDF", hlSpot, tmRec)
                                        'tlSdf = tmRec
                                        tlSdf.sPtType = slPtType
                                        tlSdf.lCopyCode = llCopyCode
                                        tlSdf.iRotNo = ilRotNo
                                        ilRet = btrUpdate(hlSpot, tlSdf, imSdfRecLen)
                                        If ilRet = BTRV_ERR_CONFLICT Then
                                            'ilCRet = btrGetDirect(hlSpot, tlSdf, imSdfRecLen, llSdfRecPos, INDEXKEY1, BTRV_LOCK_NONE)
                                            tmSdfSrchKey3.lCode = tlSdf.lCode
                                            ilCRet = btrGetEqual(hlSpot, tlSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                            If (tlSdf.sSchStatus <> "S") And (tlSdf.sSchStatus <> "G") And (tlSdf.sSchStatus <> "O") Then
                                                ilAllZones = True
                                                Exit Do
                                            End If
                                        End If
                                    End If
                                Loop While ilRet = BTRV_ERR_CONFLICT
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    If ilType = 1 Then
                                        Print #hmMsg, "mAssignCopyToSpot: btrUpdate-Point 6, Smf Error # " & Trim$(str$(ilRet))
                                    Else
                                        Print #hmMsg, "mAssignCopyToSpot: btrUpdate-Point 6, Sdf Error # " & Trim$(str$(ilRet))
                                    End If
                                End If
                                ilSpotAsgn = True
                                If Trim$(tmCrf.sZone) = "" Then
                                    ilAllZones = True
                                End If
                            End If
                        End If
                    End If
                Else
                    '6/6/16: Replaced GoSub
                    'GoSub TestAssg
                    mTestAssg slPtType, llCopyCode, ilRotNo, ilTestAssg
                End If
            Else
                '6/6/16: Replaced GoSub
                'GoSub TestAssg
                mTestAssg slPtType, llCopyCode, ilRotNo, ilTestAssg
            End If
        Else
            '6/6/16: Replaced GoSub
            'GoSub TestAssg
            mTestAssg slPtType, llCopyCode, ilRotNo, ilTestAssg
        End If
        If ilAllZones Then
            Exit Do
        End If
        ilRet = btrGetNext(hmCrf, tmCrf, imCrfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    Exit Sub
'TestAssg:
'    If slPtType = "3" Then 'Time zone
'        tmTzfSrchKey.lCode = llCopyCode
'        ilRet = btrGetEqual(hmTzf, tmTzf, imTzfRecLen, tmTzfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'        If ilRet = BTRV_ERR_NONE Then
'            If Trim$(tmCrf.sZone) = "" Then 'All zones (note zone copy superseded by all zones will be check when assigning)
'                For ilZone = 1 To 6 Step 1
'                    If ((Trim$(tmTzf.sZone(ilZone)) = "") Or (StrComp(tmTzf.sZone(ilZone), "Oth", 1) = 0)) And (tmTzf.lCifZone(ilZone) <> 0) Then
'                        If tmTzf.iRotNo(ilZone) = tmCrf.iRotNo Then
'                            'Zone copy must be Ok because of way rot # assigned
'                            ilTestAssg = False
'                            Exit For
'                        End If
'                    End If
'                Next ilZone
'            Else
'                For ilZone = 1 To 6 Step 1
'                    If tmTzf.sZone(ilZone) = tmCrf.sZone Then
'                        If tmTzf.iRotNo(ilZone) = tmCrf.iRotNo Then
'                            ilTestAssg = False
'                            Exit For
'                        End If
'                    End If
'                Next ilZone
'            End If
'        End If
'    Else
'        If (slPtType = "1") Or (slPtType = "2") Then
'            If ilRotNo = tmCrf.iRotNo Then
'                ilTestAssg = False
'            End If
'        End If
'    End If
'    Return
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mRepInv_BuildKey                 *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Build sort key from Contract   *
'*                                                     *
'*******************************************************
Public Function mRepInv_BuildKey() As String
    Dim ilLoop As Integer
    Dim slKey As String
    Dim slStr As String

'    If tmChf.iAgfCode = 0 Then  'Obtain advertiser- direct bill
'        'For ilLoop = LBound(tgCommAdf) To UBound(tgCommAdf) - 1 Step 1
'        '    If tmChf.iAdfCode = tgCommAdf(ilLoop).iCode Then
'            ilLoop = gBinarySearchAdf(tmChf.iAdfCode)
'            If ilLoop <> -1 Then
'                If (tgCommAdf(ilLoop).sBillAgyDir = "D") And (Trim$(tgCommAdf(ilLoop).sAddrID) <> "") Then
'                    slName = Trim$(tgCommAdf(ilLoop).sName) & ", " & Trim$(tgCommAdf(ilLoop).sAddrID)
'                Else
'                    slName = Trim$(tgCommAdf(ilLoop).sName)
'                End If
'                tmMnfSrchKey.iCode = tgCommAdf(ilLoop).iMnfSort
'        '        Exit For
'            End If
'        'Next ilLoop
'    Else    'Obtain agency
'        'For ilLoop = LBound(tgCommAgf) To UBound(tgCommAgf) - 1 Step 1
'        '    If tmChf.iAgfCode = tgCommAgf(ilLoop).iCode Then
'            ilLoop = gBinarySearchAgf(tmChf.iAgfCode)
'            If ilLoop <> -1 Then
'                slName = Trim$(tgCommAgf(ilLoop).sName) & "/" & Trim$(tgCommAgf(ilLoop).sCityID)
'                tmMnfSrchKey.iCode = tgCommAgf(ilLoop).iMnfSort
'        '        Exit For
'            End If
'        'Next ilLoop
'        If tmMnfSrchKey.iCode <= 0 Then
'            'For ilLoop = LBound(tgCommAdf) To UBound(tgCommAdf) - 1 Step 1
'            '    If tmChf.iAdfCode = tgCommAdf(ilLoop).iCode Then
'                ilLoop = gBinarySearchAdf(tmChf.iAdfCode)
'                If ilLoop <> -1 Then
'                    tmMnfSrchKey.iCode = tgCommAdf(ilLoop).iMnfSort
'            '        Exit For
'                End If
'            'Next ilLoop
'        End If
'    End If
'
'    If tmMnfSrchKey.iCode > 0 Then
'        If tmMnf.iCode <> tmMnfSrchKey.iCode Then
'            ilRet = btrGetEqual(hmMnf, tmMnf, imMnfRecLen, tmMnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
'        Else
'            ilRet = BTRV_ERR_NONE
'        End If
'        If ilRet <> BTRV_ERR_NONE Then
'            tmMnf.iCode = 0
'            tmMnf.iGroupNo = 0
'            'Sort PSA and Promos to end of list
'            If (tmChf.sType = "S") Or (tmChf.sType = "M") Then
'                slSort = "99999"
'            Else
'                slSort = "99998"
'            End If
'        Else
'            If tmMnf.iGroupNo > 0 Then
'                slSort = Trim$(Str$(tmMnf.iGroupNo))
'                Do While Len(slSort) < 5
'                    slSort = "0" & slSort
'                Loop
'            Else
'                'Sort PSA and Promos to end of list
'                If (tmChf.sType = "S") Or (tmChf.sType = "M") Then
'                    slSort = "99999"
'                Else
'                    slSort = "99998"
'                End If
'            End If
'        End If
'    Else
'        'Sort PSA and Promos to end of list
'        If (tmChf.sType = "S") Or (tmChf.sType = "M") Then
'            slSort = "99999"
'        Else
'            slSort = "99998"
'        End If
'    End If
'    Do While Len(slName) < 46
'        slName = slName & " "
'    Loop
'    slKey = slSort & slName
    slKey = mCreateField1Key(tmChf)
    'Advertiser
    'For ilLoop = LBound(tgCommAdf) To UBound(tgCommAdf) - 1 Step 1
    '    If tmChf.iAdfCode = tgCommAdf(ilLoop).iCode Then
        ilLoop = gBinarySearchAdf(tmChf.iAdfCode)
        If ilLoop <> -1 Then
            'If (tgCommAdf(ilLoop).sBillAgyDir = "D") And (Trim$(tgCommAdf(ilLoop).sAddrID) <> "") Then
            '    slKey = slKey & Trim$(tgCommAdf(ilLoop).sName) & ", " & Trim$(tgCommAdf(ilLoop).sAddrID)
            'Else
                slKey = slKey & tgCommAdf(ilLoop).sName
            'End If
    '        Exit For
        End If
    'Next ilLoop
    'Contract number
    slStr = Trim$(str$(tmChf.lCntrNo))
    Do While Len(slStr) < 8
        slStr = "0" & slStr
    Loop
    slKey = slKey & slStr
    slKey = slKey & tmChf.sProduct
    mRepInv_BuildKey = slKey
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mClearIvr                       *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Initiate fields                 *
'*                                                     *
'*******************************************************
Private Sub mClearIvr(ilClearHd As Integer, ilClearLn As Integer, ilClearSp As Integer)
    Dim ilLoop As Integer
    If ilClearHd Then
        tmIvr.iType = IVRTYPE_NA
        For ilLoop = LBound(tmIvr.sTitle) To UBound(tmIvr.sTitle) Step 1
            tmIvr.sTitle(ilLoop) = ""
        Next ilLoop
        tmIvr.lChfCode = 0
        tmIvr.sTerms = ""
        tmIvr.iShowInvType = 0
        If (tgSpf.sBLaserForm = "2") Then
            If imInvGenType = 1 Then
                tmIvr.iFormType = 1
            Else
                If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                    tmIvr.iFormType = 0
                Else
                    tmIvr.iFormType = 1
                End If
            End If
        End If
        tmIvr.sCashTrade = ""
        tmIvr.iCTSplit = 0
        For ilLoop = LBound(tmIvr.sAddr) To UBound(tmIvr.sAddr) Step 1
            tmIvr.sAddr(ilLoop) = ""
        Next ilLoop
        For ilLoop = LBound(tmIvr.sPayAddr) To UBound(tmIvr.sPayAddr) Step 1
            tmIvr.sPayAddr(ilLoop) = ""
        Next ilLoop
        tmIvr.iMnfSort = 0
        For ilLoop = LBound(tmIvr.lComment) To UBound(tmIvr.lComment) Step 1
            tmIvr.lComment(ilLoop) = 0
        Next ilLoop
        tmIvr.sEDIComment = ""
        tmIvr.lOTotalSpots = 0
        tmIvr.lOTotalGross = 0
        tmIvr.lATotalSpots = 0
        tmIvr.lATotalGross = 0
        tmIvr.lRTotalGross = 0
        tmIvr.iPctComm = 0
    End If
    If ilClearLn Then
        tmIvr.iLineNo = 0
        tmIvr.iRdfCode = 0
        tmIvr.sOVehName = ""
        tmIvr.sODPName = ""
        tmIvr.iLen = 0
        tmIvr.sODays = ""
        tmIvr.iWkNo = 0
        tmIvr.lONoSpots = 0
        tmIvr.sORate = ""
    End If
    If ilClearSp Then
        tmIvr.sADayDate = ""
        tmIvr.sATime = ""
        tmIvr.sARate = ""
        For ilLoop = LBound(tmIvr.sACopy) To UBound(tmIvr.sACopy) Step 1
            tmIvr.sACopy(ilLoop) = ""
        Next ilLoop
        tmIvr.sAVehName = ""
        tmIvr.sRRemark = ""
        tmIvr.sRAmount = ""
        tmIvr.iPrgEnfCode = 0
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mClearPSF                       *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Remove unbilled                 *
'*                                                     *
'*******************************************************
Private Sub mClearPSF()
    Dim ilRet As Integer
    Dim ilUpper As Integer
    Dim ilExtLen As Integer
    Dim ilOffSet As Integer
    Dim llNoRec As Long
    Dim ilLoop As Integer
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
    ReDim lmPSFCode(0 To 0) As Long

    ilUpper = UBound(lmPSFCode)
    ilExtLen = Len(tmPsf)  'Extract operation record size
    llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlAdf) 'Obtain number of records
    btrExtClear hmPsf   'Clear any previous extend operation
    ilRet = btrGetFirst(hmPsf, tmPsf, imPsfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If ilRet = BTRV_ERR_END_OF_FILE Then
        Exit Sub
    Else
        If ilRet <> BTRV_ERR_NONE Then
            Exit Sub
        End If
    End If
    Call btrExtSetBounds(hmPsf, llNoRec, -1, "UC", "PSF", "") 'Set extract limits (all records)
    tlCharTypeBuff.sType = "Y"
    ilOffSet = gFieldOffset("Sdf", "SdfBill")
    ilRet = btrExtAddLogicConst(hmPsf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_LAST_TERM, tlCharTypeBuff, 1)
    If ilRet <> BTRV_ERR_NONE Then
        Exit Sub
    End If
    ilOffSet = 0
    ilRet = btrExtAddField(hmPsf, ilOffSet, ilExtLen)  'Extract First Name field
    If ilRet <> BTRV_ERR_NONE Then
        Exit Sub
    End If
    'ilRet = btrExtGetNextExt(hlAdf)    'Extract record
    ilUpper = UBound(lmPSFCode)
    ilRet = btrExtGetNext(hmPsf, tmPsf, ilExtLen, lmPSFCode(ilUpper))
    lmPSFCode(ilUpper) = tmPsf.lCode
    If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
        If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
            Exit Sub
        End If
        ilUpper = UBound(lmPSFCode)
        ilExtLen = Len(tmPsf)  'Extract operation record size
        'ilRet = btrExtGetFirst(hlAdf, tgCommAdf(ilUpperBound), ilExtLen, llRecPos)
        Do While ilRet = BTRV_ERR_REJECT_COUNT
            ilRet = btrExtGetNext(hmPsf, tmPsf, ilExtLen, lmPSFCode(ilUpper))
            lmPSFCode(ilUpper) = tmPsf.lCode
        Loop
        Do While ilRet = BTRV_ERR_NONE
            ilUpper = ilUpper + 1
            ReDim Preserve lmPSFCode(0 To ilUpper) As Long
            ilRet = btrExtGetNext(hmPsf, tmPsf, ilExtLen, lmPSFCode(ilUpper))
            lmPSFCode(ilUpper) = tmPsf.lCode
            Do While ilRet = BTRV_ERR_REJECT_COUNT
                ilRet = btrExtGetNext(hmPsf, tmPsf, ilExtLen, lmPSFCode(ilUpper))
                lmPSFCode(ilUpper) = tmPsf.lCode
            Loop
        Loop
    End If
    ''ilRet = btrBeginTrans(hmPsf, 1000)
    'If ilRet <> BTRV_ERR_NONE Then
    '    Screen.MousePointer = vbDefault
    '    ilRet = MsgBox("Clear Not Completed, Try Later", vbOkOnly + vbExclamation, "Invoice")
    '    Exit Sub
    'End If
    For ilLoop = 0 To UBound(lmPSFCode) - 1 Step 1
        Do
            'ilRet = btrGetDirect(hmPsf, tmPsf, imPsfRecLen, lmPSFCode(ilLoop), INDEXKEY0, BTRV_LOCK_NONE)
            tmSdfSrchKey3.lCode = lmPSFCode(ilLoop)
            ilRet = btrGetEqual(hmPsf, tmPsf, imPsfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                'ilRet = btrAbortTrans(hmRvf)
                Screen.MousePointer = vbDefault
                gSetMousePointer grdAirTime, grdRevenue, vbDefault
                ilRet = MsgBox("Clear Not Completed, Try Later", vbOKOnly + vbExclamation, "Invoice")
                Exit Sub
            End If
            If tmPsf.sBill <> "Y" Then
                'tmRec = tmPsf
                'ilRet = gGetByKeyForUpdate("PSF", hmPsf, tmRec)
                'tmPsf = tmRec
                'If ilRet <> BTRV_ERR_NONE Then
                '    'ilRet = btrAbortTrans(hmRvf)
                '    Screen.MousePointer = vbDefault
                '    ilRet = MsgBox("Clear Not Completed, Try Later", vbOkOnly + vbExclamation, "Invoice")
                '    Exit Sub
                'End If
                ilRet = btrDelete(hmPsf)
            End If
        Loop While ilRet = BTRV_ERR_CONFLICT
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            Print #hmMsg, "mClearPSF: btrDelete-Point 1, Psf Error # " & Trim$(str$(ilRet))
        End If
        If ilRet <> BTRV_ERR_NONE Then
            'ilRet = btrAbortTrans(hmRvf)
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            ilRet = MsgBox("Clear PSF Not Completed, Try Later", vbOKOnly + vbExclamation, "Invoice")
            Exit Sub
        End If
    Next ilLoop
    'ilRet = btrEndTrans(hmPsf)
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mComputeRndDateTime             *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Compute random Date and time   *
'*                                                     *
'*******************************************************
Private Sub mComputeRndDateTime(llStartDate As Long, llEndDate As Long, ilAllowedDays() As Integer, ilOrderedNoSpots As Integer, slDate As String, llTime As Long)
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  slLnStart                     slLnEnd                                                 *
'******************************************************************************************
'
'   Where:
'       llStartDate(I)- allowed Start Date
'       llEndDate(I)- allowed end date
'       ilAllowedDays(I)- Array of allowed days
'       slDate(O)- random date
'       llTime(O)- random time
'
'       tgMRdf(I)
'       tmClf(I)
'       imHour(I/O)
'       imDay(I/O)
'       imQH(I/O)
'
    Dim ilRdf As Integer
    Dim ilTBIndex As Integer
    Dim ilLoop As Integer
    Dim ilHrLowCt As Integer
    Dim ilDyLowCt As Integer
    Dim ilQHLowCt As Integer
    Dim ilHrIndex As Integer
    Dim ilDyIndex As Integer
    Dim ilQHIndex As Integer
    Dim ilHrFound As Integer
    Dim ilQHFound As Integer
    Dim ilTBTest As Integer
    Dim ilFound As Integer
    Dim ilDay As Integer
    Dim llSTime As Long
    Dim llETime As Long
    Dim llTBStartTime As Long
    Dim llTBEndTime As Long
    'ReDim ilSvQH(1 To 4) As Integer
    ReDim ilSvQH(0 To 4) As Integer
    Dim slStartTime As String
    Dim slEndTime As String
    Dim llTotalTime As Long
    Dim ilTotalsNoDays As Integer
    Dim llSepLength As Long
    Dim llDate As Long
    Dim ilSepLoop As Integer
    Dim ilIndex As Integer
    Dim ilHrLoop As Integer
    Dim ilDyLoop As Integer
    Dim ilQHLoop As Integer
    ReDim ilRndNo(0 To 14) As Integer
    'ReDim ilSvHour(1 To 24) As Integer
    'ReDim ilSvDay(1 To 7) As Integer
    'ReDim ilHourArray(1 To 24) As Integer
    'ReDim ilDayArray(1 To 7) As Integer
    'ReDim ilQHArray(1 To 4) As Integer
    'Index zero ignored
    ReDim ilSvHour(0 To 24) As Integer
    ReDim ilSvDay(0 To 7) As Integer
    ReDim ilHourArray(0 To 24) As Integer
    ReDim ilDayArray(0 To 7) As Integer
    ReDim ilQHArray(0 To 4) As Integer

    ilTBIndex = 1
    llTotalTime = 0
    If (tmClf.iStartTime(0) = 1) And (tmClf.iStartTime(1) = 0) Then
        'For ilRdf = LBound(tgMRdf) To UBound(tgMRdf) - 1 Step 1
        '    If tgMRdf(ilRdf).iCode = tmClf.iRdfcode Then
            ilRdf = gBinarySearchRdf(tmClf.iRdfCode)
            If ilRdf <> -1 Then
                tmRdf = tgMRdf(ilRdf)
                For ilLoop = LBound(tmRdf.iStartTime, 2) To UBound(tmRdf.iStartTime, 2) Step 1
                    If (tmRdf.iStartTime(0, ilLoop) <> 1) Or (tmRdf.iStartTime(1, ilLoop) <> 0) Then
                        '''If tmRdf.sWkDays(ilLoop, ilDay + 1) = "Y" Then
                        ''gUnpackTime tmRdf.iStartTime(0, ilLoop), tmRdf.iStartTime(1, ilLoop), "A", "1", slLnStart
                        ''gUnpackTime tmRdf.iEndTime(0, ilLoop), tmRdf.iEndTime(1, ilLoop), "A", "1", slLnEnd
                        ''lmTBStartTime(ilTBIndex) = CLng(gTimeToCurrency(slLnStart, False))
                        ''lmTBEndTime(ilTBIndex) = CLng(gTimeToCurrency(slLnEnd, True))
                        ''ilTBIndex = ilTBIndex + 1
                        gUnpackTimeLong tmRdf.iStartTime(0, ilLoop), tmRdf.iStartTime(1, ilLoop), False, llTBStartTime
                        gUnpackTimeLong tmRdf.iEndTime(0, ilLoop), tmRdf.iEndTime(1, ilLoop), True, llTBEndTime
                        If ilTBIndex <= UBound(lmTBStartTime) Then
                            If llTBStartTime < llTBEndTime Then
                                lmTBStartTime(ilTBIndex) = llTBStartTime
                                lmTBEndTime(ilTBIndex) = llTBEndTime
                                llTotalTime = llTotalTime + (llTBEndTime - llTBStartTime)
                                ilTBIndex = ilTBIndex + 1
                            Else
                                lmTBStartTime(ilTBIndex) = llTBStartTime
                                lmTBEndTime(ilTBIndex) = 86400
                                llTotalTime = llTotalTime + (86400 - llTBStartTime)
                                ilTBIndex = ilTBIndex + 1
                                If ilTBIndex <= UBound(lmTBStartTime) Then
                                    lmTBStartTime(ilTBIndex) = 0
                                    lmTBEndTime(ilTBIndex) = llTBEndTime
                                    llTotalTime = llTotalTime + (llTBEndTime - 0)
                                    ilTBIndex = ilTBIndex + 1
                                End If
                            End If
                        End If
                    End If
                Next ilLoop
        '        Exit For
            End If
        'Next ilRdf
        ilTBIndex = ilTBIndex - 1
    Else
        ''gUnpackTime tmClf.iStartTime(0), tmClf.iStartTime(1), "A", "1", slLnStart
        ''gUnpackTime tmClf.iEndTime(0), tmClf.iEndTime(1), "A", "1", slLnEnd
        ''lmTBStartTime(ilTBIndex) = CLng(gTimeToCurrency(slLnStart, False))
        ''lmTBEndTime(ilTBIndex) = CLng(gTimeToCurrency(slLnEnd, True))
        gUnpackTimeLong tmClf.iStartTime(0), tmClf.iStartTime(1), False, llTBStartTime
        gUnpackTimeLong tmClf.iEndTime(0), tmClf.iEndTime(1), True, llTBEndTime
        If llTBStartTime < llTBEndTime Then
            lmTBStartTime(ilTBIndex) = llTBStartTime
            lmTBEndTime(ilTBIndex) = llTBEndTime
            llTotalTime = llTotalTime + (llTBEndTime - llTBStartTime)
        Else
            lmTBStartTime(ilTBIndex) = llTBStartTime
            lmTBEndTime(ilTBIndex) = 86400
            llTotalTime = llTotalTime + (86400 - llTBStartTime)
            ilTBIndex = ilTBIndex + 1
            lmTBStartTime(ilTBIndex) = 0
            lmTBEndTime(ilTBIndex) = llTBEndTime
            llTotalTime = llTotalTime + (llTBEndTime - 0)
        End If
    End If

    ilTotalsNoDays = 0
    For ilLoop = 1 To 7 Step 1
        ilDay = gWeekDayLong(llStartDate + ilLoop - 1)
        If llStartDate + ilLoop - 1 <= llEndDate Then
            If ilAllowedDays(ilDay) Then
                ilTotalsNoDays = ilTotalsNoDays + 1
            End If
        End If
    Next ilLoop
    llSepLength = (llTotalTime * ilTotalsNoDays) / (ilOrderedNoSpots * 2)
    If llSepLength >= 3600& Then
        llSepLength = 3599
    ElseIf llSepLength < 300& Then
        llSepLength = 0
    Else
        llSepLength = llSepLength - 1
    End If

    For ilLoop = 1 To 24 Step 1
        ilSvHour(ilLoop) = imHour(ilLoop)
    Next ilLoop
    For ilLoop = 1 To 7 Step 1
        ilSvDay(ilLoop) = imDay(ilLoop)
    Next ilLoop
    For ilLoop = 1 To 4 Step 1
        ilSvQH(ilLoop) = imQH(ilLoop)
    Next ilLoop
    ilFound = False
    Do
        ilHrLowCt = -1
        'ReDim imHour(1 To 24) As Integer
        ReDim imHour(0 To 24) As Integer    'Index zero ignored
        For ilLoop = LBONE To 24 Step 1
            imHour(ilLoop) = ilSvHour(ilLoop)
        Next ilLoop
        For ilLoop = LBONE To 24 Step 1
            llTime = 3600 * CLng((ilLoop - 1))
            ilHrFound = False
            For ilTBTest = 1 To ilTBIndex Step 1
                If (llTime >= 3600 * (lmTBStartTime(ilTBTest) \ 3600)) And (llTime <= 3600 * ((lmTBEndTime(ilTBTest) - 1) \ 3600)) Then
                    ilHrFound = True
                    Exit For
                End If
            Next ilTBTest
            If Not ilHrFound Then
                imHour(ilLoop) = 30000
            End If
            'If ilHrLowCt = -1 Then
            '    ilHrLowCt = imHour(ilLoop)
            'ElseIf imHour(ilLoop) < ilHrLowCt Then
            '    ilHrLowCt = imHour(ilLoop)
            'End If
        Next ilLoop
        ilDyLowCt = -1
        'ReDim imDay(1 To 7) As Integer
        ReDim imDay(0 To 7) As Integer
        For ilLoop = LBONE To 7 Step 1
            imDay(ilLoop) = ilSvDay(ilLoop)
        Next ilLoop
        For ilLoop = LBONE To 7 Step 1
            ilDay = gWeekDayLong(llStartDate + ilLoop - 1)
            If llStartDate + ilLoop - 1 > llEndDate Then
                If imDay(ilDay + 1) < 30000 Then
                    imDay(ilDay + 1) = imDay(ilDay + 1) + 30000
                End If
            Else
                If Not ilAllowedDays(ilDay) Then
                    If imDay(ilDay + 1) < 30000 Then
                        imDay(ilDay + 1) = imDay(ilDay + 1) + 30000
                    End If
                End If
            End If
            'If ilDyLowCt = -1 Then
            '    ilDyLowCt = imDay(ilDay + 1)
            'ElseIf imDay(ilDay + 1) < ilDyLowCt Then
            '    ilDyLowCt = imDay(ilDay + 1)
            'End If
        Next ilLoop
        'Do
        '    ilHrIndex = Int((24 - 1 + 1) * Rnd + 1)
        'Loop While imHour(ilHrIndex) <> ilHrLowCt
        'Do
        '    ilDyIndex = Int((7 - 1 + 1) * Rnd + 1)
        'Loop While imDay(ilDyIndex) <> ilDyLowCt
        For ilLoop = LBONE To 24 Step 1
            ilHourArray(ilLoop) = imHour(ilLoop)
        Next ilLoop
        For ilLoop = LBONE To 7 Step 1
            ilDayArray(ilLoop) = imDay(ilLoop)
        Next ilLoop
        mSortArray ilHourArray(), imHour()
        mSortArray ilDayArray(), imDay()
        For ilHrLoop = LBONE To UBound(imHour) Step 1
            ilHrIndex = imHour(ilHrLoop)
            For ilDyLoop = LBONE To UBound(imDay) Step 1
                ilDyIndex = imDay(ilDyLoop)
                ilQHLowCt = -1
                'ReDim imQH(1 To 4) As Integer
                ReDim imQH(0 To 4) As Integer
                For ilLoop = LBONE To 4 Step 1
                    imQH(ilLoop) = ilSvQH(ilLoop)
                Next ilLoop
                For ilLoop = LBONE To 4 Step 1
                    ilQHFound = False
                    For ilTBTest = 1 To ilTBIndex Step 1
                        llTime = 3600 * CLng((ilHrIndex - 1))
                        If (llTime \ 3600 >= lmTBStartTime(ilTBTest) \ 3600) And (llTime < lmTBEndTime(ilTBTest)) Then
                            If (llTime < lmTBStartTime(ilTBTest)) Then
                                llSTime = lmTBStartTime(ilTBTest)
                            Else
                                llSTime = llTime
                            End If
                            If (llTime + 3600 > lmTBEndTime(ilTBTest)) Then
                                llETime = lmTBEndTime(ilTBTest)
                            Else
                                llETime = llTime + 3600
                            End If
                            If llSTime + 3600 <= llETime Then
                                ilQHFound = True
                                Exit For
                            End If
                            If llSTime < llETime Then
                                For llTime = llSTime To llETime - 1 Step 900
                                    If (llTime Mod 3600) \ 900 + 1 = ilLoop Then
                                        ilQHFound = True
                                        Exit For
                                    End If
                                Next llTime
                            Else
                                llTime = llSTime
                                If (llTime Mod 3600) \ 900 + 1 = ilLoop Then
                                    ilQHFound = True
                                    Exit For
                                End If
                            End If
                            If ilQHFound Then
                                Exit For
                            End If
                        End If
                    Next ilTBTest
                    If Not ilQHFound Then
                        imQH(ilLoop) = 30000
                    End If
                    'If ilQHFound Then
                    '    If ilQHLowCt = -1 Then
                    '        ilQHLowCt = imQH(ilLoop)
                    '    ElseIf imQH(ilLoop) < ilQHLowCt Then
                    '        ilQHLowCt = imQH(ilLoop)
                    '    End If
                    'End If
                Next ilLoop
                'Do
                '    ilQHIndex = Int((4 - 1 + 1) * Rnd + 1)
                'Loop While imQH(ilQHIndex) <> ilQHLowCt
                For ilLoop = LBONE To 4 Step 1
                    ilQHArray(ilLoop) = imQH(ilLoop)
                Next ilLoop
                mSortArray ilQHArray(), imQH()
                For ilQHLoop = LBONE To UBound(imQH) Step 1
                    ilQHIndex = imQH(ilQHLoop)
                    If lmTBStartTime(1) < lmTBEndTime(1) Then
                        llTime = 3600 * CLng((ilHrIndex - 1)) + 900 * CLng((ilQHIndex - 1))
                        llDate = gDateValue(Format$(llStartDate + ilDyIndex - 1 - gWeekDayLong(llStartDate), "m/d/yy"))
                        mGenXRndNos ilRndNo()
                        For ilTBTest = 1 To ilTBIndex Step 1
                            '10-2-01 Test for >= on quarter hours (900)
                            If ((llTime >= lmTBStartTime(ilTBTest)) And (llTime < lmTBEndTime(ilTBTest))) Or ((lmTBStartTime(ilTBTest) + 900 >= lmTBEndTime(ilTBTest)) And (llTime <= lmTBStartTime(ilTBTest)) And (llTime + 900 >= lmTBEndTime(ilTBTest))) Then
                                ilIndex = 0
                                Do
                                    'llTime = llTime + 60 * Int((14 - 0 + 1) * Rnd + 0)
                                    llTime = llTime + 60 * ilRndNo(ilIndex)
                                    '2/27/19: check if time is under 90 seconds and if so just usre the satrt time
                                    If lmTBStartTime(ilTBTest) + 900 >= lmTBEndTime(ilTBTest) Then
                                        llTime = lmTBStartTime(ilTBTest)
                                    End If
                                    If (llTime >= lmTBStartTime(ilTBTest)) And (llTime < lmTBEndTime(ilTBTest)) Then
                                        'Check separation time
                                        ilFound = True
                                        For ilSepLoop = 0 To UBound(tmPsfInfo) - 1 Step 1
                                            If tmPsfInfo(ilSepLoop).lDate = llDate Then
                                                If tmPsfInfo(ilSepLoop).lTime <= llTime Then
                                                    If llTime - tmPsfInfo(ilSepLoop).lTime < llSepLength Then
                                                        ilFound = False
                                                        Exit For
                                                    End If
                                                Else
                                                    If tmPsfInfo(ilSepLoop).lTime - llTime < llSepLength Then
                                                        ilFound = False
                                                        Exit For
                                                    End If
                                                End If
                                            End If
                                        Next ilSepLoop
                                        If ilFound = True Then
                                            Exit Do
                                        End If
                                    End If
                                    ilIndex = ilIndex + 1
                                    If ilIndex >= 15 Then
                                        Exit Do
                                    End If
                                    llTime = 3600 * CLng((ilHrIndex - 1)) + 900 * CLng((ilQHIndex - 1))
                                Loop Until ilFound
                                If ilFound Then
                                    Exit For
                                End If
                            End If
                        Next ilTBTest
                        If ilFound Then
                            Exit For
                        End If
                    Else
                        llTime = lmTBStartTime(1)
                    End If
                Next ilQHLoop
                If ilFound Then
                    Exit For
                End If
            Next ilDyLoop
            If ilFound Then
                Exit For
            End If
        Next ilHrLoop
        If ilFound Then
            Exit Do
        End If
    Loop Until ilFound
    'ReDim imHour(1 To 24) As Integer
    ReDim imHour(0 To 24) As Integer
    For ilLoop = LBONE To 24 Step 1
        imHour(ilLoop) = ilSvHour(ilLoop)
    Next ilLoop
    imHour(ilHrIndex) = imHour(ilHrIndex) + 1
    'ReDim imDay(1 To 7) As Integer
    ReDim imDay(0 To 7) As Integer
    For ilLoop = LBONE To 7 Step 1
        imDay(ilLoop) = ilSvDay(ilLoop)
    Next ilLoop
    imDay(ilDyIndex) = imDay(ilDyIndex) + 1
    'ReDim imQH(1 To 4) As Integer
    ReDim imQH(0 To 4) As Integer
    For ilLoop = LBONE To 4 Step 1
        imQH(ilLoop) = ilSvQH(ilLoop)
    Next ilLoop
    imQH(ilQHIndex) = imQH(ilQHIndex) + 1
    ilDay = gWeekDayLong(llStartDate)
    slDate = Format$(llStartDate + ilDyIndex - 1 - ilDay, "m/d/yy")

End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mCreateDateTimeForMissed        *
'*                                                     *
'*             Created:9/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Create date/Time and add copy  *
'*                      to missed spots if invoicing   *
'*                      by Order                       *
'*                                                     *
'*******************************************************
Private Function mCreateDateTimeForMissed(tlSdfExt As SDFEXT, llStdStartDate As Long, llStdEndDate As Long, llCalStartDate As Long, llCalEndDate As Long, llWkStartDate As Long, llWkEndDate As Long) As Integer
'
'   tlSdfExt(I/O)- Sdf Extent record
'
'   tmChf(I)
'
    Dim ilRet As Integer
    Dim llMissedDate As Long
    Dim llMissedTime As Long
    Dim llFlSDate As Long
    Dim llFlEDate As Long
    Dim llSDateRg As Long
    Dim llEDateRg As Long
    Dim llWkSDate As Long
    Dim llWkEDate As Long
    Dim llWkMoDate As Long
    Dim ilDay As Integer
    Dim ilValidDay As Integer
    Dim ilTBIndex As Integer
    Dim ilLoop As Integer
    Dim ilRdf As Integer
    Dim llDate As Long
    Dim slDate As String
    Dim llSmfRecPos As Long
    Dim llSmfCode As Long
    Dim llSdfRecPos As Long
    Dim llSdfCode As Long
    Dim llTBStartTime As Long
    Dim llTBEndTime As Long
    Dim ilMissedTimeSet As Integer
    Dim llGameLength As Long
    Dim slGameLength As String
    Dim slGameStartTime As String
    Dim slGameEndTime As String
    Dim ilGsfFound As Integer
    Dim ilCount As Integer
    '4/19/18: Invoicing by Order and using Avail Time: Verify MG date/time don't create a discrepancy when used as missed Date/time
    Dim llMGDate As Long
    Dim llMGTime As Long
    Dim blMGTimeOk As Boolean
    Dim llOrigMissedDate As Long

    mCreateDateTimeForMissed = True

    'We should add a flag to SMF that indicates if dates/times generated
    'this way prel and final will look the same and reprint will generate
    'if this is a new missed that we set bill on.
    'Removed this code for sorting to be correct on MG and Outside for reprinting
    'If (rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value) And (tgSpf.sBMissedDT <> "A") Then    'Reprint, determine pass numbers (1 for Cash, 2 for Trade)
    '    Exit Function
    'End If
    If (((tgSpf.sInvAirOrder = "O") And (tgSpf.sBLaserForm <> "2")) Or (tgSpf.sInvAirOrder = "S")) And ((tlSdfExt.sSchStatus = "M") Or (tlSdfExt.sSchStatus = "U") Or (tlSdfExt.sSchStatus = "R") Or (tlSdfExt.sSchStatus = "G") Or (tlSdfExt.sSchStatus = "O")) Then
        'Bill Bonus spots as Aired only
        If tlSdfExt.iStatus = 0 Then
            If tlSdfExt.sSpotType = "X" Then
                Exit Function
            End If
        ElseIf tlSdfExt.iStatus = 1 Then
            'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tlSdfExt.lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
            tmSmfSrchKey1.lCode = tlSdfExt.lCode
            ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            tmSdfSrchKey3.lCode = tmSmf.lSdfCode
            ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If tmSdf.sSpotType = "X" Then
                Exit Function
            End If
        End If
        'Test if previously created- if so bypass spot
        If mSdfExtExist(tlSdfExt) Then
            mCreateDateTimeForMissed = False
            Exit Function
        End If
        llMissedDate = 0
        llMissedTime = -1
        llSmfRecPos = 0
        llSmfCode = 0
        If tmChf.lCode <> tlSdfExt.lChfCode Then
            tmChfSrchKey.lCode = tlSdfExt.lChfCode
            ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
            If ilRet <> BTRV_ERR_NONE Then
                mCreateDateTimeForMissed = False
                Exit Function
            End If
        End If
        If tmChf.sBillCycle = "C" Then
            llSDateRg = llCalStartDate
            llEDateRg = llCalEndDate
        ElseIf tmChf.sBillCycle = "W" Then
            llSDateRg = llWkStartDate
            llEDateRg = llWkEndDate
        Else
            llSDateRg = llStdStartDate
            llEDateRg = llStdEndDate
        End If
        If (tlSdfExt.sBill <> "Y") Or (tgSpf.sBMissedDT = "A") Then
            If tlSdfExt.iStatus = 0 Then
                'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tlSdfExt.lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                tmSdfSrchKey3.lCode = tlSdfExt.lCode
                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            ElseIf tlSdfExt.iStatus = 1 Then
                'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tlSdfExt.lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                tmSmfSrchKey1.lCode = tlSdfExt.lCode
                ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            End If
            ilRet = btrGetPosition(hmSdf, llSdfRecPos)
            llSdfCode = tmSdf.lCode
            If (tmSdf.sSchStatus = "O") Or (tmSdf.sSchStatus = "G") Then
                'tmSmfSrchKey.lChfCode = tlSdfExt.lChfCode
                'tmSmfSrchKey.iLineNo = tlSdfExt.iLineNo
                'tmSmfSrchKey.iMissedDate(0) = 0 'ilDate0
                'tmSmfSrchKey.iMissedDate(1) = 0 'ilDate1
                'ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                tmSmfSrchKey2.lCode = tmSdf.lCode
                ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tlSdfExt.lChfCode) And (tmSmf.iLineNo = tlSdfExt.iLineNo)
                    If tmSdf.lCode = tmSmf.lSdfCode Then
                        ilRet = btrGetPosition(hmSmf, llSmfRecPos)
                        llSmfCode = tmSmf.lCode
                        'gUnpackDateLong tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), llMissedDate
                        gUnpackDateLongError tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), llMissedDate, "13:mCreateDateTimeForMissed " & tmSmf.lCode
                        gUnpackTimeLong tmSmf.iMissedTime(0), tmSmf.iMissedTime(1), False, llMissedTime
                        Exit Do
                    End If
                    ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                Loop
                'Test if MG Prior to invoice month- if so ignore spot
                If (llMissedDate < llSDateRg) Or (llMissedDate > llEDateRg) Then
                    mCreateDateTimeForMissed = False
                    Exit Function
                End If
            Else
                'gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llMissedDate
                gUnpackDateLongError tmSdf.iDate(0), tmSdf.iDate(1), llMissedDate, "10:mCreateDateTimeForMissed " & tmSdf.lCode
                gUnpackTimeLong tmSdf.iTime(0), tmSdf.iTime(1), False, llMissedTime
            End If
            '4/19/18:
            'If (tgSpf.sBMissedDT = "A") And ((tlSdfExt.sSchStatus = "O") Or (tlSdfExt.sSchStatus = "G")) Then
            '    'gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llMissedDate
            '    gUnpackDateLongError tmSdf.iDate(0), tmSdf.iDate(1), llMissedDate, "11:mCreateDateTimeForMissed " & tmSdf.lCode
            '    gUnpackTimeLong tmSdf.iTime(0), tmSdf.iTime(1), False, llMissedTime
            'Else
            If (tgSpf.sBMissedDT = "A") And ((tlSdfExt.sSchStatus = "O") Or (tlSdfExt.sSchStatus = "G")) Then
                'gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llMissedDate
                gUnpackDateLongError tmSdf.iDate(0), tmSdf.iDate(1), llMGDate, "11:mCreateDateTimeForMissed " & tmSdf.lCode
                gUnpackTimeLong tmSdf.iTime(0), tmSdf.iTime(1), False, llMGTime
                gUnpackDateLongError tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), llOrigMissedDate, "9:mCreateDateTimeForMissed " & tmSmf.lCode
            End If
            '4/19/18: end of change
                If (tmClf.lChfCode <> tlSdfExt.lChfCode) Or (tmClf.iLine <> tlSdfExt.iLineNo) Then
                    tmClfSrchKey.lChfCode = tlSdfExt.lChfCode
                    tmClfSrchKey.iLine = tlSdfExt.iLineNo
                    tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
                    tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
                    ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                End If
                If (tmClf.lChfCode = tlSdfExt.lChfCode) And (tmClf.iLine = tlSdfExt.iLineNo) Then
                    'Get flight and determine dates and allowed days
                    If tmSdf.iGameNo <= 0 Then
                        tmCffSrchKey.lChfCode = tmClf.lChfCode
                        tmCffSrchKey.iClfLine = tmClf.iLine
                        tmCffSrchKey.iCntRevNo = tmClf.iCntRevNo
                        tmCffSrchKey.iPropVer = tmClf.iPropVer
                        tmCffSrchKey.iStartDate(0) = 0
                        tmCffSrchKey.iStartDate(1) = 0
                        ilRet = btrGetGreaterOrEqual(hmCff, tmCff, imCffRecLen, tmCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    Else
                        tmCff.iPropVer = -1
                        tmCgfSrchKey1.lClfCode = tmClf.lCode
                        ilRet = btrGetEqual(hmCgf, tmCgf, imCgfRecLen, tmCgfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        Do While tmClf.lCode = tmCgf.lClfCode
                            If (tmSdf.sSchStatus = "O") Or (tmSdf.sSchStatus = "G") Then
                                If tmCgf.iGameNo = tmSmf.iGameNo Then
                                    gCgfToCff tmClf, tmCgf, tmCgfCff()
                                    tmCff = tmCgfCff(0) 'tmCgfCff(1)
                                    Exit Do
                                End If
                            Else
                                If tmCgf.iGameNo = tmSdf.iGameNo Then
                                    gCgfToCff tmClf, tmCgf, tmCgfCff()
                                    tmCff = tmCgfCff(0) 'tmCgfCff(1)
                                    Exit Do
                                End If
                            End If
                            ilRet = btrGetNext(hmCgf, tmCgf, imCgfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                            If ilRet <> BTRV_ERR_NONE Then
                                tmCff.sDelete = "Y"
                                Exit Do
                            End If
                        Loop
                    End If
                    Do While (ilRet = BTRV_ERR_NONE) And (tmCff.lChfCode = tmClf.lChfCode) And (tmCff.iClfLine = tmClf.iLine) And (tmCff.iCntRevNo = tmClf.iCntRevNo) And (tmCff.iPropVer = tmClf.iPropVer)
                        'Test dates
                        If tmCff.sDelete <> "Y" Then
                            'gUnpackDateLong tmCff.iStartDate(0), tmCff.iStartDate(1), llFlSDate
                            gUnpackDateLongError tmCff.iStartDate(0), tmCff.iStartDate(1), llFlSDate, "12:mCreateDateTimeForMissed-CFF "
                            'gUnpackDateLong tmCff.iEndDate(0), tmCff.iEndDate(1), llFlEDate
                            gUnpackDateLongError tmCff.iEndDate(0), tmCff.iEndDate(1), llFlEDate, "13:mCreateDateTimeForMissed-CFF "
                            If (llMissedDate >= llFlSDate) And (llMissedDate <= llFlEDate) Then
                                If tmCff.sDyWk <> "D" Then
                                    llWkSDate = llMissedDate
                                    Do While gWeekDayLong(llWkSDate) <> 0
                                        llWkSDate = llWkSDate - 1
                                    Loop
                                    llWkMoDate = llWkSDate
                                    llWkEDate = llMissedDate
                                    Do While gWeekDayLong(llWkEDate) <> 6
                                        llWkEDate = llWkEDate + 1
                                    Loop
                                    If llWkSDate < llSDateRg Then
                                        llWkSDate = llSDateRg
                                    End If
                                    If llWkEDate > llEDateRg Then
                                        llWkEDate = llEDateRg
                                    End If
                                    If llWkSDate < llFlSDate Then
                                        llWkSDate = llFlSDate
                                    End If
                                    If llWkEDate > llFlEDate Then
                                        llWkEDate = llFlEDate
                                    End If
                                    ilValidDay = False
                                    For llDate = llWkSDate To llWkEDate Step 1
                                        ilDay = gWeekDayLong(llDate)
                                        If (tmCff.iDay(ilDay) > 0) Or (tmCff.sXDay(ilDay) = "1") Then
                                            ilValidDay = True
                                            Exit For
                                        End If
                                    Next llDate
                                    If ilValidDay Then
                                        Do
                                            ilDay = Int((7) * Rnd)  '0 to 6
                                            If (ilDay + llWkMoDate >= llWkSDate) And (ilDay + llWkMoDate <= llWkEDate) And ((tmCff.iDay(ilDay) > 0) Or (tmCff.sXDay(ilDay) = "1")) Then
                                                llMissedDate = ilDay + llWkMoDate
                                                Exit Do
                                            End If
                                        Loop
                                    Else
                                        mCreateDateTimeForMissed = False
                                        Exit Function
                                    End If
                                End If
                                Exit Do
                            End If
                        End If
                        If tmSdf.iGameNo > 0 Then
                            Exit Do
                        End If
                        ilRet = btrGetNext(hmCff, tmCff, imCffRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                    Loop
                    'Pick Time
                    ilMissedTimeSet = False
                    ilTBIndex = 1
                    
                    '3-23-12 determine missed time for game based on time of event
                    If tmSdf.iGameNo <= 0 Then
                        If (tmClf.iStartTime(0) = 1) And (tmClf.iStartTime(1) = 0) Then
                            'For ilRdf = LBound(tgMRdf) To UBound(tgMRdf) - 1 Step 1
                            '    If tgMRdf(ilRdf).iCode = tmClf.iRdfcode Then
                                ilRdf = gBinarySearchRdf(tmClf.iRdfCode)
                                If ilRdf <> -1 Then
                                    tmRdf = tgMRdf(ilRdf)
                                    For ilLoop = LBound(tmRdf.iStartTime, 2) To UBound(tmRdf.iStartTime, 2) Step 1
                                        If (tmRdf.iStartTime(0, ilLoop) <> 1) Or (tmRdf.iStartTime(1, ilLoop) <> 0) Then
                                            '''If tmRdf.sWkDays(ilLoop, ilDay + 1) = "Y" Then
                                            ''gUnpackTimeLong tmRdf.iStartTime(0, ilLoop), tmRdf.iStartTime(1, ilLoop), False, lmTBStartTime(ilTBIndex)
                                            ''gUnpackTimeLong tmRdf.iEndTime(0, ilLoop), tmRdf.iEndTime(1, ilLoop), True, lmTBEndTime(ilTBIndex)
                                            ''ilTBIndex = ilTBIndex + 1
                                            gUnpackTimeLong tmRdf.iStartTime(0, ilLoop), tmRdf.iStartTime(1, ilLoop), False, llTBStartTime
                                            gUnpackTimeLong tmRdf.iEndTime(0, ilLoop), tmRdf.iEndTime(1, ilLoop), True, llTBEndTime
                                            If ilTBIndex <= UBound(lmTBStartTime) Then
                                                If llTBStartTime < llTBEndTime Then
                                                    lmTBStartTime(ilTBIndex) = llTBStartTime
                                                    lmTBEndTime(ilTBIndex) = llTBEndTime
                                                    ilTBIndex = ilTBIndex + 1
                                                Else
                                                    lmTBStartTime(ilTBIndex) = llTBStartTime
                                                    lmTBEndTime(ilTBIndex) = 86400
                                                    ilTBIndex = ilTBIndex + 1
                                                    If ilTBIndex <= UBound(lmTBStartTime) Then
                                                        lmTBStartTime(ilTBIndex) = 0
                                                        lmTBEndTime(ilTBIndex) = llTBEndTime
                                                        ilTBIndex = ilTBIndex + 1
                                                    End If
                                                End If
                                            End If
                                        End If
                                    Next ilLoop
                                    ilTBIndex = ilTBIndex - 1
                            '        Exit For
                                End If
                            'Next ilRdf
                        Else
                            ''gUnpackTimeLong tmClf.iStartTime(0), tmClf.iStartTime(1), False, lmTBStartTime(ilTBIndex)
                            ''gUnpackTimeLong tmClf.iEndTime(0), tmClf.iEndTime(1), True, lmTBEndTime(ilTBIndex)
                            gUnpackTimeLong tmClf.iStartTime(0), tmClf.iStartTime(1), False, llTBStartTime
                            gUnpackTimeLong tmClf.iEndTime(0), tmClf.iEndTime(1), True, llTBEndTime
                            If llTBStartTime < llTBEndTime Then
                                lmTBStartTime(ilTBIndex) = llTBStartTime
                                lmTBEndTime(ilTBIndex) = llTBEndTime
                                If llTBStartTime = llTBEndTime Then
                                    ilMissedTimeSet = True
                                    llMissedTime = llTBStartTime
                                End If
                            Else
                                lmTBStartTime(ilTBIndex) = llTBStartTime
                                lmTBEndTime(ilTBIndex) = 86400
                                ilTBIndex = ilTBIndex + 1
                                lmTBStartTime(ilTBIndex) = 0
                                lmTBEndTime(ilTBIndex) = llTBEndTime
                            End If
                        End If
                    Else                '3-23-12 sports event
                        ilGsfFound = False
                        tmGsfSrchKey3.iVefCode = tmSdf.iVefCode
                        tmGsfSrchKey3.iGameNo = tmSdf.iGameNo
                        ilRet = btrGetEqual(hmGsf, tmGsf, imGsfRecLen, tmGsfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
                        Do While (ilRet = BTRV_ERR_NONE) And (tmGsf.iVefCode = tmSdf.iVefCode) And (tmGsf.iGameNo = tmSdf.iGameNo)
                            If (tmGsf.iAirDate(0) = tmSdf.iDate(0)) And (tmGsf.iAirDate(1) = tmSdf.iDate(1)) Then
                                ilGsfFound = True
                                Exit Do
                            End If
                            ilRet = btrGetNext(hmGsf, tmGsf, imGsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
                        Loop
                        If (ilRet <> BTRV_ERR_NONE) Or (Not ilGsfFound) Then
                            'no schedule exists
                            'default to 12m-12m
                            llTBStartTime = 0
                            llTBEndTime = 86400
                        Else
                            tmLvfSrchKey0.lCode = tmGsf.lLvfCode
                            ilRet = btrGetEqual(hmLvf, tmLvf, imLvfRecLen, tmLvfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get current record
                            If ilRet <> BTRV_ERR_NONE Then
                                'no library
                                'default to 12m-12m
                                llTBStartTime = 0
                                llTBEndTime = 86400
                            Else
                                gUnpackTimeLong tmGsf.iAirTime(0), tmGsf.iAirTime(1), False, llTBStartTime        'convert start time of game to long for compares
                                
                                slGameStartTime = gFormatTimeLong(llTBStartTime, "A", "1")                      'convert game start time to string
                                gUnpackLength tmLvf.iLen(0), tmLvf.iLen(1), "3", False, slGameLength            'get game length
                                gAddTimeLength slGameStartTime, slGameLength, "A", "1", slGameEndTime, "Y"      'Compute game end time
                                llTBEndTime = gTimeToLong(slGameEndTime, True)                                  'compare game end time for compares
        
                                If llTBStartTime < llTBEndTime Then                                             'has game cross midnight?
                                    lmTBStartTime(ilTBIndex) = llTBStartTime
                                    lmTBEndTime(ilTBIndex) = llTBEndTime
                                    If llTBStartTime = llTBEndTime Then
                                        ilMissedTimeSet = True
                                        llMissedTime = llTBStartTime
                                    End If
                                Else                                                                        'game cross midnight, create 2 entries
                                    lmTBStartTime(ilTBIndex) = llTBStartTime
                                    lmTBEndTime(ilTBIndex) = 86400
                                    ilTBIndex = ilTBIndex + 1
                                    lmTBStartTime(ilTBIndex) = 0
                                    lmTBEndTime(ilTBIndex) = llTBEndTime
                                End If
                            End If
                        End If
                    End If
                    
                    'If lmTBStartTime(1) < lmTBEndTime(1) Then
                    If Not ilMissedTimeSet Then
                        ilCount = 0
                        Do
                            '7/1814: If time is less then one hour, use start time
                            'llMissedTime = 60 * CLng(Int(1440 * Rnd))  '0-1439
                            'For ilLoop = 1 To ilTBIndex Step 1
                            '    If (llMissedTime >= lmTBStartTime(ilLoop)) And (llMissedTime < lmTBEndTime(ilLoop)) Then
                            '        Exit Do
                            '    End If
                            'Next ilLoop
                            If ((ilTBIndex = 1) And (lmTBEndTime(1) - lmTBStartTime(1) < 3600)) Or (ilCount >= 100) Then
                                llMissedTime = lmTBStartTime(1)
                                Exit Do
                            Else
                                llMissedTime = 60 * CLng(Int(1440 * Rnd))  '0-1439
                                ilCount = ilCount + 1
                                For ilLoop = 1 To ilTBIndex Step 1
                                    If (llMissedTime >= lmTBStartTime(ilLoop)) And (llMissedTime < lmTBEndTime(ilLoop)) Then
                                        Exit Do
                                    End If
                                Next ilLoop
                            End If
                        Loop
                    End If
                    'Else
                    '    llMissedTime = lmTBStartTime(1)
                    'End If
                End If
            '4/19/19:
            'End If
            If (tlSdfExt.sSchStatus = "O") Or (tlSdfExt.sSchStatus = "G") Then
                Do
                    'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, llSmfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSmfSrchKey1.lCode = llSmfCode
                    ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    'tmRec = tmSmf
                    'ilRet = gGetByKeyForUpdate("SMF", hmSmf, tmRec)
                    'tmSmf = tmRec
                    '4/19/18: Determine if MG date/time is valid to be used
                    If (tgSpf.sBMissedDT = "A") Then
                        If (tlSdfExt.sBill <> "Y") Then
                            'MG date within same week?
                            If gObtainPrevMondayLong(llMGDate) = gObtainPrevMondayLong(llMissedDate) Then
                                If tmCff.sDelete <> "Y" Then
                                    If tmCff.sDyWk <> "D" Then
                                        ilDay = gWeekDayLong(llMGDate)
                                        If (tmCff.iDay(ilDay) > 0) Or (tmCff.sXDay(ilDay) = "1") Then
                                            llMissedDate = llMGDate
                                        End If
                                    Else
                                        If gWeekDayLong(llMGDate) = gWeekDayLong(llMissedDate) Then
                                            llMissedDate = llMGDate
                                        End If
                                    End If
                                Else
                                    llMissedDate = llMGDate
                                End If
                            End If
                            blMGTimeOk = False
                            For ilLoop = 1 To ilTBIndex Step 1
                                If (llMGTime >= lmTBStartTime(ilLoop)) And (llMGTime < lmTBEndTime(ilLoop)) Then
                                    blMGTimeOk = True
                                    Exit For
                                End If
                            Next ilLoop
                            If blMGTimeOk Then
                                llMissedTime = llMGTime
                            End If
                            mClosestAvailTime llMissedDate, llMissedTime, ilTBIndex, llOrigMissedDate
                            slDate = Format$(llMissedDate, "m/d/yy")
                            gPackDate slDate, tmSmf.iMissedDate(0), tmSmf.iMissedDate(1)
                            gPackTimeLong llMissedTime, tmSmf.iMissedTime(0), tmSmf.iMissedTime(1)
                        Else
                            gUnpackDateLongError tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), llMissedDate, "12:mCreateDateTimeForMissed " & tmSmf.lCode
                            gUnpackTimeLong tmSmf.iMissedTime(0), tmSmf.iMissedTime(1), False, llMissedTime
                        End If
                    Else
                        'Random date/time
                        slDate = Format$(llMissedDate, "m/d/yy")
                        gPackDate slDate, tmSmf.iMissedDate(0), tmSmf.iMissedDate(1)
                        gPackTimeLong llMissedTime, tmSmf.iMissedTime(0), tmSmf.iMissedTime(1)
                    End If
                    
                    'slDate = Format$(llMissedDate, "m/d/yy")
                    'gPackDate slDate, tmSmf.iMissedDate(0), tmSmf.iMissedDate(1)
                    'gPackTimeLong llMissedTime, tmSmf.iMissedTime(0), tmSmf.iMissedTime(1)
                    '4/19/18: end  change
                    If tgSpf.sBMissedDT = "A" Then
                        tmSmf.sPtType = tmSdf.sPtType
                        tmSmf.lCopyCode = tmSdf.lCopyCode
                        tmSmf.iRotNo = tmSdf.iRotNo
                    End If
                    ilRet = btrUpdate(hmSmf, tmSmf, imSmfRecLen)
                Loop While ilRet = BTRV_ERR_CONFLICT
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    Print #hmMsg, "mCreateDateTimeForMissed: btrUpdate-Point 1, Smf Error # " & Trim$(str$(ilRet))
                End If
                'Assign Copy
                If tgSpf.sBMissedDT <> "A" Then
                    mAssignCopyToSpot 1, hmSmf, tmSdf, tmSmf
                End If
                tlSdfExt.iVefCode = tmSmf.iOrigSchVef   'Change vehicle to original vehicle
            Else
                'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, llSdfRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                tmSdfSrchKey3.lCode = llSdfCode
                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                'tmRec = tmSdf
                'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmRec)
                'tmSdf = tmRec
                slDate = Format$(llMissedDate, "m/d/yy")
                gPackDate slDate, tmSdf.iDate(0), tmSdf.iDate(1)
                gPackTimeLong llMissedTime, tmSdf.iTime(0), tmSdf.iTime(1)
                'Ignore conflicts- as someone must be moving the spot
                If tmSdf.sSchStatus = "M" Then
                    tmSdf.sXCrossMidnight = "N"
                End If
                ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    Print #hmMsg, "mCreateDateTimeForMissed: btrUpdate-Point 2, Sdf Error # " & Trim$(str$(ilRet))
                End If
                'Assign Copy
                mAssignCopyToSpot 0, hmSdf, tmSdf, tmSmf
            End If
            slDate = Format$(llMissedDate, "m/d/yy")
            gPackDate slDate, tlSdfExt.iDate(0), tlSdfExt.iDate(1)
            gPackTimeLong llMissedTime, tlSdfExt.iTime(0), tlSdfExt.iTime(1)
        Else
            If (tlSdfExt.sSchStatus = "O") Or (tlSdfExt.sSchStatus = "G") Then
                If tlSdfExt.iStatus = 0 Then
                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tlSdfExt.lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSdfSrchKey3.lCode = tlSdfExt.lCode
                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                ElseIf tlSdfExt.iStatus = 1 Then
                    'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tlSdfExt.lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSmfSrchKey1.lCode = tlSdfExt.lCode
                    ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                End If
                'tmSmfSrchKey.lChfCode = tlSdfExt.lChfCode
                'tmSmfSrchKey.iLineNo = tlSdfExt.iLineNo
                'tmSmfSrchKey.iMissedDate(0) = 0 'ilDate0
                'tmSmfSrchKey.iMissedDate(1) = 0 'ilDate1
                'ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                tmSmfSrchKey2.lCode = tmSdf.lCode
                ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tlSdfExt.lChfCode) And (tmSmf.iLineNo = tlSdfExt.iLineNo)
                    If tmSdf.lCode = tmSmf.lSdfCode Then
                        tlSdfExt.iDate(0) = tmSmf.iMissedDate(0)
                        tlSdfExt.iDate(1) = tmSmf.iMissedDate(1)
                        tlSdfExt.iTime(0) = tmSmf.iMissedTime(0)
                        tlSdfExt.iTime(1) = tmSmf.iMissedTime(1)
                        Exit Do
                    End If
                    ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                Loop
            End If
        End If
    End If
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mCreateISR                      *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Create ISR records if required *
'*                                                     *
'*******************************************************
Private Sub mCreateISR(ilTestSize As Integer)
    Dim ilLoop As Integer
    Dim ilRet As Integer
    If ilTestSize Then
        If UBound(tgSortNoKey) < 32000 Then
            Exit Sub
        End If
    End If
    igUsedISR = True
    For ilLoop = 0 To lbcKey.ListCount - 1 Step 1
        tmSortISR.sKey = lbcKey.List(ilLoop)
        tmSortISR.tSort = tgSortNoKey(lbcKey.ItemData(ilLoop))
        LSet tmIsr = tmSortISR
        gPackDate smGenDate, tmIsr.iGenDate(0), tmIsr.iGenDate(1)
        gPackTime smGenTime, tmIsr.iGenTime(0), tmIsr.iGenTime(1)
        ilRet = btrInsert(hmIsr, tmIsr, imIsrRecLen, INDEXKEY0)
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            Print #hmMsg, "mCreateISR: btrInsert-Point 1, Isr Error # " & Trim$(str$(ilRet))
        End If
    Next ilLoop
    ReDim tgSortNoKey(0 To 0) As TYPESORTNOKEY
    lbcKey.Clear
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mCreateRvf                      *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Create RVF records             *
'*                                                     *
'*******************************************************
Private Sub mCreateRvf(llInvoiceNo As Long, slAgyRate As String, ilPass As Integer, slProduct As String, ilUrfCode As Integer, llStartSortIndex As Long, llEndSortIndex As Long, slTotalRate As String, slTotalNoPerWk As String, slPctTrade As String)
    Dim ilLoop As Integer
    Dim ilRvf As Integer
    Dim ilFound As Integer
    Dim ilRet As Integer
    Dim slStr As String
    Dim ilClf As Integer
    Dim ilPkRvf As Integer
    Dim ilMultiRvf As Integer
    Dim ilVefCode As Integer
    'Dim llSdfIndex As Integer
    Dim llSdfIndex As Long
    Dim slAiredPrice As String
    Dim slPkTotal As String
    Dim slPkPrice As String
    Dim slRGrossPkTotal As String   'Running Gross amount stored into RVF (airing vehicles of packages)
    Dim slRNetPkTotal As String     'Running Net amount stored into RVF (airing vehicles of packages)
    Dim ilIndex As Integer
    Dim ilVsf As Integer
    Dim slPct As String
    Dim slRGrossVTotal As String     'Running Gross amount stored into RVF (airing vehicles of virtual vehicle)
    Dim slRNetVTotal As String       'Running Net amount stored into RVf (airing vehicles of Virtual vehicle)
    Dim slVPrice As String
    Dim ilLine As Integer
    Dim ilBaseRvf As Integer
    Dim slGrossTotal As String  'Gross amount shown on the invoice
    Dim slNetTotal As String    'Net amount shown on the invoice
    Dim ilLastBalanceIndex As Integer    'Index for last package or virtual vehicle that its to get the remaining dollars
    Dim llSDate As Long
    Dim llEDate As Long
    'Dim ilTest As Integer
    Dim slAllVefDollars As String
    Dim slAllVefBilledDollars As String
    Dim ilCntrSpotObtained As Integer
    Dim ilStartRvf As Integer
    '4/10/15: Include missed if billing by Order or Missed reason set as Bill
    Dim blIncludeMissed As Boolean
    Dim llAcq As Long
    ReDim llAcqSdfCode(0 To 0) As Long

    lmTax1 = 0
    lmTax2 = 0
    If imRemoteCntr Then
        Exit Sub
    End If
    If (tmChf.sType <> "S") And (tmChf.sType <> "M") And (tmChf.sType <> "V") Then
        'If rbcType(INVGEN_Final).Value Then    'And (ilPreview = 0) Then
        '12/17/06-Change to tax by agency or vehicle
        'If (rbcType(INVGEN_Final).Value) Or ((imExportCntr) And (rbcType(INVGEN_Preliminary).Value Or rbcType(INVGEN_Final).Value Or rbcType(INVGEN_Reprint).Value)) Or ((tgSpf.iBTax(0) <> 0) Or (tgSpf.iBTax(1) <> 0)) Then   'And (ilPreview = 0) Then
        '11-15-16 test for archive, treat like reprint
        If (rbcType(INVGEN_Final).Value) Or ((imExportCntr) And (rbcType(INVGEN_Preliminary).Value Or rbcType(INVGEN_Final).Value Or rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value)) Or (((Asc(tgSpf.sUsingFeatures3) And TAXONAIRTIME) = TAXONAIRTIME) Or ((Asc(tgSpf.sUsingFeatures3) And TAXONNTR) = TAXONNTR)) Then   'And (ilPreview = 0) Then
            ilCntrSpotObtained = False
            'Create receivable record
            ilStartRvf = UBound(tgRvf)
            ReDim tgExportCount(0 To 0) As EXPORTCOUNT
            For ilLoop = 0 To UBound(tgRvfByVef) - 1 Step 1
                ilRvf = UBound(tgRvf)
                'Product- update prf now instead of after all invoices generated
                tgRvf(ilRvf).lPrfCode = 0
                If (Trim$(slProduct) <> "") Then
                    If Left$(Trim$(slProduct), 1) <> "~" Then
                        ilFound = False
                        tmPrfSrchKey.iAdfCode = tmChf.iAdfCode
                        ilRet = btrGetGreaterOrEqual(hmPrf, tmPrf, imPrfRecLen, tmPrfSrchKey, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point
                        Do While (ilRet = BTRV_ERR_NONE) And (tmPrf.iAdfCode = tmChf.iAdfCode) 'tmRvf.iAdfCode)
                            If StrComp(Trim$(Trim$(slProduct)), Trim$(tmPrf.sName), 1) = 0 Then
                                ilFound = True
                                tgRvf(ilRvf).lPrfCode = tmPrf.lCode
                                Exit Do
                            End If
                            ilRet = btrGetNext(hmPrf, tmPrf, imPrfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                        Loop
                        'If Not ilFound Then
                        If (Not ilFound) And (rbcType(INVGEN_Final).Value) Then
                            Do  'Loop until record updated or added
                                tmPrf.lCode = 0
                                tmPrf.iAdfCode = tmChf.iAdfCode
                                tmPrf.sName = Trim$(slProduct)
                                tmPrf.iMnfComp(0) = 0
                                tmPrf.iMnfComp(1) = 0
                                tmPrf.iMnfExcl(0) = 0
                                tmPrf.iMnfExcl(1) = 0
                                tmPrf.iUrfCode = ilUrfCode
                                tmPrf.iRemoteID = tgUrf(0).iRemoteUserID
                                tmPrf.lAutoCode = tmPrf.lCode
                                ilRet = btrInsert(hmPrf, tmPrf, imPrfRecLen, INDEXKEY0)
                            Loop While ilRet = BTRV_ERR_CONFLICT
                            If ilRet <> BTRV_ERR_NONE Then
                                If ilRet >= 30000 Then
                                    ilRet = csiHandleValue(0, 7)
                                End If
                                Print #hmMsg, "mCreateRvf: btrInsert-Point 1, Prf Error # " & Trim$(str$(ilRet))
                            End If
                            If ilRet = BTRV_ERR_NONE Then
                                tgRvf(ilRvf).lPrfCode = tmPrf.lCode
                                Do
                                    tmPrf.iRemoteID = tgUrf(0).iRemoteUserID
                                    tmPrf.lAutoCode = tmPrf.lCode
                                    tmPrf.iSourceID = tgUrf(0).iRemoteUserID
                                    gPackDate smSyncDate, tmPrf.iSyncDate(0), tmPrf.iSyncDate(1)
                                    gPackTime smSyncTime, tmPrf.iSyncTime(0), tmPrf.iSyncTime(1)
                                    ilRet = btrUpdate(hmPrf, tmPrf, imPrfRecLen)
                                Loop While ilRet = BTRV_ERR_CONFLICT
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    Print #hmMsg, "mCreateRvf: btrUpdate-Point 1, Prf Error # " & Trim$(str$(ilRet))
                                End If
                            Else
                                tgRvf(ilRvf).lPrfCode = 0
                            End If
                        End If
                    End If
                End If
                tgRvf(ilRvf).iAgfCode = tmChf.iAgfCode
                tgRvf(ilRvf).iAdfCode = tmChf.iAdfCode
                tgRvf(ilRvf).iSlfCode = tmChf.iSlfCode(0)
                tgRvf(ilRvf).lCntrNo = tmChf.lCntrNo
                tgRvf(ilRvf).lInvNo = llInvoiceNo
                tgRvf(ilRvf).lRefInvNo = 0
                tgRvf(ilRvf).iBillVefCode = tgRvfByVef(ilLoop).iVefCode
                tgRvf(ilRvf).iAirVefCode = tgRvfByVef(ilLoop).iVefCode
                '6/7/15: Check number changed to string
                'tgRvf(ilRvf).lCheckNo = 0
                tgRvf(ilRvf).sCheckNo = ""
                If tmChf.sBillCycle = "C" Then
                    gPackDate smEndCal, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                ElseIf tmChf.sBillCycle = "W" Then
                    gPackDate smEndWk, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                Else
                    gPackDate smEndStd, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                End If
                tgRvf(ilRvf).sTranType = "IN"
                tgRvf(ilRvf).sAction = " "
                gStrToPDN tgRvfByVef(ilLoop).sTotalGross, 2, 6, tgRvf(ilRvf).sGross
                slGrossTotal = tgRvfByVef(ilLoop).sTotalGross
                If slAgyRate = "" Then
                    slStr = tgRvfByVef(ilLoop).sTotalGross
                Else
                    slStr = gDivStr(gMulStr(tgRvfByVef(ilLoop).sTotalGross, gSubStr("100.00", slAgyRate)), "100.00")
                End If
                slNetTotal = slStr
                gStrToPDN slStr, 2, 6, tgRvf(ilRvf).sNet
                If tmChf.sBillCycle = "C" Then
                    tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndCal))
                    tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndCal))
                ElseIf tmChf.sBillCycle = "W" Then
                    tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndWk))
                    tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndWk))
                Else
                    tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndStd))
                    tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndStd))
                End If
                gPackDate "", tgRvf(ilRvf).iPurgeDate(0), tgRvf(ilRvf).iPurgeDate(1)
                'If Val(slPctTrade) = 100 Then
                If ilPass = 2 Then
                    tgRvf(ilRvf).sCashTrade = "T"
                Else
                    tgRvf(ilRvf).sCashTrade = "C"
                End If
                tgRvf(ilRvf).iPkLineNo = 0
                tgRvf(ilRvf).iInvDate(0) = tgRvf(ilRvf).iTranDate(0)
                tgRvf(ilRvf).iInvDate(1) = tgRvf(ilRvf).iTranDate(1)
                gPackDate smNowDate, tgRvf(ilRvf).iDateEntrd(0), tgRvf(ilRvf).iDateEntrd(1)
                tgRvf(ilRvf).iUrfCode = ilUrfCode
                tgRvf(ilRvf).iMnfGroup = 0  'Participant MnfCode, set in mUpdateRvf if Sales Source is Ask
                tgRvf(ilRvf).iMnfItem = 0   'NTR billing type
                tgRvf(ilRvf).lSbfCode = 0
                tgRvf(ilRvf).lPcfCode = 0
                tgRvf(ilRvf).lCefCode = 0
                tgRvf(ilRvf).sInCollect = "N"
                tgRvf(ilRvf).iRemoteID = 0
                tgRvf(ilRvf).lAcquisitionCost = 0
                tgRvf(ilRvf).iBacklogTrfCode = 0
                '1/17/09: Added buyer
                'tgRvf(ilRvf).sUnused = ""
                tgRvf(ilRvf).iPnfBuyer = tmChf.iPnfBuyer
                tgRvf(ilRvf).lGsfCode = tgRvfByVef(ilLoop).lGsfCode
                'If package line and "O", then create multi-rvf
                If tgRvfByVef(ilLoop).iPkLineNo > 0 Then
                    tgRvf(ilRvf).iPkLineNo = tgRvfByVef(ilLoop).iPkLineNo
                    ilClf = LBound(tgClfInv)
                    ilMultiRvf = False
                    Do While ilClf <= UBound(tgClfInv) - 1
                        If tgRvfByVef(ilLoop).iPkLineNo = tgClfInv(ilClf).ClfRec.iLine Then
                            'tgSpf.sInvAirOrder = "O" => Show Order, Update Aired
                            If (tgClfInv(ilClf).ClfRec.sType = "O") Or ((tgClfInv(ilClf).ClfRec.sType = "A") And (tgSpf.sInvAirOrder = "O")) Or ((tgClfInv(ilClf).ClfRec.sType = "E") And (tgSpf.sInvAirOrder = "O")) Then
                                ilMultiRvf = True
                                'If ((tgClfInv(ilClf).ClfRec.sType = "A") And (tgSpf.sInvAirOrder = "O")) Or ((tgClfInv(ilClf).ClfRec.sType = "E") And (tgSpf.sInvAirOrder = "O")) Then
                                '    tmChf.iPkageGenMeth = 0 'Force to by Week
                                'End If
                            End If
                            Exit Do
                        End If
                        ilClf = ilClf + 1
                    Loop
                    If ilMultiRvf Then
                        ilBaseRvf = ilRvf
                        'Create one record for each hidden line
                        'ReDim tmPkRvf(1 To 1) As RVFVEF
                        ReDim tmPkRvf(0 To 0) As RVFVEF
                        slPkTotal = ".00"
                        slAllVefDollars = ".00"
                        slAllVefBilledDollars = ".00"
                        ''If invoice by line, check for lines without spots
                        'If tmChf.iPkageGenMeth <> 1 Then
                            ReDim llAcqSdfCode(0 To 0) As Long
                            For llSdfIndex = llStartSortIndex To llEndSortIndex Step 1
                                For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                    If tgClfInv(ilLine).ClfRec.iLine = tgSortKey(llSdfIndex).iLineNo Then
                                        'Test if cancel before start
                                        'gUnpackDateLong tgClfInv(ilLine).ClfRec.iStartDate(0), tgClfInv(ilLine).ClfRec.iStartDate(1), llSDate
                                        gUnpackDateLongError tgClfInv(ilLine).ClfRec.iStartDate(0), tgClfInv(ilLine).ClfRec.iStartDate(1), llSDate, "14:mCreateRvf " & tgClfInv(ilLine).ClfRec.lCode
                                        'gUnpackDateLong tgClfInv(ilLine).ClfRec.iEndDate(0), tgClfInv(ilLine).ClfRec.iEndDate(1), llEDate
                                        gUnpackDateLongError tgClfInv(ilLine).ClfRec.iEndDate(0), tgClfInv(ilLine).ClfRec.iEndDate(1), llEDate, "15:mCreateRvf " & tgClfInv(ilLine).ClfRec.lCode
                                        If (tgRvfByVef(ilLoop).iPkLineNo = tgClfInv(ilLine).ClfRec.iPkLineNo) And (llSDate <= llEDate) Then
                                            'Create vehicle record and sum price
                                            tmClf = tgClfInv(ilLine).ClfRec
                                            If tgSortKey(llSdfIndex).iType = 0 Then
                                                'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                ilVefCode = tmSdf.iVefCode  'Airing Vehicle
                                                If (tgSpf.sInvAirOrder = "S") Or (tgSpf.sInvAirOrder = "2") Then   'Update Ordered Vehicle
                                                    If (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                                        ilVefCode = tgClfInv(ilLine).ClfRec.iVefCode
                                                    End If
                                                End If
                                            ElseIf tgSortKey(llSdfIndex).iType = 1 Then
                                                'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSmfSrchKey1.lCode = tgSortKey(llSdfIndex).lCode
                                                ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                                                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                If tgSpf.sInvAirOrder <> "S" Then   'S=Update Ordered Vehicle
                                                    ilVefCode = tmSdf.iVefCode
                                                Else
                                                    ilVefCode = tgClfInv(ilLine).ClfRec.iVefCode
                                                End If
                                            Else
                                                'ilRet = btrGetDirect(hmPsf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                                ilRet = btrGetEqual(hmPsf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                ilVefCode = tmSdf.iVefCode
                                            End If
                                            If tmSdf.sSpotType <> "X" Then
                                                ilRet = gGetFlightPrice(tmSdf, tmClf, hmCff, hmSmf, slAiredPrice)
                                            Else
                                                slAiredPrice = ".00"
                                            End If
                                            ilIndex = -1
                                            For ilPkRvf = LBound(tmPkRvf) To UBound(tmPkRvf) - 1 Step 1
                                                If (tmPkRvf(ilPkRvf).iVefCode = ilVefCode) Then 'tmSdf.iVefCode) Then
                                                    ilIndex = ilPkRvf
                                                    Exit For
                                                End If
                                            Next ilPkRvf
                                            If ilIndex = -1 Then
                                                ilPkRvf = UBound(tmPkRvf)
                                                tmPkRvf(ilPkRvf).iVefCode = ilVefCode   'tmSdf.iVefCode
                                                tmPkRvf(ilPkRvf).iPkLineNo = tgRvfByVef(ilLoop).iPkLineNo
                                                tmPkRvf(ilPkRvf).sTotalGross = ".0000"
                                                tmPkRvf(ilPkRvf).lAcquisitionCost = 0
                                                'ReDim Preserve tmPkRvf(1 To ilPkRvf + 1) As RVFVEF
                                                ReDim Preserve tmPkRvf(0 To ilPkRvf + 1) As RVFVEF
                                            Else
                                                ilPkRvf = ilIndex
                                            End If
                                            tmPkRvf(ilPkRvf).sTotalGross = gAddStr(tmPkRvf(ilPkRvf).sTotalGross, slAiredPrice)
                                            slPkTotal = gAddStr(slPkTotal, slAiredPrice)
                                            '4/10/15
                                            'If ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) And (tgSortKey(llSdfIndex).iType = 0) Then
                                            If ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Or ((tmSdf.sSchStatus = "M") And mIncludeMissed())) And (tgSortKey(llSdfIndex).iType = 0) Then
                                                ilFound = False
                                                If (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C") Then
                                                    ilFound = True
                                                Else
                                                    For llAcq = 0 To UBound(llAcqSdfCode) - 1 Step 1
                                                        If llAcqSdfCode(llAcq) = tmSdf.lCode Then
                                                            ilFound = True
                                                        End If
                                                    Next llAcq
                                                End If
                                                If Not ilFound Then
                                                    mBuildAcqWithCommInfo "Air", tgRvf(ilBaseRvf), tmClf.lAcquisitionCost
                                                    tmPkRvf(ilPkRvf).lAcquisitionCost = tmPkRvf(ilPkRvf).lAcquisitionCost + tmClf.lAcquisitionCost
                                                    llAcqSdfCode(UBound(llAcqSdfCode)) = tmSdf.lCode
                                                    ReDim Preserve llAcqSdfCode(0 To UBound(llAcqSdfCode) + 1) As Long
                                                End If
                                            End If
                                        End If
                                        Exit For
                                    End If
                                Next ilLine
                            Next llSdfIndex
                        'Else
                        '    If Not ilCntrSpotObtained Then
                        '        'ilRet = gObtainCntrSpot(-1, True, tmChf.lCode, -1, "", "", tgLnSdfExtSort(), tgLnSdfExt())
                        '        ilRet = gObtainCntrSpot(tmChf.lVefCode, True, tmChf.lCode, -1, "S", "", "", tgLnSdfExtSort(), tgLnSdfExt(), 0, False)
                        '        ilCntrSpotObtained = True
                        '    End If
                        '    For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                        '        'Test if cancel before start
                        '        'gUnpackDateLong tgClfInv(ilLine).ClfRec.iStartDate(0), tgClfInv(ilLine).ClfRec.iStartDate(1), llSDate
                        '        gUnpackDateLongError tgClfInv(ilLine).ClfRec.iStartDate(0), tgClfInv(ilLine).ClfRec.iStartDate(1), llSDate, "16:mCreateRvf " & tgClfInv(ilLine).ClfRec.lCode
                        '        'gUnpackDateLong tgClfInv(ilLine).ClfRec.iEndDate(0), tgClfInv(ilLine).ClfRec.iEndDate(1), llEDate
                        '        gUnpackDateLongError tgClfInv(ilLine).ClfRec.iEndDate(0), tgClfInv(ilLine).ClfRec.iEndDate(1), llEDate, "17:mCreateRvf " & tgClfInv(ilLine).ClfRec.lCode
                        '        If (tgRvfByVef(ilLoop).iPkLineNo = tgClfInv(ilLine).ClfRec.iPkLineNo) And (llSDate <= llEDate) Then
                        '            tmClf = tgClfInv(ilLine).ClfRec
                        '            'For llSdfIndex = LBound(tgLnSdfExt) To UBound(tgLnSdfExt) - 1 Step 1
                        '            '    If (tgLnSdfExt(llSdfIndex).iLineNo = tmClf.iLine) Then
                        '            '        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgLnSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                        '            '        tmSdfSrchKey3.lCode = tgLnSdfExt(llSdfIndex).lCode
                        '            For llSdfIndex = LBound(tgLnSdfExt) To UBound(tgLnSdfExt) - 1 Step 1
                        '                If (tgLnSdfExt(llSdfIndex).iLineNo = tmClf.iLine) Then
                        '                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgLnSdfExt(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                        '                    tmSdfSrchKey3.lCode = tgLnSdfExt(llSdfIndex).lCode
                        '                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        '                    ilFound = True
                        '                    If tgSpf.sInvAirOrder <> "S" Then   'S=Update Ordered Vehicle
                        '                        ilVefCode = tmSdf.iVefCode
                        '                        'If (tgLnSdfExt(llSdfIndex).sSchStatus = "H") Or (tgLnSdfExt(llSdfIndex).sSchStatus = "C") Then
                        '                        If (tgLnSdfExt(llSdfIndex).sSchStatus = "H") Or (tgLnSdfExt(llSdfIndex).sSchStatus = "C") Then
                        '                            ilFound = False
                        '                        End If
                        '                    Else
                        '                        ilVefCode = tgClfInv(ilLine).ClfRec.iVefCode
                        '                    End If
                        '                    If ilFound Then
                        '                        ilIndex = -1
                        '                        For ilPkRvf = LBound(tmPkRvf) To UBound(tmPkRvf) - 1 Step 1
                        '                            If (tmPkRvf(ilPkRvf).iVefCode = ilVefCode) Then 'tmSdf.iVefCode) Then
                        '                                ilIndex = ilPkRvf
                        '                                Exit For
                        '                            End If
                        '                        Next ilPkRvf
                        '                        ilRet = gGetFlightPrice(tmSdf, tmClf, hmCff, hmSmf, slAiredPrice)
                        '                        If ilIndex = -1 Then
                        '                            ilPkRvf = UBound(tmPkRvf)
                        '                            tmPkRvf(ilPkRvf).iVefCode = ilVefCode   'tmSdf.iVefCode
                        '                            tmPkRvf(ilPkRvf).iPkLineNo = tgRvfByVef(ilLoop).iPkLineNo
                        '                            tmPkRvf(ilPkRvf).sTotalGross = ".0000"
                        '                            tmPkRvf(ilPkRvf).sTotalVefDollars = ".00"
                        '                            tmPkRvf(ilPkRvf).sTotalVefBilledDollars = ".00"
                        '                            tmPkRvf(ilPkRvf).lAcquisitionCost = 0
                        '                            ReDim Preserve tmPkRvf(1 To ilPkRvf + 1) As RVFVEF
                        '                        Else
                        '                            ilPkRvf = ilIndex
                        '                        End If
                        '                        tmPkRvf(ilPkRvf).sTotalVefDollars = gAddStr(tmPkRvf(ilPkRvf).sTotalVefDollars, slAiredPrice)
                        '                        '4/10/15
                        '                        'If ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) Then
                        '                        If ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) Or ((tmSdf.sSchStatus = "M") And mIncludeMissed()) Then
                        '                            ilFound = False
                        '                            If (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C") Then
                        '                                ilFound = True
                        '                            Else
                        '                                For llAcq = 0 To UBound(llAcqSdfCode) - 1 Step 1
                        '                                    If llAcqSdfCode(llAcq) = tmSdf.lCode Then
                        '                                        ilFound = True
                        '                                    End If
                        '                                Next llAcq
                        '                            End If
                        '                            If Not ilFound Then
                        '                                mBuildAcqWithCommInfo "Air", tgRvf(ilBaseRvf)
                        '                                tmPkRvf(ilPkRvf).lAcquisitionCost = tmPkRvf(ilPkRvf).lAcquisitionCost + tmClf.lAcquisitionCost
                        '                                llAcqSdfCode(UBound(llAcqSdfCode)) = tmSdf.lCode
                        '                                ReDim Preserve llAcqSdfCode(0 To UBound(llAcqSdfCode) + 1) As Long
                        '                            End If
                        '                        End If
                        '                    End If
                        '                End If
                        '            'Next llSdfIndex
                        '            Next llSdfIndex
                        '        End If
                        '    Next ilLine
                        '    mGetPastInTran tmChf.lCntrNo, tmChf.iadfCode, tmChf.iAgfCode, tgRvfByVef(ilLoop).iPkLineNo
                        '    slAllVefDollars = ".00"
                        '    slAllVefBilledDollars = ".00"
                        '    For ilPkRvf = LBound(tmPkRvf) To UBound(tmPkRvf) - 1 Step 1
                        '        slAllVefDollars = gAddStr(slAllVefDollars, tmPkRvf(ilPkRvf).sTotalVefDollars)
                        '        slAllVefBilledDollars = gAddStr(slAllVefBilledDollars, tmPkRvf(ilPkRvf).sTotalVefBilledDollars)
                        '    Next ilPkRvf
                        'End If
                        slRGrossPkTotal = ".00"
                        slRNetPkTotal = ".00"
                        ilLastBalanceIndex = UBound(tmPkRvf) - 1
                        'If tmChf.iPkageGenMeth <> 1 Then
                            For ilPkRvf = LBound(tmPkRvf) To UBound(tmPkRvf) - 1 Step 1
                                If gCompNumberStr(tmPkRvf(ilPkRvf).sTotalGross, ".00") > 0 Then
                                    ilLastBalanceIndex = ilPkRvf
                                End If
                            Next ilPkRvf
                        'Else
                        '    For ilPkRvf = LBound(tmPkRvf) To UBound(tmPkRvf) - 1 Step 1
                        '        If gCompNumberStr(tmPkRvf(ilPkRvf).sTotalVefDollars, tmPkRvf(ilPkRvf).sTotalVefBilledDollars) <> 0 Then
                        '            ilLastBalanceIndex = ilPkRvf
                        '        End If
                        '    Next ilPkRvf
                        'End If
                        For ilPkRvf = LBound(tmPkRvf) To UBound(tmPkRvf) - 1 Step 1
                            If ilRvf <> ilBaseRvf Then
                                tgRvf(ilRvf) = tgRvf(ilBaseRvf)
                            End If
                            If ilPkRvf <> ilLastBalanceIndex Then
                                ''slPkPrice = gMulStr(slGrossTotal, gDivStr(tmPkRvf(ilPkRvf).sTotalGross, slPkTotal))
                                'If tmChf.iPkageGenMeth = 1 Then
                                '    If (gCompNumberStr(slAllVefDollars, slAllVefBilledDollars) <> 0) Then
                                '        slPkPrice = gDivStr(gMulStr(slGrossTotal, gSubStr(tmPkRvf(ilPkRvf).sTotalVefDollars, tmPkRvf(ilPkRvf).sTotalVefBilledDollars)), gSubStr(slAllVefDollars, slAllVefBilledDollars))
                                '    Else
                                '        slPkPrice = ".00"
                                '    End If
                                'Else
                                    If gCompNumberStr(slPkTotal, ".00") > 0 Then
                                        slPkPrice = gDivStr(gMulStr(slGrossTotal, tmPkRvf(ilPkRvf).sTotalGross), slPkTotal)
                                    Else
                                        slPkPrice = ".00"
                                    End If
                                'End If
                                slPkPrice = gRoundStr(slPkPrice, ".01", 2)
                                slRGrossPkTotal = gAddStr(slRGrossPkTotal, slPkPrice)
                            Else
                                slPkPrice = gSubStr(slGrossTotal, slRGrossPkTotal)
                                slPkTotal = ".00"   'Force remaining prices to be zero
                            End If
                            gStrToPDN slPkPrice, 2, 6, tgRvf(ilRvf).sGross
                            If ilPkRvf <> ilLastBalanceIndex Then
                                If slAgyRate = "" Then
                                    slStr = slPkPrice
                                Else
                                    slStr = gDivStr(gMulStr(slPkPrice, gSubStr("100.00", slAgyRate)), "100.00")
                                End If
                                slRNetPkTotal = gAddStr(slRNetPkTotal, slStr)
                            Else
                                slStr = gSubStr(slNetTotal, slRNetPkTotal)
                            End If
                            gStrToPDN slStr, 2, 6, tgRvf(ilRvf).sNet
                            tgRvf(ilRvf).iAirVefCode = tmPkRvf(ilPkRvf).iVefCode
                            tgRvf(ilRvf).iPkLineNo = tgRvfByVef(ilLoop).iPkLineNo
                            If ilRvf = ilBaseRvf Then
                                tgExportCount(UBound(tgExportCount)).lONoSpots = 0
                                tgExportCount(UBound(tgExportCount)).lANoSpots = tgRvfByVef(ilLoop).lANoSpots
                                tgExportCount(UBound(tgExportCount)).lBNoSpots = tgRvfByVef(ilLoop).lBNoSpots
                            Else
                                tgExportCount(UBound(tgExportCount)).lONoSpots = 0
                                tgExportCount(UBound(tgExportCount)).lANoSpots = 0
                                tgExportCount(UBound(tgExportCount)).lBNoSpots = 0
                            End If
                            'If UBound(tgExportCount) = 0 Then
                                tgExportCount(UBound(tgExportCount)).lONoSpots = Val(slTotalNoPerWk)
                                tgExportCount(UBound(tgExportCount)).lOGross = gStrDecToLong(slTotalRate, 2)
                                tgExportCount(UBound(tgExportCount)).iCommPct = gStrDecToInt(slAgyRate, 2)
                            'End If
                            tgExportCount(UBound(tgExportCount)).lPrice = tgRvfByVef(ilLoop).lPrice
                            tgExportCount(UBound(tgExportCount)).iLnVefCode = tgRvfByVef(ilLoop).iLnVefCode
                            tgExportCount(UBound(tgExportCount)).iCombineID = ilLoop + 1
                            ReDim Preserve tgExportCount(0 To UBound(tgExportCount) + 1) As EXPORTCOUNT
                            tgRvf(ilRvf).lAcquisitionCost = tmPkRvf(ilPkRvf).lAcquisitionCost
                            If ilPass = 1 Then
                                If Val(slPctTrade) <> 100 Then
                                    tgRvf(ilRvf).lAcquisitionCost = ((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100
                                End If
                            ElseIf ilPass = 2 Then
                                If Val(slPctTrade) <> 100 Then
                                    tgRvf(ilRvf).lAcquisitionCost = tgRvf(ilRvf).lAcquisitionCost - (((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100)
                                End If
                            End If
                            ilRvf = ilRvf + 1
                            ReDim Preserve tgRvf(0 To ilRvf) As RVF
                        Next ilPkRvf
                    Else
                        tgExportCount(UBound(tgExportCount)).lONoSpots = 0
                        tgExportCount(UBound(tgExportCount)).lANoSpots = tgRvfByVef(ilLoop).lANoSpots
                        tgExportCount(UBound(tgExportCount)).lBNoSpots = tgRvfByVef(ilLoop).lBNoSpots
                        tgExportCount(UBound(tgExportCount)).iCombineID = ilLoop + 1
                        'If UBound(tgExportCount) = 0 Then
                            tgExportCount(UBound(tgExportCount)).lONoSpots = Val(slTotalNoPerWk)
                            tgExportCount(UBound(tgExportCount)).lOGross = gStrDecToLong(slTotalRate, 2)
                            tgExportCount(UBound(tgExportCount)).iCommPct = gStrDecToInt(slAgyRate, 2)
                        'End If
                        tgExportCount(UBound(tgExportCount)).lPrice = tgRvfByVef(ilLoop).lPrice
                        tgExportCount(UBound(tgExportCount)).iLnVefCode = tgRvfByVef(ilLoop).iLnVefCode
                        ReDim Preserve tgExportCount(0 To UBound(tgExportCount) + 1) As EXPORTCOUNT
                        For llSdfIndex = llStartSortIndex To llEndSortIndex Step 1
                            For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                If tgClfInv(ilLine).ClfRec.iLine = tgSortKey(llSdfIndex).iLineNo Then
                                    'Test if cancel before start
                                    'gUnpackDateLong tgClfInv(ilLine).ClfRec.iStartDate(0), tgClfInv(ilLine).ClfRec.iStartDate(1), llSDate
                                    gUnpackDateLongError tgClfInv(ilLine).ClfRec.iStartDate(0), tgClfInv(ilLine).ClfRec.iStartDate(1), llSDate, "18:mCreateRvf " & tgClfInv(ilLine).ClfRec.lCode
                                    'gUnpackDateLong tgClfInv(ilLine).ClfRec.iEndDate(0), tgClfInv(ilLine).ClfRec.iEndDate(1), llEDate
                                    gUnpackDateLongError tgClfInv(ilLine).ClfRec.iEndDate(0), tgClfInv(ilLine).ClfRec.iEndDate(1), llEDate, "19:mCreateRvf " & tgClfInv(ilLine).ClfRec.lCode
                                    If (tgRvfByVef(ilLoop).iPkLineNo = tgClfInv(ilLine).ClfRec.iPkLineNo) And (llSDate <= llEDate) Then
                                        'Create vehicle record and sum price
                                        tmClf = tgClfInv(ilLine).ClfRec
                                        If tgSortKey(llSdfIndex).iType = 0 Then
                                            'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                            tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                            ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                        ElseIf tgSortKey(llSdfIndex).iType = 1 Then
                                            'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                            tmSmfSrchKey1.lCode = tgSortKey(llSdfIndex).lCode
                                            ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                            tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                                            ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                        Else
                                            'ilRet = btrGetDirect(hmPsf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                            tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                            ilRet = btrGetEqual(hmPsf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                        End If
                                        If tgSpf.sInvAirOrder <> "S" Then   'S=Update Ordered Vehicle
                                            ilVefCode = tmSdf.iVefCode
                                        Else
                                            ilVefCode = tgClfInv(ilLine).ClfRec.iVefCode
                                            '4/12/14: If hidden liner, convert to package vehicle
                                            If tgClfInv(ilLine).ClfRec.sType = "H" Then
                                                Do While ilClf <= UBound(tgClfInv) - 1
                                                    If tgClfInv(ilLine).ClfRec.iPkLineNo = tgClfInv(ilClf).ClfRec.iLine Then
                                                        ilVefCode = tgClfInv(ilClf).ClfRec.iVefCode
                                                        Exit Do
                                                    End If
                                                    ilClf = ilClf + 1
                                                Loop
                                            End If
                                        End If
                                        If tgRvfByVef(ilLoop).iVefCode = ilVefCode Then
                                            '4/10/15
                                            'If ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) And (tgSortKey(llSdfIndex).iType = 0) Then
                                            If ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Or ((tmSdf.sSchStatus = "M") And mIncludeMissed())) And (tgSortKey(llSdfIndex).iType = 0) Then
                                                ilFound = False
                                                If (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C") Then
                                                    ilFound = True
                                                Else
                                                    For llAcq = 0 To UBound(llAcqSdfCode) - 1 Step 1
                                                        If llAcqSdfCode(llAcq) = tmSdf.lCode Then
                                                            ilFound = True
                                                        End If
                                                    Next llAcq
                                                End If
                                                If Not ilFound Then
                                                    mBuildAcqWithCommInfo "Air", tgRvf(ilRvf), tmClf.lAcquisitionCost
                                                    tgRvf(ilRvf).lAcquisitionCost = tgRvf(ilRvf).lAcquisitionCost + tmClf.lAcquisitionCost
                                                    llAcqSdfCode(UBound(llAcqSdfCode)) = tmSdf.lCode
                                                    ReDim Preserve llAcqSdfCode(0 To UBound(llAcqSdfCode) + 1) As Long
                                                End If
                                            End If
                                        End If
                                    End If
                                    Exit For
                                End If
                            Next ilLine
                        Next llSdfIndex
                        If ilPass = 1 Then
                            If Val(slPctTrade) <> 100 Then
                                tgRvf(ilRvf).lAcquisitionCost = ((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100
                            End If
                        ElseIf ilPass = 2 Then
                            If Val(slPctTrade) <> 100 Then
                                tgRvf(ilRvf).lAcquisitionCost = tgRvf(ilRvf).lAcquisitionCost - (((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100)
                            End If
                        End If
                        ReDim Preserve tgRvf(0 To ilRvf + 1) As RVF
                    End If
                Else
                    tmVefSrchKey.iCode = tgRvfByVef(ilLoop).iVefCode
                    ilRet = btrGetEqual(hmVef, tmVVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If tmVVef.sType = "V" Then
                        ilBaseRvf = ilRvf
                        'Distribute Dollars based on virtual vehicle
                        tmVsfSrchKey.lCode = tmVVef.lVsfCode
                        ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        slRGrossVTotal = ".00"
                        slRNetVTotal = ".00"
                        ilLastBalanceIndex = LBound(tmVsf.iFSCode)
                        For ilVsf = UBound(tmVsf.iFSCode) To LBound(tmVsf.iFSCode) Step -1
                            If (tmVsf.iFSCode(ilVsf) > 0) And (tmVsf.lFSComm(ilVsf) > 0) Then
                                ilLastBalanceIndex = ilVsf
                            End If
                        Next ilVsf
                        For ilVsf = UBound(tmVsf.iFSCode) To LBound(tmVsf.iFSCode) Step -1
                            If tmVsf.iFSCode(ilVsf) > 0 Then
                                If ilRvf <> ilBaseRvf Then
                                    tgRvf(ilRvf) = tgRvf(ilBaseRvf)
                                End If
                                'gPDNToStr tmVsf.lFSComm(ilVsf), 4, slPct
                                slPct = gLongToStrDec(tmVsf.lFSComm(ilVsf), 4)
                                If ilVsf <> ilLastBalanceIndex Then
                                    slVPrice = gDivStr(gMulStr(slGrossTotal, slPct), "100.00")
                                    slVPrice = gRoundStr(slVPrice, ".01", 2)
                                    slRGrossVTotal = gAddStr(slRGrossVTotal, slVPrice)
                                Else
                                    slVPrice = gSubStr(slGrossTotal, slRGrossVTotal)
                                    slGrossTotal = ".00"    'Force remaining to be zero
                                End If
                                gStrToPDN slVPrice, 2, 6, tgRvf(ilRvf).sGross
                                If ilVsf <> ilLastBalanceIndex Then
                                    If slAgyRate = "" Then
                                        slStr = slVPrice
                                    Else
                                        slStr = gDivStr(gMulStr(slVPrice, gSubStr("100.00", slAgyRate)), "100.00")
                                    End If
                                    slRNetVTotal = gAddStr(slRNetVTotal, slStr)
                                Else
                                    slStr = gSubStr(slNetTotal, slRNetVTotal)
                                End If
                                gStrToPDN slStr, 2, 6, tgRvf(ilRvf).sNet
                                tgRvf(ilRvf).iAirVefCode = tmVsf.iFSCode(ilVsf)
                                If ilRvf = ilBaseRvf Then
                                    tgExportCount(UBound(tgExportCount)).lONoSpots = 0
                                    tgExportCount(UBound(tgExportCount)).lANoSpots = tgRvfByVef(ilLoop).lANoSpots
                                    tgExportCount(UBound(tgExportCount)).lBNoSpots = tgRvfByVef(ilLoop).lBNoSpots
                                Else
                                    tgExportCount(UBound(tgExportCount)).lONoSpots = 0
                                    tgExportCount(UBound(tgExportCount)).lANoSpots = 0
                                    tgExportCount(UBound(tgExportCount)).lBNoSpots = 0
                                End If
                                tgExportCount(UBound(tgExportCount)).iCombineID = ilLoop + 1
                                'If UBound(tgExportCount) = 0 Then
                                    tgExportCount(UBound(tgExportCount)).lONoSpots = Val(slTotalNoPerWk)
                                    tgExportCount(UBound(tgExportCount)).lOGross = gStrDecToLong(slTotalRate, 2)
                                    tgExportCount(UBound(tgExportCount)).iCommPct = gStrDecToInt(slAgyRate, 2)
                                'End If
                                tgExportCount(UBound(tgExportCount)).lPrice = tgRvfByVef(ilLoop).lPrice
                                tgExportCount(UBound(tgExportCount)).iLnVefCode = tgRvfByVef(ilLoop).iLnVefCode
                                ReDim Preserve tgExportCount(0 To UBound(tgExportCount) + 1) As EXPORTCOUNT
                                ilRvf = ilRvf + 1
                                ReDim Preserve tgRvf(0 To ilRvf) As RVF
                            End If
                        Next ilVsf
                    Else
                        If tgSpf.sInvAirOrder <> "O" Then   'O=Show Order, Update Airing
                            tgExportCount(UBound(tgExportCount)).lONoSpots = 0
                            tgExportCount(UBound(tgExportCount)).lANoSpots = tgRvfByVef(ilLoop).lANoSpots
                            tgExportCount(UBound(tgExportCount)).lBNoSpots = tgRvfByVef(ilLoop).lBNoSpots
                            tgExportCount(UBound(tgExportCount)).iCombineID = ilLoop + 1
                            'If UBound(tgExportCount) = 0 Then
                                tgExportCount(UBound(tgExportCount)).lONoSpots = Val(slTotalNoPerWk)
                                tgExportCount(UBound(tgExportCount)).lOGross = gStrDecToLong(slTotalRate, 2)
                                tgExportCount(UBound(tgExportCount)).iCommPct = gStrDecToInt(slAgyRate, 2)
                            'End If
                            tgExportCount(UBound(tgExportCount)).lPrice = tgRvfByVef(ilLoop).lPrice
                            tgExportCount(UBound(tgExportCount)).iLnVefCode = tgRvfByVef(ilLoop).iLnVefCode
                            ReDim Preserve tgExportCount(0 To UBound(tgExportCount) + 1) As EXPORTCOUNT
                            For llSdfIndex = llStartSortIndex To llEndSortIndex Step 1
                                For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                    If (tgClfInv(ilLine).ClfRec.iLine = tgSortKey(llSdfIndex).iLineNo) And (tgClfInv(ilLine).ClfRec.iVefCode = tgRvfByVef(ilLoop).iVefCode) Then
                                        'Ignore package and hidden lines
                                        If (tgClfInv(ilLine).ClfRec.sType <> "O") And (tgClfInv(ilLine).ClfRec.sType <> "A") And (tgClfInv(ilLine).ClfRec.sType <> "E") And (tgClfInv(ilLine).ClfRec.sType <> "H") Then
                                            tmClf = tgClfInv(ilLine).ClfRec
                                            If tgSortKey(llSdfIndex).iType = 0 Then
                                                'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                            ElseIf tgSortKey(llSdfIndex).iType = 1 Then
                                                'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSmfSrchKey1.lCode = tgSortKey(llSdfIndex).lCode
                                                ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                                                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                            Else
                                                'ilRet = btrGetDirect(hmPsf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                                ilRet = btrGetEqual(hmPsf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                            End If
                                            '4/10/15
                                            'If ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) And (tgSortKey(llSdfIndex).iType = 0) Then
                                            If ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Or ((tmSdf.sSchStatus = "M") And mIncludeMissed())) And (tgSortKey(llSdfIndex).iType = 0) Then
                                                ilFound = False
                                                If (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C") Then
                                                    ilFound = True
                                                Else
                                                    For llAcq = 0 To UBound(llAcqSdfCode) - 1 Step 1
                                                        If llAcqSdfCode(llAcq) = tmSdf.lCode Then
                                                            ilFound = True
                                                        End If
                                                    Next llAcq
                                                End If
                                                If Not ilFound Then
                                                    mBuildAcqWithCommInfo "Air", tgRvf(ilRvf), tmClf.lAcquisitionCost
                                                    tgRvf(ilRvf).lAcquisitionCost = tgRvf(ilRvf).lAcquisitionCost + tmClf.lAcquisitionCost
                                                    llAcqSdfCode(UBound(llAcqSdfCode)) = tmSdf.lCode
                                                    ReDim Preserve llAcqSdfCode(0 To UBound(llAcqSdfCode) + 1) As Long
                                                End If
                                            End If
                                        End If
                                    End If
                                Next ilLine
                            Next llSdfIndex
                            If ilPass = 1 Then
                                If Val(slPctTrade) <> 100 Then
                                    tgRvf(ilRvf).lAcquisitionCost = ((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100
                                End If
                            ElseIf ilPass = 2 Then
                                If Val(slPctTrade) <> 100 Then
                                    tgRvf(ilRvf).lAcquisitionCost = tgRvf(ilRvf).lAcquisitionCost - (((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100)
                                End If
                            End If
                            ReDim Preserve tgRvf(0 To ilRvf + 1) As RVF
                        Else
                            ilBaseRvf = ilRvf
                            'ReDim tmPkRvf(1 To 1) As RVFVEF
                            ReDim tmPkRvf(0 To 0) As RVFVEF
                            For llSdfIndex = llStartSortIndex To llEndSortIndex Step 1
                                For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                    If (tgClfInv(ilLine).ClfRec.iLine = tgSortKey(llSdfIndex).iLineNo) And (tgClfInv(ilLine).ClfRec.iVefCode = tgRvfByVef(ilLoop).iVefCode) Then
                                        'Ignore package and hidden lines
                                        If (tgClfInv(ilLine).ClfRec.sType <> "O") And (tgClfInv(ilLine).ClfRec.sType <> "A") And (tgClfInv(ilLine).ClfRec.sType <> "E") And (tgClfInv(ilLine).ClfRec.sType <> "H") Then
                                            tmClf = tgClfInv(ilLine).ClfRec
                                            If tgSortKey(llSdfIndex).iType = 0 Then
                                                'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                ilVefCode = tmSdf.iVefCode
                                            ElseIf tgSortKey(llSdfIndex).iType = 1 Then
                                                'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSmfSrchKey1.lCode = tgSortKey(llSdfIndex).lCode
                                                ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                                                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                ilVefCode = tmSdf.iVefCode
                                            Else
                                                'ilRet = btrGetDirect(hmPsf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                                ilRet = btrGetEqual(hmPsf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                ilVefCode = tmSdf.iVefCode
                                            End If
                                            ilRet = gGetFlightPrice(tmSdf, tmClf, hmCff, hmSmf, slAiredPrice)
                                            ilIndex = -1
                                            For ilPkRvf = LBound(tmPkRvf) To UBound(tmPkRvf) - 1 Step 1
                                                If (tmPkRvf(ilPkRvf).iVefCode = ilVefCode) Then 'tmSdf.iVefCode) Then
                                                    ilIndex = ilPkRvf
                                                    Exit For
                                                End If
                                            Next ilPkRvf
                                            If ilIndex = -1 Then
                                                ilPkRvf = UBound(tmPkRvf)
                                                tmPkRvf(ilPkRvf).iVefCode = ilVefCode   'tmSdf.iVefCode
                                                tmPkRvf(ilPkRvf).sTotalGross = ".0000"
                                                tmPkRvf(ilPkRvf).lAcquisitionCost = 0
                                                'ReDim Preserve tmPkRvf(1 To ilPkRvf + 1) As RVFVEF
                                                ReDim Preserve tmPkRvf(0 To ilPkRvf + 1) As RVFVEF
                                            Else
                                                ilPkRvf = ilIndex
                                            End If
                                            tmPkRvf(ilPkRvf).sTotalGross = gAddStr(tmPkRvf(ilPkRvf).sTotalGross, slAiredPrice)
                                            '4/10/15
                                            'If ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) And (tgSortKey(llSdfIndex).iType = 0) Then
                                            If ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Or ((tmSdf.sSchStatus = "M") And mIncludeMissed())) And (tgSortKey(llSdfIndex).iType = 0) Then
                                                ilFound = False
                                                If (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C") Then
                                                    ilFound = True
                                                Else
                                                    For llAcq = 0 To UBound(llAcqSdfCode) - 1 Step 1
                                                        If llAcqSdfCode(llAcq) = tmSdf.lCode Then
                                                            ilFound = True
                                                        End If
                                                    Next llAcq
                                                End If
                                                If Not ilFound Then
                                                    mBuildAcqWithCommInfo "Air", tgRvf(ilBaseRvf), tmClf.lAcquisitionCost
                                                    tmPkRvf(ilPkRvf).lAcquisitionCost = tmPkRvf(ilPkRvf).lAcquisitionCost + tmClf.lAcquisitionCost
                                                    llAcqSdfCode(UBound(llAcqSdfCode)) = tmSdf.lCode
                                                    ReDim Preserve llAcqSdfCode(0 To UBound(llAcqSdfCode) + 1) As Long
                                                End If
                                            End If
                                        End If
                                    End If
                                Next ilLine
                            Next llSdfIndex
                            'If UBound(tmPkRvf) <= 2 Then
                            If UBound(tmPkRvf) <= 1 Then
                                '       Fixed 2/2/98, this fixes problem if spot is
                                '       outside or MG to different vehicle.
                                'If tmPkRvf(1).iVefCode > 0 Then
                                If tmPkRvf(0).iVefCode > 0 Then
                                    'tgRvf(ilRvf).iAirVefCode = tmPkRvf(1).iVefCode
                                    tgRvf(ilRvf).iAirVefCode = tmPkRvf(0).iVefCode
                                End If
                                tgExportCount(UBound(tgExportCount)).lONoSpots = 0
                                tgExportCount(UBound(tgExportCount)).lANoSpots = tgRvfByVef(ilLoop).lANoSpots
                                tgExportCount(UBound(tgExportCount)).lBNoSpots = tgRvfByVef(ilLoop).lBNoSpots
                                tgExportCount(UBound(tgExportCount)).iCombineID = ilLoop + 1
                                'If UBound(tgExportCount) = 0 Then
                                    tgExportCount(UBound(tgExportCount)).lONoSpots = Val(slTotalNoPerWk)
                                    tgExportCount(UBound(tgExportCount)).lOGross = gStrDecToLong(slTotalRate, 2)
                                    tgExportCount(UBound(tgExportCount)).iCommPct = gStrDecToInt(slAgyRate, 2)
                                'End If
                                tgExportCount(UBound(tgExportCount)).lPrice = tgRvfByVef(ilLoop).lPrice
                                tgExportCount(UBound(tgExportCount)).iLnVefCode = tgRvfByVef(ilLoop).iLnVefCode
                                ReDim Preserve tgExportCount(0 To UBound(tgExportCount) + 1) As EXPORTCOUNT
                                'tgRvf(ilRvf).lAcquisitionCost = tmPkRvf(1).lAcquisitionCost
                                tgRvf(ilRvf).lAcquisitionCost = tmPkRvf(0).lAcquisitionCost
                                If ilPass = 1 Then
                                    If Val(slPctTrade) <> 100 Then
                                        tgRvf(ilRvf).lAcquisitionCost = ((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100
                                    End If
                                ElseIf ilPass = 2 Then
                                    If Val(slPctTrade) <> 100 Then
                                        tgRvf(ilRvf).lAcquisitionCost = tgRvf(ilRvf).lAcquisitionCost - (((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100)
                                    End If
                                End If
                                ReDim Preserve tgRvf(0 To ilRvf + 1) As RVF
                            Else
                                slRGrossPkTotal = ".00"
                                slRNetPkTotal = ".00"
                                For ilPkRvf = LBound(tmPkRvf) To UBound(tmPkRvf) - 1 Step 1
                                    If tmPkRvf(ilPkRvf).iVefCode <> tgRvfByVef(ilLoop).iVefCode Then
                                        slPkPrice = tmPkRvf(ilPkRvf).sTotalGross
                                        slPkPrice = gRoundStr(slPkPrice, ".01", 2)
                                        slRGrossPkTotal = gAddStr(slRGrossPkTotal, slPkPrice)
                                        If slAgyRate = "" Then
                                            slStr = slPkPrice
                                        Else
                                            slStr = gDivStr(gMulStr(slPkPrice, gSubStr("100.00", slAgyRate)), "100.00")
                                        End If
                                        slRNetPkTotal = gAddStr(slRNetPkTotal, slStr)
                                    End If
                                Next ilPkRvf
                                For ilPkRvf = LBound(tmPkRvf) To UBound(tmPkRvf) - 1 Step 1
                                    If ilRvf <> ilBaseRvf Then
                                        tgRvf(ilRvf) = tgRvf(ilBaseRvf)
                                    End If
                                    If tmPkRvf(ilPkRvf).iVefCode <> tgRvfByVef(ilLoop).iVefCode Then
                                        slPkPrice = tmPkRvf(ilPkRvf).sTotalGross
                                        slPkPrice = gRoundStr(slPkPrice, ".01", 2)
                                    Else
                                        slPkPrice = gSubStr(slGrossTotal, slRGrossPkTotal)
                                    End If
                                    gStrToPDN slPkPrice, 2, 6, tgRvf(ilRvf).sGross
                                    If tmPkRvf(ilPkRvf).iVefCode <> tgRvfByVef(ilLoop).iVefCode Then
                                        If slAgyRate = "" Then
                                            slStr = slPkPrice
                                        Else
                                            slStr = gDivStr(gMulStr(slPkPrice, gSubStr("100.00", slAgyRate)), "100.00")
                                        End If
                                    Else
                                        slStr = gSubStr(slNetTotal, slRNetPkTotal)
                                    End If
                                    gStrToPDN slStr, 2, 6, tgRvf(ilRvf).sNet
                                    tgRvf(ilRvf).iAirVefCode = tmPkRvf(ilPkRvf).iVefCode
                                    If ilRvf = ilBaseRvf Then
                                        tgExportCount(UBound(tgExportCount)).lONoSpots = 0
                                        tgExportCount(UBound(tgExportCount)).lANoSpots = tgRvfByVef(ilLoop).lANoSpots
                                        tgExportCount(UBound(tgExportCount)).lBNoSpots = tgRvfByVef(ilLoop).lBNoSpots
                                    Else
                                        tgExportCount(UBound(tgExportCount)).lONoSpots = 0
                                        tgExportCount(UBound(tgExportCount)).lANoSpots = 0
                                        tgExportCount(UBound(tgExportCount)).lBNoSpots = 0
                                    End If
                                    tgExportCount(UBound(tgExportCount)).iCombineID = ilLoop + 1
                                    'If UBound(tgExportCount) = 0 Then
                                        tgExportCount(UBound(tgExportCount)).lONoSpots = Val(slTotalNoPerWk)
                                        tgExportCount(UBound(tgExportCount)).lOGross = gStrDecToLong(slTotalRate, 2)
                                        tgExportCount(UBound(tgExportCount)).iCommPct = gStrDecToInt(slAgyRate, 2)
                                    'End If
                                    tgExportCount(UBound(tgExportCount)).lPrice = tgRvfByVef(ilLoop).lPrice
                                    tgExportCount(UBound(tgExportCount)).iLnVefCode = tgRvfByVef(ilLoop).iLnVefCode
                                    ReDim Preserve tgExportCount(0 To UBound(tgExportCount) + 1) As EXPORTCOUNT
                                    tgRvf(ilRvf).lAcquisitionCost = tmPkRvf(ilPkRvf).lAcquisitionCost
                                    If ilPass = 1 Then
                                        If Val(slPctTrade) <> 100 Then
                                            tgRvf(ilRvf).lAcquisitionCost = ((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100
                                        End If
                                    ElseIf ilPass = 2 Then
                                        If Val(slPctTrade) <> 100 Then
                                            tgRvf(ilRvf).lAcquisitionCost = tgRvf(ilRvf).lAcquisitionCost - (((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100)
                                        End If
                                    End If
                                    ilRvf = ilRvf + 1
                                    ReDim Preserve tgRvf(0 To ilRvf) As RVF
                                Next ilPkRvf
                            End If
                        End If
                    End If
                End If
            Next ilLoop
            mCalcTaxes ilStartRvf
            ilRet = mWriteExportRec(ilStartRvf)
        End If
        llInvoiceNo = llInvoiceNo + 1
        'If llInvoiceNo > tgSpf.lBHighestNo Then
        '    llInvoiceNo = tgSpf.lBLowestNo
        'End If
        mCheckNextInvNo llInvoiceNo
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mCreateSortRec                  *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Create sort records            *
'*                                                     *
'*******************************************************
Private Sub mCreateSortRec(ilType As Integer, ilUpper As Integer, llStdStartDate As Long, llStdEndDate As Long, llCalStartDate As Long, llCalEndDate As Long, llWkStartDate As Long, llWkEndDate As Long, llBaseDate As Long, tlSdfExt As SDFEXT)

'
'   Where
'       ilType(I)-0=Sdf (tlSdfExt); 1=Smf; 2=Psf
'
    Dim ilLoop As Integer
    Dim slName As String
    Dim slNameCode As String
    Dim ilVefCode As Integer
    Dim slLnVehName As String
    'Dim slCode As String
    Dim ilVeh As Integer
    Dim ilVeh1 As Integer
    Dim ilRet As Integer
    Dim slStr As String
    Dim slKey As String
    Dim llDate As Long
    Dim slDate As String
    'Dim ilLine As Integer
    Dim llTime As Long
    'Dim llWkDate As Long
    Dim llAvDate As Long
    Dim llAvTime As Long
    Dim ilAvTime0 As Integer
    Dim ilAvTime1 As Integer
    Dim ilFound As Integer
    Dim ilSlf As Integer
    Dim ilVff As Integer
    Dim ilBonusSpot As Integer
    Dim tlClf As CLF
    Dim tlVef As VEF
    Dim ilIncludeSpot As Integer
    Dim ilVpfIndex As Integer
    Dim ilDay As Integer
    Dim ilVlf As Integer
    Dim tlSort As TYPESORTNOKEY
    Dim slSvKey As String
    Dim ilPkLineNo As Integer
    Dim ilGameNo As Integer
    Dim slGameNo As String
    Dim ilEDIFlag As Integer
    Dim blAddComment52 As Boolean
    Dim slPkLineType As String
    'ReDim slCopyProduct(1 To 6) As String
    ReDim slCopyProduct(0 To 6) As String   'Index zero ignored
    'ReDim slCopy(1 To 6) As String
    ReDim slCopy(0 To 6) As String          'Index zero ignored
    'ReDim slFields(1 To 13) As String
    ReDim slFields(0 To 13) As String   'Index zero ignored
    ReDim ilDate(0 To 1) As Integer

    If tmChf.lCode <> tlSdfExt.lChfCode Then
        tmChfSrchKey.lCode = tlSdfExt.lChfCode
        ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If ilRet <> BTRV_ERR_NONE Then
            Exit Sub
        End If
    End If
    'Bypass Reservation Contracts
    If tmChf.sType = "V" Then
        Exit Sub
    End If
    
    For ilLoop = 1 To UBound(lmCPMBypassCntr) - 1 Step 1
        If lmCPMBypassCntr(ilLoop) = tlSdfExt.lChfCode Then
            Exit Sub
        End If
    Next ilLoop
   
    If tmChf.sBillCycle = "C" Then
        If ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbUnchecked Then
            Exit Sub
        End If
        If Not imFullCal Then
            gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
            If gDateValue(slDate) > llCalEndDate Then
                Exit Sub
            End If
        End If
    ElseIf tmChf.sBillCycle = "W" Then
        If ckcBillCycle(INVBILLCYCLE_Week).Value = vbUnchecked Then
            Exit Sub
        End If
        If Not imFullWk Then
            gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
            If gDateValue(slDate) > llWkEndDate Then
                Exit Sub
            End If
        End If
    Else
        If ckcBillCycle(INVBILLCYCLE_STD).Value = vbUnchecked Then
            Exit Sub
        End If
        If Not imFullStd Then
            gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
            If gDateValue(slDate) > llStdEndDate Then
                Exit Sub
            End If
        End If
    End If
    
    ilEDIFlag = mDetermineIfEDIRequired()
    If tgUrf(0).iSlfCode > 0 Then   'Test if Salesperson- then only allow his contracts
        ilFound = False
        For ilSlf = LBound(tmChf.iSlfCode) To UBound(tmChf.iSlfCode) Step 1
            If tmChf.iSlfCode(ilSlf) <> 0 Then
                If tgUrf(0).iSlfCode = tmChf.iSlfCode(ilSlf) Then
                    ilFound = True
                    Exit For
                End If
            End If
        Next ilSlf
        If Not ilFound Then
            '9/10/13: Add Manager test if in same group
            If (tgUrf(0).iGroupNo > 0) Then
                'Manager?
                For ilSlf = LBound(tgMSlf) To UBound(tgMSlf) - 1 Step 1
                    If tgMSlf(ilSlf).iCode = tgUrf(0).iSlfCode Then
                        ilFound = True
                        If StrComp(tgMSlf(ilSlf).sJobTitle, "S", 1) = 0 Then
                            Exit Sub
                        End If
                    End If
                Next ilSlf
                If Not ilFound Then
                    Exit Sub
                End If
                ilFound = False
                For ilSlf = LBound(tmChf.iSlfCode) To UBound(tmChf.iSlfCode) Step 1
                    If tmChf.iSlfCode(ilSlf) <> 0 Then
                        For ilLoop = LBound(tgPopUrf) To UBound(tgPopUrf) - 1 Step 1
                            If tgPopUrf(ilLoop).iSlfCode = tmChf.iSlfCode(ilSlf) Then
                                If tgPopUrf(ilLoop).iGroupNo = tgUrf(0).iGroupNo Then
                                    ilFound = True
                                    Exit For
                                End If
                            End If
                        Next ilLoop
                        If ilFound Then
                            Exit For
                        End If
                    End If
                Next ilSlf
                If Not ilFound Then
                    Exit Sub
                End If
            Else
                Exit Sub
            End If
        End If
    End If

    If imGenCntrExport = True Then
        mSetExportCntrFlag tmChf.iSlfCode(0)
        If ((tmChf.lCntrNo >= tgSpf.lCLowestNo) And (imExportCntr)) Or ((tmChf.lCntrNo < tgSpf.lCLowestNo) And (Not imExportCntr)) Then
            ilFound = False
            For ilLoop = LBound(tgClusterErr) To UBound(tgClusterErr) - 1 Step 1
                If tmChf.lCntrNo = tgClusterErr(ilLoop).lCntrNo Then
                    ilFound = True
                    Exit For
                End If
            Next ilLoop
            If Not ilFound Then
                tgClusterErr(UBound(tgClusterErr)).lCntrNo = tmChf.lCntrNo
                tgClusterErr(UBound(tgClusterErr)).lChfCode = tmChf.lCode
                If tmChf.lCntrNo >= tgSpf.lCLowestNo Then
                    tgClusterErr(UBound(tgClusterErr)).iFlag = 2
                Else
                    tgClusterErr(UBound(tgClusterErr)).iFlag = 1
                End If
                ReDim Preserve tgClusterErr(0 To UBound(tgClusterErr) + 1) As CLUSTERERR
            End If
        End If
    End If

    If (tmClf.lChfCode <> tmChf.lCode) Or (tmClf.iLine <> tlSdfExt.iLineNo) Then
        tmClfSrchKey.lChfCode = tmChf.lCode
        tmClfSrchKey.iLine = tlSdfExt.iLineNo
        tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
        tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
        ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_NONE Then
            Exit Sub
        End If
        If (tmClf.lChfCode <> tmChf.lCode) Or (tmClf.iLine <> tlSdfExt.iLineNo) Then
            Exit Sub
        End If
    End If
    If (tmClf.sType = "O") Then
        ilPkLineNo = tmClf.iLine
    ElseIf (tmClf.sType = "A") Then
        ilPkLineNo = tmClf.iLine
    ElseIf (tmClf.sType = "E") Then
        ilPkLineNo = tmClf.iLine
    ElseIf (tmClf.sType = "H") Then
        ilPkLineNo = tmClf.iPkLineNo
    Else
        ilPkLineNo = 0
    End If

    slKey = mCreateField1Key(tmChf)

    'Advertiser
    'For ilLoop = LBound(tgCommAdf) To UBound(tgCommAdf) - 1 Step 1
    '    If tmChf.iAdfCode = tgCommAdf(ilLoop).iCode Then
        ilLoop = gBinarySearchAdf(tmChf.iAdfCode)
        If ilLoop <> -1 Then
            slKey = slKey & "|" & tgCommAdf(ilLoop).sName
    '        Exit For
        End If
    'Next ilLoop
    'Contract number
    slStr = Trim$(str$(tmChf.lCntrNo))
    Do While Len(slStr) < 8
        slStr = "0" & slStr
    Loop
    slKey = slKey & "|" & slStr
    'Either contract product or copy product
    ilBonusSpot = False
    If ilType = 0 Then
        If tlSdfExt.sSpotType = "X" Then
            ilBonusSpot = True
        End If
    ElseIf ilType = 1 Then
        'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tlSdfExt.lRecPos, INDEXKEY1, BTRV_LOCK_NONE)
        tmSmfSrchKey1.lCode = tlSdfExt.lCode
        ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_NONE Then
            Exit Sub
        End If
        tmSdfSrchKey3.lCode = tmSmf.lSdfCode
        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_NONE Then
            Exit Sub
        End If
        If tmSdf.sSpotType = "X" Then
            ilBonusSpot = True
        End If
    End If
    If tmChf.sInvGp = "P" Then  'By product-code later (for now use contract product)
        If ilType = 0 Then
            'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tlSdfExt.lRecPos, INDEXKEY1, BTRV_LOCK_NONE)
            tmSdfSrchKey3.lCode = tlSdfExt.lCode
            ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                Exit Sub
            End If
        ElseIf ilType = 1 Then
            'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tlSdfExt.lRecPos, INDEXKEY1, BTRV_LOCK_NONE)
            'tmSdfSrchKey3.lCode = tmSmf.lSdfCode
            'ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        Else
            tmSdf = tmPsf
        End If
        If (ilRet = BTRV_ERR_NONE) Then
            mObtainCopy slCopyProduct(), slCopy()
            If Trim$(slCopyProduct(1)) <> "" Then
                slKey = slKey & "|" & slCopyProduct(1)
            Else
                'If copy missing or product missing-> make product ~ plus blanks
                slCopyProduct(1) = "~     "
                slKey = slKey & "|" & slCopyProduct(1) 'tmChf.sProduct
            End If
        Else
            'If copy missing or product missing-> make product ~ plus blanks
            slCopyProduct(1) = "~     "
            slKey = slKey & "|" & slCopyProduct(1) 'tmChf.sProduct
        End If
    ElseIf tmChf.sInvGp = "T" Then  'By tag- code later (for now use contract product)
        'If copy missing or tag missing-> make product ~ plus blanks
        slKey = slKey & "|" & tmChf.sProduct
    Else
        slKey = slKey & "|" & tmChf.sProduct
    End If
    slPkLineType = ""
    If ilType = 0 Then
        If tmClf.sType = "H" Then
            'Get vehicle name from package line
            tmClfSrchKey.lChfCode = tmChf.lCode
            tmClfSrchKey.iLine = tmClf.iPkLineNo
            tmClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
            tmClfSrchKey.iPropVer = 32000 ' 0 show latest version
            ilRet = btrGetGreaterOrEqual(hmClf, tlClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
            If tmPkVef.iCode <> tlClf.iVefCode Then
                tmVefSrchKey.iCode = tlClf.iVefCode
                ilRet = btrGetEqual(hmVef, tmPkVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                If ilRet <> BTRV_ERR_NONE Then
                    tmPkVef.sName = "Vehicle Missing"
                    tmPkVef.iCode = tmClf.iVefCode
                End If
            End If
            slPkLineType = tlClf.sType
            tlVef = tmPkVef
            'slKey = slKey & "|" & tlVef.sName
            'Add vehicle name of package line incase no spots from package line
            slLnVehName = tlVef.sName
            ilFound = False
            For ilLoop = 0 To UBound(tgInvVehCode) - 1 Step 1
                'ilRet = gParseItem(Trim$(tgInvVehCode(ilLoop).sKey), 2, "\", slCode)
                If tgInvVehCode(ilLoop).iCode = tlVef.iCode Then
                    ilFound = True
                    Exit For
                End If
            Next ilLoop
            If Not ilFound Then
                tgInvVehCode(UBound(tgInvVehCode)).sKey = "000|000|" & tlVef.sName & "\" & Trim$(str$(tlVef.iCode))
                tgInvVehCode(UBound(tgInvVehCode)).iCode = tlVef.iCode
                ReDim Preserve tgInvVehCode(0 To UBound(tgInvVehCode) + 1) As VEHSORT
            End If
        Else
            'If O or G get vehicle from line
            If (tlSdfExt.sSchStatus = "O") Or (tlSdfExt.sSchStatus = "G") Then
                If tmLnVef.iCode <> tmClf.iVefCode Then
                    tmVefSrchKey.iCode = tmClf.iVefCode
                    ilRet = btrGetEqual(hmVef, tmLnVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        tmLnVef.sName = "Vehicle Missing"
                        tmLnVef.iCode = tmClf.iVefCode
                        For ilVeh = 0 To UBound(tgInvVehCode) - 1 Step 1 'lbcVehicle.ListCount - 1 Step 1
                            slNameCode = Trim$(tgInvVehCode(ilVeh).sKey)    'Traffic!lbcVehicle.List(ilVeh)
                            'ilRet = gParseItem(slNameCode, 2, "\", slCode)
                            ilVefCode = tgInvVehCode(ilVeh).iCode
                            If tmClf.iVefCode = ilVefCode Then
                                ilRet = gParseItem(slNameCode, 1, "\", slName)
                                ilRet = gParseItem(slName, 3, "|", slName)
                                tmLnVef.sName = slName
                                Exit For
                            End If
                        Next ilVeh
                    End If
                End If
                tlVef = tmLnVef
                'slKey = slKey & "|" & tlVef.sName
                slLnVehName = tlVef.sName
            Else
                If tmVef.iCode <> tmClf.iVefCode Then
                    If tmLnVef.iCode <> tmClf.iVefCode Then
                        tmVefSrchKey.iCode = tmClf.iVefCode
                        ilRet = btrGetEqual(hmVef, tmLnVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If ilRet <> BTRV_ERR_NONE Then
                            tmLnVef.sName = "Vehicle Missing"
                            tmLnVef.iCode = tmClf.iVefCode
                        End If
                    End If
                    tlVef = tmLnVef
                    'slKey = slKey & "|" & tlVef.sName
                    slLnVehName = tlVef.sName
                Else
                    'slKey = slKey & "|" & tmVef.sName
                    slLnVehName = tmVef.sName
                    tlVef = tmVef
                End If
            End If
        End If
    ElseIf ilType = 1 Then
        If tmClf.sType = "H" Then
            tmClfSrchKey.lChfCode = tmChf.lCode
            tmClfSrchKey.iLine = tmClf.iPkLineNo
            tmClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
            tmClfSrchKey.iPropVer = 32000 ' 0 show latest version
            ilRet = btrGetGreaterOrEqual(hmClf, tlClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
            If tmPkVef.iCode <> tlClf.iVefCode Then
                tmVefSrchKey.iCode = tlClf.iVefCode
                ilRet = btrGetEqual(hmVef, tmPkVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                If ilRet <> BTRV_ERR_NONE Then
                    tmPkVef.sName = "Vehicle Missing"
                    tmPkVef.iCode = tmClf.iVefCode
                End If
            End If
            slPkLineType = tlClf.sType
            tlVef = tmPkVef
            'slKey = slKey & "|" & tlVef.sName
            slLnVehName = tlVef.sName
        Else
            If tmVef.iCode <> tmClf.iVefCode Then
                If tmLnVef.iCode <> tmClf.iVefCode Then
                    tmVefSrchKey.iCode = tmClf.iVefCode
                    ilRet = btrGetEqual(hmVef, tmLnVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        tmLnVef.sName = "Vehicle Missing"
                        tmLnVef.iCode = tmClf.iVefCode
                    End If
                End If
                tlVef = tmLnVef
                'slKey = slKey & "|" & tlVef.sName
                slLnVehName = tlVef.sName
            Else
                'slKey = slKey & "|" & tmVef.sName
                slLnVehName = tmVef.sName
                tlVef = tmVef
            End If
        End If
    Else
        tmVefSrchKey.iCode = tlSdfExt.iVefCode
        If tlVef.iCode <> tlSdfExt.iVefCode Then
            ilRet = btrGetEqual(hmVef, tlVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        End If
        'slKey = slKey & "|" & tlVef.sName
        slLnVehName = tlVef.sName
    End If
    'If tgSpf.sBLaserForm <> "2" Then   'Sort within form 2
        'Sort Extra Bonus spots to end of all vehicles (lines)
        If ilType = 0 Then
            If (Not ilBonusSpot) Or (tgSpf.sBCombine = "N") Then
                slKey = slKey & "|" & slLnVehName
            Else
                slKey = slKey & "|" & smBlkVefName
            End If
        ElseIf ilType = 1 Then
            'slKey = slKey & "|" & slLnVehName
            If (Not ilBonusSpot) Or (tgSpf.sBCombine = "N") Then
                slKey = slKey & "|" & slLnVehName
            Else
                slKey = slKey & "|" & smBlkVefName
            End If
        Else
            slKey = slKey & "|" & slLnVehName
        End If
        If tmClf.sType = "H" Then
            slStr = Trim$(str$(tmClf.iPkLineNo))
        Else
            slStr = Trim$(str$(tlSdfExt.iLineNo))
        End If
        Do While Len(slStr) < 4
            slStr = "0" & slStr
        Loop
        slKey = slKey & "|" & slStr
        'Week number- sort virtual vehicles within same week together
        'gUnpackDateLong tlSdfExt.iDate(0), tlSdfExt.iDate(1), llDate
        gUnpackDateLongError tlSdfExt.iDate(0), tlSdfExt.iDate(1), llDate, "20:mCreateSortRec " & tlSdfExt.lCode
        slStr = Trim$(str$((llDate - llBaseDate) \ 7))
        Do While Len(slStr) < 4
            slStr = "0" & slStr
        Loop
        If (ilBonusSpot) And (tgSpf.sBCombine = "N") Then
            slStr = "{{{{"
        End If
        slKey = slKey & "|" & slStr
        'Sort Extra Bonus spots to end of week
        If ilType = 0 Then
            If Not ilBonusSpot Then
                slKey = slKey & "|" & "0"
            Else
                slKey = slKey & "|" & "1"
            End If
        ElseIf ilType = 1 Then
            'slKey = slKey & "|" & "0"
            If Not ilBonusSpot Then
                slKey = slKey & "|" & "0"
            Else
                slKey = slKey & "|" & "1"
            End If
        Else
            slKey = slKey & "|" & "0"
        End If
    'End If
    'Spot Vehicle name
    If Not ilBonusSpot Then
        If ((tgSpf.sInvAirOrder = "O") And (tgSpf.sBLaserForm <> "2")) Or (tgSpf.sInvAirOrder = "S") Then
            tlVef.sName = slLnVehName
        Else
            If tmVef.iCode = tlSdfExt.iVefCode Then
                tlVef = tmVef
            Else
                tmVefSrchKey.iCode = tlSdfExt.iVefCode
                ilRet = btrGetEqual(hmVef, tlVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                If ilRet <> BTRV_ERR_NONE Then
                    tlVef.sName = "Vehicle Missing"
                    tlVef.iCode = tlSdfExt.iVefCode
                End If
            End If
        End If
    Else
        If tmVef.iCode = tlSdfExt.iVefCode Then
            tlVef = tmVef
        Else
            tmVefSrchKey.iCode = tlSdfExt.iVefCode
            ilRet = btrGetEqual(hmVef, tlVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                tlVef.sName = "Vehicle Missing"
                tlVef.iCode = tlSdfExt.iVefCode
            End If
        End If
    End If
    slKey = slKey & "|" & tlVef.sName
    'Game Number
    If ilType = 0 Then
        If tmChf.sInvGp <> "P" Then  'By product-code later (for now use contract product)
            'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tlSdfExt.lRecPos, INDEXKEY1, BTRV_LOCK_NONE)
            tmSdfSrchKey3.lCode = tlSdfExt.lCode
            ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                tmSmfSrchKey2.lCode = tmSdf.lCode
                ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            End If
        End If
        ilGameNo = tmSdf.iGameNo
    Else
        ilGameNo = tmSmf.iGameNo
    End If
    ''If Show Order, then get original game number
    If ((tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) And ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) Then
        ilGameNo = tmSmf.iGameNo
    'Else
    '    ilGameNo = tmSdf.iGameNo
    End If
    slGameNo = Trim$(str$(ilGameNo))
    '6/30/12:  Allow 5 digit event #'s
    Do While Len(slGameNo) < 5  '3
        slGameNo = "0" & slGameNo
    Loop
    slKey = slKey & "|" & slGameNo
    'Date
    If tmSdf.sXCrossMidnight <> "Y" Then
        gUnpackDateForSort tlSdfExt.iDate(0), tlSdfExt.iDate(1), slDate
    Else
        gUnpackDate tlSdfExt.iDate(0), tlSdfExt.iDate(1), slDate
        '5/22/14: Adjust the airing date
        'slDate = gIncOneDay(slDate)
        slDate = mAdjXMidnightDate(slDate, slPkLineType, False, blAddComment52)
        gPackDate slDate, ilDate(0), ilDate(1)
        gUnpackDateForSort ilDate(0), ilDate(1), slDate
    End If
    slKey = slKey & "|" & slDate
    'Time
    gUnpackTimeLong tlSdfExt.iTime(0), tlSdfExt.iTime(1), False, llTime
    slStr = Trim$(str$(llTime))
    Do While Len(slStr) < 6
        slStr = "0" & slStr
    Loop
    'tgSortNoKey(ilUpper).sKey = slKey & "|" & slStr
    ilUpper = UBound(tgSortNoKey)
    slKey = slKey & "|" & slStr
    slStr = Trim$(str$(ilPkLineNo))
    Do While Len(slStr) < 4
        slStr = "0" & slStr
    Loop
    slKey = slKey & "|" & slStr
    slSvKey = slKey
    tgSortNoKey(ilUpper).lChfCode = tmChf.lCode
    tgSortNoKey(ilUpper).sInvGp = tmChf.sInvGp
    '12/27/08:  Added test so that Bonus spots will sort at end of other spots of same line with EDI.
    '           Using line number only caused record 41 not to appear all the times as required.
    '           Bonus spot sorted sometimes ahead of regular spots.
    '           Changing the WkDef test in InvoiceRpt did not fix the problem
    'If (tgSpf.sBLaserForm <> "2") Then
    If (tgSpf.sBLaserForm <> "2") Or (ilEDIFlag And (tmEDIArf.sSepInvByVeh = "Y") And (tgSpf.sBCombine <> "N") And (tgSpf.sBLaserForm = "2")) Then
        If ilType = 0 Then
            If Not ilBonusSpot Then
                tgSortNoKey(ilUpper).iLineNo = tlSdfExt.iLineNo
            Else
                tgSortNoKey(ilUpper).iLineNo = -1
            End If
        ElseIf ilType = 1 Then
            'tgSortNoKey(ilUpper).iLineNo = tlSdfExt.iLineNo
            If Not ilBonusSpot Then
                tgSortNoKey(ilUpper).iLineNo = tlSdfExt.iLineNo
            Else
                tgSortNoKey(ilUpper).iLineNo = -1
            End If
        Else
            tgSortNoKey(ilUpper).iLineNo = tlSdfExt.iLineNo
        End If
    Else
        tgSortNoKey(ilUpper).iLineNo = tlSdfExt.iLineNo
    End If
    tgSortNoKey(ilUpper).iType = ilType   '0=Sdf; 1=Smf; 2=Psf
    '10/5/14
    If tlSdfExt.sSchStatus = "Z" Then
        tgSortNoKey(ilUpper).iType = 3
    End If
    tgSortNoKey(ilUpper).iBilled = False
    tgSortNoKey(ilUpper).sPriceType = tlSdfExt.sPriceType
    tgSortNoKey(ilUpper).lCode = tlSdfExt.lCode
    tgSortNoKey(ilUpper).sType = tmVef.sType
    tgSortNoKey(ilUpper).iVefCode = tlSdfExt.iVefCode
    tgSortNoKey(ilUpper).iLen = tmClf.iLen
    tgSortNoKey(ilUpper).lCntrNo = tmChf.lCntrNo
    tgSortNoKey(ilUpper).sSchStatus = tlSdfExt.sSchStatus
    tgSortNoKey(ilUpper).sAdjAirTime = ""
    'Set missed bill flag
    tgSortNoKey(ilUpper).iBillMissed = False
    If (ilType = 0) And (tlSdfExt.sSchStatus = "M") Then
        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tlSdfExt.lRecPos, INDEXKEY1, BTRV_LOCK_NONE)
        tmSdfSrchKey3.lCode = tlSdfExt.lCode
        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        For ilLoop = LBound(tgMRMnf) To UBound(tgMRMnf) - 1 Step 1
            If tmSdf.iMnfMissed = tgMRMnf(ilLoop).iCode Then
                If tgMRMnf(ilLoop).iGroupNo = 2 Then
                    tgSortNoKey(ilUpper).iBillMissed = True
                End If
                Exit For
            End If
        Next ilLoop
    End If
    'Move up to get game number
    'If ilType = 0 Then
    '    If tmChf.sInvGp <> "P" Then  'By product-code later (for now use contract product)
    '        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tlSdfExt.lRecPos, INDEXKEY1, BTRV_LOCK_NONE)
    '        tmSdfSrchKey3.lCode = tlSdfExt.lCode
    '        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    '    End If
    'ElseIf ilType = 1 Then
    'End If
    tgSortNoKey(ilUpper).iSdfVefCode = tmSdf.iVefCode
    tlSort = tgSortNoKey(ilUpper)
    ilIncludeSpot = True
    If (tgSpf.sInvAirOrder = "2") And (ilType <> 2) Then
        'Don't include selling spots that are to be billed via airing vehicles- handled with bonus
        'For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
        '    If (tlSdfExt.iVefCode = tgMVef(ilVeh).iCode) Then
            ilVeh = gBinarySearchVef(tlSdfExt.iVefCode)
            If ilVeh <> -1 Then
                If (tgMVef(ilVeh).sType = "S") Then
                    ilVpfIndex = gVpfFind(Invoice, tlSdfExt.iVefCode)
                    If tgVpf(ilVpfIndex).sBillSA = "Y" Then
                        If (tmClf.sType = "H") Or (rbcType(INVGEN_Aff).Value) Then
                            ilIncludeSpot = False
                        End If
                    End If
                End If
        '        Exit For
            End If
        'Next ilVeh
    End If
    If ilIncludeSpot Then
        ilUpper = ilUpper + 1
        lbcKey.AddItem slKey
        lbcKey.ItemData(lbcKey.NewIndex) = ilUpper - 1
        ReDim Preserve tgSortNoKey(0 To ilUpper) As TYPESORTNOKEY
    End If
    If ilType <> 2 Then
        'If simulcast- create as bonus spot
        If (tlSdfExt.sSchStatus = "S") Or (tlSdfExt.sSchStatus = "G") Or (tlSdfExt.sSchStatus = "O") Or (tgSortNoKey(ilUpper).iBillMissed) Or ((tlSdfExt.sSchStatus = "M") And ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S"))) Then
            ilIncludeSpot = True
            'If (tgSpf.sInvAirOrder = "2") And ((tlSdfExt.sSchStatus = "G") Or (tlSdfExt.sSchStatus = "O")) Then
            If (tgSpf.sBLaserForm = "2") And ((tlSdfExt.sSchStatus = "G") Or (tlSdfExt.sSchStatus = "O")) Then
                'Test if air date within billing date (ignore missed part of MG)
                If ilType = 0 Then
                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tlSdfExt.lRecPos, INDEXKEY1, BTRV_LOCK_NONE)
                    tmSdfSrchKey3.lCode = tlSdfExt.lCode
                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                End If
                'gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llDate
                gUnpackDateLongError tmSdf.iDate(0), tmSdf.iDate(1), llDate, "21:mCreateSortRec " & tmSdf.lCode
                If tmChf.sBillCycle = "C" Then
                    If (llDate < llCalStartDate) Or (llDate > llCalEndDate) Then
                        ilIncludeSpot = False
                    Else
                        If Not imFullCal Then
                            gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                            If gDateValue(slDate) > llCalEndDate Then
                                ilIncludeSpot = False
                            End If
                        End If
                    End If
               ElseIf tmChf.sBillCycle = "W" Then
                    If (llDate < llWkStartDate) Or (llDate > llWkEndDate) Then
                        ilIncludeSpot = False
                    Else
                        If Not imFullWk Then
                            gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                            If gDateValue(slDate) > llWkEndDate Then
                                ilIncludeSpot = False
                            End If
                        End If
                    End If
                Else
                    If (llDate < llStdStartDate) Or (llDate > llStdEndDate) Then
                        ilIncludeSpot = False
                    Else
                        If Not imFullStd Then
                            gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                            If gDateValue(slDate) > llStdEndDate Then
                                ilIncludeSpot = False
                            End If
                        End If
                    End If
                End If
            End If
            If (rbcType(INVGEN_Aff).Value) And (tlSdfExt.sSchStatus = "M") Then  'Ignore missed spots on affidavits
                ilIncludeSpot = False
            ElseIf (rbcType(INVGEN_Aff).Value) And (ilType = 1) Then 'Ignore missed part of MG's on Affidavits
                ilIncludeSpot = False
            End If
            If ilIncludeSpot Then
                For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                    If (tlVef.iCode = tgMVef(ilVeh).iVefCode) And (tgMVef(ilVeh).sType = "T") And (tgMVef(ilVeh).sState = "A") Then
                        tgSortNoKey(ilUpper) = tlSort
                        slName = slSvKey
                        'Replace the 5th, and 9th fields
                        For ilLoop = LBONE To UBound(slFields) Step 1
                            ilRet = gParseItemNoTrim(slName, ilLoop, "|", slFields(ilLoop))    'Get application name
                        Next ilLoop
                        slFields(5) = smBlkVefName
                        slFields(6) = "-1"
                        slFields(9) = tgMVef(ilVeh).sName
                        slKey = slFields(1)
                        For ilLoop = LBONE + 1 To UBound(slFields) Step 1
                            slKey = slKey & "|" & slFields(ilLoop)
                        Next ilLoop
                        'tgSortNoKey(ilUpper).sKey = slKey
                        tgSortNoKey(ilUpper).iLineNo = -2
                        ilUpper = ilUpper + 1
                        lbcKey.AddItem slKey
                        lbcKey.ItemData(lbcKey.NewIndex) = ilUpper - 1
                        ReDim Preserve tgSortNoKey(0 To ilUpper) As TYPESORTNOKEY
                    End If
                Next ilVeh
                'If (tgSpf.sInvAirOrder = "2") Then
                If (tgSpf.sBLaserForm = "2") Then
                    'For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                    '    If (tlSdfExt.iVefCode = tgMVef(ilVeh).iCode) Then
                        ilVeh = gBinarySearchVef(tlSdfExt.iVefCode)
                        If ilVeh <> -1 Then
                            If (tgMVef(ilVeh).sType = "S") Then
                                ilVpfIndex = gVpfFind(Invoice, tlSdfExt.iVefCode)
                                If tgVpf(ilVpfIndex).sBillSA = "Y" Then
                                    If ilType = 0 Then
                                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tlSdfExt.lRecPos, INDEXKEY1, BTRV_LOCK_NONE)
                                        tmSdfSrchKey3.lCode = tlSdfExt.lCode
                                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                    End If
                                    mGetAvailDT llAvDate, llAvTime
                                    gPackTimeLong llAvTime, ilAvTime0, ilAvTime1
                                    ilDay = gWeekDayLong(llAvDate)
                                    If ilDay = 6 Then
                                        gObtainVlf "S", hmVLF, tlSdfExt.iVefCode, llDate, tmVlf7()
                                        ReDim tmVlf(LBound(tmVlf7) To UBound(tmVlf7)) As VLF
                                        For ilVlf = LBound(tmVlf7) To UBound(tmVlf7) Step 1
                                            tmVlf(ilVlf) = tmVlf7(ilVlf)
                                        Next ilVlf
                                    ElseIf ilDay = 5 Then   'Saturady
                                        gObtainVlf "S", hmVLF, tlSdfExt.iVefCode, llDate, tmVlf6()
                                        ReDim tmVlf(LBound(tmVlf6) To UBound(tmVlf6)) As VLF
                                        For ilVlf = LBound(tmVlf6) To UBound(tmVlf6) Step 1
                                            tmVlf(ilVlf) = tmVlf6(ilVlf)
                                        Next ilVlf
                                    Else
                                        gObtainVlf "S", hmVLF, tlSdfExt.iVefCode, llDate, tmVlf0()
                                        ReDim tmVlf(LBound(tmVlf0) To UBound(tmVlf0)) As VLF
                                        For ilVlf = LBound(tmVlf0) To UBound(tmVlf0) Step 1
                                            tmVlf(ilVlf) = tmVlf0(ilVlf)
                                        Next ilVlf
                                    End If
                                    For ilVlf = LBound(tmVlf) To UBound(tmVlf) - 1 Step 1
                                        If (ilAvTime0 = tmVlf(ilVlf).iSellTime(0)) And (ilAvTime1 = tmVlf(ilVlf).iSellTime(1)) Then
                                            tgSortNoKey(ilUpper) = tlSort
                                            slName = slSvKey
                                            'Replace the 5th, and 9th fields
                                            For ilLoop = LBONE To UBound(slFields) Step 1
                                                ilRet = gParseItemNoTrim(slName, ilLoop, "|", slFields(ilLoop))    'Get application name
                                            Next ilLoop
                                            slFields(5) = smBlkVefName
                                            slFields(6) = "-1"
                                            'For ilVeh1 = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                                            '    If tgMVef(ilVeh1).iCode = tmVlf(ilVlf).iAirCode Then
                                                ilVeh1 = gBinarySearchVef(tmVlf(ilVlf).iAirCode)
                                                If ilVeh1 <> -1 Then
                                                    slFields(9) = tgMVef(ilVeh1).sName
                                            '        Exit For
                                                End If
                                            'Next ilVeh1
                                            gUnpackTimeLong tmVlf(ilVlf).iAirTime(0), tmVlf(ilVlf).iAirTime(1), False, llTime
                                            slStr = Trim$(str$(llTime))
                                            Do While Len(slStr) < 6
                                                slStr = "0" & slStr
                                            Loop
                                            slFields(12) = slStr
                                            slKey = slFields(1)
                                            For ilLoop = LBONE + 1 To UBound(slFields) Step 1
                                                slKey = slKey & "|" & slFields(ilLoop)
                                            Next ilLoop
                                            'tgSortNoKey(ilUpper).sKey = slKey
                                            tgSortNoKey(ilUpper).iLineNo = -2
                                            ilUpper = ilUpper + 1
                                            lbcKey.AddItem slKey
                                            lbcKey.ItemData(lbcKey.NewIndex) = ilUpper - 1
                                            ReDim Preserve tgSortNoKey(0 To ilUpper) As TYPESORTNOKEY
                                        End If
                                    Next ilVlf
                                End If
                            End If
                    '        Exit For
                        End If
                    'Next ilVeh
                End If
            End If
        End If
    End If
    mCreateISR True
    ilUpper = UBound(tgSortNoKey)
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mDatePop                        *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Populate box with               *
'*                     previously months dates invoiced*
'*                                                     *
'*******************************************************
Private Sub mDatePop()
    Dim llLastStd As Long
    Dim llLastCal As Long
    Dim llEarliestDate As Long
    Dim slDate As String
    Dim llDate As Long
    'Dim ilMonth As Integer
    'Dim ilYear As Integer
    Dim slName As String
    Dim ilLoop As Integer
    Dim ilRet As Integer
    Dim slNameCode As String
    Dim slCode As String
    Dim ilVefCode As Integer
    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    llEarliestDate = -1
    gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slDate
    llLastStd = gDateValue(slDate)
    gUnpackDate tgSpf.iBLastCalMnth(0), tgSpf.iBLastCalMnth(1), slDate
    llLastCal = gDateValue(slDate)
    ilRet = gPopUserVehicleBox(Invoice, VEHCONV_WO_FEED + VEHCONV_W_FEED + VEHSELLING + VEHVIRTUAL + ACTIVEVEH + DORMANTVEH, lbcVehicle, tmInvVehicle(), smInvVehicleTag)
    For ilLoop = 0 To UBound(tmInvVehicle) - 1 Step 1 'Traffic!lbcVehicle.ListCount - 1 To 0 Step -1
        slNameCode = tmInvVehicle(ilLoop).sKey    'Traffic!lbcVehicle.List(ilLoop)
        ilRet = gParseItem(slNameCode, 1, "\", slName)    'Get application name
        ilRet = gParseItem(slName, 3, "|", slName)    'Get application name
        ilRet = gParseItem(slNameCode, 2, "\", slCode)    'Get application name
        ilVefCode = Val(slCode)
        'tmLcfSrchKey.iType = 0
        'tmLcfSrchKey.sStatus = "C"  ' Current
        'tmLcfSrchKey.iVefCode = ilVefCode
        'slDate = Format$("1/1/95", "m/d/yy")
        'gPackDate slDate, tmLcfSrchKey.iLogDate(0), tmLcfSrchKey.iLogDate(1)
        'tmLcfSrchKey.iSeqNo = 0
        'ilRet = btrGetGreaterOrEqual(hmLcf, tmLcf, imLcfRecLen, tmLcfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        'If (ilRet = BTRV_ERR_NONE) And (tmLcf.iVefCode = ilVefCode) And (tmLcf.sStatus = "C") And (tmLcf.iType = 0) Then
        tmLcfSrchKey2.iVefCode = ilVefCode
        slDate = Format$("1/1/95", "m/d/yy")
        gPackDate slDate, tmLcfSrchKey2.iLogDate(0), tmLcfSrchKey2.iLogDate(1)
        ilRet = btrGetGreaterOrEqual(hmLcf, tmLcf, imLcfRecLen, tmLcfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        If (ilRet = BTRV_ERR_NONE) And (tmLcf.iVefCode = ilVefCode) And (tmLcf.sStatus = "C") Then
            'gUnpackDateLong tmLcf.iLogDate(0), tmLcf.iLogDate(1), llDate
            gUnpackDateLongError tmLcf.iLogDate(0), tmLcf.iLogDate(1), llDate, "22:mDatePop-Lcf "
            If llEarliestDate = -1 Then
                llEarliestDate = llDate
            ElseIf llDate < llEarliestDate Then
                llEarliestDate = llDate
            End If
        End If
    Next ilLoop
    If (UBound(tmInvVehicle) <= 0) Or (llEarliestDate = -1) Then
        llDate = gDateValue("1/1/1970")
        gPackDateLong llDate, tmRvfSrchKey3.iTranDate(0), tmRvfSrchKey3.iTranDate(1)
        ilRet = btrGetGreaterOrEqual(hmPhf, tmRvf, imRvfRecLen, tmRvfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        Do While (ilRet = BTRV_ERR_NONE)
            If (tmRvf.sTranType = "IN") Then
                'gUnpackDateLong tmRvf.iTranDate(0), tmRvf.iTranDate(1), llEarliestDate
                gUnpackDateLongError tmRvf.iTranDate(0), tmRvf.iTranDate(1), llEarliestDate, "23:mDatePop " & tmRvf.lCode
                Exit Do
            End If
            ilRet = btrGetNext(hmPhf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        Loop
    End If
    If (UBound(tmInvVehicle) <= 0) Or (llEarliestDate = -1) Then
        llDate = gDateValue("1/1/1970")
        gPackDateLong llDate, tmRvfSrchKey3.iTranDate(0), tmRvfSrchKey3.iTranDate(1)
        ilRet = btrGetGreaterOrEqual(hmRvf, tmRvf, imRvfRecLen, tmRvfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        Do While (ilRet = BTRV_ERR_NONE)
            If (tmRvf.sTranType = "IN") Then
                'gUnpackDateLong tmRvf.iTranDate(0), tmRvf.iTranDate(1), llEarliestDate
                gUnpackDateLongError tmRvf.iTranDate(0), tmRvf.iTranDate(1), llEarliestDate, "24:mDatePop " & tmRvf.lCode
                Exit Do
            End If
            ilRet = btrGetNext(hmRvf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        Loop
    End If
    gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slDate
    'Use Now date if greater then last broadcast date for NTR
    If lmNowDate > gDateValue(slDate) Then
        slDate = Format$(lmNowDate, "m/d/yy")
    End If
    If (slDate <> "") And (llEarliestDate > 0) Then
        slCode = slDate
        slDate = gObtainEndStd(slDate)
        llDate = gDateValue(slDate)
        Do While llDate > llEarliestDate
            slDate = Format$(llDate, "m/d/yy")
            slName = gMonthYearFormat(slDate)
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'lbcDates.AddItem slName
            cbcDates.AddItem slName
            slDate = gObtainStartStd(slDate)
            llDate = gDateValue(slDate) - 1
        Loop
        slDate = slCode
        slDate = gObtainEndStd(slDate)
        slDate = gObtainPrevMonday(slDate)
        llDate = gDateValue(slDate)
        Do While llDate > llEarliestDate
            slDate = Format$(llDate, "m/d/yy")
            'lbcWeek.AddItem slDate
            cbcWeek.AddItem slDate
            slDate = gDecOneWeek(slDate)
            llDate = gDateValue(slDate)
        Loop
    End If
    Screen.MousePointer = vbDefault
    gSetMousePointer grdAirTime, grdRevenue, vbDefault
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mClearIvr                       *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Initiate fields                 *
'*                                                     *
'*******************************************************
Private Sub mDeleteISR()
    Dim ilRet As Integer
    Dim llDate As Long
    Dim llTime As Long
    Dim llLastIsrCode As Long
    llLastIsrCode = -1
    gPackDate smGenDate, tmIsrSrchKey1.iGenDate(0), tmIsrSrchKey1.iGenDate(1)
    gPackTime smGenTime, tmIsrSrchKey1.iGenTime(0), tmIsrSrchKey1.iGenTime(1)
    tmIsrSrchKey1.iType = 0
    tmIsrSrchKey1.lCode = 0
    ilRet = btrGetGreaterOrEqual(hmIsr, tmIsr, imIsrRecLen, tmIsrSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While ilRet = BTRV_ERR_NONE
        'gUnpackDateLong tmIsr.iGenDate(0), tmIsr.iGenDate(1), llDate
        gUnpackDateLongError tmIsr.iGenDate(0), tmIsr.iGenDate(1), llDate, "25:mDeleteISR " & tmIsr.lCode
        If lmGenDate <> llDate Then
            Exit Do
        End If
        gUnpackTimeLong tmIsr.iGenTime(0), tmIsr.iGenTime(1), False, llTime
        If lmGenTime <> llTime Then
            Exit Do
        End If
        If llLastIsrCode = tmIsr.lCode Then
            Exit Do
        End If
        llLastIsrCode = tmIsr.lCode
        ilRet = btrDelete(hmIsr)
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            Print #hmMsg, "mDeleteISR: btrDelete-Point 1, Isr Error # " & Trim$(str$(ilRet))
        End If
        gPackDate smGenDate, tmIsrSrchKey1.iGenDate(0), tmIsrSrchKey1.iGenDate(1)
        gPackTime smGenTime, tmIsrSrchKey1.iGenTime(0), tmIsrSrchKey1.iGenTime(1)
        tmIsrSrchKey1.iType = 0
        tmIsrSrchKey1.lCode = 0
        ilRet = btrGetGreaterOrEqual(hmIsr, tmIsr, imIsrRecLen, tmIsrSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Loop
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mDetInvoiceNo                   *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Determine Invoice Number       *
'*                                                     *
'*******************************************************
Private Function mDetInvoiceNo(ilPass As Integer, llStartSortIndex As Long, llEndSortIndex As Long, llTax1 As Long, llTax2 As Long) As Long
    'Dim ilLoop As Integer
    'Dim llInvoiceNo As Long
    'For ilLoop = 0 To UBound(lmRPCntrNo) - 1 Step 1
    '    If tgSpf.sBCombine = "N" Then
    '        If (lmRPCntrNo(ilLoop) = tmChf.lCntrNo) And (imRPVefCode(ilLoop) = tgSortKey(llStartSortIndex).iVefCode) Then
    '            If ilPass = 1 Then
    '                If (smRPCashTrade(ilLoop) = "C") Then
    '                    llInvoiceNo = lmRPInvNo(ilLoop)
    '                    Exit For
    '                End If
    '            Else
    '                If (smRPCashTrade(ilLoop) = "T") Then
    '                    llInvoiceNo = lmRPInvNo(ilLoop)
    '                    Exit For
    '                End If
    '            End If
    '        End If
    '    Else
    '        If lmRPCntrNo(ilLoop) = tmChf.lCntrNo Then
    '            If ilPass = 1 Then
    '                'If (lmRPCntrNo(ilLoop) = tmChf.lCntrNo) And (smRPCashTrade(ilLoop) = "C") Then
    '                If (smRPCashTrade(ilLoop) = "C") Then
    '                    llInvoiceNo = lmRPInvNo(ilLoop)
    '                    Exit For
    '                End If
    '            Else
    '                'If (lmRPCntrNo(ilLoop) = tmChf.lCntrNo) And (smRPCashTrade(ilLoop) = "T") Then
    '                If (smRPCashTrade(ilLoop) = "T") Then
    '                    llInvoiceNo = lmRPInvNo(ilLoop)
    '                    Exit For
    '                End If
    '            End If
    '        End If
    '    End If
    'Next ilLoop
    'mDetInvoiceNo = llInvoiceNo
    'Called to get Air Time invoice number
    Dim ilLoop As Integer
    Dim llInvoiceNo As Long
    Dim llSort As Long
    Dim slPkLineNo As String
    Dim ilPkLineNo As Integer
    Dim ilRet As Integer
    '9/11/09: Handle Real Packages which have rvf.iPkLineNo = 0
    Dim slLineNo As String
    Dim ilLineNo As Integer
    
    llInvoiceNo = 0
    For llSort = llStartSortIndex To llEndSortIndex Step 1
        If (tgSortKey(llSort).iLineNo <> -1) And (tgSortKey(llSort).iLineNo <> -2) Then
            For ilLoop = 0 To UBound(tmRPInfo) - 1 Step 1
                If (tmRPInfo(ilLoop).iMnfItem = 0) Or (tmRPInfo(ilLoop).iMnfItem = -1) Then   'Air time or Both
                    If tgSpf.sBCombine = "N" Then
                        ilRet = gParseItem(tgSortKey(llSort).sKey, 13, "|", slPkLineNo)
                        ilPkLineNo = Val(slPkLineNo)
                        If ilPkLineNo > 0 Then
                            '9/11/09: Handle Real Packages which have rvf.iPkLineNo = 0
                            'If (tmRPInfo(ilLoop).lCntrNo = tmChf.lCntrNo) And (tmRPInfo(ilLoop).iPkLineNo = ilPkLineNo) Then
                            '    If ilPass = 1 Then
                            '        If (tmRPInfo(ilLoop).sCashTrade = "C") Then
                            '            llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                            '            llTax1 = tmRPInfo(ilLoop).lAirTax1
                            '            llTax2 = tmRPInfo(ilLoop).lAirTax2
                            '            Exit For
                            '        End If
                            '    Else
                            '        If (tmRPInfo(ilLoop).sCashTrade = "T") Then
                            '            llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                            '            llTax1 = tmRPInfo(ilLoop).lAirTax1
                            '            llTax2 = tmRPInfo(ilLoop).lAirTax2
                            '            Exit For
                            '        End If
                            '    End If
                            'End If
                            If (tmRPInfo(ilLoop).lCntrNo = tmChf.lCntrNo) Then
                                If tmRPInfo(ilLoop).iPkLineNo > 0 Then
                                    If (tmRPInfo(ilLoop).iPkLineNo = ilPkLineNo) Then
                                        If ilPass = 1 Then
                                            If (tmRPInfo(ilLoop).sCashTrade = "C") Then
                                                llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                                                llTax1 = tmRPInfo(ilLoop).lAirTax1
                                                llTax2 = tmRPInfo(ilLoop).lAirTax2
                                                Exit For
                                            End If
                                        Else
                                            If (tmRPInfo(ilLoop).sCashTrade = "T") Then
                                                llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                                                llTax1 = tmRPInfo(ilLoop).lAirTax1
                                                llTax2 = tmRPInfo(ilLoop).lAirTax2
                                                Exit For
                                            End If
                                        End If
                                    End If
                                Else
                                    
                                    tmClfSrchKey.lChfCode = tmChf.lCode
                                    tmClfSrchKey.iLine = ilPkLineNo
                                    tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
                                    tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
                                    ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                    If (ilRet = BTRV_ERR_NONE) And (tmClf.lChfCode = tmChf.lCode) And (tmClf.iLine = ilPkLineNo) Then
                                        If tmClf.sType = "A" Then
                                            'Get spot to get airing vehicle and Line no
                                            tmClfSrchKey.lChfCode = tmChf.lCode
                                            tmClfSrchKey.iLine = tgSortKey(llSort).iLineNo
                                            tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
                                            tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
                                            ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                            If (ilRet = BTRV_ERR_NONE) And (tmClf.lChfCode = tmChf.lCode) And (tmClf.iLine = tgSortKey(llSort).iLineNo) Then
                                                If (tmClf.iPkLineNo = ilPkLineNo) And (tmRPInfo(ilLoop).iBillVefCode = tmClf.iVefCode) Then
                                                    If ilPass = 1 Then
                                                        If (tmRPInfo(ilLoop).sCashTrade = "C") Then
                                                            llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                                                            llTax1 = tmRPInfo(ilLoop).lAirTax1
                                                            llTax2 = tmRPInfo(ilLoop).lAirTax2
                                                            Exit For
                                                        End If
                                                    Else
                                                        If (tmRPInfo(ilLoop).sCashTrade = "T") Then
                                                            llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                                                            llTax1 = tmRPInfo(ilLoop).lAirTax1
                                                            llTax2 = tmRPInfo(ilLoop).lAirTax2
                                                            Exit For
                                                        End If
                                                    End If
                                                End If
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        Else
                            If (tmRPInfo(ilLoop).lCntrNo = tmChf.lCntrNo) And (tmRPInfo(ilLoop).iAirVefCode = tgSortKey(llSort).iVefCode) And (tmRPInfo(ilLoop).iPkLineNo = 0) Then
                                If ilPass = 1 Then
                                    If (tmRPInfo(ilLoop).sCashTrade = "C") Then
                                        llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                                        llTax1 = tmRPInfo(ilLoop).lAirTax1
                                        llTax2 = tmRPInfo(ilLoop).lAirTax2
                                        Exit For
                                    End If
                                Else
                                    If (tmRPInfo(ilLoop).sCashTrade = "T") Then
                                        llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                                        llTax1 = tmRPInfo(ilLoop).lAirTax1
                                        llTax2 = tmRPInfo(ilLoop).lAirTax2
                                        Exit For
                                    End If
                                End If
                            End If
                        End If
                    Else
                        If tmRPInfo(ilLoop).lCntrNo = tmChf.lCntrNo Then
                            If ilPass = 1 Then
                                'If (lmRPCntrNo(ilLoop) = tmChf.lCntrNo) And (smRPCashTrade(ilLoop) = "C") Then
                                If (tmRPInfo(ilLoop).sCashTrade = "C") Then
                                    llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                                    llTax1 = tmRPInfo(ilLoop).lAirTax1
                                    llTax2 = tmRPInfo(ilLoop).lAirTax2
                                    Exit For
                                End If
                            Else
                                'If (lmRPCntrNo(ilLoop) = tmChf.lCntrNo) And (smRPCashTrade(ilLoop) = "T") Then
                                If (tmRPInfo(ilLoop).sCashTrade = "T") Then
                                    llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                                    llTax1 = tmRPInfo(ilLoop).lAirTax1
                                    llTax2 = tmRPInfo(ilLoop).lAirTax2
                                    Exit For
                                End If
                            End If
                        End If
                    End If
                End If
            Next ilLoop
            If llInvoiceNo <> 0 Then
                Exit For
            End If
        End If
    Next llSort
    mDetInvoiceNo = llInvoiceNo
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mEDIStartEnd                    *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: EDI Records associated with    *
'*                      of a station                   *
'*                                                     *
'*******************************************************
Private Sub mEDIStationEnd(ilEDIUpper As Integer, ilPass As Integer, slEDITotalRate As String, slEDITotalAirRate As String, slAgyRate As String, slEDITotalAired As String, ilEDITotalNoInv As Integer)
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilFound                       ilInfo                                                  *
'******************************************************************************************
    Dim ilPos As Integer
    Dim slStr As String
    Dim slTotalNet As String
    Dim slAgyComm As String
    Dim ilLoop As Integer
    Dim slVehicleName As String
    Dim slEDILnIndex As String
    Dim slEDISpotIndex As String
    Dim slPrevVehicleName As String
    Dim ilPrevEDILnIndex As Integer
    Dim ilRet As Integer
    Dim ilEDI As Integer
    Dim ilVef As Integer
    Dim ilVpf As Integer
    Dim ilXMidIndex As Integer
    Dim il25Index As Integer
    Dim il33Index As Integer
    Dim il34Index As Integer
    Dim slCallLetters As String
    Dim ilSpotCount As Integer
    Dim ilCount As Integer
    Dim slCountVehicleName As String
    Dim slCountLnIndex As String
    Dim slBonus As String
    Dim slGross As String
    Dim slNet As String
    Dim slSpotRate As String
    Dim slMediaType As String

    ilXMidIndex = -1
    If bmAddXMidMessage Then
        smEDIRecords(ilEDIUpper) = "33;" & smXMidMsgBottom & ";"
        ilXMidIndex = ilEDIUpper
        ilEDIUpper = ilEDIUpper + 1
        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
    End If
    If slAgyRate = "" Then
        slTotalNet = slEDITotalAirRate
        slAgyComm = "0"
    Else
        slStr = gDivStr(gMulStr(slEDITotalAirRate, gSubStr("100.00", slAgyRate)), "100.00")
        slTotalNet = gAddStr(slTotalNet, slStr)
        slAgyComm = gSubStr(slEDITotalAirRate, slTotalNet)
    End If
    il33Index = -1
    If smHeaderComment <> "" Then
        smEDIRecords(ilEDIUpper) = "33;" & Left$(smHeaderComment, 129) & ";"
        il33Index = ilEDIUpper
        ilEDIUpper = ilEDIUpper + 1
        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
    End If
    il25Index = -1
    If ilPass = 2 Then
        'TTP 10582 - Spot Data EDI: request to remove "trade reciprocal agreement"
        If StrComp(Trim$(tmEDIArf.sID), "SpotData", vbTextCompare) = 0 Then
            'suppress record 25 entirely from the Spot Data form of the export. I think we should leave record 25 for the other forms.
        Else
            smEDIRecords(ilEDIUpper) = "25;" & "** Trade Reciprocal Agreement **" & ";"
            il25Index = ilEDIUpper
            ilEDIUpper = ilEDIUpper + 1
            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
        End If
    End If
    slEDITotalAired = gAddStr(slEDITotalAired, slEDITotalAirRate)
    If imEDIIndex >= 0 Then
        tgEDIServiceInfo(imEDIIndex).sTotalAired = gAddStr(tgEDIServiceInfo(imEDIIndex).sTotalAired, slEDITotalAirRate)
    End If
    'ilEDITotalNoInv = ilEDITotalNoInv + 1
    ilPos = InStr(slEDITotalRate, ".")
    If ilPos > 0 Then
        slStr = Left$(slEDITotalRate, ilPos - 1) & Mid$(slEDITotalRate, ilPos + 1)
    Else
        slStr = slEDITotalRate
    End If
    il34Index = ilEDIUpper
    smEDIRecords(ilEDIUpper) = "34;" & slStr & ";"
    ilPos = InStr(slEDITotalAirRate, ".")
    If ilPos > 0 Then
        slStr = Left$(slEDITotalAirRate, ilPos - 1) & Mid$(slEDITotalAirRate, ilPos + 1)
    Else
        slStr = slEDITotalAirRate
    End If
    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slStr & ";"
    ilPos = InStr(slAgyComm, ".")
    If ilPos > 0 Then
        slStr = Left$(slAgyComm, ilPos - 1) & Mid$(slAgyComm, ilPos + 1)
    Else
        slStr = slAgyComm
    End If
    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slStr & ";"
    ilPos = InStr(slTotalNet, ".")
    If ilPos > 0 Then
        slStr = Left$(slTotalNet, ilPos - 1) & Mid$(slTotalNet, ilPos + 1)
    Else
        slStr = slTotalNet
    End If
    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slStr & ";"
    ilEDIUpper = ilEDIUpper + 1
    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
    If ((tmEDIArf.sSepInvByVeh = "Y") And (tgSpf.sBCombine <> "N")) Then
        slMediaType = Trim$(tgSpf.sEDIMediaType)
        If Trim$(tmEDIArf.sEDIMediaType) <> "" Then
            slMediaType = Trim$(tmEDIArf.sEDIMediaType)
        End If
        'Resort records by Vehicle; Line #; EDI Record index
        If UBound(smEDIByVehSort) - 1 > 0 Then
            ArraySortTyp fnAV(smEDIByVehSort(), 0), UBound(smEDIByVehSort), 0, LenB(smEDIByVehSort(0)), 0, LenB(smEDIByVehSort(0).sKey), 0
        End If
        slPrevVehicleName = ""
        ilPrevEDILnIndex = -1
        slGross = "0.00"
        For ilLoop = 0 To UBound(smEDIByVehSort) - 1 Step 1
            ilRet = gParseItem(smEDIByVehSort(ilLoop).sKey, 1, "|", slVehicleName)
            slVehicleName = Trim$(slVehicleName)
            ilRet = gParseItem(smEDIByVehSort(ilLoop).sKey, 2, "|", slEDILnIndex)
            ilRet = gParseItem(smEDIByVehSort(ilLoop).sKey, 3, "|", slEDISpotIndex)
            If slPrevVehicleName <> slVehicleName Then
                If slPrevVehicleName <> "" Then
                    'Output record 33, 25 and 34;
                    If ilXMidIndex <> -1 Then
                        Print #hmEDI, smEDIRecords(ilXMidIndex)
                    End If
                    If il33Index <> -1 Then
                        Print #hmEDI, smEDIRecords(il33Index)
                    End If
                    If il25Index <> -1 Then
                        Print #hmEDI, smEDIRecords(il25Index)
                    End If
                    If il34Index <> -1 Then
                        'Compute Net and Agency commision
                        If slAgyRate = "" Then
                            slNet = slGross
                            slAgyComm = "0"
                        Else
                            slNet = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                            slAgyComm = gSubStr(slGross, slNet)
                        End If
                        ilPos = InStr(slGross, ".")
                        If ilPos > 0 Then
                            slStr = Left$(slGross, ilPos - 1) & Mid$(slGross, ilPos + 1)
                        Else
                            slStr = slGross
                        End If
                        smEDIRecords(il34Index) = "34;" & slStr & ";"
                        smEDIRecords(il34Index) = smEDIRecords(il34Index) & slStr & ";"
                        ilPos = InStr(slAgyComm, ".")
                        If ilPos > 0 Then
                            slStr = Left$(slAgyComm, ilPos - 1) & Mid$(slAgyComm, ilPos + 1)
                        Else
                            slStr = slAgyComm
                        End If
                        smEDIRecords(il34Index) = smEDIRecords(il34Index) & slStr & ";"
                        ilPos = InStr(slNet, ".")
                        If ilPos > 0 Then
                            slStr = Left$(slNet, ilPos - 1) & Mid$(slNet, ilPos + 1)
                        Else
                            slStr = slNet
                        End If
                        smEDIRecords(il34Index) = smEDIRecords(il34Index) & slStr & ";"
                        Print #hmEDI, smEDIRecords(il34Index)
                        If ilLoop = UBound(smEDIByVehSort) Then
                            Exit For
                        End If
                        slGross = "0.00"
                    End If
                End If
                'Output 21-32
                For ilEDI = 0 To UBound(smEDIRecords) - 1 Step 1
                    slStr = Left(smEDIRecords(ilEDI), 2)
                    If (Val(slStr) <= 32) And (Val(slStr) <> 25) Then
                        If Val(slStr) = 21 Then
                            ilEDITotalNoInv = ilEDITotalNoInv + 1
                            If imEDIIndex >= 0 Then
                                tgEDIServiceInfo(imEDIIndex).iTotalNoInv = tgEDIServiceInfo(imEDIIndex).iTotalNoInv + 1
                            End If
                        End If
                        If Val(slStr) = 22 Then
                            For ilVef = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                                If StrComp(Trim$(tgMVef(ilVef).sName), slVehicleName, vbTextCompare) = 0 Then
                                    ilVpf = gBinarySearchVpf(tgMVef(ilVef).iCode)
                                    Exit For
                                End If
                            Next ilVef
                            If ilVpf <> -1 Then
                                slCallLetters = ""
                                If Trim$(tgVpf(ilVpf).sEDICallLetters) = "" Then
                                    mAddViewListMsg 1, tmChf.lCntrNo, Trim$(slVehicleName) & " EDI Call Letters Missing"
                                    smEDIRecords(ilEDI) = "22;" & Trim$(tgSpf.sEDICallLetter) & ";" & slMediaType & ";" & Trim$(tgSpf.sEDIBand) & ";" & Trim$(Left$(tgSpf.sGClient, 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(0), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(1), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(2), 30)) & ";;" & "CSI" & ";"
                                Else
                                    slCallLetters = Trim$(tgVpf(ilVpf).sEDICallLetters)
                                    If Trim$(tgVpf(ilVpf).sEDIBand) = "" Then
                                        smEDIRecords(ilEDI) = "22;" & Trim$(tgVpf(ilVpf).sEDICallLetters) & ";" & slMediaType & ";" & Trim$(tgSpf.sEDIBand) & ";" & Trim$(Left$(tgSpf.sGClient, 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(0), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(1), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(2), 30)) & ";;" & "CSI" & ";"
                                        If Trim$(tgSpf.sEDIBand) <> "" Then
                                            slCallLetters = slCallLetters & "-" & Trim$(tgSpf.sEDIBand)
                                        End If
                                    Else
                                        smEDIRecords(ilEDI) = "22;" & Trim$(tgVpf(ilVpf).sEDICallLetters) & ";" & slMediaType & ";" & Trim$(tgVpf(ilVpf).sEDIBand) & "M" & ";" & Trim$(Left$(tgSpf.sGClient, 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(0), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(1), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(2), 30)) & ";;" & "CSI" & ";"
                                        slCallLetters = slCallLetters & "-" & Trim$(tgVpf(ilVpf).sEDIBand) & "M"
                                    End If
                                End If
                            End If
                        End If
                        Print #hmEDI, smEDIRecords(ilEDI)
                        If Val(slStr) > 32 Then
                            Exit For
                        End If
                    End If
                Next ilEDI
                slPrevVehicleName = slVehicleName
            End If
            If ilPrevEDILnIndex <> Val(slEDILnIndex) Then
                'Find 41
                ilEDI = Val(slEDILnIndex)
                slStr = Left(smEDIRecords(ilEDI), 2)
                If Val(slStr) = 41 Then
                    ilRet = gParseItem(smEDIRecords(ilEDI), 7, ";", slSpotRate)
                    'Adjust spot count
                    ilSpotCount = 1
                    For ilCount = ilLoop + 1 To UBound(smEDIByVehSort) - 1 Step 1
                        ilRet = gParseItem(smEDIByVehSort(ilCount).sKey, 1, "|", slCountVehicleName)
                        slCountVehicleName = Trim$(slCountVehicleName)
                        ilRet = gParseItem(smEDIByVehSort(ilCount).sKey, 2, "|", slCountLnIndex)
                        If (StrComp(slVehicleName, slCountVehicleName, vbTextCompare) = 0) And (Val(slCountLnIndex) = ilEDI) Then
                            ilRet = gParseItem(smEDIByVehSort(ilCount).sKey, 4, "|", slBonus)
                            If slBonus <> "Y" Then
                                ilSpotCount = ilSpotCount + 1
                            End If
                        Else
                            Exit For
                        End If
                    Next ilCount
                    'Field Eight is spot count, replace it
                    ilCount = 0
                    ilPos = 1
                    slStr = smEDIRecords(ilEDI)
                    Do While ilCount < 7
                        ilPos = InStr(ilPos, slStr, ";", vbTextCompare) + 1
                        ilCount = ilCount + 1
                    Loop
                    slStr = Left(slStr, ilPos - 1) & Trim$(str$(ilSpotCount))
                    ilPos = InStr(ilPos, smEDIRecords(ilEDI), ";", vbTextCompare)
                    slStr = slStr & Mid(smEDIRecords(ilEDI), ilPos)
                    Print #hmEDI, slStr 'smEDIRecords(ilEDI)
                    slStr = Left(smEDIRecords(ilEDI + 1), 2)
                    If Val(slStr) = 42 Then
                        Print #hmEDI, smEDIRecords(ilEDI + 1)
                    End If
                End If
            End If
            ilPrevEDILnIndex = Val(slEDILnIndex)
            ilEDI = Val(slEDISpotIndex)
            slStr = Left(smEDIRecords(ilEDI), 2)
            If Val(slStr) = 51 Then
                ilRet = gParseItem(smEDIRecords(ilEDI), 8, ";", slSpotRate)
                If Len(slSpotRate) > 1 Then
                    slSpotRate = Left$(slSpotRate, Len(slSpotRate) - 2) & "." & right(slSpotRate, 2)
                End If
                slGross = gAddStr(slGross, slSpotRate)
                Print #hmEDI, smEDIRecords(ilEDI)
                slStr = Left(smEDIRecords(ilEDI + 1), 2)
                If Val(slStr) = 52 Then
                    If (InStr(1, smEDIRecords(ilEDI + 1), slCallLetters, vbTextCompare) <= 0) Or (slCallLetters = "") Then
                        Print #hmEDI, smEDIRecords(ilEDI + 1)
                    End If
                End If
            End If
        Next ilLoop
        If UBound(smEDIByVehSort) > 0 Then
            If ilXMidIndex <> -1 Then
                Print #hmEDI, smEDIRecords(ilXMidIndex)
            End If
            If il33Index <> -1 Then
                Print #hmEDI, smEDIRecords(il33Index)
            End If
            If il25Index <> -1 Then
                Print #hmEDI, smEDIRecords(il25Index)
            End If
            If il34Index <> -1 Then
                'Compute Net and Agency commision
                If slAgyRate = "" Then
                    slNet = slGross
                    slAgyComm = "0"
                Else
                    slNet = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                    slAgyComm = gSubStr(slGross, slNet)
                End If
                ilPos = InStr(slGross, ".")
                If ilPos > 0 Then
                    slStr = Left$(slGross, ilPos - 1) & Mid$(slGross, ilPos + 1)
                Else
                    slStr = slGross
                End If
                smEDIRecords(il34Index) = "34;" & slStr & ";"
                smEDIRecords(il34Index) = smEDIRecords(il34Index) & slStr & ";"
                ilPos = InStr(slAgyComm, ".")
                If ilPos > 0 Then
                    slStr = Left$(slAgyComm, ilPos - 1) & Mid$(slAgyComm, ilPos + 1)
                Else
                    slStr = slAgyComm
                End If
                smEDIRecords(il34Index) = smEDIRecords(il34Index) & slStr & ";"
                ilPos = InStr(slNet, ".")
                If ilPos > 0 Then
                    slStr = Left$(slNet, ilPos - 1) & Mid$(slNet, ilPos + 1)
                Else
                    slStr = slNet
                End If
                smEDIRecords(il34Index) = smEDIRecords(il34Index) & slStr & ";"
                Print #hmEDI, smEDIRecords(il34Index)
            End If
        End If
    Else
        ilEDITotalNoInv = ilEDITotalNoInv + 1
        If imEDIIndex >= 0 Then
            tgEDIServiceInfo(imEDIIndex).iTotalNoInv = tgEDIServiceInfo(imEDIIndex).iTotalNoInv + 1
        End If
        'Output records
        For ilLoop = 0 To UBound(smEDIRecords) - 1 Step 1
            'Print #hmEDI, smEDIRecords(ilLoop) & Chr(21);
            '2/12/03- replace Chr(21) with C/R, Line Feed.  This is a ABC request
            Print #hmEDI, smEDIRecords(ilLoop)
        Next ilLoop
    End If
    ReDim smEDIRecords(0 To 0) As String
    ReDim smEDIByVehSort(0 To 0) As SORTCODE
    ilEDIUpper = 0
    slEDITotalRate = ".00"
    slEDITotalAirRate = ".00"
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mEDIStartStart                  *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: EDI Records associated with    *
'*                      of a station                   *
'*                                                     *
'*******************************************************
Private Sub mEDIStationStart(ilEDIUpper As Integer, ilVefCode As Integer, slSInvDate As String, slCInvDate As String, slWInvDate As String, llInvoiceNo As Long, slSBMonth As String, slCBMonth As String, slWBMonth As String, slStdSDate As String, slStdEDate As String, slCalSDate As String, slCalEDate As String, slWkSDate As String, slWkEDate As String)
    Dim ilVpfIndex As Integer
    Dim slStr As String
    Dim ilVefLockBox As Integer
    Dim slEstNo As String
    Dim ilRet As Integer
    Dim ilVeh As Integer
    Dim slMsg As String
    Dim slMediaType As String

    bmAddXMidMessage = False
    ilEDIUpper = 0
    ReDim smEDIRecords(0 To ilEDIUpper) As String
    If tmChf.iAgfCode > 0 Then
        If tmAgf.iArfInvCode > 0 Then
            If Trim$(tmAgf.sBillAddr(0)) = "" Then
                smEDIRecords(ilEDIUpper) = "21;" & Trim$(tmAgf.sCodeStn) & ";" & Trim$(Left$(tmAgf.sName, 25)) & ";" & Trim$(Left$(tmAgf.sCntrAddr(0), 30)) & ";" & Trim$(Left$(tmAgf.sCntrAddr(1), 30)) & ";" & Trim$(Left$(tmAgf.sCntrAddr(2), 30)) & ";;"
            Else
                smEDIRecords(ilEDIUpper) = "21;" & Trim$(tmAgf.sCodeStn) & ";" & Trim$(Left$(tmAgf.sName, 25)) & ";" & Trim$(Left$(tmAgf.sBillAddr(0), 30)) & ";" & Trim$(Left$(tmAgf.sBillAddr(1), 30)) & ";" & Trim$(Left$(tmAgf.sBillAddr(2), 30)) & ";;"
            End If
        End If
    Else
        If tmAdf.iArfInvCode > 0 Then
            If Trim$(tmAdf.sBillAddr(0)) = "" Then
                smEDIRecords(ilEDIUpper) = "21;" & Trim$(tmAdf.sCodeStn) & ";" & Trim$(Left$(tmAdf.sName, 25)) & ";" & Trim$(Left$(tmAdf.sCntrAddr(0), 30)) & ";" & Trim$(Left$(tmAdf.sCntrAddr(1), 30)) & ";" & Trim$(Left$(tmAdf.sCntrAddr(2), 30)) & ";;"
            Else
                smEDIRecords(ilEDIUpper) = "21;" & Trim$(tmAdf.sCodeStn) & ";" & Trim$(Left$(tmAdf.sName, 25)) & ";" & Trim$(Left$(tmAdf.sBillAddr(0), 30)) & ";" & Trim$(Left$(tmAdf.sBillAddr(1), 30)) & ";" & Trim$(Left$(tmAdf.sBillAddr(2), 30)) & ";;"
            End If
        End If
    End If
    ilEDIUpper = ilEDIUpper + 1
    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
    'Station
    'smEDIRecords(ilEDIUpper) = "22;ABC;X;FM;" & Trim$(Left$(tgSpf.sGClient, 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(0), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(1), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(2), 30)) & ";;" & "CSI" & ";"
    slMediaType = Trim$(tgSpf.sEDIMediaType)
    If Trim$(tmEDIArf.sEDIMediaType) <> "" Then
        slMediaType = Trim$(tmEDIArf.sEDIMediaType)
    End If
    If ilVefCode <= 0 Then
        smEDIRecords(ilEDIUpper) = "22;" & Trim$(tgSpf.sEDICallLetter) & ";" & slMediaType & ";" & Trim$(tgSpf.sEDIBand) & ";" & Trim$(Left$(tgSpf.sGClient, 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(0), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(1), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(2), 30)) & ";;" & "CSI" & ";"
    Else
        ilVpfIndex = gVpfFind(Invoice, ilVefCode)
        If Trim$(tgVpf(ilVpfIndex).sEDICallLetters) = "" Then
            If Trim$(tgSpf.sEDICallLetter) = "" Then
                ilVeh = gBinarySearchVef(ilVefCode)
                If ilVeh <> -1 Then
                    slMsg = Trim$(tgMVef(ilVeh).sName) & " EDI Call Letters Missing"
                Else
                    slMsg = "EDI Call Letters Missing"
                End If
                mAddViewListMsg 1, tmChf.lCntrNo, slMsg
            End If
            smEDIRecords(ilEDIUpper) = "22;" & Trim$(tgSpf.sEDICallLetter) & ";" & slMediaType & ";" & Trim$(tgSpf.sEDIBand) & ";" & Trim$(Left$(tgSpf.sGClient, 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(0), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(1), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(2), 30)) & ";;" & "CSI" & ";"
        Else
            If Trim$(tgVpf(ilVpfIndex).sEDIBand) = "" Then
                smEDIRecords(ilEDIUpper) = "22;" & Trim$(tgVpf(ilVpfIndex).sEDICallLetters) & ";" & slMediaType & ";" & Trim$(tgSpf.sEDIBand) & ";" & Trim$(Left$(tgSpf.sGClient, 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(0), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(1), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(2), 30)) & ";;" & "CSI" & ";"
            Else
                smEDIRecords(ilEDIUpper) = "22;" & Trim$(tgVpf(ilVpfIndex).sEDICallLetters) & ";" & slMediaType & ";" & Trim$(tgVpf(ilVpfIndex).sEDIBand) & "M" & ";" & Trim$(Left$(tgSpf.sGClient, 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(0), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(1), 30)) & ";" & Trim$(Left$(tgSpf.sGAddr(2), 30)) & ";;" & "CSI" & ";"
            End If
        End If
    End If
    ilEDIUpper = ilEDIUpper + 1
    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
    'Payee
    'If tmChf.iAgfCode > 0 Then
    '    If Trim$(tmAgf.sBillAddr(0)) = "" Then
    '        smEDIRecords(ilEDIUpper) = "23;" & Trim$(Left$(tmAgf.sName, 25)) & ";" & Trim$(Left$(tmAgf.sCntrAddr(0), 30)) & ";" & Trim$(Left$(tmAgf.sCntrAddr(1), 30)) & ";" & Trim$(Left$(tmAgf.sCntrAddr(2), 30)) & ";;"
    '    Else
    '        smEDIRecords(ilEDIUpper) = "23;" & Trim$(Left$(tmAgf.sName, 25)) & ";" & Trim$(Left$(tmAgf.sBillAddr(0), 30)) & ";" & Trim$(Left$(tmAgf.sBillAddr(1), 30)) & ";" & Trim$(Left$(tmAgf.sBillAddr(2), 30)) & ";;"
    '    End If
    'Else
    '    If Trim$(tmAdf.sBillAddr(0)) = "" Then
    '        smEDIRecords(ilEDIUpper) = "23;" & Trim$(Left$(tmAdf.sName, 25)) & ";" & Trim$(Left$(tmAdf.sCntrAddr(0), 30)) & ";" & Trim$(Left$(tmAdf.sCntrAddr(1), 30)) & ";" & Trim$(Left$(tmAdf.sCntrAddr(2), 30)) & ";;"
    '    Else
    '        smEDIRecords(ilEDIUpper) = "23;" & Trim$(Left$(tmAdf.sName, 25)) & ";" & Trim$(Left$(tmAdf.sBillAddr(0), 30)) & ";" & Trim$(Left$(tmAdf.sBillAddr(1), 30)) & ";" & Trim$(Left$(tmAdf.sBillAddr(2), 30)) & ";;"
    '    End If
    'End If
    ilVefLockBox = mGetVefLockBox(tmChf)
    If Not ilVefLockBox Then
        If tmChf.iAgfCode > 0 Then
            'TTP 10404 - Invoice: blank lock box address being shown after adding new lock box
            If tmAgf.iArfLkCode > 0 Then
                If tmArfSrchKey.iCode <> tmAgf.iArfLkCode Then
                    tmArfSrchKey.iCode = tmAgf.iArfLkCode
                    ilRet = btrGetEqual(hmArf, tmArf, imArfRecLen, tmArfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        tmArf.sNmAd(0) = "Missing"
                        tmArf.sNmAd(1) = " "
                        tmArf.sNmAd(2) = " "
                        tmArf.sNmAd(3) = " "
                    End If
                End If
                smEDIRecords(ilEDIUpper) = "23;" & Trim$(Left$(tmArf.sNmAd(0), 30)) & ";" & Trim$(Left$(tmArf.sNmAd(1), 30)) & ";" & Trim$(Left$(tmArf.sNmAd(2), 30)) & ";" & Trim$(Left$(tmArf.sNmAd(3), 30)) & ";;"
            Else
                smEDIRecords(ilEDIUpper) = "23;" & Trim$(Left$(tgSpf.sBPayName, 30)) & ";" & Trim$(Left$(tgSpf.sBPayAddr(0), 30)) & ";" & Trim$(Left$(tgSpf.sBPayAddr(1), 30)) & ";" & Trim$(Left$(tgSpf.sBPayAddr(2), 30)) & ";;"
            End If
        Else
            If tmAdf.iArfLkCode > 0 Then
                'v81 testing results 3-28-22 - Issue 2: direct advertiser is not showing the lockbox on the invoice and EDI invoice form.
                If tmArfSrchKey.iCode <> tmAdf.iArfLkCode Then
                    tmArfSrchKey.iCode = tmAdf.iArfLkCode
                    ilRet = btrGetEqual(hmArf, tmArf, imArfRecLen, tmArfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        tmArf.sNmAd(0) = "Missing"
                        tmArf.sNmAd(1) = " "
                        tmArf.sNmAd(2) = " "
                        tmArf.sNmAd(3) = " "
                    End If
                End If
                smEDIRecords(ilEDIUpper) = "23;" & Trim$(Left$(tmArf.sNmAd(0), 30)) & ";" & Trim$(Left$(tmArf.sNmAd(1), 30)) & ";" & Trim$(Left$(tmArf.sNmAd(2), 30)) & ";" & Trim$(Left$(tmArf.sNmAd(3), 30)) & ";;"
            Else
                smEDIRecords(ilEDIUpper) = "23;" & Trim$(Left$(tgSpf.sBPayName, 30)) & ";" & Trim$(Left$(tgSpf.sBPayAddr(0), 30)) & ";" & Trim$(Left$(tgSpf.sBPayAddr(1), 30)) & ";" & Trim$(Left$(tgSpf.sBPayAddr(2), 30)) & ";;"
            End If
        End If
    Else
        smEDIRecords(ilEDIUpper) = "23;" & Trim$(Left$(tmArf.sNmAd(0), 30)) & ";" & Trim$(Left$(tmArf.sNmAd(1), 30)) & ";" & Trim$(Left$(tmArf.sNmAd(2), 30)) & ";" & Trim$(Left$(tmArf.sNmAd(3), 30)) & ";;"
    End If
    ilEDIUpper = ilEDIUpper + 1
    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
    'Invoice Header
    slEstNo = Trim$(tmChf.sAgyEstNo) & Trim$(tmChf.sTitle)
    slEstNo = right$(slEstNo, 10)
    smEDIRecords(ilEDIUpper) = "31;;" & Trim$(Left$(tmSlf.sFirstName, 1)) & " " & Trim$(Left$(tmSlf.sLastName, 23)) & ";" & Trim$(Left$(tmAdf.sName, 25)) & ";" & Trim$(Left$(tmChf.sProduct, 25)) & ";"
    If (tmChf.sBillCycle = "C") Or (tmChf.sBillCycle = "T") Then
        'smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slCInvDate & ";;" & Trim$(tmChf.sAgyEstNo) & Trim$(tmChf.sTitle) & ";" & Trim$(str$(llInvoiceNo)) & ";" & slCBMonth & ";" & slCalSDate & ";" & slCalEDate & ";;;"
        'Donovan only allows estimate numbers of 10 characters
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slCInvDate & ";;" & Trim$(slEstNo) & ";" & Trim$(str$(llInvoiceNo)) & ";" & slCBMonth & ";" & slCalSDate & ";" & slCalEDate & ";;;"
    ElseIf (tmChf.sBillCycle = "W") Then
        'smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slCInvDate & ";;" & Trim$(tmChf.sAgyEstNo) & Trim$(tmChf.sTitle) & ";" & Trim$(str$(llInvoiceNo)) & ";" & slCBMonth & ";" & slCalSDate & ";" & slCalEDate & ";;;"
        'Donovan only allows estimate numbers of 10 characters
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slWInvDate & ";;" & Trim$(slEstNo) & ";" & Trim$(str$(llInvoiceNo)) & ";" & slWBMonth & ";" & slWkSDate & ";" & slWkEDate & ";;;"
    Else
        'smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slSInvDate & ";;" & Trim$(tmChf.sAgyEstNo) & Trim$(tmChf.sTitle) & ";" & Trim$(str$(llInvoiceNo)) & ";" & slSBMonth & ";" & slStdSDate & ";" & slStdEDate & ";;;"
        'Donovan only allows estimate numbers of 10 characters
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slSInvDate & ";;" & Trim$(slEstNo) & ";" & Trim$(str$(llInvoiceNo)) & ";" & slSBMonth & ";" & slStdSDate & ";" & slStdEDate & ";;;"
    End If
    gUnpackDate tmChf.iStartDate(0), tmChf.iStartDate(1), slStr
    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & Format$(gDateValue(slStr), "yymmdd") & ";"
    gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slStr
    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & Format$(gDateValue(slStr), "yymmdd") & ";;;"
    If tmChf.iAgfCode > 0 Then
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & "Y;"
    Else
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & "N;"
    End If

    If ((tmEDIArf.sSepInvByVeh = "Y") And (tgSpf.sBCombine <> "N")) Then
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";;" & Trim$(str$(tmChf.lCntrNo)) & ";" & Trim$(str$(tmChf.lCntrNo)) & ";;"
    Else
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";;;" & Trim$(str$(tmChf.lCntrNo)) & ";;"
    End If
    
    smEDIClientCode = ""
    smEDIProductCode = ""
    If tmChf.lEffCode > 0 Then
        tmEffSrchKey.lCode = tmChf.lEffCode
        ilRet = btrGetEqual(hmEff, tmEff, imEffRecLen, tmEffSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If ilRet = BTRV_ERR_NONE Then
            smEDIClientCode = tmEff.sString(0)
            smEDIProductCode = tmEff.sString(1)
        End If
    End If
    
    'If tmChf.iAgfCode > 0 Then
    '    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & Trim$(Left$(tmAgf.sCodeRep, 8)) & ";;" & Trim$(Left$(tmAdf.sCodeRep, 8)) & ";"
    'Else
    '    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";;" & Trim$(Left$(tmAdf.sCodeRep, 8)) & ";"
    'End If
    If (smEDIClientCode <> "") And (smEDIProductCode <> "") Then
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & Trim$(Left$(smEDIClientCode, 8)) & ";;" & Trim$(Left$(smEDIProductCode, 8)) & ";"
    ElseIf (smEDIClientCode <> "") Then
        'smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & Trim$(Left$(smEDIClientCode, 8)) & ";;" & Trim$(Left$(tmAdf.sCodeRep, 8)) & ";"
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & Trim$(Left$(smEDIClientCode, 8)) & ";;" & "" & ";"
    ElseIf (smEDIProductCode <> "") Then
        'If tmChf.iAgfCode > 0 Then
        '    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & Trim$(Left$(tmAgf.sCodeRep, 8)) & ";;" & Trim$(Left$(smEDIProductCode, 8)) & ";"
        'Else
        '    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";;" & Trim$(Left$(smEDIProductCode, 8)) & ";"
        'End If
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & "" & ";;" & Trim$(Left$(smEDIProductCode, 8)) & ";"
    Else
        'If tmChf.iAgfCode > 0 Then
        '    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & Trim$(Left$(tmAgf.sCodeRep, 8)) & ";;" & Trim$(Left$(tmAdf.sCodeRep, 8)) & ";"
        'Else
        '    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";;" & Trim$(Left$(tmAdf.sCodeRep, 8)) & ";"
        'End If
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & "" & ";;" & "" & ";"
    End If
    tmPnfSrchKey.iCode = tmChf.iPnfBuyer
    ilRet = btrGetEqual(hmPnf, tmPnf, imPnfRecLen, tmPnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If ilRet = BTRV_ERR_NONE Then
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";" & Trim$(Left$(tmPnf.sName, 25)) & ";"
    Else
        smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";" & "" & ";"
    End If
    ilEDIUpper = ilEDIUpper + 1
    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mAirTime_InvEnd                  *
'*                                                     *
'*             Created:3/01/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: End of invoice processing      *
'*                      Code removed from mInvoiceRpt  *
'*                      to make room                   *
'*                                                     *
'*******************************************************
Private Sub mAirTime_InvEnd(ilPreview As Integer, ilErrorFlag As Integer, slFileName As String, llInvoiceNo As Long, slGTOrdered As String, slGTReconc As String, slGTAired As String, slGTComm As String, slGTNet As String, ilEDITotalNoInv As Integer, slEDITotalAired As String, ilImpactPrt As Integer)
    Dim ilLLRet As Integer
    Dim slStr As String
    Dim ilPos As Integer
    Dim slDisplay As String
    Dim ilRet As Integer
    '4/3/12
    Dim ilEDI As Integer
    Dim slTotalAired As String
    
    gUserActivityLog "E", "Invoice: Prepass Air Time"
    If rbcType(INVGEN_Final).Value Then
        If igUsedISR = False Then
            'DL 11/19/01- removed code- add ilRet =
            ''10-31-01 plcUpdating.Caption = "Updating Receivables"
            'smplcUpdating = "Updating Receivables"
            'plcUpdating.Visible = True
            'DoEvents
            'ilRet = mUpdateInv()
            'plcUpdating.Visible = False
            'DoEvents
            ilRet = BTRV_ERR_NONE
            'DL 11/19/01
        Else
            ilRet = BTRV_ERR_NONE
        End If
        'If ilRet = BTRV_ERR_NONE Then
        '    ilRet = mUpdateDates(llInvoiceNo)
        'End If
    End If
    If rbcOutput(0).Value Then
        slDisplay = "D"
    Else
        slDisplay = "P"
    End If
    igRptCallType = INVOICESJOB
    'If tgSpf.sInvAirOrder = "2" Then
    If tgSpf.sBLaserForm = "2" Then
        igRptType = 2
    Else
        igRptType = 0
    End If
    'Start Crystal report
    igChildDone = False 'edcLinkDestDoneMsg.Text = ""
    edcLinkSrceDoneMsg.Text = ""
    If (Not igStdAloneMode) And (imShowHelpMsg) Then
        If igTestSystem Then
            slStr = "Invoice^Test\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & smGenDate & "\" & smGenTime & "\" & slDisplay
        Else
            slStr = "Invoice^Prod\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & smGenDate & "\" & smGenTime & "\" & slDisplay
        End If
    Else
        If igTestSystem Then
            slStr = "Invoice^Test^NOHELP\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & smGenDate & "\" & smGenTime & "\" & slDisplay
        Else
            slStr = "Invoice^Prod^NOHELP\" & sgUserName & "\" & Trim$(str$(igRptCallType)) & "\" & Trim$(str$(igRptType)) & "\" & smGenDate & "\" & smGenTime & "\" & slDisplay
        End If
    End If
    If (tgSpf.sBLaserForm = "2") Then
        If rbcType(INVGEN_Aff).Value Then
            slStr = slStr & "\2"    'affidavit
        Else
            slStr = slStr & "\1"    'invoice without spot
        End If
    ElseIf (tgSpf.sBLaserForm = "3") Then
        slStr = slStr & "\3"        'combined invoice
    ElseIf (tgSpf.sBLaserForm = "4") Then        '3-8-12  3-col aired
        slStr = slStr & "\7"
    Else
        slStr = slStr & "\0"        'three column invoice
    End If
smStartInvRpt = Format$(Now, "h:mm:ssAM/PM")
    sgCommandStr = slStr & "\" & sgInvMonthYear & "\"
    If (Asc(tgSaf(0).sFeatures8) And PODADSERVER) <> PODADSERVER Then  'Payment on Collection
        If Not imCombineAirAndNTR Then
            gUserActivityLog "S", "Invoice: Output Air Time"
            RptSelIn.Show vbModal
            gUserActivityLog "E", "Invoice: Output Air Time"
        End If
    End If
smEndInvRpt = Format$(Now, "h:mm:ssAM/PM")
    If (tgSpf.sAEDII = "Y") Then    'EDI Service
        ReDim smEDIRecords(0 To 0) As String
        ReDim smEDIByVehSort(0 To 0) As SORTCODE
        '4/3/12: Output totals by Service
        For ilEDI = 0 To UBound(tgEDIServiceInfo) - 1 Step 1
            hmEDI = tgEDIServiceInfo(ilEDI).hEDI
            If tgEDIServiceInfo(ilEDI).sUsed = "Y" Then
                smEDIRecords(0) = "12;" & Trim$(str$(tgEDIServiceInfo(ilEDI).iTotalNoInv)) & ";"
                slTotalAired = Trim$(tgEDIServiceInfo(ilEDI).sTotalAired)
                ilPos = InStr(slTotalAired, ".")
                If ilPos > 0 Then
                    slStr = Left$(slTotalAired, ilPos - 1) & Mid$(slTotalAired, ilPos + 1)
                Else
                    slStr = slTotalAired
                End If
                smEDIRecords(0) = smEDIRecords(0) & slStr & ";"
                'Print #hmEDI, smEDIRecords(0) & Chr(21);
                '2/12/03- replace Chr(21) with C/R, Line Feed.  This is a ABC request
                Print #hmEDI, smEDIRecords(0)
            End If
        Next ilEDI
    End If
    If Not imUsingCrystal Then
        'in case of preview: show the preview
        If ilPreview <> 0 Then
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            If ilErrorFlag = 0 Then
'VB6**          ilDummy = LlPreviewDisplay(hdJob, slFileName, sgRptSavePath, Invoice.hWnd)
            Else
                mErrMsg ilErrorFlag
            End If
            Screen.MousePointer = vbHourglass
            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
'VB6**      ilDummy = LlPreviewDeleteFiles(hdJob, slFileName, sgRptSavePath)
            If rbcType(INVGEN_Final).Value Then
                If ilLLRet = 0 Then
                    Screen.MousePointer = vbHourglass
                    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                    DoEvents
                    'mUpdateInv llInvoiceNo
                    Screen.MousePointer = vbHourglass
                    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                Else
                    ilErrorFlag = ilLLRet
                    mErrMsg ilErrorFlag
                End If
            End If
        Else
            If ilLLRet = 0 Then
                Screen.MousePointer = vbHourglass
                gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                DoEvents
                'mUpdateInv llInvoiceNo
                Screen.MousePointer = vbHourglass
                gSetMousePointer grdAirTime, grdRevenue, vbHourglass
            Else
                ilErrorFlag = ilLLRet
                mErrMsg ilErrorFlag
            End If
        End If
    Else
        'mUpdateInv llInvoiceNo
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mErrMsg                         *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Translate Micro Help error code *
'*                                                     *
'*******************************************************
Private Sub mErrMsg(ilError As Integer)
    Dim slMsg As String
    If (ilError = -99) Or (ilError = 0) Then
        Exit Sub
    End If
    Select Case ilError
        Case -1
            slMsg = "Invalid Job Handle"
        Case -2
            slMsg = "Only One Designer Active Allowed"
        Case -3
            slMsg = "Invalid Project Type"
        Case -4
            slMsg = "Print function called without Print Job Opened"
        Case -5
            slMsg = "LLPrintSetBoxText called without Print Job Opened"
        Case -6
            slMsg = "Multi-Printing Not Allowed"
        Case -10
            slMsg = "LLPrintStart or LLPrintWithBoxStart called without Print Job Opened"
        Case -11
            slMsg = "Print Device could not be opened"
        Case -12
            slMsg = "Error while printing (could be insufficient disk space, paper jam or missing DLL)"
        Case -13
            slMsg = "An application can only have one Job Open"
        Case -14
            slMsg = "Visula Basic DLL missing"
        Case -15
            slMsg = "No Printer available"
        Case -16
            slMsg = "No Preview mode set"
        Case -17
            slMsg = "No Preview files found"
        Case -18
            slMsg = "Parameter call error"
        Case -19
            slMsg = "Expression in LLExprEvaluate could not be interpreted"
        Case -20
            slMsg = "Unknown expression-mode in LLSetOption"
        Case -21
            slMsg = "No table defined with LL_PROJECT_LIST"
        Case -22
            slMsg = "Project file not found"
        Case -23
            slMsg = "Expression error"
        Case -24
            slMsg = "Project file has wrong format"
        Case -25
            slMsg = "LLPrintEnableObject- object name is invalid"
        Case -26
            slMsg = "LLPrintEnableObject- project has no objects"
        Case -27
            slMsg = "LLPrintEnableObject- no object with name defined"
        Case -28
            slMsg = "LLPrint...Start- no table in the table mode"
        Case -29
            slMsg = "LLPrint...Start- project has no objects"
        Case -30
            slMsg = "LLPrintGetTextCharsPrinted- no text object"
        Case -31
            slMsg = "Variable does not exist"
        Case -32
            slMsg = "Field function used although the project is not a table object"
        Case -33
            slMsg = "Expression mode error"
        Case -34
            slMsg = "Error code error error"
        Case -35
            slMsg = "Variable not defined"
        Case -36
            slMsg = "Field not defined"
        Case -37
            slMsg = "Sorting order not defined"
        Case -99
            slMsg = "User Aborted printing"
        Case -100
            slMsg = "DLL required are in error"
        Case -101
            slMsg = "Required Language DLL missing"
        Case -102
            slMsg = "Memory problems"
    End Select
    slMsg = "Report Error #" & Trim$(str$(ilError)) & ": " & slMsg
    MsgBox slMsg, vbOKOnly, "Report Error"
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mFinishOutput                   *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Finish Output                   *
'*                                                     *
'*******************************************************
Private Sub mFinishOutput(slTotalNoPerWk As String, slTotalRate As String, ilImpactPrt As Integer, slTotalAirCount As String, ilPass As Integer, ilStartPass As Integer, slTGNoSpots As String, slTotalAirRate As String, slAgyRate As String, slAgyComm As String, slTotalNet As String, slGTNet As String, slGTComm As String, ilEDIFlag As Integer, ilEDIUpper As Integer, slTotalMissedRate As String, slTotalMissedRateNonPkg As String, slGTOrdered As String, slGTReconc As String, slGTAired As String, slEDITotalAired As String, ilEDITotalNoInv As Integer)
    Dim slStr As String
    Dim ilLoop As Integer
    'Dim ilPos As Integer
    Dim ilRet As Integer
    'Dim llMissed As Long
    Dim llAdjDollar As Long
    Dim ilTest As Long

    If imUsingCrystal Then
        mClearIvr False, True, True
        If smForm2Key = "" Then     'No spot found
            Exit Sub
        End If
        tmIvr.iType = IVRTYPE_TotalAirtimeRep 'AirTime or REP Total
        tmIvr.lOTotalSpots = Val(slTotalNoPerWk)
        tmIvr.lOTotalGross = gStrDecToLong(slTotalRate, 2)
        'Change to use air totals
        'If tgSpf.sInvAirOrder = "2" Then    'Adjust for missed on Standard lines
        '    llMissed = gStrDecToLong(slTotalMissedRateNonPkg, 2)
        '    If llMissed <> 0 Then
        '        tmIvr.lOTotalGross = tmIvr.lOTotalGross + llMissed
        '    End If
        'End If
        'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81
        'Fix TTP 10826 / TTP 10813 - RE: v81 TTP 10826 - updated test results Issue #4
        mSetAirNTRStatus tgChfInv.lCntrNo, "AIR", IIF(tgChfInv.iAgfCode = 0, tgChfInv.iAdfCode, tgChfInv.iAgfCode)
        
        tmIvr.lATotalSpots = Val(slTotalAirCount)
        tmIvr.lATotalGross = gStrDecToLong(slTotalAirRate, 2)
        tmIvr.lRTotalGross = gStrDecToLong(slTotalMissedRate, 2)
        tmIvr.lSpotKeyNo = tmIvr.lSpotKeyNo + 1
        'If Show Order, check dollars and adjust if sum of hidden lines plus conventional lines
        'is not equal to total from package line flights plus conventional line flights
        If (tgSpf.sInvAirOrder = "S") Or (tgSpf.sInvAirOrder = "O") Then
            llAdjDollar = tmIvr.lOTotalGross - tmIvr.lATotalGross
            If llAdjDollar > 0 Then
                For ilLoop = 0 To UBound(tgRvfByVef) - 1 Step 1
                    If tgRvfByVef(ilLoop).iPkLineNo > 0 Then
                        If gStrDecToLong(tgRvfByVef(ilLoop).sTotalGross, 2) > llAdjDollar Then
                            tgRvfByVef(ilLoop).sTotalGross = gAddStr(tgRvfByVef(ilLoop).sTotalGross, gLongToStrDec(llAdjDollar, 2))
                            tmIvr.lATotalGross = tmIvr.lATotalGross + llAdjDollar
                            Exit For
                        End If
                    End If
                Next ilLoop
            ElseIf llAdjDollar < 0 Then
                llAdjDollar = -1 * llAdjDollar
                For ilLoop = 0 To UBound(tgRvfByVef) - 1 Step 1
                    If tgRvfByVef(ilLoop).iPkLineNo > 0 Then
                        If gStrDecToLong(tgRvfByVef(ilLoop).sTotalGross, 2) > llAdjDollar Then
                            tgRvfByVef(ilLoop).sTotalGross = gSubStr(tgRvfByVef(ilLoop).sTotalGross, gLongToStrDec(llAdjDollar, 2))
                            tmIvr.lATotalGross = tmIvr.lATotalGross - llAdjDollar
                            Exit For
                        End If
                    End If
                Next ilLoop
            End If
        End If
        'For ilLoop = 1 To 11 Step 1
        '    ilRet = gParseItemNoTrim(slName, ilLoop, "|", slFields(ilLoop))    'Get application name
        'Next ilLoop
        'tmIvr.sKey = slFields(1) & slFields(2) & slFields(3) & slFields(4) & slFields(9) & slFields(10) & slFields(11)
        tmIvr.sKey = smForm2Key & "3"

         '11-13-01 Calculate the net amount to be stored in IVR.  Crystal cannot
        'calculate this due to separate transactions whose net/agy comm are calculated independently
        If slAgyRate = "" Then
            slTotalNet = slTotalAirRate
            slAgyComm = "0"
        Else
            For ilLoop = 0 To UBound(tgRvfByVef) - 1 Step 1
                slStr = gDivStr(gMulStr(tgRvfByVef(ilLoop).sTotalGross, gSubStr("100.00", slAgyRate)), "100.00")
                slTotalNet = gAddStr(slTotalNet, slStr)
            Next ilLoop
            slAgyComm = gSubStr(slTotalAirRate, slTotalNet)
            slStr = slAgyComm
            gFormatStr slStr, FMTCOMMA + FMTDOLLARSIGN, 2, slStr
            If Not ilImpactPrt Then
                slStr = slStr & " "
            End If
        End If

        tmIvr.lATotalNet = gStrDecToLong(slTotalNet, 2)
        tmIvr.lTax1 = lmTax1
        tmIvr.lTax2 = lmTax2
        'If Not imExportCntr Then
        If (Not imExportCntr) And (Not imRemoteCntr) Then
            If (tgSpf.sBLaserForm = "2") Then
                If imInvGenType = 1 Then
                    tmIvr.iFormType = 1
                Else
                    If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                        tmIvr.iFormType = 0
                    Else
                        tmIvr.iFormType = 1
                    End If
                End If
            End If
            tmIvr.lClfCxfCode = 0
            tmIvr.lClfCode = 0
            tmIvr.lCode = 0
            mGetInstallmentCounts tmChf ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
            tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
            tmIvr.iTotalInstallInvs = imTotalInstallInvs
            tmIvr.sInstallCntr = tmChf.sInstallDefined
            ilRet = mInsertIVRandClearDollars(ilEDIFlag, tmIvr)
            If tgSpf.sBLaserForm = "1" Then
                If imCombineAirAndNTR Or ((Asc(tgSaf(0).sFeatures8) And PODADSERVER) = PODADSERVER) Then 'Combined OR AdServer
                    'TTP 10517 - Invoices: if "ad server" option is not checked on, and "commercial and NTR" invoices are set to be separate, the air time portion of the invoice does not print
                    If (tmIvr.iType = IVRTYPE_TotalAirtimeRep) Or (tmIvr.iType = IVRTYPE_TotalAdServer) Or (tmIvr.iType = IVRTYPE_TotalNTR) Or (tmIvr.iType = IVRTYPE_TotalInstallment) Or (tmIvr.iType = IVRTYPE_TotalCntr) Then
                        LSet tmImr = tmIvr
                        tmImr.lIvrCode = tmIvr.lCode
                        tmImr.sUnused = ""
                        'ilRet = btrInsert(hmImr, tmImr, imImrRecLen, INDEXKEY0)
                        ilRet = mWriteImr(ilEDIFlag, tmImr)
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            Print #hmMsg, "mFinishOutput: btrInsert-Point 1, Imr Error # " & Trim$(str$(ilRet))
                        End If
                    End If
                    For ilTest = LBound(tmAirNTRCombine) To UBound(tmAirNTRCombine) - 1 Step 1
                        If tmAirNTRCombine(ilTest).lChfCode = tmIvr.lChfCode Then
                            If (tmAirNTRCombine(ilTest).sCashTrade = tmIvr.sCashTrade) Then
                                tmAirNTRCombine(ilTest).lIvrCode = tmIvr.lCode
                                Exit For
                            End If
                        End If
                    Next ilTest
                End If
            End If
        End If
        Exit Sub
    End If
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":Ordered", True)
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":Aired", False)
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":Reconc", False)
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":TotalNoPerWk", True)
'VB6**    ilDummy = LLDefineVariableExt(hdJob, "TotalNoPerWk", slTotalNoPerWk, LL_TEXT, "")
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":TotalRate", True)
    slStr = slTotalRate
    gFormatStr slStr, FMTCOMMA + FMTDOLLARSIGN, 2, slStr
    If Not ilImpactPrt Then
        slStr = slStr & " "
    End If
'VB6**    ilDummy = LLDefineVariableExt(hdJob, "TotalRate", slStr, LL_TEXT, "")
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":Ordered", False)
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":Aired", True)
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":Reconc", False)
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":TotalAirCount", True)
'VB6**    ilDummy = LLDefineVariableExt(hdJob, "TotalAirCount", slTotalAirCount, LL_TEXT, "")

    If (tmChf.sType <> "S") And (tmChf.sType <> "M") Then
        If (ilPass = 1) Or (ilStartPass = 2) Then
            slTGNoSpots = gAddStr(slTGNoSpots, slTotalAirCount)
        End If
    End If
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":TotalAirRate", True)
    slStr = slTotalAirRate
    gFormatStr slStr, FMTCOMMA + FMTDOLLARSIGN, 2, slStr
    If Not ilImpactPrt Then
        slStr = slStr & " "
    End If
'VB6**    ilDummy = LLDefineVariableExt(hdJob, "TotalAirRate", slStr, LL_TEXT, "")
    If slAgyRate = "" Then
'VB6**  ilLLRet = LLPrintEnableObject(hdJob, ":AgyComm", False)
'VB6**  ilLLRet = LLPrintEnableObject(hdJob, ":AgyCommMsg", False)
        slTotalNet = slTotalAirRate
        slAgyComm = "0"
    Else
        For ilLoop = 0 To UBound(tgRvfByVef) - 1 Step 1
            slStr = gDivStr(gMulStr(tgRvfByVef(ilLoop).sTotalGross, gSubStr("100.00", slAgyRate)), "100.00")
            slTotalNet = gAddStr(slTotalNet, slStr)
        Next ilLoop
        slAgyComm = gSubStr(slTotalAirRate, slTotalNet)
'VB6**  ilLLRet = LLPrintEnableObject(hdJob, ":AgyComm", True)
        slStr = slAgyComm
        gFormatStr slStr, FMTCOMMA + FMTDOLLARSIGN, 2, slStr
        If Not ilImpactPrt Then
            slStr = slStr & " "
        End If
'VB6**  ilDummy = LLDefineVariableExt(hdJob, "AgyComm", slStr, LL_TEXT, "")
'VB6**  ilLLRet = LLPrintEnableObject(hdJob, ":AgyCommMsg", True)
    End If
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":TotalNet", True)
    slStr = slTotalNet
    If (tmChf.sType <> "S") And (tmChf.sType <> "M") Then
        slGTNet = gAddStr(slGTNet, slTotalNet)
        slGTComm = gAddStr(slGTComm, slAgyComm)
    End If
    gFormatStr slStr, FMTCOMMA + FMTDOLLARSIGN, 2, slStr
    If Not ilImpactPrt Then
        slStr = slStr & " "
    End If
'VB6**    ilDummy = LLDefineVariableExt(hdJob, "TotalNet", slStr, LL_TEXT, "")
    If (ilEDIFlag) Or (smHeaderComment <> "") Then
'VB6**  ilLLRet = LLPrintEnableObject(hdJob, ":BottomMsg", True)
        slStr = ""
        If ilEDIFlag Then
            If Trim$(tmEDIArf.sNmAd(0)) <> "" Then
                slStr = "Electronic Invoice Sent To " & Trim$(tmEDIArf.sNmAd(0))
            Else
                slStr = "Electronic Invoice Sent To " & Trim$(tmEDIArf.sID)
            End If
        End If
        If Len(smHeaderComment) > 0 Then
            If slStr <> "" Then
                slStr = slStr & Chr(10) & Chr(10)   'One blank line
            End If
            slStr = slStr & smHeaderComment
        End If
'VB6**  ilDummy = LLDefineVariableExt(hdJob, "BottomMsg", slStr, LL_TEXT, "")
    Else
'VB6**  ilLLRet = LLPrintEnableObject(hdJob, ":BottomMsg", False)
    End If
    'If ilEDIFlag And (smHeaderComment <> "") Then
    '    smEDIRecords(ilEDIUpper) = "33;" & Left$(smHeaderComment, 129) & ";"
    '    ilEDIUpper = ilEDIUpper + 1
    '    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
    'End If
    If (tmChf.sType = "S") Then
'VB6**  ilLLRet = LLPrintEnableObject(hdJob, ":TradeMsg", True)
'VB6**  ilDummy = LLDefineVariableExt(hdJob, "TradeMsg", "** PSA Invoice **", LL_TEXT, "")
    ElseIf (tmChf.sType = "M") Then
'VB6**  ilLLRet = LLPrintEnableObject(hdJob, ":TradeMsg", True)
'VB6**  ilDummy = LLDefineVariableExt(hdJob, "TradeMsg", "** Promo Invoice **", LL_TEXT, "")
    Else
        'If Val(slPctTrade) = 100 Then
        If ilPass = 2 Then
'VB6**      ilLLRet = LLPrintEnableObject(hdJob, ":TradeMsg", True)
'VB6**      ilDummy = LLDefineVariableExt(hdJob, "TradeMsg", "** Trade Reciprocal Agreement **", LL_TEXT, "")
            'If ilEDIFlag Then
            '    smEDIRecords(ilEDIUpper) = "25;" & "** Trade Reciprocal Agreement **" & ";"
            '    ilEDIUpper = ilEDIUpper + 1
            '    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
            'End If
        Else
'VB6**      ilLLRet = LLPrintEnableObject(hdJob, ":TradeMsg", False)
        End If
    End If
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":Ordered", False)
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":Aired", False)
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":Reconc", True)
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":TotalMissedRate", True)
    slStr = slTotalMissedRate
    gFormatStr slStr, FMTCOMMA + FMTDOLLARSIGN + FMTNEGATBACK, 2, slStr
    If InStr(slStr, "-") <= 0 Then
        If ilImpactPrt Then
            slStr = slStr & " "
        Else
            slStr = slStr & " "
        End If
    Else
        If Not ilImpactPrt Then
            slStr = slStr & " "
        End If
    End If
'VB6**    ilDummy = LLDefineVariableExt(hdJob, "TotalMissedRate", slStr, LL_TEXT, "")
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":TotalOrdered", True)
    slStr = slTotalRate
    If (tmChf.sType <> "S") And (tmChf.sType <> "M") Then
        slGTOrdered = gAddStr(slGTOrdered, slTotalRate)
    End If
    gFormatStr slStr, FMTCOMMA + FMTDOLLARSIGN, 2, slStr
    If Not ilImpactPrt Then
        slStr = slStr & " "
    End If
'VB6**    ilDummy = LLDefineVariableExt(hdJob, "TotalOrdered", slStr, LL_TEXT, "")
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":TotalReconc", True)
    slStr = slTotalMissedRate
    If (tmChf.sType <> "S") And (tmChf.sType <> "M") Then
        slGTReconc = gAddStr(slGTReconc, slTotalMissedRate)
    End If
    gFormatStr slStr, FMTCOMMA + FMTDOLLARSIGN, 2, slStr
    If Not ilImpactPrt Then
        slStr = slStr & " "
    End If
'VB6**    ilDummy = LLDefineVariableExt(hdJob, "TotalReconc", slStr, LL_TEXT, "")
'VB6**    ilLLRet = LLPrintEnableObject(hdJob, ":TotalAired", True)
    slStr = slTotalAirRate
    If (tmChf.sType <> "S") And (tmChf.sType <> "M") Then
        slGTAired = gAddStr(slGTAired, slTotalAirRate)
    End If
    'If ilEDIFlag Then
    '    slEDITotalAired = gAddStr(slEDITotalAired, slTotalAirRate)
    '    ilEDITotalNoInv = ilEDITotalNoInv + 1
    'End If
    gFormatStr slStr, FMTCOMMA + FMTDOLLARSIGN, 2, slStr
    If Not ilImpactPrt Then
        slStr = slStr & " "
    End If
'VB6**    ilDummy = LLDefineVariableExt(hdJob, "TotalAired", slStr, LL_TEXT, "")
    'If ilEDIFlag Then
    '    ilPos = InStr(slTotalRate, ".")
    '    If ilPos > 0 Then
    '        slStr = Left$(slTotalRate, ilPos - 1) & Mid$(slTotalRate, ilPos + 1)
    '    Else
    '        slStr = slTotalRate
    '    End If
    '    smEDIRecords(ilEDIUpper) = "34;" & slStr & ";"
    '    ilPos = InStr(slTotalAirRate, ".")
    '    If ilPos > 0 Then
    '        slStr = Left$(slTotalAirRate, ilPos - 1) & Mid$(slTotalAirRate, ilPos + 1)
    '    Else
    '        slStr = slTotalAirRate
    '    End If
    '    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slStr & ";"
    '    ilPos = InStr(slAgyComm, ".")
    '    If ilPos > 0 Then
    '        slStr = Left$(slAgyComm, ilPos - 1) & Mid$(slAgyComm, ilPos + 1)
    '    Else
    '        slStr = slAgyComm
    '    End If
    '    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slStr & ";"
    '    ilPos = InStr(slTotalNet, ".")
    '    If ilPos > 0 Then
    '        slStr = Left$(slTotalNet, ilPos - 1) & Mid$(slTotalNet, ilPos + 1)
    '    Else
    '        slStr = slTotalNet
    '    End If
    '    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slStr & ";"
    '    ilEDIUpper = ilEDIUpper + 1
    '    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
    '    'Output records
    '    For ilLoop = 0 To UBound(smEDIRecords) - 1 Step 1
    '        Print #hmEDI, smEDIRecords(ilLoop) & Chr(21);
    '    Next ilLoop
    '    ReDim smEDIRecords(0 To 0) As String
    'End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mFixSpotOrder                   *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Fix spot order in sorted array  *
'*                     to match SSF                    *
'*                                                     *
'*******************************************************
Private Sub mFixSpotOrder(llStartSortIndex As Long, llEndSortIndex As Long)
    Dim llSdfIndex1 As Long
    Dim slVehicle1 As String
    Dim slDate1 As String
    Dim slTime1 As String
    Dim llSdfIndex2 As Long
    Dim slVehicle2 As String
    Dim slDate2 As String
    Dim slTime2 As String
    Dim llNumberMatch As Long
    Dim ilAvail As Integer
    Dim ilType As Integer       '10-31-01
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim llLoop As Long
    Dim llNumber As Long
    Dim llTest As Long
    Dim ilIndex As Integer

''TTP 10931 !!! - Invoice: one conventional spot is not getting bill flag set when final invoices are run
'Dim fn As Integer
'fn = FreeFile(0)
'Open "C:\spotdump-before.txt" For Output As #fn
'For llSdfIndex1 = 0 To UBound(tgSortKey) Step 1
'Print #fn, llSdfIndex1 & ",code:" & tgSortKey(llSdfIndex1).lCode & ",Line:" & tgSortKey(llSdfIndex1).iLineNo & ",Type:" & tgSortKey(llSdfIndex1).sType
'Next llSdfIndex1
'Close #fn

    'Test for one or less spots- if so return as sorting is not required
    If llEndSortIndex <= llStartSortIndex Then
        Exit Sub
    End If
    llSdfIndex1 = llStartSortIndex
    Do
        If tgSortKey(llSdfIndex1).iType = 0 Then

            'ilRet = gParseItem(tgSortKey(llSdfIndex1).sKey, 9, "|", slVehicle1)
            'ilRet = gParseItem(tgSortKey(llSdfIndex1).sKey, 11, "|", slDate1)
            'ilRet = gParseItem(tgSortKey(llSdfIndex1).sKey, 12, "|", slTime1)
            slVehicle1 = Trim$(tmSpeedSortParse(llSdfIndex1).sVehName)
            slDate1 = Trim$(tmSpeedSortParse(llSdfIndex1).sSdfDate)
            slTime1 = Trim$(tmSpeedSortParse(llSdfIndex1).sSdfTime)
            'Advance to next type = 0 spot
            llSdfIndex2 = llSdfIndex1 + 1
            llNumberMatch = 0
            ReDim llSdfCode(0 To 0) As Long
            ReDim llMatchIndex(0 To 0) As Long
            
            Do
                If tgSortKey(llSdfIndex2).iType = 0 Then
                    'ilRet = gParseItem(tgSortKey(llSdfIndex2).sKey, 9, "|", slVehicle2)
                    'ilRet = gParseItem(tgSortKey(llSdfIndex2).sKey, 11, "|", slDate2)
                    'ilRet = gParseItem(tgSortKey(llSdfIndex2).sKey, 12, "|", slTime2)
                    slVehicle2 = Trim$(tmSpeedSortParse(llSdfIndex2).sVehName)
                    slDate2 = Trim$(tmSpeedSortParse(llSdfIndex2).sSdfDate)
                    slTime2 = Trim$(tmSpeedSortParse(llSdfIndex2).sSdfTime)
                    'If (slVehicle1 = slVehicle2) And (slDate1 = slDate2) And (slTime1 = slTime2) Then
                    If (slDate1 = slDate2) And (slTime1 = slTime2) Then
                        If tgSortKey(llSdfIndex1).iSdfVefCode = tgSortKey(llSdfIndex2).iSdfVefCode Then
                            If llNumberMatch = 0 Then
                                'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex1).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex1).lCode
                                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                If (tmSdf.sSchStatus <> "S") And (tmSdf.sSchStatus <> "O") And (tmSdf.sSchStatus <> "G") Then 'Scheduled / Outside / Makegood
                                    Exit Do
                                Else
                                    If (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C") Then 'Open BB / Close BB
                                        Exit Do
                                    End If
                                    llSdfCode(llNumberMatch) = tmSdf.lCode
                                    llMatchIndex(llNumberMatch) = llSdfIndex1
                                End If
                            End If
                            'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex2).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                            tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex2).lCode
                            ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                            If (tmSdf.sSpotType <> "O") And (tmSdf.sSpotType <> "C") Then 'Open BB / Close BB
                                If (tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "O") Or (tmSdf.sSchStatus = "G") Then 'Scheduled / Outside / Makegood
                                    llNumberMatch = llNumberMatch + 1
                                    ReDim Preserve llSdfCode(0 To llNumberMatch) As Long
                                    ReDim Preserve llMatchIndex(0 To llNumberMatch) As Long
                                    llSdfCode(llNumberMatch) = tmSdf.lCode
                                    llMatchIndex(llNumberMatch) = llSdfIndex2
                                End If
                            End If
                        End If
                    Else
                        Exit Do
                    End If
                End If
                llSdfIndex2 = llSdfIndex2 + 1
            Loop While llSdfIndex2 <= llEndSortIndex
            
            If llNumberMatch > 0 Then
                'Find Avail of matching spot
                ReDim tmSvSort(0 To llNumberMatch) As TYPESORTKEY
                For llLoop = 0 To llNumberMatch Step 1
                    tmSvSort(llLoop) = tgSortKey(llMatchIndex(llLoop))
                Next llLoop
                'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex1).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex1).lCode
                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                ''10-31-01 slType = "O"
                '11/24/12
                'ilType = 0          '10-31-01
                ilType = tmSdf.iGameNo
                imSsfRecLen = Len(tmSsf) 'Max size of variable length record
                tmSsfSrchKey.iType = ilType '10-31-01 slType
                tmSsfSrchKey.iVefCode = tmSdf.iVefCode  'ilVefCode
                tmSsfSrchKey.iDate(0) = tmSdf.iDate(0)  'ilLogDate0
                tmSsfSrchKey.iDate(1) = tmSdf.iDate(1)  'ilLogDate1
                tmSsfSrchKey.iStartTime(0) = 0
                tmSsfSrchKey.iStartTime(1) = 0
                '10-31-01 If (tmSsf.sType <> slType) Or (tmSsf.iVefcode <> tmSdf.iVefcode) Or (tmSsf.iDate(0) <> tmSdf.iDate(0)) Or (tmSsf.iDate(1) <> tmSdf.iDate(1)) Or (tmSsf.iStartTime(0) <> 0) Or (tmSsf.iStartTime(1) <> 0) Then
                If (tmSsf.iType <> ilType) Or (tmSsf.iVefCode <> tmSdf.iVefCode) Or (tmSsf.iDate(0) <> tmSdf.iDate(0)) Or (tmSsf.iDate(1) <> tmSdf.iDate(1)) Or (tmSsf.iStartTime(0) <> 0) Or (tmSsf.iStartTime(1) <> 0) Then
                    ilRet = gSSFGetGreaterOrEqual(hmSsf, tmSsf, imSsfRecLen, tmSsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get last current record to obtain date
                Else
                    ilRet = BTRV_ERR_NONE
                End If
                '10-31-01 Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.sType = slType) And (tmSsf.iVefcode = tmSdf.iVefcode) And (tmSsf.iDate(0) = tmSdf.iDate(0)) And (tmSsf.iDate(1) = tmSdf.iDate(1))
                Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.iType = ilType) And (tmSsf.iVefCode = tmSdf.iVefCode) And (tmSsf.iDate(0) = tmSdf.iDate(0)) And (tmSsf.iDate(1) = tmSdf.iDate(1))
                    For ilLoop = 1 To tmSsf.iCount Step 1
                        LSet tmSpot = tmSsf.tPas(ilLoop + ADJSSFPASBZ)
                        If ((tmSpot.iRecType And &HF) >= 10) Then
                            If tmSpot.lSdfCode = tmSdf.lCode Then
                                For ilAvail = ilLoop - 1 To 1 Step -1
                                    LSet tmAvail = tmSsf.tPas(ilAvail + ADJSSFPASBZ)
                                    If (tmAvail.iRecType >= 2) And (tmAvail.iRecType <= 9) Then 'Contract Avail subrecord
                                        llNumber = 0
                                        For ilIndex = ilAvail + 1 To tmSsf.iCount Step 1
                                            LSet tmSpot = tmSsf.tPas(ilIndex + ADJSSFPASBZ)
                                            '1/7/19: limit to spots within avail
                                            If ((tmSpot.iRecType And &HF) >= 10) Then
                                                For llTest = 0 To llNumberMatch Step 1
                                                    If tmSpot.lSdfCode = llSdfCode(llTest) Then
                                                        'Move spot
                                                        tgSortKey(llMatchIndex(llNumber)) = tmSvSort(llTest)
                                                        
                                                        'TTP 10931 - Invoice: one conventional spot is not getting bill flag set when final invoices are run
                                                        llMatchIndex(llNumber) = -1 'flag this one as Sorted
                                                        llSdfCode(llTest) = -1 'flag this one as Sorted
                                                        
                                                        llNumber = llNumber + 1
                                                        Exit For
                                                    End If
                                                Next llTest
                                                If llNumber > llNumberMatch Then
                                                    Exit Do
                                                End If
                                            Else
                                                Exit Do
                                            End If
                                        Next ilIndex
                                        Exit For
                                    End If
                                Next ilAvail
                            End If
                        End If
                    Next ilLoop
                    imSsfRecLen = Len(tmSsf) 'Max size of variable length record
                    ilRet = gSSFGetNext(hmSsf, tmSsf, imSsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop
                
                'TTP 10931 - Invoice: one conventional spot is not getting bill flag set when final invoices are run
                'Check if all the Sorting occured, one sometimes is left behind.  determine which one and put the correct one into value into tgSortKey
                Do
                    llNumber = -1
                    ilRet = False
                    For ilLoop = 0 To UBound(llSdfCode) - 1
                        If llSdfCode(ilLoop) > 0 Then
                            llNumber = llSdfCode(ilLoop)
                            llSdfCode(ilLoop) = -1
                            Exit For
                        End If
                    Next ilLoop
                    llNumberMatch = -1
                    If llNumber > 0 Then
                        For ilLoop = 0 To UBound(llMatchIndex)
                            If llMatchIndex(ilLoop) > 0 Then
                                llNumberMatch = llMatchIndex(ilLoop)
                                llMatchIndex(ilLoop) = -1
                                Exit For
                            End If
                        Next ilLoop
                    End If
                    If llNumber > -1 And llNumberMatch > -1 Then
                        'tgSortKey (llNumberMatch)
                        For ilLoop = 0 To UBound(tmSvSort)
                            If tmSvSort(ilLoop).lCode = llNumber Then
                                tgSortKey(llNumberMatch) = tmSvSort(ilLoop)
                                ilRet = True
                                Exit For
                            End If
                        Next ilLoop
                    End If
                Loop While ilRet = True
                
                'llSdfIndex1 = llSdfIndex2' + 1
                If (llSdfIndex2 - llSdfIndex1 - 1) = llNumberMatch Then
                    llSdfIndex1 = llSdfIndex2 ' + 1
                Else
                    llSdfIndex1 = llSdfIndex1 + 1
                End If
            Else
                llSdfIndex1 = llSdfIndex2   'Next to be checked
            End If
        Else
            llSdfIndex1 = llSdfIndex1 + 1 'Next to be checked
        End If
    Loop While llSdfIndex1 < llEndSortIndex

''TTP 10931 !!! - Invoice: one conventional spot is not getting bill flag set when final invoices are run
'fn = FreeFile(0)
'Open "C:\spotdump-after.txt" For Output As #fn
'For llSdfIndex1 = 0 To UBound(tgSortKey) Step 1
'Print #fn, llSdfIndex1 & ",code:" & tgSortKey(llSdfIndex1).lCode & ",Line:" & tgSortKey(llSdfIndex1).iLineNo & ",Type:" & tgSortKey(llSdfIndex1).sType
'Next llSdfIndex1
'Close #fn
End Sub

'**********************************************************************
'*                                                                    *
'*      Procedure Name:mGenHeader                                     *
'*                                                                    *
'*             Created:4/21/94       By:D. LeVine                     *
'*            Modified:              By:                              *
'*                                                                    *
'*            Comments:Generate Header fields                         *
'*                                                                    *
'*      11-17-05 Always show Payables contact or "Accounts Payable"   *
'*              if contact doesnt exist.  Form #2 previously showed   *
'*              the buyers name.
'**********************************************************************
Public Sub mGenHeader(ilImpactPrt As Integer, llInvoiceNo As Long, ilPass As Integer, slPctTrade As String, ilType As Integer, ilAddNTR As Integer, ilEDIFlag As Integer, llCntrNo As Long)
'   Type(I)- 0=Invoice; 1=Remote
    Dim slStr As String
    Dim slParse As String
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim ilPos As Integer
    Dim ilAttnCode As Integer
    Dim ilVefLockBox As Integer
    Dim ilTest As Integer
    Dim ilMatchFd As Integer
    Dim ilLoopOnInvPDF As Integer
    Dim blFoundInvPDF As Boolean
    Dim ilLoopOnArf As Integer
    Dim slTempPath As String
    Dim slPDFEmailAddress As String
    Dim blPDFFlag As Boolean            '12-18-16

    If Not ilImpactPrt Then
        If (tgSpf.sBLaserForm = "2") Or (ilType = 1) Then
            If rbcType(INVGEN_Aff).Value Then
                If ilPass <> 2 Then
                    slStr = "AFFIDAVIT" & Chr(10) & "of" & Chr(10) & "PERFORMANCE"
                    tmIvr.sCashTrade = "C"
                Else
                    slStr = "TRADE AFFIDAVIT" & Chr(10) & "of" & Chr(10) & "PERFORMANCE"
                    tmIvr.sCashTrade = "T"
                End If
            Else
                If ilPass <> 2 Then
                    slStr = "INVOICE" & Chr(10) & "and" & Chr(10) & "AFFIDAVIT"
                    tmIvr.sCashTrade = "C"
                Else
                    slStr = "TRADE INVOICE" & Chr(10) & "and" & Chr(10) & "AFFIDAVIT"
                    tmIvr.sCashTrade = "T"
                End If
            End If
        ElseIf (tgSpf.sBLaserForm = "3") Then
            If ilPass <> 2 Then
                slStr = "INVOICE" & Chr(10) & "and" & Chr(10) & "AFFIDAVIT"
                tmIvr.sCashTrade = "C"
            Else
                slStr = "TRADE INVOICE" & Chr(10) & "and" & Chr(10) & "AFFIDAVIT"
                tmIvr.sCashTrade = "T"
            End If
        Else
            If imCombineAirAndNTR Then
                If ilPass <> 2 Then
                    slStr = "INVOICE" & Chr(10) & "and" & Chr(10) & "AFFIDAVIT"
                    tmIvr.sCashTrade = "C"
                Else
                    slStr = "TRADE INVOICE" & Chr(10) & "and" & Chr(10) & "AFFIDAVIT"
                    tmIvr.sCashTrade = "T"
                End If
            Else
                If ilPass <> 2 Then
                    slStr = "INVOICE" & Chr(10) & "and" & Chr(10) & "AFFIDAVIT"
                    tmIvr.sCashTrade = "C"
                Else
                    slStr = "TRADE INVOICE" & Chr(10) & "and" & Chr(10) & "AFFIDAVIT"
                    tmIvr.sCashTrade = "T"
                End If
            End If
        End If
        
        If ilAddNTR Then
            'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81
            If mGetNTRHeaderStatus(llCntrNo) = True Then
                'Yes, we may put NTR in the header...  This Invoice Has NTR, and Does NOT have AirTime or CPM.
                'If Invoices are not Combined (Air + NTR), the INV_NTR report will add "NTR" on it's own - despite this code.
                If Not imCombineAirAndNTR Then
                    slStr = "NTR" & Chr(10) & slStr
                Else
                    'Check if this NTR is combined with Air time.  If not, then include NTR
                    ilMatchFd = False
                    For ilTest = LBound(tmAirNTRCombine) To UBound(tmAirNTRCombine) - 1 Step 1
                        If tmAirNTRCombine(ilTest).lChfCode = tgChfInv.lCode Then
                            If ((ilPass <> 2) And (tmAirNTRCombine(ilTest).sCashTrade = "C")) Or ((ilPass = 2) And (tmAirNTRCombine(ilTest).sCashTrade = "T")) Then
                                ilMatchFd = True
                                Exit For
                            End If
                        End If
                    Next ilTest
                    '12/1/09:  Contract without spots and NTR should not include NTR in the header
                    'If Not ilMatchFd Then
                    If (Not ilMatchFd) And (UBound(tmAirNTRCombine) > LBound(tmAirNTRCombine)) Then
                        slStr = "NTR" & Chr(10) & slStr
                    Else
                        'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81
                        If InStr(1, slStr, "NTR") = 0 Then
                            slStr = "NTR" & Chr(10) & slStr
                        End If
                    End If
                End If
            End If
        Else
            Select Case tgChfInv.sType
                Case "P"    'Proposal
                Case "H"    'Hold
                Case "V"    'Reservation
                Case "J"    'Rejection
                Case "E"    'Order
                Case "C"    'Contract
                Case "D"    'Deferred
                Case "T"    'Remnant
                    'slStr = "REMNANT" & Chr(10) & slStr
                Case "R"    'Direct Response
                    slStr = "DIRECT RESPONSE" & Chr(10) & slStr
                Case "Q"    'Direct Response
                    slStr = "PER INQUIRY" & Chr(10) & slStr
                Case "S"    'PSA
                    slStr = "PSA" & Chr(10) & slStr
                Case "M"    'Promo
                    slStr = "PROMO" & Chr(10) & slStr
            End Select
        End If
        For ilLoop = LBound(tmIvr.sTitle) To UBound(tmIvr.sTitle) Step 1
            tmIvr.sTitle(ilLoop) = ""
            ilRet = gParseItem(slStr, ilLoop + 1, Chr(10), slParse)
            If (ilRet = CP_MSG_NONE) Then
                tmIvr.sTitle(ilLoop) = slParse
            End If
        Next ilLoop
    End If
    slStr = Trim$(str$(tgChfInv.lCntrNo)) & Chr$(0)
    tmIvr.lChfCode = tgChfInv.lCode
    If (tgChfInv.sBillCycle = "C") Or (tgChfInv.sBillCycle = "T") Then
        gPackDate smEndCal, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
        gPackDate smStartCal, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
    ElseIf (tgChfInv.sBillCycle = "W") Then
        gPackDate smEndWk, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
        gPackDate smStartWk, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
    Else
        gPackDate smEndStd, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
        gPackDate smStartStd, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
    End If
    If (tgChfInv.sType = "S") Or (tgChfInv.sType = "M") Then
        slStr = " " & Chr$(0)
    Else
        slStr = Trim$(str$(llInvoiceNo)) & Chr$(0)
    End If
    tmIvr.lInvNo = llInvoiceNo
    'slStr = Trim$(Str$(ilPageNo)) & Chr$(0)
    'ilDummy = LLDefineVariableExt(hdJob, "PageNo", slStr, LL_TEXT, "")
    smTerms = sgDefaultTerms

    'Get Lock Box from Vehicle
    ilVefLockBox = mGetVefLockBox(tgChfInv)

    If tgChfInv.iAgfCode > 0 Then
        If (tgSpf.sBLaserForm = "2") Or (ilType = 1) Then
            ilAttnCode = tmAgf.iPnfPay
        Else
            ilAttnCode = tmAgf.iPnfPay
        End If
        If Trim$(tmAgf.sBillAddr(0)) <> "" Then
            If (InStr(1, tmAgf.sBillAddr(0), "Attn:", 1) > 0) Or (InStr(1, tmAgf.sBillAddr(1), "Attn:", 1) > 0) Then
                slStr = Trim$(tmAgf.sName) & Chr$(10) & Trim$(tmAgf.sBillAddr(0)) & Chr$(10) & Trim$(tmAgf.sBillAddr(1)) & Chr$(10) & Trim$(tmAgf.sBillAddr(2)) & Chr$(0)
            Else
                If ilAttnCode > 0 Then 'tmAgf.iPnfPay > 0 Then
                    '11-17-05 need to show the payables contact for form #2
                    tmPnfSrchKey.iCode = ilAttnCode 'tmAgf.iPnfPay
                    ilRet = btrGetEqual(hmPnf, tmPnf, imPnfRecLen, tmPnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet = BTRV_ERR_NONE Then
                        slStr = Trim$(tmAgf.sName) & Chr$(10) & "Attn: " & Trim$(tmPnf.sName) & Chr$(10) & Trim$(tmAgf.sBillAddr(0)) & Chr$(10) & Trim$(tmAgf.sBillAddr(1)) & Chr$(10) & Trim$(tmAgf.sBillAddr(2)) & Chr$(0)
                    Else
                        slStr = Trim$(tmAgf.sName) & Chr$(10) & "Attn: Accounts Payable" & Chr$(10) & Trim$(tmAgf.sBillAddr(0)) & Chr$(10) & Trim$(tmAgf.sBillAddr(1)) & Chr$(10) & Trim$(tmAgf.sBillAddr(2)) & Chr$(0)
                    End If
                Else
                    slStr = Trim$(tmAgf.sName) & Chr$(10) & "Attn: Accounts Payable" & Chr$(10) & Trim$(tmAgf.sBillAddr(0)) & Chr$(10) & Trim$(tmAgf.sBillAddr(1)) & Chr$(10) & Trim$(tmAgf.sBillAddr(2)) & Chr$(0)
                End If
            End If
        Else
            If (InStr(1, tmAgf.sCntrAddr(0), "Attn:", 1) > 0) Or (InStr(1, tmAgf.sCntrAddr(1), "Attn:", 1) > 0) Then
                slStr = Trim$(tmAgf.sName) & Chr$(10) & Trim$(tmAgf.sCntrAddr(0)) & Chr$(10) & Trim$(tmAgf.sCntrAddr(1)) & Chr$(10) & Trim$(tmAgf.sCntrAddr(2)) & Chr$(0)
            Else
                If ilAttnCode > 0 Then  'tmAgf.iPnfPay > 0 Then
                    '11-17-05 always show the payables name, not buyer name for all forms
                    tmPnfSrchKey.iCode = ilAttnCode 'tmAgf.iPnfPay
                    ilRet = btrGetEqual(hmPnf, tmPnf, imPnfRecLen, tmPnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet = BTRV_ERR_NONE Then
                        slStr = Trim$(tmAgf.sName) & Chr$(10) & "Attn: " & Trim$(tmPnf.sName) & Chr$(10) & Trim$(tmAgf.sCntrAddr(0)) & Chr$(10) & Trim$(tmAgf.sCntrAddr(1)) & Chr$(10) & Trim$(tmAgf.sCntrAddr(2)) & Chr$(0)
                    Else
                        slStr = Trim$(tmAgf.sName) & Chr$(10) & "Attn: Accounts Payable" & Chr$(10) & Trim$(tmAgf.sCntrAddr(0)) & Chr$(10) & Trim$(tmAgf.sCntrAddr(1)) & Chr$(10) & Trim$(tmAgf.sCntrAddr(2)) & Chr$(0)
                    End If
                Else
                    slStr = Trim$(tmAgf.sName) & Chr$(10) & "Attn: Accounts Payable" & Chr$(10) & Trim$(tmAgf.sCntrAddr(0)) & Chr$(10) & Trim$(tmAgf.sCntrAddr(1)) & Chr$(10) & Trim$(tmAgf.sCntrAddr(2)) & Chr$(0)
                End If
            End If
        End If
        
        For ilLoop = LBound(tmIvr.sAddr) To UBound(tmIvr.sAddr) Step 1
            tmIvr.sAddr(ilLoop) = ""
            ilRet = gParseItem(slStr, ilLoop + 1, Chr(10), slParse)
            If (ilRet = CP_MSG_NONE) Then
                ilPos = InStr(slParse, Chr$(0))
                If ilPos > 0 Then
                    slParse = Left$(slParse, ilPos - 1)
                End If
                tmIvr.sAddr(ilLoop) = slParse
            End If
        Next ilLoop

        If Not ilVefLockBox Then
            If tmAgf.iArfLkCode > 0 Then
                'TTP 10404 - Invoice: blank lock box address being shown after adding new lock box
                If tmArfSrchKey.iCode <> tmAgf.iArfLkCode Then
                    tmArfSrchKey.iCode = tmAgf.iArfLkCode
                    ilRet = btrGetEqual(hmArf, tmArf, imArfRecLen, tmArfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        tmArf.sNmAd(0) = "Missing"
                        tmArf.sNmAd(1) = " "
                        tmArf.sNmAd(2) = " "
                        tmArf.sNmAd(3) = " "
                    End If
                End If
                tmIvr.sPayAddr(0) = Trim$(tmArf.sNmAd(0))
                tmIvr.sPayAddr(1) = Trim$(tmArf.sNmAd(1))
                tmIvr.sPayAddr(2) = Trim$(tmArf.sNmAd(2))
                tmIvr.sPayAddr(3) = Trim$(tmArf.sNmAd(3))
            Else
                tmIvr.sPayAddr(0) = Trim$(tgSpf.sBPayName)
                tmIvr.sPayAddr(1) = Trim$(tgSpf.sBPayAddr(0))
                tmIvr.sPayAddr(2) = Trim$(tgSpf.sBPayAddr(1))
                tmIvr.sPayAddr(3) = Trim$(tgSpf.sBPayAddr(2))
            End If
        Else
            tmIvr.sPayAddr(0) = Trim$(tmArf.sNmAd(0))
            tmIvr.sPayAddr(1) = Trim$(tmArf.sNmAd(1))
            tmIvr.sPayAddr(2) = Trim$(tmArf.sNmAd(2))
            tmIvr.sPayAddr(3) = Trim$(tmArf.sNmAd(3))
        End If
        If tmAgf.iMnfSort > 0 Then
            tmIvr.iMnfSort = tmAgf.iMnfSort
        Else
            tmIvr.iMnfSort = tmAdf.iMnfSort
        End If
        tmMnfSrchKey.iCode = tmAgf.iMnfInvTerms
        If tmMnfSrchKey.iCode > 0 Then
            If tmMnf.iCode <> tmMnfSrchKey.iCode Then
                ilRet = btrGetEqual(hmMnf, tmMnf, imMnfRecLen, tmMnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            Else
                ilRet = BTRV_ERR_NONE
            End If
            If ilRet = BTRV_ERR_NONE Then
                smTerms = Trim$(tmMnf.sName)
            End If
        End If
        
        blPDFFlag = False       '12-18-16
        '10016
        If mIsAllowedToPdFEmail(ilAddNTR) Then
            If mIsItPDFEmail(tmAgf.iArfInvCode) Then      'see if this agency is emailing pdf invoices
                blPDFFlag = True                            '12-18-16 need to know if pdf to exclude from finals
                blFoundInvPDF = False
                tgInvPDF_Info(UBound(tgInvPDF_Info)).iAdfCode = 0
                For ilLoopOnInvPDF = LBound(tgInvPDF_Info) To UBound(tgInvPDF_Info) - 1
                    If tgInvPDF_Info(ilLoopOnInvPDF).iAgfCode = tgChfInv.iAgfCode Then
                        blFoundInvPDF = True
                        'Fix RE: v81 TTP 10826 - updated test results Thu 1/18/24 2:18 PM (Issue 4)
                        'Determine if this Agy / Adv has AitTime and NTR....
                        If tgChfInv.sNTRDefined <> "N" Then
                            tgInvPDF_Info(ilLoopOnInvPDF).bHasNTR = True
                        End If
                        If tgInvPDF_Info(ilLoopOnInvPDF).bHasAirTime = True Then
                            tgInvPDF_Info(ilLoopOnInvPDF).bHasAirTime = True
                        End If
                        Exit For
                    End If
                Next ilLoopOnInvPDF
                If Not blFoundInvPDF Then
                    'Fix RE: v81 TTP 10826 - updated test results Thu 1/18/24 2:18 PM (Issue 4)
                    'Determine if this Agy / Adv has AitTime and NTR....
                    If tgChfInv.sNTRDefined <> "N" Then
                        tgInvPDF_Info(ilLoopOnInvPDF).bHasNTR = True
                    End If
                    If tgInvPDF_Info(ilLoopOnInvPDF).bHasAirTime = True Then
                        tgInvPDF_Info(ilLoopOnInvPDF).bHasAirTime = True
                    End If
                    tgInvPDF_Info(UBound(tgInvPDF_Info)).iAgfCode = tgChfInv.iAgfCode   'array of unique agency codes
                    tgInvPDF_Info(UBound(tgInvPDF_Info)).sPayeeName = tmAgf.sName
                    tgInvPDF_Info(UBound(tgInvPDF_Info)).iAdfCode = tgChfInv.iAdfCode   '7-6-17
    
                    slTempPath = Trim$(sgExportPath)
                    If right(slTempPath, 1) <> "\" Then
                        slTempPath = slTempPath & "\"
                    End If
                    For ilLoopOnArf = 0 To UBound(tgEDIServiceInfo) - 1 Step 1
                        If Trim$(tgEDIServiceInfo(ilLoopOnArf).tArf.iCode) = tmAgf.iArfInvCode Then
                            tgInvPDF_Info(UBound(tgInvPDF_Info)).sPDFExportPath = slTempPath & Trim$(tgEDIServiceInfo(ilLoopOnArf).tArf.sID)
                            Exit For
                        End If
                    Next ilLoopOnArf
                    slPDFEmailAddress = mGetPDFEmailAddress(True, tmAgf.iCode)
                    tgInvPDF_Info(UBound(tgInvPDF_Info)).sPDFEmailAddress = Trim$(slPDFEmailAddress)
                    tgInvPDF_Info(UBound(tgInvPDF_Info)).iSelectiveEmail = 0 'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                    
                    ReDim Preserve tgInvPDF_Info(0 To UBound(tgInvPDF_Info) + 1) As INVPDF_INFO
                End If
                
                '7-6-17 create list of pdf emails to send for csv
                tgInvPDF_DetailInfo(UBound(tgInvPDF_DetailInfo)).iAdfCode = tgChfInv.iAdfCode
                tgInvPDF_DetailInfo(UBound(tgInvPDF_DetailInfo)).iAgfCode = tgChfInv.iAgfCode
                tgInvPDF_DetailInfo(UBound(tgInvPDF_DetailInfo)).sAdvtName = tmAdf.sName
                tgInvPDF_DetailInfo(UBound(tgInvPDF_DetailInfo)).lCntrNo = tgChfInv.lCntrNo
                tgInvPDF_DetailInfo(UBound(tgInvPDF_DetailInfo)).lInvNo = llInvoiceNo
                
                ReDim Preserve tgInvPDF_DetailInfo(0 To UBound(tgInvPDF_DetailInfo) + 1) As InvPDF_DETAILINFO
            End If
        End If
    Else
        tmAgf.sPkInvShow = "D"
        If (tgSpf.sBLaserForm = "2") Or (ilType = 1) Then
            ilAttnCode = tmAdf.iPnfPay
        Else
            ilAttnCode = tmAdf.iPnfPay
        End If
        If Trim$(tmAdf.sBillAddr(0)) <> "" Then
            If (InStr(1, tmAdf.sBillAddr(0), "Attn:", 1) > 0) Or (InStr(1, tmAdf.sBillAddr(1), "Attn:", 1) > 0) Then
                slStr = Trim$(tmAdf.sName) & Chr$(10) & Trim$(tmAdf.sBillAddr(0)) & Chr$(10) & Trim$(tmAdf.sBillAddr(1)) & Chr$(10) & Trim$(tmAdf.sBillAddr(2)) & Chr$(0)
            Else
                If ilAttnCode > 0 Then  'tmAdf.iPnfPay > 0 Then
                    tmPnfSrchKey.iCode = ilAttnCode 'tmAdf.iPnfPay
                    ilRet = btrGetEqual(hmPnf, tmPnf, imPnfRecLen, tmPnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet = BTRV_ERR_NONE Then
                        slStr = Trim$(tmAdf.sName) & Chr$(10) & "Attn: " & Trim$(tmPnf.sName) & Chr$(10) & Trim$(tmAdf.sBillAddr(0)) & Chr$(10) & Trim$(tmAdf.sBillAddr(1)) & Chr$(10) & Trim$(tmAdf.sBillAddr(2)) & Chr$(0)
                    Else
                        slStr = Trim$(tmAdf.sName) & Chr$(10) & "Attn: Accounts Payable" & Chr$(10) & Trim$(tmAdf.sBillAddr(0)) & Chr$(10) & Trim$(tmAdf.sBillAddr(1)) & Chr$(10) & Trim$(tmAdf.sBillAddr(2)) & Chr$(0)
                    End If
                Else
                    slStr = Trim$(tmAdf.sName) & Chr$(10) & "Attn: Accounts Payable" & Chr$(10) & Trim$(tmAdf.sBillAddr(0)) & Chr$(10) & Trim$(tmAdf.sBillAddr(1)) & Chr$(10) & Trim$(tmAdf.sBillAddr(2)) & Chr$(0)
                End If
            End If
        Else
            If (InStr(1, tmAdf.sCntrAddr(0), "Attn:", 1) > 0) Or (InStr(1, tmAdf.sCntrAddr(1), "Attn:", 1) > 0) Then
                slStr = Trim$(tmAdf.sName) & Chr$(10) & Trim$(tmAdf.sCntrAddr(0)) & Chr$(10) & Trim$(tmAdf.sCntrAddr(1)) & Chr$(10) & Trim$(tmAdf.sCntrAddr(2)) & Chr$(0)
            Else
                If ilAttnCode > 0 Then  'tmAdf.iPnfPay > 0 Then
                    '12-5-05 Regardless of type of invoice, always show the Payables Name, or "Attn:  Accounts Paybles"
                    tmPnfSrchKey.iCode = ilAttnCode 'tmAdf.iPnfPay
                    ilRet = btrGetEqual(hmPnf, tmPnf, imPnfRecLen, tmPnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet = BTRV_ERR_NONE Then
                        slStr = Trim$(tmAdf.sName) & Chr$(10) & "Attn: " & Trim$(tmPnf.sName) & Chr$(10) & Trim$(tmAdf.sCntrAddr(0)) & Chr$(10) & Trim$(tmAdf.sCntrAddr(1)) & Chr$(10) & Trim$(tmAdf.sCntrAddr(2)) & Chr$(0)
                    Else
                        slStr = Trim$(tmAdf.sName) & Chr$(10) & "Attn: Accounts Payable" & Chr$(10) & Trim$(tmAdf.sCntrAddr(0)) & Chr$(10) & Trim$(tmAdf.sCntrAddr(1)) & Chr$(10) & Trim$(tmAdf.sCntrAddr(2)) & Chr$(0)
                    End If
                Else
                    slStr = Trim$(tmAdf.sName) & Chr$(10) & "Attn: Accounts Payable" & Chr$(10) & Trim$(tmAdf.sCntrAddr(0)) & Chr$(10) & Trim$(tmAdf.sCntrAddr(1)) & Chr$(10) & Trim$(tmAdf.sCntrAddr(2)) & Chr$(0)
                End If
            End If
        End If
        
        For ilLoop = LBound(tmIvr.sAddr) To UBound(tmIvr.sAddr) Step 1
            tmIvr.sAddr(ilLoop) = ""
            ilRet = gParseItem(slStr, ilLoop + 1, Chr(10), slParse)
            If (ilRet = CP_MSG_NONE) Then
                ilPos = InStr(slParse, Chr$(0))
                If ilPos > 0 Then
                    slParse = Left$(slParse, ilPos - 1)
                End If
                tmIvr.sAddr(ilLoop) = slParse
            End If
        Next ilLoop
        If Not ilVefLockBox Then
            If tmAdf.iArfLkCode > 0 Then
                'v81 testing results 3-28-22 - Issue 2: direct advertiser is not showing the lockbox on the invoice and EDI invoice form.
                If tmArfSrchKey.iCode <> tmAdf.iArfLkCode Then
                    tmArfSrchKey.iCode = tmAdf.iArfLkCode
                    ilRet = btrGetEqual(hmArf, tmArf, imArfRecLen, tmArfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        tmArf.sNmAd(0) = "Missing"
                        tmArf.sNmAd(1) = " "
                        tmArf.sNmAd(2) = " "
                        tmArf.sNmAd(3) = " "
                    End If
                End If
                tmIvr.sPayAddr(0) = Trim$(tmArf.sNmAd(0))
                tmIvr.sPayAddr(1) = Trim$(tmArf.sNmAd(1))
                tmIvr.sPayAddr(2) = Trim$(tmArf.sNmAd(2))
                tmIvr.sPayAddr(3) = Trim$(tmArf.sNmAd(3))
            Else
                tmIvr.sPayAddr(0) = Trim$(tgSpf.sBPayName)
                tmIvr.sPayAddr(1) = Trim$(tgSpf.sBPayAddr(0))
                tmIvr.sPayAddr(2) = Trim$(tgSpf.sBPayAddr(1))
                tmIvr.sPayAddr(3) = Trim$(tgSpf.sBPayAddr(2))
            End If
        Else
            tmIvr.sPayAddr(0) = Trim$(tmArf.sNmAd(0))
            tmIvr.sPayAddr(1) = Trim$(tmArf.sNmAd(1))
            tmIvr.sPayAddr(2) = Trim$(tmArf.sNmAd(2))
            tmIvr.sPayAddr(3) = Trim$(tmArf.sNmAd(3))
        End If
        tmIvr.iMnfSort = tmAdf.iMnfSort
        tmMnfSrchKey.iCode = tmAdf.iMnfInvTerms
        If tmMnfSrchKey.iCode > 0 Then
            If tmMnf.iCode <> tmMnfSrchKey.iCode Then
                ilRet = btrGetEqual(hmMnf, tmMnf, imMnfRecLen, tmMnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            Else
                ilRet = BTRV_ERR_NONE
            End If
            If ilRet = BTRV_ERR_NONE Then
                smTerms = Trim$(tmMnf.sName)
            End If
        End If
        '10016
        If mIsAllowedToPdFEmail(ilAddNTR) Then
            If mIsItPDFEmail(tmAdf.iArfInvCode) Then       'is this direct advt emailing pdf invoices
                blPDFFlag = True                            '12-18-16 need to know if pdf to exclude from finals
                blFoundInvPDF = False
                tgInvPDF_Info(UBound(tgInvPDF_Info)).iAgfCode = 0
                For ilLoopOnInvPDF = LBound(tgInvPDF_Info) To UBound(tgInvPDF_Info) - 1
                    If tgInvPDF_Info(ilLoopOnInvPDF).iAdfCode = tgChfInv.iAdfCode Then
                        blFoundInvPDF = True
                        Exit For
                    End If
                Next ilLoopOnInvPDF
                If Not blFoundInvPDF Then
                    tgInvPDF_Info(UBound(tgInvPDF_Info)).iAdfCode = tgChfInv.iAdfCode   'array of unique direct advt codes
                    tgInvPDF_Info(UBound(tgInvPDF_Info)).sPayeeName = tmAdf.sName
                    tgInvPDF_Info(UBound(tgInvPDF_Info)).iAgfCode = tgChfInv.iAgfCode   '7-6-17
    
                    slTempPath = Trim$(sgExportPath)
                    If right(slTempPath, 1) <> "\" Then
                        slTempPath = slTempPath & "\"
                    End If
    
                    For ilLoopOnArf = 0 To UBound(tgEDIServiceInfo) - 1 Step 1
                        If Trim$(tgEDIServiceInfo(ilLoopOnArf).tArf.iCode) = tmAdf.iArfInvCode Then
                            tgInvPDF_Info(UBound(tgInvPDF_Info)).sPDFExportPath = slTempPath & Trim$(tgEDIServiceInfo(ilLoopOnArf).tArf.sID)
                            Exit For
                        End If
                    Next ilLoopOnArf
                    slPDFEmailAddress = mGetPDFEmailAddress(False, tmAdf.iCode)
                    tgInvPDF_Info(UBound(tgInvPDF_Info)).sPDFEmailAddress = Trim$(slPDFEmailAddress)
                    tgInvPDF_Info(UBound(tgInvPDF_Info)).iSelectiveEmail = 0 'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist

                    ReDim Preserve tgInvPDF_Info(0 To UBound(tgInvPDF_Info) + 1) As INVPDF_INFO
                End If
                
                '7-6-17 create list of pdf emails to send for csv
                tgInvPDF_DetailInfo(UBound(tgInvPDF_DetailInfo)).iAdfCode = tgChfInv.iAdfCode
                tgInvPDF_DetailInfo(UBound(tgInvPDF_DetailInfo)).iAgfCode = tgChfInv.iAgfCode
                tgInvPDF_DetailInfo(UBound(tgInvPDF_DetailInfo)).sAdvtName = tmAdf.sName
                tgInvPDF_DetailInfo(UBound(tgInvPDF_DetailInfo)).lCntrNo = tgChfInv.lCntrNo
                tgInvPDF_DetailInfo(UBound(tgInvPDF_DetailInfo)).lInvNo = llInvoiceNo
                ReDim Preserve tgInvPDF_DetailInfo(0 To UBound(tgInvPDF_DetailInfo) + 1) As InvPDF_DETAILINFO
                
            End If
        End If
    End If
    tmIvr.iShowInvType = 0
    If (tgSpf.sBLaserForm = "2") Then
        If imInvGenType = 1 Then
            tmIvr.iFormType = 1
        Else
            If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                tmIvr.iFormType = 0
            Else
                tmIvr.iFormType = 1
            End If
        End If
    End If
    tmIvr.iCTSplit = 0
    slStr = ""
    If (Val(slPctTrade) = 0) Or (Val(slPctTrade) = 100) Then
        If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value Then    '11-15-16 Reprint or archive via invoice numbers
            If ckcShowPrel.Value = vbChecked Then
                slStr = "(Reprint)"
                tmIvr.iShowInvType = 2
            End If
        ElseIf (rbcType(INVGEN_Undo).Value) And (ckcShowPrel.Value = vbChecked) Then    '10-31-01 Preliminary via invoice numbers
            slStr = "(Revised)"
            tmIvr.iShowInvType = 4
        ElseIf (rbcType(INVGEN_Preliminary).Value) And (ckcShowPrel.Value = vbChecked) Then    '10-31-01 Preliminary via invoice numbers
            slStr = "(Preliminary)"
            tmIvr.iShowInvType = 1
        '12-18-16 if finals, archive,along with EDI that is to be ignored, create it so its archived, set flag to 5 to include in archive run
        'otherwise, include it in the printout and archive
        ElseIf (rbcType(INVGEN_Final).Value) And (ckcArchive.Value = vbChecked) And (ilEDIFlag) And ckcIncludeEDI.Value = vbUnchecked Then     'if finals and archive selected, and this invoice is edi defined, flag it so its ignored in normal run
            tmIvr.iShowInvType = 5                      '11-16-16 Archive inv that should be ignored in normal run
        ElseIf (rbcType(INVGEN_Final).Value) And (blPDFFlag) Then     '12-18-16 -final & its pdf email, exclude from finals printout, include if archiving
            tmIvr.iShowInvType = 5
        End If
    Else
        If ilPass = 1 Then
            slStr = "(" & gSubStr("100", slPctTrade) & "% of Order)"
            tmIvr.iCTSplit = 100 - tgChfInv.iPctTrade
        Else
            slStr = "(" & slPctTrade & "% of Order)"
            tmIvr.iCTSplit = tgChfInv.iPctTrade
        End If
        If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value Then    '11-15-16 Reprint or archive via invoice numbers
            If ckcShowPrel.Value = vbChecked Then
                slStr = "(Reprint)"
                tmIvr.iShowInvType = 2
            End If
        ElseIf (rbcType(INVGEN_Undo).Value) And (ckcShowPrel.Value = vbChecked) Then    '10-31-01 Preliminary via invoice numbers
            slStr = slStr & Chr$(10) & "(Revised)"
        ElseIf (rbcType(INVGEN_Preliminary).Value) And (ckcShowPrel.Value = vbChecked) Then    '10-31-01 Preliminary via invoice numbers
            slStr = slStr & Chr$(10) & "(Preliminary)"
            tmIvr.iShowInvType = 1
        '12-18-16 if finals, archive,along with EDI that is to be ignored, create it so its archived, set flag to 5 to include in archive run
        'otherwise, include it in the printout and archive
        ElseIf (rbcType(INVGEN_Final).Value) And (ckcArchive.Value = vbChecked) And (ilEDIFlag) And (ckcIncludeEDI.Value = vbUnchecked) Then     'if finals and archive selected, and this invoice is edi defined, flag it so its ignored in normal run
            tmIvr.iShowInvType = 5                      '11-16-16 Archive inv that should be ignored in normal run
        ElseIf (rbcType(INVGEN_Final).Value) And (blPDFFlag) Then     '12-18-16 -final & its pdf email, exclude from finals printout, include if archiving
            tmIvr.iShowInvType = 5
        End If
    End If
    slStr = smTerms '"15 Days Upon Receipt"
    tmIvr.sTerms = slStr
    Select Case tmChf.sBillCycle
        Case "S"    'Standard
            slStr = "Standard"
            If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                slStr = "As Ordered"
            Else
                slStr = "As Aired"
            End If
        Case "C"    'Calendar
            slStr = "Calendar"
            If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                slStr = "As Ordered"
            Else
                slStr = "As Aired"
            End If
        Case "W"    'Weekly
            slStr = "Week"
            If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                slStr = "As Ordered"
            Else
                slStr = "As Aired"
            End If
        Case "T"    'Package-Standard
            slStr = "Standard"
            slStr = "Package"
        Case "D"    'Package-Calendar
            slStr = "Calendar"
            slStr = "Package"
        Case Else
            slStr = ""
            slStr = ""
    End Select
    If (Trim$(tmChf.sAgyEstNo) <> "") And (Trim$(tmChf.sAgyEstNo) <> "0") Then
        If Trim$(tmChf.sProduct) = "" Then
            slStr = Trim$(tmChf.sAgyEstNo) & Trim$(tmChf.sTitle) & Chr$(0)
        Else
            slStr = UCase$(Trim$(tmChf.sProduct)) & "/" & Trim$(tmChf.sAgyEstNo) & Trim$(tmChf.sTitle) & Chr$(0)
        End If
    Else
        slStr = UCase$(Trim$(tmChf.sProduct)) & Chr$(0)
    End If
    If tgChfInv.iSlfCode(0) > 0 Then
        If tgChfInv.iSlfCode(0) <> tmSlf.iCode Then
            tmSlfSrchKey.iCode = tgChfInv.iSlfCode(0)
            ilRet = btrGetEqual(hmSlf, tmSlf, imSlfRecLen, tmSlfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                tmSlf.sLastName = ""
                tmSlf.iSofCode = 0
            End If
        End If
    End If
    'Obtain Selling office
    If tmSlf.iSofCode > 0 Then
        If tmSlf.iSofCode <> tmSof.iCode Then
            tmSofSrchKey.iCode = tmSlf.iSofCode
            ilRet = btrGetEqual(hmSof, tmSof, imSofRecLen, tmSofSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet = BTRV_ERR_NONE Then
                slStr = Trim$(tmSlf.sLastName) & "/" & Trim$(tmSof.sName) & Chr$(0)
            Else
                slStr = Trim$(tmSlf.sLastName) & Chr$(0)
            End If
        Else
            slStr = Trim$(tmSlf.sLastName) & "/" & Trim$(tmSof.sName) & Chr$(0)
        End If
    Else
        slStr = Trim$(tmSlf.sLastName) & Chr$(0)
    End If
    If (((ilType = 0) Or (ilAddNTR)) And ((imCombineAirAndNTR)) Or ((ilType = 0) And (Asc(tgSaf(0).sFeatures8) And PODADSERVER) = PODADSERVER)) Then
        tmAirNTRCombine(UBound(tmAirNTRCombine)).lChfCode = tmChf.lCode
        tmAirNTRCombine(UBound(tmAirNTRCombine)).lInvNo = llInvoiceNo
        tmAirNTRCombine(UBound(tmAirNTRCombine)).sCashTrade = tmIvr.sCashTrade
        tmAirNTRCombine(UBound(tmAirNTRCombine)).iEDIFlag = ilEDIFlag
        tmAirNTRCombine(UBound(tmAirNTRCombine)).iArfPDFEMailCode = imArfPDFEMailCode
        ReDim Preserve tmAirNTRCombine(0 To UBound(tmAirNTRCombine) + 1) As AIRNTRCOMBINE
    End If
    
    '--------------------------------------------------
    'TTP 10622 - Invoice: exclude trade portion from "pay this amount" value shown on the final invoice page
    '--------------------------------------------------
    'Upper-Case "T"=Trade Invoice (don't Suppress net Amount), Lower-Case "t"=Trade Invoice (Suppress net Amount)
    If tmIvr.sCashTrade = "T" Then
        'Check suppress Net Amount for trade invoices (AgfxInvFeatures and AdfxInvFeatures)
        If CheckSuppressNetAmount(tgChfInv.iAgfCode, tgChfInv.iAdfCode) Then
            tmIvr.sCashTrade = "t" '"Suppress net Amount" from this Trade invoice?
        End If
    End If
    
    gInvExportHeaderBuildInfo tmIvr, tmAdf, tmAgf, tmSlf, tmSof, smTerms           '5-12-17
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mRepInv_GenIvr                  *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Initiate fields                 *
'*                                                     *
'*******************************************************
Sub mRepInv_GenIvr()
    Dim ilSbf As Integer
    Dim ilImpactPrt As Integer
    Dim ilPass As Integer
    Dim ilFound As Integer
    Dim slPctTrade As String
    Dim ilVeh As Integer
    Dim slForm2Key As String
    Dim ilONoSpots As Integer
    Dim llANoSpots As Long
    Dim llOTotalNoSpots As Long
    Dim llOGross As Long
    Dim llAGross As Long
    Dim llOTotalGross As Long
    Dim llSumOGross As Long     'Cash or Trade Ordered total
    Dim llSumAGross As Long     'Cash or Trade actual total
    Dim llANet As Long
    Dim slProduct As String
    Dim ilRvf As Integer
    Dim ilSRvf As Integer
    Dim slAgyRate As String
    Dim slGross As String
    Dim slStr As String
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim ilLoop1 As Integer
    Dim ilIndex As Integer
    Dim ilMnf As Integer
    Dim llChfCode As Long
    Dim ilCheck As Integer
    Dim ilSpots As Integer
    Dim ilCarried As Integer
    Dim llInvNo As Long
    Dim llSbfDate As Long
    Dim ilMatch As Integer
    Dim llInvoiceNo As Long
    Dim ilPos As Integer
    Dim ilClf1 As Integer
    Dim ilClf2 As Integer
    Dim ilPkLineNo As Integer
    Dim ilNowTime(0 To 1) As Integer        '10-31-01
    Dim slEDITotalAired As String   'EDI Grand Total of Dollars Aired
    Dim ilEDITotalNoInv As Integer  'EDI Grand Total of invoices generated
    Dim ilEDIFlag As Integer
    Dim ilUpdateBillFlag As Integer
    Dim ilEDI As Integer
    Dim blPostByLine As Boolean
    Dim blPostByCount As Boolean

    'If (tgSpf.sAEDII = "Y") And (tgSpf.sPostCalAff = "D") Then
    If (tgSpf.sAEDII = "Y") And ((Asc(tgSpf.sUsingFeatures8) And REPBYDT) = REPBYDT) Then
        If Not mInitEDI(1) Then
            Exit Sub
        End If
    End If

    smRemoteGenDate = Format$(Now, "m/d/yy")
    lmRemoteGenDate = gDateValue(smRemoteGenDate)
    smRemoteGenTime = Format$(Now, "h:mm:ssAM/PM")
    lmRemoteGenTime = gTimeToLong(smRemoteGenTime, False)

    slEDITotalAired = ".00"
    ilEDITotalNoInv = 0

    gPackDate smRemoteGenDate, tmIvr.iGenDate(0), tmIvr.iGenDate(1)
    'gPackTime smSbfGenTime, tmIvr.iGenTime(0), tmIvr.iGenTime(1)
    gPackTime smRemoteGenTime, ilNowTime(0), ilNowTime(1)
    gUnpackTimeLong ilNowTime(0), ilNowTime(1), False, tmIvr.lGenTime
    tmIvr.lDisclaimer = tgSpf.lBCxfDisclaimer

    ilImpactPrt = False
    tmIvr.lSpotKeyNo = 0
    ilSbf = LBound(tgSbfCntr)
    Do While ilSbf <= UBound(tgSbfCntr) - 1
        ilUpdateBillFlag = False
        llChfCode = tgSbfCntr(ilSbf).tSbf.lChfCode
        llSbfDate = tgSbfCntr(ilSbf).lSDate
        tmChfSrchKey.lCode = llChfCode
        ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If ilRet = BTRV_ERR_NONE Then
            If tgChfInv.sBillCycle = "C" Then
                gUnpackDate tgSbfCntr(ilSbf).tSbf.iDate(0), tgSbfCntr(ilSbf).tSbf.iDate(1), smStartCal
                smStartCal = gObtainStartCal(smStartCal)
                smEndCal = gObtainEndCal(smStartCal)
                lmStartCal = gDateValue(smStartCal)
                lmEndCal = gDateValue(smEndCal)
            ElseIf tgChfInv.sBillCycle = "W" Then
                gUnpackDate tgSbfCntr(ilSbf).tSbf.iDate(0), tgSbfCntr(ilSbf).tSbf.iDate(1), smStartWk
                smStartWk = gObtainPrevMonday(smStartWk)
                smEndWk = gObtainNextSunday(smStartWk)
                lmStartWk = gDateValue(smStartWk)
                lmEndWk = gDateValue(smEndWk)
            Else
                gUnpackDate tgSbfCntr(ilSbf).tSbf.iDate(0), tgSbfCntr(ilSbf).tSbf.iDate(1), smStartStd
                smStartStd = gObtainStartStd(smStartStd)
                smEndStd = gObtainEndStd(smStartStd)
                lmStartStd = gDateValue(smStartStd)
                lmEndStd = gDateValue(smEndStd)
            End If
            tgSortKey(UBound(tgSortKey)).lCntrNo = tgChfInv.lCntrNo
            tgSortKey(UBound(tgSortKey)).lChfCode = tgChfInv.lCode
            tgSortKey(UBound(tgSortKey)).lSbfDate = llSbfDate
            tgSortKey(UBound(tgSortKey)).iType = 10
            'Moved to create rvf records
            'If rbcType(INVGEN_Final).Value Then
            '    tgSortKey(UBound(tgSortKey)).iBilled = True
            'Else
                tgSortKey(UBound(tgSortKey)).iBilled = False
            'End If
            ReDim Preserve tgSortKey(0 To UBound(tgSortKey) + 1) As TYPESORTKEY
            slPctTrade = gIntToStrDec(tgChfInv.iPctTrade, 0)
            slProduct = Trim$(tgChfInv.sProduct)
            For ilPass = 1 To 2 Step 1
                ilFound = False
                If (ilPass = 1) And (tgChfInv.iPctTrade <> 100) Then
                    ilFound = True
                End If
                If (ilPass = 2) And (tgChfInv.iPctTrade <> 0) Then
                    ilFound = True
                End If
                If ilFound Then
                    'Determine Aired Gross, Ordered number of spots, Aired number of Spots
                    llOGross = 0
                    llAGross = 0
                    llSumOGross = 0
                    llSumAGross = 0
                    llANet = 0
                    ilONoSpots = 0
                    llANoSpots = 0
                    llOTotalNoSpots = 0
                    llOTotalGross = 0
                    llChfCode = tgChfInv.lCode
                    mRepInv_ObtainCntrInfo llChfCode, ilPass, slPctTrade, llOGross, ilONoSpots
                    blPostByLine = False
                    blPostByCount = False
                    For ilIndex = LBound(tmRepMatch) To UBound(tmRepMatch) - 1 Step 1
                        If tmRepMatch(ilIndex).sPostBy = "L" Then
                            blPostByLine = True
                        Else
                            blPostByCount = True
                        End If
                    Next ilIndex
                    ilFound = True
                    If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then     '11-15-16 reprint, aff, or archive, or undo: Determine invoice number
                        ilFound = False
                        For ilLoop = 0 To UBound(tmRPInfo) - 1 Step 1
                            If (tgChfInv.lCntrNo = tmRPInfo(ilLoop).lCntrNo) And (tmRPInfo(ilLoop).iMnfItem = 0) Then
                                If ilPass = 1 Then
                                    If (tmRPInfo(ilLoop).sCashTrade = "C") Then
                                        llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                                        ilFound = True
                                        Exit For
                                    End If
                                Else
                                    If (tmRPInfo(ilLoop).sCashTrade = "T") Then
                                        llInvoiceNo = tmRPInfo(ilLoop).lInvNo
                                        ilFound = True
                                        Exit For
                                    End If
                                End If
                            End If
                        Next ilLoop
                    Else
                        'Determine invoice number
                        'ilFound = mRvfExist(llInvNo, 0, 0)
                        If ilPass = 1 Then
                            ilFound = mRvfExist(llInvNo, 0, 0, "C")
                        Else
                            ilFound = mRvfExist(llInvNo, 0, 0, "T")
                        End If
                        llInvoiceNo = llInvNo
                    End If

                    'Test that contract has been completely posted
                    If ilFound Then
                        ilFound = False
                        For ilIndex = LBound(tmRepMatch) To UBound(tmRepMatch) - 1 Step 1
                            ilFound = False
                            'Must match on each line price to know that it was posted.
                            'For ilCheck = 1 To 2 Step 1
                            For ilCheck = 1 To 1 Step 1
                                For ilLoop = ilSbf To UBound(tgSbfCntr) - 1 Step 1
                                    If (llChfCode <> tgSbfCntr(ilLoop).tSbf.lChfCode) Or (llSbfDate <> tgSbfCntr(ilLoop).lSDate) Then
                                        Exit For
                                    Else
                                        'Look if Vehicle exist
                                        'If tgSpf.sPostCalAff <> "D" Then
                                        If tmRepMatch(ilIndex).sPostBy = "C" Then
                                            If ((tmRepMatch(ilIndex).iVefCode = tgSbfCntr(ilLoop).tSbf.iAirVefCode) And (tmRepMatch(ilIndex).lPrice = tgSbfCntr(ilLoop).tSbf.lSpotPrice) And (ilCheck = 1)) Or ((tmRepMatch(ilIndex).iVefCode = tgSbfCntr(ilLoop).tSbf.iAirVefCode) And (ilCheck = 2)) Then
                                                ilFound = True
                                                Exit For
                                            End If
                                        Else
                                            If ((tmRepMatch(ilIndex).iVefCode = tgSbfCntr(ilLoop).tSbf.iAirVefCode) And (tmRepMatch(ilIndex).iLineNo = tgSbfCntr(ilLoop).tSbf.iLineNo) And (ilCheck = 1)) Or ((tmRepMatch(ilIndex).iVefCode = tgSbfCntr(ilLoop).tSbf.iAirVefCode) And (ilCheck = 2)) Then
                                                ilFound = True
                                                Exit For
                                            End If
                                        End If
                                    End If
                                Next ilLoop
                                If ilFound Then
                                    Exit For
                                End If
                            Next ilCheck
                            'If not found, then stop looking as this contract can't be invoiced
                            If Not ilFound Then
                                Exit For
                            End If
                        Next ilIndex
                    End If

                    If ilFound Then

                        tmChf = tgChfInv
                        mGetComment
                        mGetAdfAgfSlf
                        ilEDIFlag = False
                        imArfPDFEMailCode = -1
                        If (tgSpf.sAEDII = "Y") And (Not blPostByCount) Then
                            ilEDIFlag = mDetermineIfEDIRequired()
                        End If
                        'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81; Add Contract # so that the contract can be checked for AirTime/CPM & NTR to determine if Header should show NTR
                        mGenHeader ilImpactPrt, llInvoiceNo, ilPass, slPctTrade, 1, False, ilEDIFlag, tmChf.lCntrNo
                        'Build array of markets
                        ReDim ilMktIndex(0 To 0) As Integer
                        For ilLoop = ilSbf To UBound(tgSbfCntr) - 1 Step 1
                            tgSbfCntr(ilLoop).iANoSpots = 0
                            tgSbfCntr(ilLoop).lAGross = 0
                            If (llChfCode <> tgSbfCntr(ilLoop).tSbf.lChfCode) Or (llSbfDate <> tgSbfCntr(ilLoop).lSDate) Then
                                ilFound = True
                                Exit For
                            Else
                                ilFound = False
                                'For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                                '    If (tgSbfCntr(ilLoop).tSbf.iAirVefCode = tgMVef(ilVeh).iCode) Then
                                    ilVeh = gBinarySearchVef(tgSbfCntr(ilLoop).tSbf.iAirVefCode)
                                    If ilVeh <> -1 Then
                                        If (Trim$(tgSpf.sRepRptForm) = "V") Then
                                            ilFound = False
                                            'If Virtual, then sum hidden into virtual
                                            'If tgSpf.sPostCalAff = "D" Then
                                            If (Asc(tgSpf.sUsingFeatures8) And REPBYDT) = REPBYDT Then
                                                If tgSbfCntr(ilLoop).tSbf.iLineNo > 0 Then
                                                    For ilClf1 = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                                        If tgClfInv(ilClf1).ClfRec.iLine = tgSbfCntr(ilLoop).tSbf.iLineNo Then
                                                            If tgClfInv(ilClf1).ClfRec.iPkLineNo > 0 Then
                                                                For ilClf2 = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                                                    If tgClfInv(ilClf2).ClfRec.iLine = tgClfInv(ilClf1).ClfRec.iPkLineNo Then
                                                                        If gBinarySearchVef(tgClfInv(ilClf2).ClfRec.iVefCode) <> -1 Then
                                                                            ilCheck = gBinarySearchVef(tgClfInv(ilClf2).ClfRec.iVefCode)
                                                                            If tgMVef(ilCheck).sStdInvTime = "O" Then
                                                                                ilVeh = -ilCheck
                                                                            End If
                                                                        End If
                                                                        Exit For
                                                                    End If
                                                                Next ilClf2
                                                                Exit For
                                                            End If
                                                        End If
                                                    Next ilClf1
                                                End If
                                            End If
                                            For ilCheck = LBound(ilMktIndex) To UBound(ilMktIndex) - 1 Step 1
                                                If ilMktIndex(ilCheck) = ilVeh Then
                                                    ilFound = True
                                                    Exit For
                                                End If
                                            Next ilCheck
                                            If Not ilFound Then
                                                ilMktIndex(UBound(ilMktIndex)) = ilVeh
                                                ReDim Preserve ilMktIndex(0 To UBound(ilMktIndex) + 1) As Integer
                                                ilFound = True
                                            End If
                                        Else
                                            For ilMnf = LBound(tgMkMnf) To UBound(tgMkMnf) - 1 Step 1
                                                If (tgMVef(ilVeh).iMnfVehGp3Mkt = tgMkMnf(ilMnf).iCode) Or (Trim$(tgSpf.sRepRptForm) = "V") Then
                                                    ilFound = False
                                                    For ilCheck = LBound(ilMktIndex) To UBound(ilMktIndex) - 1 Step 1
                                                        If ilMktIndex(ilCheck) = ilMnf Then
                                                            ilFound = True
                                                            Exit For
                                                        End If
                                                    Next ilCheck
                                                    If Not ilFound Then
                                                        ilMktIndex(UBound(ilMktIndex)) = ilMnf
                                                        ReDim Preserve ilMktIndex(0 To UBound(ilMktIndex) + 1) As Integer
                                                        ilFound = True
                                                    End If
                                                    Exit For
                                                End If
                                            Next ilMnf
                                        End If
                                '        Exit For
                                    End If
                                'Next ilVeh
                                If Not ilFound Then
                                    If (Trim$(tgSpf.sRepRptForm) = "V") Then
                                        Print #hmMsg, "  Not all vehicles defined for Contract " & Trim$(str$(tmChf.lCntrNo))
                                    Else
                                        Print #hmMsg, "  Not all markets defined for Contract " & Trim$(str$(tmChf.lCntrNo))
                                    End If
                                    Exit For
                                End If
                            End If
                        Next ilLoop
                        If Not ilFound Then
                            Exit For
                        End If
                        If (tmChf.iAgfCode > 0) And (ilPass = 1) Then   '(Val(slPctTrade) <> 100) Then
                            'gPDNToStr tmAgf.sComm, 2, slAgyRate
                            slAgyRate = gIntToStrDec(tmAgf.iComm, 2)
                            tmIvr.iPctComm = tmAgf.iComm
                        ElseIf (tmChf.iAgfCode > 0) And (tmChf.sAgyCTrade = "Y") And (ilPass = 2) Then   '(Val(slPctTrade) <> 100) Then
                            'gPDNToStr tmAgf.sComm, 2, slAgyRate
                            slAgyRate = gIntToStrDec(tmAgf.iComm, 2)
                            tmIvr.iPctComm = tmAgf.iComm
                        Else
                            slAgyRate = ""
                            tmIvr.iPctComm = 0
                        End If

                        'If (tgSpf.sAEDII = "Y") And (tgSpf.sPostCalAff = "D") Then
                        tmIvr.sEDIComment = ""
                        'ilEDIFlag = False
                        'If (tgSpf.sAEDII = "Y") And (Not blPostByCount) Then
                        '    ilEDIFlag = mDetermineIfEDIRequired()
                            If ilEDIFlag Then
                                If Trim$(tmEDIArf.sNmAd(0)) <> "" Then
                                    tmIvr.sEDIComment = "Electronic Invoice Sent To " & Trim$(tmEDIArf.sNmAd(0))
                                Else
                                    tmIvr.sEDIComment = "Electronic Invoice Sent To " & Trim$(tmEDIArf.sID)
                                End If
                            End If
                        'End If

                        slForm2Key = mRepInv_BuildKey()
                        For ilLoop = 0 To UBound(ilMktIndex) - 1 Step 1
                            tmIvr.iType = IVRTYPE_TotalVefMkt 'Vehicle or Market Subtotal
                            tmIvr.iLineNo = 0           '1-12-05
                            tmIvr.iRdfCode = 0          '4/14/11
                            'tmIvr.sADayDate = "Market"
                            ''tmIvr.iPrgEnfCode = 0
                            ''tmIvr.sOVehName = "No Market Name"
                            ilMnf = ilMktIndex(ilLoop)
                            If (Trim$(tgSpf.sRepRptForm) = "V") Then
                                tmIvr.sADayDate = "Vehicle"
                                tmIvr.iPrgEnfCode = 0   'tgMVef(ilMnf).iCode
                                tmIvr.sOVehName = tgMVef(Abs(ilMnf)).sName
                            Else
                                tmIvr.sADayDate = "Market"
                                tmIvr.iPrgEnfCode = tgMkMnf(ilMnf).iCode
                                tmIvr.sOVehName = tgMkMnf(ilMnf).sName
                            End If
                            llANoSpots = 0
                            llAGross = 0
                            ilONoSpots = 0
                            llOGross = 0
                            For ilLoop1 = ilSbf To UBound(tgSbfCntr) - 1 Step 1
                                If (llChfCode <> tgSbfCntr(ilLoop1).tSbf.lChfCode) Or (llSbfDate <> tgSbfCntr(ilLoop1).lSDate) Then
                                    Exit For
                                Else
                                    'For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                                    '    If (tgSbfCntr(ilLoop1).tSbf.iAirVefCode = tgMVef(ilVeh).iCode) Then
                                        ilVeh = gBinarySearchVef(tgSbfCntr(ilLoop1).tSbf.iAirVefCode)
                                        If ilVeh <> -1 Then
                                            ilPkLineNo = 0
                                            If (Trim$(tgSpf.sRepRptForm) = "V") Then
                                                'If tgSpf.sPostCalAff = "D" Then
                                                If ((Asc(tgSpf.sUsingFeatures8) And REPBYDT) = REPBYDT) Then
                                                    If (tgSbfCntr(ilLoop1).tSbf.iLineNo > 0) Then
                                                        For ilClf1 = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                                            If tgClfInv(ilClf1).ClfRec.iLine = tgSbfCntr(ilLoop1).tSbf.iLineNo Then
                                                                If tgClfInv(ilClf1).ClfRec.iPkLineNo > 0 Then
                                                                    For ilClf2 = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                                                        If tgClfInv(ilClf2).ClfRec.iLine = tgClfInv(ilClf1).ClfRec.iPkLineNo Then
                                                                            If gBinarySearchVef(tgClfInv(ilClf2).ClfRec.iVefCode) <> -1 Then
                                                                                ilCheck = gBinarySearchVef(tgClfInv(ilClf2).ClfRec.iVefCode)
                                                                                If tgMVef(ilCheck).sStdInvTime = "O" Then
                                                                                    ilVeh = -ilCheck
                                                                                    ilPkLineNo = tgClfInv(ilClf1).ClfRec.iPkLineNo
                                                                                End If
                                                                            End If
                                                                            Exit For
                                                                        End If
                                                                    Next ilClf2
                                                                    Exit For
                                                                End If
                                                            End If
                                                        Next ilClf1
                                                    End If
                                                End If
                                                If ilVeh = ilMnf Then
                                                    ilMatch = True
                                                Else
                                                    ilMatch = False
                                                End If
                                            Else
                                                If tgMVef(ilVeh).iMnfVehGp3Mkt = tgMkMnf(ilMnf).iCode Then
                                                    ilMatch = True
                                                Else
                                                    ilMatch = False
                                                End If
                                            End If
                                            If ilMatch Then
                                                If tgSbfCntr(ilLoop1).tSbf.sInserted = "Y" Then
                                                    ilFound = True
                                                    tgSbfCntr(ilLoop1).iANoSpots = tgSbfCntr(ilLoop1).tSbf.iAirNoSpots
                                                    tgSbfCntr(ilLoop1).lAGross = tgSbfCntr(ilLoop1).tSbf.lSpotPrice * (tgSbfCntr(ilLoop1).tSbf.iAirNoSpots)
                                                    'If tgSpf.sPostCalAff = "D" Then
                                                    If ((Asc(tgSpf.sUsingFeatures8) And REPBYDT) = REPBYDT) And (tgSbfCntr(ilLoop1).tSbf.iLineNo > 0) Then
                                                        tgSbfCntr(ilLoop1).iANoSpots = tgSbfCntr(ilLoop1).iANoSpots + tgSbfCntr(ilLoop1).tSbf.iBonusNoSpots
                                                    End If
                                                Else
                                                    'Find Orders that match vehicle and price, compute spots
                                                    For ilCheck = 1 To 2 Step 1
                                                        For ilIndex = LBound(tmRepMatch) To UBound(tmRepMatch) - 1 Step 1
                                                            ilFound = False
                                                            'Look if Vehicle exist
                                                            ilMatch = False
                                                            'If tgSpf.sPostCalAff <> "D" Then
                                                            If tmRepMatch(ilIndex).sPostBy = "C" Then
                                                                If ((tmRepMatch(ilIndex).iVefCode = tgSbfCntr(ilLoop1).tSbf.iAirVefCode) And (tmRepMatch(ilIndex).lPrice = tgSbfCntr(ilLoop1).tSbf.lSpotPrice) And (ilCheck = 1)) Or ((tmRepMatch(ilIndex).iVefCode = tgSbfCntr(ilLoop1).tSbf.iAirVefCode) And (ilCheck = 2)) Then
                                                                    ilMatch = True
                                                                End If
                                                            Else
                                                                'If ((tmRepMatch(ilIndex).iVefCode = tgSbfCntr(ilLoop1).tSbf.iAirVefCode) And (tmRepMatch(ilIndex).lPrice = tgSbfCntr(ilLoop1).tSbf.lSpotPrice) And (tmRepMatch(ilIndex).iLineNo = tgSbfCntr(ilLoop1).tSbf.iLineNo) And (ilCheck = 1)) Or ((tmRepMatch(ilIndex).iVefCode = tgSbfCntr(ilLoop1).tSbf.iAirVefCode) And (ilCheck = 2)) Then
                                                                If ilMnf > 0 Then
                                                                    If ((tmRepMatch(ilIndex).iVefCode = tgSbfCntr(ilLoop1).tSbf.iAirVefCode) And (tmRepMatch(ilIndex).lPrice = tgSbfCntr(ilLoop1).tSbf.lSpotPrice) And (tmRepMatch(ilIndex).iLineNo = tgSbfCntr(ilLoop1).tSbf.iLineNo) And (ilCheck = 1)) Then
                                                                        ilMatch = True
                                                                    End If
                                                                Else
                                                                    If (tmRepMatch(ilIndex).iPkLineNo = ilPkLineNo) Then
                                                                        If ((tmRepMatch(ilIndex).iVefCode = tgSbfCntr(ilLoop1).tSbf.iAirVefCode) And (tmRepMatch(ilIndex).lPrice = tgSbfCntr(ilLoop1).tSbf.lSpotPrice) And (tmRepMatch(ilIndex).iLineNo = tgSbfCntr(ilLoop1).tSbf.iLineNo) And (ilCheck = 1)) Then
                                                                            ilMatch = True
                                                                        End If
                                                                    End If
                                                                End If
                                                            End If
                                                            If ilMatch Then
                                                                ilFound = True
                                                                'Compute Spots
                                                                'If (tmRepMatch(ilIndex).iONoSpots >= tgSbfCntr(ilLoop1).tSbf.iAirNoSpots) And (tgSpf.sPostCalAff <> "D") Then
                                                                If (tmRepMatch(ilIndex).iONoSpots >= tgSbfCntr(ilLoop1).tSbf.iAirNoSpots) And (tmRepMatch(ilIndex).sPostBy = "C") Then
                                                                    'Order greater or equal to aired, then use aired for spots and gross computation
                                                                    tgSbfCntr(ilLoop1).iANoSpots = tgSbfCntr(ilLoop1).tSbf.iAirNoSpots
                                                                    tgSbfCntr(ilLoop1).lAGross = tmRepMatch(ilIndex).lPrice * (tgSbfCntr(ilLoop1).tSbf.iAirNoSpots)
                                                                'ElseIf tgSpf.sPostCalAff = "D" Then
                                                                ElseIf tmRepMatch(ilIndex).sPostBy = "L" Then
                                                                    tgSbfCntr(ilLoop1).iANoSpots = tgSbfCntr(ilLoop1).tSbf.iAirNoSpots + tgSbfCntr(ilLoop1).tSbf.iBonusNoSpots
                                                                    tgSbfCntr(ilLoop1).lAGross = tmRepMatch(ilIndex).lPrice * (tgSbfCntr(ilLoop1).tSbf.iAirNoSpots)
                                                                Else
                                                                    'Aired more the Ordered
                                                                    If tmAdf.sAllowRepMG <> "N" Then
                                                                        ilCarried = tgSbfCntr(ilLoop1).iCarry
                                                                    Else
                                                                        ilCarried = 0
                                                                    End If
                                                                    ilSpots = tgSbfCntr(ilLoop1).tSbf.iAirNoSpots - tmRepMatch(ilIndex).iONoSpots
                                                                    If ilCarried <= ilSpots Then
                                                                        'MG (ilCarry) plus Bonus (ilSpots-ilCarry)
                                                                        tgSbfCntr(ilLoop1).iANoSpots = tgSbfCntr(ilLoop1).tSbf.iAirNoSpots
                                                                        tgSbfCntr(ilLoop1).lAGross = tmRepMatch(ilIndex).lPrice * (tmRepMatch(ilIndex).iONoSpots + ilCarried)
                                                                    Else
                                                                        tgSbfCntr(ilLoop1).iANoSpots = tgSbfCntr(ilLoop1).tSbf.iAirNoSpots
                                                                        tgSbfCntr(ilLoop1).lAGross = tmRepMatch(ilIndex).lPrice * (tgSbfCntr(ilLoop1).tSbf.iAirNoSpots)
                                                                    End If
                                                                End If
                                                                'llANoSpots = llANoSpots + tgSbfCntr(ilLoop1).iANoSpots
                                                                'llAGross = llAGross + tgSbfCntr(ilLoop1).lAGross
                                                                ilONoSpots = ilONoSpots + tmRepMatch(ilIndex).iONoSpots 'tgSbfCntr(ilLoop1).iANoSpots
                                                                llOGross = llOGross + tmRepMatch(ilIndex).lPrice * (tmRepMatch(ilIndex).iONoSpots)    'tgSbfCntr(ilLoop1).lAGross
                                                                Exit For
                                                            End If
                                                        Next ilIndex
                                                        If ilFound Then
                                                            Exit For
                                                        End If
                                                    Next ilCheck
                                                    If Not ilFound Then
                                                        'Spots in vehicles not sold- count as Bonus only
                                                        tgSbfCntr(ilLoop1).iANoSpots = tgSbfCntr(ilLoop1).tSbf.iAirNoSpots
                                                        'If tgSpf.sPostCalAff = "D" Then
                                                        If blPostByLine And (tgSbfCntr(ilLoop1).tSbf.iLineNo > 0) Then
                                                            tgSbfCntr(ilLoop1).iANoSpots = tgSbfCntr(ilLoop1).iANoSpots + tgSbfCntr(ilLoop1).tSbf.iBonusNoSpots
                                                        End If
                                                        tgSbfCntr(ilLoop1).lAGross = 0
                                                        'llANoSpots = llANoSpots + tgSbfCntr(ilLoop1).iANoSpots
                                                    End If
                                                End If
                                                llANoSpots = llANoSpots + tgSbfCntr(ilLoop1).iANoSpots
                                                llAGross = llAGross + tgSbfCntr(ilLoop1).lAGross
                                                tgSbfCntr(ilLoop1).lAcquisitionCost = tgSbfCntr(ilLoop1).lAcquisitionCost + tgSbfCntr(ilLoop1).iANoSpots * tgSbfCntr(ilLoop1).tSbf.lAcquisitionCost
                                    '            Exit For
                                            End If
                                        End If
                                    'Next ilVeh
                                End If
                            Next ilLoop1

                            llOTotalNoSpots = llOTotalNoSpots + ilONoSpots
                            llOTotalGross = llOTotalGross + llOGross

                            tmIvr.lONoSpots = ilONoSpots
                            tmIvr.lATotalSpots = llANoSpots
                            slGross = gLongToStrDec(llOGross, 2)
                            If ilPass = 1 Then
                                If Val(slPctTrade) <> 100 Then
                                    slGross = gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100")
                                End If
                            ElseIf ilPass = 2 Then
                                If Val(slPctTrade) <> 100 Then
                                    slGross = gSubStr(slGross, gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100"))
                                End If
                            End If
                            llSumOGross = llSumOGross + gStrDecToLong(slGross, 2)
                            gFormatStr slGross, FMTCOMMA, 2, tmIvr.sORate

                            slGross = gLongToStrDec(llAGross, 2)
                            If ilPass = 1 Then
                                If Val(slPctTrade) <> 100 Then
                                    slGross = gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100")
                                End If
                            ElseIf ilPass = 2 Then
                                If Val(slPctTrade) <> 100 Then
                                    slGross = gSubStr(slGross, gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100"))
                                End If
                            End If
                            llSumAGross = llSumAGross + gStrDecToLong(slGross, 2)
                            gFormatStr slGross, FMTCOMMA, 2, tmIvr.sARate
                            tmIvr.sKey = slForm2Key & "2" & tmIvr.sOVehName
                            tmIvr.lSpotKeyNo = tmIvr.lSpotKeyNo + 1
                            tmIvr.lClfCxfCode = 0
                            tmIvr.lClfCode = 0
                            tmIvr.iFormType = 1  'Force to Air
                            tmIvr.lCode = 0
                            'tmIvr.iInstallInvoiceNo = 0
                            'tmIvr.iTotalInstallInvs = 0
                            mGetInstallmentCounts tmChf ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
                            tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
                            tmIvr.iTotalInstallInvs = imTotalInstallInvs
                            tmIvr.sInstallCntr = tmChf.sInstallDefined
                            'ilRet = btrInsert(hmIvr, tmIvr, imIvrRecLen, INDEXKEY1)
                            If (tgSpf.sAEDII = "Y") And (ilEDIFlag) And (Not blPostByCount) Then
                                ilRet = mWriteIvr(ilEDIFlag, tmIvr, tmChf, True)          '5-31-17 need to know if processing REP, ignore during the Inv Exp feature
                            Else
                                ilRet = mWriteIvr(False, tmIvr, tmChf, True)             '5-31-17 need to know if processing REP, ignore during the Inv Exp feature
                            End If
                            If ilRet <> BTRV_ERR_NONE Then
                                If ilRet >= 30000 Then
                                    ilRet = csiHandleValue(0, 7)
                                End If
                                Print #hmMsg, "mRepInv_GenIvr: btrInsert-Point 1, Ivr Error # " & Trim$(str$(ilRet))
                            End If
                        Next ilLoop
                        'Now form type 3 record
                        llANet = 0
                        llAGross = 0
                        llANoSpots = 0
                        For ilLoop = ilSbf To UBound(tgSbfCntr) - 1 Step 1
                            If (llChfCode <> tgSbfCntr(ilLoop).tSbf.lChfCode) Or (llSbfDate <> tgSbfCntr(ilLoop).lSDate) Then
                                Exit For
                            Else
                                If (ilPass = 1) And (tgChfInv.iPctTrade <> 100) Then
                                    'Could use tgSbfCntr(ilLoop).lAGross like in trade area?
                                    llAGross = llAGross + tgSbfCntr(ilLoop).lAGross ' + tgSbfCntr(ilLoop).tSbf.lGross
                                    llANoSpots = llANoSpots + tgSbfCntr(ilLoop).iANoSpots
                                End If
                                If (ilPass = 2) And (tgChfInv.iPctTrade <> 0) Then
                                    llAGross = llAGross + tgSbfCntr(ilLoop).lAGross
                                    llANoSpots = llANoSpots + tgSbfCntr(ilLoop).iANoSpots
                                End If
                            End If
                        Next ilLoop
                        'slGross = gLongToStrDec(llAGross, 2)
                        slGross = gLongToStrDec(llSumAGross, 2)
                        If ilPass = 1 Then
                            'If Val(slPctTrade) <> 0 Then
                            '    slGross = gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100")
                            'End If
                            ''If Val(slPctTrade) <> 100 Then
                            ''    slGross = gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100")
                            ''End If
                            If slAgyRate = "" Then
                                slStr = slGross
                            Else
                                slStr = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                            End If
                            llANet = llANet + gStrDecToLong(slStr, 2)
                        ElseIf ilPass = 2 Then
                            'If Val(slPctTrade) <> 100 Then
                            '    slGross = gSubStr(slGross, gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100"))
                            'End If
                            If slAgyRate = "" Then
                                slStr = slGross
                            Else
                                slStr = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                            End If
                            llANet = llANet + gStrDecToLong(slStr, 2)
                        End If
                        tmIvr.iType = IVRTYPE_TotalAirtimeRep 'AirTime or REP Total
                        'tmIvr.iOTotalSpots = 0  'ilONoSpots
                        'tmIvr.lOTotalGross = 0  'llOGross
                        tmIvr.lOTotalSpots = llOTotalNoSpots
                        tmIvr.lOTotalGross = llSumOGross    'llOTotalGross
                        tmIvr.lATotalSpots = llANoSpots
                        tmIvr.lATotalGross = llSumAGross    'llAGross
                        tmIvr.lRTotalGross = 0
                        tmIvr.lATotalNet = llANet
                        tmIvr.lSpotKeyNo = tmIvr.lSpotKeyNo + 1
                        tmIvr.sKey = slForm2Key & "3"
                        tmIvr.iFormType = 1  'Force to Air
                        tmIvr.lClfCxfCode = 0
                        tmIvr.lClfCode = 0
                        tmIvr.lCode = 0
                        mGetInstallmentCounts tmChf ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
                        tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
                        tmIvr.iTotalInstallInvs = imTotalInstallInvs
                        tmIvr.sInstallCntr = tmChf.sInstallDefined
                        'ilRet = btrInsert(hmIvr, tmIvr, imIvrRecLen, INDEXKEY1)
                        If (tgSpf.sAEDII = "Y") And (ilEDIFlag) And (Not blPostByCount) Then
                            ilRet = mWriteIvr(ilEDIFlag, tmIvr, tmChf, True)        '5-31-17 need to know if processing REP, ignore during the Inv Exp feature
                        Else
                            ilRet = mWriteIvr(False, tmIvr, tmChf, True)            '5-31-17 need to know if processing REP, ignore during the Inv Exp feature
                        End If
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            Print #hmMsg, "mRepInv_GenIvr: btrInsert-Point 2, Ivr Error # " & Trim$(str$(ilRet))
                        End If
                        'Create RVF record
                        If rbcType(INVGEN_Final).Value Then
                            ilUpdateBillFlag = True
                            tgSortKey(UBound(tgSortKey) - 1).iBilled = True

                            ilRvf = UBound(tgRvf)
                            ilSRvf = ilRvf
                            tgRvf(ilRvf).lCode = 0
                            'Product- update prf now instead of after all invoices generated
                            tgRvf(ilRvf).lPrfCode = 0
                            If (Trim$(slProduct) <> "") Then
                                ilFound = False
                                tmPrfSrchKey.iAdfCode = tmChf.iAdfCode
                                ilRet = btrGetGreaterOrEqual(hmPrf, tmPrf, imPrfRecLen, tmPrfSrchKey, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point
                                Do While (ilRet = BTRV_ERR_NONE) And (tmPrf.iAdfCode = tmChf.iAdfCode) 'tmRvf.iAdfCode)
                                    If StrComp(Trim$(Trim$(slProduct)), Trim$(tmPrf.sName), 1) = 0 Then
                                        ilFound = True
                                        tgRvf(ilRvf).lPrfCode = tmPrf.lCode
                                        Exit Do
                                    End If
                                    ilRet = btrGetNext(hmPrf, tmPrf, imPrfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                                Loop
                                If (Not ilFound) And (rbcType(INVGEN_Final).Value) Then
                                    Do  'Loop until record updated or added
                                        tmPrf.lCode = 0
                                        tmPrf.iAdfCode = tmChf.iAdfCode
                                        tmPrf.sName = Trim$(slProduct)
                                        tmPrf.iMnfComp(0) = 0
                                        tmPrf.iMnfComp(1) = 0
                                        tmPrf.iMnfExcl(0) = 0
                                        tmPrf.iMnfExcl(1) = 0
                                        tmPrf.iUrfCode = tgUrf(0).iCode
                                        tmPrf.iRemoteID = tgUrf(0).iRemoteUserID
                                        tmPrf.lAutoCode = tmPrf.lCode
                                        ilRet = btrInsert(hmPrf, tmPrf, imPrfRecLen, INDEXKEY0)
                                    Loop While ilRet = BTRV_ERR_CONFLICT
                                    If ilRet <> BTRV_ERR_NONE Then
                                        If ilRet >= 30000 Then
                                            ilRet = csiHandleValue(0, 7)
                                        End If
                                        Print #hmMsg, "mRepInv_GenIvr: btrInsert-Point 3, Prf Error # " & Trim$(str$(ilRet))
                                    End If
                                    If ilRet = BTRV_ERR_NONE Then
                                        tgRvf(ilRvf).lPrfCode = tmPrf.lCode
                                        Do
                                            tmPrf.iRemoteID = tgUrf(0).iRemoteUserID
                                            tmPrf.lAutoCode = tmPrf.lCode
                                            tmPrf.iSourceID = tgUrf(0).iRemoteUserID
                                            gPackDate smSyncDate, tmPrf.iSyncDate(0), tmPrf.iSyncDate(1)
                                            gPackTime smSyncTime, tmPrf.iSyncTime(0), tmPrf.iSyncTime(1)
                                            ilRet = btrUpdate(hmPrf, tmPrf, imPrfRecLen)
                                        Loop While ilRet = BTRV_ERR_CONFLICT
                                        If ilRet <> BTRV_ERR_NONE Then
                                            If ilRet >= 30000 Then
                                                ilRet = csiHandleValue(0, 7)
                                            End If
                                            Print #hmMsg, "mRepInv_GenIVR: btrUpdate-Point 1, Prf Error # " & Trim$(str$(ilRet))
                                        End If
                                    Else
                                        tgRvf(ilRvf).lPrfCode = 0
                                    End If
                                End If
                            End If
                            tgRvf(ilRvf).iAgfCode = tmChf.iAgfCode
                            tgRvf(ilRvf).iAdfCode = tmChf.iAdfCode
                            tgRvf(ilRvf).iSlfCode = tmChf.iSlfCode(0)
                            tgRvf(ilRvf).lCntrNo = tmChf.lCntrNo
                            tgRvf(ilRvf).lInvNo = llInvoiceNo
                            tgRvf(ilRvf).lRefInvNo = 0
                            '6/7/15: Check number changed to string
                            'tgRvf(ilRvf).lCheckNo = llSbfDate   'should be 0 but temporary store llSbfDate so that RVF can be tied to tgSortKey
                            tgRvf(ilRvf).sCheckNo = Trim$(str$(llSbfDate))   'should be 0 but temporary store llSbfDate so that RVF can be tied to tgSortKey
                            If tmChf.sBillCycle = "C" Then
                                gPackDate smEndCal, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                            ElseIf tmChf.sBillCycle = "W" Then
                                gPackDate smEndWk, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                            Else
                                gPackDate smEndStd, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                            End If
                            tgRvf(ilRvf).sTranType = "IN"
                            tgRvf(ilRvf).sAction = " "
                            If tmChf.sBillCycle = "C" Then
                                tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndCal))
                                tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndCal))
                            ElseIf tmChf.sBillCycle = "W" Then
                                tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndWk))
                                tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndWk))
                            Else
                                tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndStd))
                                tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndStd))
                            End If
                            gPackDate "", tgRvf(ilRvf).iPurgeDate(0), tgRvf(ilRvf).iPurgeDate(1)
                            'If Val(slPctTrade) = 100 Then
                            If ilPass = 2 Then
                                tgRvf(ilRvf).sCashTrade = "T"
                            Else
                                tgRvf(ilRvf).sCashTrade = "C"
                            End If
                            tgRvf(ilRvf).iPkLineNo = 0
                            tgRvf(ilRvf).iInvDate(0) = tgRvf(ilRvf).iTranDate(0)
                            tgRvf(ilRvf).iInvDate(1) = tgRvf(ilRvf).iTranDate(1)
                            gPackDate smNowDate, tgRvf(ilRvf).iDateEntrd(0), tgRvf(ilRvf).iDateEntrd(1)
                            tgRvf(ilRvf).iUrfCode = tgUrf(0).iCode
                            tgRvf(ilRvf).iMnfGroup = 0  'Participant MnfCode, set in mUpdateRvf if Sales Source is Ask

                            tgRvf(ilRvf).lAcquisitionCost = 0
                            '1/17/09: Added buyer
                            'tgRvf(ilRvf).sUnused = ""
                            tgRvf(ilRvf).iPnfBuyer = tmChf.iPnfBuyer
                            For ilLoop = ilSbf To UBound(tgSbfCntr) - 1 Step 1
                                ilRvf = UBound(tgRvf)
                                tgRvf(ilRvf).iBillVefCode = tgSbfCntr(ilLoop).tSbf.iBillVefCode
                                tgRvf(ilRvf).iAirVefCode = tgSbfCntr(ilLoop).tSbf.iAirVefCode
                                tgRvf(ilRvf).lRefInvNo = tgSbfCntr(ilLoop).tSbf.lRefInvNo
                                If (llChfCode <> tgSbfCntr(ilLoop).tSbf.lChfCode) Or (llSbfDate <> tgSbfCntr(ilLoop).lSDate) Then
                                    Exit For
                                Else
                                    'Determine if same vehicle already created a rvf image
                                    ilFound = False
                                    For ilLoop1 = ilSRvf To UBound(tgRvf) - 1 Step 1
                                        If (tgRvf(ilLoop1).lCntrNo = tmChf.lCntrNo) And (tgRvf(ilLoop1).iAirVefCode = tgRvf(ilRvf).iAirVefCode) And (tgRvf(ilLoop1).iBillVefCode = tgRvf(ilRvf).iBillVefCode) And (tgRvf(ilLoop1).sCashTrade = tgRvf(ilRvf).sCashTrade) Then
                                            If (tgRvf(ilLoop1).iTranDate(0) = tgRvf(ilRvf).iTranDate(0)) And (tgRvf(ilLoop1).iTranDate(1) = tgRvf(ilRvf).iTranDate(1)) Then
                                                ilFound = True
                                                Exit For
                                            End If
                                        End If
                                    Next ilLoop1
                                    If Not ilFound Then
                                        tgRvf(ilRvf).lAcquisitionCost = tgSbfCntr(ilLoop).lAcquisitionCost
                                        If (ilPass = 1) And (tmChf.iPctTrade <> 100) Then
                                            llAGross = tgSbfCntr(ilLoop).lAGross
                                            For ilLoop1 = ilLoop + 1 To UBound(tgSbfCntr) - 1 Step 1
                                                If (llChfCode <> tgSbfCntr(ilLoop1).tSbf.lChfCode) Or (llSbfDate <> tgSbfCntr(ilLoop1).lSDate) Then
                                                    Exit For
                                                Else
                                                    If (tgSbfCntr(ilLoop).tSbf.iAirVefCode = tgSbfCntr(ilLoop1).tSbf.iAirVefCode) And (tgSbfCntr(ilLoop).tSbf.iBillVefCode = tgSbfCntr(ilLoop1).tSbf.iBillVefCode) Then
                                                        llAGross = llAGross + tgSbfCntr(ilLoop1).lAGross
                                                    End If
                                                End If
                                            Next ilLoop1
                                            slGross = gLongToStrDec(llAGross, 2)
                                            If Val(slPctTrade) <> 0 Then
                                                slGross = gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100")
                                            End If
                                            gStrToPDN slGross, 2, 6, tgRvf(ilRvf).sGross
                                            If slAgyRate = "" Then
                                                slStr = slGross
                                            Else
                                                slStr = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                                            End If
                                            gStrToPDN slStr, 2, 6, tgRvf(ilRvf).sNet
                                            tgRvf(ilRvf).lAcquisitionCost = ((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100
                                            ReDim Preserve tgRvf(0 To UBound(tgRvf) + 1) As RVF
                                            tgRvf(ilRvf + 1) = tgRvf(ilRvf)
                                        End If
                                        If (ilPass = 2) And (tmChf.iPctTrade <> 0) Then
                                            llAGross = tgSbfCntr(ilLoop).lAGross
                                            For ilLoop1 = ilLoop + 1 To UBound(tgSbfCntr) - 1 Step 1
                                                If (llChfCode <> tgSbfCntr(ilLoop1).tSbf.lChfCode) Or (llSbfDate <> tgSbfCntr(ilLoop1).lSDate) Then
                                                    Exit For
                                                Else
                                                    If (tgSbfCntr(ilLoop).tSbf.iAirVefCode = tgSbfCntr(ilLoop1).tSbf.iAirVefCode) And (tgSbfCntr(ilLoop).tSbf.iBillVefCode = tgSbfCntr(ilLoop1).tSbf.iBillVefCode) Then
                                                        llAGross = llAGross + tgSbfCntr(ilLoop1).lAGross
                                                    End If
                                                End If
                                            Next ilLoop1
                                            slGross = gLongToStrDec(llAGross, 2)
                                            If Val(slPctTrade) <> 100 Then
                                                slGross = gSubStr(slGross, gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100"))
                                            End If
                                            gStrToPDN slGross, 2, 6, tgRvf(ilRvf).sGross
                                            If slAgyRate = "" Then
                                                slStr = slGross
                                            Else
                                                slStr = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                                            End If
                                            gStrToPDN slStr, 2, 6, tgRvf(ilRvf).sNet
                                            tgRvf(ilRvf).lAcquisitionCost = tgRvf(ilRvf).lAcquisitionCost - (((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100)
                                            ReDim Preserve tgRvf(0 To UBound(tgRvf) + 1) As RVF
                                            tgRvf(ilRvf + 1) = tgRvf(ilRvf)
                                        End If
                                    End If
                                End If
                            Next ilLoop
                        End If
                        'Create EDI if required
                        'If (tgSpf.sAEDII = "Y") And (tgSpf.sPostCalAff = "D") Then
                        If (tgSpf.sAEDII = "Y") And (ilEDIFlag) And (Not blPostByCount) Then
                            mGenerateRepEDI llChfCode, llInvoiceNo, ilPass, slAgyRate, slPctTrade, slEDITotalAired, ilEDITotalNoInv
                        End If

                        'llInvoiceNo = llInvoiceNo + 1
                        'If llInvoiceNo > tgSpf.lBHighestNo Then
                        '    llInvoiceNo = tgSpf.lBLowestNo
                        'End If
                    End If
                End If
            Next ilPass
            If ilUpdateBillFlag Then
                ilRet = mUpdateRepSpotsBillFlag(llChfCode)
            End If
            'Advance ilSbf to next contract
            Do
                If (llChfCode <> tgSbfCntr(ilSbf).tSbf.lChfCode) Or (llSbfDate <> tgSbfCntr(ilSbf).lSDate) Then
                    Exit Do
                End If
                ilSbf = ilSbf + 1
            Loop While ilSbf <= UBound(tgSbfCntr) - 1
        End If
    Loop
    'If (tgSpf.sAEDII = "Y") And (tgSpf.sPostCalAff = "D") Then    'EDI Service
    If (tgSpf.sAEDII = "Y") And ((Asc(tgSpf.sUsingFeatures8) And REPBYDT) = REPBYDT) Then
        ReDim smEDIRecords(0 To 0) As String
        ReDim smEDIByVehSort(0 To 0) As SORTCODE
        smEDIRecords(0) = "12;" & Trim$(str$(ilEDITotalNoInv)) & ";"
        ilPos = InStr(slEDITotalAired, ".")
        If ilPos > 0 Then
            slStr = Left$(slEDITotalAired, ilPos - 1) & Mid$(slEDITotalAired, ilPos + 1)
        Else
            slStr = slEDITotalAired
        End If
        smEDIRecords(0) = smEDIRecords(0) & slStr & ";"
        'Print #hmEDI, smEDIRecords(0) & Chr(21);
        '2/12/03- replace Chr(21) with C/R, Line Feed.  This is a ABC request
        Print #hmEDI, smEDIRecords(0)

        'Print #hmEDI, ""
        'Close #hmEDI
        For ilEDI = 0 To UBound(tgEDIServiceInfo) - 1 Step 1
            hmEDI = tgEDIServiceInfo(ilEDI).hEDI
            If tgEDIServiceInfo(ilEDI).sUsed = "Y" Then
                '1-6-11 extra blank line created to avoid the partial/incomplete "Transmission record 12" that
                'sometimes occured
                Sleep 100
                'only create the extra blank line if its not Media Bank EDI becuase they cannot handle the blank line
                If StrComp(Trim$(tgEDIServiceInfo(ilEDI).tArf.sID), "MOcean OX", vbTextCompare) <> 0 Then
                    Print #hmEDI, ""
                End If
            End If
            Sleep 100
            On Error Resume Next
            Unlock #hmEDI
            Close #hmEDI
            If tgEDIServiceInfo(ilEDI).sUsed = "N" Then
                On Error Resume Next
                Kill Trim$(tgEDIServiceInfo(ilEDI).sPathFile)
            End If
        Next ilEDI
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mGenMktTotal                    *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Generate Market total records   *
'*                                                     *
'*******************************************************
Private Sub mGenMktTotal(ilEDIFlag As Integer)
    'Dim ilVehSubTotal As Integer
    'Dim ilVeh As Integer
    Dim ilFound As Integer
    'Dim ilMnfVehGp3Mkt As Integer
    Dim ilLoop As Integer
    Dim ilMnf As Integer
    Dim ilRet As Integer
    'If imExportCntr Then
    If (imExportCntr) Or (imRemoteCntr) Then
        Exit Sub
    End If
    If (tgSpf.sBLaserForm = "2") And (imUsingCrystal) And (Not rbcType(INVGEN_Aff).Value) Then
        'ilFound = False
        'For ilVehSubTotal = 0 To UBound(tgRvfByVef) - 1 Step 1
        '    ilMnfVehGp3Mkt = -1
        '    For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
        '        If (tgRvfByVef(ilVehSubTotal).iVefCode = tgMVef(ilVeh).iCode) Then
        '            ilMnfVehGp3Mkt = tgMVef(ilVeh).iMnfVehGp3Mkt
        '            Exit For
        '        End If
        '    Next ilVeh
        '    ilFound = False
        '    For ilLoop = 0 To UBound(tgMktTotal) - 1 Step 1
        '        If tgMktTotal(ilLoop).iMnfVehGp3Mkt = ilMnfVehGp3Mkt Then
        '            ilFound = True
        '            tgMktTotal(ilLoop).iNoSpots = tgMktTotal(ilLoop).iNoSpots + tgRvfByVef(ilVehSubTotal).iNoSpots
        '            tgMktTotal(ilLoop).sMktTotalGross = gAddStr(tgMktTotal(ilLoop).sMktTotalGross, tgRvfByVef(ilVehSubTotal).sTotalGross)
        '            Exit For
        '        End If
        '    Next ilLoop
        '    If Not ilFound Then
        '        tgMktTotal(UBound(tgMktTotal)).iMnfVehGp3Mkt = ilMnfVehGp3Mkt
        '        tgMktTotal(UBound(tgMktTotal)).iNoSpots = tgRvfByVef(ilVehSubTotal).iNoSpots
        '        tgMktTotal(UBound(tgMktTotal)).sMktTotalGross = tgRvfByVef(ilVehSubTotal).sTotalGross
        '        ReDim Preserve tgMktTotal(0 To UBound(tgMktTotal) + 1) As MKTTOTAL
        '    End If
        'Next ilVehSubTotal
        ilFound = False
        For ilLoop = 0 To UBound(tgMktTotal) - 1 Step 1
            If tgMktTotal(ilLoop).iMnfVehGp3Mkt > 0 Then
                ilFound = True
                Exit For
            End If
        Next ilLoop
        If ilFound Then
            For ilLoop = 0 To UBound(tgMktTotal) - 1 Step 1
                tmIvr.iType = IVRTYPE_TotalVefMkt 'Vehicle or Market Subtotal
                tmIvr.iLineNo = 0           '1-12-05
                tmIvr.iRdfCode = 0          '4/14/11
                tmIvr.sADayDate = "Market"
                tmIvr.iPrgEnfCode = 0
                tmIvr.sOVehName = "No Market Name"
                For ilMnf = LBound(tgMkMnf) To UBound(tgMkMnf) - 1 Step 1
                    If tgMktTotal(ilLoop).iMnfVehGp3Mkt = tgMkMnf(ilMnf).iCode Then
                        tmIvr.iPrgEnfCode = tgMkMnf(ilMnf).iCode
                        tmIvr.sOVehName = tgMkMnf(ilMnf).sName
                        Exit For
                    End If
                Next ilMnf
                tmIvr.lONoSpots = tgMktTotal(ilLoop).lONoSpots
                gFormatStr Trim$(tgMktTotal(ilLoop).sOMktTotalGross), FMTCOMMA, 2, tmIvr.sORate
                'tmIvr.sORate = Trim$(tgMktTotal(ilLoop).sOMktTotalGross)
                tmIvr.sKey = smForm2Key & "2" & tmIvr.sOVehName
                tmIvr.lSpotKeyNo = tmIvr.lSpotKeyNo + 1
                If imInvGenType = 1 Then
                    tmIvr.iFormType = 1
                Else
                    If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                        tmIvr.iFormType = 0
                    Else
                        tmIvr.iFormType = 1
                    End If
                End If
                tmIvr.lClfCxfCode = 0
                tmIvr.lClfCode = 0
                tmIvr.lCode = 0
                mGetInstallmentCounts tgChfInv ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
                tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
                tmIvr.iTotalInstallInvs = imTotalInstallInvs
                tmIvr.sInstallCntr = tgChfInv.sInstallDefined
                'ilRet = btrInsert(hmIvr, tmIvr, imIvrRecLen, INDEXKEY1)
                ilRet = mWriteIvr(ilEDIFlag, tmIvr, tgChfInv)
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    Print #hmMsg, "mGenMktTotal: btrInsert-Point 1, Ivr Error # " & Trim$(str$(ilRet))
                End If
            Next ilLoop
        End If
    End If
    Exit Sub
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetAdfAgfSlf                   *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Get Adf, Agf, Slf               *
'*                                                     *
'*******************************************************
Public Sub mGetAdfAgfSlf()
    Dim ilRet As Integer
    Dim ilVefLockBox As Integer

    '1/27/09:  Read the advertiser in again to handle the case that two contract
    'reference the same advertiser and one has a buyer but the other does not
    'If tgChfInv.iAdfCode <> tmAdf.iCode Then
        tmAdfSrchKey.iCode = tgChfInv.iAdfCode
        ilRet = btrGetEqual(hmAdf, tmAdf, imAdfRecLen, tmAdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_NONE Then
            tmAdf.sName = "Missing"
            tmAdf.sBillAddr(0) = "Missing"
            tmAdf.sBillAddr(1) = " "
            tmAdf.sBillAddr(2) = " "
            tmAdf.iPnfBuyer = 0
        End If
        If tgSpf.sARepCodes = "N" Then
            tmAdf.sCodeRep = ""
        End If
        If tgSpf.sAAgyCodes = "N" Then
            tmAdf.sCodeAgy = ""
        End If
    'End If
    'If (tmAdf.iPnfBuyer > 0) Then
    If (tgChfInv.iPnfBuyer > 0) Then
        '1/19/09:  Use contract buyer if defined instead of Advertiser
        'tmPnfSrchKey.iCode = tmAdf.iPnfBuyer
        tmPnfSrchKey.iCode = tgChfInv.iPnfBuyer
        ilRet = btrGetEqual(hmPnf, tmPnf, imPnfRecLen, tmPnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If ilRet = BTRV_ERR_NONE Then
            If Trim$(tmPnf.sBillAddr(0)) <> "" Then
                tmAdf.sBillAddr(0) = tmPnf.sBillAddr(0)
                tmAdf.sBillAddr(1) = tmPnf.sBillAddr(1)
                tmAdf.sBillAddr(2) = tmPnf.sBillAddr(2)
            ElseIf Trim$(tmPnf.sCntrAddr(0)) <> "" Then
                tmAdf.sBillAddr(0) = tmPnf.sCntrAddr(0)
                tmAdf.sBillAddr(1) = tmPnf.sCntrAddr(1)
                tmAdf.sBillAddr(2) = tmPnf.sCntrAddr(2)
            End If
        End If
    End If
    ilVefLockBox = mGetVefLockBox(tgChfInv)
    If tgChfInv.iAgfCode > 0 Then
        '1/27/09:  Read the advertiser in again to handle the case that two contract
        'reference the same advertiser and one has a buyer but the other does not
        'If tgChfInv.iAgfCode <> tmAgf.iCode Then
            tmAgfSrchKey.iCode = tgChfInv.iAgfCode
            ilRet = btrGetEqual(hmAgf, tmAgf, imAgfRecLen, tmAgfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                tmAgf.sName = "Missing"
                tmAgf.sBillAddr(0) = "Missing"
                tmAgf.sBillAddr(1) = " "
                tmAgf.sBillAddr(2) = " "
                tmAgf.iArfLkCode = 0
                tmAgf.iPnfBuyer = 0
            End If
        'End If
        If tgSpf.sARepCodes = "N" Then
            tmAgf.sCodeRep = ""
        End If
        If tgSpf.sAStnCodes = "N" Then
            tmAgf.sCodeStn = ""
        End If
        If (tmAgf.iArfLkCode > 0) And (Not ilVefLockBox) Then
            'v81 testing results 3-28-22 - Issue 2: direct advertiser is not showing the lockbox on the invoice and EDI invoice form.
            'If tmArf.iCode <> tmAgf.iArfLkCode Then
            If tmArfSrchKey.iCode <> tmAgf.iArfLkCode Then
                tmArfSrchKey.iCode = tmAgf.iArfLkCode
                ilRet = btrGetEqual(hmArf, tmArf, imArfRecLen, tmArfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                If ilRet <> BTRV_ERR_NONE Then
                    tmArf.sNmAd(0) = "Missing"
                    tmArf.sNmAd(1) = " "
                    tmArf.sNmAd(2) = " "
                    tmArf.sNmAd(3) = " "
                End If
            End If
        End If
        'If (tmAgf.iPnfBuyer > 0) Then
        If (tgChfInv.iPnfBuyer > 0) Then
            '1/19/09:  Use contract buyer if defined instead of agency
            'tmPnfSrchKey.iCode = tmAgf.iPnfBuyer
            tmPnfSrchKey.iCode = tgChfInv.iPnfBuyer
            ilRet = btrGetEqual(hmPnf, tmPnf, imPnfRecLen, tmPnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet = BTRV_ERR_NONE Then
                If Trim$(tmPnf.sBillAddr(0)) <> "" Then
                    tmAgf.sBillAddr(0) = tmPnf.sBillAddr(0)
                    tmAgf.sBillAddr(1) = tmPnf.sBillAddr(1)
                    tmAgf.sBillAddr(2) = tmPnf.sBillAddr(2)
                ElseIf Trim$(tmPnf.sCntrAddr(0)) <> "" Then
                    tmAgf.sBillAddr(0) = tmPnf.sCntrAddr(0)
                    tmAgf.sBillAddr(1) = tmPnf.sCntrAddr(1)
                    tmAgf.sBillAddr(2) = tmPnf.sCntrAddr(2)
                End If
            End If
        End If
    Else
        tmAgf.sPkInvShow = tmAdf.sPkInvShow
        If (tmAdf.iArfLkCode > 0) And (Not ilVefLockBox) Then
            'v81 testing results 3-28-22 - Issue 2: direct advertiser is not showing the lockbox on the invoice and EDI invoice form.
            'If tmArf.iCode <> tmAdf.iArfLkCode Then
            If tmArfSrchKey.iCode <> tmAdf.iArfLkCode Then
                tmArfSrchKey.iCode = tmAdf.iArfLkCode
                ilRet = btrGetEqual(hmArf, tmArf, imArfRecLen, tmArfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                If ilRet <> BTRV_ERR_NONE Then
                    tmArf.sNmAd(0) = "Missing"
                    tmArf.sNmAd(1) = " "
                    tmArf.sNmAd(2) = " "
                    tmArf.sNmAd(3) = " "
                End If
            End If
        End If
    End If
    If tgChfInv.iSlfCode(0) > 0 Then
        If tgChfInv.iSlfCode(0) <> tmSlf.iCode Then
            tmSlfSrchKey.iCode = tgChfInv.iSlfCode(0)
            ilRet = btrGetEqual(hmSlf, tmSlf, imSlfRecLen, tmSlfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                tmSlf.sLastName = ""
                tmSlf.sFirstName = ""
                tmSlf.iSofCode = 0
            End If
        End If
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetAirTime                     *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Obtain Time spot aired          *
'*                                                     *
'*******************************************************
Private Function mGetAirTime(llInTime As Long, ilPrevLen As Integer) As Long
'
'   slTime = mGetAirTime(llInTime, ilPrevLen)
'   Where:
'       llInTime(I)- Start Time
'       ilPrevLen(I)- Length of spots previous at the same time (this is used if spot not found in ssf)
'       llTime(O)- Air time
'
'       tmSdf(I)- spot to obtain air time for
'
    Dim llTime As Long
    Dim ilType As Integer       '10-31-01
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim ilAvail As Integer
    Dim ilIndex As Integer

    llTime = llInTime
    ''slType = "O"    '10-31-01
    '11/24/12
    'ilType = 0       '10-31-01
    ilType = tmSdf.iGameNo
    imSsfRecLen = Len(tmSsf) 'Max size of variable length record
    tmSsfSrchKey.iType = ilType '10-31-01 slType
    tmSsfSrchKey.iVefCode = tmSdf.iVefCode  'ilVefCode
    tmSsfSrchKey.iDate(0) = tmSdf.iDate(0)  'ilLogDate0
    tmSsfSrchKey.iDate(1) = tmSdf.iDate(1)  'ilLogDate1
    tmSsfSrchKey.iStartTime(0) = 0
    tmSsfSrchKey.iStartTime(1) = 0
    'If (tmSsf.sType <> slType) Or (tmSsf.iVefcode <> tmSdf.iVefcode) Or (tmSsf.iDate(0) <> tmSdf.iDate(0)) Or (tmSsf.iDate(1) <> tmSdf.iDate(1)) Or (tmSsf.iStartTime(0) <> 0) Or (tmSsf.iStartTime(1) <> 0) Then
    If (tmSsf.iType <> ilType) Or (tmSsf.iVefCode <> tmSdf.iVefCode) Or (tmSsf.iDate(0) <> tmSdf.iDate(0)) Or (tmSsf.iDate(1) <> tmSdf.iDate(1)) Or (tmSsf.iStartTime(0) <> 0) Or (tmSsf.iStartTime(1) <> 0) Then
        ilRet = gSSFGetGreaterOrEqual(hmSsf, tmSsf, imSsfRecLen, tmSsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get last current record to obtain date
    Else
        ilRet = BTRV_ERR_NONE
    End If
    'Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.sType = slType) And (tmSsf.iVefcode = tmSdf.iVefcode) And (tmSsf.iDate(0) = tmSdf.iDate(0)) And (tmSsf.iDate(1) = tmSdf.iDate(1))
    Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.iType = ilType) And (tmSsf.iVefCode = tmSdf.iVefCode) And (tmSsf.iDate(0) = tmSdf.iDate(0)) And (tmSsf.iDate(1) = tmSdf.iDate(1))
        For ilLoop = 1 To tmSsf.iCount Step 1
           LSet tmSpot = tmSsf.tPas(ilLoop + ADJSSFPASBZ)
            If ((tmSpot.iRecType And &HF) >= 10) Then
                If tmSpot.lSdfCode = tmSdf.lCode Then
                    'The time will be added back in when primary found
                    If (tmSpot.iRecType And SSSPLITSEC) = SSSPLITSEC Then
                        llTime = llTime - (tmSpot.iPosLen And &HFFF)
                    End If
                    For ilAvail = ilLoop - 1 To 1 Step -1
                       LSet tmAvail = tmSsf.tPas(ilAvail + ADJSSFPASBZ)
                        If (tmAvail.iRecType >= 2) And (tmAvail.iRecType <= 9) Then 'Contract Avail subrecord
                            For ilIndex = ilAvail + 1 To ilLoop - 1 Step 1
                               LSet tmSpot = tmSsf.tPas(ilIndex + ADJSSFPASBZ)
                                If (tmSpot.iRecType And SSSPLITSEC) <> SSSPLITSEC Then
                                    llTime = llTime + (tmSpot.iPosLen And &HFFF)
                                End If
                            Next ilIndex
                            mGetAirTime = llTime
                            Exit Function
                        End If
                    Next ilAvail
                End If
            End If
        Next ilLoop
        imSsfRecLen = Len(tmSsf) 'Max size of variable length record
        ilRet = gSSFGetNext(hmSsf, tmSsf, imSsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    llTime = llTime + ilPrevLen
    mGetAirTime = llTime
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetAnyVehSpots                 *
'*                                                     *
'*             Created:9/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Get spots scheduled to vehicles*
'*                      not original schedule into     *
'*            Modified: D.S. 6/12/01 Added exit if     *
'*                      ckcAll.Value is True.          *
'*                                                     *
'*******************************************************
Private Function mGetAnyVehSpots(ilTestBilled As Integer, llStdStartDate As Long, llStdEndDate As Long, llCalStartDate As Long, llCalEndDate As Long, llWkStartDate As Long, llWkEndDate As Long, llBaseDate As Long, ilUpper As Integer) As Integer
    Dim llLoop As Long
    Dim ilRet As Integer
    Dim ilExtLen As Integer
    Dim llNoRec As Long
    Dim ilOffSet As Integer
    Dim slDate As String
    'Dim llDate As Long
    Dim ilIncludeSpot As Integer
    'Dim slNameCode As String
    'Dim slCode As String
    'Dim slName As String
    Dim llRecPos As Long
    Dim llSdfRecPos As Long
    Dim tlSdfExt As SDFEXT
    'Dim ilVeh As Integer
    'Dim ilVefCode As Integer
    Dim llLastUnbilledDate As Long
    Dim slUnbilled As String
    Dim ilTest As Integer
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
    Dim tlDateTypeBuff As POPDATETYPE   'Type field record
    'ReDim slCopyProduct(1 To 6) As String
    'ReDim slCopy(1 To 6) As String
    Dim slChfCode As String
    Dim slLineNo As String
    Dim ilVef As Integer
    ReDim tgMGSdfExt(0 To 0) As SORTSDFEXT
    mGetAnyVehSpots = True
    If ckcAll.Value = vbChecked Then    '10-31-01
        Exit Function
    End If
    'Check MG file for missed spots within date range
    btrExtClear hmSmf   'Clear any previous extend operation
    ilExtLen = Len(tmSmf)
    llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hmSdf) 'Obtain number of records
    btrExtClear hmSmf   'Clear any previous extend operation
    ilRet = btrGetFirst(hmSmf, tmSmf, imSmfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If ilRet <> BTRV_ERR_END_OF_FILE Then
        If ilRet <> BTRV_ERR_NONE Then
            mGetAnyVehSpots = False
            Exit Function
        End If
        Call btrExtSetBounds(hmSmf, llNoRec, -1, "UC", "SMF", "") 'Set extract limits (all records)
        tlCharTypeBuff.sType = "A"    'Extract all matching records
        ilOffSet = gFieldOffset("Smf", "SmfMGSource")
        ilRet = btrExtAddLogicConst(hmSmf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
        If ilTestBilled = 1 Then
            slDate = smStartStd
        ElseIf ilTestBilled = 2 Then
            slDate = smStartCal
        ElseIf ilTestBilled = 3 Then
            slDate = smStartWk
        Else
            'If (llStdStartDate > 0) And (llCalStartDate > 0) Then
            '    If llStdStartDate < llCalStartDate Then
            '        slDate = smStartStd
            '    Else
            '        slDate = smStartCal
            '    End If
            'ElseIf llCalStartDate > 0 Then
            '    slDate = smStartCal
            'Else
            '    slDate = smStartStd
            'End If
            slDate = ""
            If llStdStartDate > 0 Then
                slDate = smStartStd
            End If
            If (llCalStartDate > 0) And ((llCalStartDate < gDateValue(slDate)) Or (slDate = "")) Then
                slDate = smStartCal
            End If
            If (llWkStartDate > 0) And ((llWkStartDate < gDateValue(slDate)) Or (slDate = "")) Then
                slDate = smStartWk
            End If
        End If
        gPackDate slDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
        ilOffSet = gFieldOffset("Smf", "SmfActualDate")
        ilRet = btrExtAddLogicConst(hmSmf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_GTE, BTRV_EXT_AND, tlDateTypeBuff, 4)
        If ilTestBilled = 1 Then
            slDate = smEndStd
        ElseIf ilTestBilled = 2 Then
            slDate = smEndCal
        ElseIf ilTestBilled = 3 Then
            slDate = smEndWk
        Else
            'If (llStdEndDate > 0) And (llCalEndDate > 0) Then
            '    If llStdEndDate > llCalEndDate Then
            '        slDate = smEndStd
            '    Else
            '        slDate = smEndCal
            '    End If
            'ElseIf llCalEndDate > 0 Then
            '    slDate = smEndCal
            'Else
            '    slDate = smEndStd
            'End If
            slDate = ""
            If llStdEndDate > 0 Then
                slDate = smEndStd
            End If
            If (llCalEndDate > 0) And ((llCalEndDate > gDateValue(slDate)) Or (slDate = "")) Then
                slDate = smEndCal
            End If
            If (llWkEndDate > 0) And ((llWkEndDate > gDateValue(slDate)) Or (slDate = "")) Then
                slDate = smEndWk
            End If
        End If
        gPackDate slDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
        ilOffSet = gFieldOffset("Smf", "SmfActualDate")
        ilRet = btrExtAddLogicConst(hmSmf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_LTE, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)
        ilRet = btrExtAddField(hmSmf, 0, ilExtLen)  'Extract Name
        If ilRet <> BTRV_ERR_NONE Then
            mGetAnyVehSpots = False
            Exit Function
        End If
        ilRet = btrExtGetNext(hmSmf, tmSmf, ilExtLen, llRecPos)
        If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
            If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                mGetAnyVehSpots = False
                Exit Function
            End If
            ilExtLen = Len(tmSmf)
            'ilRet = btrExtGetFirst(hmSdf, tlSdfExt, ilExtLen, llRecPos)
            Do While ilRet = BTRV_ERR_REJECT_COUNT
                ilRet = btrExtGetNext(hmSmf, tmSmf, ilExtLen, llRecPos)
            Loop
            Do While ilRet = BTRV_ERR_NONE
                ilIncludeSpot = True
                tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                If ilRet = BTRV_ERR_NONE Then
                    If tmSdf.iVefCode = tmSmf.iOrigSchVef Then
                        ilIncludeSpot = False
                    Else
                        If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value Then        '11-15-16 reprint or archive
                            If tmSdf.sBill <> "Y" Then
                                ilIncludeSpot = False
                            End If
                        ElseIf rbcType(INVGEN_Aff) Then
                            'Ignore billed flag for affidavits
                        Else
                            If tmSdf.sBill = "Y" Then
                                ilIncludeSpot = False
                            End If
                        End If
                        ilRet = btrGetPosition(hmSdf, llSdfRecPos)
                    End If
                Else
                    ilIncludeSpot = False
                End If
                If ilIncludeSpot Then
                    ilVef = gBinarySearchVef(tmSmf.iOrigSchVef)
                    If ilVef <> -1 Then
                        If tgMVef(ilVef).sType = "R" Then
                            ilIncludeSpot = False
                        End If
                    End If
                End If
                If ilIncludeSpot Then
                    tlSdfExt.iVefCode = tmSdf.iVefCode     'Vehicle Code (combos not allowed)
                    tlSdfExt.lChfCode = tmSdf.lChfCode       'Contract code
                    tlSdfExt.iLineNo = tmSdf.iLineNo       'Contract code
                    tlSdfExt.iDate(0) = tmSdf.iDate(0)    'Schedule or missed Date of spot
                    tlSdfExt.iDate(1) = tmSdf.iDate(1)    'Schedule or missed Date of spot
                    tlSdfExt.iTime(0) = tmSdf.iTime(0)    'Schedule or missed Date of spot
                    tlSdfExt.iTime(1) = tmSdf.iTime(1)    'Schedule or missed Date of spot
                    tlSdfExt.sSchStatus = tmSdf.sSchStatus    'S=Scheduled, M=Missed, R=Ready to schd MG, U=Unscheduled MG,
                    tlSdfExt.sTracer = tmSdf.sTracer
                    tlSdfExt.iLen = tmSdf.iLen         'Spot length
                    tlSdfExt.sPriceType = tmSdf.sPriceType
                    tlSdfExt.sSpotType = tmSdf.sSpotType
                    tlSdfExt.sBill = tmSdf.sBill
                    tlSdfExt.iGameNo = tmSdf.iGameNo
                    tlSdfExt.lCode = tmSdf.lCode
                    tlSdfExt.lRecPos = llSdfRecPos         'Record position
                    tlSdfExt.lMdDate = 0    'Missed date for MG's (used in gCntrDisp)
                    tlSdfExt.iStatus = tmSmf.iOrigSchVef    'Temporary store vehicle code     '0=From Sdf; 1= from Smf

                    'tgMGSdfExt(UBound(tgMGSdfExt)) = tlSdfExt
                    'ReDim Preserve tgMGSdfExt(0 To UBound(tgMGSdfExt) + 1) As SDFEXT
                    slChfCode = Trim$(str$(tlSdfExt.lChfCode))
                    Do While Len(slChfCode) < 10
                        slChfCode = "0" & slChfCode
                    Loop
                    slLineNo = Trim$(str$(tlSdfExt.iLineNo))
                    Do While Len(slLineNo) < 5
                        slLineNo = "0" & slLineNo
                    Loop
                    tgMGSdfExt(UBound(tgMGSdfExt)).sKey = slChfCode & slLineNo
                    tgMGSdfExt(UBound(tgMGSdfExt)).tSdfExt = tlSdfExt
                    ReDim Preserve tgMGSdfExt(0 To UBound(tgMGSdfExt) + 1) As SORTSDFEXT
                End If
                ilRet = btrExtGetNext(hmSmf, tmSmf, ilExtLen, llRecPos)
                Do While ilRet = BTRV_ERR_REJECT_COUNT
                    ilRet = btrExtGetNext(hmSmf, tmSmf, ilExtLen, llRecPos)
                Loop
            Loop
        End If
    End If
    llLoop = UBound(tgMGSdfExt)
    If llLoop > 0 Then
        ArraySortTyp fnAV(tgMGSdfExt(), 0), llLoop, 0, LenB(tgMGSdfExt(0)), 0, LenB(tgMGSdfExt(0).sKey), 0
    End If
    For llLoop = 0 To UBound(tgMGSdfExt) - 1 Step 1
        tlSdfExt = tgMGSdfExt(llLoop).tSdfExt
        If tmVef.iVefCode <> tlSdfExt.iStatus Then  'tmSdf.iVefCode Then
            tmVefSrchKey.iCode = tlSdfExt.iStatus  'tmSdf.iVefCode
            ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        End If
        tlSdfExt.iStatus = 0     '0=From Sdf; 1= from Smf
        llLastUnbilledDate = 0
        slUnbilled = ""
        If ilTestBilled = 0 Then
            ilRet = mCreateDateTimeForMissed(tlSdfExt, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate)
        Else
            ilRet = True
        End If
        If ilRet Then
            If mTestSdfExt(0, ilTestBilled, tlSdfExt, slUnbilled, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate, ilUpper, llLastUnbilledDate, True) Then
                If ilTestBilled > 0 Then
                    mGetAnyVehSpots = True
                End If
            Else
                If ilTestBilled = 0 Then
                    mGetAnyVehSpots = False
                End If
            End If
            If (slUnbilled <> "") And (ilTestBilled > 0) Then
'                'slUnbilled = "Contract #" & Str$(tmChf.lCntrNo) & ", Line" & Str$(tmClf.iLine) & " on " & Trim$(tmVef.sName) & " " & slUnbilled
'                ilFound = False
'                For ilTest = 0 To lbcUnbilled.ListCount Step 1
'                    slStr = lbcUnbilled.List(ilTest)
'                    If InStr(slStr, Trim$(tmVef.sName)) > 0 Then
'                        ilFound = True
'                        If InStr(slStr, Trim$(slUnbilled)) <= 0 Then
'                            lbcUnbilled.List(ilTest) = lbcUnbilled.List(ilTest) & " " & slUnbilled
'                        End If
'                        Exit For
'                    End If
'                Next ilTest
'                If Not ilFound Then
'                    slUnbilled = Trim$(tmVef.sName) & " " & slUnbilled
'                    If gOkAddStrToListBox(slUnbilled, lmAddItemLen, imShowMsg) Then
'                        lbcUnbilled.AddItem slUnbilled
'                    Else
'                        imShowMsg = False
'                    End If
'                End If
                 For ilTest = 0 To UBound(tgInvVehCode) - 1 Step 1
                    If tgInvVehCode(ilTest).iCode = tlSdfExt.iVefCode Then
                        tgInvVehCode(ilTest).iStatus = 1
                        Exit For
                    End If
                 Next ilTest
            End If
        End If
    Next llLoop
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetAvailDT                     *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Obtain avail date/Time of spot  *
'*                                                     *
'*******************************************************
Private Sub mGetAvailDT(llAvDate As Long, llAvTime As Long)
'
'   slTime = mGetAavailTime()
'   Where:
'       llTime(O)- Air time
'
'       tmSdf(I)- spot to obtain air time for
'
    'Dim llTime As Long
    Dim ilType As Integer       '10-31-01
    Dim ilRet As Integer
    Dim ilLoop As Integer
    'Dim ilAvail As Integer
    'Dim ilIndex As Integer
    Dim llWkDate As Long
    Dim llDate As Long
    Dim ilDate0 As Integer
    Dim ilDate1 As Integer

    If (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C") Then
        'gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llAvDate
        gUnpackDateLongError tmSdf.iDate(0), tmSdf.iDate(1), llAvDate, "26:mGetAvailDT " & tmSdf.lCode
        gUnpackTimeLong tmSdf.iTime(0), tmSdf.iTime(1), False, llAvTime
        Exit Sub
    End If
    'gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llAvDate
    gUnpackDateLongError tmSdf.iDate(0), tmSdf.iDate(1), llAvDate, "27:mGetAvailDT " & tmSdf.lCode
    ''slType = "O"   '10-31-01
    '11/24/12
    'ilType = 0      '10-31-01
    ilType = tmSdf.iGameNo
    imSsfRecLen = Len(tmSsf) 'Max size of variable length record
    tmSsfSrchKey.iType = ilType '10-31-01
    tmSsfSrchKey.iVefCode = tmSdf.iVefCode  'ilVefCode
    tmSsfSrchKey.iDate(0) = tmSdf.iDate(0)  'ilLogDate0
    tmSsfSrchKey.iDate(1) = tmSdf.iDate(1)  'ilLogDate1
    tmSsfSrchKey.iStartTime(0) = 0
    tmSsfSrchKey.iStartTime(1) = 0
    'If (tmSsf.sType <> slType) Or (tmSsf.iVefcode <> tmSdf.iVefcode) Or (tmSsf.iDate(0) <> tmSdf.iDate(0)) Or (tmSsf.iDate(1) <> tmSdf.iDate(1)) Or (tmSsf.iStartTime(0) <> 0) Or (tmSsf.iStartTime(1) <> 0) Then
    If (tmSsf.iType <> ilType) Or (tmSsf.iVefCode <> tmSdf.iVefCode) Or (tmSsf.iDate(0) <> tmSdf.iDate(0)) Or (tmSsf.iDate(1) <> tmSdf.iDate(1)) Or (tmSsf.iStartTime(0) <> 0) Or (tmSsf.iStartTime(1) <> 0) Then
        ilRet = gSSFGetGreaterOrEqual(hmSsf, tmSsf, imSsfRecLen, tmSsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get last current record to obtain date
    Else
        ilRet = BTRV_ERR_NONE
    End If
    '10-31-01 Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.sType = slType) And (tmSsf.iVefcode = tmSdf.iVefcode) And (tmSsf.iDate(0) = tmSdf.iDate(0)) And (tmSsf.iDate(1) = tmSdf.iDate(1))
    Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.iType = ilType) And (tmSsf.iVefCode = tmSdf.iVefCode) And (tmSsf.iDate(0) = tmSdf.iDate(0)) And (tmSsf.iDate(1) = tmSdf.iDate(1))
        For ilLoop = 1 To tmSsf.iCount Step 1
           LSet tmSpot = tmSsf.tPas(ilLoop + ADJSSFPASBZ)
           LSet tmAvail = tmSsf.tPas(ilLoop + ADJSSFPASBZ)
            If (tmAvail.iRecType >= 2) And (tmAvail.iRecType <= 9) Then 'Contract Avail subrecord
                gUnpackTimeLong tmAvail.iTime(0), tmAvail.iTime(1), False, llAvTime
            ElseIf ((tmSpot.iRecType And &HF) >= 10) Then
                If tmSpot.lSdfCode = tmSdf.lCode Then
                    Exit Sub
                End If
            End If
        Next ilLoop
        imSsfRecLen = Len(tmSsf) 'Max size of variable length record
        ilRet = gSSFGetNext(hmSsf, tmSsf, imSsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    'Scan week
    'gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llWkDate
    gUnpackDateLongError tmSdf.iDate(0), tmSdf.iDate(1), llWkDate, "28:mGetAvailDT " & tmSdf.lCode
    Do While gWeekDayLong(llWkDate) <> 0
        llWkDate = llWkDate - 1
    Loop
    For llDate = llWkDate To llWkDate + 6 Step 1
        llAvDate = llDate
        gPackDateLong llDate, ilDate0, ilDate1
        ''slType = "O"   '10-31-01
        '11/24/12
        'ilType = 0          '10-31-01
        ilType = tmSdf.iGameNo
        imSsfRecLen = Len(tmSsf) 'Max size of variable length record
        tmSsfSrchKey.iType = ilType '10-31-01
        tmSsfSrchKey.iVefCode = tmSdf.iVefCode  'ilVefCode
        tmSsfSrchKey.iDate(0) = ilDate0
        tmSsfSrchKey.iDate(1) = ilDate1
        tmSsfSrchKey.iStartTime(0) = 0
        tmSsfSrchKey.iStartTime(1) = 0
        'If (tmSsf.sType <> slType) Or (tmSsf.iVefcode <> tmSdf.iVefcode) Or (tmSsf.iDate(0) <> ilDate0) Or (tmSsf.iDate(1) <> ilDate1) Or (tmSsf.iStartTime(0) <> 0) Or (tmSsf.iStartTime(1) <> 0) Then
        If (tmSsf.iType <> ilType) Or (tmSsf.iVefCode <> tmSdf.iVefCode) Or (tmSsf.iDate(0) <> ilDate0) Or (tmSsf.iDate(1) <> ilDate1) Or (tmSsf.iStartTime(0) <> 0) Or (tmSsf.iStartTime(1) <> 0) Then
            ilRet = gSSFGetGreaterOrEqual(hmSsf, tmSsf, imSsfRecLen, tmSsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get last current record to obtain date
        Else
            ilRet = BTRV_ERR_NONE
        End If
        'Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.sType = slType) And (tmSsf.iVefcode = tmSdf.iVefcode) And (tmSsf.iDate(0) = ilDate0) And (tmSsf.iDate(1) = ilDate1)
        Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.iType = ilType) And (tmSsf.iVefCode = tmSdf.iVefCode) And (tmSsf.iDate(0) = ilDate0) And (tmSsf.iDate(1) = ilDate1)
            For ilLoop = 1 To tmSsf.iCount Step 1
               LSet tmSpot = tmSsf.tPas(ilLoop + ADJSSFPASBZ)
               LSet tmAvail = tmSsf.tPas(ilLoop + ADJSSFPASBZ)
                If (tmAvail.iRecType >= 2) And (tmAvail.iRecType <= 9) Then 'Contract Avail subrecord
                    gUnpackTimeLong tmAvail.iTime(0), tmAvail.iTime(1), False, llAvTime
                ElseIf ((tmSpot.iRecType And &HF) >= 10) Then
                    If tmSpot.lSdfCode = tmSdf.lCode Then
                        Exit Sub
                    End If
                End If
            Next ilLoop
            imSsfRecLen = Len(tmSsf) 'Max size of variable length record
            ilRet = gSSFGetNext(hmSsf, tmSsf, imSsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        Loop
    Next llDate
    'gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llAvDate
    gUnpackDateLongError tmSdf.iDate(0), tmSdf.iDate(1), llAvDate, "29:mGetAvailDT " & tmSdf.lCode
    gUnpackTimeLong tmSdf.iTime(0), tmSdf.iTime(1), False, llAvTime
    Exit Sub
End Sub

'********************************************************************
'*                                                                  *
'*      Procedure Name:mGetComment                                  *
'*                                                                  *
'*             Created:9/02/93       By:D. LeVine                   *
'*            Modified:              By:                            *
'*                                                                  *
'*            Comments: Get comment                                 *
'*                                                                  *
'*      1-24-05 merchandising comment randomly not showing due to   *
'*              invalid pointer placed in record                    *
'*              Always show merchandising comment (if exists) even if
'*              there was an "Other Comments" to be printed.        *
'*              previously, because of bridge report, not all comments
'*              were shown
'********************************************************************
Public Sub mGetComment()
    Dim ilRet As Integer
    Dim ilPos As Integer
    Dim slStr As String
    'tmIvr.lComment(1) = 0
    'tmIvr.lComment(2) = 0
    'tmIvr.lComment(3) = 0
    'tmIvr.lComment(4) = 0
    tmIvr.lComment(0) = 0
    tmIvr.lComment(1) = 0
    tmIvr.lComment(2) = 0
    tmIvr.lComment(3) = 0
    If tmChf.lCxfCode <> 0 Then
        tmCxf.sComment = ""
        imCxfRecLen = Len(tmCxf) '5027
        tmCxSrchKey.lCode = tmChf.lCxfCode
        ilRet = btrGetEqual(hmCxf, tmCxf, imCxfRecLen, tmCxSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If (ilRet = BTRV_ERR_NONE) Then
            slStr = gStripChr0(tmCxf.sComment)
            'If (tmCxf.iStrLen > 0) And (tmCxf.sShInv = "Y") Then
            If (slStr <> "") And (tmCxf.sShInv = "Y") Then
                'tmIvr.lComment(2) = tmChf.lCxfCode
                tmIvr.lComment(1) = tmChf.lCxfCode
                smHeaderComment = slStr 'Trim$(Left$(tmCxf.sComment, tmCxf.iStrLen))
                'Replace 0d 0a with blank
                ilPos = InStr(smHeaderComment, sgCR & sgLF)
                Do While ilPos > 0
                    Mid$(smHeaderComment, ilPos, 2) = "  "
                    ilPos = InStr(smHeaderComment, sgCR & sgLF)
                Loop
            Else
                smHeaderComment = ""
            End If
        Else
            smHeaderComment = ""
        End If
    Else
        smHeaderComment = ""
    End If
    'If smHeaderComment = "" Then       1-24-05 always show the merchandising comment
        If tmChf.lCxfMerch <> 0 Then
            tmCxf.sComment = ""
            imCxfRecLen = Len(tmCxf) '5027
            tmCxSrchKey.lCode = tmChf.lCxfMerch
            ilRet = btrGetEqual(hmCxf, tmCxf, imCxfRecLen, tmCxSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
            If (ilRet = BTRV_ERR_NONE) Then
                slStr = gStripChr0(tmCxf.sComment)
                'If (tmCxf.iStrLen > 0) And (tmCxf.sShInv = "Y") Then
                If (slStr <> "") And (tmCxf.sShInv = "Y") Then
                    'tmIvr.lComment(3) = tmChf.lCxfMerch     '1-24-05 lCxfCode
                    tmIvr.lComment(2) = tmChf.lCxfMerch     '1-24-05 lCxfCode
                    smHeaderComment = slStr    'Trim$(Left$(tmCxf.sComment, tmCxf.iStrLen))
                    'Replace 0d 0a with blank
                    ilPos = InStr(smHeaderComment, sgCR & sgLF)
                    Do While ilPos > 0
                        Mid$(smHeaderComment, ilPos, 2) = "  "
                        ilPos = InStr(smHeaderComment, sgCR & sgLF)
                    Loop
                Else
                    smHeaderComment = ""
                End If
            Else
                smHeaderComment = ""
            End If
        Else
            smHeaderComment = ""
        End If
    'End If

    '1-24-05 show promotions comment
    If tmChf.lCxfProm <> 0 Then
        tmCxf.sComment = ""
        imCxfRecLen = Len(tmCxf) '5027
        tmCxSrchKey.lCode = tmChf.lCxfProm
        ilRet = btrGetEqual(hmCxf, tmCxf, imCxfRecLen, tmCxSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If (ilRet = BTRV_ERR_NONE) Then
            slStr = gStripChr0(tmCxf.sComment)
            'If (tmCxf.iStrLen > 0) And (tmCxf.sShInv = "Y") Then
            If (slStr <> "") And (tmCxf.sShInv = "Y") Then
                'tmIvr.lComment(4) = tmChf.lCxfProm
                tmIvr.lComment(3) = tmChf.lCxfProm
                smHeaderComment = slStr 'Trim$(Left$(tmCxf.sComment, tmCxf.iStrLen))
                'Replace 0d 0a with blank
                ilPos = InStr(smHeaderComment, sgCR & sgLF)
                Do While ilPos > 0
                    Mid$(smHeaderComment, ilPos, 2) = "  "
                    ilPos = InStr(smHeaderComment, sgCR & sgLF)
                Loop
            End If
        End If
    End If
    '1-24-05 show cancellation comment
    If tmChf.lCxfCanc <> 0 Then
        tmCxf.sComment = ""
        imCxfRecLen = Len(tmCxf) '5027
        tmCxSrchKey.lCode = tmChf.lCxfCanc
        ilRet = btrGetEqual(hmCxf, tmCxf, imCxfRecLen, tmCxSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If (ilRet = BTRV_ERR_NONE) Then
            slStr = gStripChr0(tmCxf.sComment)
            'If (tmCxf.iStrLen > 0) And (tmCxf.sShInv = "Y") Then
            If (slStr <> "") And (tmCxf.sShInv = "Y") Then
                'tmIvr.lComment(1) = tmChf.lCxfCanc
                tmIvr.lComment(0) = tmChf.lCxfCanc
                smHeaderComment = slStr 'Trim$(Left$(tmCxf.sComment, tmCxf.iStrLen))
                'Replace 0d 0a with blank
                ilPos = InStr(smHeaderComment, sgCR & sgLF)
                Do While ilPos > 0
                    Mid$(smHeaderComment, ilPos, 2) = "  "
                    ilPos = InStr(smHeaderComment, sgCR & sgLF)
                Loop
            End If
        End If
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetnMissedForReprint           *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Obtain spots for                *
'*                     specified dates and contract    *
'*                                                     *
'*******************************************************
Private Sub mGetMissedForReprint(slUnbilled As String, llStdStartDate As Long, llStdEndDate As Long, llCalStartDate As Long, llCalEndDate As Long, llWkStartDate As Long, llWkEndDate As Long, llBaseDate As Long, ilUpper As Integer, llLastUnbilledDate As Long)
'
'   ilRet = mGetnMissedForReprint ()
'   Where:
'       smStartStd(I)- Standard month Start date
'       smEndStd(I)- Standard month End date
'       smStartCal(I)- Calendar month Start date
'       smEndCal(I)- Calendar month End date
'       ilRet (O)- True if spots obtained OK; False if error
'       tgSortKey() (O)- contains the records unsorted
'       lbcCntr (O)- contains the contracts
'
    Dim llNoRec As Long
    Dim ilRet As Integer
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
    Dim tlDateTypeBuff As POPDATETYPE   'Type field record
    Dim tlIntTypeBuff As POPINTEGERTYPE   'Type field record
    Dim slDate As String
    Dim ilOffSet As Integer
    Dim ilExtLen As Integer
    Dim ilLoop As Integer
    Dim ilIncludeSpot As Integer
    Dim ilVeh As Integer
    Dim slNameCode As String
    Dim ilVefCode As Integer
    Dim ilVsf As Integer
    Dim tlSdfExt As SDFEXT
    Dim tlVef As VEF        'tmVef contains selected vehicle; tlVef contains processing vehicle
    'Test if reprint
    If (rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value) Then
        Exit Sub
    End If
    For ilVeh = 0 To UBound(tgInvVehCode) - 1 'lbcVehicle.ListCount - 1 Step 1
        'If (lbcVehicle.Selected(ilVeh)) Then
            slNameCode = Trim$(tgInvVehCode(ilVeh).sKey)    'Traffic!lbcVehicle.List(ilVeh)
            ilVefCode = tgInvVehCode(ilVeh).iCode
            tmVefSrchKey.iCode = ilVefCode
            ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If tmVef.sType <> "V" Then
                For ilVsf = LBound(tmVsf.iFSCode) To UBound(tmVsf.iFSCode) Step 1
                    tmVsf.iFSCode(ilVsf) = 0
                Next ilVsf
                tmVsf.iFSCode(LBound(tmVsf.iFSCode)) = ilVefCode
            Else
                tmVsfSrchKey.lCode = tmVef.lVsfCode
                ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                'Include virtual vehicle as first vehicle
                For ilVsf = UBound(tmVsf.iFSCode) To LBound(tmVsf.iFSCode) + 1 Step -1
                    tmVsf.iFSCode(ilVsf) = tmVsf.iFSCode(ilVsf - 1)
                    tmVsf.iNoSpots(ilVsf) = tmVsf.iNoSpots(ilVsf - 1)
                    tmVsf.lFSComm(ilVsf) = tmVsf.lFSComm(ilVsf - 1)
                Next ilVsf
                tmVsf.iFSCode(LBound(tmVsf.iFSCode)) = ilVefCode
                tmVsf.iNoSpots(LBound(tmVsf.iFSCode)) = 1
                'gStrToPDN "100.0000", 4, 4, tmVsf.sFSComm(LBound(tmVsf.iFSCode))
                tmVsf.lFSComm(LBound(tmVsf.iFSCode)) = 1000000
            End If
            For ilVsf = LBound(tmVsf.iFSCode) To UBound(tmVsf.iFSCode) Step 1
                If tmVsf.iFSCode(ilVsf) > 0 Then
                    If tmVef.sType = "V" Then
                        tmVefSrchKey.iCode = tmVsf.iFSCode(ilVsf)   'ilVefCode
                        ilRet = btrGetEqual(hmVef, tlVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                        If ilRet <> BTRV_ERR_NONE Then
                            tlVef.sName = "Vehicle Missing"
                        End If
                    Else
                        tlVef = tmVef
                    End If
                    ilExtLen = 2 + 4 + 2 + 4 + 4 + 1 + 1 + 2 + 1 + 1 + 1 + 2 + 2 + 1 + 4 'VefCode+ChfCode+LineNo+Date+Time+Status+Tracer+Length+PriceType+SpotType+Bill+Adf+GameNo+Midnight+Code Len(tmSdfExt(1)) - 4'Extract operation record size
                    llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hmSdf) 'Obtain number of records
                    btrExtClear hmSdf   'Clear any previous extend operation
                    tmSdfSrchKey1.iVefCode = tmVsf.iFSCode(ilVsf)   'ilVefCode
                    'If (llStdStartDate > 0) And (llCalStartDate > 0) Then
                    '    If llStdStartDate < llCalStartDate Then
                    '        gPackDate smStartStd, tmSdfSrchKey1.iDate(0), tmSdfSrchKey1.iDate(1)
                    '    Else
                    '        gPackDate smStartCal, tmSdfSrchKey1.iDate(0), tmSdfSrchKey1.iDate(1)
                    '    End If
                    'ElseIf llCalStartDate > 0 Then
                    '    gPackDate smStartCal, tmSdfSrchKey1.iDate(0), tmSdfSrchKey1.iDate(1)
                    'Else
                    '    gPackDate smStartStd, tmSdfSrchKey1.iDate(0), tmSdfSrchKey1.iDate(1)
                    'End If
                    slDate = ""
                    If llStdStartDate > 0 Then
                        slDate = smStartStd
                    End If
                    If (llCalStartDate > 0) And ((llCalStartDate < gDateValue(slDate)) Or (slDate = "")) Then
                        slDate = smStartCal
                    End If
                    If (llWkStartDate > 0) And ((llWkStartDate < gDateValue(slDate)) Or (slDate = "")) Then
                        slDate = smStartWk
                    End If
                    
                    ''5/22/14: Gather spots prior to start date if billing spot that cross midnight in airing period
                    'No missed that cross midnight
                    'If (imXMidHandle = 2) Then
                    '    slDate = gDecOneDay(slDate)
                    'End If
                    
                    gPackDate slDate, tmSdfSrchKey1.iDate(0), tmSdfSrchKey1.iDate(1)
                    tmSdfSrchKey1.iTime(0) = 0
                    tmSdfSrchKey1.iTime(1) = 0
                    tmSdfSrchKey1.sSchStatus = " "
                    ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_END_OF_FILE Then
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        Call btrExtSetBounds(hmSdf, llNoRec, -1, "UC", "SDFEXTPK", SDFEXTPK) 'Set extract limits (all records)
                        tlCharTypeBuff.sType = "Y"    'Extract all matching records
                        ilOffSet = gFieldOffset("Sdf", "SdfBill")
                        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
                        tlCharTypeBuff.sType = "H"    'Extract all non-matching records
                        ilOffSet = gFieldOffset("Sdf", "SdfSchStatus")
                        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
                        tlCharTypeBuff.sType = "O"    'Extract all non-matching records
                        ilOffSet = gFieldOffset("Sdf", "SdfSchStatus")
                        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
                        tlCharTypeBuff.sType = "G"    'Extract all non-matching records
                        ilOffSet = gFieldOffset("Sdf", "SdfSchStatus")
                        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
                        tlCharTypeBuff.sType = "S"    'Extract all non-matching records
                        ilOffSet = gFieldOffset("Sdf", "SdfSchStatus")
                        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
                        tlIntTypeBuff.iType = tmVsf.iFSCode(ilVsf)  'ilVefCode    'Extract all matching records
                        ilOffSet = gFieldOffset("Sdf", "SdfVefCode")
                        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_INT, ilOffSet, 2, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlIntTypeBuff, 2)
                        'If (llCalStartDate > 0) And (llStdStartDate > 0) Then
                        '    If llStdStartDate < llCalStartDate Then
                        '        slDate = smStartStd
                        '    Else
                        '        slDate = smStartCal
                        '    End If
                        'ElseIf llCalStartDate > 0 Then
                        '    slDate = smStartCal
                        'Else
                        '    slDate = smStartStd
                        'End If
                        slDate = ""
                        If llStdStartDate > 0 Then
                            slDate = smStartStd
                        End If
                        If (llCalStartDate > 0) And ((llCalStartDate < gDateValue(slDate)) Or (slDate = "")) Then
                            slDate = smStartCal
                        End If
                        If (llWkStartDate > 0) And ((llWkStartDate < gDateValue(slDate)) Or (slDate = "")) Then
                            slDate = smStartWk
                        End If
                        
                        ''5/22/14: Gather spots prior to start date if billing spot that cross midnight in airing period
                        'No missed that cross midnight
                        'If (imXMidHandle = 2) Then
                        '    slDate = gDecOneDay(slDate)
                        'End If
                        
                        gPackDate slDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
                        ilOffSet = gFieldOffset("Sdf", "SdfDate")
                        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_GTE, BTRV_EXT_AND, tlDateTypeBuff, 4)
                        'If (llStdEndDate > 0) And (llCalEndDate > 0) Then
                        '    If llStdEndDate > llCalEndDate Then
                        '        slDate = smEndStd
                        '    Else
                        '        slDate = smEndCal
                        '    End If
                        'ElseIf llCalEndDate > 0 Then
                        '    slDate = smEndCal
                        'Else
                        '    slDate = smEndStd
                        'End If
                        slDate = ""
                        If llStdEndDate > 0 Then
                            slDate = smEndStd
                        End If
                        If (llCalEndDate > 0) And ((llCalEndDate > gDateValue(slDate)) Or (slDate = "")) Then
                            slDate = smEndCal
                        End If
                        If (llWkEndDate > 0) And ((llWkEndDate > gDateValue(slDate)) Or (slDate = "")) Then
                            slDate = smEndWk
                        End If
                        gPackDate slDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
                        ilOffSet = gFieldOffset("Sdf", "SdfDate")
                        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_LTE, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)

                        ilOffSet = gFieldOffset("Sdf", "SdfVefCode")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 2)  'Extract Name
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        ilOffSet = gFieldOffset("Sdf", "SdfChfCode")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 4)  'Extract iCode field
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        ilOffSet = gFieldOffset("Sdf", "SdfLineNo")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 2)  'Extract Name
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        ilOffSet = gFieldOffset("Sdf", "SdfDate")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 4) 'Extract Variation
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        ilOffSet = gFieldOffset("Sdf", "SdfTime")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 4) 'Extract Variation
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        ilOffSet = gFieldOffset("Sdf", "SdfSchStatus")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        ilOffSet = gFieldOffset("Sdf", "SdfTracer")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        ilOffSet = gFieldOffset("Sdf", "SdfLen")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 2) 'Extract Variation
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        ilOffSet = gFieldOffset("Sdf", "SdfPriceType")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        ilOffSet = gFieldOffset("Sdf", "SdfSpotType")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        ilOffSet = gFieldOffset("Sdf", "SdfBill")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        ilOffSet = gFieldOffset("Sdf", "SdfAdfCode")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 2)  'Extract Name
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        ilOffSet = gFieldOffset("Sdf", "SdfGameNo")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 2)  'Extract Name
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        
                        '5/22/14: add cross midnight
                        ilOffSet = gFieldOffset("Sdf", "SdfXCrossMidnight")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        
                        ilOffSet = gFieldOffset("Sdf", "SdfCode")
                        ilRet = btrExtAddField(hmSdf, ilOffSet, 4) 'Extract Variation
                        If ilRet <> BTRV_ERR_NONE Then
                            Exit Sub
                        End If
                        'ilRet = btrExtGetNextExt(hmSdf)    'Extract record
                        ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
                        If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
                            If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                                Exit Sub
                            End If
                            ilExtLen = 2 + 4 + 2 + 4 + 4 + 1 + 1 + 2 + 1 + 1 + 1 + 2 + 2 + 1 + 4 'VefCode+ChfCode+LineNo+Date+Time+Status+Tracer+Length+PriceType+SpotType+Bill+Adf+GameNo+Midnight+Code Len(tmSdfExt(1)) - 4'Extract operation record size
                            'ilRet = btrExtGetFirst(hmSdf, tlSdfExt, ilExtLen, llRecPos)
                            Do While ilRet = BTRV_ERR_REJECT_COUNT
                                ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
                            Loop
                            ReDim tgSdfExtIn(0 To 0) As SORTSDFEXT
                            Do While ilRet = BTRV_ERR_NONE
                                'Check that spot has not been include (G and O spots)
                                ilIncludeSpot = True
                                tlSdfExt.iStatus = 0
                                tlSdfExt.lMdDate = 0    'Missed date for MG's (used in gCntrDisp)
                                If mSdfExtExist(tlSdfExt) Then
                                    ilIncludeSpot = False
                                End If
                                If ilIncludeSpot Then
                                    ilIncludeSpot = False
                                    If tmChf.lCode <> tlSdfExt.lChfCode Then
                                        tmChfSrchKey.lCode = tlSdfExt.lChfCode
                                        ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                    End If
                                    For ilLoop = 0 To UBound(tmRPInfo) - 1 Step 1
                                        If (tmChf.lCntrNo = tmRPInfo(ilLoop).lCntrNo) And ((tmRPInfo(ilLoop).iMnfItem = 0) Or (tmRPInfo(ilLoop).iMnfItem = -1)) Then
                                            ilIncludeSpot = True
                                            Exit For
                                        End If
                                    Next ilLoop
                                End If
                                If ilIncludeSpot Then
                                    tlSdfExt.iStatus = 0
                                    tlSdfExt.lMdDate = 0    'Missed date for MG's (used in gCntrDisp)
                                    LSet tgSdfExtIn(UBound(tgSdfExtIn)) = tlSdfExt
                                    ReDim Preserve tgSdfExtIn(0 To UBound(tgSdfExtIn) + 1) As SORTSDFEXT
                                    'mCreateDateTimeForMissed not required as Order does not call this function
                                End If
                                ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
                                Do While ilRet = BTRV_ERR_REJECT_COUNT
                                    ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
                                Loop
                            Loop
                            For ilLoop = 0 To UBound(tgSdfExtIn) - 1 Step 1
                                LSet tlSdfExt = tgSdfExtIn(ilLoop)
                                If Not mTestSdfExt(0, 0, tlSdfExt, slUnbilled, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate, ilUpper, llLastUnbilledDate, True) Then
                                End If
                            Next ilLoop
                        End If
                    End If
                End If
            Next ilVsf
        'End If
    Next ilVeh
    Exit Sub
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetMissedFromMGs               *
'*                                                     *
'*             Created:9/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Get missed spots for MG's      *
'*                                                     *
'*******************************************************
Private Function mGetMissedFromMGs(llStdStartDate As Long, llStdEndDate As Long, llCalStartDate As Long, llCalEndDate As Long, llWkStartDate As Long, llWkEndDate As Long, llBaseDate As Long, ilUpper As Integer) As Integer
    Dim ilLoop As Integer
    Dim llLoop As Long
    Dim ilRet As Integer
    Dim ilExtLen As Integer
    Dim llNoRec As Long
    Dim ilOffSet As Integer
    Dim slDate As String
    Dim llDate As Long
    Dim ilIncludeSpot As Integer
    Dim slNameCode As String
    'Dim slCode As String
    Dim tlVef As VEF
    Dim tlClf As CLF
    Dim ilVeh As Integer
    'Dim ilVsf As Integer
    'Dim ilFound As Integer
    Dim ilPass As Integer
    Dim ilStartPass As Integer
    Dim ilEndPass As Integer
    'Dim slStr As String
    'Dim slSort As String
    Dim llRecPos As Long
    'Dim llSdfRecPos As Long
    Dim llTranDate As Long
    'Dim llTime As Long
    Dim tlSdfExt As SDFEXT
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
    Dim tlDateTypeBuff As POPDATETYPE   'Type field record
    'ReDim slCopyProduct(1 To 6) As String
    'ReDim slCopy(1 To 6) As String
    Dim slChfCode As String
    Dim slLineNo As String
    ReDim tgMGSdfExt(0 To 0) As SORTSDFEXT
    mGetMissedFromMGs = True
    If (tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") Then
        ilStartPass = 1 'MG
        ilEndPass = 2   'Get bonuses missed in mObtainCntrToInvoice
    Else
        ilStartPass = 1 'MG
        ilEndPass = 2   'Outside
    End If
    'Check MG file for missed spots within date range
    For ilPass = ilStartPass To ilEndPass Step 1
        btrExtClear hmSmf   'Clear any previous extend operation
        ilExtLen = Len(tmSmf)
        llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hmSdf) 'Obtain number of records
        btrExtClear hmSmf   'Clear any previous extend operation
        ilRet = btrGetFirst(hmSmf, tmSmf, imSmfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_END_OF_FILE Then
            If ilRet <> BTRV_ERR_NONE Then
                igInvErrFlag = True
                Print #hmMsg, "Error " & Trim$(str$(ilRet)) & " GetFirst for SMF in mGetMissedFrom MGs"
                mGetMissedFromMGs = False
                Exit Function
            End If
            Call btrExtSetBounds(hmSmf, llNoRec, -1, "UC", "SMF", "") 'Set extract limits (all records)
            If ilPass = 1 Then
                tlCharTypeBuff.sType = "G"    'Extract all matching records
            Else
                tlCharTypeBuff.sType = "O"    'Extract all matching records
            End If
            ilOffSet = gFieldOffset("Smf", "SmfSchStatus")
            ilRet = btrExtAddLogicConst(hmSmf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
            '"O" spots ignore because only the schedule one is shown not the missed part
            'ilRet = btrExtAddLogicConst(hmSmf, BTRV_KT_STRING, ilOffset, 1, BTRV_EXT_EQUAL, BTRV_EXT_OR, tlCharTypeBuff, 1)
            'tlCharTypeBuff.sType = "O"    'Extract all matching records
            'ilOffset = gFieldOffset("Smf", "SmfSchStatus")
            'ilRet = btrExtAddLogicConst(hmSmf, BTRV_KT_STRING, ilOffset, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
            'If (llStdStartDate > 0) And (llCalStartDate > 0) Then
            '    If llStdStartDate < llCalStartDate Then
            '        slDate = smStartStd
            '    Else
            '        slDate = smStartCal
            '    End If
            'ElseIf llCalStartDate > 0 Then
            '    slDate = smStartCal
            'Else
            '    slDate = smStartStd
            'End If
            slDate = ""
            If llStdStartDate > 0 Then
                slDate = smStartStd
            End If
            If (llCalStartDate > 0) And ((llCalStartDate < gDateValue(slDate)) Or (slDate = "")) Then
                slDate = smStartCal
            End If
            If (llWkStartDate > 0) And ((llWkStartDate < gDateValue(slDate)) Or (slDate = "")) Then
                slDate = smStartWk
            End If
            gPackDate slDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
            ilOffSet = gFieldOffset("Smf", "SmfMissedDate")
            ilRet = btrExtAddLogicConst(hmSmf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_GTE, BTRV_EXT_AND, tlDateTypeBuff, 4)
            'If (llStdEndDate > 0) And (llCalEndDate > 0) Then
            '    If llStdEndDate > llCalEndDate Then
            '        slDate = smEndStd
            '    Else
            '        slDate = smEndCal
            '    End If
            'ElseIf llCalEndDate > 0 Then
            '    slDate = smEndCal
            'Else
            '    slDate = smEndStd
            'End If
            slDate = ""
            If llStdEndDate > 0 Then
                slDate = smEndStd
            End If
            If (llCalEndDate > 0) And ((llCalEndDate > gDateValue(slDate)) Or (slDate = "")) Then
                slDate = smEndCal
            End If
            If (llWkEndDate > 0) And ((llWkEndDate > gDateValue(slDate)) Or (slDate = "")) Then
                slDate = smEndWk
            End If
            gPackDate slDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
            ilOffSet = gFieldOffset("Smf", "SmfMissedDate")
            ilRet = btrExtAddLogicConst(hmSmf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_LTE, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)
            ilRet = btrExtAddField(hmSmf, 0, ilExtLen)  'Extract Name
            If ilRet <> BTRV_ERR_NONE Then
                igInvErrFlag = True
                Print #hmMsg, "Error " & Trim$(str$(ilRet)) & " btrExtAddField for SMF in mGetMissedFrom MGs"
                mGetMissedFromMGs = False
                Exit Function
            End If
            ilRet = btrExtGetNext(hmSmf, tmSmf, ilExtLen, llRecPos)
            If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
                If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                    mGetMissedFromMGs = False
                    Exit Function
                End If
                'ilRet = btrExtGetFirst(hmSdf, tlSdfExt, ilExtLen, llRecPos)
                ilExtLen = Len(tmSmf)
                Do While ilRet = BTRV_ERR_REJECT_COUNT
                    ilRet = btrExtGetNext(hmSmf, tmSmf, ilExtLen, llRecPos)
                Loop
                Do While ilRet = BTRV_ERR_NONE
                    'Test dates- if missed within billing dates, then include spots
                    If tmChfSrchKey.lCode <> tmSmf.lChfCode Then
                        tmChfSrchKey.lCode = tmSmf.lChfCode
                        ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                        If ilRet <> BTRV_ERR_NONE Then
                            igInvErrFlag = True
                            Print #hmMsg, "Error " & Trim$(str$(ilRet)) & " Contract Missing " & Trim$(str$(tmSmf.lChfCode)) & " in mGetMissedFrom MGs"
                            If (rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Archive).Value) Then      '11-15-16 prelim, reprint or archive
                                ilIncludeSpot = False
                            Else
                                mGetMissedFromMGs = False
                                Exit Function
                            End If
                        End If
                    End If
                    ilIncludeSpot = True
                    gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                    llDate = gDateValue(slDate)
                    If tmChf.sBillCycle = "C" Then
                        If (llDate < llCalStartDate) Or (llDate > llCalEndDate) Then
                            ilIncludeSpot = False
                        Else
                            If Not imFullCal Then
                                gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                                If gDateValue(slDate) > llCalEndDate Then
                                    ilIncludeSpot = False
                                End If
                            End If
                        End If
                    ElseIf tmChf.sBillCycle = "W" Then
                        If (llDate < llWkStartDate) Or (llDate > llWkEndDate) Then
                            ilIncludeSpot = False
                        Else
                            If Not imFullWk Then
                                gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                                If gDateValue(slDate) > llWkEndDate Then
                                    ilIncludeSpot = False
                                End If
                            End If
                        End If
                    Else
                        If (llDate < llStdStartDate) Or (llDate > llStdEndDate) Then
                            ilIncludeSpot = False
                        Else
                            If Not imFullStd Then
                                gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                                If gDateValue(slDate) > llStdEndDate Then
                                    ilIncludeSpot = False
                                End If
                            End If
                        End If
                    End If
                    If (tmChf.sType = "S") Or (tmChf.sType = "M") Or (tmChf.sType = "V") Then
                        ilIncludeSpot = False
                    End If
                    If ilIncludeSpot Then
                        ilVeh = gBinarySearchVef(tmSmf.iOrigSchVef)
                        If ilVeh <> -1 Then
                            If tgMVef(ilVeh).sType = "R" Then
                                ilIncludeSpot = False
                            End If
                        End If
                    End If
                    If (ilIncludeSpot) And ((rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Aff).Value) Or (rbcType(INVGEN_Archive).Value)) Then        '11-15-16 reprint, aff, or archive
                        ilIncludeSpot = False
                        For ilLoop = 0 To UBound(tmRPInfo) - 1 Step 1
                            If (tmChf.lCntrNo = tmRPInfo(ilLoop).lCntrNo) And ((tmRPInfo(ilLoop).iMnfItem = 0) Or (tmRPInfo(ilLoop).iMnfItem = -1)) Then
                                ilIncludeSpot = True
                                Exit For
                            End If
                        Next ilLoop
                    End If
                    If (ilIncludeSpot) And (rbcCntr(INVCNTR_Selective).Value Or rbcCntr(INVCNTR_WOExpired).Value Or rbcCntr(INVCNTR_Posted).Value) And ((rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value)) Then
                        ilIncludeSpot = False
                        For ilLoop = 0 To UBound(lmSelCntrCode) - 1 Step 1
                            If tmChf.lCode = lmSelCntrCode(ilLoop) Then
                                ilIncludeSpot = True
                                Exit For
                            End If
                        Next ilLoop
                    End If
                    If ilIncludeSpot Then
                        'Obtain line
                        ilIncludeSpot = False
                        If (tmChf.lCode <> tmClf.lChfCode) Or (tmSmf.iLineNo <> tmClf.iLine) Then
                            tmClfSrchKey.lChfCode = tmChf.lCode
                            tmClfSrchKey.iLine = tmSmf.iLineNo
                            tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
                            tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
                            ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                        Else
                            ilRet = BTRV_ERR_NONE
                        End If
                        If (tmClf.lChfCode = tmChf.lCode) And (tmClf.iLine = tmSmf.iLineNo) Then
                            For ilVeh = 0 To UBound(tgInvVehCode) - 1 Step 1 'lbcVehicle.ListCount - 1 Step 1
                                'If lbcVehicle.Selected(ilVeh) Then
                                    slNameCode = Trim$(tgInvVehCode(ilVeh).sKey)    'Traffic!lbcVehicle.List(ilVeh)
                                    'ilRet = gParseItem(slNameCode, 2, "\", slCode)
                                    If tgInvVehCode(ilVeh).iCode = tmClf.iVefCode Then
                                        ilIncludeSpot = True
                                        Exit For
                                    End If
                                'End If
                            Next ilVeh
                        End If
                        '12/15/07:  Removed the ilPass = 1 test(MG only)
                        'If (ilPass = 1) And (ilIncludeSpot) And ((rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value)) Then  'Not reprint
                        If (ilIncludeSpot) And ((rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value)) Then  'Not reprint
                            'If Showing by Order bypass test
                            If (tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") Then
                                'Test if Missed was shown on a previous invoice- if so ignore
                                'tmRvfSrchKey1.iAdfCode = tmChf.iAdfCode
                                'ilRet = btrGetEqual(hmRvf, tmRvf, imRvfRecLen, tmRvfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                tmRvfSrchKey4.lCntrNo = tmChf.lCntrNo
                                tmRvfSrchKey4.iTranDate(0) = 0
                                tmRvfSrchKey4.iTranDate(1) = 0
                                ilRet = btrGetGreaterOrEqual(hmRvf, tmRvf, imRvfRecLen, tmRvfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                Do While (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tmRvf.lCntrNo)
                                    If (tmChf.iAgfCode = tmRvf.iAgfCode) And (tmClf.iVefCode = tmRvf.iBillVefCode) And (tmRvf.iAdfCode = tmChf.iAdfCode) And (tmRvf.sTranType = "IN") And (tmRvf.sInvoiceUndone <> "Y") Then
                                        'gUnpackDateLong tmRvf.iTranDate(0), tmRvf.iTranDate(1), llTranDate
                                        gUnpackDateLongError tmRvf.iTranDate(0), tmRvf.iTranDate(1), llTranDate, "30:mGetMissedFrimMGs " & tmRvf.lCode
                                        If llDate <= llTranDate Then
                                            ilIncludeSpot = False
                                            Exit Do
                                        End If
                                    End If
                                    ilRet = btrGetNext(hmRvf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                                Loop
                                '12/12/07- test history
                                tmRvfSrchKey4.lCntrNo = tmChf.lCntrNo
                                tmRvfSrchKey4.iTranDate(0) = 0
                                tmRvfSrchKey4.iTranDate(1) = 0
                                ilRet = btrGetGreaterOrEqual(hmPhf, tmRvf, imRvfRecLen, tmRvfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                Do While (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tmRvf.lCntrNo)
                                    If (tmChf.iAgfCode = tmRvf.iAgfCode) And (tmClf.iVefCode = tmRvf.iBillVefCode) And (tmRvf.iAdfCode = tmChf.iAdfCode) And (tmRvf.sTranType = "IN") And (tmRvf.sInvoiceUndone <> "Y") Then
                                        'gUnpackDateLong tmRvf.iTranDate(0), tmRvf.iTranDate(1), llTranDate
                                        gUnpackDateLongError tmRvf.iTranDate(0), tmRvf.iTranDate(1), llTranDate, "31:mGetMissedFromMGs " & tmRvf.lCode
                                        If llDate <= llTranDate Then
                                            ilIncludeSpot = False
                                            Exit Do
                                        End If
                                    End If
                                    ilRet = btrGetNext(hmPhf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                                Loop
                            End If
                        End If
                        '6/4/15: Bypass Fill spots as the missed date is arbitrary
                        If ilIncludeSpot Then
                            tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                            ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                            If ilRet = BTRV_ERR_NONE Then
                                If tmSdf.sSpotType = "X" Then
                                    ilIncludeSpot = False
                                End If
                            End If
                        End If
                        If ilIncludeSpot Then
                            If tmVef.iCode <> tmClf.iVefCode Then
                                tmVefSrchKey.iCode = tmClf.iVefCode
                                ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                If ilRet <> BTRV_ERR_NONE Then
                                    tmVef.sName = "Vehicle Missing"
                                End If
                            End If
                            '6/4/15: Moved above to bypass Fill spots
                            'tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                            'ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                            If tlVef.iCode <> tmSdf.iVefCode Then
                                If tmVef.iCode = tmSdf.iVefCode Then
                                    tlVef = tmVef
                                Else
                                    tmVefSrchKey.iCode = tmSdf.iVefCode
                                    ilRet = btrGetEqual(hmVef, tlVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                    If ilRet <> BTRV_ERR_NONE Then
                                        tlVef.sName = "Vehicle Missing"
                                        tlVef.iCode = tmSdf.iVefCode
                                    End If
                                End If
                            End If
                            'Build tlSdfExt so same sort code can be used
                            tlSdfExt.iVefCode = tlVef.iCode     'Vehicle Code (combos not allowed)
                            tlSdfExt.lChfCode = tmSmf.lChfCode       'Contract code
                            tlSdfExt.iLineNo = tmSmf.iLineNo       'Contract code
                            tlSdfExt.iDate(0) = tmSmf.iMissedDate(0)    'Schedule or missed Date of spot
                            tlSdfExt.iDate(1) = tmSmf.iMissedDate(1)    'Schedule or missed Date of spot
                            tlSdfExt.iTime(0) = tmSmf.iMissedTime(0)    'Schedule or missed Date of spot
                            tlSdfExt.iTime(1) = tmSmf.iMissedTime(1)    'Schedule or missed Date of spot
                            tlSdfExt.sSchStatus = tmSmf.sSchStatus    'S=Scheduled, M=Missed, R=Ready to schd MG, U=Unscheduled MG,
                            tlSdfExt.sTracer = " "
                            tlSdfExt.iLen = tmClf.iLen         'Spot length
                            tlSdfExt.lRecPos = llRecPos         'Record position
                            tlSdfExt.iGameNo = tmSmf.iGameNo    'tmSdf.iGameNo
                            tlSdfExt.lCode = tmSmf.lCode
                            tlSdfExt.lMdDate = 0    'Missed date for MG's (used in gCntrDisp)
                            tlSdfExt.iStatus = 1     '0=From Sdf; 1= from Smf
                            tlSdfExt.sBill = tmSdf.sBill
                            If ((tgSpf.sInvAirOrder = "O") And (tgSpf.sBLaserForm <> "2")) Or (tgSpf.sInvAirOrder = "S") Or ((tgSpf.sInvAirOrder = "O") And (tgSpf.sBLaserForm = "2") And (rbcType(INVGEN_Preliminary).Value Or rbcType(INVGEN_Final).Value Or rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value)) Then     'Bypass spot if previously included, 11-15-16 test prelim, final, reprint, archive
                                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Then     'Reprint- only include Billed
                                    If tmSdf.sBill <> "Y" Then
                                        ilIncludeSpot = False
                                    End If
                                Else
                                    If tmSdf.sBill = "Y" Then
                                        ilIncludeSpot = False
                                    End If
                                End If
                                If ilIncludeSpot Then
                                    If mSdfExtExist(tlSdfExt) Then
                                        ilIncludeSpot = False
                                    End If
                                End If
                            Else
                                'If (tmSdf.sSchStatus = "O") And (tmSdf.sSpotType <> "X") Then
                                '    ilIncludeSpot = False
                                'Else
                                '    If tmSdf.sSchStatus = "O" Then
                                '        If mSdfExtExist(tlSdfExt) Then
                                '            ilIncludeSpot = False
                                '        End If
                                '    End If
                                '    'SchStatus = "G"- test if line is H if so test how package line is to be invoiced, O or A (if O test if spot exist)
                                '    If (tmClf.sType = "H") And (tmSdf.sSchStatus = "G") Then
                                '        tmClfSrchKey.lChfCode = tmChf.lCode
                                '        tmClfSrchKey.iLine = tmClf.iPkLineNo
                                '        tmClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
                                '        tmClfSrchKey.iPropVer = 32000 ' 0 show latest version
                                '        ilRet = btrGetGreaterOrEqual(hmClf, tlClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                '        If tlClf.sType = "O" Then
                                '            If mSdfExtExist(tlSdfExt) Then
                                '                ilIncludeSpot = False
                                '            End If
                                '        End If
                                '    End If
                                'End If
                                If tmSdf.sSchStatus = "O" Then
                                    If mSdfExtExist(tlSdfExt) Then
                                        ilIncludeSpot = False
                                    End If
                                End If
                                'SchStatus = "G"- test if line is H if so test how package line is to be invoiced, O or A (if O test if spot exist)
                                If (tmClf.sType = "H") And (tmSdf.sSchStatus = "G") Then
                                    If (tmChf.lCode <> tmPkClf.lChfCode) Or (tmClf.iPkLineNo <> tmPkClf.iLine) Then
                                        tmClfSrchKey.lChfCode = tmChf.lCode
                                        tmClfSrchKey.iLine = tmClf.iPkLineNo
                                        tmClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
                                        tmClfSrchKey.iPropVer = 32000 ' 0 show latest version
                                        ilRet = btrGetGreaterOrEqual(hmClf, tmPkClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                    Else
                                        ilRet = BTRV_ERR_NONE
                                    End If
                                    tlClf = tmPkClf
                                    If tlClf.sType = "O" Then
                                        If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then     '11-15-16, archive & Reprint- only include Billed
                                            If tmSdf.sBill <> "Y" Then
                                                ilIncludeSpot = False
                                            End If
                                        Else
                                            If tmSdf.sBill = "Y" Then
                                                ilIncludeSpot = False
                                            End If
                                        End If
                                        If ilIncludeSpot Then
                                            If mSdfExtExist(tlSdfExt) Then
                                                ilIncludeSpot = False
                                            End If
                                        End If
                                    Else
                                        If (tgSpf.sInvAirOrder = "2") Then  'Ignore missed part of MG's (eliminate record if already processed from mObtainCntrToInvoice)
                                                                            '(note: if schedule date outside, then mCreateCortRec will eliminate this record)
                                            If mSdfExtExist(tlSdfExt) Then
                                                ilIncludeSpot = False
                                            End If
                                        End If
                                    End If
                                ElseIf (tmClf.sType = "H") And (tmSdf.sSchStatus = "O") Then
                                    If ilIncludeSpot Then
                                        If (tmChf.lCode <> tmPkClf.lChfCode) Or (tmClf.iPkLineNo <> tmPkClf.iLine) Then
                                            tmClfSrchKey.lChfCode = tmChf.lCode
                                            tmClfSrchKey.iLine = tmClf.iPkLineNo
                                            tmClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
                                            tmClfSrchKey.iPropVer = 32000 ' 0 show latest version
                                            ilRet = btrGetGreaterOrEqual(hmClf, tlClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                        Else
                                            ilRet = BTRV_ERR_NONE
                                        End If
                                        tlClf = tmPkClf
                                        If tlClf.sType <> "O" Then
                                            If (tmSdf.sSpotType <> "X") Then
                                                ilIncludeSpot = False
                                            Else
                                                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then      '11-15-16 arhive or Reprint- only include Billed
                                                    If tmSdf.sBill <> "Y" Then
                                                        ilIncludeSpot = False
                                                    End If
                                                Else
                                                    If tmSdf.sBill = "Y" Then
                                                        ilIncludeSpot = False
                                                    End If
                                                End If
                                            End If
                                        Else
                                            If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then      '11-15-16 archive or Reprint- only include Billed
                                                If tmSdf.sBill <> "Y" Then
                                                    ilIncludeSpot = False
                                                End If
                                            Else
                                                If tmSdf.sBill = "Y" Then
                                                    ilIncludeSpot = False
                                                End If
                                            End If
                                        End If
                                    End If
                                Else
                                    If (tmSdf.sSchStatus = "O") And (tmSdf.sSpotType <> "X") Then
                                        'Include missed part of Outside if missed date within billing period but scheduled date is outside
                                        '2/6/03
                                        If (tgSpf.sInvAirOrder = "A") And (tgSpf.sBLaserForm = "1") Then
                                            'If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Then     'Reprint- only include Billed
                                            '    If tmSdf.sBill <> "Y" Then
                                            '        ilIncludeSpot = False
                                            '    End If
                                            'Else
                                            '    If tmSdf.sBill = "Y" Then
                                            '        ilIncludeSpot = False
                                            '    End If
                                            'End If
                                        Else
                                            ilIncludeSpot = False
                                        End If
                                    Else
                                        If (tmSdf.sSchStatus = "O") And (tmSdf.sSpotType = "X") Then
                                            'Only the Outside gets billed, not the missed
                                            If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then     '11-15-16 archive or Reprint- only include Billed
                                                If tmSdf.sBill <> "Y" Then
                                                    ilIncludeSpot = False
                                                End If
                                            Else
                                                If tmSdf.sBill = "Y" Then
                                                    ilIncludeSpot = False
                                                End If
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                            If ilIncludeSpot Then
                                For llLoop = LBound(tgMGSdfExt) To UBound(tgMGSdfExt) - 1 Step 1
                                    If tgMGSdfExt(llLoop).tSdfExt.lCode = tlSdfExt.lCode Then
                                        ilIncludeSpot = False
                                        Exit For
                                    End If
                                Next llLoop
                            End If
                            If ilIncludeSpot Then
                                'tgMGSdfExt(UBound(tgMGSdfExt)) = tlSdfExt
                                'ReDim Preserve tgMGSdfExt(0 To UBound(tgMGSdfExt) + 1) As SORTSDFEXT
                                slChfCode = Trim$(str$(tlSdfExt.lChfCode))
                                Do While Len(slChfCode) < 10
                                    slChfCode = "0" & slChfCode
                                Loop
                                slLineNo = Trim$(str$(tlSdfExt.iLineNo))
                                Do While Len(slLineNo) < 5
                                    slLineNo = "0" & slLineNo
                                Loop
                                tgMGSdfExt(UBound(tgMGSdfExt)).sKey = slChfCode & slLineNo
                                tgMGSdfExt(UBound(tgMGSdfExt)).tSdfExt = tlSdfExt
                                ReDim Preserve tgMGSdfExt(0 To UBound(tgMGSdfExt) + 1) As SORTSDFEXT
                            End If
                        End If
                    End If
                    ilRet = btrExtGetNext(hmSmf, tmSmf, ilExtLen, llRecPos)
                    Do While ilRet = BTRV_ERR_REJECT_COUNT
                        ilRet = btrExtGetNext(hmSmf, tmSmf, ilExtLen, llRecPos)
                    Loop
                Loop
            End If
        End If
    Next ilPass
    llLoop = UBound(tgMGSdfExt)
    If llLoop > 0 Then
        ArraySortTyp fnAV(tgMGSdfExt(), 0), llLoop, 0, LenB(tgMGSdfExt(0)), 0, LenB(tgMGSdfExt(0).sKey), 0
    End If
    For llLoop = 0 To UBound(tgMGSdfExt) - 1 Step 1
        tlSdfExt = tgMGSdfExt(llLoop).tSdfExt
        If mCreateDateTimeForMissed(tlSdfExt, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate) Then
            mCreateSortRec 1, ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate, tlSdfExt
        End If
    Next llLoop
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetMktCode                     *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Generate Market total records   *
'*                                                     *
'*******************************************************
Private Sub mGetMktCode()
    Dim ilVef As Integer
    'For ilVef = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
    '    If tgMVef(ilVef).iCode = tmClf.iVefCode Then
        ilVef = gBinarySearchVef(tmClf.iVefCode)
        If ilVef <> -1 Then
            imMnfVehGp3Mkt = tgMVef(ilVef).iMnfVehGp3Mkt
            Exit Sub
        End If
    'Next ilVef
    imMnfVehGp3Mkt = 0
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetPackageSpots                *
'*                                                     *
'*             Created:9/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Get Package Spots              *
'*                      1. Scan all lines for Package  *
'*                      lines between dates            *
'*                      2. Get flights and determine   *
'*                      number of spots required       *
'*                      3. Test if spot already exist  *
'*                      if not create into Psf         *
'*                      4. Assign Copy to spot         *
'*                                                     *
'*******************************************************
Private Sub mGetPackageSpots(llStdStartDate As Long, llStdEndDate As Long, llCalStartDate As Long, llCalEndDate As Long, llWkStartDate As Long, llWkEndDate As Long, llBaseDate As Long, ilUpper As Integer)
    Dim ilLoop As Integer
    Dim ilRet As Integer
    Dim ilExtLen As Integer
    Dim llNoRec As Long
    Dim llRecPos As Long
    Dim ilOffSet As Integer
    Dim slDate As String
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim llLnSDate As Long       'Line Start Date
    Dim llLnEDate As Long       'Line End Date
    Dim ilIncludeLn As Integer  'Include Line
    Dim llFlSDate As Long       'Flight Start Date
    Dim llFlEDate As Long       'Flight End Date
    Dim ilIncludeFl As Integer  'Include Flight
    Dim ilDay As Integer
    Dim llSDateRg As Long       'StartDate Range
    Dim llEDateRg As Long       'End Date Range
    Dim llDate As Long
    Dim llSDate As Long       'Flight Start Date
    Dim llEDate As Long       'Flight End Date
    Dim ilVefCode As Integer
    Dim ilTest As Integer
    'Dim slNameCode As String
    'Dim slCode As String
    Dim ilFound As Integer
    Dim llClf As Long
    Dim llLoop As Long
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
    ReDim ilAllowedDays(0 To 6) As Integer
    Dim tlVef As VEF

    If (tgSpf.sCPkOrdered <> "Y") And (tgSpf.sCPkAired <> "Y") And (tgSpf.sCPkEqual <> "Y") Then
        Exit Sub
    End If
    ReDim tgPkLnGen(0 To 0) As PKLNGEN
    btrExtClear hmClf   'Clear any previous extend operation
    ilExtLen = Len(tmClf)
    llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hmSdf) 'Obtain number of records
    btrExtClear hmClf   'Clear any previous extend operation
    ilRet = btrGetFirst(hmClf, tmClf, imClfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If ilRet <> BTRV_ERR_END_OF_FILE Then
        If ilRet <> BTRV_ERR_NONE Then
            Exit Sub
        End If
        Call btrExtSetBounds(hmClf, llNoRec, -1, "UC", "CLF", "") 'Set extract limits (all records)
        'If (llStdStartDate > 0) And (llCalStartDate > 0) Then
        '    If llStdStartDate < llCalStartDate Then
        '        slDate = smStartStd
        '    Else
        '        slDate = smStartCal
        '    End If
        'ElseIf llCalStartDate > 0 Then
        '    slDate = smStartCal
        'Else
        '    slDate = smStartStd
        'End If
        slDate = ""
        If llStdStartDate > 0 Then
            slDate = smStartStd
        End If
        If (llCalStartDate > 0) And ((llCalStartDate < gDateValue(slDate)) Or (slDate = "")) Then
            slDate = smStartCal
        End If
        If (llWkStartDate > 0) And ((llWkStartDate < gDateValue(slDate)) Or (slDate = "")) Then
            slDate = smStartWk
        End If
        llStartDate = gDateValue(slDate)
        'If (llStdEndDate > 0) And (llCalEndDate > 0) Then
        '    If llStdEndDate > llCalEndDate Then
        '        slDate = smEndStd
        '    Else
        '        slDate = smEndCal
        '    End If
        'ElseIf llCalEndDate > 0 Then
        '    slDate = smEndCal
        'Else
        '    slDate = smEndStd
        'End If
        slDate = ""
        If llStdEndDate > 0 Then
            slDate = smEndStd
        End If
        If (llCalEndDate > 0) And ((llCalEndDate > gDateValue(slDate)) Or (slDate = "")) Then
            slDate = smEndCal
        End If
        If (llWkEndDate > 0) And ((llWkEndDate > gDateValue(slDate)) Or (slDate = "")) Then
            slDate = smEndWk
        End If
        llEndDate = gDateValue(slDate)
        tlCharTypeBuff.sType = "O"    'Extract all matching records
        ilOffSet = gFieldOffset("Clf", "ClfType")
        ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_OR, tlCharTypeBuff, 1)
        tlCharTypeBuff.sType = "E"    'Extract all matching records
        ilOffSet = gFieldOffset("Clf", "ClfType")
        ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_OR, tlCharTypeBuff, 1)
        tlCharTypeBuff.sType = "A"    'Extract all matching records
        ilOffSet = gFieldOffset("Clf", "ClfType")
        ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_LAST_TERM, tlCharTypeBuff, 1)
        ilRet = btrExtAddField(hmClf, 0, ilExtLen)  'Extract Name
        If ilRet <> BTRV_ERR_NONE Then
            Exit Sub
        End If
        ilRet = btrExtGetNext(hmClf, tmClf, ilExtLen, llRecPos)
        If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
            If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                Exit Sub
            End If
            'ilRet = btrExtGetFirst(hmSdf, tlSdfExt, ilExtLen, llRecPos)
            ilExtLen = Len(tmClf)
            Do While ilRet = BTRV_ERR_REJECT_COUNT
                ilRet = btrExtGetNext(hmClf, tmClf, ilExtLen, llRecPos)
            Loop
            Do While ilRet = BTRV_ERR_NONE
                If tmClf.sSchStatus = "F" Then
                    If tmChf.lCode <> tmClf.lChfCode Then
                        tmChfSrchKey.lCode = tmClf.lChfCode
                        ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                        If ilRet <> BTRV_ERR_NONE Then
                            ilIncludeLn = False
                        End If
                    Else
                        ilRet = BTRV_ERR_NONE
                    End If
                    If ilRet = BTRV_ERR_NONE Then
                        ilFound = False
                        For llLoop = LBound(tgPkLnGen) To UBound(tgPkLnGen) - 1 Step 1
                            If (tmChf.lCntrNo = tgPkLnGen(llLoop).lCntrNo) And (tmClf.iLine = tgPkLnGen(llLoop).tClf.iLine) Then
                                ilFound = True
                                If tmClf.iCntRevNo > tgPkLnGen(llLoop).tClf.iCntRevNo Then
                                    tgPkLnGen(llLoop).tClf = tmClf
                                    tgPkLnGen(llLoop).lRecPos = llRecPos
                                End If
                                Exit For
                            End If
                        Next llLoop
                        If Not ilFound Then
                            tgPkLnGen(UBound(tgPkLnGen)).tClf = tmClf
                            tgPkLnGen(UBound(tgPkLnGen)).lRecPos = llRecPos
                            tgPkLnGen(UBound(tgPkLnGen)).lCntrNo = tmChf.lCntrNo
                            ReDim Preserve tgPkLnGen(0 To UBound(tgPkLnGen) + 1) As PKLNGEN
                        End If
                    End If
                End If
                ilRet = btrExtGetNext(hmClf, tmClf, ilExtLen, llRecPos)
                Do While ilRet = BTRV_ERR_REJECT_COUNT
                    ilRet = btrExtGetNext(hmClf, tmClf, ilExtLen, llRecPos)
                Loop
            Loop
        End If
    End If
    For llClf = 0 To UBound(tgPkLnGen) - 1 Step 1
        tmClf = tgPkLnGen(llClf).tClf
        llRecPos = tgPkLnGen(llClf).lRecPos

        'Test date
        'gUnpackDateLong tmClf.iStartDate(0), tmClf.iStartDate(1), llLnSDate
        gUnpackDateLongError tmClf.iStartDate(0), tmClf.iStartDate(1), llLnSDate, "32:mGetPackageSpots " & tmClf.lCode
        'gUnpackDateLong tmClf.iEndDate(0), tmClf.iEndDate(1), llLnEDate
        gUnpackDateLongError tmClf.iEndDate(0), tmClf.iEndDate(1), llLnEDate, "33:mGetPackageSpots " & tmClf.lCode
        ilIncludeLn = True
        If (llLnEDate < llStartDate) Or (llLnSDate > llEndDate) Then
            ilIncludeLn = False
        Else
            If tmClf.sDelete = "Y" Then
                ilIncludeLn = False
            End If
        End If
        If llLnEDate < llLnSDate Then
            ilIncludeLn = False
        End If
        If ilIncludeLn Then
            If tmChf.lCode <> tmClf.lChfCode Then
                tmChfSrchKey.lCode = tmClf.lChfCode
                ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                If ilRet <> BTRV_ERR_NONE Then
                    ilIncludeLn = False
                End If
            End If
            If (tmChf.sType = "S") Or (tmChf.sType = "M") Or (tmChf.sType = "V") Then
                ilIncludeLn = False
            End If
        End If
        'Check if Contract is REP or Air time.  If Rep, then ignore contract
        If (ilIncludeLn) And ((Asc(tgSpf.sUsingFeatures) And USINGREP) = USINGREP) Then
            If tmChf.lVefCode > 0 Then
                ilVefCode = tmChf.lVefCode
                ilTest = gBinarySearchVef(ilVefCode)
                If ilTest <> -1 Then
                    If tgMVef(ilTest).sType = "R" Then
                        ilIncludeLn = False
                    End If
                End If
            ElseIf tmChf.lVefCode < 0 Then
                tmVsfSrchKey.lCode = -tmChf.lVefCode
                ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                Do While ilRet = BTRV_ERR_NONE
                    For ilLoop = LBound(tmVsf.iFSCode) To UBound(tmVsf.iFSCode) Step 1
                        If tmVsf.iFSCode(ilLoop) > 0 Then
                            ilVefCode = tmVsf.iFSCode(ilLoop)
                            ilTest = gBinarySearchVef(ilVefCode)
                            If ilTest <> -1 Then
                                If tgMVef(ilTest).sType = "R" Then
                                    ilIncludeLn = False
                                    Exit Do
                                End If
                            End If
                        End If
                    Next ilLoop
                    If (tmVsf.lLkVsfCode <= 0) Then
                        Exit Do
                    End If
                    tmVsfSrchKey.lCode = tmVsf.lLkVsfCode
                    ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop
            End If
        End If
        If ilIncludeLn Then
            If (rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value) Then          '11-15-16 reprint, aff or archive
                ilIncludeLn = False
                For ilLoop = 0 To UBound(tmRPInfo) - 1 Step 1
                    If (tmChf.lCntrNo = tmRPInfo(ilLoop).lCntrNo) And ((tmRPInfo(ilLoop).iMnfItem = 0) Or (tmRPInfo(ilLoop).iMnfItem = -1)) Then
                        ilIncludeLn = True
                        Exit For
                    End If
                Next ilLoop
            End If
            If (rbcCntr(INVCNTR_Selective).Value Or rbcCntr(INVCNTR_WOExpired).Value Or rbcCntr(INVCNTR_Posted).Value) And ((rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value)) Then
                ilIncludeLn = False
                For ilLoop = 0 To UBound(lmSelCntrCode) - 1 Step 1
                    If tmChf.lCode = lmSelCntrCode(ilLoop) Then
                        ilIncludeLn = True
                        Exit For
                    End If
                Next ilLoop
            End If
        End If
        If ilIncludeLn Then
            If (tmChf.sBillCycle = "C") And (Not imFullCal) Then
                'gUnpackDateLong tmChf.iEndDate(0), tmChf.iEndDate(1), llDate
                gUnpackDateLongError tmChf.iEndDate(0), tmChf.iEndDate(1), llDate, "34:mGetPackageSpots " & tmChf.lCode
                If llDate > llCalEndDate Then
                    ilIncludeLn = False
                End If
            End If
            If (tmChf.sBillCycle = "W") And (Not imFullWk) Then
                'gUnpackDateLong tmChf.iEndDate(0), tmChf.iEndDate(1), llDate
                gUnpackDateLongError tmChf.iEndDate(0), tmChf.iEndDate(1), llDate, "34:mGetPackageSpots " & tmChf.lCode
                If llDate > llWkEndDate Then
                    ilIncludeLn = False
                End If
            End If
            If (tmChf.sBillCycle = "S") And (Not imFullStd) Then
                'gUnpackDateLong tmChf.iEndDate(0), tmChf.iEndDate(1), llDate
                gUnpackDateLongError tmChf.iEndDate(0), tmChf.iEndDate(1), llDate, "35:mGetPackageSpots " & tmChf.lCode
                If llDate > llStdEndDate Then
                    ilIncludeLn = False
                End If
            End If
        End If
        If ilIncludeLn Then
            'Add vehicle to list
            ilFound = False
            For ilLoop = 0 To UBound(tgInvVehCode) - 1 Step 1
                'ilRet = gParseItem(Trim$(tgInvVehCode(ilLoop).sKey), 2, "\", slCode)
                If tgInvVehCode(ilLoop).iCode = tmClf.iVefCode Then
                    ilFound = True
                    Exit For
                End If
            Next ilLoop
            If Not ilFound Then
                tmVefSrchKey.iCode = tmClf.iVefCode
                ilRet = btrGetEqual(hmVef, tlVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                tgInvVehCode(UBound(tgInvVehCode)).sKey = "000|000|" & tlVef.sName & "\" & Trim$(str$(tlVef.iCode))
                tgInvVehCode(UBound(tgInvVehCode)).iCode = tlVef.iCode
                ReDim Preserve tgInvVehCode(0 To UBound(tgInvVehCode) + 1) As VEHSORT
            End If
            'If (tmClf.sType = "O") Or ((tmClf.sType = "A") And (tgSpf.sInvAirOrder = "2")) Or ((tmClf.sType = "E") And (tgSpf.sInvAirOrder = "2")) Then
            'If (tmClf.sType = "O") Or ((tmClf.sType = "A") And (tgSpf.sBLaserForm = "2")) Or ((tmClf.sType = "E") And (tgSpf.sInvAirOrder = "2")) Then
            If (tmClf.sType = "O") Or ((tmClf.sType = "E") And (tgSpf.sInvAirOrder = "2")) Then
                For ilLoop = LBONE To 24 Step 1
                    imHour(ilLoop) = 0
                Next ilLoop
                For ilLoop = LBONE To 7 Step 1
                    imDay(ilLoop) = 0
                Next ilLoop
                For ilLoop = LBONE To 4
                    imQH(ilLoop) = 0
                Next ilLoop
                'Obtain flight for line
                tmCffSrchKey.lChfCode = tmClf.lChfCode
                tmCffSrchKey.iClfLine = tmClf.iLine
                tmCffSrchKey.iCntRevNo = tmClf.iCntRevNo
                tmCffSrchKey.iPropVer = tmClf.iPropVer
                tmCffSrchKey.iStartDate(0) = 0
                tmCffSrchKey.iStartDate(1) = 0
                ilRet = btrGetGreaterOrEqual(hmCff, tmCff, imCffRecLen, tmCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tmCff.lChfCode = tmClf.lChfCode) And (tmCff.iClfLine = tmClf.iLine) And (tmCff.iCntRevNo = tmClf.iCntRevNo) And (tmCff.iPropVer = tmClf.iPropVer)
                    'Test dates
                    If tmCff.sDelete = "Y" Then
                        ilIncludeFl = False
                    Else
                        ilIncludeFl = True
                        'gUnpackDateLong tmCff.iStartDate(0), tmCff.iStartDate(1), llFlSDate
                        gUnpackDateLongError tmCff.iStartDate(0), tmCff.iStartDate(1), llFlSDate, "36:mGetPackageSpots-CFF "
                        'gUnpackDateLong tmCff.iEndDate(0), tmCff.iEndDate(1), llFlEDate
                        gUnpackDateLongError tmCff.iEndDate(0), tmCff.iEndDate(1), llFlEDate, "37:mGetPackageSpots-CFF "
                        If (llFlEDate < llStartDate) Or (llFlSDate > llEndDate) Then
                            ilIncludeFl = False
                        Else
                            If llFlEDate < llFlSDate Then
                                ilIncludeFl = False
                            End If
                        End If
                    End If
                    If ilIncludeFl Then
                        For ilLoop = LBONE To 24 Step 1
                            If imHour(ilLoop) >= 30000 Then
                                imHour(ilLoop) = imHour(ilLoop) - 30000
                            End If
                        Next ilLoop
                        For ilLoop = LBONE To 7 Step 1
                            If imDay(ilLoop) >= 30000 Then
                                imDay(ilLoop) = imDay(ilLoop) - 30000
                            End If
                        Next ilLoop
                        For ilLoop = LBONE To 4
                            If imQH(ilLoop) >= 30000 Then
                                'imQH(ilLoop) = imDay(ilLoop) - 30000
                                imQH(ilLoop) = imQH(ilLoop) - 30000
                            End If
                        Next ilLoop
                        'Determine number of spots required
                        If tmChf.sBillCycle = "C" Then
                            llSDateRg = llCalStartDate
                            llEDateRg = llCalEndDate
                        ElseIf tmChf.sBillCycle = "W" Then
                            llSDateRg = llWkStartDate
                            llEDateRg = llWkEndDate
                        Else
                            llSDateRg = llStdStartDate
                            llEDateRg = llStdEndDate
                        End If
                        llSDate = llFlSDate
                        llEDate = gDateValue(gObtainNextSunday(Format$(llSDate, "m/d/yy")))
                        If llEDate > llFlEDate Then
                            llEDate = llFlEDate
                        End If
                        Do While llSDate <= llEDate
                            If (llEDate >= llSDateRg) And (llSDate <= llEDateRg) Then
                                If tmChf.sBillCycle = "C" Then
                                    If tmCff.sDyWk = "D" Then
                                        If tmClf.sType <> "E" Then
                                            For llDate = llSDate To llEDate Step 1
                                                For ilDay = 0 To 6 Step 1
                                                    ilAllowedDays(ilDay) = False
                                                    imDay(ilDay + 1) = 30000
                                                Next ilDay
                                                ilDay = gWeekDayLong(llDate)
                                                ilAllowedDays(ilDay) = True
                                                imDay(ilDay + 1) = 0
                                                mObtainPsf tmCff.iDay(ilDay), llDate, llDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                            Next llDate
                                        Else
                                            For ilDay = 0 To 6 Step 1
                                                ilAllowedDays(ilDay) = False
                                                imDay(ilDay + 1) = 30000
                                            Next ilDay
                                            For llDate = llSDate To llEDate Step 1
                                                ilDay = gWeekDayLong(llDate)
                                                If tmCff.iDay(ilDay) > 0 Then
                                                    ilAllowedDays(ilDay) = True
                                                    imDay(ilDay + 1) = 0
                                                End If
                                            Next llDate
                                            mObtainPsf 1, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                        End If
                                    Else
                                        'Determine which spots/week to be used
                                        If tmCff.iSpotsWk > 0 Then
                                            For ilDay = 0 To 6 Step 1
                                                If tmCff.iDay(ilDay) > 0 Then
                                                    ilAllowedDays(ilDay) = True
                                                Else
                                                    ilAllowedDays(ilDay) = False
                                                End If
                                            Next ilDay
                                            If tmClf.sType <> "E" Then
                                                mObtainPsf tmCff.iSpotsWk, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                            Else
                                                mObtainPsf 1, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                            End If
                                        Else
                                            For ilDay = 0 To 6 Step 1
                                                If tmCff.sXDay(ilDay) = "1" Then
                                                    ilAllowedDays(ilDay) = True
                                                Else
                                                    ilAllowedDays(ilDay) = False
                                                End If
                                            Next ilDay
                                            If tmCff.iXSpotsWk > 0 Then
                                                If tmClf.sType <> "E" Then
                                                    mObtainPsf tmCff.iXSpotsWk, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                                Else
                                                    mObtainPsf 1, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                                End If
                                            End If
                                        End If
                                    End If
                                ElseIf tmChf.sBillCycle = "W" Then
                                    If tmCff.sDyWk = "D" Then
                                        If tmClf.sType <> "E" Then
                                            For llDate = llSDate To llEDate Step 1
                                                For ilDay = 0 To 6 Step 1
                                                    ilAllowedDays(ilDay) = False
                                                    imDay(ilDay + 1) = 30000
                                                Next ilDay
                                                ilDay = gWeekDayLong(llDate)
                                                ilAllowedDays(ilDay) = True
                                                imDay(ilDay + 1) = 0
                                                mObtainPsf tmCff.iDay(ilDay), llDate, llDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                            Next llDate
                                        Else
                                            For ilDay = 0 To 6 Step 1
                                                ilAllowedDays(ilDay) = False
                                                imDay(ilDay + 1) = 30000
                                            Next ilDay
                                            For llDate = llSDate To llEDate Step 1
                                                ilDay = gWeekDayLong(llDate)
                                                If tmCff.iDay(ilDay) > 0 Then
                                                    ilAllowedDays(ilDay) = True
                                                    imDay(ilDay + 1) = 0
                                                End If
                                            Next llDate
                                            mObtainPsf 1, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                        End If
                                    Else
                                        'Determine which spots/week to be used
                                        If tmCff.iSpotsWk > 0 Then
                                            For ilDay = 0 To 6 Step 1
                                                If tmCff.iDay(ilDay) > 0 Then
                                                    ilAllowedDays(ilDay) = True
                                                Else
                                                    ilAllowedDays(ilDay) = False
                                                End If
                                            Next ilDay
                                            If tmClf.sType <> "E" Then
                                                mObtainPsf tmCff.iSpotsWk, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                            Else
                                                mObtainPsf 1, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                            End If
                                        Else
                                            For ilDay = 0 To 6 Step 1
                                                If tmCff.sXDay(ilDay) = "1" Then
                                                    ilAllowedDays(ilDay) = True
                                                Else
                                                    ilAllowedDays(ilDay) = False
                                                End If
                                            Next ilDay
                                            If tmCff.iXSpotsWk > 0 Then
                                                If tmClf.sType <> "E" Then
                                                    mObtainPsf tmCff.iXSpotsWk, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                                Else
                                                    mObtainPsf 1, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                                End If
                                            End If
                                        End If
                                    End If
                                Else
                                    If tmCff.sDyWk = "D" Then
                                        If tmClf.sType <> "E" Then
                                            For llDate = llSDate To llEDate Step 1
                                                For ilDay = 0 To 6 Step 1
                                                    ilAllowedDays(ilDay) = False
                                                    imDay(ilDay + 1) = 30000
                                                Next ilDay
                                                ilDay = gWeekDayLong(llDate)
                                                ilAllowedDays(ilDay) = True
                                                imDay(ilDay + 1) = 0
                                                mObtainPsf tmCff.iDay(ilDay), llDate, llDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                            Next llDate
                                        Else
                                            For ilDay = 0 To 6 Step 1
                                                ilAllowedDays(ilDay) = False
                                                imDay(ilDay + 1) = 30000
                                            Next ilDay
                                            For llDate = llSDate To llEDate Step 1
                                                ilDay = gWeekDayLong(llDate)
                                                If tmCff.iDay(ilDay) > 0 Then
                                                    ilAllowedDays(ilDay) = True
                                                    imDay(ilDay + 1) = 0
                                                End If
                                            Next llDate
                                            mObtainPsf 1, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                        End If
                                    Else
                                        For ilDay = 0 To 6 Step 1
                                            If tmCff.iDay(ilDay) > 0 Then
                                                ilAllowedDays(ilDay) = True
                                            Else
                                                ilAllowedDays(ilDay) = False
                                            End If
                                        Next ilDay
                                        If tmClf.sType <> "E" Then
                                            mObtainPsf tmCff.iSpotsWk, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                        Else
                                            mObtainPsf 1, llSDate, llEDate, ilAllowedDays(), ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate
                                        End If
                                    End If
                                End If
                            End If
                            llSDate = llEDate + 1
                            llEDate = llEDate + 7
                            If llEDate > llFlEDate Then
                                llEDate = llFlEDate
                            End If
                        Loop
                    End If
                    ilRet = btrGetNext(hmCff, tmCff, imCffRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop
            End If
        End If
    Next llClf
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetPastINTran                  *
'*                                                     *
'*             Created:3/01/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Obtain Rvf records             *
'*                                                     *
'*******************************************************
Private Sub mGetPastInTran(llCntrNo As Long, ilAdfCode As Integer, ilAgfCode As Integer, ilPkLineNo As Integer)
    Dim ilPass As Integer
    Dim hlFile As Integer
    'Dim ilFound As Integer
    Dim ilRet As Integer
    Dim slDollars As String
    Dim ilIndex As Integer
    Dim ilPkRvf As Integer
    For ilPass = 1 To 2 Step 1
        If ilPass = 1 Then
            hlFile = hmRvf
        Else
            hlFile = hmPhf
        End If
        tmRvfSrchKey1.iAdfCode = ilAdfCode
        ilRet = btrGetEqual(hlFile, tmRvf, imRvfRecLen, tmRvfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        Do While (ilRet = BTRV_ERR_NONE) And (tmRvf.iAdfCode = ilAdfCode)
            If (ilAgfCode = tmRvf.iAgfCode) And (ilPkLineNo = tmRvf.iPkLineNo) And (llCntrNo = tmRvf.lCntrNo) Then
                If ((tmRvf.sTranType = "IN") Or (tmRvf.sTranType = "AN")) Then
                    gPDNToStr tmRvf.sGross, 2, slDollars
                    ilIndex = -1
                    For ilPkRvf = LBound(tmPkRvf) To UBound(tmPkRvf) - 1 Step 1
                        If (tmPkRvf(ilPkRvf).iVefCode = tmRvf.iAirVefCode) Then 'tmSdf.iVefCode) Then
                            ilIndex = ilPkRvf
                            Exit For
                        End If
                    Next ilPkRvf
                    If ilIndex = -1 Then
                        ilPkRvf = UBound(tmPkRvf)
                        tmPkRvf(ilPkRvf).iVefCode = tmRvf.iAirVefCode   'tmSdf.iVefCode
                        tmPkRvf(ilPkRvf).iPkLineNo = ilPkLineNo
                        tmPkRvf(ilPkRvf).sTotalGross = ".0000"
                        tmPkRvf(ilPkRvf).sTotalVefDollars = ".00"
                        tmPkRvf(ilPkRvf).sTotalVefBilledDollars = ".00"
                        'ReDim Preserve tmPkRvf(1 To ilPkRvf + 1) As RVFVEF
                        ReDim Preserve tmPkRvf(0 To ilPkRvf + 1) As RVFVEF
                    Else
                        ilPkRvf = ilIndex
                    End If
                    tmPkRvf(ilPkRvf).sTotalVefBilledDollars = gAddStr(tmPkRvf(ilPkRvf).sTotalVefBilledDollars, slDollars)
                End If
            End If
            ilRet = btrGetNext(hlFile, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        Loop
    Next ilPass
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mGetRvfIndex                    *
'*                                                     *
'*             Created:3/01/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Obtain RvfByVef record index   *
'*                      for a spot                     *
'*                                                     *
'*******************************************************
Private Function mGetRvfIndex(ilVefCode As Integer) As Integer
'
'   tmVef(I)
'   tmClf(I)
'

    Dim ilUpdateIndex As Integer
    Dim ilLoop As Integer
    Dim ilPkLineNo As Integer
    Dim llGsfCode As Long
    Dim ilRet As Integer
    
    ilUpdateIndex = -1
    If (tmClf.sType = "O") Then
        ilPkLineNo = tmClf.iLine
    ElseIf (tmClf.sType = "A") Then
        ilPkLineNo = tmClf.iLine
    ElseIf (tmClf.sType = "E") Then
        ilPkLineNo = tmClf.iLine
    Else
        ilPkLineNo = 0
    End If
    
    '4/30/14: Break out revenue by Sport Event
    llGsfCode = 0
    If ((Asc(tgSaf(0).sFeatures2) And EVENTREVENUE) = EVENTREVENUE) Then
        If (ilPkLineNo = 0) Or (tmSpotClf.sType = "S") Or (tmClf.sType = "A") Then
            If (tmSdf.iGameNo > 0) Then
                tmGsfSrchKey3.iVefCode = tmSdf.iVefCode
                tmGsfSrchKey3.iGameNo = tmSdf.iGameNo
                ilRet = btrGetEqual(hmGsf, tmGsf, imGsfRecLen, tmGsfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
                Do While (ilRet = BTRV_ERR_NONE) And (tmGsf.iVefCode = tmSdf.iVefCode) And (tmGsf.iGameNo = tmSdf.iGameNo)
                    If (tmSdf.iDate(0) = tmGsf.iAirDate(0)) And (tmSdf.iDate(1) = tmGsf.iAirDate(1)) Then
                        llGsfCode = tmGsf.lCode
                        Exit Do
                    End If
                    ilRet = btrGetNext(hmGsf, tmGsf, imGsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
                Loop
            End If
        End If
    End If

    If imExportCntr Then
        For ilLoop = 0 To UBound(tgRvfByVef) - 1 Step 1
            If (tgRvfByVef(ilLoop).iVefCode = ilVefCode) And (tgRvfByVef(ilLoop).iLnVefCode = tmSpotClf.iVefCode) Then
                'If tgRvfByVef(ilLoop).iPkLineNo = ilPkLineNo Then
                If (tgRvfByVef(ilLoop).iPkLineNo = ilPkLineNo) And (tgRvfByVef(ilLoop).lGsfCode = llGsfCode) Then
                    ilUpdateIndex = ilLoop
                    Exit For
                End If
            End If
        Next ilLoop
    Else
        For ilLoop = 0 To UBound(tgRvfByVef) - 1 Step 1
            If (tgRvfByVef(ilLoop).iVefCode = ilVefCode) Then
                'If tgRvfByVef(ilLoop).iPkLineNo = ilPkLineNo Then
                If (tgRvfByVef(ilLoop).iPkLineNo = ilPkLineNo) And (tgRvfByVef(ilLoop).lGsfCode = llGsfCode) Then
                    ilUpdateIndex = ilLoop
                    Exit For
                End If
            End If
        Next ilLoop
    End If
    If ilUpdateIndex = -1 Then
        ilUpdateIndex = UBound(tgRvfByVef)
        ReDim Preserve tgRvfByVef(0 To ilUpdateIndex + 1) As RVFVEF
        tgRvfByVef(ilUpdateIndex).iVefCode = ilVefCode
        tgRvfByVef(ilUpdateIndex).iPkLineNo = ilPkLineNo
        tgRvfByVef(ilUpdateIndex).lGsfCode = llGsfCode
        tgRvfByVef(ilUpdateIndex).sTotalGross = ".00"
        tgRvfByVef(ilUpdateIndex).lANoSpots = 0
        tgRvfByVef(ilUpdateIndex).lBNoSpots = 0
        tgRvfByVef(ilUpdateIndex).lPrice = -1
        If imExportCntr Then
            tgRvfByVef(ilUpdateIndex).iLnVefCode = tmSpotClf.iVefCode
        Else
            tgRvfByVef(ilUpdateIndex).iLnVefCode = 0
        End If
    End If
    mGetRvfIndex = ilUpdateIndex
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mIncCountsForCntrExport         *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Increment aired counts for      *
'*                     contract export                 *
'*                                                     *
'*******************************************************
Sub mIncCountsForCntrExport(ilVefCode As Integer, ilBonusSpot As Integer, slAiredPrice As String)
    Dim ilUpdateIndex As Integer
    Dim ilLoop As Integer
    Dim ilPkLineNo As Integer
    Dim llPrice As Long

    If imRemoteCntr Then
        Exit Sub
    End If
    If imExportCntr Then
        'Code taken from mGetRvfIndex
        If InStr(slAiredPrice, ".") > 0 Then
            llPrice = gStrDecToLong(slAiredPrice, 2)
        Else
            llPrice = "0"
        End If
        ilUpdateIndex = -1
        If (tmClf.sType = "O") Then
            ilPkLineNo = tmClf.iLine
        ElseIf (tmClf.sType = "A") Then
            ilPkLineNo = tmClf.iLine
        ElseIf (tmClf.sType = "E") Then
            ilPkLineNo = tmClf.iLine
        Else
            ilPkLineNo = 0
        End If
        For ilLoop = 0 To UBound(tgRvfByVef) - 1 Step 1
            If (tgRvfByVef(ilLoop).iVefCode = ilVefCode) And (tgRvfByVef(ilLoop).iLnVefCode = tmSpotClf.iVefCode) Then
                If tgRvfByVef(ilLoop).iPkLineNo = ilPkLineNo Then
                    If tgRvfByVef(ilLoop).lPrice = llPrice Then
                        If Not ilBonusSpot Then
                            tgRvfByVef(ilLoop).lANoSpots = tgRvfByVef(ilLoop).lANoSpots + 1
                        Else
                            tgRvfByVef(ilLoop).lBNoSpots = tgRvfByVef(ilLoop).lBNoSpots + 1
                        End If
                        Exit Sub
                    End If
                End If
            End If
        Next ilLoop
        If ilUpdateIndex = -1 Then
            For ilLoop = 0 To UBound(tgRvfByVef) - 1 Step 1
                If (tgRvfByVef(ilLoop).iVefCode = ilVefCode) And (tgRvfByVef(ilLoop).iLnVefCode = tmSpotClf.iVefCode) Then
                    If tgRvfByVef(ilLoop).iPkLineNo = ilPkLineNo Then
                        If tgRvfByVef(ilLoop).lPrice = -1 Then
                            If Not ilBonusSpot Then
                                tgRvfByVef(ilLoop).lANoSpots = tgRvfByVef(ilLoop).lANoSpots + 1
                            Else
                                tgRvfByVef(ilLoop).lBNoSpots = tgRvfByVef(ilLoop).lBNoSpots + 1
                            End If
                            tgRvfByVef(ilLoop).lPrice = llPrice
                            Exit Sub
                        End If
                    End If
                End If
            Next ilLoop
        End If
        If ilUpdateIndex = -1 Then
            ilUpdateIndex = UBound(tgRvfByVef)
            ReDim Preserve tgRvfByVef(0 To ilUpdateIndex + 1) As RVFVEF
            tgRvfByVef(ilUpdateIndex).iVefCode = ilVefCode
            tgRvfByVef(ilUpdateIndex).iPkLineNo = ilPkLineNo
            tgRvfByVef(ilUpdateIndex).sTotalGross = ".00"
            If Not ilBonusSpot Then
                tgRvfByVef(ilUpdateIndex).lANoSpots = 1
                tgRvfByVef(ilUpdateIndex).lBNoSpots = 0
            Else
                tgRvfByVef(ilUpdateIndex).lANoSpots = 0
                tgRvfByVef(ilUpdateIndex).lBNoSpots = 1
            End If
            tgRvfByVef(ilUpdateIndex).lPrice = llPrice
            tgRvfByVef(ilUpdateIndex).iLnVefCode = tmSpotClf.iVefCode
        End If
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mInit                           *
'*                                                     *
'*             Created:9/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Initialize modular             *
'*                                                     *
'*******************************************************
Private Sub mInit()
'
'   mInit
'   Where:
'
    Dim ilRet As Integer
    Dim ilMultiTable As Integer
    Dim slStr As String
    Dim slDate As String
    Dim ilLoop As Integer
    Dim ilVeh As Integer
    Dim ilVff As Integer

    imTerminate = False
    imFirstActivate = True
    mParseCmmdLine
    If imTerminate Then
        Exit Sub
    End If
    
    Screen.MousePointer = vbHourglass
    'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
    plcFromLine.Height = Invoice.Height - 1600
    frcBilling.Top = plcFromLine.Height - frcBilling.Height - 80
    plcAdvt.Top = plcFromLine.Height - plcAdvt.Height - 80
    cbcDates.Top = frcType.Top + frcType.Height + 80
    cbcWeek.Top = frcType.Top + frcType.Height + 80
    grdRevenue.Top = frcType.Top + frcType.Height + cbcDates.Height + 160
    grdRevenue.Height = plcFromLine.Height - grdRevenue.Top - plcAdvt.Height - 160
    grdRevenue.Left = 120
    grdRevenue.Width = plcFromLine.Width - 240
    grdAirTime.Height = plcFromLine.Height - grdAirTime.Top - plcAdvt.Height - frcBilling.Height - 200
    
    lbcVehicle.Top = grdAirTime.Top
    lbcVehicle.Height = grdAirTime.Height
    ckcAll.Top = lbcVehicle.Top + lbcVehicle.Height + 20
    
    plcCntr.Top = plcFromLine.Height - plcAdvt.Height - frcBilling.Height - 80
    lacMonth.Top = cbcDates.Top + 20
    lacMonth.Left = 120
    lacWeek.Top = cbcDates.Top + 20
    lacWeek.Left = 3780
        
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    imFromCallRadioButton = False
    imObtainDateCalled = False
    imAppendFutureSpots = -1
    igJobShowing(INVOICESJOB) = True
    imFirstActivate = True
    imBuildingAdvt = False
    lmLockRecCode = 0
    imIgnoreSelAdvtRequest = False
    imCombineAirAndNTR = True
    ReDim lmCPMBypassCntr(0 To 0) As Long

    'dan-imCombineAirAndNTR could be set here instead of cmcGenerate
    If ((Asc(tgSpf.sUsingFeatures5) And COMBINEAIRNTR) = COMBINEAIRNTR) Or (((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) = INSTALLMENT)) Then
        lacNTR.Visible = False
        lacNTRDates.Visible = False
    Else
        lacNTR.Visible = True
        lacNTRDates.Visible = True
    End If
    '10016
    mSetPDFEmailAllowed
    'must be run after mSetPDFEmailAllowed
    mSetPDFToggling
    imRollbackReconcRequired = -1
    imcPrt.Picture = IconTraf!imcPrinter.Picture    'IconTraf!imcCamera.Picture
    
    'ReDim imHour(1 To 24) As Integer     'Hour count (Index 1 for 12m-1a; Index 2 for 1a-2a;...)
    ReDim imHour(0 To 24) As Integer     'Hour count (Index 1 for 12m-1a; Index 2 for 1a-2a;...). Index zero ignored
    'ReDim imDay(1 To 7) As Integer       'Day count (Index 1 for monday; Index 2 for tuesday;..)
    ReDim imDay(0 To 7) As Integer       'Day count (Index 1 for monday; Index 2 for tuesday;..)
    'ReDim imQH(1 To 4) As Integer        'Quarter hour count (Index 1 for 0min to 15min; Index 2 for 15min to 30min;..). Index zero ignored
    ReDim imQH(0 To 4) As Integer        'Quarter hour count (Index 1 for 0min to 15min; Index 2 for 15min to 30min;..). Index zero ignored. Index zero ignored
                                        'time periods of the rate card program
                                        '(-1 if time period not defined).  This is used
                                        'to distribute the spots according to % defined
                                        'with each time period (% are normalized to the
                                        'smallest percent. i.e. 20%, 20%, 60% => 1.0, 1.0, 3.0)
    'mParseCmmdLine
    'ilRet = PEOpenEngine()
    'If ilRet = 0 Then
    '    MsgBox "Unable to open print engine"
    '    imTerminate = True
    '    'mTerminate
    '    Exit Sub
    'End If
    smLogUserCode = Trim$(str$(tgUrf(0).iCode))
    'User should be running Affidavit of Performance report
    If (tgSpf.sBLaserForm = "2") And (Trim$(tgUrf(0).sName) = sgCPName) Then
        rbcType(INVGEN_Aff).Visible = True
    Else
        rbcType(INVGEN_Aff).Visible = False
    End If
    
    '12/15/12
    bmWeeklyBillExist = False
    If ((Asc(tgSpf.sUsingFeatures9) And WEEKLYBILL) = WEEKLYBILL) Then
        bmWeeklyBillExist = True
    End If
    
    'Invoice.Height = cmcCancel.Top + 5 * cmcCancel.Height / 3
    cmcGenerate.Top = Invoice.Height - 1000 '(3 * cmcGenerate.Height) / 2
    cmcCancel.Top = cmcGenerate.Top
    cmcSaleHist.Top = cmcGenerate.Top
    cmcClearPsf.Top = cmcGenerate.Top
    cmcReport.Top = cmcGenerate.Top
    imcHelp.Top = cmcGenerate.Top - 60
    lbcView.Top = plcFromLine.Top + plcFromLine.Height + 60
    lbcView.Height = cmcGenerate.Top - lbcView.Top - 60
    pbcClickFocus.Top = cmcGenerate.Top
    pbcClickFocus.Left = -100
    lbcView.Visible = False
    'gCenterForm Invoice
    gCenterStdAlone Invoice
    'Invoice.Show
    
    ilRet = gObtainSAF()
    mCheckAndPopEDIServiceNames
    
    'Set options for report generate
    'imcHelp.Picture = Traffic!imcHelp.Picture
'VB6**    hdJob = rpcRpt.hJob
    smNowDate = Format$(gNow(), "m/d/yy")
    lmNowDate = gDateValue(smNowDate)   'Format$(Now, "m/d/yy"))
    gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slDate
    lmSpfStdDate = gDateValue(slDate)
    gUnpackDate tgSpf.iBLastCalMnth(0), tgSpf.iBLastCalMnth(1), slDate
    lmSpfCalDate = gDateValue(slDate)
    gUnpackDate tgSaf(0).iBLastWeeklyDate(0), tgSaf(0).iBLastWeeklyDate(1), slDate
    lmSafWkDate = gDateValue(slDate)
    '12/15/12
    'If lmSafWkDate = gDateValue("1/1/1990") Then
    If (lmSafWkDate = gDateValue("1/1/1990")) Or (Not bmWeeklyBillExist) Then
        lmSafWkDate = 0
    End If
    smBlkVefName = "{~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~}"
    ilMultiTable = True
    'dummy = LlSetOption(hdJob, LL_OPTION_HELPAVAILABLE, False)
'VB6**    ilDummy = LlSetOption(hdJob, LL_OPTION_SORTVARIABLES, True)
'VB6**    ilDummy = LlSetOption(hdJob, LL_OPTION_ONLYONETABLE, Not ilMultiTable)
    imFirstTime = True
    hmVef = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVef, "", sgDBPath & "VEF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: VEF.Btr)", Invoice
    On Error GoTo 0
    imVefRecLen = Len(tmVef)
    
    '5-24-13 required if using vehicle as lock box address; 4th line of address is in vff
    hmVff = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVff, "", sgDBPath & "VFF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: VFF.Btr)", Invoice
    On Error GoTo 0
    imVffRecLen = Len(tmVff)
    
    hmVsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVsf, "", sgDBPath & "VSF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: VSF.Btr)", Invoice
    On Error GoTo 0
    imVsfRecLen = Len(tmVsf)
    hmVLF = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmVLF, "", sgDBPath & "VLF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: VLF.Btr)", Invoice
    On Error GoTo 0
    'ReDim tmVlf0(1 To 1) As VLF
    'ReDim tmVlf6(1 To 1) As VLF
    'ReDim tmVlf7(1 To 1) As VLF
    'imVlfRecLen = Len(tmVlf0(1))
    ReDim tmVlf0(0 To 0) As VLF
    ReDim tmVlf6(0 To 0) As VLF
    ReDim tmVlf7(0 To 0) As VLF
    imVlfRecLen = Len(tmVlf0(0))
    hmCHF = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCHF, "", sgDBPath & "Chf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: CHF.Btr)", Invoice
    On Error GoTo 0
    imCHFRecLen = Len(tmChf)
    hmClf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmClf, "", sgDBPath & "CLF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: CLF.Btr)", Invoice
    On Error GoTo 0
    imClfRecLen = Len(tmClf)
    hmCff = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCff, "", sgDBPath & "CFF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: CFF.Btr)", Invoice
    On Error GoTo 0
    imCffRecLen = Len(tmCff)
    hmCgf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCgf, "", sgDBPath & "CGF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: CGF.Btr)", Invoice
    On Error GoTo 0
    imCgfRecLen = Len(tmCgf)
    hmMsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmMsf, "", sgDBPath & "MSF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: MSF.Btr)", Invoice
    On Error GoTo 0
    imMsfRecLen = Len(tmMsf)
    hmMgf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmMgf, "", sgDBPath & "MGF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: MGF.Btr)", Invoice
    On Error GoTo 0
    imMgfRecLen = Len(tmMgf)
    hmGsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmGsf, "", sgDBPath & "GSF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: GSF.Btr)", Invoice
    On Error GoTo 0
    imGsfRecLen = Len(tmGsf)
    hmCxf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCxf, "", sgDBPath & "CXF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: CXF.Btr)", Invoice
    On Error GoTo 0
    imCxfRecLen = Len(tmCxf)
    tmCxSrchKey.lCode = tgSpf.lBCxfDisclaimer
    If tgSpf.lBCxfDisclaimer <> 0 Then
        tmCxf.sComment = ""
        imCxfRecLen = Len(tmCxf)
        ilRet = btrGetEqual(hmCxf, tmCxf, imCxfRecLen, tmCxSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If ilRet <> BTRV_ERR_NONE Then
            tmCxf.lCode = 0
            'tmCxf.iStrLen = 0
            tmCxf.sComment = ""
        End If
    Else
        tmCxf.lCode = 0
        'tmCxf.iStrLen = 0
        tmCxf.sComment = ""
    End If
    'If tmCxf.iStrLen > 0 Then
    '    smDisclaimer = Trim$(Left$(tmCxf.sComment, tmCxf.iStrLen))
    'Else
    '    smDisclaimer = ""
    'End If
    smDisclaimer = gStripChr0(tmCxf.sComment)
    imCxfRecLen = Len(tmCxf)
    hmRdf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmRdf, "", sgDBPath & "Rdf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Rdf.Btr)", Invoice
    On Error GoTo 0
    imRdfRecLen = Len(tmRdf)
    hmAdf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmAdf, "", sgDBPath & "ADF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: ADF.Btr)", Invoice
    On Error GoTo 0
    imAdfRecLen = Len(tmAdf)
    hmAgf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmAgf, "", sgDBPath & "AGF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: AGF.Btr)", Invoice
    On Error GoTo 0
    imAgfRecLen = Len(tmAgf)
    hmPnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmPnf, "", sgDBPath & "PNF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: PNF.Btr)", Invoice
    On Error GoTo 0
    imPnfRecLen = Len(tmPnf)
    
    '11-17-16
    hmPDF = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmPDF, "", sgDBPath & "PDF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: PDF.Btr)", Invoice
    On Error GoTo 0
    imPdfRecLen = Len(tmPdf)
    
    hmSlf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSlf, "", sgDBPath & "SLF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: SLF.Btr)", Invoice
    On Error GoTo 0
    imSlfRecLen = Len(tmSlf)
    hmSof = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSof, "", sgDBPath & "SOF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: SOF.Btr)", Invoice
    On Error GoTo 0
    imSofRecLen = Len(tmSof)
    hmRvf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmRvf, "", sgDBPath & "RVF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: RVF.Btr)", Invoice
    On Error GoTo 0
    imRvfRecLen = Len(tmRvf)
    hmPhf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmPhf, "", sgDBPath & "PHF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: PHF.Btr)", Invoice
    On Error GoTo 0
    hmPrf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmPrf, "", sgDBPath & "PRF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: PRF.Btr)", Invoice
    On Error GoTo 0
    imPrfRecLen = Len(tmPrf)
    hmCrf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmCrf, "", sgDBPath & "CRF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: CRF.Btr)", Invoice
    On Error GoTo 0
    imCrfRecLen = Len(tmCrf)
    hmCnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCnf, "", sgDBPath & "CNF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: CNF.Btr)", Invoice
    On Error GoTo 0
    imCnfRecLen = Len(tmCnf)
    '5/5/15: Handle multi-vehicle rotations
    hmCvf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCvf, "", sgDBPath & "CVF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: CVF.Btr)", Invoice
    On Error GoTo 0
    hmCif = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmCif, "", sgDBPath & "CIF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: CIF.Btr)", Invoice
    On Error GoTo 0
    imCifRecLen = Len(tmCif)
    hmCcf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCcf, "", sgDBPath & "CCF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: CCF.Btr)", Invoice
    On Error GoTo 0
    imCcfRecLen = Len(tmCcf)
    hmCpf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmCpf, "", sgDBPath & "CPF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: CPF.Btr)", Invoice
    On Error GoTo 0
    imCpfRecLen = Len(tmCpf)
    hmTzf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmTzf, "", sgDBPath & "TZF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: TZF.Btr)", Invoice
    On Error GoTo 0
    imTzfRecLen = Len(tmTzf)
    hmMnf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmMnf, "", sgDBPath & "MNF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: MNF.Btr)", Invoice
    On Error GoTo 0
    imMnfRecLen = Len(tmMnf)
    hmArf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmArf, "", sgDBPath & "ARF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: ARF.Btr)", Invoice
    On Error GoTo 0
    imArfRecLen = Len(tmArf)
    hmSmf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmSmf, "", sgDBPath & "SMF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: SMF.Btr)", Invoice
    On Error GoTo 0
    imSmfRecLen = Len(tmSmf)
    hmPsf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmPsf, "", sgDBPath & "PSF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: PSF.Btr)", Invoice
    On Error GoTo 0
    imPsfRecLen = Len(tmPsf)
    hmSdf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmSdf, "", sgDBPath & "SDF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: SDF.Btr)", Invoice
    On Error GoTo 0
    imSdfRecLen = Len(tmSdf)
    hmSsf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSsf, "", sgDBPath & "SSF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: SSF.Btr)", Invoice
    On Error GoTo 0
    hmLcf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmLcf, "", sgDBPath & "LCF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: LCF.Btr)", Invoice
    On Error GoTo 0
    hmLef = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmLef, "", sgDBPath & "LEF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: LEF.Btr)", Invoice
    On Error GoTo 0
    imLefRecLen = Len(tmLef)
        
        '3-23-12    Need lvf for game length
    hmLvf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmLvf, "", sgDBPath & "LVF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: LVF.Btr)", Invoice
    On Error GoTo 0
    imLvfRecLen = Len(tmLvf)

    hmIsr = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmIsr, "", sgDBPath & "ISR.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: ISR.Btr)", Invoice
    On Error GoTo 0
    imIsrRecLen = Len(tmIsr)
    hmIvr = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmIvr, "", sgDBPath & "IVR.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: IVR.Btr)", Invoice
    On Error GoTo 0
    imIvrRecLen = Len(tmIvr)
    hmImr = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmImr, "", sgDBPath & "IMR.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: IMR.Btr)", Invoice
    On Error GoTo 0
    imImrRecLen = Len(tmImr)

    hmSbf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmSbf, "", sgDBPath & "Sbf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Sbf.Btr)", Invoice
    On Error GoTo 0
    imSbfRecLen = Len(tmSbf)

    hmSbfVehCheck = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmSbfVehCheck, "", sgDBPath & "Sbf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Sbf.Btr)", Invoice
    On Error GoTo 0

    hmPcf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmPcf, "", sgDBPath & "Pcf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Pcf.Btr)", Invoice
    On Error GoTo 0
    imPcfRecLen = Len(tmPcf)

    hmPcfVehCheck = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmPcfVehCheck, "", sgDBPath & "Pcf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Pcf.Btr)", Invoice
    On Error GoTo 0

    hmIbf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmIbf, "", sgDBPath & "Ibf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Ibf.Btr)", Invoice
    On Error GoTo 0
    imIbfRecLen = Len(tmIbf)

    hmRlf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmRlf, "", sgDBPath & "Rlf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Rlf.Btr)", Invoice
    On Error GoTo 0

    If ((Asc(tgSpf.sAutoType2) And RN_NET) = RN_NET) Then
        hmGif = CBtrvTable(TWOHANDLES) 'CBtrvObj()
        ilRet = btrOpen(hmGif, "", sgDBPath & "Gif.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        On Error GoTo mInitErr
        gBtrvErrorMsg ilRet, "mInit (btrOpen: Gif.Btr)", Invoice
        On Error GoTo 0
        imGifRecLen = Len(tmGif)
        hmCef = CBtrvTable(TWOHANDLES) 'CBtrvObj()
        ilRet = btrOpen(hmCef, "", sgDBPath & "Cef.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        On Error GoTo mInitErr
        gBtrvErrorMsg ilRet, "mInit (btrOpen: Cef.Btr)", Invoice
        On Error GoTo 0
        imCefRecLen = Len(tmCef)
    End If


    hmEff = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmEff, "", sgDBPath & "Eff.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Eff.Btr)", Invoice
    On Error GoTo 0
    imEffRecLen = Len(tmEff)
    
    hmRhf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmRhf, "", sgDBPath & "Rhf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Rhf.Btr)", Invoice
    On Error GoTo 0
    imRhfRecLen = Len(tmRhf)



    hmUaf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmUaf, "", sgDBPath & "Uaf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Uaf.Btr)", Invoice
    On Error GoTo 0
    imUafRecLen = Len(tmUaf)

    hmUrf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmUrf, "", sgDBPath & "Urf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Urf.Btr)", Invoice
    On Error GoTo 0
    imUrfRecLen = Len(tmUrf)

    'Sales Source
    slStr = ""
    'ReDim tgSSMnf(1 To 1) As MNF
    ReDim tgSSMnf(0 To 0) As MNF
    ilRet = gObtainMnfForType("S", slStr, tgSSMnf())
    imGenCntrExport = False
    For ilLoop = LBound(tgSSMnf) To UBound(tgSSMnf) - 1 Step 1
        If (Trim$(tgSSMnf(ilLoop).sUnitType) = "E") Or (Trim$(tgSSMnf(ilLoop).sUnitType) = "F") Then
            imGenCntrExport = True
            Exit For
        End If
    Next ilLoop
    imChkHistory = False
    For ilLoop = LBound(tgSSMnf) To UBound(tgSSMnf) - 1 Step 1
        If (Trim$(tgSSMnf(ilLoop).sUnitType) = "N") Or (Trim$(tgSSMnf(ilLoop).sUnitType) = "E") Then
            imChkHistory = True
            Exit For
        End If
    Next ilLoop

    hmPif = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmPif, "", sgDBPath & "PIF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: PIF.Btr)", Invoice
    On Error GoTo 0

    hmIihf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmIihf, "", sgDBPath & "Iihf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Iihf.Btr)", Invoice
    On Error GoTo 0
    imIihfRecLen = Len(tmIihf)

    hmApf = CBtrvTable(TWOHANDLES) 'CBtrvObj()
    ilRet = btrOpen(hmApf, "", sgDBPath & "Apf.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    On Error GoTo mInitErr
    gBtrvErrorMsg ilRet, "mInit (btrOpen: Apf.Btr)", Invoice
    On Error GoTo 0
    imApfRecLen = Len(tmApf)

    'Missed Reason
    slStr = ""
    'ReDim tgMRMnf(1 To 1) As MNF
    ReDim tgMRMnf(0 To 0) As MNF
    ilRet = gObtainMnfForType("M", slStr, tgMRMnf())
    'Missed Reason
    slStr = ""
    'ReDim tgNTRMnf(1 To 1) As MNF
    ReDim tgNTRMnf(0 To 0) As MNF
    ilRet = gObtainMnfForType("I", slStr, tgNTRMnf())
    'Teams
    smTeamTag = ""
    ilRet = gObtainMnfForType("Z", smTeamTag, tmTeam())
    Randomize   'Remove this if same results are to be obtained
    ReDim tgInvVehCode(0 To 0) As VEHSORT
    imLcfRecLen = Len(tmLcf)
    lbcVehicle.Clear
    'mVehPop
    'If imTerminate Then
    '    Exit Sub
    'End If
    ilRet = gObtainRdf(sgMRdfStamp, tgMRdf())
    ilRet = gObtainVef()
    If Not imChkHistory Then
        For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
            For ilLoop = 1 To 8 Step 1
                If (Trim$(tgMVef(ilVeh).sExtUpdateRvf(ilLoop - 1)) = "N") Then
                    imChkHistory = True
                    Exit For
                End If
                If (Trim$(tgMVef(ilVeh).sUpdateRVF(ilLoop - 1)) = "N") Or (Trim$(tgMVef(ilVeh).sUpdateRVF(ilLoop - 1)) = "E") Then
                    imChkHistory = True
                    Exit For
                End If
            Next ilLoop
            If imChkHistory Then
                Exit For
            End If
        Next ilVeh
    End If
    gObtainVirtVehList

    ilRet = gObtainAdvt()
    ilRet = gObtainAgency()

    ilRet = gObtainSalesperson()

    ilRet = gVffRead()
    smPostLogSource = ""
    'If (Asc(tgSaf(0).sFeatures3) And REQSTATIONPOSTING) = REQSTATIONPOSTING Then 'Require to Post spot prior to invoicing
        For ilVff = LBound(tgVff) To UBound(tgVff) Step 1
            If tgVff(ilVff).sPostLogSource = "S" Then
                rbcCntr(INVCNTR_Posted).Visible = True
                If (Asc(tgSaf(0).sFeatures3) And REQSTATIONPOSTING) = REQSTATIONPOSTING Then 'Require to Post spot prior to invoicing
                    smPostLogSource = tgVff(ilVff).sPostLogSource
                Else
                    smPostLogSource = "T" 'Test non-hidden lines
                End If
                Exit For
            End If
        Next ilVff
    'End If
    smSvPostLogSource = smPostLogSource
    
    'Moved to end of this routine
    'tmcStart.Enabled = True

    'ckcType(INVTYPE_Commercial).Visible = False
    'For ilLoop = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
    '    If (tgMVef(ilLoop).sType = "C") Or (tgMVef(ilLoop).sType = "S") Then
    '        ckcType(INVTYPE_Commercial).Visible = True
    '        Exit For
    '    End If
    'Next ilLoop
    'If ckcType(INVTYPE_Commercial).Visible = False Then
    '    ckcType(INVTYPE_GenRepAR).Move ckcType(INVTYPE_Commercial).Left, ckcType(INVTYPE_Commercial).Top
    '    lbcVehicle.Visible = False
    '    lbcCntr.Visible = False
    '    ckcAll.Visible = False
    '    plcCntr.Visible = False
    '    rbcType(INVGEN_Preliminary).Enabled = False
    '    ckcShowPrel.Enabled = False
    '    'If rbcType(INVGEN_Aff).Visible = True Then
    '    If (tgSpf.sBLaserForm = "2") And (Trim$(tgUrf(0).sName) = sgCPName) Then
    '        rbcType(INVGEN_Aff).Enabled = False
    '    End If
    'End If
    'If ckcType(INVTYPE_Installment).Visible = False Then
    '    ckcType(INVTYPE_NTR).Move ckcType(INVTYPE_Installment).Left, ckcType(INVTYPE_Installment).Top
    'End If
    ''Market Processing
    'mMarketPop
    'gAnyRepDef
    'gAnyClustersDef
    'If (UBound(igRepVefCode) > 0) Or (UBound(igMktVefCode) > 0) Then
    '    ckcType(INVTYPE_PrintRep).Visible = True
    '    ckcType(INVTYPE_PrintRep).Value = vbUnchecked
    '    ckcType(INVTYPE_GenRepAR).Visible = True
    '    ckcType(INVTYPE_GenRepAR).Value = vbUnchecked
    'Else
    '    ckcType(INVTYPE_PrintRep).Visible = False
    '    ckcType(INVTYPE_PrintRep).Value = vbUnchecked
    '    ckcType(INVTYPE_GenRepAR).Visible = False
    '    ckcType(INVTYPE_GenRepAR).Value = vbUnchecked
    '    If ckcType(INVTYPE_Installment).Visible = True Then
    '        ckcType(INVTYPE_NTR).Move ckcType(INVTYPE_Commercial).Left, ckcType(INVTYPE_Installment).Top
    '        ckcType(INVTYPE_Installment).Move ckcType(INVTYPE_Commercial).Left, ckcType(INVTYPE_PrintRep).Top
    '    Else
    '        ckcType(INVTYPE_NTR).Move ckcType(INVTYPE_Commercial).Left, ckcType(INVTYPE_PrintRep).Top
    '    End If
    'End If
    
    'TTP 10813 - PDF invoice - selective invoice feature checklist
    grdAirTime.Left = 2560
    grdAirTime.Width = 9520
    
    imVirtBillMethod = 3    'Show spot and prices for first vehicle only
    smStartStd = ""
    smEndStd = ""
    smStartCal = ""
    smEndCal = ""
    lmStartStd = 0
    lmEndStd = 0
    lmStartCal = 0
    lmEndCal = 0
    imBypassVehSelect = False
    imBypassAll = False
    imGenInv = False

    lmUndoInvDate = 0
    lmUndoInvWeek = 0
    ReDim tmRPSelInfo(0 To 0) As RPSELINFO

    'edcUpdating.Move 2730, 2055
    edcUpdating.Move (Invoice.Width - edcUpdating.Width) / 2, plcFromLine.Top + (plcFromLine.Height - edcUpdating.Height) / 2
    plcUnbilled.Move (Invoice.Width - plcUnbilled.Width) / 2, plcFromLine.Top + (plcFromLine.Height - plcUnbilled.Height) / 2
    frcReprint.Move (Invoice.Width - frcReprint.Width) / 2, plcFromLine.Top + (plcFromLine.Height - frcReprint.Height) / 2
    plcInvSpotTimeZone.Move frcBilling.Left, frcBilling.Top + frcBilling.Height - plcInvSpotTimeZone.Height
   'Select all vehicles
    'ckcAll.Value = True
    
    bmCalCntrExist = False
    '12/15/12
    'If ((Asc(tgSpf.sOptionFields) And OFCALENDARBILL) <> OFCALENDARBILL) Then
    '    '8/20/12: Allow Calendar billing if contract previously set as Calendar
    '    'ckcBillCycle(INVBILLCYCLE_Calendar).Enabled = False
    '    'lacCal.Enabled = False
    '    If Not gChrRefExist(Invoice, "C", "Chf.Btr", "chfBillCycle", False) Then
    '        ckcBillCycle(INVBILLCYCLE_Calendar).Enabled = False
    '        lacCal.Enabled = False
    '    Else
    '        bmCalCntrExist = True
    '    End If
    'End If
    bmCalBillExist = False
    If ((Asc(tgSpf.sOptionFields) And OFCALENDARBILL) <> OFCALENDARBILL) Then
        '8/20/12: Allow Calendar billing if contract previously set as Calendar
        'ckcBillCycle(INVBILLCYCLE_Calendar).Enabled = False
        'lacCal.Enabled = False
        If Not gChrRefExist(Invoice, "C", "Chf.Btr", "chfBillCycle", False) Then
            ckcBillCycle(INVBILLCYCLE_Calendar).Enabled = False
            lacCal.Enabled = False
            bmCalBillExist = False
        Else
            bmCalCntrExist = True
            bmCalBillExist = True
        End If
    Else
        bmCalBillExist = True
    End If
    If Not bmCalBillExist Then
        lmSpfCalDate = 0
    End If

    '12/15/12
    'If ((Asc(tgSpf.sUsingFeatures9) And WEEKLYBILL) <> WEEKLYBILL) Then
    If Not bmWeeklyBillExist Then
        ckcBillCycle(INVBILLCYCLE_Week).Enabled = False
        lacWeekly.Enabled = False
        'lbcWeek.Visible = False
        cbcWeek.Visible = False
        lacWeek.Visible = False
        'grdRevenue.Width = grdRevenue.Left + grdRevenue.Width - lbcWeek.Left
        'grdRevenue.Width = grdRevenue.Left + grdRevenue.Width - cbcWeek.Left
        'grdRevenue.Left = lbcWeek.Left
    End If
    'Dan M 9-25-09 adjust look of 'wait' message
    gAdjustScreenMessage Me, pbcPrinting
    lmLastClickedRow = -1
    lmScrollTop = grdAirTime.FixedRows
    imLastAirTimeColSorted = -1
    imLastAirTimeSort = -1
    
    ReDim smEDIRecords(0 To 0) As String
    ReDim smEDIByVehSort(0 To 0) As SORTCODE
    
    mSetGridColumns
    mSetGridTitles
    mClearAirTimeGrid
    lmScrollTop = grdRevenue.FixedRows
    imLastRevenueColSorted = -1
    imLastRevenueSort = -1
    mClearRevenueGrid
    
    If (Asc(tgSpf.sUsingFeatures9) And PRINTEDI) = PRINTEDI Then
        ckcIncludeEDI.Value = vbChecked
    Else
        ckcIncludeEDI.Value = vbUnchecked
    End If
    
    imXMidHandle = 0    '1
    '10/5/14: Handle spots crossing midnight
    If (tgSpf.sAEDII = "Y") Then    'EDI Service
        If (tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") Then
            If tgSaf(0).sXMidSpotsBill = "A" Then
                imXMidHandle = 2
            Else
                imXMidHandle = 1
            End If
        End If
    End If
    bmAddXMidMessage = False
    smXMidMsgReconc = "Aired Past Mid"
    smXMidMsgBottom = smXMidMsgReconc & "- spots scheduled to air on the last day of the billing month but which air past midnight, technically aired on the following day"
    
    tmcStart.Enabled = True
    
    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    '10016
    bgPDFEmailTestMode = False
    If bgInternalGuide Then
        mnuTools.Visible = True
        Invoice.Height = Invoice.Height + 200
        '10530
        mnuTestPDFEmail.Checked = True
        bgPDFEmailTestMode = True
    End If
    
    imPDFEmailArf = mGetPDFEmailArfCode
    'Invoice.Height = cmcCancel.Top + 5 * cmcCancel.Height / 3
    'gCenterStdAlone Invoice
    'made part of tmcStart
    'Screen.MousePointer = vbDefault
    
    Exit Sub
mInitErr:
    On Error GoTo 0
    imTerminate = True
    Screen.MousePointer = vbDefault
    gSetMousePointer grdAirTime, grdRevenue, vbDefault
    Exit Sub
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mInitEDI                        *
'*                                                     *
'*             Created:3/01/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Initialize EDI File            *
'*                      Code removed from mInvoiceRpt  *
'*                      to make room                   *
'*                                                     *
'*******************************************************
Private Function mInitEDI(ilSource As Integer) As Integer
'
'ilSource(I): 0=Air time; 1=Rep
'
    Dim slNowDate As String
    Dim slFYear As String
    Dim slFMonth As String
    Dim slFDay As String
    Dim slLetter As String
    Dim slEDIFileName As String
    Dim slDateTime As String
    Dim ilRet As Integer
    Dim ilEDI As Integer
    Dim slExportPath As String
    Dim fs As New FileSystemObject
    
    If (tgSpf.sAEDII = "Y") Then    'EDI Service
        If rbcType(INVGEN_Final).Value Then    'Final invoices
            slNowDate = smNowDate   'Format$(Now, "m/d/yy")
            gObtainYearMonthDayStr slNowDate, True, slFYear, slFMonth, slFDay
            If ilSource = 0 Then
                slEDIFileName = "Inv-" & right$(slFYear, 2) & slFMonth & slFDay
            Else
                slEDIFileName = "Rep-" & right$(slFYear, 2) & slFMonth & slFDay
            End If
            'slLetter = "A"
            'Do
            '    ilRet = 0
            '    On Error GoTo mInitEDIErr:
            '    smEDIFile = slEDIFileName & slLetter & ".EDI"
            '    slDateTime = FileDateTime(sgExportPath & smEDIFile)
            '    If ilRet = 0 Then
            '        slLetter = Chr(Asc(slLetter) + 1)
            '    End If
            'Loop While ilRet = 0
        Else
            If ilSource = 0 Then
                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value Then        '11-15-16 reprint or archive
                    slEDIFileName = "RePRT"
                Else
                    slEDIFileName = "PrelTest"  'Preliminary invoices
                End If
            Else
                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value Then            '11-15-16 reprint or archive
                    slEDIFileName = "Rep-RePRT"
                Else
                    slEDIFileName = "Rep-PrelTest"  'Preliminary invoices
                End If
            End If
            slLetter = ""
        End If
        'On Error GoTo 0
        'smEDIFile = sgExportPath & slEDIFileName & slLetter & ".EDI" 'slToFile
        'ilRet = 0
        'On Error GoTo mInitEDIErr:
        'hmEDI = FreeFile
        ''Open smEDIFile For Output As hmEDI
        'Open smEDIFile For Output Lock Write As hmEDI
        'If ilRet <> 0 Then
        '    MsgBox "Open " & smEDIFile & ", Error #" & str$(ilRet), vbOkOnly + vbCritical + vbApplicationModal, "Open Error"
        '    'edcTo.SetFocus
        '    mInitEDI = False
        '    Exit Function
        'End If
        'On Error GoTo 0
        For ilEDI = 0 To UBound(tgEDIServiceInfo) - 1 Step 1
            'If Trim$(tgEDIServiceInfo(ilEDI).tArf.sID) <> "PDF EMail" Then         'create all EDI defined folders
                slExportPath = sgExportPath & Trim$(tgEDIServiceInfo(ilEDI).tArf.sID)
                '3/23/12: \ must be removed for FolderExists
                If right(slExportPath, 1) = "\" Then
                    slExportPath = Left$(slExportPath, Len(slExportPath) - 1)
                End If
                If Not fs.FolderExists(slExportPath) Then
                    fs.CreateFolder (slExportPath)
                    If Not fs.FolderExists(slExportPath) Then
                        slExportPath = sgExportPath
                    End If
                End If
                If right(slExportPath, 1) = "\" Then
                    slExportPath = Left$(slExportPath, Len(slExportPath) - 1)
                End If
                If rbcType(INVGEN_Final).Value Then    'Final invoices
                    slLetter = "A"
                    Do
                        ilRet = 0
                        'On Error GoTo mInitEDIErr:
                        '3/23/12:
                        'smEDIFile = slEDIFileName & slLetter & ".EDI"
                        'slDateTime = FileDateTime(slExportPath & smEDIFile)
                        If UBound(tgEDIServiceInfo) > 1 Then
                            smEDIFile = slExportPath & "\" & Trim$(tgEDIServiceInfo(ilEDI).tArf.sID) & "-" & slEDIFileName & slLetter & ".EDI"    'slToFile
                        Else
                            smEDIFile = slExportPath & "\" & slEDIFileName & slLetter & ".EDI"   'slToFile
                        End If
                        'slDateTime = FileDateTime(smEDIFile)
                        ilRet = gFileExist(smEDIFile)
                        If ilRet = 0 Then
                            slLetter = Chr(Asc(slLetter) + 1)
                        End If
                    Loop While ilRet = 0
                End If
                On Error GoTo 0
                If UBound(tgEDIServiceInfo) > 1 Then
                    smEDIFile = slExportPath & "\" & Trim$(tgEDIServiceInfo(ilEDI).tArf.sID) & "-" & slEDIFileName & slLetter & ".EDI"    'slToFile
                Else
                    '3/23/12: Missing backslash
                    'smEDIFile = slExportPath & slEDIFileName & slLetter & ".EDI" 'slToFile
                    smEDIFile = slExportPath & "\" & slEDIFileName & slLetter & ".EDI"   'slToFile
                End If
                ilRet = 0
                'On Error GoTo mInitEDIErr:
                'hmEDI = FreeFile
                ''Open smEDIFile For Output As hmEDI
                'Open smEDIFile For Output Lock Write As hmEDI
                ilRet = gFileOpen(smEDIFile, "Output Lock Write", hmEDI)
                If ilRet <> 0 Then
                    MsgBox "Open " & smEDIFile & ", Error #" & str$(ilRet), vbOKOnly + vbCritical + vbApplicationModal, "Open Error"
                    'edcTo.SetFocus
                    mInitEDI = False
                    Exit Function
                End If
                tgEDIServiceInfo(ilEDI).hEDI = hmEDI
                tgEDIServiceInfo(ilEDI).sPathFile = smEDIFile
                tgEDIServiceInfo(ilEDI).sUsed = "N"
            'End If
        Next ilEDI
        On Error GoTo 0
    End If
    mInitEDI = True
    Exit Function
'mInitEDIErr:
'    ilRet = Err.Number
'    Resume Next
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mInitInv                        *
'*                                                     *
'*             Created:3/01/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Initialize Invoice start       *
'*                      Code removed from mInvoiceRpt  *
'*                      to make room                   *
'*                                                     *
'*******************************************************
Private Sub mInitInv(ilImpactPrt As Integer, slStdSDate As String, slStdEDate As String, slCalSDate As String, slCalEDate As String, slWkSDate As String, slWkEDate As String, slCBMonth As String, slSBMonth As String, slWBMonth As String, slSInvDate As String, slCInvDate As String, slWInvDate As String)
    Dim ilLoop As Integer
    Dim ilIndex As Integer
    Dim ilUpper As Integer
    Dim ilFound As Integer
    Dim slTest As String

    ReDim tgRvf(0 To 0) As RVF
    ReDim tgRvfByVef(0 To 0) As RVFVEF
    imCHFRecLen = Len(tgChfInv)
    ReDim tgClfInv(0 To 0) As CLFLIST
    tgClfInv(0).iStatus = -1 'Not Used
    tgClfInv(0).lRecPos = 0
    tgClfInv(0).iFirstCff = -1
    ReDim tgCffInv(0 To 0) As CFFLIST
    tgCffInv(0).iStatus = -1 'Not Used
    tgCffInv(0).lRecPos = 0
    tgCffInv(0).iNextCff = -1
    tmAdf.iCode = 0
    tmVef.iCode = 0
    'define variables for the load check (yes, L&L now checks the definition file!)

    '10-31-01 No difference with type of invoice, comment out check for type of invoice form
    'If (rbcPrtType(0).Value) And ((tgSpf.sBLaserForm = "2") Or (tgSpf.sBLaserForm = "3")) Then
    'Else
    '    If ilImpactPrt Then
    '        gInvoice False
    '    Else
    '        gInvoice True
    '    End If
    'End If
    'Moved to cmcGenerate_Click because of other billing types
    'If (Not rbcType(INVGEN_Reprint).Value) And (Not rbcType(INVGEN_Aff).Value) Then
    '    llInvoiceNo = tgSpf.lBNextNo
    '    If llInvoiceNo < tgSpf.lBLowestNo Then
    '        llInvoiceNo = tgSpf.lBLowestNo
    '    End If
    '    If llInvoiceNo > tgSpf.lBHighestNo Then
    '        llInvoiceNo = tgSpf.lBLowestNo
    '    End If
    'End If
    'Initiate EDI file
    slStdSDate = Format$(gDateValue(smStartStd), "yymmdd")
    slStdEDate = Format$(gDateValue(smEndStd), "yymmdd")
    slCalSDate = Format$(gDateValue(smStartCal), "yymmdd")
    slCalEDate = Format$(gDateValue(smEndCal), "yymmdd")
    slWkSDate = Format$(gDateValue(smStartWk), "yymmdd")
    slWkEDate = Format$(gDateValue(smEndWk), "yymmdd")
    slCBMonth = Format$(gDateValue(gObtainEndStd(smEndCal)), "yymm")
    slSBMonth = Format$(gDateValue(smEndStd), "yymm")
    slWBMonth = Format$(gDateValue(smEndWk), "yymm")
    slSInvDate = Format$(gDateValue(smEndStd), "yymmdd")
    slCInvDate = Format$(gDateValue(smEndCal), "yymmdd")
    slWInvDate = Format$(gDateValue(smEndWk), "yymmdd")
    ''Resort vehicles to get package mix into other vehicles
    ''the code in mInvoiceRpt must be changed to cycle thru lines
    ''and test if vehicle selected- removing the loop on vehicles
    'lbcResortVefCode.Clear
    'For ilLoop = 0 To UBound(tgInvVehCode) - 1 Step 1
    '    If (tgInvVehCode(ilLoop) <> smBlkVefName & "\-1") Then
    '        lbcResortVefCode.AddItem tgInvVehCode(ilLoop)
    '    End If
    'Next ilLoop
    'For ilLoop = 0 To lbcResortVefCode.ListCount - 1 Step 1
    '    tgInvVehCode(ilLoop) = lbcResortVefCode.List(ilLoop)
    'Next ilLoop
    slTest = smBlkVefName & "\-1"
    ilLoop = 0
    Do
        If StrComp(Trim$(tgInvVehCode(ilLoop).sKey), slTest, 1) = 0 Then
            For ilIndex = ilLoop To UBound(tgInvVehCode) - 2 Step 1
                tgInvVehCode(ilIndex) = tgInvVehCode(ilIndex + 1)
            Next ilIndex
            ReDim Preserve tgInvVehCode(0 To UBound(tgInvVehCode) - 1) As VEHSORT
        Else
            ilLoop = ilLoop + 1
        End If
    Loop While ilLoop < UBound(tgInvVehCode)
    ilUpper = UBound(tgInvVehCode)
    If ilUpper > 0 Then
        ArraySortTyp fnAV(tgInvVehCode(), 0), ilUpper, 0, LenB(tgInvVehCode(0)), 0, LenB(tgInvVehCode(0).sKey), 0
    End If
    'Test if Bonus vehicle name should be added to vehicles selected
    ilFound = False
    For ilLoop = 0 To UBound(tgInvVehCode) - 1 Step 1
        'If (tgInvVehCode(ilLoop) = smBlkVefName & "\-1") Then
        If StrComp(Trim$(tgInvVehCode(ilLoop).sKey), slTest, 1) = 0 Then
            ilFound = True
            Exit For
        End If
    Next ilLoop
    If Not ilFound Then
        tgInvVehCode(UBound(tgInvVehCode)).sKey = smBlkVefName & "\-1"
        tgInvVehCode(UBound(tgInvVehCode)).iCode = -1
        ReDim Preserve tgInvVehCode(0 To UBound(tgInvVehCode) + 1) As VEHSORT
    End If
    
    ReDim tgInvPDF_Info(0 To 0) As INVPDF_INFO      '7-12-16 init array of unique agy or direct adv codes to filter for pdf export
    
    tmIvr.lSpotKeyNo = 0
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mInvoiceRpt                     *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Generate Invoice report        *
'*                                                     *
'*******************************************************
Private Sub mInvoiceRpt(ilPreview As Integer, slName As String, ilUrfCode As Integer, ilImpactPrt As Integer, llInvoiceNo As Long)
    Dim ilErrorFlag As Integer
    Dim llRecNo As Long
    Dim llRecsRemaining As Long
    'Dim slError As String
    Dim ilDBEof As Integer
    'Dim ilLLRet As Integer
    Dim ilRet As Integer
    Dim slStr As String
    Dim llDate As Long
    'Dim llSDate As Long
    'Dim llStartDate As Long
    'Dim llEndDate As Long
    Dim slDate As String
    Dim slTime As String
    Dim slStartTime As String
    Dim slEndTime As String
    'Dim llStartTime As Long
    'Dim llEndTime As Long
    Dim llTime As Long
    'Dim ilCntrIndex As Integer
    'Dim slLineNoStr As String
    'Dim ilDispOnly As Integer
    Dim ilHeaderInit As Integer
    Dim ilLineInit As Integer
    'Dim ilLbcIndex As Integer
    Dim llSdfIndex As Long
    Dim ilShowSpot As Integer
    Dim ilLineEOF As Integer
    Dim ilClf As Integer
    Dim slNameCode As String
    Dim slCode As String
    Dim ilCff As Integer
    Dim ilDay As Integer
    Dim ilSpotsPerWk As Integer
    Dim slSFlightDate As String
    Dim slEFlightDate As String
    Dim ilLoop As Integer
    Dim llLoop As Long
    Dim ilNewPage As Integer
    'Dim ilNoOrderedRows As Integer
    'Dim llNoAiredRows As Long
    'Dim ilNoReconcRows As Integer
    'Dim ilNoOrderedRowsPrt As Integer
    'Dim llNoAiredRowsPrt As Integer
    'Dim ilNoReconcRowsPrt As Integer
    'Dim ilNoRowsToPrt As Integer
    'Dim ilNoTimes As Integer
    'Dim ilNoFlights As Integer
    'Dim ilMaxRowPerPage As Integer
    'Dim ilRowRemainingPerPage As Integer
    'Dim ilNoLinesPerPage As Integer
    'Dim ilNoTotalLines As Integer
    Dim llStartSortIndex As Long
    Dim llEndSortIndex As Long
    Dim ilVeh As Integer
    Dim ilIncludeFlight As Integer
    Dim slAiredPrice As String
    Dim llFlightStartDate As Long
    'Dim llInvoiceNo As Long
    Dim ilShowTotals As Integer
    Dim slTotalNoPerWk As String
    Dim slTotalRate As String
    Dim slTotalAirCount As String
    Dim slTotalAirRate As String
    Dim slAgyRate As String
    Dim slAgyComm As String
    Dim slTotalNet As String
    Dim slTotalMissedRate As String
    Dim slTotalMissedRateNonPkg As String    'Missed rate not including any missed from package and hidden
    Dim slGTOrdered As String
    Dim slGTReconc As String
    Dim slGTAired As String
    Dim slGTNet As String
    Dim slGTComm As String
    Dim slTGNoSpots As String
    Dim ilUpdateIndex As Integer
    Dim slPctTrade As String
    Dim slProduct As String
    Dim ilFound As Integer
    Dim ilZone As Integer
    Dim ilShowISCI As Integer
    'ReDim slCopyProduct(1 To 6) As String
    ReDim slCopyProduct(0 To 6) As String   'Index zero ignored
    'ReDim slCopy(1 To 6) As String  'Zone plus ISCI
    ReDim slCopy(0 To 6) As String  'Zone plus ISCI. Index zero ignored
    Dim ilEDIUpper As Integer
    Dim slSBMonth As String
    Dim slCBMonth As String
    Dim slWBMonth As String
    Dim slStdSDate As String
    Dim slStdEDate As String
    Dim slCalSDate As String
    Dim slCalEDate As String
    Dim slWkSDate As String
    Dim slWkEDate As String
    Dim slCInvDate As String
    Dim slSInvDate As String
    Dim slWInvDate As String
    Dim slStrTime As String
    Dim ilEDIFlag As Integer
    Dim slEDIDays As String
    Dim slEDISTime As String
    Dim slEDIETime As String
    Dim slEDIRate As String     'Value without decimal point
    Dim ilEDINoOrderedSpots As Integer
    Dim ilEDIFirstLineIndex As Integer
    Dim ilEDIDay As Integer
    Dim slEDIAirDate As String
    Dim slEDIAirTime As String
    Dim ilPos As Integer
    Dim ilCopyIndex As Integer
    Dim ilEDIVefCode As Integer     'Vehicle for which EDI is being generated
    Dim slEDITotalRate As String    'EDI Ordered total (by Vehicle)
    Dim slEDITotalAirRate As String 'EDI Aired Total (by Vehicle)
    Dim slEDITotalNet As String     'EDI Net Aired Total (by Vehicle)
    Dim slEDIAirRate As String      'EDI Spot Rate
    Dim slEDITotalAired As String   'EDI Grand Total of Dollars Aired
    Dim ilEDITotalNoInv As Integer  'EDI Grand Total of invoices generated
    Dim slEDILnStartDate As String
    Dim slEDILnEndDate As String
    Dim slEDIMGDate As String
    Dim slEDIMGTime As String
    Dim slEDIMissedDate As String
    Dim slEDIMissedTime As String
    Dim ilVehSubTotal As Integer
    Dim ilLastVeh As Integer
    Dim ilLastClf As Integer
    Dim slTotalVirtVehRate As String
    Dim slVirtVehRate As String
    Dim ilRemVirtSpotRate As Integer
    Dim ilShowSpots As Integer
    Dim ilShowBottomMsg As Integer
    Dim ilShowTradeMsg As Integer
    Dim ilWkIndex As Integer
    Dim slOrderedPrice As String
    Dim ilLine As Integer
    Dim ilVsf As Integer
    Dim ilRdf As Integer
    Dim ilPass As Integer '1=Cash Pass; 2=Trade Pass
    Dim ilStartPass As Integer
    Dim ilEndPass As Integer
    Dim ilMGVehShown As Integer
    'Retain previous spot information so spots at same time can be adjust
    Dim ilPrevVeh As Integer    'Previous spot vehicle code
    Dim llPrevDate As Long  'Previous spot date
    Dim llPrevTime As Long  'Previous spot time
    Dim ilPrevLen As Integer    'Running spot length of previous spots at same time
    Dim ilTimeProb As Integer
    Dim ilVpfIndex As Integer
    Dim slShowTime As String
    'Dim ilSOrderTimeIndex As Integer
    'Dim ilEOrderTimeIndex As Integer
    Dim llCntrNo As Long
    Dim llPrevCntrNo As Long
    Dim ilAnyOutput As Integer  'True=Output; False=No Output (separate invoices by advertiser and Hide lines only)
    Dim ilAnyIvr As Integer 'True=Ivr spots written, False=No ivr spots created (create extra spot one so report works)
    Dim ilBonusSpot As Integer  'True if bonus spot
    Dim ilFirstBonus As Integer
    Dim slFlightPrice As String
    Dim llSpotDate As Long
    Dim llSvSpotDate As Long
    Dim slSvSchStatus As String
    Dim ilIndex As Integer
    Dim ilContinue As Integer
    Dim ilOrigGameNo As Integer
    Dim ilGameNoForWkNo As Integer
    Dim slStr1 As String
    Dim ilEDI As Integer
    Dim blAddComment52 As Boolean
    Dim llSDFDate As Long
    Dim ilVefCode As Integer
    Dim slDPAirTime As String
    Dim ilDoe As Integer
    
    'ReDim slFields(1 To 11) As String
    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    smExportCntrName = ""
    mInitInv ilImpactPrt, slStdSDate, slStdEDate, slCalSDate, slCalEDate, slWkSDate, slWkEDate, slCBMonth, slSBMonth, slWBMonth, slSInvDate, slCInvDate, slWInvDate
    If Not mInitEDI(0) Then
        Exit Sub
    End If
    smFileName = sgRptPath & slName & Chr$(0)

    If Not mOpenExportCntrFile() Then
        Exit Sub
    End If

    'initiate printing

    '10-31-01 force to always use crystal so all other code works
    'If (rbcPrtType(0).Value) And ((tgSpf.sBLaserForm = "2") Or (tgSpf.sBLaserForm = "3")) Then
        imUsingCrystal = True
    'Else
    '    imUsingCrystal = False
    '    slLangText = "Printing..."
    '    If ilPreview <> 0 Then
'VB6**      ilLLRet = LlPrintWithBoxStart(hdJob, LL_PROJECT_LIST, smFileName, LL_PRINT_PREVIEW, LL_BOXTYPE_BRIDGEMETER, Invoice.hWnd, slLangText)
'VB6**      ilDummy = LlPreviewSetTempPath(hdJob, sgRptSavePath)
'VB6**      ilDummy = LlPreviewSetResolution(hdJob, 200)
     '   Else
'VB6**      ilLLRet = LlPrintWithBoxStart(hdJob, LL_PROJECT_LIST, smFileName, LL_PRINT_NORMAL, LL_BOXTYPE_BRIDGEMETER, Invoice.hWnd, slLangText)
     '   End If
    'End If
    DoEvents
    'If (ilLLRet = 0) Then
        If Not imUsingCrystal Then
'VB6**      ilDummy = LLDefineVariableExt(hdJob, "Logo", sgLogoPath & "RptLogo.Bmp", LL_DRAWING, "")
'VB6**      ilDummy = LLDefineVariableExt(hdJob, "Arrow", sgLogoPath & "ArrowLt.Wmf", LL_DRAWING, "")
        End If
        'Compute Time of job number of spots to be invoiced
        llRecsRemaining = 0
        'For ilLoop = 0 To lbcCntr.ListCount - 1 Step 1
        '    If lbcCntr.Selected(ilLoop) Then
        '        llRecsRemaining = llRecsRemaining + 1
        '    End If
        'Next ilLoop
        For ilLoop = grdAirTime.FixedRows To grdAirTime.rows - 1 Step 1
            If (grdAirTime.TextMatrix(ilLoop, ATBILLINDEX) <> "") And (grdAirTime.TextMatrix(ilLoop, ATSELECTEDINDEX) <> "-1") Then
                If grdAirTime.TextMatrix(ilLoop, ATSELECTEDINDEX) = "1" Then
                    llRecsRemaining = llRecsRemaining + 1
                End If
            End If
        Next ilLoop
        slGTOrdered = ".00"
        slGTReconc = ".00"
        slGTAired = ".00"
        slGTNet = ".00"
        slGTComm = ".00"
        slTGNoSpots = "0"
        slEDITotalAired = ".00"
        ilEDITotalNoInv = 0
        llRecNo = 0
        ilErrorFlag = 0
        ilDBEof = False
        For ilTimeProb = 0 To 10 Step 1 'Loop to fix reprint timing problem
        Next ilTimeProb
        If Not imUsingCrystal Then
'VB6**      slPrinter = LlVBPrintGetPrinter(hdJob)
'VB6**      slPort = LlVBPrintGetPort(hdJob)
        End If
        For ilTimeProb = 0 To 10 Step 1 'Loop to fix reprint timing problem
        Next ilTimeProb
        ilShowTotals = False
        ilShowBottomMsg = False
        ilShowTradeMsg = False
        imLbcKeyIndex = 0
        llEndSortIndex = -1
        llPrevCntrNo = -1
        ReDim smXferRepDBID(0 To 0) As String
        ReDim smXferChfCode(0 To 0) As String
        Do
            If llEndSortIndex <> -1 Then
                ilShowTotals = True
            End If
            'If PSA or Promo contract- generate invoice with no invoice number
            'and don't update receivables
            For ilTimeProb = 0 To 10 Step 1 'Loop to fix reprint timing problem
            Next ilTimeProb
            ilRet = mReadChfRec(llStartSortIndex, llEndSortIndex, slProduct)
            If Not ilRet Then
                Exit Do
            End If
            mClearIvr True, True, True
            tmChf = tgChfInv
            llCntrNo = tmChf.lCntrNo
            ilAnyOutput = False
            ilFirstBonus = True
            smForm2Key = ""
            bmAddXMidMessage = False
            mFixSpotOrder llStartSortIndex, llEndSortIndex
            mSetPasses slPctTrade, ilStartPass, ilEndPass
                
            For ilPass = ilStartPass To ilEndPass Step 1
                If (ilStartPass = 1) And (ilPass = 2) Then
                    ilShowTotals = True
                End If
                ilAnyIvr = False
                ilPrevVeh = 0
                llPrevDate = 0
                llPrevTime = 0
                ilPrevLen = 0
                ilContinue = True
                ReDim tgRvfByVef(0 To 0) As RVFVEF
                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then       'Determine invoice number, 11-15-16 archive, reprint , aff or undo
                    llInvoiceNo = mDetInvoiceNo(ilPass, llStartSortIndex, llEndSortIndex, lmRPTax1, lmRPTax2)
                    If llInvoiceNo <= 0 Then
                        ilContinue = False
                    End If
                Else
                    mCheckNextInvNo llInvoiceNo
                End If
                If ilContinue Then
                    mGetComment
                    'gPDNToStr tmChf.sPctTrade, 0, slPctTrade
                    slPctTrade = gIntToStrDec(tmChf.iPctTrade, 0)

                    mGetAdfAgfSlf
                    slTotalNoPerWk = "0"
                    slTotalRate = ".00"
                    slTotalAirCount = "0"
                    slTotalAirRate = ".00"
                    ReDim tgMktTotal(0 To 0) As MKTTOTAL
                    If (tmChf.iAgfCode > 0) And (ilPass = 1) Then   '(Val(slPctTrade) <> 100) Then
                        'gPDNToStr tmAgf.sComm, 2, slAgyRate
                        slAgyRate = gIntToStrDec(tmAgf.iComm, 2)
                        tmIvr.iPctComm = tmAgf.iComm
                    ElseIf (tmChf.iAgfCode > 0) And (tmChf.sAgyCTrade = "Y") And (ilPass = 2) Then   '(Val(slPctTrade) <> 100) Then
                        'gPDNToStr tmAgf.sComm, 2, slAgyRate
                        slAgyRate = gIntToStrDec(tmAgf.iComm, 2)
                        tmIvr.iPctComm = tmAgf.iComm
                    Else
                        slAgyRate = ""
                        tmIvr.iPctComm = 0
                    End If
                    slAgyComm = ".00"
                    slTotalNet = ".00"
                    slTotalMissedRate = ".00"
                    slTotalMissedRateNonPkg = ".00"
                    ilNewPage = True
                    ilHeaderInit = False
                    'Agency
                    ilEDIUpper = 0
                    ReDim smEDIRecords(0 To ilEDIUpper) As String
                    ReDim smEDIByVehSort(0 To 0) As SORTCODE
                    ilEDIFlag = mDetermineIfEDIRequired()
                    If ilEDIFlag Then
                        If Trim$(tmEDIArf.sNmAd(0)) <> "" Then
                            tmIvr.sEDIComment = "Electronic Invoice Sent To " & Trim$(tmEDIArf.sNmAd(0))
                        Else
                            tmIvr.sEDIComment = "Electronic Invoice Sent To " & Trim$(tmEDIArf.sID)
                        End If
                    Else
                        tmIvr.sEDIComment = ""
                    End If
                    'Determine last vehicle and line so totals can be shown
                    For ilVeh = 0 To UBound(tgInvVehCode) - 1 Step 1 'lbcVehicle.ListCount - 1 Step 1
                        'If lbcVehicle.Selected(ilVeh) Then
                            slNameCode = Trim$(tgInvVehCode(ilVeh).sKey)    'Traffic!lbcVehicle.List(ilVeh)
                            If (slNameCode <> smBlkVefName & "\-1") Then
                                'ilRet = gParseItem(slNameCode, 2, "\", slCode)
                                slCode = Trim$(str$(tgInvVehCode(ilVeh).iCode))
                                For ilClf = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                    tmClf = tgClfInv(ilClf).ClfRec
                                    If (tmClf.sType <> "H") Then
                                        ilRet = False
                                        If tmClf.iVefCode = Val(slCode) Then
                                            'Check if line has any spots or should have had spots
                                            If (tmClf.sType <> "A") And ((tmClf.sType <> "E") Or (tgSpf.sInvAirOrder <> "2")) Then
                                                For llLoop = llStartSortIndex To llEndSortIndex Step 1
                                                    If tmClf.iLine = tgSortKey(llLoop).iLineNo Then
                                                        ilRet = True
                                                        Exit For
                                                    End If
                                                Next llLoop
                                            Else
                                                'Test if spots exist for hidden lines of the air line
                                                For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                                    If (tgClfInv(ilLine).ClfRec.sType = "H") And (tmClf.iLine = tgClfInv(ilLine).ClfRec.iPkLineNo) Then
                                                        For llLoop = llStartSortIndex To llEndSortIndex Step 1
                                                            If tgClfInv(ilLine).ClfRec.iLine = tgSortKey(llLoop).iLineNo Then
                                                                ilRet = True
                                                                Exit For
                                                            End If
                                                        Next llLoop
                                                    End If
                                                    If ilRet Then
                                                        Exit For
                                                    End If
                                                Next ilLine
                                            End If
                                            ilDoe = ilDoe + 1
                                            If ilDoe > 100 Then
                                                DoEvents
                                                ilDoe = 0
                                            End If
                                        End If
                                        If ilRet Then
                                            ilAnyOutput = True
                                            ilLastVeh = ilVeh
                                            ilLastClf = ilClf
                                        End If
                                    End If
                                Next ilClf
                            Else
                                'Test if any bonus spots
                                ilRet = False
                                'Ignore Bonus spots for Trades if split (include simulcast)
                                If (ilPass = 1) Or (ilStartPass = 2) Then
                                    For llLoop = llStartSortIndex To llEndSortIndex Step 1
                                        If (tgSortKey(llLoop).iLineNo = -1) Or (tgSortKey(llLoop).iLineNo = -2) Then
                                            ilRet = True
                                            Exit For
                                        End If
                                    Next llLoop
                                    If ilRet Then
                                        ilLastVeh = UBound(tgInvVehCode) - 1
                                        ilLastClf = UBound(tgClfInv) - 1
                                        ilAnyOutput = True
                                    End If
                                Else
                                    'Include simulcast
                                    For llLoop = llStartSortIndex To llEndSortIndex Step 1
                                        If (tgSortKey(llLoop).iLineNo = -2) Then
                                            ilRet = True
                                            Exit For
                                        End If
                                    Next llLoop
                                    If ilRet Then
                                        ilLastVeh = UBound(tgInvVehCode) - 1
                                        ilLastClf = UBound(tgClfInv) - 1
                                        ilAnyOutput = True
                                    End If
                                End If
                            End If
                        'End If
                    Next ilVeh
                    ilEDIVefCode = -1
                    slEDITotalRate = ".00"
                    slEDITotalAirRate = ".00"
                    slEDITotalNet = ".00"
                    For ilVeh = 0 To UBound(tgInvVehCode) - 1 Step 1 'lbcVehicle.ListCount - 1 Step 1
                        'If lbcVehicle.Selected(ilVeh) Then
                            slNameCode = Trim$(tgInvVehCode(ilVeh).sKey)    'Traffic!lbcVehicle.List(ilVeh)
                            'ilRet = gParseItem(slNameCode, 2, "\", slCode)
                            slCode = Trim$(str$(tgInvVehCode(ilVeh).iCode))
                            For ilClf = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                tmClf = tgClfInv(ilClf).ClfRec
                                slNameCode = Trim$(tgInvVehCode(ilVeh).sKey)    'Traffic!lbcVehicle.List(ilVeh)
                                If (slNameCode <> smBlkVefName & "\-1") Then
                                    ilRet = False
                                    ilBonusSpot = False
                                    'Bypass Hidden lines
                                    If (tmClf.sType <> "H") Then
                                        If tmClf.iVefCode = Val(slCode) Then
                                            If (tmClf.sType <> "A") And ((tmClf.sType <> "E") Or (tgSpf.sInvAirOrder <> "2")) Then
                                                'Check if line has any spots or should have had spots
                                                For llLoop = llStartSortIndex To llEndSortIndex Step 1
                                                    If tmClf.iLine = tgSortKey(llLoop).iLineNo Then
                                                        ilRet = True
                                                        Exit For
                                                    End If
                                                Next llLoop
                                            Else
                                                'Test if spots exist for hidden lines of the air line
                                                For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                                    If (tgClfInv(ilLine).ClfRec.sType = "H") And (tmClf.iLine = tgClfInv(ilLine).ClfRec.iPkLineNo) Then
                                                        For llLoop = llStartSortIndex To llEndSortIndex Step 1
                                                            If tgClfInv(ilLine).ClfRec.iLine = tgSortKey(llLoop).iLineNo Then
                                                                ilRet = True
                                                                Exit For
                                                            End If
                                                        Next llLoop
                                                    End If
                                                    If ilRet Then
                                                        Exit For
                                                    End If
                                                Next ilLine
                                            End If
                                            ilDoe = ilDoe + 1
                                            If ilDoe > 100 Then
                                                DoEvents
                                                ilDoe = 0
                                            End If
                                        End If
                                    Else
                                        'Find Package line and if Ordered, then set bill flag
                                        'Aired bill flag will be set when processing spots
                                        For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                            If tmClf.iPkLineNo = tgClfInv(ilLine).ClfRec.iLine Then
                                                If (tgClfInv(ilLine).ClfRec.sType = "O") Then
                                                    For llLoop = llStartSortIndex To llEndSortIndex Step 1
                                                        If tmClf.iLine = tgSortKey(llLoop).iLineNo Then
                                                            If rbcType(INVGEN_Final).Value Then
                                                                tgSortKey(llLoop).iBilled = True
                                                            End If
                                                        End If
                                                    Next llLoop
                                                End If
                                                Exit For
                                            End If
                                        Next ilLine
                                    End If
                                Else
                                    'Ignore Bonus spots for Trades if split
                                    If (ilPass = 1) Or (ilStartPass = 2) Then
                                        If ilClf = UBound(tgClfInv) - 1 Then
                                            ilRet = False
                                            For llLoop = llStartSortIndex To llEndSortIndex Step 1
                                                If (tgSortKey(llLoop).iLineNo = -1) Or (tgSortKey(llLoop).iLineNo = -2) Then
                                                    ilRet = True
                                                    Exit For
                                                End If
                                            Next llLoop
                                            If ilRet Then
                                                ilAnyOutput = True
                                                ilLastVeh = ilVeh
                                                ilLastClf = ilClf
                                                ilBonusSpot = True
                                            End If
                                        Else
                                            ilRet = False
                                        End If
                                    Else
                                        If ilClf = UBound(tgClfInv) - 1 Then
                                            ilRet = False
                                            For llLoop = llStartSortIndex To llEndSortIndex Step 1
                                                If tgSortKey(llLoop).iLineNo = -2 Then
                                                    ilRet = True
                                                    Exit For
                                                End If
                                            Next llLoop
                                            If ilRet Then
                                                ilAnyOutput = True
                                                ilLastVeh = ilVeh
                                                ilLastClf = ilClf
                                                ilBonusSpot = True
                                            End If
                                        Else
                                            ilRet = False
                                        End If
                                    End If
                                End If
                                If ilRet Then
                                    If ilEDIFlag And ilEDIVefCode <> -1 Then
                                        '12/23/08: For By Vehicle- initially combine all spots into the same edi records, then sort to generate file
                                        'If (tgSpf.sBCombine = "N") Or ((tmEDIArf.sSepInvByVeh = "Y") And (tgSpf.sBCombine <> "N")) Then
                                        If (tgSpf.sBCombine = "N") Then
                                            'If Not ilBonusSpot Then
                                                If ilEDIVefCode <> tmClf.iVefCode Then
                                                    '10/20/14: remove 41 if last record to be added
                                                    mRemovePriorEDI41WOSpots ilEDIUpper, ilEDIFirstLineIndex
                                                    mEDIStationEnd ilEDIUpper, ilPass, slEDITotalRate, slEDITotalAirRate, slAgyRate, slEDITotalAired, ilEDITotalNoInv
                                                    ilEDIVefCode = -1
                                                End If
                                            'Else
                                            '    If ilEDIVefCode <> 0 Then
                                            '        mEDIStationEnd ilEDIUpper, ilPass, slEDITotalRate, slEDITotalAirRate, slAgyRate, slEDITotalAired, ilEDITotalNoInv
                                            '        ilEDIVefCode = -1
                                            '    End If
                                            'End If
                                        End If
                                    End If
                                    If ilEDIFlag Then
                                        If ilEDIVefCode = -1 Then
                                            If (Not ilBonusSpot) Or (tgSpf.sBCombine = "N") Then
                                                ilEDIVefCode = tmClf.iVefCode
                                            Else
                                                ilEDIVefCode = 0
                                            End If
                                            mEDIStationStart ilEDIUpper, ilEDIVefCode, slSInvDate, slCInvDate, slWInvDate, llInvoiceNo, slSBMonth, slCBMonth, slWBMonth, slStdSDate, slStdEDate, slCalSDate, slCalEDate, slWkSDate, slWkEDate
                                        End If
                                    End If
                                    'This is required here for virtual vehicles- later it is reset
                                    'if spot moved to another vehicle
                                    'Vehicle Name
                                    If Not ilBonusSpot Then
                                        If tmClf.iVefCode <> tmVef.iCode Then
                                            tmVefSrchKey.iCode = tmClf.iVefCode
                                            ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                            If ilRet <> BTRV_ERR_NONE Then
                                                tmVef.sName = "Missing"
                                            End If
                                        End If
                                    End If
                                    mGetMktCode
                                    'ilUpdateIndex = mGetRvfIndex(tmClf.iVefCode)
                                    'Build output arrays
                                    If Not ilBonusSpot Then
                                        'Line number
                                        tmIvr.iLineNo = tmClf.iLine
                                        tmIvr.iRdfCode = 0     '4/14/11
                                        If tmVef.sType = "V" Then
                                            tmVsfSrchKey.lCode = tmVef.lVsfCode
                                            ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                            'Include virtual vehicle as first vehicle
                                            For ilVsf = UBound(tmVsf.iFSCode) To LBound(tmVsf.iFSCode) + 1 Step -1
                                                tmVsf.iFSCode(ilVsf) = tmVsf.iFSCode(ilVsf - 1)
                                                tmVsf.iNoSpots(ilVsf) = tmVsf.iNoSpots(ilVsf - 1)
                                                tmVsf.lFSComm(ilVsf) = tmVsf.lFSComm(ilVsf - 1)
                                            Next ilVsf
                                            tmVsf.iFSCode(LBound(tmVsf.iFSCode)) = tmClf.iVefCode
                                            tmVsf.iNoSpots(LBound(tmVsf.iFSCode)) = 1
                                            'gStrToPDN "100.0000", 4, 4, tmVsf.sFSComm(LBound(tmVsf.iFSCode))
                                            tmVsf.lFSComm(LBound(tmVsf.iFSCode)) = 1000000
                                        End If
                                        tmRdf.sName = "Missing"
                                        'For ilRdf = LBound(tgMRdf) To UBound(tgMRdf) - 1 Step 1
                                        '    If tgMRdf(ilRdf).iCode = tmClf.iRdfcode Then
                                            ilRdf = gBinarySearchRdf(tmClf.iRdfCode)
                                            If ilRdf <> -1 Then
                                                tmRdf = tgMRdf(ilRdf)
                                        '        Exit For
                                            End If
                                        'Next ilRdf
                                        'ilNoTimes = 1
                                        tmIvr.sOVehName = Trim$(tmVef.sName)
                                        'Times
                                        slEDISTime = ""
                                        slEDIETime = ""
                                        slStrTime = ""
                                        slDPAirTime = ""
                                        'ilSOrderTimeIndex = ilNoTimes + 1
                                        If (tmClf.iStartTime(0) <> 1) Or (tmClf.iStartTime(1) <> 0) Then
                                            gUnpackTime tmClf.iStartTime(0), tmClf.iStartTime(1), "A", "1", slStartTime
                                            gUnpackTime tmClf.iEndTime(0), tmClf.iEndTime(1), "A", "1", slEndTime
                                            gAdjOverrideTimes tmClf.iVefCode, slStartTime, slEndTime
                                            If tgSpf.sBOrderDPShow <> "B" Then
                                                tmIvr.sODPName = RTrim$(slStartTime & "-" & slEndTime)
                                                If tgSpf.sBOrderDPShow = "N" Then
                                                    tmIvr.iRdfCode = tmClf.iRdfCode     '4/14/11
                                                End If
                                            End If
                                            slStrTime = slStartTime & "-" & slEndTime
                                            slEDISTime = gFormatTime(slStartTime, "M", "2")
                                            slEDIETime = gFormatTime(slEndTime, "M", "2")
                                            If slEDIETime = "0000" Then
                                                slEDIETime = "2400"
                                            End If
                                        Else
                                            'Add times
                                            If tgSpf.sBOrderDPShow = "T" Then
                                                For ilLoop = LBound(tmRdf.iStartTime, 2) To UBound(tmRdf.iStartTime, 2) Step 1 'Row
                                                    If (tmRdf.iStartTime(0, ilLoop) <> 1) Or (tmRdf.iStartTime(1, ilLoop) <> 0) Then
                                                        gUnpackTime tmRdf.iStartTime(0, ilLoop), tmRdf.iStartTime(1, ilLoop), "A", "1", slStartTime
                                                        gUnpackTime tmRdf.iEndTime(0, ilLoop), tmRdf.iEndTime(1, ilLoop), "A", "1", slEndTime
                                                        gAdjOverrideTimes tmClf.iVefCode, slStartTime, slEndTime
                                                        tmIvr.sODPName = RTrim$(slStartTime & "-" & slEndTime)
                                                        If slStrTime = "" Then
                                                            slStrTime = slStartTime & "-" & slEndTime 'Trim$(tmRdf.sName) & " " & slStartTime & "-" & slEndTime
                                                        End If
                                                        If slEDISTime = "" Then
                                                            slEDISTime = gFormatTime(slStartTime, "M", "2")
                                                            slEDIETime = gFormatTime(slEndTime, "M", "2")
                                                            If slEDIETime = "0000" Then
                                                                slEDIETime = "2400"
                                                            End If
                                                        End If
                                                    End If
                                                Next ilLoop
                                            ElseIf tgSpf.sBOrderDPShow = "N" Then
                                                tmIvr.sODPName = Trim$(tmRdf.sName)
                                            End If
                                            If slStrTime = "" Then
                                                For ilLoop = LBound(tmRdf.iStartTime, 2) To UBound(tmRdf.iStartTime, 2) Step 1 'Row
                                                    If (tmRdf.iStartTime(0, ilLoop) <> 1) Or (tmRdf.iStartTime(1, ilLoop) <> 0) Then
                                                        gUnpackTime tmRdf.iStartTime(0, ilLoop), tmRdf.iStartTime(1, ilLoop), "A", "1", slStartTime
                                                        gUnpackTime tmRdf.iEndTime(0, ilLoop), tmRdf.iEndTime(1, ilLoop), "A", "1", slEndTime
                                                        gAdjOverrideTimes tmClf.iVefCode, slStartTime, slEndTime
                                                        If slDPAirTime = "" Then
                                                            slDPAirTime = slStartTime & "-" & slEndTime 'Trim$(tmRdf.sName) & " " & slStartTime & "-" & slEndTime
                                                            Exit For
                                                        End If
                                                    End If
                                                Next ilLoop
                                            Else
                                                slDPAirTime = slStrTime
                                            End If
                                            slStr = slDPAirTime
                                            ilPos = InStr(1, slStr, "A")
                                            Do While (ilPos > 0) And (ilPos < Len(slStr))
                                                slStr = Left$(slStr, ilPos) & Mid$(slStr, ilPos + 2)
                                                ilPos = InStr(ilPos + 1, slStr, "A")
                                            Loop
                                            ilPos = InStr(1, slStr, "P")
                                            Do While (ilPos > 0) And (ilPos < Len(slStr))
                                                slStr = Left$(slStr, ilPos) & Mid$(slStr, ilPos + 2)
                                                ilPos = InStr(ilPos + 1, slStr, "P")
                                            Loop
                                            slDPAirTime = slStr
                                        End If
                                        'ilEOrderTimeIndex = ilNoTimes
                                        'Remove M- For package if showing daypart times
                                        slStr = slStrTime
                                        ilPos = InStr(1, slStr, "A")
                                        Do While (ilPos > 0) And (ilPos < Len(slStr))
                                            slStr = Left$(slStr, ilPos) & Mid$(slStr, ilPos + 2)
                                            ilPos = InStr(ilPos + 1, slStr, "A")
                                        Loop
                                        ilPos = InStr(1, slStr, "P")
                                        Do While (ilPos > 0) And (ilPos < Len(slStr))
                                            slStr = Left$(slStr, ilPos) & Mid$(slStr, ilPos + 2)
                                            ilPos = InStr(ilPos + 1, slStr, "P")
                                        Loop
                                        slStrTime = slStr
                                        'slStr = slStr & Chr$(0)
                                        'ilDummy = LLDefineFieldExt(hdJob, "Times", slStr, LL_TEXT, "")
                                        'Length
                                        tmIvr.iLen = tmClf.iLen
                                        'Moved to mProcFlight
                                        'Dates, days and number of spots per wk
                                        'ilNoFlights = 1 '0
                                        ilCff = tgClfInv(ilClf).iFirstCff
                                        llFlightStartDate = 0
                                        ilEDIFirstLineIndex = UBound(smEDIRecords)
                                        ilEDINoOrderedSpots = 0
                                        slTotalVirtVehRate = ".00"
                                        ReDim tmWkDef(0 To 0) As WKDEF
                                        Do While ilCff <> -1
                                            gUnpackDate tgCffInv(ilCff).CffRec.iStartDate(0), tgCffInv(ilCff).CffRec.iStartDate(1), slSFlightDate
                                            gUnpackDate tgCffInv(ilCff).CffRec.iEndDate(0), tgCffInv(ilCff).CffRec.iEndDate(1), slEFlightDate
                                            ilIncludeFlight = True
                                            If tmChf.sBillCycle = "C" Then
                                                If (gDateValue(slSFlightDate) > lmEndCal) Or (gDateValue(slEFlightDate) < lmStartCal) Then
                                                    ilIncludeFlight = False
                                                End If
                                            ElseIf tmChf.sBillCycle = "W" Then
                                                If (gDateValue(slSFlightDate) > lmEndWk) Or (gDateValue(slEFlightDate) < lmStartWk) Then
                                                    ilIncludeFlight = False
                                                End If
                                            Else
                                                If (gDateValue(slSFlightDate) > lmEndStd) Or (gDateValue(slEFlightDate) < lmStartStd) Then
                                                    ilIncludeFlight = False
                                                End If
                                            End If
                                            'Test if CBS
                                            If gDateValue(slEFlightDate) < gDateValue(slSFlightDate) Then
                                                ilIncludeFlight = False
                                            End If
                                            
                                            If ilIncludeFlight Then
                                                mProcFlight ilCff, slSFlightDate, slEFlightDate, ilPass, slPctTrade, slEDIRate, slTotalNoPerWk, ilEDINoOrderedSpots, slTotalRate, slEDITotalRate, slTotalVirtVehRate

                                                If llFlightStartDate = 0 Then
                                                    llFlightStartDate = gDateValue(slSFlightDate)
                                                End If
                                                slStr = ""
                                                If tgCffInv(ilCff).CffRec.sDyWk <> "D" Then
                                                    slStr = gDayNames(tgCffInv(ilCff).CffRec.iDay(), tgCffInv(ilCff).CffRec.sXDay(), 2, slEDIDays)
                                                    slEDIDays = mConvertEDIDays(slEDIDays)
                                                Else
                                                    ilSpotsPerWk = 0
                                                    slStr = ""
                                                    slEDIDays = ""
                                                    For ilDay = 0 To 6 Step 1
                                                        ilSpotsPerWk = ilSpotsPerWk + tgCffInv(ilCff).CffRec.iDay(ilDay)
                                                        slStr = slStr & str$(tgCffInv(ilCff).CffRec.iDay(ilDay)) & " "
                                                        If tgCffInv(ilCff).CffRec.iDay(ilDay) > 0 Then
                                                            Select Case ilDay
                                                                Case 0
                                                                    slEDIDays = slEDIDays & "M"
                                                                Case 1
                                                                    slEDIDays = slEDIDays & "T"
                                                                Case 2
                                                                    slEDIDays = slEDIDays & "W"
                                                                Case 3
                                                                    slEDIDays = slEDIDays & "T"
                                                                Case 4
                                                                    slEDIDays = slEDIDays & "F"
                                                                Case 5
                                                                    slEDIDays = slEDIDays & "S"
                                                                Case 6
                                                                    slEDIDays = slEDIDays & "S"
                                                            End Select
                                                        Else
                                                            slEDIDays = slEDIDays & " "
                                                        End If
                                                    Next ilDay
                                                End If
                                                If ilEDIFlag Then
                                                    slEDILnStartDate = ""
                                                    slEDILnEndDate = ""
                                                    If tmChf.sBillCycle = "C" Then
                                                        If gDateValue(slSFlightDate) < lmStartCal Then
                                                            slEDILnStartDate = Format$(lmStartCal, "yymmdd")
                                                        Else
                                                            slEDILnStartDate = Format$(gDateValue(slSFlightDate), "yymmdd")
                                                        End If
                                                        If gDateValue(slEFlightDate) > lmEndCal Then
                                                            slEDILnStartDate = Format$(lmEndCal, "yymmdd")
                                                        Else
                                                            slEDILnStartDate = Format$(gDateValue(slEFlightDate), "yymmdd")
                                                        End If
                                                    ElseIf tmChf.sBillCycle = "W" Then
                                                        If gDateValue(slSFlightDate) < lmStartWk Then
                                                            slEDILnStartDate = Format$(lmStartWk, "yymmdd")
                                                        Else
                                                            slEDILnStartDate = Format$(gDateValue(slSFlightDate), "yymmdd")
                                                        End If
                                                        If gDateValue(slEFlightDate) > lmEndWk Then
                                                            slEDILnStartDate = Format$(lmEndWk, "yymmdd")
                                                        Else
                                                            slEDILnStartDate = Format$(gDateValue(slEFlightDate), "yymmdd")
                                                        End If
                                                    Else
                                                        If gDateValue(slSFlightDate) < lmStartStd Then
                                                            slEDILnStartDate = Format$(lmStartStd, "yymmdd")
                                                        Else
                                                            slEDILnStartDate = Format$(gDateValue(slSFlightDate), "yymmdd")
                                                        End If
                                                        If gDateValue(slEFlightDate) > lmEndStd Then
                                                            slEDILnStartDate = Format$(lmEndStd, "yymmdd")
                                                        Else
                                                            slEDILnStartDate = Format$(gDateValue(slEFlightDate), "yymmdd")
                                                        End If
                                                    End If
                                                End If
                                            End If
                                            ilCff = tgCffInv(ilCff).iNextCff
                                        Loop
                                        slOrderedPrice = RTrim$(smCffPrice) 'Later change to get price from flight- for mg, get price from
                                                                    'orginal week which might not be a flight week
                                    Else
                                        ReDim tmWkDef(0 To 0) As WKDEF      '8-25-05 set array when only bonus spots
                                        'ilNoFlights = 1
                                        slOrderedPrice = ".00" 'Later change to get price from flight- for mg, get price from
                                        'If (tgSpf.sInvAirOrder = "2") And (tgSpf.sBLaserForm = "2") Then
                                        '    slTotalNoPerWk = gAddStr(slTotalNoPerWk, "1")
                                        'End If
                                    End If
                                    smCffPrice = ""    'Remove price
                                    'Build Aired Array and Reconcile (this must match air)
                                    If (tmVef.sType <> "V") Or (ilBonusSpot) Then
                                        If Not ilBonusSpot Then
                                            'llNoAiredRows = 0
                                            'ilNoReconcRows = 0
                                        Else
                                            If ilFirstBonus Then    'Force blank line
                                                'llNoAiredRows = 1
                                                'ilNoReconcRows = 1
                                                ilFirstBonus = False
                                            End If
                                        End If
                                    Else
                                        'llNoAiredRows = 0
                                        'ilNoReconcRows = 0
                                        ilRemVirtSpotRate = False
                                        If (imVirtBillMethod = 1) Or (imVirtBillMethod = 2) Then
                                            ilFound = False
                                            'Billed price computed from ordered, then remove Missed, add MG
                                            'Output total dollar row for line (spot price*#weeks*#spots-Missed+MG)
                                            'slTotalVirtVehRate = ".00" 'Line price computed from ordered- remove Missed, add MG
                                            For llSdfIndex = llStartSortIndex To llEndSortIndex Step 1
                                                ilShowSpot = False
                                                tmSpotClf = tmClf
                                                If tmClf.sType = "A" Then   'Aired
                                                    For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                                        If tgClfInv(ilLine).ClfRec.iLine = tgSortKey(llSdfIndex).iLineNo Then
                                                            If (tmClf.iLine = tgClfInv(ilLine).ClfRec.iPkLineNo) Then
                                                                ilShowSpot = True
                                                                tmSpotClf = tgClfInv(ilLine).ClfRec
                                                            End If
                                                            Exit For
                                                        End If
                                                    Next ilLine
                                                Else
                                                    If tgSortKey(llSdfIndex).iLineNo = tgClfInv(ilClf).ClfRec.iLine Then
                                                        ilShowSpot = True
                                                    End If
                                                End If
                                                If ilShowSpot Then
                                                    ilFound = True
                                                    '10/5/14
                                                    If (tgSortKey(llSdfIndex).iType = 0) Or (tgSortKey(llSdfIndex).iType = 3) Then
                                                        'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                        tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                        If (tgSortKey(llSdfIndex).iBillMissed) And (tmSdf.sSchStatus = "M") Then
                                                            tmSdf.sSchStatus = "S"
                                                        End If
                                                        tmSmf.iOrigSchVef = tmSdf.iVefCode
                                                        If (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                                            'tmSmfSrchKey.lChfCode = tmSdf.lChfCode  'tmClf.lChfCode
                                                            'tmSmfSrchKey.iLineNo = tmSdf.iLineNo    'tmClf.iLine
                                                            'tmSmfSrchKey.iMissedDate(0) = 0 'ilDate0
                                                            'tmSmfSrchKey.iMissedDate(1) = 0 'ilDate1
                                                            'ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                                            tmSmfSrchKey2.lCode = tmSdf.lCode
                                                            ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                            'Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tmClf.lChfCode) And (tmSmf.iLineNo = tmClf.iLine)
                                                            Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tmSdf.lChfCode) And (tmSmf.iLineNo = tmSdf.iLineNo)
                                                                If (tmSmf.lSdfCode = tmSdf.lCode) Then
                                                                    Exit Do
                                                                End If
                                                                ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                            Loop
                                                            ilRet = gGetFlightPrice(tmSdf, tmSpotClf, hmCff, hmSmf, slAiredPrice)
                                                        Else
                                                            ilRet = gGetFlightPrice(tmSdf, tmSpotClf, hmCff, hmSmf, slAiredPrice)
                                                        End If
                                                        If tgSortKey(llSdfIndex).iLineNo = -2 Then
                                                            slAiredPrice = "0.00"
                                                        End If
                                                        'Determine flight price
                                                        If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                                                            ilUpdateIndex = mGetRvfIndex(tmClf.iVefCode)
                                                        ElseIf (tgSpf.sInvAirOrder = "2") Then
                                                            ilUpdateIndex = mGetRvfIndex(tmClf.iVefCode)
                                                        Else
                                                            ilUpdateIndex = mGetRvfIndex(tmSdf.iVefCode)    'Summary by virtual vehicle
                                                        End If
                                                        slVirtVehRate = gVirtVefSpotPrice(hmVef, hmVsf, tmSpotClf.iVefCode, tmSmf.iOrigSchVef, slAiredPrice)
                                                        If (tmSdf.sSpotType <> "X") And (tmSdf.sSpotType <> "O") And (tmSdf.sSpotType <> "C") Then
                                                            'If tmClf.sPriceType = "T" Then
                                                                If (tmSdf.sPriceType = "N") Then
                                                                    If gCompNumberStr(slAiredPrice, "0.00") <> 0 Then
                                                                        ilRemVirtSpotRate = True
                                                                    End If
                                                                ElseIf (tmSdf.sPriceType = "P") Then
                                                                    ilRemVirtSpotRate = True
                                                                End If
                                                            'End If
                                                            If (tmSdf.sSchStatus = "M") Or (tmSdf.sSchStatus = "U") Or (tmSdf.sSchStatus = "R") Or (tmSdf.sSchStatus = "C") Then
                                                                If InStr(slAiredPrice, ".") > 0 Then
                                                                    slTotalVirtVehRate = gSubStr(slTotalVirtVehRate, slVirtVehRate)
                                                                End If
                                                            Else
                                                                If InStr(slAiredPrice, ".") > 0 Then
                                                                    If ilRemVirtSpotRate Then
                                                                        slTotalVirtVehRate = gSubStr(slTotalVirtVehRate, slVirtVehRate)
                                                                    End If
                                                                    If tmSdf.sSchStatus = "G" Then
                                                                        slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, slVirtVehRate)
                                                                    End If
                                                                End If
                                                            End If
                                                        End If
                                                    ElseIf tgSortKey(llSdfIndex).iType = 1 Then
                                                        'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                        tmSmfSrchKey1.lCode = tgSortKey(llSdfIndex).lCode
                                                        ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                        tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                                                        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                        ilRet = gGetFlightPrice(tmSdf, tmSpotClf, hmCff, hmSmf, slAiredPrice)

                                                        If InStr(slAiredPrice, ".") > 0 Then
                                                            slVirtVehRate = gVirtVefSpotPrice(hmVef, hmVsf, tmSpotClf.iVefCode, tmSmf.iOrigSchVef, slAiredPrice)
                                                            slTotalVirtVehRate = gSubStr(slTotalVirtVehRate, slVirtVehRate)
                                                        End If
                                                    Else
                                                        'ilRet = btrGetDirect(hmPsf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                        tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                                        ilRet = btrGetEqual(hmPsf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                        tmSmf.iOrigSchVef = tmSdf.iVefCode
                                                    End If
                                                End If
                                            Next llSdfIndex
                                            If ilFound Then
                                                slTotalAirRate = gAddStr(slTotalAirRate, slTotalVirtVehRate)
                                                slEDITotalAirRate = gAddStr(slEDITotalAirRate, slTotalVirtVehRate)
                                                tgRvfByVef(ilUpdateIndex).sTotalGross = gAddStr(tgRvfByVef(ilUpdateIndex).sTotalGross, slTotalVirtVehRate)
                                            End If
                                        End If
                                    End If
                                    For llSdfIndex = llStartSortIndex To llEndSortIndex Step 1
                                        ilShowSpot = False
                                        If Not ilBonusSpot Then
                                            tmSpotClf = tmClf
                                            If (tmClf.sType = "A") Or ((tmClf.sType = "E") And (tgSpf.sInvAirOrder = "2")) Then   '((tmClf.sType = "E") And (tgSortKey(llSdfIndex).iType = 2)) Then   'Aired
                                                For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                                    If tgClfInv(ilLine).ClfRec.iLine = tgSortKey(llSdfIndex).iLineNo Then
                                                        If (tmClf.iLine = tgClfInv(ilLine).ClfRec.iPkLineNo) Or (tmClf.iLine = tgClfInv(ilLine).ClfRec.iLine) Then
                                                            tmSpotClf = tgClfInv(ilLine).ClfRec
                                                            ilShowSpot = True
                                                            Exit For
                                                        End If
                                                        'Exit For
                                                    End If
                                                Next ilLine
                                            ElseIf tmClf.sType = "O" Then
                                                If tgSortKey(llSdfIndex).iLineNo = tgClfInv(ilClf).ClfRec.iLine Then
                                                    ilShowSpot = True
                                                Else
                                                    'Might need to include Bonus spots of hidden lines which belong to package line
                                                    For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                                        If tgClfInv(ilLine).ClfRec.iLine = tgSortKey(llSdfIndex).iLineNo Then
                                                            If tmClf.iLine = tgClfInv(ilLine).ClfRec.iPkLineNo Then
                                                                '10/5/14
                                                                If (tgSortKey(llSdfIndex).iType = 0) Or (tgSortKey(llSdfIndex).iType = 3) Then
                                                                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                                    tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                                                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                                    If (tgSortKey(llSdfIndex).iBillMissed) And (tmSdf.sSchStatus = "M") Then
                                                                        tmSdf.sSchStatus = "S"
                                                                    Else
                                                                        mCheckIfMissedChgdToMG
                                                                    End If
                                                                ElseIf tgSortKey(llSdfIndex).iType = 1 Then
                                                                    'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                                    tmSmfSrchKey1.lCode = tgSortKey(llSdfIndex).lCode
                                                                    ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                                    tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                                                                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                                End If
                                                                If (tmSdf.sSpotType = "X") Then
                                                                    'ilShowSpot = True
                                                                End If
                                                                If rbcType(INVGEN_Aff).Value Then
                                                                    ilShowSpot = True
                                                                End If
                                                                Exit For
                                                            End If
                                                        End If
                                                    Next ilLine
                                                End If
                                            Else
                                                If tgSpf.sInvAirOrder = "2" Then
                                                    If (tmClf.sType = "E") And (tgSortKey(llSdfIndex).iType = 2) And (tgSortKey(llSdfIndex).iLineNo = tmClf.iLine) Then
                                                        If rbcType(INVGEN_Final).Value Then
                                                            tgSortKey(llSdfIndex).iBilled = True
                                                        End If
                                                    Else
                                                        If tgSortKey(llSdfIndex).iLineNo = tgClfInv(ilClf).ClfRec.iLine Then
                                                            ilShowSpot = True
                                                        End If
                                                    End If
                                                Else
                                                    If tgSortKey(llSdfIndex).iLineNo = tgClfInv(ilClf).ClfRec.iLine Then
                                                        ilShowSpot = True
                                                    End If
                                                End If
                                                If tgSortKey(llSdfIndex).iLineNo = tgClfInv(ilClf).ClfRec.iLine Then
                                                    ilShowSpot = True
                                                End If
                                            End If
                                        Else
                                            'test it trade part of split- if so ignore spots
                                            If (ilPass = 1) Or (ilStartPass = 2) Then
                                                If (tgSortKey(llSdfIndex).iLineNo = -1) Or (tgSortKey(llSdfIndex).iLineNo = -2) Then
                                                    ilShowSpot = True
                                                End If
                                            Else
                                                If (tgSortKey(llSdfIndex).iLineNo = -2) Then
                                                    ilShowSpot = True
                                                End If
                                            End If
                                        End If
                                        If ilShowSpot Then
                                            '10/5/14
                                            If (tgSortKey(llSdfIndex).iType = 0) Or (tgSortKey(llSdfIndex).iType = 3) Then
                                                'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                If (tgSortKey(llSdfIndex).iBillMissed) And (tmSdf.sSchStatus = "M") Then
                                                    tmSdf.sSchStatus = "S"
                                                Else
                                                    mCheckIfMissedChgdToMG
                                                End If
                                                ilOrigGameNo = tmSdf.iGameNo
                                                ilGameNoForWkNo = ilOrigGameNo
                                                'Get SMF for spot
                                                tmSmf.iOrigSchVef = tmSdf.iVefCode
                                                If (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                                    'tmSmfSrchKey.lChfCode = tmClf.lChfCode
                                                    'tmSmfSrchKey.iLineNo = tmClf.iLine
                                                    'tmSmfSrchKey.iMissedDate(0) = 0 'ilDate0
                                                    'tmSmfSrchKey.iMissedDate(1) = 0 'ilDate1
                                                    'ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                                    tmSmfSrchKey2.lCode = tmSdf.lCode
                                                    ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                    Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tmClf.lChfCode) And (tmSmf.iLineNo = tmClf.iLine)
                                                        If (tmSmf.lSdfCode = tmSdf.lCode) Then
                                                            ilOrigGameNo = tmSmf.iGameNo
                                                            Exit Do
                                                        End If
                                                        ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                    Loop
                                                End If
                                            ElseIf tgSortKey(llSdfIndex).iType = 1 Then
                                                'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSmfSrchKey1.lCode = tgSortKey(llSdfIndex).lCode
                                                ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                                                ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                '9/15/14: Match sort
                                                'ilOrigGameNo = tmSmf.iGameNo
                                                'ilGameNoForWkNo = ilOrigGameNo
                                                If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                                                    ilOrigGameNo = tmSmf.iGameNo
                                                    ilGameNoForWkNo = ilOrigGameNo
                                                Else
                                                    ilOrigGameNo = tmSmf.iGameNo
                                                    ilGameNoForWkNo = tmSdf.iGameNo
                                                End If
                                            Else
                                                'ilRet = btrGetDirect(hmPsf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                                                tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                                                ilRet = btrGetEqual(hmPsf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                tmSmf.iOrigSchVef = tmSdf.iVefCode
                                                ilOrigGameNo = 0
                                                ilGameNoForWkNo = 0
                                            End If
                                            'Filter out virtual vehicle spots
                                            ilShowSpots = True
                                            If Not ilBonusSpot Then
                                                If (tmVef.sType = "V") And ((imVirtBillMethod = 2) Or (imVirtBillMethod = 3)) Then
                                                    If tgSortKey(llSdfIndex).iType = 0 Then
                                                        If (tmSdf.sSchStatus = "S") Then
                                                            If tmSdf.iVefCode <> tmVsf.iFSCode(0) Then
                                                                If tmSdf.sSpotType <> "X" Then  'Show Extra Bonus Spots
                                                                    ilShowSpots = False
                                                                End If
                                                            End If
                                                        ElseIf (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                                            If tmSmf.iOrigSchVef <> tmVsf.iFSCode(0) Then
                                                                If tmSdf.sSpotType <> "X" Then  'Show Extra Bonus Spots
                                                                    ilShowSpots = False
                                                                End If
                                                            End If
                                                        Else
                                                            'Missed- show if as order
                                                            If ((tgSpf.sInvAirOrder = "O") And (tgSpf.sBLaserForm <> "2")) Or (tgSpf.sInvAirOrder = "S") Or ((tgSpf.sInvAirOrder = "O") And (tgSpf.sBLaserForm = "2") And (rbcType(INVGEN_Preliminary).Value Or rbcType(INVGEN_Final).Value)) Then
                                                                If (tmSdf.sSchStatus = "H") Then
                                                                    ilShowSpot = False
                                                                Else
                                                                    If tmSdf.iVefCode <> tmVsf.iFSCode(0) Then
                                                                        ilShowSpots = False
                                                                    End If
                                                                End If
                                                            Else
                                                                ilShowSpots = False
                                                            End If
                                                        End If
                                                        If Not ilShowSpots Then
                                                            If rbcType(INVGEN_Final).Value Then
                                                                tgSortKey(llSdfIndex).iBilled = True
                                                            End If
                                                        End If
                                                    ElseIf tgSortKey(llSdfIndex).iType = 1 Then
                                                        If (tmSdf.sSchStatus = "S") Then
                                                            If tmSdf.iVefCode <> tmVsf.iFSCode(0) Then
                                                                If tmSdf.sSpotType <> "X" Then  'Show Extra Bonus Spots
                                                                    ilShowSpots = False
                                                                End If
                                                            End If
                                                        ElseIf (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                                            If tmSmf.iOrigSchVef <> tmVsf.iFSCode(0) Then
                                                                If tmSdf.sSpotType <> "X" Then  'Show Extra Bonus Spots
                                                                    ilShowSpots = False
                                                                End If
                                                            End If
                                                        Else
                                                            ilShowSpots = False
                                                        End If
                                                        If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                                                            If Not ilShowSpots Then
                                                                If rbcType(INVGEN_Final).Value Then
                                                                    tgSortKey(llSdfIndex).iBilled = True
                                                                End If
                                                            End If
                                                        End If
                                                    Else
                                                        If tmSdf.iVefCode <> tmVsf.iFSCode(0) Then
                                                            If tmSdf.sSpotType <> "X" Then  'Show Extra Bonus Spots
                                                                ilShowSpots = False
                                                            End If
                                                        End If
                                                    End If
                                                End If
                                            Else
                                                'Get true line associated with spot
                                                For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                                    If tgClfInv(ilLine).ClfRec.iLine = tmSdf.iLineNo Then
                                                        tmSpotClf = tgClfInv(ilLine).ClfRec
                                                        If tgClfInv(ilLine).ClfRec.iPkLineNo > 0 Then
                                                            'Find package line
                                                            For ilIndex = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                                                If tgClfInv(ilIndex).ClfRec.iLine = tgClfInv(ilLine).ClfRec.iPkLineNo Then
                                                                    tmClf = tgClfInv(ilIndex).ClfRec
                                                                    Exit For
                                                                End If
                                                            Next ilIndex
                                                        Else
                                                            tmClf = tgClfInv(ilLine).ClfRec
                                                        End If
                                                        Exit For
                                                    End If
                                                Next ilLine
                                                'If simulcast- replace airing vehicle
                                                If tgSortKey(llSdfIndex).iLineNo = -2 Then
                                                    'Airing vehicle in field 9
                                                    ilRet = gParseItem(tgSortKey(llSdfIndex).sKey, 9, "|", slStr)
                                                    For ilIndex = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                                                        If StrComp(Trim$(tgMVef(ilIndex).sName), Trim$(slStr), 1) = 0 Then
                                                            tmSdf.iVefCode = tgMVef(ilIndex).iCode
                                                            tmSpotClf.iVefCode = tgMVef(ilIndex).iCode
                                                            Exit For
                                                        End If
                                                    Next ilIndex
                                                End If
                                            End If
                                            'Changed on 3/20/03- Jim order
                                            'If (tmSdf.sSpotType = "X") And (tmSdf.sPriceType = "N") Then
                                            'If (tmSdf.sSpotType = "X") And (tmAdf.sBonusOnInv = "N") Then
                                            If (tmSdf.sSpotType = "X") And ((tmAdf.sBonusOnInv = "N") Or (tmSdf.sPriceType = "-")) Then
                                                If tmSdf.sPriceType = "+" Then
                                                ElseIf (tmAdf.sBonusOnInv = "N") Or (tmSdf.sPriceType = "-") Then
                                                    ilShowSpots = False
                                                    If rbcType(INVGEN_Final).Value Then
                                                        tgSortKey(llSdfIndex).iBilled = True
                                                    End If
                                                End If
                                            End If
                                            If smForm2Key = "" Then
                                                smForm2Key = mForm2Key(llSdfIndex)
                                            End If
                                            If ilShowSpots Then
                                                blAddComment52 = False
                                                If Not ilBonusSpot Then
                                                    If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                                                        ilUpdateIndex = mGetRvfIndex(tmClf.iVefCode)
                                                    ElseIf tgSpf.sInvAirOrder = "2" Then
                                                        'Only get index for PSF or Conventional
                                                        If (tgSortKey(llSdfIndex).iType = 2) Then
                                                            ilUpdateIndex = mGetRvfIndex(tmClf.iVefCode)
                                                        ElseIf (tmClf.sType = "E") Then
                                                            'Create Rvf record incase no package spots to be billed for month- still need invoice sent to rvf so affidavit can be run
                                                            ilUpdateIndex = mGetRvfIndex(tmClf.iVefCode)
                                                            ilUpdateIndex = -1
                                                        ElseIf (tmClf.sType <> "O") And (tmClf.sType <> "A") And (tmClf.sType <> "H") Then
                                                            ilUpdateIndex = mGetRvfIndex(tmClf.iVefCode)
                                                        Else
                                                            '3/19/14: Real vehicles with site type 2 need to be added to receivables
                                                            'ilUpdateIndex = -1
                                                            If (tmClf.sType = "A") Then
                                                                'Might need to use tmSdf.iVefCode if want revenue by airing vehicle
                                                                'Use tmChf.iVefCode if want revenue by package vehicle
                                                                'Use tmSpotClf.iVefCode if want revenue of order line
                                                                ilUpdateIndex = mGetRvfIndex(tmSpotClf.iVefCode)
                                                            Else
                                                                ilUpdateIndex = -1
                                                            End If
                                                        End If
                                                    Else
                                                        If (tgSortKey(llSdfIndex).iType <> 1) Then 'Type = 1 is for MG's that only missed date is within billing dates
                                                            ilUpdateIndex = mGetRvfIndex(tmSdf.iVefCode)
                                                        Else
                                                            ilUpdateIndex = -1
                                                        End If
                                                    End If
                                                Else
                                                    ilUpdateIndex = -1
                                                End If
                                                If Not ilBonusSpot Then
                                                    If (tmVef.sType = "V") And (imVirtBillMethod = 1) Then
                                                        'Obtain vehicle name
                                                        ilRet = gParseItem(tgSortKey(llSdfIndex).sKey, 9, "|", slStr)
                                                    End If
                                                End If
                                                tmIvr.sRRemark = ""
                                                tmIvr.sRAmount = ""
                                                slEDIAirRate = slEDIRate
                                                '5/31/12: Method (D: InvAirOrder = 2) not showing the Missed part of a MG
                                                'If (tgSortKey(llSdfIndex).iType = 0) Or (tgSortKey(llSdfIndex).iType = 2) Or (((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Or (tgSpf.sInvAirOrder = "2")) And (tgSortKey(llSdfIndex).iType = 1)) Or (tmSdf.sSpotType = "X") Then
                                                '10/23/14: Handle Bonus spots that cross midnight
                                                'If (tgSortKey(llSdfIndex).iType = 0) Or (tgSortKey(llSdfIndex).iType = 2) Or (((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) And (tgSortKey(llSdfIndex).iType = 1)) Or (tmSdf.sSpotType = "X") Then
                                                gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llDate
                                                '11-15-16 test for archive in addition to reprint
                                                If (tgSortKey(llSdfIndex).iType = 0) Or (tgSortKey(llSdfIndex).iType = 2) Or (((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) And (tgSortKey(llSdfIndex).iType = 1)) Or ((tmSdf.sSpotType = "X") And (tgSortKey(llSdfIndex).iType <> 3)) Or ((tgSortKey(llSdfIndex).iType = 3) And (rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value) And (llDate + 1 = lmStartStd)) Then
                                                    If (tgSpf.sInvAirOrder <> "2") Or (tgSortKey(llSdfIndex).iType <> 1) Then
                                                        If rbcType(INVGEN_Final).Value Then
                                                            tgSortKey(llSdfIndex).iBilled = True
                                                        End If
                                                    End If
                                                    tmVefSrchKey.iCode = tmSdf.iVefCode 'tmVsf.iFSCode(ilVsf)   'ilVefCode
                                                    If tmVefSrchKey.iCode <> tmInvRptVef.iCode Then
                                                        ilRet = btrGetEqual(hmVef, tmInvRptVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                        If ilRet <> BTRV_ERR_NONE Then
                                                            'tmInvRptVef.sShowTime = "A"
                                                        End If
                                                    End If
                                                    If tgSortKey(llSdfIndex).iType = 2 Then
                                                        If (tmClf.sType = "O") And (tmAdf.sPkInvShow = "D") And (tmAgf.sPkInvShow = "D") Then
                                                            slShowTime = "D"
                                                        Else
                                                            slShowTime = " "
                                                        End If
                                                    Else
                                                        ilVpfIndex = gVpfFind(Invoice, tmSdf.iVefCode)
                                                        slShowTime = tgVpf(ilVpfIndex).sShowTime
                                                    End If
                                                    If (((tgSpf.sInvAirOrder = "O") And (rbcType(INVGEN_Aff).Value <> True)) Or (tgSpf.sInvAirOrder = "S")) And ((tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) And (tmSdf.sSpotType <> "X") Then
                                                        gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                                    Else
                                                        gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                                    End If
                                                    llDate = gDateValue(slDate)
                                                    'Show weeks without spots
                                                    For ilWkIndex = LBound(tmWkDef) To UBound(tmWkDef) - 1 Step 1
                                                        'Process missed game at end
                                                        'If ((tmWkDef(ilWkIndex).lWkEDate < llDate) And (tmSdf.iGameNo = 0)) Or ((tmWkDef(ilWkIndex).iGameNo = tmSdf.iGameNo) And (tgSortKey(llSdfIndex).iType = 0)) Or ((tmWkDef(ilWkIndex).iGameNo = tmSmf.iGameNo) And (tgSortKey(llSdfIndex).iType = 1)) Then
                                                        If (tmWkDef(ilWkIndex).lWkEDate < llDate) And (tmWkDef(ilWkIndex).iGameNo = 0) And (ilOrigGameNo = 0) Then
                                                            If Not tmWkDef(ilWkIndex).iWkShown Then
                                                                tmWkDef(ilWkIndex).iWkShown = True
                                                                'Don't show any information about missing weeks for form 2 and 3
                                                                If (tgSpf.sBLaserForm <> "2") And (tgSpf.sBLaserForm <> "3") Then
                                                                    'Code later: get price from week- if mg get from original week which might not
                                                                    'be within tmWkDef
                                                                    tmIvr.iWkNo = tmIvr.iWkNo + 1
                                                                    tmIvr.sODays = RTrim$(Trim$(tmWkDef(ilWkIndex).sDays))
                                                                    tmIvr.lONoSpots = Val(RTrim$(tmWkDef(ilWkIndex).sNoSpots))
                                                                    tmIvr.sORate = RTrim$(Trim$(tmWkDef(ilWkIndex).sWkPrice))
                                                                    'EDI Flight Info
                                                                    mRemovePriorEDI41WOSpots ilEDIUpper, ilEDIFirstLineIndex
                                                                    smEDIRecords(ilEDIUpper) = "41;" & Trim$(str$(tmClf.iLine)) & ";" & tmWkDef(ilWkIndex).sEDIDays & ";" & slEDISTime & ";" & slEDIETime & ";;" & Trim$(tmWkDef(ilWkIndex).sEDIRate) & ";" & Trim$(tmWkDef(ilWkIndex).sNoSpots) & ";" & "" & ";" & "" & ";"
                                                                    ilEDIUpper = ilEDIUpper + 1
                                                                    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                                    If ilEDIFirstLineIndex = ilEDIUpper - 1 Then
                                                                        smEDIRecords(ilEDIUpper) = "42;" & Trim$(tmVef.sName) & ";"
                                                                        ilEDIUpper = ilEDIUpper + 1
                                                                        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                                    End If
                                                                    If (tmAdf.sRateOnInv = "N") Then
                                                                        tmIvr.sORate = ""
                                                                        tmIvr.sARate = ""
                                                                        tmIvr.sRAmount = ""
                                                                    End If
                                                                    If imUsingCrystal Then
                                                                        If (Not ilHeaderInit) Then
                                                                            'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81; Add Contract # so that the contract can be checked for AirTime/CPM & NTR to determine if Header should show NTR
                                                                            mGenHeader ilImpactPrt, llInvoiceNo, ilPass, slPctTrade, 0, False, ilEDIFlag, tmChf.lCntrNo
                                                                            ilHeaderInit = True
                                                                        End If
                                                                        mResetFieldsForIvr llSdfIndex, ilAnyIvr, ilBonusSpot, ilEDIFlag
                                                                        'Second call required to bypass daypart definition
                                                                        mResetFieldsForIvr llSdfIndex, ilAnyIvr, ilBonusSpot, ilEDIFlag
                                                                        'mClearIvr False, False, True
                                                                    End If
                                                                End If
                                                            End If
                                                        End If
                                                    Next ilWkIndex
                                                    'If (Not ilBonusSpot) And (tmSdf.sSpotType <> "X") And (tmSdf.sSpotType <> "O") And (tmSdf.sSpotType <> "C") Then
                                                    If (Not ilBonusSpot) And (tmSdf.sSpotType <> "X") Then
                                                        ilFound = False
                                                        For ilWkIndex = LBound(tmWkDef) To UBound(tmWkDef) - 1 Step 1
                                                            'If (llDate >= tmWkDef(ilWkIndex).lWkSDate) And (llDate <= tmWkDef(ilWkIndex).lWkEDate) And ((tmWkDef(ilWkIndex).iGameNo = 0) Or (tmWkDef(ilWkIndex).iGameNo = ilOrigGameNo)) Then
                                                            If ((llDate >= tmWkDef(ilWkIndex).lWkSDate) And (llDate <= tmWkDef(ilWkIndex).lWkEDate) And (tmWkDef(ilWkIndex).iGameNo = 0) And (ilOrigGameNo = 0)) Or ((tmWkDef(ilWkIndex).iGameNo > 0) And (tmWkDef(ilWkIndex).iGameNo = ilGameNoForWkNo)) Then
                                                                ilFound = True
                                                                If Not tmWkDef(ilWkIndex).iWkShown Then
                                                                    tmWkDef(ilWkIndex).iWkShown = True
                                                                    'Code later: get price from week- if mg get from original week which might not
                                                                    'be within tmWkDef
                                                                    'slWkPrice = tmWkDef(ilWkIndex).sWkPrice
                                                                    If tmWkDef(ilWkIndex).iGameNo > 0 Then
                                                                        tmIvr.iWkNo = ilGameNoForWkNo
                                                                        mGetTeams tmClf.iVefCode, tmWkDef(ilWkIndex).iGameNo, llDate, smVisitTeam, smHomeTeam, smAbbrVisitTeam, smAbbrHomeTeam
                                                                        tmIvr.sODPName = ""
                                                                        tmIvr.sODays = smAbbrVisitTeam & " @" & smAbbrHomeTeam
                                                                    Else
                                                                        tmIvr.iWkNo = tmIvr.iWkNo + 1
                                                                        tmIvr.sODays = Trim$(tmWkDef(ilWkIndex).sDays)
                                                                    End If
                                                                    tmIvr.lONoSpots = Val(Trim$(tmWkDef(ilWkIndex).sNoSpots))
                                                                    tmIvr.sORate = Trim$(tmWkDef(ilWkIndex).sWkPrice)
                                                                    'EDI Flight Info
                                                                    mRemovePriorEDI41WOSpots ilEDIUpper, ilEDIFirstLineIndex
                                                                    smEDIRecords(ilEDIUpper) = "41;" & Trim$(str$(tmClf.iLine)) & ";" & tmWkDef(ilWkIndex).sEDIDays & ";" & slEDISTime & ";" & slEDIETime & ";;" & Trim$(tmWkDef(ilWkIndex).sEDIRate) & ";" & Trim$(tmWkDef(ilWkIndex).sNoSpots) & ";" & "" & ";" & "" & ";"
                                                                    ilEDIUpper = ilEDIUpper + 1
                                                                    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                                    If ilEDIFirstLineIndex = ilEDIUpper - 1 Then
                                                                        smEDIRecords(ilEDIUpper) = "42;" & Trim$(tmVef.sName) & ";"
                                                                        ilEDIUpper = ilEDIUpper + 1
                                                                        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                                    End If
                                                                End If
                                                                Exit For
                                                            End If
                                                        Next ilWkIndex
                                                        If Not ilFound Then
                                                            tmIvr.sODays = ""
                                                            tmIvr.lONoSpots = 0
                                                            tmIvr.sORate = slOrderedPrice
                                                        End If
                                                    End If
                                                    'Spot Price
                                                    If (tmSdf.sSpotType <> "X") And (tmSdf.sSpotType <> "O") And (tmSdf.sSpotType <> "C") Then
                                                        ilRet = gGetFlightPrice(tmSdf, tmSpotClf, hmCff, hmSmf, slAiredPrice)
                                                        If tgSortKey(llSdfIndex).iLineNo = -2 Then
                                                            slAiredPrice = "0.00"
                                                        End If
                                                        If (tmSdf.sPriceType = "N") Then
                                                            If gCompNumberStr(slAiredPrice, "0.00") <> 0 Then
                                                                slAiredPrice = "N/C"
                                                                slEDIAirRate = "0"
                                                            Else
                                                                If (tmVef.sType = "V") And ((imVirtBillMethod = 1) Or (imVirtBillMethod = 2)) Then
                                                                    slAiredPrice = gVirtVefSpotPrice(hmVef, hmVsf, tmSpotClf.iVefCode, tmSmf.iOrigSchVef, slAiredPrice)
                                                                Else
                                                                    slAiredPrice = slAiredPrice 'slWkPrice
                                                                End If
                                                                slEDIAirRate = slAiredPrice
                                                            End If
                                                        ElseIf (tmSdf.sPriceType = "P") Then
                                                            slAiredPrice = "N/C"
                                                            slEDIAirRate = "0"
                                                        Else
                                                            If (tmVef.sType = "V") And ((imVirtBillMethod = 1) Or (imVirtBillMethod = 2)) Then
                                                                slAiredPrice = gVirtVefSpotPrice(hmVef, hmVsf, tmSpotClf.iVefCode, tmSmf.iOrigSchVef, slAiredPrice)
                                                            Else
                                                                slAiredPrice = slAiredPrice 'slWkPrice
                                                            End If
                                                            slEDIAirRate = slAiredPrice
                                                        End If
                                                        slFlightPrice = slAiredPrice
                                                    Else
                                                        If tmSdf.sSpotType = "O" Then
                                                            slAiredPrice = Trim$(str$(tmSdf.iLen)) & """" & " Open BB"
                                                        ElseIf tmSdf.sSpotType = "C" Then
                                                            slAiredPrice = Trim$(str$(tmSdf.iLen)) & """" & " Close BB"
                                                        Else
                                                            slAiredPrice = "Bonus"
                                                        End If
                                                        slEDIAirRate = "0"
                                                        If imExportCntr Then
                                                            If tgSortKey(llSdfIndex).iLineNo <> -2 Then
                                                                slStr = tmSdf.sSpotType
                                                                'gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llSvSpotDate
                                                                gUnpackDateLongError tmSdf.iDate(0), tmSdf.iDate(1), llSvSpotDate, "38:mInvoiceRpt " & tmSdf.lCode
                                                                slSvSchStatus = tmSdf.sSchStatus
                                                                tmSdf.sSpotType = "A"
                                                                tmSdf.sSchStatus = "S"
                                                                tmSpotClf = tmClf
                                                                If (tmClf.sType = "A") Or ((tmClf.sType = "E") And (tgSpf.sInvAirOrder = "2")) Then   '((tmClf.sType = "E") And (tgSortKey(llSdfIndex).iType = 2)) Then   'Aired
                                                                    For ilLine = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                                                                        If tgClfInv(ilLine).ClfRec.iLine = tgSortKey(llSdfIndex).iLineNo Then
                                                                            If (tmClf.iLine = tgClfInv(ilLine).ClfRec.iPkLineNo) Or (tmClf.iLine = tgClfInv(ilLine).ClfRec.iLine) Then
                                                                                tmSpotClf = tgClfInv(ilLine).ClfRec
                                                                                Exit For
                                                                            End If
                                                                            'Exit For
                                                                        End If
                                                                    Next ilLine
                                                                End If
                                                                ilLine = 0
                                                                Do
                                                                    ilRet = gGetFlightPrice(tmSdf, tmSpotClf, hmCff, hmSmf, slFlightPrice)
                                                                    If ilRet Then
                                                                        Exit Do
                                                                        'Backup week until price found
                                                                    End If
                                                                    'gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llSpotDate
                                                                    llSpotDate = llSvSpotDate
                                                                    ilLine = ilLine + 7
                                                                    gPackDateLong llSpotDate - ilLine, tmSdf.iDate(0), tmSdf.iDate(1)
                                                                    If ilLine > 56 Then
                                                                        Exit Do
                                                                    End If
                                                                Loop While ilRet = False
                                                                gPackDateLong llSvSpotDate, tmSdf.iDate(0), tmSdf.iDate(1)
                                                                tmSdf.sSchStatus = slSvSchStatus
                                                                tmSdf.sSpotType = slStr
                                                            Else
                                                                slFlightPrice = "0.00"
                                                            End If
                                                        End If
                                                    End If
                                                    If (Left$(slEDIAirRate, 1) < "0") Or (Left$(slEDIAirRate, 1) > "9") Then
                                                        slEDIAirRate = "0"
                                                    End If
                                                    If (Not ilBonusSpot) And (tmSdf.sSpotType <> "X") And (tmSdf.sSpotType <> "O") And (tmSdf.sSpotType <> "C") Then
                                                        If (tmVef.sType = "V") And ((imVirtBillMethod = 1) Or (imVirtBillMethod = 2)) Then
                                                            If InStr(slAiredPrice, ".") > 0 Then
                                                                slAiredPrice = ""
                                                                If (tmSdf.sSchStatus = "S") Then    'Assign price to first spot
                                                                    slEDIAirRate = slTotalVirtVehRate   '"0"
                                                                    slTotalVirtVehRate = "0"
                                                                Else
                                                                    slEDIAirRate = "0"
                                                                End If
                                                            End If
                                                        End If
                                                        slStr = slEDIAirRate
                                                        ilPos = InStr(slStr, ".")
                                                        If ilPos > 0 Then
                                                            slEDIAirRate = Left$(slStr, ilPos - 1) & Mid$(slStr, ilPos + 1)
                                                        End If
                                                        If (((tgSpf.sInvAirOrder = "O") And (rbcType(INVGEN_Aff).Value <> True)) Or (tgSpf.sInvAirOrder = "S")) And ((tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) Then
                                                            gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                                            ilVefCode = tmClf.iVefCode
                                                        Else
                                                            ilVefCode = tmSdf.iVefCode
                                                            If tmSdf.sXCrossMidnight <> "Y" Then
                                                                gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                                            Else
                                                                gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                                                '5/22/14: Adjust the airing date
                                                                'slDate = gIncOneDay(slDate)
                                                                slDate = mAdjXMidnightDate(slDate, "", True, blAddComment52)
                                                            End If
                                                        End If
                                                        llDate = gDateValue(slDate)
                                                        ilEDIDay = gWeekDayLong(llDate) + 1 '1=Monday;..;7=Sunday
                                                        slEDIAirDate = Format$(llDate, "yymmdd")
                                                        tmIvr.sADayDate = mFormatAirDateColumn(ilVefCode, slDate)   'Trim$(Left$(Format$(llDate, "ddd"), 2) & ", " & slDate)
                                                        If (tmClf.sType = "O") And (tmAdf.sPkInvShow = "D") And (tmAgf.sPkInvShow = "D") Then
                                                            tmIvr.sATime = slStrTime
                                                            gUnpackTimeLong tmSdf.iTime(0), tmSdf.iTime(1), False, llTime
                                                            slTime = gFormatTimeLong(llTime, "A", "1")
                                                            slEDIAirTime = gFormatTime(slTime, "M", "2")
                                                            mAdjEDIDateTime tmSdf.iVefCode, slDate, slTime, ilEDIDay, slEDIAirDate, slEDIAirTime
                                                        Else
                                                            If (((tgSpf.sInvAirOrder = "O") And (rbcType(INVGEN_Aff).Value <> True)) Or (tgSpf.sInvAirOrder = "S")) And ((tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) Then
                                                                gUnpackTimeLong tmSmf.iMissedTime(0), tmSmf.iMissedTime(1), False, llTime
                                                            Else
                                                                gUnpackTimeLong tmSdf.iTime(0), tmSdf.iTime(1), False, llTime
                                                            End If
                                                            If (tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                                                                If (ilPrevVeh = tmSdf.iVefCode) And (llPrevDate = llDate) And (llPrevTime = llTime) Then
                                                                    If slShowTime = "S" Then
                                                                        'llTime = mGetAirTime(llTime, ilPrevLen)
                                                                        llTime = mAdjAirTime(llStartSortIndex, llEndSortIndex, llSdfIndex, llTime, ilPrevLen)
                                                                        ilPrevLen = ilPrevLen + tmSdf.iLen
                                                                    ElseIf slShowTime = "H" Then
                                                                        llTime = llTime + 3600  'Add hour
                                                                    End If
                                                                Else
                                                                    ilPrevVeh = tmSdf.iVefCode
                                                                    llPrevDate = llDate
                                                                    llPrevTime = llTime
                                                                    ilPrevLen = tmSdf.iLen
                                                                    If slShowTime = "S" Then
                                                                        'llTime = mGetAirTime(llTime, ilPrevLen)
                                                                        llTime = mAdjAirTime(llStartSortIndex, llEndSortIndex, llSdfIndex, llTime, ilPrevLen)
                                                                        ilPrevLen = ilPrevLen + tmSdf.iLen
                                                                    End If
                                                                End If
                                                            End If
                                                            slTime = gFormatTimeLong(llTime, "A", "1")
                                                            'gUnpackTime tmSdf.iTime(0), tmSdf.iTime(1), "A", "1", slTime
                                                            slEDIAirTime = gFormatTime(slTime, "M", "2")
                                                            If (((tgSpf.sInvAirOrder = "O") And (rbcType(INVGEN_Aff).Value <> True)) Or (tgSpf.sInvAirOrder = "S")) And ((tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) Then
                                                                mAdjEDIDateTime tmSmf.iOrigSchVef, slDate, slTime, ilEDIDay, slEDIAirDate, slEDIAirTime
                                                            Else
                                                                mAdjEDIDateTime tmSdf.iVefCode, slDate, slTime, ilEDIDay, slEDIAirDate, slEDIAirTime
                                                            End If
                                                            If slShowTime <> "D" Then
                                                                slStr1 = slTime
                                                            Else
                                                                slStr1 = slDPAirTime    'slStrTime   'slStr
                                                            End If
                                                            tmIvr.sATime = Trim$(slStr1)
                                                        End If
                                                        If (tgSpf.sInvAirOrder = "O") And (tgSpf.sBLaserForm = "2") And ((tmSdf.sSchStatus = "M") Or (tmSdf.sSchStatus = "U") Or (tmSdf.sSchStatus = "R") Or (tmSdf.sSchStatus = "C")) Then
                                                            'Adjust price only
                                                            If rbcType(INVGEN_Aff).Value Then    'Affidavit
                                                            Else
                                                                If (InStr(slAiredPrice, ".") > 0) And (ilUpdateIndex >= 0) Then
                                                                    If (ilPass = 1) And (Val(slPctTrade) <> 0) Then
                                                                        slAiredPrice = gDivStr(gMulStr(slAiredPrice, gSubStr("100", slPctTrade)), "100")
                                                                    ElseIf (ilPass = 2) And (Val(slPctTrade) <> 100) Then
                                                                        slAiredPrice = gSubStr(slAiredPrice, gDivStr(gMulStr(slAiredPrice, gSubStr("100", slPctTrade)), "100"))
                                                                    End If
                                                                    slTotalAirRate = gAddStr(slTotalAirRate, slAiredPrice)
                                                                    slEDITotalAirRate = gAddStr(slEDITotalAirRate, slAiredPrice)
                                                                    tgRvfByVef(ilUpdateIndex).sTotalGross = gAddStr(tgRvfByVef(ilUpdateIndex).sTotalGross, slAiredPrice)
                                                                End If
                                                            End If
                                                            tmIvr.sATime = ""
                                                            tmIvr.sARate = ""
                                                        ElseIf ((tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") And ((tmSdf.sSchStatus = "M") Or (tmSdf.sSchStatus = "U") Or (tmSdf.sSchStatus = "R"))) Or (tmSdf.sSchStatus = "C") Then
                                                            tmIvr.sATime = ""
                                                            tmIvr.sARate = ""
                                                        Else
                                                            If (tgSortKey(llSdfIndex).iBillMissed) Then
                                                                tmIvr.sATime = ""
                                                            End If
                                                            If (tmVef.sType = "V") And ((imVirtBillMethod = 1) Or (imVirtBillMethod = 2)) Then
                                                                slTotalAirCount = gAddStr(slTotalAirCount, "1")
                                                                mIncCountsForCntrExport tmSdf.iVefCode, False, slFlightPrice
                                                            Else
                                                                If (tgSpf.sBLaserForm = "3") Then
                                                                    If ((tgSpf.sInvAirOrder <> "2") And (tgSpf.sInvAirOrder <> "A")) Or ((tgSpf.sInvAirOrder = "2") And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Or ((tgSpf.sInvAirOrder = "2") And (ilBonusSpot)) Or ((tgSpf.sInvAirOrder = "A") And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Or ((tgSpf.sInvAirOrder = "A") And (ilBonusSpot)) Then
                                                                        If ((tgSpf.sInvAirOrder <> "2") And (tgSpf.sInvAirOrder <> "A")) Or ((tgSpf.sInvAirOrder = "2") And (tgSortKey(llSdfIndex).iType = 0)) Or ((tgSpf.sInvAirOrder = "2") And (ilBonusSpot)) Or ((tgSpf.sInvAirOrder = "A") And (tgSortKey(llSdfIndex).iType = 0)) Or ((tgSpf.sInvAirOrder = "A") And (ilBonusSpot)) Then
                                                                            slTotalAirCount = gAddStr(slTotalAirCount, "1")
                                                                            mIncCountsForCntrExport tmSdf.iVefCode, False, slFlightPrice
                                                                        ElseIf (tgSortKey(llSdfIndex).iType = 2) And (tmClf.sType = "O") Then
                                                                            mIncCountsForCntrExport tmSdf.iVefCode, False, slFlightPrice
                                                                            slTotalAirCount = gAddStr(slTotalAirCount, "1")
                                                                        End If
                                                                        'xx
                                                                        If (InStr(slAiredPrice, ".") > 0) And (ilUpdateIndex >= 0) Then
                                                                            If (ilPass = 1) And (Val(slPctTrade) <> 0) Then
                                                                                slAiredPrice = gDivStr(gMulStr(slAiredPrice, gSubStr("100", slPctTrade)), "100")
                                                                            ElseIf (ilPass = 2) And (Val(slPctTrade) <> 100) Then
                                                                                slAiredPrice = gSubStr(slAiredPrice, gDivStr(gMulStr(slAiredPrice, gSubStr("100", slPctTrade)), "100"))
                                                                            End If
                                                                            slTotalAirRate = gAddStr(slTotalAirRate, slAiredPrice)
                                                                            slEDITotalAirRate = gAddStr(slEDITotalAirRate, slAiredPrice)
                                                                            tgRvfByVef(ilUpdateIndex).sTotalGross = gAddStr(tgRvfByVef(ilUpdateIndex).sTotalGross, slAiredPrice)
                                                                        End If
                                                                        tmIvr.sARate = slAiredPrice
                                                                    End If
                                                                Else
                                                                    'LaserForm = 2 is for Shadow and Traffic.Com only (both are to print the same, Shadow we update via ordered, Traffic.com update via Aired
                                                                    'Shadow uses InvAirOrder = 2 and Traffic.Com uses = O
                                                                    'If (tgSpf.sInvAirOrder <> "2") Or ((tgSpf.sInvAirOrder = "2") And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Or ((tgSpf.sInvAirOrder = "2") And (ilBonusSpot)) Then
                                                                    If (tgSpf.sBLaserForm <> "2") Or ((tgSpf.sBLaserForm = "2") And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Or ((tgSpf.sBLaserForm = "2") And (ilBonusSpot)) Or ((tgSpf.sBLaserForm = "2") And ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) And (tmSdf.sSchStatus = "M") And (rbcType(INVGEN_Preliminary).Value Or rbcType(INVGEN_Final).Value Or rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value)) Then         '11-15-16 test for prelim, reprint or archive
                                                                        'If ((tgSpf.sInvAirOrder <> "2")) Or ((tgSpf.sInvAirOrder = "2") And (tgSortKey(llSdfIndex).iType = 0)) Or ((tgSpf.sInvAirOrder = "2") And (ilBonusSpot)) Then
                                                                        If Not rbcType(INVGEN_Aff).Value Then
                                                                            If ((tgSpf.sBLaserForm <> "2")) Or ((tgSpf.sBLaserForm = "2") And (tgSortKey(llSdfIndex).iType = 0)) Or ((tgSpf.sBLaserForm = "2") And (ilBonusSpot)) Or ((tgSpf.sBLaserForm = "2") And ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S"))) Then
                                                                                slTotalAirCount = gAddStr(slTotalAirCount, "1")
                                                                                mIncCountsForCntrExport tmSdf.iVefCode, False, slFlightPrice
                                                                            End If
                                                                        Else
                                                                            If ((tgSpf.sBLaserForm <> "2") And (tgSpf.sBLaserForm <> "3")) Or ((tgSpf.sBLaserForm = "2") And (tgSortKey(llSdfIndex).iType = 0) And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Or ((tgSpf.sBLaserForm = "2") And ((ilBonusSpot) Or (tmSdf.sSpotType = "X") Or (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C"))) Or ((tgSpf.sBLaserForm = "3") And ((tgSortKey(llSdfIndex).iType = 0) Or (tgSortKey(llSdfIndex).iType = 1)) And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Or ((tgSpf.sBLaserForm = "3") And ((ilBonusSpot) Or (tmSdf.sSpotType = "X") Or (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C"))) Then
                                                                                slTotalAirCount = gAddStr(slTotalAirCount, "1")
                                                                                mIncCountsForCntrExport tmSdf.iVefCode, False, slFlightPrice
                                                                            End If
                                                                        End If
                                                                        'xx
                                                                        If (InStr(slAiredPrice, ".") > 0) And (ilUpdateIndex >= 0) Then
                                                                            If (ilPass = 1) And (Val(slPctTrade) <> 0) Then
                                                                                slAiredPrice = gDivStr(gMulStr(slAiredPrice, gSubStr("100", slPctTrade)), "100")
                                                                            ElseIf (ilPass = 2) And (Val(slPctTrade) <> 100) Then
                                                                                slAiredPrice = gSubStr(slAiredPrice, gDivStr(gMulStr(slAiredPrice, gSubStr("100", slPctTrade)), "100"))
                                                                            End If
                                                                            slTotalAirRate = gAddStr(slTotalAirRate, slAiredPrice)
                                                                            slEDITotalAirRate = gAddStr(slEDITotalAirRate, slAiredPrice)
                                                                            tgRvfByVef(ilUpdateIndex).sTotalGross = gAddStr(tgRvfByVef(ilUpdateIndex).sTotalGross, slAiredPrice)
                                                                        End If
                                                                        tmIvr.sARate = slAiredPrice
                                                                    End If
                                                                End If
                                                            End If
                                                        End If
                                                    Else
                                                        If tmSdf.sXCrossMidnight <> "Y" Then
                                                            gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                                        Else
                                                            gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                                            '5/22/14: Adjust the airing date
                                                            'slDate = gIncOneDay(slDate)
                                                            slDate = mAdjXMidnightDate(slDate, "", True, blAddComment52)
                                                        End If
                                                        llDate = gDateValue(slDate)
                                                        ilEDIDay = gWeekDayLong(llDate) + 1 '1=Monday;..;7=Sunday
                                                        slEDIAirDate = Format$(llDate, "yymmdd")
                                                        tmIvr.sADayDate = mFormatAirDateColumn(tmSdf.iVefCode, slDate)   'Trim$(Left$(Format$(llDate, "ddd"), 2) & ", " & slDate)
                                                        'gUnpackTimeLong tmSdf.iTime(0), tmSdf.iTime(1), False, llTime
                                                        ilRet = gParseItem(tgSortKey(llSdfIndex).sKey, 12, "|", slStr)
                                                        llTime = Val(slStr)
                                                        If (ilPrevVeh = tmSdf.iVefCode) And (llPrevDate = llDate) And (llPrevTime = llTime) Then
                                                            If slShowTime = "S" Then
                                                                'llTime = mGetAirTime(llTime, ilPrevLen)
                                                                llTime = mAdjAirTime(llStartSortIndex, llEndSortIndex, llSdfIndex, llTime, ilPrevLen)
                                                                ilPrevLen = ilPrevLen + tmSdf.iLen
                                                            ElseIf slShowTime = "H" Then
                                                                llTime = llTime + 3600  'Add hour
                                                            End If
                                                        Else
                                                            ilPrevVeh = tmSdf.iVefCode
                                                            llPrevDate = llDate
                                                            llPrevTime = llTime
                                                            ilPrevLen = tmSdf.iLen
                                                            If slShowTime = "S" Then
                                                                'llTime = mGetAirTime(llTime, ilPrevLen)
                                                                llTime = mAdjAirTime(llStartSortIndex, llEndSortIndex, llSdfIndex, llTime, ilPrevLen)
                                                                ilPrevLen = ilPrevLen + tmSdf.iLen
                                                            End If
                                                        End If
                                                        slTime = gFormatTimeLong(llTime, "A", "1")
                                                        'gUnpackTime tmSdf.iTime(0), tmSdf.iTime(1), "A", "1", slTime
                                                        slEDIAirTime = gFormatTime(slTime, "M", "2")
                                                        mAdjEDIDateTime tmSdf.iVefCode, slDate, slTime, ilEDIDay, slEDIAirDate, slEDIAirTime
                                                        If slShowTime <> "D" Then
                                                            slStr1 = slTime
                                                        Else
                                                            slStr1 = slDPAirTime    'slStrTime   'slStr
                                                        End If
                                                        tmIvr.sATime = Trim$(slStr1)
                                                        'Only increment for Bonus spots
                                                        If (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C") Then
                                                            'If tgSpf.sBLaserForm <> "1" Then
                                                            '    slTotalAirCount = gAddStr(slTotalAirCount, "1")
                                                            '    mIncCountsForCntrExport tmSdf.iVefCode, True, slFlightPrice
                                                            'End If
                                                        Else
                                                            slTotalAirCount = gAddStr(slTotalAirCount, "1")
                                                            mIncCountsForCntrExport tmSdf.iVefCode, True, slFlightPrice
                                                        End If
                                                        If tmSdf.sSpotType = "O" Then
                                                            slStr1 = Trim$(str$(tmSdf.iLen)) & """" & " Open BB"
                                                        ElseIf tmSdf.sSpotType = "C" Then
                                                            slStr1 = Trim$(str$(tmSdf.iLen)) & """" & " Close BB"
                                                        Else
                                                            slStr1 = "Bonus"
                                                            tmIvr.iLen = tmSdf.iLen
                                                        End If
                                                        tmIvr.sARate = slStr1
                                                    End If
                                                    If (tgSortKey(llSdfIndex).iBillMissed) Or (tmSdf.sSchStatus = "C") Then
                                                        For ilLoop = LBound(slCopy) To UBound(slCopy) Step 1
                                                            slCopy(ilLoop) = ""
                                                            slCopyProduct(ilLoop) = ""
                                                        Next ilLoop
                                                        ilShowISCI = True
                                                        slStr = ""
                                                        For ilLoop = LBound(tgMRMnf) To UBound(tgMRMnf) - 1 Step 1
                                                            If tmSdf.iMnfMissed = tgMRMnf(ilLoop).iCode Then
                                                                '12/14/15: Include cancel without requiring it be set as bill cancelled
                                                                If (tgMRMnf(ilLoop).iGroupNo = 2) Or (tmSdf.sSchStatus = "C") Then
                                                                    slStr = Trim$(tgMRMnf(ilLoop).sName)
                                                                    'slCopy(LBound(slCopy)) = slStr
                                                                    slCopy(LBONE) = slStr
                                                                End If
                                                                Exit For
                                                            End If
                                                        Next ilLoop
                                                    Else
                                                        mObtainCopy slCopyProduct(), slCopy()
                                                        ilShowISCI = False
                                                        slStr = ""
                                                        If tmChf.iAgfCode > 0 Then
                                                            If (tmAgf.sShowISCI = "Y" Or tmAgf.sShowISCI = "W") Or (tmAdf.sShowISCI = "Y" Or tmAdf.sShowISCI = "W") Then        '3-10-15  show isci (W) on invoice without leader hard-coded prefix of WW_
                                                                ilShowISCI = True
                                                                If Trim$(slCopy(1)) <> "" Then
                                                                    If tmAgf.sShowISCI = "W" Or tmAdf.sShowISCI = "W" Then          '3-10-15 allow isci to truncate hard-coded ww_
                                                                        If InStr(1, Trim$(slCopy(1)), "WW_", 1) = 1 Then 'compares, remove "WW_" prefix
                                                                            slCopy(1) = Mid$(slCopy(1), 4)
                                                                        End If
                                                                    End If
                                                                    If StrComp(Trim$(slCopyProduct(1)), Trim$(tmChf.sProduct), 1) = 0 Then
                                                                        slStr = slCopy(1)
                                                                    Else
                                                                        slStr = slCopy(1) & " " & slCopyProduct(1)
                                                                    End If
                                                                End If
                                                            End If
                                                        Else
                                                            If tmAdf.sShowISCI = "Y" Or tmAdf.sShowISCI = "W" Then      '3-10-15  show isci (W) on invoice without leader hard-coded prefix of WW_
                                                                ilShowISCI = True
                                                                If Trim$(slCopy(1)) <> "" Then
                                                                    If tmAdf.sShowISCI = "W" Then                   '3-10-15  show isci (W) on invoice without leader hard-coded prefix of WW_
                                                                        If InStr(1, Trim$(slCopy(1)), "WW_", 1) = 1 Then 'compares, remove "WW_" prefix
                                                                            slCopy(1) = Mid$(slCopy(1), 4)
                                                                        End If
                                                                    End If
                                                                    If StrComp(Trim$(slCopyProduct(1)), Trim$(tmChf.sProduct), 1) = 0 Then
                                                                        slStr = slCopy(1)
                                                                    Else
                                                                        slStr = slCopy(1) & " " & slCopyProduct(1)
                                                                    End If
                                                                End If
                                                            End If
                                                        End If
                                                    End If
                                                    'tmIvr.sACopy(1) = slStr
                                                    tmIvr.sACopy(0) = slStr
                                                    If (Not ilBonusSpot) And (tmSdf.sSpotType <> "X") And (tmSdf.sSpotType <> "O") And (tmSdf.sSpotType <> "C") Then
                                                        slStr = ""
                                                        If ilEDIFlag Then
                                                            ilCopyIndex = LBONE 'LBound(slCopy)
                                                            If ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) Or (((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) And ((tmSdf.sSchStatus = "M") Or (tmSdf.sSchStatus = "U") Or (tmSdf.sSchStatus = "R"))) Then
                                                                mAdd41IfMissing tmSdf, ilEDIUpper
                                                                smEDIRecords(ilEDIUpper) = "51;" & "Y;" & slEDIAirDate & ";" & Trim$(str$(ilEDIDay)) & ";" & slEDIAirTime & ";" & Trim$(str$(tmClf.iLen)) & ";"
                                                                slStr = ""
                                                                If ilShowISCI Then
                                                                    'For ilZone = LBound(slCopy) To UBound(slCopy) Step 1  'Add two zones together- separated by space
                                                                    For ilZone = LBONE To UBound(slCopy) Step 1  'Add two zones together- separated by space
                                                                        If Trim$(slCopy(ilZone)) <> "" Then
                                                                            If slStr <> "" Then
                                                                                If Len(slStr & " " & slCopy(ilZone)) > 30 Then
                                                                                    Exit For
                                                                                End If
                                                                                ilCopyIndex = ilZone + 1
                                                                                slStr = slStr & " " & slCopy(ilZone)
                                                                                Exit For
                                                                            Else
                                                                                ilCopyIndex = ilZone + 1
                                                                                slStr = slCopy(ilZone)
                                                                            End If
                                                                        End If
                                                                    Next ilZone
                                                                End If
                                                                smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slStr & ";" & slEDIAirRate & ";"
                                                            Else

                                                                smEDIRecords(ilEDIUpper) = "51;" & "N;" & slEDIAirDate & ";" & Trim$(str$(ilEDIDay)) & ";" & slEDIAirTime & ";" & Trim$(str$(tmClf.iLen)) & ";;" & slEDIAirRate & ";"
                                                            End If

                                                            If ((tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") And (tmSdf.sSchStatus = "G")) Or ((tgSpf.sBLaserForm = "2") And (tmSdf.sSchStatus = "G")) Then
                                                                slEDIMissedDate = ""
                                                                slEDIMissedTime = ""
                                                                gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                                                slEDIMissedDate = Format$(gDateValue(slDate), "yymmdd")
                                                                gUnpackTime tmSmf.iMissedTime(0), tmSmf.iMissedTime(1), "A", "1", slTime
                                                                slEDIMissedTime = gFormatTime(slTime, "M", "2")
                                                                If slEDIMissedDate = "" Then
                                                                    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";;;;;;;;;;N;"
                                                                Else
                                                                    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";;" & slEDIMissedDate & ";;;;;;;;N;"
                                                                End If
                                                            Else
                                                                smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";;;;;;;;;;N;"
                                                            End If
                                                            mEDIByVehSort ilEDIFlag, llSdfIndex
                                                            ilEDIUpper = ilEDIUpper + 1
                                                            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                            '10/15/16: Add MG vehicle to handle case where MG on different vehicles and in non-airing week
                                                            If ((tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") And (tmSdf.sSchStatus = "G")) Or ((tgSpf.sBLaserForm = "2") And (tmSdf.sSchStatus = "G")) Then
                                                                ilRet = gBinarySearchVef(tmSdf.iVefCode)
                                                                If ilRet <> -1 Then
                                                                    smEDIRecords(ilEDIUpper) = "52;" & "MG on " & Trim$(tgMVef(ilRet).sName) & ";"
                                                                    ilEDIUpper = ilEDIUpper + 1
                                                                    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                                End If
                                                            End If
                                                            slStr = ""
                                                            If ilShowISCI Then
                                                                For ilZone = ilCopyIndex To UBound(slCopy) Step 1  'Show one zone because of space (20 char only)
                                                                    If Trim$(slCopy(ilZone)) <> "" Then
                                                                        slStr = slCopy(ilZone)
                                                                        smEDIRecords(ilEDIUpper) = "52;" & Left$(slStr, 20) & ";"
                                                                        ilEDIUpper = ilEDIUpper + 1
                                                                        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                                    End If
                                                                Next ilZone
                                                            End If
                                                                                                                      
                                                            '5/22/14: Add Midnight comment is required
                                                            If blAddComment52 Then
                                                                smEDIRecords(ilEDIUpper) = "52;" & smXMidMsgReconc & ";"
                                                                ilEDIUpper = ilEDIUpper + 1
                                                                ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                            End If
                                                            
                                                        End If
                                                        slStr = ""
                                                        'If ((tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") And ((tmSdf.sSchStatus = "M") Or (tmSdf.sSchStatus = "U") Or (tmSdf.sSchStatus = "R") Or (tmSdf.sSchStatus = "G"))) Or (tmSdf.sSchStatus = "C") Then
                                                        If ((tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") And ((tmSdf.sSchStatus = "M") Or (tmSdf.sSchStatus = "U") Or (tmSdf.sSchStatus = "R") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Or (tmSdf.sSchStatus = "C") Then
                                                            If ((tmSdf.sSchStatus = "G")) And (tmSdf.iGameNo > 0) Then
                                                                'mGetTeams tmClf.iVefCode, tmSdf.iGameNo, smVisitTeam, smHomeTeam, smAbbrVisitTeam, smAbbrHomeTeam
                                                                gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llSDFDate
                                                                mGetTeams tmClf.iVefCode, tmSmf.iGameNo, llSDFDate, smVisitTeam, smHomeTeam, smAbbrVisitTeam, smAbbrHomeTeam
                                                            End If
                                                            If (tmSdf.sSchStatus = "G") Then
                                                                'Show missed date
                                                                'Obtain original dates
                                                                tmIvr.sRRemark = "MG"
                                                                gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                                                tmIvr.sRRemark = "MG for: " & Left$(slDate, Len(slDate) - 3)
                                                                If tmSdf.iGameNo > 0 Then
                                                                    If Trim$(smAbbrHomeTeam) <> "" Then     '6-7-17 if no team name found, theres extra @ , remove it
                                                                        tmIvr.sRRemark = RTrim$(tmIvr.sRRemark) & " " & smAbbrVisitTeam & " @" & smAbbrHomeTeam
                                                                    End If
                                                                End If
                                                                If (tmVef.sType = "V") And ((imVirtBillMethod = 1) Or (imVirtBillMethod = 2)) Then
                                                                Else
                                                                    tmIvr.sRAmount = slAiredPrice
                                                                    If InStr(slAiredPrice, ".") > 0 Then
                                                                        slTotalMissedRate = gAddStr(slTotalMissedRate, slAiredPrice)
                                                                        If (tgSpf.sInvAirOrder = "2") And (tmClf.sType = "S") Then
                                                                            slTotalMissedRateNonPkg = gAddStr(slTotalMissedRateNonPkg, slAiredPrice)
                                                                        End If
                                                                    Else
                                                                    End If
                                                                End If
                                                            ElseIf (tmSdf.sSchStatus = "O") Then
                                                                'If Outside missed from another billing period, set Reconcile amount
                                                                'gUnpackDateLong tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), llDate
                                                                gUnpackDateLongError tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), llDate, "39:mInvoiceRpt " & tmSmf.lCode
                                                                If ((tmChf.sBillCycle = "C") And ((llDate > lmEndCal) Or (llDate < lmStartCal))) Or ((tmChf.sBillCycle = "S") And ((llDate > lmEndStd) Or (llDate < lmStartStd))) Or ((tmChf.sBillCycle = "W") And ((llDate > lmEndWk) Or (llDate < lmStartWk))) Then
                                                                    If (tmVef.sType = "V") And ((imVirtBillMethod = 1) Or (imVirtBillMethod = 2)) Then
                                                                    Else
                                                                        tmIvr.sRAmount = slAiredPrice
                                                                        If InStr(slAiredPrice, ".") > 0 Then
                                                                            slTotalMissedRate = gAddStr(slTotalMissedRate, slAiredPrice)
                                                                            If (tgSpf.sInvAirOrder = "2") And (tmClf.sType = "S") Then
                                                                                slTotalMissedRateNonPkg = gAddStr(slTotalMissedRateNonPkg, slAiredPrice)
                                                                            End If
                                                                        Else
                                                                        End If
                                                                    End If
                                                                End If
                                                            Else
                                                                If (tmSdf.sSchStatus = "C") Then
                                                                    slStr1 = "Canceled"
                                                                Else
                                                                    slStr1 = "Missed"
                                                                End If
                                                                tmIvr.sRRemark = slStr1
                                                                If (tmVef.sType = "V") And ((imVirtBillMethod = 1) Or (imVirtBillMethod = 2)) Then
                                                                Else
                                                                    If InStr(slAiredPrice, ".") > 0 Then
                                                                        slStr = gVirtVefSpotPrice(hmVef, hmVsf, tmClf.iVefCode, tmSmf.iOrigSchVef, slAiredPrice)
                                                                        slStr1 = "-" & slStr 'slAiredPrice
                                                                        slTotalMissedRate = gSubStr(slTotalMissedRate, slStr)
                                                                        If (tgSpf.sInvAirOrder = "2") And (tmClf.sType = "S") Then
                                                                            slTotalMissedRateNonPkg = gSubStr(slTotalMissedRateNonPkg, slStr)
                                                                        End If
                                                                    Else
                                                                        slStr1 = slAiredPrice
                                                                    End If
                                                                    tmIvr.sRAmount = slStr1
                                                                End If
                                                            End If
                                                        '10/5/14
                                                        Else
                                                            If (imXMidHandle = 2) And (tmSdf.sXCrossMidnight = "Y") Then
                                                                If (tmChf.sBillCycle <> "C") And (tmChf.sBillCycle <> "W") Then
                                                                    gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                                                    If lmStartStd - 1 = gDateValue(slDate) Then
                                                                        tmIvr.sRRemark = "Scheduled before Midnight, Aired After"
                                                                        '10/23/14: Add message to EDI
                                                                        If ilEDIFlag Then
                                                                            smEDIRecords(ilEDIUpper) = "52;" & "Aired past midnight" & ";"
                                                                            ilEDIUpper = ilEDIUpper + 1
                                                                            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                                        End If
                                                                    End If
                                                                End If
                                                            End If
                                                        End If
                                                        mShowMGVehicle llSdfIndex, ilMGVehShown, tmInvRptVef
                                                        'Test if other copy zones defined, if so add to output
                                                        If (ilShowISCI) And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) Then
                                                            For ilZone = 2 To 6 Step 1
                                                                If Trim$(slCopy(ilZone)) <> "" Then
                                                                    ilMGVehShown = False
                                                                    If StrComp(Trim$(slCopyProduct(ilZone)), Trim$(tmChf.sProduct), 1) = 0 Then
                                                                        slStr1 = slCopy(ilZone)
                                                                    Else
                                                                        slStr1 = slCopy(ilZone) & " " & slCopyProduct(ilZone)
                                                                    End If
                                                                    'If tmIvr.sACopy(1) = "" Then
                                                                    '    tmIvr.sACopy(1) = Trim$(slStr1)
                                                                    'ElseIf tmIvr.sACopy(2) = "" Then
                                                                    '    tmIvr.sACopy(2) = Trim$(slStr1)
                                                                    'ElseIf tmIvr.sACopy(3) = "" Then
                                                                    '    tmIvr.sACopy(3) = Trim$(slStr1)
                                                                    'ElseIf tmIvr.sACopy(4) = "" Then
                                                                    '    tmIvr.sACopy(4) = Trim$(slStr1)
                                                                    'End If
                                                                    If tmIvr.sACopy(0) = "" Then
                                                                        tmIvr.sACopy(0) = Trim$(slStr1)
                                                                    ElseIf tmIvr.sACopy(1) = "" Then
                                                                        tmIvr.sACopy(1) = Trim$(slStr1)
                                                                    ElseIf tmIvr.sACopy(2) = "" Then
                                                                        tmIvr.sACopy(2) = Trim$(slStr1)
                                                                    ElseIf tmIvr.sACopy(3) = "" Then
                                                                        tmIvr.sACopy(3) = Trim$(slStr1)
                                                                    End If
                                                                End If
                                                            Next ilZone
                                                        End If
                                                        If (tgSpf.sBLaserForm = "2") Or (tgSpf.sBLaserForm = "3") Then
                                                            tmIvr.iLen = tmSdf.iLen
                                                        End If
                                                    Else
                                                        'Obtain vehicle name
                                                        ilRet = gParseItem(tgSortKey(llSdfIndex).sKey, 9, "|", slStr)
                                                        tmIvr.sRRemark = Trim$(slStr)
                                                        tmIvr.sRAmount = " "
                                                        If ilEDIFlag Then
                                                            smEDIRecords(ilEDIUpper) = "51;" & "Y;" & slEDIAirDate & ";" & Trim$(str$(ilEDIDay)) & ";" & slEDIAirTime & ";" & Trim$(str$(tgSortKey(llSdfIndex).iLen)) & ";"
                                                            ilCopyIndex = LBONE '1
                                                            slStr = ""
                                                            If ilShowISCI Then
                                                                For ilZone = LBONE To 6 Step 1  'Add two zones together- separated by space
                                                                    If Trim$(slCopy(ilZone)) <> "" Then
                                                                        If slStr <> "" Then
                                                                            If Len(slStr & " " & slCopy(ilZone)) > 30 Then
                                                                                Exit For
                                                                            End If
                                                                            ilCopyIndex = ilZone + 1
                                                                            slStr = slStr & " " & slCopy(ilZone)
                                                                            Exit For
                                                                        Else
                                                                            ilCopyIndex = ilZone + 1
                                                                            slStr = slCopy(ilZone)
                                                                        End If
                                                                    End If
                                                                Next ilZone
                                                            End If
                                                            smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slStr & ";" & slEDIAirRate & ";"
                                                            smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";;;;;;;;;;N;"
                                                            mEDIByVehSort ilEDIFlag, llSdfIndex
                                                            ilEDIUpper = ilEDIUpper + 1
                                                            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                            'Vehicle Name
                                                            smEDIRecords(ilEDIUpper) = "52;" & Left$(Trim$(tmIvr.sRRemark), 20) & ";"
                                                            ilEDIUpper = ilEDIUpper + 1
                                                            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                            slStr = ""
                                                            If ilShowISCI Then
                                                                For ilZone = ilCopyIndex To 6 Step 1  'Show one zone because of space (20 char only)
                                                                    If Trim$(slCopy(ilZone)) <> "" Then
                                                                        slStr = slCopy(ilZone)
                                                                        smEDIRecords(ilEDIUpper) = "52;" & Left$(slStr, 20) & ";"
                                                                        ilEDIUpper = ilEDIUpper + 1
                                                                        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                                    End If
                                                                Next ilZone
                                                            End If
                                                            
                                                            '5/22/14: Add Midnight comment is required
                                                            If blAddComment52 Then
                                                                smEDIRecords(ilEDIUpper) = "52;" & smXMidMsgReconc & ";"
                                                                ilEDIUpper = ilEDIUpper + 1
                                                                ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                            Else
                                                                '10/24/14
                                                                If (imXMidHandle = 2) And (tmSdf.sXCrossMidnight = "Y") Then
                                                                    If (tmChf.sBillCycle <> "C") And (tmChf.sBillCycle <> "W") Then
                                                                        gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                                                        If lmStartStd - 1 = gDateValue(slDate) Then
                                                                            'tmIvr.sRRemark = "Scheduled before Midnight, Aired After"
                                                                            '10/23/14: Add message to EDI
                                                                            smEDIRecords(ilEDIUpper) = "52;" & "Aired past midnight" & ";"
                                                                            ilEDIUpper = ilEDIUpper + 1
                                                                            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                                        End If
                                                                    End If
                                                                End If
                                                            End If
                                                                                                                    
                                                        End If
                                                        If (tgSpf.sBLaserForm = "2") Or (tgSpf.sBLaserForm = "3") Then
                                                            tmIvr.iLen = tmSdf.iLen
                                                            tmIvr.sAVehName = tmIvr.sRRemark
                                                        End If
                                                    End If
                                                Else
                                                    'Missed spot-> MG (Outside type spots not included except if missed within period and scheduled outside of period on Form 1 Airing)
                                                    '10/5/14
                                                    If (tgSortKey(llSdfIndex).iType = 3) Then
                                                        gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slDate
                                                        ilVefCode = tmSdf.iVefCode
                                                    Else
                                                        gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                                        ilVefCode = tmSmf.iOrigSchVef
                                                    End If
                                                    llDate = gDateValue(slDate)
                                                    ilFound = False
                                                    For ilWkIndex = LBound(tmWkDef) To UBound(tmWkDef) - 1 Step 1
                                                        If ((llDate >= tmWkDef(ilWkIndex).lWkSDate) And (llDate <= tmWkDef(ilWkIndex).lWkEDate) And (tmWkDef(ilWkIndex).iGameNo = 0) And (ilOrigGameNo = 0)) Or ((tmWkDef(ilWkIndex).iGameNo > 0) And (tmWkDef(ilWkIndex).iGameNo = ilGameNoForWkNo)) Then
                                                            ilFound = True
                                                            If Not tmWkDef(ilWkIndex).iWkShown Then
                                                                tmWkDef(ilWkIndex).iWkShown = True
                                                                'Code later: get price from week- if mg get from original week which might not
                                                                'be within tmWkDef
                                                                'slWkPrice = tmWkDef(ilWkIndex).sWkPrice
                                                                If tmWkDef(ilWkIndex).iGameNo > 0 Then
                                                                    tmIvr.iWkNo = ilGameNoForWkNo
                                                                    mGetTeams tmClf.iVefCode, tmWkDef(ilWkIndex).iGameNo, llDate, smVisitTeam, smHomeTeam, smAbbrVisitTeam, smAbbrHomeTeam
                                                                    tmIvr.sODPName = ""
                                                                    tmIvr.sODays = smAbbrVisitTeam & " @" & smAbbrHomeTeam
                                                                Else
                                                                    tmIvr.iWkNo = tmIvr.iWkNo + 1
                                                                    tmIvr.sODays = Trim$(tmWkDef(ilWkIndex).sDays)
                                                                End If
                                                                tmIvr.lONoSpots = Val(Trim$(tmWkDef(ilWkIndex).sNoSpots))
                                                                tmIvr.sORate = Trim$(tmWkDef(ilWkIndex).sWkPrice)
                                                                '10/15/16: Handle case where Missed part of the MG is the first spot
                                                                mRemovePriorEDI41WOSpots ilEDIUpper, ilEDIFirstLineIndex
                                                                smEDIRecords(ilEDIUpper) = "41;" & Trim$(str$(tmClf.iLine)) & ";" & tmWkDef(ilWkIndex).sEDIDays & ";" & slEDISTime & ";" & slEDIETime & ";;" & Trim$(tmWkDef(ilWkIndex).sEDIRate) & ";" & Trim$(tmWkDef(ilWkIndex).sNoSpots) & ";" & "" & ";" & "" & ";"
                                                                ilEDIUpper = ilEDIUpper + 1
                                                                ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                                If ilEDIFirstLineIndex = ilEDIUpper - 1 Then
                                                                    smEDIRecords(ilEDIUpper) = "42;" & Trim$(tmVef.sName) & ";"
                                                                    ilEDIUpper = ilEDIUpper + 1
                                                                    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                                End If
                                                            End If
                                                            Exit For
                                                        End If
                                                    Next ilWkIndex
                                                    If Not ilFound Then
                                                        tmIvr.sODays = ""
                                                        tmIvr.lONoSpots = 0
                                                        tmIvr.sORate = slOrderedPrice
                                                    End If
                                                    ''Spot Price
                                                    '10/23/14: Handle bonus spots
                                                    'ilRet = gGetFlightPrice(tmSdf, tmSpotClf, hmCff, hmSmf, slAiredPrice)
                                                    If (tmSdf.sSpotType = "X") And (tgSortKey(llSdfIndex).iType = 3) Then
                                                        slAiredPrice = "Bonus"
                                                    Else
                                                        ilRet = gGetFlightPrice(tmSdf, tmSpotClf, hmCff, hmSmf, slAiredPrice)
                                                    End If
                                                    slFlightPrice = slAiredPrice
                                                    ilEDIDay = gWeekDayLong(llDate) + 1 '1=Monday;..;7=Sunday
                                                    slEDIAirDate = Format$(llDate, "yymmdd")
                                                    tmIvr.sADayDate = mFormatAirDateColumn(ilVefCode, slDate)   'Trim$(Left$(Format$(llDate, "ddd"), 2) & ", " & slDate)
                                                    '10/23/14: Set time
                                                    'gUnpackTime tmSmf.iMissedTime(0), tmSmf.iMissedTime(1), "A", "1", slTime
                                                    'slEDIAirTime = gFormatTime(slTime, "M", "2")
                                                    'mAdjEDIDateTime tmSmf.iOrigSchVef, slDate, slTime, ilEDIDay, slEDIAirDate, slEDIAirTime
                                                    'If (tmClf.sType = "O") And (tmAdf.sPkInvShow = "D") And (tmAgf.sPkInvShow = "D") Then
                                                    '    slStr1 = slStrTime   'slStr
                                                    'Else
                                                    '    gUnpackTimeLong tmSmf.iMissedTime(0), tmSmf.iMissedTime(1), False, llTime
                                                    '    slTime = gFormatTimeLong(llTime, "A", "1")
                                                    '    'gUnpackTime tmSdf.iTime(0), tmSdf.iTime(1), "A", "1", slTime
                                                    '    If slShowTime <> "D" Then
                                                    '        slStr1 = slTime
                                                    '    Else
                                                    '        slStr1 = slStrTime   'slStr
                                                    '    End If
                                                    'End If
                                                    If (tgSortKey(llSdfIndex).iType = 3) Then
                                                        gUnpackTime tmSdf.iTime(0), tmSdf.iTime(1), "A", "1", slTime
                                                        slEDIAirTime = gFormatTime(slTime, "M", "2")
                                                        slStr1 = slTime
                                                    Else
                                                        gUnpackTime tmSmf.iMissedTime(0), tmSmf.iMissedTime(1), "A", "1", slTime
                                                        slEDIAirTime = gFormatTime(slTime, "M", "2")
                                                        mAdjEDIDateTime tmSmf.iOrigSchVef, slDate, slTime, ilEDIDay, slEDIAirDate, slEDIAirTime
                                                        If (tmClf.sType = "O") And (tmAdf.sPkInvShow = "D") And (tmAgf.sPkInvShow = "D") Then
                                                            slStr1 = slStrTime   'slStr
                                                        Else
                                                            gUnpackTimeLong tmSmf.iMissedTime(0), tmSmf.iMissedTime(1), False, llTime
                                                            slTime = gFormatTimeLong(llTime, "A", "1")
                                                            'gUnpackTime tmSdf.iTime(0), tmSdf.iTime(1), "A", "1", slTime
                                                            If slShowTime <> "D" Then
                                                                slStr1 = slTime
                                                            Else
                                                                slStr1 = slDPAirTime    'slStrTime   'slStr
                                                            End If
                                                        End If
                                                    End If
                                                    tmIvr.sATime = Trim$(slStr1)
                                                    tmIvr.sARate = ""
                                                    If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                                                        If (tmVef.sType = "V") And ((imVirtBillMethod = 1) Or (imVirtBillMethod = 2)) Then
                                                            slTotalAirCount = gAddStr(slTotalAirCount, "1")
                                                            mIncCountsForCntrExport tmSdf.iVefCode, False, slFlightPrice
                                                        Else
                                                            If Not rbcType(INVGEN_Aff).Value Then
                                                                slTotalAirCount = gAddStr(slTotalAirCount, "1")
                                                                mIncCountsForCntrExport tmSdf.iVefCode, False, slFlightPrice
                                                            Else
                                                                If ((tgSpf.sBLaserForm <> "2") And (tgSpf.sBLaserForm <> "3")) Or ((tgSpf.sBLaserForm = "2") And (tgSortKey(llSdfIndex).iType = 0) And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Or ((tgSpf.sBLaserForm = "2") And ((ilBonusSpot) Or (tmSdf.sSpotType = "X") Or (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C"))) Or ((tgSpf.sBLaserForm = "3") And ((tgSortKey(llSdfIndex).iType = 0) Or (tgSortKey(llSdfIndex).iType = 1)) And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Or ((tgSpf.sBLaserForm = "3") And ((ilBonusSpot) Or (tmSdf.sSpotType = "X") Or (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C"))) Then
                                                                    slTotalAirCount = gAddStr(slTotalAirCount, "1")
                                                                    mIncCountsForCntrExport tmSdf.iVefCode, False, slFlightPrice
                                                                End If
                                                            End If
                                                            If (InStr(slAiredPrice, ".") > 0) And (ilUpdateIndex >= 0) Then
                                                                If (ilPass = 1) And (Val(slPctTrade) <> 0) Then
                                                                    slAiredPrice = gDivStr(gMulStr(slAiredPrice, gSubStr("100", slPctTrade)), "100")
                                                                ElseIf (ilPass = 2) And (Val(slPctTrade) <> 100) Then
                                                                    slAiredPrice = gSubStr(slAiredPrice, gDivStr(gMulStr(slAiredPrice, gSubStr("100", slPctTrade)), "100"))
                                                                End If
                                                                slTotalAirRate = gAddStr(slTotalAirRate, slAiredPrice)
                                                                slEDITotalAirRate = gAddStr(slEDITotalAirRate, slAiredPrice)
                                                                tgRvfByVef(ilUpdateIndex).sTotalGross = gAddStr(tgRvfByVef(ilUpdateIndex).sTotalGross, slAiredPrice)
                                                            End If
                                                            tmIvr.sARate = Trim$(slAiredPrice)
                                                        End If
                                                        mObtainCopy slCopyProduct(), slCopy()
                                                        ilShowISCI = False
                                                        slStr = ""
                                                        If tmChf.iAgfCode > 0 Then
                                                            If (tmAgf.sShowISCI = "Y" Or tmAgf.sShowISCI = "W") Or (tmAdf.sShowISCI = "Y" Or tmAdf.sShowISCI = "W") Then   '3-10-15  show isci (W) on invoice without leader hard-coded prefix of WW_
                                                                ilShowISCI = True
                                                                If Trim$(slCopy(1)) <> "" Then
                                                                    If tmAgf.sShowISCI = "W" Or tmAdf.sShowISCI = "W" Then          '3-10-15  show isci (W) on invoice without leader hard-coded prefix of WW_
                                                                        If InStr(1, Trim$(slCopy(1)), "WW_", 1) = 1 Then 'compares, remove "WW_" prefix
                                                                            slCopy(1) = Mid$(slCopy(1), 4)
                                                                        End If
                                                                    End If
                                                                    If StrComp(Trim$(slCopyProduct(1)), Trim$(tmChf.sProduct), 1) = 0 Then
                                                                        slStr = slCopy(1)
                                                                    Else
                                                                        slStr = slCopy(1) & " " & slCopyProduct(1)
                                                                    End If
                                                                End If
                                                            End If
                                                        Else
                                                            If tmAdf.sShowISCI = "Y" Then
                                                                ilShowISCI = True
                                                                If Trim$(slCopy(1)) <> "" Then
                                                                    If tmAdf.sShowISCI = "W" Then                   '3-10-15  show isci (W) on invoice without leader hard-coded prefix of WW_
                                                                        If InStr(1, Trim$(slCopy(1)), "WW_", 1) = 1 Then 'compares, remove "WW_" prefix
                                                                            slCopy(1) = Mid$(slCopy(1), 4)
                                                                        End If
                                                                    End If
                                                                    If StrComp(Trim$(slCopyProduct(1)), Trim$(tmChf.sProduct), 1) = 0 Then
                                                                        slStr = slCopy(1)
                                                                    Else
                                                                        slStr = slCopy(1) & " " & slCopyProduct(1)
                                                                    End If
                                                                End If
                                                            End If
                                                        End If
                                                        'tmIvr.sACopy(1) = slStr
                                                        tmIvr.sACopy(0) = slStr
                                                    Else
                                                        tmIvr.sATime = ""
                                                        tmIvr.sARate = ""
                                                        '10/5/14
                                                        If (tgSortKey(llSdfIndex).iType = 3) Then
                                                            tmIvr.sRRemark = "Aired after Midnight, Bill next Month"
                                                        Else
                                                            gUnpackDate tmSmf.iActualDate(0), tmSmf.iActualDate(1), slDate
                                                            slEDIMGDate = Format$(gDateValue(slDate), "yymmdd")
                                                            gUnpackTime tmSmf.iActualTime(0), tmSmf.iActualTime(1), "A", "1", slTime
                                                            slEDIMGTime = gFormatTime(slTime, "M", "2")
                                                            If tmSdf.sSchStatus = "O" Then
                                                                slStr1 = "Missed"
                                                            Else
                                                                slStr1 = "Missed, MG " & Left$(slDate, Len(slDate) - 3)
                                                            End If
                                                            tmIvr.sRRemark = Trim$(slStr1)
                                                            If tmSdf.iGameNo > 0 Then
                                                                gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llSDFDate
                                                                mGetTeams tmClf.iVefCode, tmSdf.iGameNo, llSDFDate, smVisitTeam, smHomeTeam, smAbbrVisitTeam, smAbbrHomeTeam
                                                                If Trim$(smAbbrHomeTeam) <> "" Then         '6-2-17  blank out Outside non sports spots scheduled into sports vehicle
                                                                    tmIvr.sRRemark = RTrim$(tmIvr.sRRemark) & " " & smAbbrVisitTeam & " @" & smAbbrHomeTeam
                                                                End If
                                                            End If
                                                        End If
                                                        If (tmVef.sType = "V") And ((imVirtBillMethod = 1) Or (imVirtBillMethod = 2)) Then
                                                        Else
                                                            If InStr(slAiredPrice, ".") > 0 Then
                                                                slStr = gVirtVefSpotPrice(hmVef, hmVsf, tmClf.iVefCode, tmSmf.iOrigSchVef, slAiredPrice)
                                                                
                                                                '10-31-13 for cash/trade split, show the portion for a missed spot , not the entire value of the spot
                                                                If (ilPass = 1) And (Val(slPctTrade) <> 0) Then
                                                                    slStr = gDivStr(gMulStr(slStr, gSubStr("100", slPctTrade)), "100")
                                                                ElseIf (ilPass = 2) And (Val(slPctTrade) <> 100) Then
                                                                    slStr = gSubStr(slStr, gDivStr(gMulStr(slAiredPrice, gSubStr("100", slPctTrade)), "100"))
                                                                End If
                                                                
                                                                slStr1 = "-" & slStr 'slAiredPrice
                                                                slTotalMissedRate = gSubStr(slTotalMissedRate, slStr)
                                                                If (tgSpf.sInvAirOrder = "2") And (tmClf.sType = "S") And ((tmSdf.sSchStatus = "M") Or (tmSdf.sSchStatus = "U") Or (tmSdf.sSchStatus = "R") Or (tmSdf.sSchStatus = "C")) Then
                                                                    slTotalMissedRateNonPkg = gSubStr(slTotalMissedRateNonPkg, slStr)
                                                                End If
                                                            Else
                                                                slStr1 = slAiredPrice
                                                            End If
                                                            tmIvr.sRAmount = slStr1
                                                        End If
                                                    End If
                                                    If ilEDIFlag Then
                                                        If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                                                            'Copy missing from edi record
                                                            smEDIRecords(ilEDIUpper) = "51;" & "Y;" & slEDIAirDate & ";" & Trim$(str$(ilEDIDay)) & ";" & slEDIAirTime & ";" & Trim$(str$(tmClf.iLen)) & ";;" & slEDIAirRate & ";;;;" & "" & ";;" & "" & ";" & Trim$(str$(tmClf.iLine)) & ";" & ";;;N;"
                                                        Else
                                                            '10/22/14
                                                            If (tgSortKey(llSdfIndex).iType = 3) Then
                                                                '10/23/14: Handle Bonus spots
                                                                'smEDIRecords(ilEDIUpper) = "51;" & "N;" & slEDIAirDate & ";" & Trim$(str$(ilEDIDay)) & ";" & slEDIAirTime & ";" & Trim$(str$(tmClf.iLen)) & ";;" & slEDIAirRate & ";;;;" & "" & ";;" & "" & ";" & Trim$(str$(tmClf.iLine)) & ";" & ";;;N;"
                                                                If tmSdf.sSpotType = "X" Then
                                                                    smEDIRecords(ilEDIUpper) = "51;" & "N;" & slEDIAirDate & ";" & Trim$(str$(ilEDIDay)) & ";" & slEDIAirTime & ";" & Trim$(str$(tmClf.iLen)) & ";;" & 0 & ";;;;" & "" & ";;" & "" & ";" & Trim$(str$(tmClf.iLine)) & ";" & ";;;N;"
                                                                Else
                                                                    smEDIRecords(ilEDIUpper) = "51;" & "N;" & slEDIAirDate & ";" & Trim$(str$(ilEDIDay)) & ";" & slEDIAirTime & ";" & Trim$(str$(tmClf.iLen)) & ";;" & slEDIAirRate & ";;;;" & "" & ";;" & "" & ";" & Trim$(str$(tmClf.iLine)) & ";" & ";;;N;"
                                                                End If
                                                            Else
                                                                smEDIRecords(ilEDIUpper) = "51;" & "N;" & slEDIAirDate & ";" & Trim$(str$(ilEDIDay)) & ";" & slEDIAirTime & ";" & Trim$(str$(tmClf.iLen)) & ";;" & "0" & ";;;;" & "" & ";;" & "" & ";" & Trim$(str$(tmClf.iLine)) & ";" & ";;;N;"
                                                            End If
                                                        End If
                                                        mEDIByVehSort ilEDIFlag, llSdfIndex
                                                        ilEDIUpper = ilEDIUpper + 1
                                                        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                        If (tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") Then
                                                            '10/23/14: Handle bonus spots
                                                            'If tmSdf.sSchStatus <> "O" Then
                                                            If (tmSdf.sSchStatus <> "O") Or (tgSortKey(llSdfIndex).iType = 3) Then
                                                                '10/5/14
                                                                If (tgSortKey(llSdfIndex).iType = 3) Then
                                                                    slStr = "Bill Next Month"
                                                                Else
                                                                    slStr = "MG:" & slEDIMGDate & " " & slEDIMGTime
                                                                End If
                                                                smEDIRecords(ilEDIUpper) = "52;" & Left$(slStr, 20) & ";"
                                                                ilEDIUpper = ilEDIUpper + 1
                                                                ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                            End If
                                                        End If
                                                        
                                                        ''5/22/14: Add Midnight comment is required
                                                        'Not required for the miss spot
                                                        'If blAddComment52 Then
                                                        '    smEDIRecords(ilEDIUpper) = "52;" & smXMidMsgReconc & ";"
                                                        '    ilEDIUpper = ilEDIUpper + 1
                                                        '    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                        'End If
                                                        blAddComment52 = False
                                                            
                                                    End If
                                                    If (tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") Then
                                                        '10/5/14
                                                        If (tmSmf.sMGSource = "A") And (tgSortKey(llSdfIndex).iType <> 3) Then   'Mouse Moved to another vehicle
                                                            If tmSdf.sSchStatus <> "O" Then
                                                                tmVefSrchKey.iCode = tmSdf.iVefCode   'ilVefCode
                                                                If tmVefSrchKey.iCode <> tmInvRptVef.iCode Then
                                                                    ilRet = btrGetEqual(hmVef, tmInvRptVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                                End If
                                                                If Trim$(tmIvr.sRRemark) <> "" Then
                                                                    tmIvr.sRRemark = Trim$(tmIvr.sRRemark) & " " & Trim$(tmInvRptVef.sName)
                                                                Else
                                                                    tmIvr.sRRemark = Trim$(tmInvRptVef.sName)
                                                                End If
                                                            End If
                                                        End If
                                                    End If
                                                End If
                                                'If (tmAdf.sRateOnInv = "N") And (InStr(slAiredPrice, ".") > 0) Then
                                                If (tmAdf.sRateOnInv = "N") Then
                                                    tmIvr.sORate = ""
                                                    tmIvr.sARate = ""
                                                    tmIvr.sRAmount = ""
                                                End If
                                                If imUsingCrystal Then
                                                    If (Not ilHeaderInit) Then
                                                        'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81; Add Contract # so that the contract can be checked for AirTime/CPM & NTR to determine if Header should show NTR
                                                        mGenHeader ilImpactPrt, llInvoiceNo, ilPass, slPctTrade, 0, False, ilEDIFlag, tmChf.lCntrNo
                                                        ilHeaderInit = True
                                                    End If
                                                    '5/22/14: Add Remark
                                                    If blAddComment52 Then
                                                        If Trim$(tmIvr.sRAmount) = "" Then
                                                            tmIvr.sRAmount = smXMidMsgReconc
                                                            blAddComment52 = False
                                                        End If
                                                    End If
                                                    mResetFieldsForIvr llSdfIndex, ilAnyIvr, ilBonusSpot, ilEDIFlag
                                                    mClearIvr False, False, True
                                                    
                                                    '5/22/14: Output remork
                                                    If blAddComment52 Then
                                                        tmIvr.sRAmount = smXMidMsgReconc
                                                        blAddComment52 = False
                                                        mResetFieldsForIvr llSdfIndex, ilAnyIvr, ilBonusSpot, ilEDIFlag
                                                        mClearIvr False, False, True
                                                    End If
                                                    
                                                End If
                                            End If
                                        End If
                                    Next llSdfIndex
                                    'Show weeks without spots
                                    For ilWkIndex = LBound(tmWkDef) To UBound(tmWkDef) - 1 Step 1
                                        If (tmWkDef(ilWkIndex).iGameNo > 0) Then
                                            If Not tmWkDef(ilWkIndex).iWkShown Then
                                                tmWkDef(ilWkIndex).iWkShown = True
                                                'Don't show any information about missing weeks for form 2 and 3
                                                If (tgSpf.sBLaserForm <> "2") And (tgSpf.sBLaserForm <> "3") And (Val(tmWkDef(ilWkIndex).sNoSpots) > 0) Then
                                                    'Code later: get price from week- if mg get from original week which might not
                                                    'be within tmWkDef
                                                    ''slWkPrice = tmWkDef(ilWkIndex).sWkPrice
                                                    tmIvr.iWkNo = tmWkDef(ilWkIndex).iGameNo
                                                    mGetTeams tmClf.iVefCode, tmWkDef(ilWkIndex).iGameNo, tmWkDef(ilWkIndex).lWkSDate, smVisitTeam, smHomeTeam, smAbbrVisitTeam, smAbbrHomeTeam
                                                    tmIvr.sODPName = ""
                                                    tmIvr.sODays = smAbbrVisitTeam & " @" & smAbbrHomeTeam
                                                    tmIvr.lONoSpots = Val(Trim$(tmWkDef(ilWkIndex).sNoSpots))
                                                    tmIvr.sORate = Trim$(tmWkDef(ilWkIndex).sWkPrice)
                                                    'EDI Flight Info
                                                    mRemovePriorEDI41WOSpots ilEDIUpper, ilEDIFirstLineIndex
                                                    '10/20/14: Don't send to EDI 41's without 51's
                                                    'smEDIRecords(ilEDIUpper) = "41;" & Trim$(str$(tmClf.iLine)) & ";" & tmWkDef(ilWkIndex).sEDIDays & ";" & slEDISTime & ";" & slEDIETime & ";;" & Trim$(tmWkDef(ilWkIndex).sEDIRate) & ";" & Trim$(tmWkDef(ilWkIndex).sNoSpots) & ";" & "" & ";" & "" & ";"
                                                    'ilEDIUpper = ilEDIUpper + 1
                                                    'ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                    'If ilEDIFirstLineIndex = ilEDIUpper - 1 Then
                                                    '    smEDIRecords(ilEDIUpper) = "42;" & Trim$(tmVef.sName) & ";"
                                                    '    ilEDIUpper = ilEDIUpper + 1
                                                    '    ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                                    'End If
                                                    'If (tmAdf.sRateOnInv = "N") And (InStr(slAiredPrice, ".") > 0) Then
                                                    If (tmAdf.sRateOnInv = "N") Then
                                                        tmIvr.sORate = ""
                                                        tmIvr.sARate = ""
                                                        tmIvr.sRAmount = ""
                                                    End If
                                                    If imUsingCrystal Then
                                                        If (Not ilHeaderInit) Then
                                                            'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81; Add Contract # so that the contract can be checked for AirTime/CPM & NTR to determine if Header should show NTR
                                                            mGenHeader ilImpactPrt, llInvoiceNo, ilPass, slPctTrade, 0, False, ilEDIFlag, tmChf.lCntrNo
                                                            ilHeaderInit = True
                                                        End If
                                                        mResetFieldsForIvr llSdfIndex, ilAnyIvr, ilBonusSpot, ilEDIFlag
                                                        'Second call required to bypass daypart definition
                                                        mResetFieldsForIvr llSdfIndex, ilAnyIvr, ilBonusSpot, ilEDIFlag
                                                        'mClearIvr False, False, True
                                                    End If
                                                End If
                                            End If
                                        End If
                                    Next ilWkIndex
                                    '8/9/12: Don't replace test of number of tgRvfByVef with Unique vehicle test at this time.
                                    '        Result Contracts with same package vehicle across all lines will get a subtotal as multitgRvfByVef records exist for each package line
                                    '        The tgRvfByVef can not be combined because rvf uses the package line numbers.
                                    If (ilVeh = ilLastVeh) And (ilClf = ilLastClf) And (UBound(tgRvfByVef) - 1 > 0) Then
                                        'Show subtotals
                                        'One blank line
                                        mClearIvr False, False, True
                                        'If (tgSpf.sInvAirOrder <> "2") Then
                                        If (tgSpf.sBLaserForm <> "2") Then
                                          If (tmAdf.sRateOnInv = "Y") Then              'if this advt not showing rates on spots, remove the subtotal lines too
                                            For ilVehSubTotal = 0 To UBound(tgRvfByVef) - 1 Step 1
                                                tmVefSrchKey.iCode = tgRvfByVef(ilVehSubTotal).iVefCode
                                                ilRet = btrGetEqual(hmVef, tmVVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                                If ilRet <> BTRV_ERR_NONE Then
                                                    tmVVef.sName = "Missing"
                                                End If
                                                '8/9/12: Combine vehicle totals
                                                ilFound = False
                                                For ilLoop = ilVehSubTotal - 1 To 0 Step -1
                                                    If tgRvfByVef(ilVehSubTotal).iVefCode = tgRvfByVef(ilLoop).iVefCode Then
                                                        ilFound = True
                                                        Exit For
                                                    End If
                                                Next ilLoop
                                                'If imUsingCrystal Then
                                                If (imUsingCrystal) And (Not ilFound) Then
                                                    If (Not ilHeaderInit) Then
                                                        'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81; Add Contract # so that the contract can be checked for AirTime/CPM & NTR to determine if Header should show NTR
                                                        mGenHeader ilImpactPrt, llInvoiceNo, ilPass, slPctTrade, 0, False, ilEDIFlag, tmChf.lCntrNo
                                                        ilHeaderInit = True
                                                    End If
                                                    tmIvr.sOVehName = RTrim$(Trim$(tmVVef.sName))
                                                    slStr = UCase$(right$(Trim$(tmIvr.sOVehName), 2))
                                                    If (slStr = " N") Or (slStr = " R") Or (slStr = " S") Then
                                                        tmIvr.sOVehName = Left$(Trim$(tmIvr.sOVehName), Len(Trim$(tmIvr.sOVehName)) - 2)
                                                    End If
                                                    tmIvr.iType = IVRTYPE_TotalVefMkt 'Vehicle or Market Subtotal
                                                    tmIvr.iLineNo = 0           '1-12-05
                                                    tmIvr.iRdfCode = 0          '4/14/11
                                                    tmIvr.sADayDate = "Subtotal"
                                                    tmIvr.sARate = Trim$(tgRvfByVef(ilVehSubTotal).sTotalGross)
                                                    '8/9/12: Combine vehicle totals
                                                    For ilLoop = ilVehSubTotal + 1 To UBound(tgRvfByVef) - 1 Step 1
                                                        If tgRvfByVef(ilVehSubTotal).iVefCode = tgRvfByVef(ilLoop).iVefCode Then
                                                            tmIvr.sARate = gAddStr(Trim$(tmIvr.sARate), Trim$(tgRvfByVef(ilLoop).sTotalGross))
                                                        End If
                                                    Next ilLoop
                                                    
                                                    'For ilLoop = 1 To 11 Step 1
                                                    '    ilRet = gParseItemNoTrim(slName, ilLoop, "|", slFields(ilLoop))    'Get application name
                                                    'Next ilLoop
                                                    'tmIvr.sKey = slFields(1) & slFields(2) & slFields(3) & slFields(4) & slFields(9) & slFields(10) & slFields(11)
                                                    If (tgSpf.sBLaserForm = "2") Then
                                                        tmIvr.sKey = smForm2Key & "2" & tmIvr.sOVehName
                                                    Else
                                                        tmIvr.sKey = smForm2Key & "2" & tmIvr.sOVehName & "|99999|99999"
                                                    End If
                                                    'If Not imExportCntr Then
                                                    If (Not imExportCntr) And (Not imRemoteCntr) And (tmChf.sInstallDefined <> "Y") Then
                                                        If (tgSpf.sBLaserForm = "2") Then
                                                            If rbcType(INVGEN_Aff).Value Then
                                                                tmIvr.lSpotKeyNo = tmIvr.lSpotKeyNo + 1
                                                                If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
                                                                    tmIvr.iFormType = 0
                                                                Else
                                                                    tmIvr.iFormType = 1
                                                                End If
                                                                tmIvr.lClfCxfCode = 0
                                                                tmIvr.lClfCode = 0
                                                                tmIvr.lCode = 0
                                                                mGetInstallmentCounts tmChf ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
                                                                tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
                                                                tmIvr.iTotalInstallInvs = imTotalInstallInvs
                                                                tmIvr.sInstallCntr = tmChf.sInstallDefined
                                                                ilRet = mInsertIVRandClearDollars(ilEDIFlag, tmIvr)
                                                                If tgSpf.sBLaserForm = "1" Then
                                                                    If imCombineAirAndNTR Then
                                                                        'TTP 10517 - Invoices: if "ad server" option is not checked on, and "commercial and NTR" invoices are set to be separate, the air time portion of the invoice does not print
                                                                        If (tmIvr.iType = IVRTYPE_TotalAirtimeRep) Or (tmIvr.iType = IVRTYPE_TotalAdServer) Or (tmIvr.iType = IVRTYPE_TotalNTR) Or (tmIvr.iType = IVRTYPE_TotalInstallment) Or (tmIvr.iType = IVRTYPE_TotalCntr) Then
                                                                            LSet tmImr = tmIvr
                                                                            tmImr.lIvrCode = tmIvr.lCode
                                                                            tmImr.sUnused = ""
                                                                            'ilRet = btrInsert(hmImr, tmImr, imImrRecLen, INDEXKEY0)
                                                                            ilRet = mWriteImr(ilEDIFlag, tmImr)
                                                                            If ilRet <> BTRV_ERR_NONE Then
                                                                                If ilRet >= 30000 Then
                                                                                    ilRet = csiHandleValue(0, 7)
                                                                                End If
                                                                                Print #hmMsg, "mInvoiceRpt: btrInsert-Point 1, Imr Error # " & Trim$(str$(ilRet))
                                                                            End If
                                                                        End If
                                                                    End If
                                                                End If
                                                                ilAnyIvr = True
                                                            End If
                                                        Else
                                                            tmIvr.lSpotKeyNo = tmIvr.lSpotKeyNo + 1
                                                            tmIvr.lClfCxfCode = 0
                                                            tmIvr.lClfCode = 0
                                                            tmIvr.lCode = 0
                                                            mGetInstallmentCounts tmChf ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
                                                            tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
                                                            tmIvr.iTotalInstallInvs = imTotalInstallInvs
                                                            tmIvr.sInstallCntr = tmChf.sInstallDefined
                                                            ilRet = mInsertIVRandClearDollars(ilEDIFlag, tmIvr)
                                                            If tgSpf.sBLaserForm = "1" Then
                                                                If imCombineAirAndNTR Then
                                                                    'TTP 10517 - Invoices: if "ad server" option is not checked on, and "commercial and NTR" invoices are set to be separate, the air time portion of the invoice does not print
                                                                    If (tmIvr.iType = IVRTYPE_TotalAirtimeRep) Or (tmIvr.iType = IVRTYPE_TotalAdServer) Or (tmIvr.iType = IVRTYPE_TotalNTR) Or (tmIvr.iType = IVRTYPE_TotalInstallment) Or (tmIvr.iType = IVRTYPE_TotalCntr) Then
                                                                        LSet tmImr = tmIvr
                                                                        tmImr.lIvrCode = tmIvr.lCode
                                                                        tmImr.sUnused = ""
                                                                        'ilRet = btrInsert(hmImr, tmImr, imImrRecLen, INDEXKEY0)
                                                                        ilRet = mWriteImr(ilEDIFlag, tmImr)
                                                                        If ilRet <> BTRV_ERR_NONE Then
                                                                            If ilRet >= 30000 Then
                                                                                ilRet = csiHandleValue(0, 7)
                                                                            End If
                                                                            Print #hmMsg, "mInvoiceRpt: btrInsert-Point 2, Imr Error # " & Trim$(str$(ilRet))
                                                                        End If
                                                                    End If
                                                                End If
                                                            End If
                                                            ilAnyIvr = True
                                                        End If
                                                    End If
                                                End If
                                            Next ilVehSubTotal
                                          End If                            '11-30-17
                                        End If
                                    End If
                                    If Not ilHeaderInit Then
                                        'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81; Add Contract # so that the contract can be checked for AirTime/CPM & NTR to determine if Header should show NTR
                                        mGenHeader ilImpactPrt, llInvoiceNo, ilPass, slPctTrade, 0, False, ilEDIFlag, tmChf.lCntrNo
                                        ilHeaderInit = True
                                    End If
                                    ilErrorFlag = 0
                                End If
                                If ilErrorFlag <> 0 Then
                                    Exit For
                                End If
                            Next ilClf
                            If ilErrorFlag <> 0 Then
                                Exit For
                            End If
                        'End If
                    Next ilVeh
                    If ilErrorFlag <> 0 Then
                        Exit Do
                    Else
                        If ilAnyOutput Then
                            mGenMktTotal ilEDIFlag
                            If ilEDIFlag Then
                                '10/20/14: remove 41 if last record to be added
                                mRemovePriorEDI41WOSpots ilEDIUpper, ilEDIFirstLineIndex
                                mEDIStationEnd ilEDIUpper, ilPass, slEDITotalRate, slEDITotalAirRate, slAgyRate, slEDITotalAired, ilEDITotalNoInv
                            End If
                            If (Not ilHeaderInit) And imUsingCrystal Then
                                'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81; Add Contract # so that the contract can be checked for AirTime/CPM & NTR to determine if Header should show NTR
                                mGenHeader ilImpactPrt, llInvoiceNo, ilPass, slPctTrade, 0, False, ilEDIFlag, tmChf.lCntrNo
                                ilHeaderInit = True
                            End If
                            'Move mFinishOut after mCreateRvf because of taxes
                            'mFinishOutput slTotalNoPerWk, slTotalRate, ilImpactPrt, slTotalAirCount, ilPass, ilStartPass, slTGNoSpots, slTotalAirRate, slAgyRate, slAgyComm, slTotalNet, slGTNet, slGTComm, ilEDIFlag, ilEDIUpper, slTotalMissedRate, slTotalMissedRateNonPkg, slGTOrdered, slGTReconc, slGTAired, slEDITotalAired, ilEDITotalNoInv
                            mCreateRvf llInvoiceNo, slAgyRate, ilPass, slProduct, ilUrfCode, llStartSortIndex, llEndSortIndex, slTotalRate, slTotalNoPerWk, slPctTrade
                            mFinishOutput slTotalNoPerWk, slTotalRate, ilImpactPrt, slTotalAirCount, ilPass, ilStartPass, slTGNoSpots, slTotalAirRate, slAgyRate, slAgyComm, slTotalNet, slGTNet, slGTComm, ilEDIFlag, ilEDIUpper, slTotalMissedRate, slTotalMissedRateNonPkg, slGTOrdered, slGTReconc, slGTAired, slEDITotalAired, ilEDITotalNoInv
                        End If
                    End If
                End If
            Next ilPass
            If (rbcType(INVGEN_Final).Value) Then
                If igUsedISR Then
                    ilRet = mUpdateInv(0)
                    ReDim tgRvf(0 To 0) As RVF
                    ReDim tgRvfByVef(0 To 0) As RVFVEF
                'DL 11/19/01- added esle and call within else
                Else
                    ilRet = mUpdateInv(0)
                    ReDim tgRvf(0 To 0) As RVF
                    ReDim tgRvfByVef(0 To 0) As RVFVEF
                'DL 11/19/01
                End If
            End If
            If llPrevCntrNo <> llCntrNo Then
                'Final or Reprint air time invoices
                If ((rbcType(INVGEN_Final).Value) Or (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Archive).Value)) And (ckcType(INVTYPE_Commercial).Value = vbChecked) Then         '11-15-16 test for final, reprint, archive
                    If ((Asc(tgSpf.sAutoType2) And RN_NET) = RN_NET) And (Trim$(tmChf.sRepDBID) <> "") Then
                        ilFound = False
                        For ilLoop = 0 To UBound(smXferRepDBID) - 1 Step 1
                            If StrComp(Trim$(tmChf.sRepDBID), Trim$(smXferRepDBID(ilLoop)), vbTextCompare) = 0 Then
                                smXferChfCode(ilLoop) = smXferChfCode(ilLoop) & "," & Trim$(str$(tmChf.lCode))
                                ilFound = True
                                Exit For
                            End If
                        Next ilLoop
                        If Not ilFound Then
                            smXferRepDBID(UBound(smXferRepDBID)) = Trim$(tmChf.sRepDBID)
                            smXferChfCode(UBound(smXferChfCode)) = Trim$(str$(tmChf.lCode))
                            ReDim Preserve smXferRepDBID(0 To UBound(smXferRepDBID) + 1) As String
                            ReDim Preserve smXferChfCode(0 To UBound(smXferChfCode) + 1) As String
                        End If
                    End If
                End If
                llRecNo = llRecNo + 1
                llPrevCntrNo = llCntrNo
            End If
        Loop 'While llRecNo < llRecsRemaining
        ilRet = mNetToRepInv()
        mAirTime_InvEnd ilPreview, ilErrorFlag, smFileName, llInvoiceNo, slGTOrdered, slGTReconc, slGTAired, slGTComm, slGTNet, ilEDITotalNoInv, slEDITotalAired, ilImpactPrt
    'Else  ' LlPrintWithBoxStart
    '    ilErrorFlag = ilLLRet
    '    If Not imUsingCrystal Then
'VB6**      ilLLRet = LlPrintEnd(hdJob, 0)
    '        mErrMsg ilErrorFlag
    '    End If
    'End If  ' LlPrintWithBoxStart

    If (tgSpf.sAEDII = "Y") Then    'EDI Service
        'Added printing of a blank line to see if that helps with flushing the print buffer as not all edi records written
        For ilEDI = 0 To UBound(tgEDIServiceInfo) - 1 Step 1
            hmEDI = tgEDIServiceInfo(ilEDI).hEDI
            If tgEDIServiceInfo(ilEDI).sUsed = "Y" Then
                '1-6-11 extra blank line created to avoid the partial/incomplete "Transmission record 12" that
                'sometimes occured
                Sleep 100
                ''only create the extra blank line if its not Media Bank EDI becuase they cannot handle the blank line
                '6/7/12: add SpotData
                'If StrComp(Trim$(tgEDIServiceInfo(ilEDI).tArf.sID), "MediaBank", vbTextCompare) <> 0 Then
                If (StrComp(Trim$(tgEDIServiceInfo(ilEDI).tArf.sID), "MOcean OX", vbTextCompare) <> 0) And (StrComp(Trim$(tgEDIServiceInfo(ilEDI).tArf.sID), "SpotData", vbTextCompare) <> 0) Then
                    Print #hmEDI, ""
                End If
            End If
            On Error Resume Next
            Unlock #hmEDI
            Close #hmEDI
            If tgEDIServiceInfo(ilEDI).sUsed = "N" Then
                On Error Resume Next
                Kill Trim$(tgEDIServiceInfo(ilEDI).sPathFile)
            End If
        Next ilEDI
    End If
    Screen.MousePointer = vbDefault
    gSetMousePointer grdAirTime, grdRevenue, vbDefault
    Exit Sub
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mLastCompletedDate              *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Determine as date as marked    *
'*                      completed for specified vehicle*
'*                                                     *
'*******************************************************
Private Sub mLastCompletedDate(ilVefCode As Integer, llVehEarliestDate As Long, llVehLatestDate As Long, llVehEarliestUnComplete As Long)
'
'   mLastCompletedDate ilVefCode, llVehEarliestDate, llVehLatestDate, ilVehEarliestUnComplete
'       Where:
'           ilVefCode(I)- Vehicle code
'           llVehEarliestDate(O)- Earliest date marked as completed or -1 if no days within posting dates
'           llVehLatestDate(O)- Latest date marked as completed
'
    Dim ilVpfIndex As Integer
    'Dim llVehLLD As Long
    Dim slDate As String
    Dim llStartPostDate As Long
    Dim llEndPostDate As Long
    Dim llStdStartPostDate As Long
    Dim llStdEndPostDate As Long
    Dim ilRet As Integer
    Dim ilAnyDates As Integer
    Dim ilVsf As Integer
    Dim llVsfVehEarliestDate As Long
    Dim llVsfVehLatestDate As Long
    Dim llVsfVehEarliestUnComplete As Long
    Dim ilVsfAnyDates As Integer
    Dim llLcfDate As Long
    Dim ilVef As Integer
    Dim ilGsfFound As Integer
    
    tmVefSrchKey.iCode = ilVefCode
    ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation

    If ilRet <> BTRV_ERR_NONE Then
        llVehEarliestDate = 0
        llVehLatestDate = 0
        llVehEarliestUnComplete = 0
    End If
    If tmVef.sType <> "V" Then
        For ilVsf = LBound(tmVsf.iFSCode) To UBound(tmVsf.iFSCode) Step 1
            tmVsf.iFSCode(ilVsf) = 0
        Next ilVsf
        tmVsf.iFSCode(LBound(tmVsf.iFSCode)) = ilVefCode
    Else
        tmVsfSrchKey.lCode = tmVef.lVsfCode
        ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_NONE Then
            llVehEarliestDate = 0
            llVehLatestDate = 0
            llVehEarliestUnComplete = 0
        End If
        For ilVsf = UBound(tmVsf.iFSCode) To LBound(tmVsf.iFSCode) + 1 Step -1
            tmVsf.iFSCode(ilVsf) = tmVsf.iFSCode(ilVsf - 1)
        Next ilVsf
        tmVsf.iFSCode(LBound(tmVsf.iFSCode)) = ilVefCode
    End If
    llEndPostDate = 0
    'ilVpfIndex = gVpfFind(Invoice, ilVefCode)
    'gUnpackDate tgVpf(ilVpfIndex).iLLD(0), tgVpf(ilVpfIndex).iLLD(1), slDate
    'llVehLLD = gDateValue(slDate)
    'If (llVehLLD = 0) Then
        llEndPostDate = lmNowDate
    'Else
    '    If llVehLLD <= lmNowDate Then
    '        llEndPostDate = llVehLLD
    '    Else
    '        If tgSpf.sSMove = "Y" Then   'Move spots between todays Plus 1 And Last Log
    '            If lmNowDate < llVehLLD Then
    '                llEndPostDate = lmNowDate
    '            Else
    '                llEndPostDate = llVehLLD
    '            End If
    '        Else
    '            llEndPostDate = llVehLLD
    '        End If
    '    End If
    'End If
    llStdStartPostDate = lmSpfStdDate
    If lmSpfStdDate > 0 Then
        llStdEndPostDate = gDateValue(gObtainEndStd(Format$(lmSpfStdDate + 10, "m/d/yy")))
    Else
        llStdEndPostDate = 0
    End If
    If (lmSpfStdDate = 0) And (lmSpfCalDate = 0) Then
        llStartPostDate = gDateValue("1/1/90")
    Else
        '3/16/11: Ignore calendar billing for now
        'If (lmSpfStdDate <> 0) And (lmSpfStdDate < lmSpfCalDate) Then
            llStartPostDate = lmSpfStdDate + 1
        'Else
        '    If lmSpfCalDate <> 0 Then
        '        llStartPostDate = lmSpfCalDate + 1
        '    Else
        '        llStartPostDate = lmSpfStdDate + 1
        '    End If
        'End If
    End If
    'Get first/last completed posted dates
    ilAnyDates = True
    llVehEarliestDate = 0
    llVehLatestDate = 0
    llVehEarliestUnComplete = 0
    For ilVsf = LBound(tmVsf.iFSCode) To UBound(tmVsf.iFSCode) Step 1
        If tmVsf.iFSCode(ilVsf) > 0 Then
            ilVsfAnyDates = False
            llVsfVehEarliestDate = 0
            llVsfVehLatestDate = 0
            llVsfVehEarliestUnComplete = 0
            ilVef = gBinarySearchVef(tmVsf.iFSCode(ilVsf))
            If ilVef <> -1 Then
                If tgMVef(ilVef).sType <> "G" Then
                    tmLcfSrchKey.iType = 0
                    tmLcfSrchKey.sStatus = "C"  ' Current
                    tmLcfSrchKey.iVefCode = tmVsf.iFSCode(ilVsf)    'ilVefCode
                    slDate = Format$(llStartPostDate, "m/d/yy")
                    gPackDate slDate, tmLcfSrchKey.iLogDate(0), tmLcfSrchKey.iLogDate(1)
                    tmLcfSrchKey.iSeqNo = 0
                    ilRet = btrGetGreaterOrEqual(hmLcf, tmLcf, imLcfRecLen, tmLcfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Else
                    tmLcfSrchKey2.iVefCode = tmVsf.iFSCode(ilVsf)
                    slDate = Format$(llStartPostDate, "m/d/yy")
                    gPackDate slDate, tmLcfSrchKey2.iLogDate(0), tmLcfSrchKey2.iLogDate(1)
                    ilRet = btrGetGreaterOrEqual(hmLcf, tmLcf, imLcfRecLen, tmLcfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get last current record to obtain date
                End If
                Do While (ilRet = BTRV_ERR_NONE) And (tmLcf.iVefCode = tmVsf.iFSCode(ilVsf)) And (tmLcf.sStatus = "C") And (((tmLcf.iType = 0) And (tgMVef(ilVef).sType <> "G")) Or ((tmLcf.iType <> 0) And (tgMVef(ilVef).sType = "G")))
                    gUnpackDate tmLcf.iLogDate(0), tmLcf.iLogDate(1), slDate
                    llLcfDate = gDateValue(slDate)
                    If llLcfDate = 0 Then
                        Exit Do
                    End If
                    If llEndPostDate < llLcfDate Then
                        'llVsfVehEarliestUnComplete = llLcfDate    'llEndPostDate + 1
                        If llVsfVehEarliestUnComplete = 0 Then
                            llVsfVehEarliestUnComplete = llLcfDate
                        ElseIf llLcfDate < llVsfVehEarliestUnComplete Then
                            llVsfVehEarliestUnComplete = llLcfDate
                        End If
                        Exit Do
                    Else
                        ilVsfAnyDates = True
                        'If tgSpf.sBActDayCompl <> "N" Then  'Bypass Complete test
                        'Add checking if using Live Log for completion flag
                        ilVpfIndex = gBinarySearchVpf(tmVsf.iFSCode(ilVsf))
                        'If (tgSpf.sBActDayCompl <> "N") Or (((Asc(tgSpf.sUsingFeatures) And USINGLIVELOG) = USINGLIVELOG) And (tgVpf(ilVpfIndex).sGenLog = "L")) Then  'Bypass Complete test
                        If (tgSpf.sBActDayCompl <> "N") Or (((Asc(tgSpf.sUsingFeatures) And USINGLIVELOG) = USINGLIVELOG) And ((tgVpf(ilVpfIndex).sGenLog = "L") Or (tgVpf(ilVpfIndex).sGenLog = "A"))) Then  'Bypass Complete test
                            '1/27/07:  Only test the complete flag for Final Invoices
                            If (tmLcf.sAffPost <> "C") And (rbcType(INVGEN_Final).Value) Then
                                '11-9-05 check to see if there are any spots for this vehicle & date
                                If tgMVef(ilVef).sType <> "G" Then
                                    tmSdfSrchKey1.iVefCode = tmVsf.iFSCode(ilVsf)   'ilVefCode
                                    tmSdfSrchKey1.iDate(0) = tmLcf.iLogDate(0)
                                    tmSdfSrchKey1.iDate(1) = tmLcf.iLogDate(1)
                                    tmSdfSrchKey1.iTime(0) = 0
                                    tmSdfSrchKey1.iTime(1) = 0
                                    tmSdfSrchKey1.sSchStatus = ""
                                    ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                    If (ilRet = BTRV_ERR_NONE) And (tmVsf.iFSCode(ilVsf) = tmSdf.iVefCode And tmSdf.iDate(0) = tmLcf.iLogDate(0) And tmSdf.iDate(1) = tmLcf.iLogDate(1)) Then
                                        'llVsfVehEarliestUnComplete = llLcfDate
                                        'Exit Do
                                        If llVsfVehEarliestUnComplete = 0 Then
                                            llVsfVehEarliestUnComplete = llLcfDate
                                        ElseIf llLcfDate < llVsfVehEarliestUnComplete Then
                                            llVsfVehEarliestUnComplete = llLcfDate
                                        End If
                                        If (llLcfDate >= llStdStartPostDate) And (llLcfDate <= llStdEndPostDate) Then
                                            tgNotMarkComplete(UBound(tgNotMarkComplete)).sDate = slDate
                                            tgNotMarkComplete(UBound(tgNotMarkComplete)).iGameNo = 0
                                            tgNotMarkComplete(UBound(tgNotMarkComplete)).sVehName = tgMVef(ilVef).sName
                                            ReDim Preserve tgNotMarkComplete(0 To UBound(tgNotMarkComplete) + 1) As NOTMARKCOMPLETE
                                        End If
                                    End If
                                Else
                                    '9/21/09:  Test for Live Logs
                                    If (tgSpf.sBActDayCompl = "N") And (tgVpf(ilVpfIndex).sGenLog = "A") Then
                                        ilGsfFound = False
                                        tmGsfSrchKey3.iVefCode = tmVsf.iFSCode(ilVsf)
                                        tmGsfSrchKey3.iGameNo = tmLcf.iType
                                        ilRet = btrGetEqual(hmGsf, tmGsf, imGsfRecLen, tmGsfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
                                        Do While (ilRet = BTRV_ERR_NONE) And (tmGsf.iVefCode = tmVsf.iFSCode(ilVsf)) And (tmGsf.iGameNo = tmLcf.iType)
                                            If (tmLcf.iLogDate(0) = tmGsf.iAirDate(0)) And (tmLcf.iLogDate(1) = tmGsf.iAirDate(1)) Then
                                                ilGsfFound = True
                                                Exit Do
                                            End If
                                            ilRet = btrGetNext(hmGsf, tmGsf, imGsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
                                        Loop
                                        If (ilRet <> BTRV_ERR_NONE) Or (Not ilGsfFound) Then
                                            tmGsf.sLiveLogMerge = "M"
                                        End If
                                    End If
                                    If (tgSpf.sBActDayCompl <> "N") Or ((tgVpf(ilVpfIndex).sGenLog = "L") Or ((tgVpf(ilVpfIndex).sGenLog = "A") And (tmGsf.sLiveLogMerge <> "M"))) Then
                                        tmSdfSrchKey6.iVefCode = tmVsf.iFSCode(ilVsf)
                                        tmSdfSrchKey6.iGameNo = tmLcf.iType
                                        ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey6, INDEXKEY6, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                        Do While (ilRet = BTRV_ERR_NONE) And (tmSdf.iVefCode = tmVsf.iFSCode(ilVsf)) And (tmSdf.iGameNo = tmLcf.iType)
                                            If (tmLcf.iLogDate(0) = tmSdf.iDate(0)) And (tmLcf.iLogDate(1) = tmSdf.iDate(1)) Then
                                                ilGsfFound = True
                                                Exit Do
                                            End If
                                            ilRet = btrGetNext(hmSdf, tmSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
                                        Loop
                                        If (ilRet = BTRV_ERR_NONE) And (tmVsf.iFSCode(ilVsf) = tmSdf.iVefCode And tmSdf.iGameNo = tmLcf.iType) Then
                                            'llVsfVehEarliestUnComplete = llLcfDate
                                            'Exit Do
                                            If llVsfVehEarliestUnComplete = 0 Then
                                                llVsfVehEarliestUnComplete = llLcfDate
                                            ElseIf llLcfDate < llVsfVehEarliestUnComplete Then
                                                llVsfVehEarliestUnComplete = llLcfDate
                                            End If
                                            If (llLcfDate >= llStdStartPostDate) And (llLcfDate <= llStdEndPostDate) Then
                                                tgNotMarkComplete(UBound(tgNotMarkComplete)).sDate = slDate
                                                tgNotMarkComplete(UBound(tgNotMarkComplete)).iGameNo = tmLcf.iType
                                                tgNotMarkComplete(UBound(tgNotMarkComplete)).sVehName = tgMVef(ilVef).sName
                                                ReDim Preserve tgNotMarkComplete(0 To UBound(tgNotMarkComplete) + 1) As NOTMARKCOMPLETE
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        Else
                            If llVsfVehEarliestDate = 0 Then
                                llVsfVehEarliestDate = llLcfDate
                            Else
                                If llLcfDate < llVsfVehEarliestDate Then
                                    llVsfVehEarliestDate = llLcfDate
                                End If
                            End If
                            If tgMVef(ilVef).sType <> "G" Then
                                tmLcfSrchKey.iType = 0
                                tmLcfSrchKey.sStatus = "C"  ' Current
                                tmLcfSrchKey.iVefCode = tmVsf.iFSCode(ilVsf)    'ilVefCode
                                slDate = Format$("12/31/2026", "m/d/yy")
                                gPackDate slDate, tmLcfSrchKey.iLogDate(0), tmLcfSrchKey.iLogDate(1)
                                tmLcfSrchKey.iSeqNo = 0
                                ilRet = btrGetLessOrEqual(hmLcf, tmLcf, imLcfRecLen, tmLcfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                            Else
                                tmLcfSrchKey2.iVefCode = tmVsf.iFSCode(ilVsf)
                                slDate = Format$("12/31/2026", "m/d/yy")
                                gPackDate slDate, tmLcfSrchKey.iLogDate(0), tmLcfSrchKey.iLogDate(1)
                                ilRet = btrGetLessOrEqual(hmLcf, tmLcf, imLcfRecLen, tmLcfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get last current record to obtain date
                            End If
                            If (ilRet = BTRV_ERR_NONE) And (tmLcf.iVefCode = tmVsf.iFSCode(ilVsf)) And (tmLcf.sStatus = "C") And (((tmLcf.iType = 0) And (tgMVef(ilVef).sType <> "G")) Or ((tmLcf.iType <> 0) And (tgMVef(ilVef).sType = "G"))) Then
                                gUnpackDate tmLcf.iLogDate(0), tmLcf.iLogDate(1), slDate
                                llLcfDate = gDateValue(slDate)
                            Else
                                llLcfDate = lmNowDate
                            End If
                            If llVsfVehLatestDate = 0 Then
                                llVsfVehLatestDate = llLcfDate
                            Else
                                If llLcfDate > llVsfVehLatestDate Then
                                    llVsfVehLatestDate = llLcfDate
                                End If
                            End If
                            llVsfVehEarliestUnComplete = lmNowDate '- 1
                            Exit Do
                        End If
                        If llVsfVehEarliestDate = 0 Then
                            llVsfVehEarliestDate = llLcfDate
                            llVsfVehLatestDate = llLcfDate
                        Else
                            If llLcfDate < llVsfVehEarliestDate Then
                                llVsfVehEarliestDate = llLcfDate
                            Else
                                If llLcfDate > llVsfVehLatestDate Then
                                    llVsfVehLatestDate = llLcfDate
                                End If
                            End If
                        End If
                    End If
                    ilRet = btrGetNext(hmLcf, tmLcf, imLcfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop
                If Not ilVsfAnyDates Then
                    ilAnyDates = False
                Else
                    If llVsfVehEarliestUnComplete = 0 Then
                        llVsfVehEarliestUnComplete = llEndPostDate + 1
                    End If
                    If llVehEarliestUnComplete = 0 Then
                        llVehEarliestUnComplete = llVsfVehEarliestUnComplete
                    Else
                        If llVsfVehEarliestUnComplete < llVehEarliestUnComplete Then
                            llVehEarliestUnComplete = llVsfVehEarliestUnComplete
                        End If
                    End If
                    If llVehEarliestDate = 0 Then
                        llVehEarliestDate = llVsfVehEarliestDate
                    Else
                        If llVsfVehEarliestDate < llVehEarliestDate Then
                            llVehEarliestDate = llVsfVehEarliestDate
                        End If
                    End If
                    If llVehLatestDate = 0 Then
                        llVehLatestDate = llVsfVehLatestDate
                    Else
                        If llVsfVehLatestDate < llVehLatestDate Then
                            llVehLatestDate = llVsfVehLatestDate
                        End If
                    End If
                End If
            End If
        End If
    Next ilVsf
    If Not ilAnyDates Then
        llVehEarliestDate = -1
        Exit Sub
    End If
    If llVehEarliestUnComplete = 0 Then
        llVehEarliestUnComplete = llEndPostDate + 1
    End If
    llVehLatestDate = llVehEarliestUnComplete - 1    'i.e. vehicle only runs on the 15th
                                                    'of the month, if latest set to 15th then it
                                                    'would only allow billing thru the 15th instead
                                                    'if the full month
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mMakeListBox                    *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Make a PSF record              *
'*                                                     *
'*******************************************************
Private Sub mMakeListBox()
    Dim ilLoop As Integer
    Dim ilRet As Integer
    Dim llDate As Long
    Dim llTime As Long
    Dim slNameSort As String
    Dim slName As String
    Dim slCode As String
    Dim slKey As String
    Dim ilIndex As Integer
    Dim ilSvIndex As Integer
    Dim llRow As Long
    Dim blUnpostedFileOpen As Boolean

    'Build List box
    llRow = grdAirTime.FixedRows
    For ilLoop = grdAirTime.rows - 1 To grdAirTime.FixedRows Step -1
        If grdAirTime.TextMatrix(ilLoop, ATBILLINDEX) <> "" Then
            llRow = ilLoop + 1
            Exit For
        End If
    Next ilLoop
    blUnpostedFileOpen = False
    If igUsedISR Then
        tmChf.lCode = 0
        gPackDate smGenDate, tmIsrSrchKey0.iGenDate(0), tmIsrSrchKey0.iGenDate(1)
        gPackTime smGenTime, tmIsrSrchKey0.iGenTime(0), tmIsrSrchKey0.iGenTime(1)
        tmIsrSrchKey0.sKey = ""
        ilRet = btrGetGreaterOrEqual(hmIsr, tmIsr, imIsrRecLen, tmIsrSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        Do While ilRet = BTRV_ERR_NONE
            'gUnpackDateLong tmIsr.iGenDate(0), tmIsr.iGenDate(1), llDate
            gUnpackDateLongError tmIsr.iGenDate(0), tmIsr.iGenDate(1), llDate, "40:mMakeListBox " & tmIsr.lCode
            If lmGenDate <> llDate Then
                Exit Do
            End If
            gUnpackTimeLong tmIsr.iGenTime(0), tmIsr.iGenTime(1), False, llTime
            If lmGenTime <> llTime Then
                Exit Do
            End If
            If tmIsr.lChfCode <> tmChf.lCode Then
                ilRet = gParseItem(tmIsr.sKey, 1, "|", slName)    'Get application name
                'ilRet = gParseItem(tmIsr.sKey, 3, "|", slCode)    'Get application name
                'tmChf.lCntrNo = Val(slCode)
                'tmChf.lCode = tmIsr.lChfCode
                'slNameSort = Trim$(slName) & "/" & Trim$(Str$(tmChf.lCntrNo))
                'lbcCntr.AddItem slNameSort
                'lbcCntrCode.AddItem slNameSort & "\" & Trim$(Str$(tmChf.lCode))
                mAddGrdAirTime llRow, slName, tmIsr.lChfCode, blUnpostedFileOpen
            End If
            ilRet = btrGetNext(hmIsr, tmIsr, imIsrRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        Loop
    Else
        'DL 11/19/01- Removed sort call and changed loop to be by lbcKey
        'ilUpper = UBound(tgSortKey)
        'If ilUpper > 0 Then
        '    'ArraySortTyp fnAV(tgSortKey(),0), ilUpper, 0, LenB(tgSortKey(0)), 0, -9, 0
        '    ArraySortTyp fnAV(tgSortKey(), 0), ilUpper, 0, LenB(tgSortKey(0)), 0, LenB(tgSortKey(0).sKey), 0
        'End If
        'For ilLoop = 0 To UBound(tgSortKey) - 1 Step 1

        For ilLoop = 0 To lbcKey.ListCount - 1 Step 1
            slKey = lbcKey.List(ilLoop)
            ilIndex = lbcKey.ItemData(ilLoop)
            If ilLoop = 0 Then
                ilRet = gParseItem(slKey, 1, "|", slName)    'Get application name
                'ilRet = gParseItem(slKey, 3, "|", slCode)    'Get application name
                'tmChf.lCntrNo = Val(slCode)
                'tmChf.lCode = tgSortNoKey(ilIndex).lChfCode
                'slNameSort = Trim$(slName) & "/" & Trim$(Str$(tmChf.lCntrNo))
                'lbcCntr.AddItem slNameSort
                'lbcCntrCode.AddItem slNameSort & "\" & Trim$(Str$(tmChf.lCode))
                mAddGrdAirTime llRow, slName, tgSortNoKey(ilIndex).lChfCode, blUnpostedFileOpen
            Else
                If tgSortNoKey(ilIndex).lChfCode <> tgSortNoKey(ilSvIndex).lChfCode Then
                    ilRet = gParseItem(slKey, 1, "|", slName)    'Get application name
                    'ilRet = gParseItem(slKey, 3, "|", slCode)    'Get application name
                    'tmChf.lCntrNo = Val(slCode)
                    'tmChf.lCode = tgSortNoKey(ilIndex).lChfCode
                    'slNameSort = Trim$(slName) & "/" & Trim$(Str$(tmChf.lCntrNo))
                    'lbcCntr.AddItem slNameSort
                    'lbcCntrCode.AddItem slNameSort & "\" & Trim$(Str$(tmChf.lCode))
                    mAddGrdAirTime llRow, slName, tgSortNoKey(ilIndex).lChfCode, blUnpostedFileOpen
                End If
            End If
            ilSvIndex = ilIndex
            'DL 11/19/01
        Next ilLoop
    End If
    If blUnpostedFileOpen Then
        gLogMsgWODT "C", hmUnposted, ""
    End If
    
    grdAirTime.TopRow = 1
    grdAirTime.Redraw = True
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mMakePsf                        *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Make a PSF record              *
'*                                                     *
'*      1-27-05 Initialize psffsfcode.  New field to   *
'               to be compatible with SDF              *
'*******************************************************
Private Sub mMakePsf(llStartDate As Long, llEndDate As Long, ilAllowedDays() As Integer, ilOrderedNoSpots As Integer)
    Dim slDate As String
    Dim ilRet As Integer
    'Dim ilLoop As Integer
    Dim llTime As Long
    tmPsf.lCode = 0
    tmPsf.iVefCode = tmClf.iVefCode      'Vehicle Code (combos not allowed)
    tmPsf.lChfCode = tmClf.lChfCode    'Contract code
    tmPsf.iLineNo = tmClf.iLine    'Line number
    tmPsf.iAdfCode = tmChf.iAdfCode 'Advertiser code number

    mComputeRndDateTime llStartDate, llEndDate, ilAllowedDays(), ilOrderedNoSpots, slDate, llTime
    gPackDate slDate, tmPsf.iDate(0), tmPsf.iDate(1)
    gPackTimeLong llTime, tmPsf.iTime(0), tmPsf.iTime(1)

    tmPsf.sSchStatus = "S"    'S=Scheduled, M=Missed,
                                'G=Makegood, A=on alternate log but not MG, B=on alternate Log and MG,
                                'C=Cancelled, H=Hidden
    tmPsf.iMnfMissed = 0   'Missed reason
    tmPsf.sTracer = " "   'M=Mouse move, N=On demand & mouse moved, C=Created in post log,
                            'N=N/A, D=on Demand & created in post log
    tmPsf.sAffChg = " "   'T=Time change, C=Copy change, B=Time and copy changed, blank=no change
    tmPsf.sPtType = "0"    'Not assigned
    tmPsf.lCopyCode = 0        'Copy inventory code
    tmPsf.iRotNo = 0
    tmPsf.iLen = tmClf.iLen         'Spot length
    tmPsf.sPriceType = "L" 'Use line pricetmCClf.sPriceType 'T=True; N=No Charge; B=Bonus; S=Spinoff; R=Recapturable; A=Audience Deficiency Unit (adu)
    tmPsf.sSpotType = "A"
    tmPsf.sBill = "N"       'Not Billed
    tmPsf.iUrfCode = tgUrf(0).iCode      'Last user who modified spot
    tmPsf.lFsfCode = 0                      '1-27-05
    tmPsf.iGameNo = 0
    ilRet = btrInsert(hmPsf, tmPsf, imPsfRecLen, INDEXKEY3)
    If ilRet <> BTRV_ERR_NONE Then
        If ilRet >= 30000 Then
            ilRet = csiHandleValue(0, 7)
        End If
        Print #hmMsg, "mMakePsf: btrInsert-Point 1, Psf Error # " & Trim$(str$(ilRet))
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mMarketPop                      *
'*                                                     *
'*             Created:7/19/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Populate Market combobox       *
'*                      if requireds                   *
'*                                                     *
'*******************************************************
Sub mMarketPop()
    Dim ilRet As Integer
    Dim slName As String
    Dim slNameCode As String
    Dim slCode As String
    Dim ilSortCode As Integer
    Dim ilLoop As Integer
    Dim slStr As String
    Dim ilMkt As Integer
    Dim ilMktCode As Integer

    ilSortCode = 0
    ReDim tmMktCode(0 To 0) As SORTCODE   'VB list box clear (list box used to retain code number so record can be found)
    ReDim tmMktVefCode(0 To 0) As Integer
    slStr = ""
    'ReDim tgMkMnf(1 To 1) As MNF
    ReDim tgMkMnf(0 To 0) As MNF
    ilRet = gObtainMnfForType("H3", slStr, tgMkMnf())
    For ilLoop = LBound(tgMkMnf) To UBound(tgMkMnf) - 1 Step 1
        If Trim$(tgMkMnf(ilLoop).sRPU) = "Y" Then
            slName = Trim$(tgMkMnf(ilLoop).sName)
            slName = slName & "\" & Trim$(str$(tgMkMnf(ilLoop).iCode))
            tmMktCode(ilSortCode).sKey = slName
            If ilSortCode >= UBound(tmMktCode) Then
                ReDim Preserve tmMktCode(0 To UBound(tmMktCode) + 100) As SORTCODE
            End If
            ilSortCode = ilSortCode + 1
        End If
    Next ilLoop
    ReDim Preserve tmMktCode(0 To ilSortCode) As SORTCODE
    If UBound(tmMktCode) - 1 > 0 Then
        'ArraySortTyp tmMktCode(), tmMktCode(0), UBound(tmMktCode), 0, Len(tmMktCode(0)), 0, Len(tmMktCode(0).sKey), 0
        ArraySortTyp fnAV(tmMktCode(), 0), UBound(tmMktCode), 0, LenB(tmMktCode(0)), 0, LenB(tmMktCode(0).sKey), 0
    End If
    For ilMkt = 0 To UBound(tmMktCode) - 1 Step 1
        slNameCode = tmMktCode(ilMkt).sKey
        ilRet = gParseItem(slNameCode, 2, "\", slCode)
        ilMktCode = Val(slCode)
        For ilLoop = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
            If tgMVef(ilLoop).iMnfVehGp3Mkt = ilMktCode Then
                tmMktVefCode(UBound(tmMktVefCode)) = tgMVef(ilLoop).iCode
                ReDim Preserve tmMktVefCode(0 To UBound(tmMktVefCode) + 1) As Integer
            End If
        Next ilLoop
    Next ilMkt
    Exit Sub

    On Error GoTo 0
    imTerminate = True
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mObtainCntrToInvoice            *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                          7           *
'*            Comments:Obtain spots for                *
'*                     specified dates and contract    *
'*                                                     *
'*******************************************************
Private Function mObtainCntrToInvoice(ilTestBilled As Integer) As Integer
'
'   ilRet = mObtainCntrToInvoice (ilTestBilled)
'   Where:
'       ilTestBilled(I)- 0=Gather spots; 1=Test for any Std Month unbilled spots;
'                        2=Test for any Calendar month unbilled spots
'                        3=Test for any week unbilled spots
'       smStartStd(I)- Standard month Start date
'       smEndStd(I)- Standard month End date
'       smStartCal(I)- Calendar month Start date
'       smEndCal(I)- Calendar month End date
'       ilRet (O)- True if spots obtained OK; False if error
'       tgSortKey() (O)- contains the records unsorted
'       lbcCntr (O)- contains the contracts
'
    Dim llNoRec As Long
    Dim ilRet As Integer
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
    Dim tlDateTypeBuff As POPDATETYPE   'Type field record
    Dim slDate As String
    Dim llStdStartDate As Long
    Dim llStdEndDate As Long
    Dim llCalStartDate As Long
    Dim llCalEndDate As Long
    Dim llWkStartDate As Long
    Dim llWkEndDate As Long
    Dim slUnbilled As String
    Dim ilOffSet As Integer
    Dim ilExtLen As Integer
    Dim ilUpper As Integer
    Dim ilLoop As Integer
    Dim llLastUnbilledDate As Long
    Dim llBaseDate As Long      'Use to compute week number
    Dim tlSdfExt As SDFEXT
    Dim slChfCode As String
    Dim slLineNo As String
    Dim ilUpper1 As Integer
    Dim ilUpper2 As Integer
    Dim ilIndex As Integer
    Dim ilOk As Integer
    Dim ilVef As Integer
    Dim llCrossMidnightStartDate As Long
    Dim llCrossMidnightEndDate As Long
    Dim llDate As Long

    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    If ilTestBilled = 0 Then
        smTime1 = " 0 Start of mObtainCntrToInvoice " & Format$(gNow(), "h:mm:ssAM/PM")
    End If
    ilUpper = 0
    ReDim tgSortNoKey(0 To 0) As TYPESORTNOKEY
    lbcKey.Clear
    mClearAirTimeGrid
    If (((smStartStd = "") Or (smEndStd = "")) And (ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked)) Or (((smStartCal = "") Or (smEndCal = "")) And (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked)) Or (((smStartWk = "") Or (smEndWk = "")) And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked)) Then
        If ilTestBilled > 0 Then
            mObtainCntrToInvoice = True
        Else
            mObtainCntrToInvoice = False
        End If
        Screen.MousePointer = vbDefault
        gSetMousePointer grdAirTime, grdRevenue, vbDefault
        Exit Function
    End If
    If Not gObtainAdvt() Then
        If ilTestBilled > 0 Then
            mObtainCntrToInvoice = True
        Else
            mObtainCntrToInvoice = False
        End If
        Screen.MousePointer = vbDefault
        gSetMousePointer grdAirTime, grdRevenue, vbDefault
        Exit Function
    End If
    If Not gObtainAgency() Then
        If ilTestBilled > 0 Then
            mObtainCntrToInvoice = True
        Else
            mObtainCntrToInvoice = False
        End If
        Screen.MousePointer = vbDefault
        gSetMousePointer grdAirTime, grdRevenue, vbDefault
        Exit Function
    End If
    If ilTestBilled > 0 Then
        mObtainCntrToInvoice = False    'Set as if all spots billed
    Else
        mObtainCntrToInvoice = True
    End If
    'Check if Broadcast selected
    If (ilTestBilled = 0) And (ckcType(INVTYPE_Commercial).Value = vbUnchecked) Then
        Screen.MousePointer = vbDefault
        gSetMousePointer grdAirTime, grdRevenue, vbDefault
        Exit Function
    End If
    llBaseDate = gDateValue("1/5/1970")
    llStdStartDate = lmStartStd 'gDateValue(smStartStd)
    llStdEndDate = lmEndStd 'gDateValue(smEndStd)
    llCalStartDate = lmStartCal 'gDateValue(smStartCal)
    llCalEndDate = lmEndCal 'gDateValue(smEndCal)
    llWkStartDate = lmStartWk 'gDateValue(smStartCal)
    llWkEndDate = lmEndWk 'gDateValue(smEndCal)
    slUnbilled = ""
    llLastUnbilledDate = 0
    
    If ilTestBilled = 1 Then
        slUnbilled = slUnbilled & "Standard- "
    ElseIf ilTestBilled = 2 Then
        slUnbilled = slUnbilled & "Calendar- "
    ElseIf ilTestBilled = 3 Then
        slUnbilled = slUnbilled & "Week- "
    End If
    
    ilExtLen = 2 + 4 + 2 + 4 + 4 + 1 + 1 + 2 + 1 + 1 + 1 + 2 + 2 + 1 + 4 'VefCode+ChfCode+LineNo+Date+Time+Status+Tracer+Length+PriceType+SpotType+Bill+Adf+GameNo+Midnight+Code Len(tmSdfExt(1)) - 4'Extract operation record size
    llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hmSdf) 'Obtain number of records
    btrExtClear hmSdf   'Clear any previous extend operation

    If ilTestBilled = 1 Then
        '5/22/14: Gather spots prior to start date if billing spot that cross midnight in airing period
        If (imXMidHandle <> 2) Then
            gPackDate smStartStd, tmSdfSrchKey4.iDate(0), tmSdfSrchKey4.iDate(1)
        Else
            gPackDate gDecOneDay(smStartStd), tmSdfSrchKey4.iDate(0), tmSdfSrchKey4.iDate(1)
        End If
    ElseIf ilTestBilled = 2 Then
        '5/22/14: Gather spots prior to start date if billing spot that cross midnight in airing period
        If (imXMidHandle <> 2) Then
            gPackDate smStartCal, tmSdfSrchKey4.iDate(0), tmSdfSrchKey4.iDate(1)
        Else
            gPackDate gDecOneDay(smStartCal), tmSdfSrchKey4.iDate(0), tmSdfSrchKey4.iDate(1)
        End If
    ElseIf ilTestBilled = 3 Then
        '5/22/14: Gather spots prior to start date if billing spot that cross midnight in airing period
        If (imXMidHandle <> 2) Then
            gPackDate smStartWk, tmSdfSrchKey4.iDate(0), tmSdfSrchKey4.iDate(1)
        Else
            If gDateValue(gObtainEndStd(smStartWk)) <> gDateValue(smStartWk) + 6 Then
                gPackDate smStartWk, tmSdfSrchKey4.iDate(0), tmSdfSrchKey4.iDate(1)
            Else
                gPackDate gDecOneDay(smStartWk), tmSdfSrchKey4.iDate(0), tmSdfSrchKey4.iDate(1)
            End If
        End If
    Else
        slDate = ""
        If llStdStartDate > 0 Then
            slDate = smStartStd
        End If
        If (llCalStartDate > 0) And ((llCalStartDate < gDateValue(slDate)) Or (slDate = "")) Then
            slDate = smStartCal
        End If
        If (llWkStartDate > 0) And ((llWkStartDate < gDateValue(slDate)) Or (slDate = "")) Then
            slDate = smStartWk
        End If
        '5/22/14: Gather spots prior to start date if billing spot that cross midnight in airing period
        If (imXMidHandle = 2) Then
            slDate = gDecOneDay(slDate)
        End If
        gPackDate slDate, tmSdfSrchKey4.iDate(0), tmSdfSrchKey4.iDate(1)
    End If
    
    '--------------------------------------------------------------
    tmSdfSrchKey4.lChfCode = 0
    ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    If ilRet <> BTRV_ERR_END_OF_FILE Then
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "Error Reading SDF, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        Call btrExtSetBounds(hmSdf, llNoRec, -1, "UC", "SDFEXTPK", SDFEXTPK) 'Set extract limits (all records)
        If (Not rbcType(INVGEN_Aff).Value) Then    'Ignore bill flag if processing affidavits
            '10/17/14: Filter spots later in the code as Billed included plus spots that cross midnight on last period date.  Those spots might be billed and might by unbilled
            If (rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value) And (imXMidHandle = 2) Then       '11-15-16 test for reprint or archive
            Else
                tlCharTypeBuff.sType = "Y"    'Extract all matching records
                ilOffSet = gFieldOffset("Sdf", "SdfBill")
                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then        '11-15-16 test for reprint, aff, or archive
                    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
                Else
                    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
                End If
            End If
        End If
        tlCharTypeBuff.sType = "H"    'Extract all non-matching records
        ilOffSet = gFieldOffset("Sdf", "SdfSchStatus")
        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
        
        If ilTestBilled = 1 Then
            slDate = smStartStd
        ElseIf ilTestBilled = 2 Then
            slDate = smStartCal
        ElseIf ilTestBilled = 3 Then
            slDate = smStartWk
        Else
            slDate = ""
            If llStdStartDate > 0 Then
                slDate = smStartStd
            End If
            If (llCalStartDate > 0) And ((llCalStartDate < gDateValue(slDate)) Or (slDate = "")) Then
                slDate = smStartCal
            End If
            If (llWkStartDate > 0) And ((llWkStartDate < gDateValue(slDate)) Or (slDate = "")) Then
                slDate = smStartWk
            End If
        End If
        '5/22/14: Gather spots prior to start date if billing spot that cross midnight in airing period
        If (imXMidHandle = 2) Then
            slDate = gDecOneDay(slDate)
        End If
        '10/17/14: Filter spots later in the code as Billed included plus spots that cross midnight on last period date.  Those spots might be billed and might by unbilled
        llCrossMidnightStartDate = gDateValue(slDate)
        gPackDate slDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
        ilOffSet = gFieldOffset("Sdf", "SdfDate")
        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_GTE, BTRV_EXT_AND, tlDateTypeBuff, 4)
        If ilTestBilled = 1 Then
            slDate = smEndStd
        ElseIf ilTestBilled = 2 Then
            slDate = smEndCal
        ElseIf ilTestBilled = 3 Then
            slDate = smEndWk
        Else
            slDate = ""
            If llStdEndDate > 0 Then
                slDate = smEndStd
            End If
            If (llCalEndDate > 0) And ((llCalEndDate > gDateValue(slDate)) Or (slDate = "")) Then
                slDate = smEndCal
            End If
            If (llWkEndDate > 0) And ((llWkEndDate > gDateValue(slDate)) Or (slDate = "")) Then
                slDate = smEndWk
            End If
        End If
        '10/17/14: Filter spots later in the code as Billed included plus spots that cross midnight on last period date.  Those spots might be billed and might by unbilled
        llCrossMidnightEndDate = gDateValue(slDate)
        gPackDate slDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
        ilOffSet = gFieldOffset("Sdf", "SdfDate")
        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_LTE, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)

        ilOffSet = gFieldOffset("Sdf", "SdfVefCode")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 2)  'Extract Name
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfChfCode")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 4)  'Extract iCode field
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfLineNo")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 2)  'Extract Name
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfDate")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 4) 'Extract Variation
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfTime")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 4) 'Extract Variation
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfSchStatus")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfTracer")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfLen")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 2) 'Extract Variation
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfPriceType")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfSpotType")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfBill")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfAdfCode")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 2) 'Extract Variation
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfGameNo")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 2) 'Extract Variation
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        '5/22/14: Add Cross Midnight
        ilOffSet = gFieldOffset("Sdf", "SdfXCrossMidnight")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilOffSet = gFieldOffset("Sdf", "SdfCode")
        ilRet = btrExtAddField(hmSdf, ilOffSet, 4) 'Extract Variation
        If ilRet <> BTRV_ERR_NONE Then
            If ilTestBilled > 0 Then
                mObtainCntrToInvoice = True
                lbcUnbilled.AddItem slUnbilled & "ExtAddField Error, #" & str$(ilRet)
            Else
                mObtainCntrToInvoice = False
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            Exit Function
        End If
        ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
        If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
            If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                If ilTestBilled > 0 Then
                    mObtainCntrToInvoice = True
                    lbcUnbilled.AddItem slUnbilled & "ExtGetNext Error, #" & str$(ilRet)
                Else
                    mObtainCntrToInvoice = False
                End If
                Screen.MousePointer = vbDefault
                gSetMousePointer grdAirTime, grdRevenue, vbDefault
                Exit Function
            End If
            ilExtLen = 2 + 4 + 2 + 4 + 4 + 1 + 1 + 2 + 1 + 1 + 1 + 2 + 2 + 1 + 4 'VefCode+ChfCode+LineNo+Date+Time+Status+Tracer+Length+PriceType+SpotType+Bill+Adf+GameNo+Midnight+Code Len(tmSdfExt(1)) - 4'Extract operation record size
            Do While ilRet = BTRV_ERR_REJECT_COUNT
                ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
            Loop
            ReDim tgSdfExtIn(0 To 0) As SORTSDFEXT
            ReDim tgSdfExtIn32(0 To 32000, 0 To 0) As SORTSDFEXT
            ilUpper1 = 0
            ilUpper2 = 0
            '--------------------------------------------------------------
            Do While ilRet = BTRV_ERR_NONE
                ilOk = True
                If (tgSpf.sInvVehSel = "Y") And (ckcAll.Value = vbUnchecked) Then
                    ilOk = False
                    For ilIndex = 0 To UBound(tgInvVehCode) - 1 Step 1
                        If tgInvVehCode(ilIndex).iCode = tlSdfExt.iVefCode Then
                            ilOk = True
                            Exit For
                        End If
                    Next ilIndex
                End If
                '10/17/14: Filter spots later in the code as Billed included plus spots that cross midnight on last period date.  Those spots might be billed and might by unbilled
                If ilOk Then
                    If (rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive)) And (imXMidHandle = 2) Then         '11-15-16 test reproint or archive
                        gUnpackDateLong tlSdfExt.iDate(0), tlSdfExt.iDate(1), llDate
                        If (tlSdfExt.sXCrossMidnight = "Y") And ((llDate = llCrossMidnightStartDate) Or (llDate = llCrossMidnightEndDate)) Then
                            tlSdfExt.sSchStatus = "Z"
                        Else
                            If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then            '11-15-16 test reprint , aff or archive
                                If tlSdfExt.sBill <> "Y" Then
                                    ilOk = False
                                End If
                            Else
                                If tlSdfExt.sBill = "Y" Then
                                    ilOk = False
                                End If
                            End If
                        End If
                    End If
                End If
                If ilOk Then
                    If (Asc(tgSpf.sUsingFeatures) And USINGREP) = USINGREP Then
                        If (tlSdfExt.sSchStatus = "G") Or (tlSdfExt.sSchStatus = "O") Then
                            '3/26/10
                            tmSmfSrchKey2.lCode = tlSdfExt.lCode
                            ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                            If ilRet = BTRV_ERR_NONE Then
                                ilVef = gBinarySearchVef(tmSmf.iOrigSchVef)
                            Else
                                ilVef = -1
                            End If
                        Else
                            ilVef = gBinarySearchVef(tlSdfExt.iVefCode)
                        End If
                        If ilVef <> -1 Then
                            If tgMVef(ilVef).sType = "R" Then
                                'Rep Vehicle
                                ilOk = False
                            End If
                        End If
                    End If
                End If
                If ilOk Then
                    tlSdfExt.iStatus = 0
                    tlSdfExt.lMdDate = 0    'Missed date for MG's (used in gCntrDisp)
                    slChfCode = Trim$(str$(tlSdfExt.lChfCode))
                    Do While Len(slChfCode) < 10
                        slChfCode = "0" & slChfCode
                    Loop
                    slLineNo = Trim$(str$(tlSdfExt.iLineNo))
                    Do While Len(slLineNo) < 5
                        slLineNo = "0" & slLineNo
                    Loop
                    tgSdfExtIn32(ilUpper1, ilUpper2).sKey = slChfCode & slLineNo
                    tgSdfExtIn32(ilUpper1, ilUpper2).tSdfExt = tlSdfExt
                    ilUpper1 = ilUpper1 + 1
                    If ilUpper1 >= 32000 Then
                        ilUpper1 = 0
                        ilUpper2 = ilUpper2 + 1
                        ReDim Preserve tgSdfExtIn32(0 To 32000, 0 To ilUpper2) As SORTSDFEXT
                    End If
                End If
                ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
                Do While ilRet = BTRV_ERR_REJECT_COUNT
                    ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
                Loop
            Loop
            '--------------------------------------------------------------
            For ilIndex = 0 To ilUpper2 Step 1
                If ilIndex < ilUpper2 Then
                    ReDim tgSdfExtIn(0 To 32000) As SORTSDFEXT
                    For ilLoop = 0 To 32000 Step 1
                        tgSdfExtIn(ilLoop) = tgSdfExtIn32(ilLoop, ilIndex)
                    Next ilLoop
                Else
                    ReDim tgSdfExtIn(0 To ilUpper1) As SORTSDFEXT
                    For ilLoop = 0 To ilUpper1 Step 1
                        tgSdfExtIn(ilLoop) = tgSdfExtIn32(ilLoop, ilIndex)
                    Next ilLoop
                End If
                ilLoop = UBound(tgSdfExtIn)
                If ilLoop > 0 Then
                    ArraySortTyp fnAV(tgSdfExtIn(), 0), ilLoop, 0, LenB(tgSdfExtIn(0)), 0, LenB(tgSdfExtIn(0).sKey), 0
                End If
                For ilLoop = 0 To UBound(tgSdfExtIn) - 1 Step 1
                    tlSdfExt = tgSdfExtIn(ilLoop).tSdfExt
                    If ilTestBilled = 0 Then
                        ilRet = mCreateDateTimeForMissed(tlSdfExt, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate)
                    Else
                        ilRet = True
                    End If
                    If ilRet Then
                        If mTestSdfExt(0, ilTestBilled, tlSdfExt, slUnbilled, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate, ilUpper, llLastUnbilledDate, False) Then
                            If ilTestBilled > 0 Then
                                mObtainCntrToInvoice = True
                            End If
                        Else
                            If ilTestBilled = 0 Then
                                mObtainCntrToInvoice = False
                            End If
                        End If
                    End If
                Next ilLoop
            Next ilIndex
        End If
    End If
    
    ilRet = mGetAnyVehSpots(ilTestBilled, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate, ilUpper)
    If ilTestBilled > 0 Then
        Screen.MousePointer = vbDefault
        gSetMousePointer grdAirTime, grdRevenue, vbDefault
        Exit Function
    End If
    If Not mGetMissedFromMGs(llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate, ilUpper) Then
        mObtainCntrToInvoice = False
        Screen.MousePointer = vbDefault
        gSetMousePointer grdAirTime, grdRevenue, vbDefault
        Exit Function
    End If
    If (ilTestBilled = 0) And ((rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Aff).Value) Or (rbcType(INVGEN_Archive).Value)) Then      '11-15-16 test reprint, aff or archive
        If (tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") And (tgSpf.sInvAirOrder <> "2") Then
            mGetMissedForReprint slUnbilled, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate, ilUpper, llLastUnbilledDate
        End If
    End If
    '--------------------------------------------------------------
    'Check for package billing
    mGetPackageSpots llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate, ilUpper
    If igUsedISR Then
        mCreateISR False
    End If
    '--------------------------------------------------------------
    'Build List box
    mMakeListBox
    mObtainCntrToInvoice = True
    Screen.MousePointer = vbDefault
    gSetMousePointer grdAirTime, grdRevenue, vbDefault
    lmRecCount = btrRecords(hmIsr)
    If lmRecCount = 0 Then
        lmRecCount = UBound(tgSortNoKey)
    End If
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mObtainCopy                     *
'*                                                     *
'*             Created:3/01/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Obtain Copy                    *
'*                                                     *
'*******************************************************
Private Sub mObtainCopy(slProduct() As String, slCopy() As String)
'
'   mObtainCopy
'       Where:
'           tmSdf(I)- Spot record
'           tmSmf(I)
'           tmCpf(O)- Product/ISCI record
'
    Dim ilIndex As Integer
    Dim ilRet As Integer
    Dim ilCopy As Integer
    Dim slPtType As String
    Dim llCopyCode As Long


    For ilIndex = LBound(slCopy) To UBound(slCopy) Step 1
        slCopy(ilIndex) = ""
        slProduct(ilIndex) = ""
    Next ilIndex

    If tmSdf.sSpotType = "X" Then
        If (tmSdf.sSchStatus <> "S") And (tmSdf.sSchStatus <> "G") And (tmSdf.sSchStatus <> "O") Then
            Exit Sub
        End If
        slPtType = tmSdf.sPtType
        llCopyCode = tmSdf.lCopyCode
    Else
        If ((tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S")) Or ((tgSpf.sInvAirOrder = "O") And (tgSpf.sBLaserForm = "2")) Then
            If (tmSdf.sSchStatus <> "S") And (tmSdf.sSchStatus <> "G") And (tmSdf.sSchStatus <> "O") Then
                Exit Sub
            End If
            slPtType = tmSdf.sPtType
            llCopyCode = tmSdf.lCopyCode
        Else
            If (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
                slPtType = tmSmf.sPtType
                llCopyCode = tmSmf.lCopyCode
            Else
                slPtType = tmSdf.sPtType
                llCopyCode = tmSdf.lCopyCode
            End If
        End If
    End If
    ilCopy = LBONE  '1
    If slPtType = "1" Then  '  Single Copy
        ' Read CIF using lCopyCode from SDF
        tmCifSrchKey.lCode = llCopyCode
        ilRet = btrGetEqual(hmCif, tmCif, imCifRecLen, tmCifSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If ilRet = BTRV_ERR_NONE Then
            If tmCif.lcpfCode > 0 Then
                tmCpfSrchKey.lCode = tmCif.lcpfCode
                ilRet = btrGetEqual(hmCpf, tmCpf, imCpfRecLen, tmCpfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                If ilRet <> BTRV_ERR_NONE Then
                    tmCpf.sISCI = ""
                    tmCpf.sName = ""
                End If
                slCopy(ilCopy) = Trim$(tmCpf.sISCI)
                slProduct(ilCopy) = Trim$(tmCpf.sName)
            End If
        End If
    ElseIf slPtType = "2" Then  '  Combo Copy
    ElseIf slPtType = "3" Then  '  Time Zone Copy
        ' Read TZF using lCopyCode from SDF
        tmTzfSrchKey.lCode = llCopyCode
        ilRet = btrGetEqual(hmTzf, tmTzf, imTzfRecLen, tmTzfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If ilRet = BTRV_ERR_NONE Then
            ' Look for the first positive lZone value
            'For ilIndex = 1 To 6 Step 1
            For ilIndex = 0 To 5 Step 1
                If (tmTzf.lCifZone(ilIndex) > 0) And (StrComp(Trim$(tmTzf.sZone(ilIndex)), "Oth", 1) <> 0) Then ' Process just the first positive Zone
                    ' Read CIF using lCopyCode from SDF
                    tmCifSrchKey.lCode = tmTzf.lCifZone(ilIndex)
                    ilRet = btrGetEqual(hmCif, tmCif, imCifRecLen, tmCifSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                    If ilRet = BTRV_ERR_NONE Then
                        If tmCif.lcpfCode > 0 Then
                            tmCpfSrchKey.lCode = tmCif.lcpfCode
                            ilRet = btrGetEqual(hmCpf, tmCpf, imCpfRecLen, tmCpfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                            If ilRet <> BTRV_ERR_NONE Then
                                tmCpf.sISCI = ""
                                tmCpf.sName = ""
                            End If
                            If Trim$(tmCpf.sISCI) <> "" Then
                                slCopy(ilCopy) = Trim$(tmTzf.sZone(ilIndex)) & ": " & Trim$(tmCpf.sISCI)
                                slProduct(ilCopy) = Trim$(tmCpf.sName)
                                ilCopy = ilCopy + 1
                            End If
                        End If
                    End If
                End If
            Next ilIndex
            'For ilIndex = 1 To 6 Step 1
            For ilIndex = 0 To 5 Step 1
                If (tmTzf.lCifZone(ilIndex) > 0) And (StrComp(Trim$(tmTzf.sZone(ilIndex)), "Oth", 1) = 0) Then ' Process just the first positive Zone
                    ' Read CIF using lCopyCode from SDF
                    tmCifSrchKey.lCode = tmTzf.lCifZone(ilIndex)
                    ilRet = btrGetEqual(hmCif, tmCif, imCifRecLen, tmCifSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                    If ilRet = BTRV_ERR_NONE Then
                        If tmCif.lcpfCode > 0 Then
                            tmCpfSrchKey.lCode = tmCif.lcpfCode
                            ilRet = btrGetEqual(hmCpf, tmCpf, imCpfRecLen, tmCpfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                            If ilRet <> BTRV_ERR_NONE Then
                                tmCpf.sISCI = ""
                                tmCpf.sName = ""
                            End If
                            If Trim$(tmCpf.sISCI) <> "" Then
                                slCopy(ilCopy) = "Other: " & Trim$(tmCpf.sISCI)
                                slProduct(ilCopy) = Trim$(tmCpf.sName)
                                ilCopy = ilCopy + 1
                            End If
                        End If
                    End If
                End If
            Next ilIndex
        End If
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mObtainDates                    *
'*                                                     *
'*             Created:3/01/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Obtain standard and calendar   *
'*                      dates to be billed             *
'*                                                     *
'*******************************************************
Private Sub mObtainDates()
    Dim slDate As String
    Dim slName As String
    Dim ilRet As Integer
    Dim slNameCode As String
    Dim slCode As String
    Dim ilVefCode As Integer
    Dim llEarliestDate As Long
    Dim llLatestDate As Long
    Dim llVehEarliestDate As Long
    Dim llVehLatestDate As Long
    Dim llVehEarliestUnComplete As Long
    Dim llEarliestUnComplete As Long
    Dim ilLoop As Integer
    Dim slStartDate As String
    Dim slEndDate As String
    Dim ilSelected As Integer
    Dim ilVehWithoutDates As Integer
    Dim slMsg As String
    Dim ilPos As Integer

    If imObtainDateCalled Then
        Exit Sub
    End If
    smStartStd = ""
    smEndStd = ""
    smStartCal = ""
    smEndCal = ""
    smStartWk = ""
    smEndWk = ""
    lmStartStd = 0
    lmEndStd = 0
    lmStartCal = 0
    lmEndCal = 0
    lmStartWk = 0
    lmEndWk = 0
    imFullStd = False
    imFullCal = False
    imFullWk = False
    ilVehWithoutDates = False
    gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slDate
    lmSpfStdDate = gDateValue(slDate)
    gUnpackDate tgSpf.iBLastCalMnth(0), tgSpf.iBLastCalMnth(1), slDate
    lmSpfCalDate = gDateValue(slDate)
    gUnpackDate tgSaf(0).iBLastWeeklyDate(0), tgSaf(0).iBLastWeeklyDate(1), slDate
    lmSafWkDate = gDateValue(slDate)
    ilSelected = False
    For ilLoop = 0 To lbcVehicle.ListCount - 1 Step 1
        If lbcVehicle.Selected(ilLoop) Then
            ilSelected = True
            Exit For
        End If
    Next ilLoop
    If Not ilSelected Then
        'If (lmSpfStdDate > 0) And (ckcType(INVTYPE_Commercial).Visible = False) Then
        If (lmSpfStdDate > 0) And ((ckcType(INVTYPE_Commercial).Value = vbUnchecked) Or (ckcType(INVTYPE_Commercial).Visible = False)) Then
            slStartDate = gObtainStartStd(Format$(lmSpfStdDate + 10, "m/d/yy"))
            slEndDate = gObtainEndStd(Format$(lmSpfStdDate + 10, "m/d/yy"))
            If lmNowDate >= gDateValue(slEndDate) Then
                '10-31-01 plcStdDate.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                lacStdDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                smStartStd = slStartDate
                smEndStd = slEndDate
                lmStartStd = gDateValue(smStartStd)
                lmEndStd = gDateValue(smEndStd)
                imFullStd = True
            Else
                lacStdDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(lmNowDate - 1, "m/d/yy")) & ", Expired Only Or Full if Preliminary"
                smStartStd = slStartDate
                smEndStd = Format$(lmNowDate - 1, "m/d/yy")
                lmStartStd = gDateValue(smStartStd)
                lmEndStd = gDateValue(smEndStd)
            End If
            slStartDate = gObtainStartCal(Format$(lmSpfCalDate + 10, "m/d/yy"))
            slEndDate = gObtainEndCal(Format$(lmSpfCalDate + 10, "m/d/yy"))
            If lmNowDate >= gDateValue(slEndDate) Then
                lacCalDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                smStartCal = slStartDate
                smEndCal = slEndDate
                lmStartCal = gDateValue(smStartCal)
                lmEndCal = gDateValue(smEndCal)
                imFullCal = True
            Else
                lacCalDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(lmNowDate - 1, "m/d/yy")) & ", Expired Only Or Full if Preliminary"
                smStartCal = slStartDate
                smEndCal = Format$(lmNowDate - 1, "m/d/yy")
                lmStartCal = gDateValue(smStartCal)
                lmEndCal = gDateValue(smEndCal)
            End If
            slStartDate = gObtainPrevMonday(Format$(lmSafWkDate + 1, "m/d/yy"))
            slEndDate = gObtainNextSunday(Format$(lmSafWkDate + 1, "m/d/yy"))
            If lmNowDate >= gDateValue(slEndDate) Then
                lacWkDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Week"
                smStartWk = slStartDate
                smEndWk = slEndDate
                lmStartWk = gDateValue(smStartWk)
                lmEndWk = gDateValue(smEndWk)
                imFullWk = True
            Else
                lacWkDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(lmNowDate - 1, "m/d/yy")) & ", Expired Only Or Full if Preliminary"
                smStartWk = slStartDate
                smEndWk = Format$(lmNowDate - 1, "m/d/yy")
                lmStartWk = gDateValue(smStartWk)
                lmEndWk = gDateValue(smEndWk)
            End If
        Else
            '10-31-01 plcStdDate.Caption = "No Invoicing Dates as Vehicle not Selected"
            lacStdDates.Caption = "No Invoicing Dates as Vehicle not Selected"
            '10-31-01 plcCalDate.Caption = "No Invoicing Dates as Vehicle not Selected"
            lacCalDates.Caption = "No Invoicing Dates as Vehicle not Selected"
            lacWkDates.Caption = "No Invoicing Dates as Vehicle not Selected"
        End If
        smStdDateMsg = lacStdDates.Caption
        If ckcBillCycle(INVBILLCYCLE_STD).Value = vbUnchecked Then
            lacStdDates.Caption = ""
        End If
        smCalDateMsg = lacCalDates.Caption
        If ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbUnchecked Then
            If ckcBillCycle(INVBILLCYCLE_Calendar).Enabled Then
                lacCalDates.Caption = ""
            Else
                lacCalDates.Caption = "N/A"
            End If
        End If
        smWkDateMsg = lacWkDates.Caption
        If ckcBillCycle(INVBILLCYCLE_Week).Value = vbUnchecked Then
            If ckcBillCycle(INVBILLCYCLE_Week).Enabled Then
                lacWkDates.Caption = ""
            Else
                lacWkDates.Caption = "N/A"
            End If
        End If
        Exit Sub
    End If
    llEarliestDate = 0
    llLatestDate = 0
    ReDim tgNotMarkComplete(0 To 0) As NOTMARKCOMPLETE
    'Loop on vehicles
    For ilLoop = 0 To lbcVehicle.ListCount - 1 Step 1
        If lbcVehicle.Selected(ilLoop) Then
            slNameCode = tmInvVehicle(ilLoop).sKey    'Traffic!lbcVehicle.List(ilLoop)
            ilRet = gParseItem(slNameCode, 1, "\", slName)    'Get application name
            ilRet = gParseItem(slName, 3, "|", slName)    'Get application name
            ilRet = gParseItem(slNameCode, 2, "\", slCode)    'Get application name
            ilVefCode = Val(slCode)
            mLastCompletedDate ilVefCode, llVehEarliestDate, llVehLatestDate, llVehEarliestUnComplete
            If llVehEarliestDate <> -1 Then
                If llVehEarliestDate = 0 Then
                    'llEarliestDate = 0
                    'llLatestDate = 0
                    'Exit For
                    ilVehWithoutDates = True
                Else
                    If llEarliestDate = 0 Then
                        llEarliestDate = llVehEarliestDate
                        llLatestDate = llVehLatestDate
                        llEarliestUnComplete = llVehEarliestUnComplete
                    Else
                        If llVehEarliestDate < llEarliestDate Then
                            llEarliestDate = llVehEarliestDate
                        End If
                        If llVehLatestDate < llLatestDate Then
                            llLatestDate = llVehLatestDate
                        End If
                        If llVehEarliestUnComplete < llEarliestUnComplete Then
                            llEarliestUnComplete = llVehEarliestUnComplete
                        End If
                    End If
                End If
            End If
        End If
    Next ilLoop
    'If llEarliestDate = 0 Then
    '1/30/08:  Remove No Date message to handle case of only Rep vehicle or Installment prior to any programming
    If (ilVehWithoutDates) Or (llEarliestDate = 0) Then
        ''10-31-01 plcStdDate.Caption = "No Dates Marked as Complete"
        'lacStdDates.Caption = "No Posted Dates"
        ''10-31-01 plcCalDate.Caption = "No Dates Marked as Complete"
        'lacCalDates.Caption = "No Posted Dates"
        'smStdDateMsg = lacStdDates.Caption
        'smCalDateMsg = lacCalDates.Caption
        'Exit Sub
        lmSpfStdDate = 0
        gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slDate
        If slDate <> "" Then
            If gDateValue(slDate) Then
                lmSpfStdDate = gDateValue(slDate)
            End If
        End If
        If lmSpfStdDate = 0 Then
            lacStdDates.Caption = "No Posted Dates or Last Invoice Date"
            'lacCalDates.Caption = "No Posted Dates or Last Invoice Date"
            smStdDateMsg = lacStdDates.Caption
            'smCalDateMsg = lacCalDates.Caption
            'Exit Sub
        Else
            slStartDate = gObtainStartStd(Format$(lmSpfStdDate + 10, "m/d/yy"))
            slEndDate = gObtainEndStd(Format$(lmSpfStdDate + 10, "m/d/yy"))
            If (tgSpf.sBActDayCompl = "Y") Then
                lacStdDates.Caption = "No Dates marked as Complete in " & slStartDate & "-" & slEndDate
            Else
                If gDateValue(slEndDate) < lmNowDate Then
                    lacStdDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                    smStartStd = slStartDate
                    smEndStd = slEndDate
                    lmStartStd = gDateValue(smStartStd)
                    lmEndStd = gDateValue(smEndStd)
                    imFullStd = True
                ElseIf (gDateValue(slEndDate) < lmNowDate + (7 - gWeekDayLong(lmNowDate))) And (gWeekDayLong(lmNowDate) >= 4) And ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) Then
                    slEndDate = gObtainNextSunday(slEndDate)
                    lacStdDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                    smStartStd = slStartDate
                    smEndStd = slEndDate
                    lmStartStd = gDateValue(smStartStd)
                    lmEndStd = gDateValue(smEndStd)
                    imFullStd = True
                Else
                    If ((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) = INSTALLMENT) Then
                        '3/4/19: Temporarily remove advance bill feature
                        lacStdDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(lmNowDate - 1, "m/d/yy")) & ", Expired Contracts"  ' and Advance Billing"
                    Else
                        lacStdDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(lmNowDate - 1, "m/d/yy")) & ", Expired Contracts Only"
                    End If
                    smStartStd = slStartDate
                    smEndStd = Format$(lmNowDate - 1, "m/d/yy")
                    lmStartStd = gDateValue(smStartStd)
                    lmEndStd = gDateValue(smEndStd)
                End If
            End If
        End If
        lmSpfCalDate = 0
        gUnpackDate tgSpf.iBLastCalMnth(0), tgSpf.iBLastCalMnth(1), slDate
        If slDate <> "" Then
            If gDateValue(slDate) Then
                lmSpfCalDate = gDateValue(slDate)
            End If
        End If
        If lmSpfCalDate = 0 Then
            'lacStdDates.Caption = "No Posted Dates or Last Invoice Date"
            lacCalDates.Caption = "No Posted Dates or Last Invoice Date"
            'smStdDateMsg = lacStdDates.Caption
            smCalDateMsg = lacCalDates.Caption
            'Exit Sub
        Else
            slStartDate = gObtainStartCal(Format$(lmSpfCalDate + 10, "m/d/yy"))
            slEndDate = gObtainEndCal(Format$(lmSpfCalDate + 10, "m/d/yy"))
            If (tgSpf.sBActDayCompl = "Y") Then
                lacCalDates.Caption = "No Dates marked as Complete in " & slStartDate & "-" & slEndDate
            Else
                If gDateValue(slEndDate) < lmNowDate Then
                    lacCalDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                    smStartCal = slStartDate
                    smEndCal = slEndDate
                    lmStartCal = gDateValue(smStartCal)
                    lmEndCal = gDateValue(smEndCal)
                    imFullCal = True
                Else
                    If ((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) = INSTALLMENT) Then
                        '3/4/19: Temporarily remove advance bill feature
                        lacCalDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(lmNowDate - 1, "m/d/yy")) & ", Expired Contracts"  ' and Advance Billing"
                    Else
                        lacCalDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(lmNowDate - 1, "m/d/yy")) & ", Expired Contracts Only"
                    End If
                    smStartCal = slStartDate
                    smEndCal = Format$(lmNowDate - 1, "m/d/yy")
                    lmStartCal = gDateValue(smStartStd)
                    lmEndCal = gDateValue(smEndStd)
                End If
            End If
        End If
    
        lmSafWkDate = 0
        gUnpackDate tgSaf(0).iBLastWeeklyDate(0), tgSaf(0).iBLastWeeklyDate(1), slDate
        If slDate <> "" Then
            If gDateValue(slDate) Then
                lmSafWkDate = gDateValue(slDate)
            End If
        End If
        If (lmSafWkDate = 0) Or (lmSafWkDate = gDateValue("1/1/1990")) Then
            'lacStdDates.Caption = "No Posted Dates or Last Invoice Date"
            lacWkDates.Caption = "No Posted Dates or Last Invoice Date"
            'smStdDateMsg = lacStdDates.Caption
            smWkDateMsg = lacWkDates.Caption
            'Exit Sub
        Else
            slStartDate = gObtainPrevMonday(Format$(lmSafWkDate + 1, "m/d/yy"))
            slEndDate = gObtainNextSunday(Format$(lmSafWkDate + 1, "m/d/yy"))
            If (tgSpf.sBActDayCompl = "Y") Then
                lacWkDates.Caption = "No Dates marked as Complete in " & slStartDate & "-" & slEndDate
            Else
                If gDateValue(slEndDate) < lmNowDate Then
                    lacWkDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Week"
                    smStartWk = slStartDate
                    smEndWk = slEndDate
                    lmStartWk = gDateValue(smStartWk)
                    lmEndWk = gDateValue(smEndWk)
                    imFullWk = True
                ElseIf (gDateValue(slEndDate) < lmNowDate + (7 - gWeekDayLong(lmNowDate))) And (gWeekDayLong(lmNowDate) >= 4) And ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) Then
                    slEndDate = gObtainNextSunday(slEndDate)
                    lacWkDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Week"
                    smStartWk = slStartDate
                    smEndWk = slEndDate
                    lmStartWk = gDateValue(smStartWk)
                    lmEndWk = gDateValue(smEndWk)
                    imFullWk = True
                Else
                    If ((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) = INSTALLMENT) Then
                        '3/4/19: Temporarily remove advance bill feature
                        lacWkDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(lmNowDate - 1, "m/d/yy")) & ", Expired Contracts"   ' and Advance Billing"
                    Else
                        lacWkDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(lmNowDate - 1, "m/d/yy")) & ", Expired Contracts Only"
                    End If
                    smStartWk = slStartDate
                    smEndWk = Format$(lmNowDate - 1, "m/d/yy")
                    lmStartWk = gDateValue(smStartWk)
                    lmEndWk = gDateValue(smEndWk)
                End If
            End If
        End If
    Else
        'Determine next invoicing Dates
        lmSpfStdDate = 0
        gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slDate
        If slDate <> "" Then
            If gDateValue(slDate) Then
                lmSpfStdDate = gDateValue(slDate)
            End If
        End If
        If lmSpfStdDate = 0 Then
            slStartDate = gObtainStartStd(Format$(llEarliestDate, "m/d/yy"))
            slEndDate = gObtainEndStd(Format$(llEarliestDate, "m/d/yy"))
        Else
            slStartDate = gObtainStartStd(Format$(lmSpfStdDate + 10, "m/d/yy"))
            slEndDate = gObtainEndStd(Format$(lmSpfStdDate + 10, "m/d/yy"))
        End If
        If llLatestDate < gDateValue(slStartDate) Then
            '10-31-01 plcStdDate.Caption = "No Dates marked as Complete in" & slStartDate & "-" & slEndDate
            lacStdDates.Caption = "No Dates marked as Complete in " & slStartDate & "-" & slEndDate
        Else
            If llLatestDate >= gDateValue(slEndDate) Then
                '10-31-01 plcStdDate.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                lacStdDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                smStartStd = slStartDate
                smEndStd = slEndDate
                lmStartStd = gDateValue(smStartStd)
                lmEndStd = gDateValue(smEndStd)
                imFullStd = True
            Else
                If llEarliestUnComplete > gDateValue(slEndDate) Then
                    '10-31-01 plcStdDate.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                    lacStdDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                    smStartStd = slStartDate
                    smEndStd = slEndDate
                    lmStartStd = gDateValue(smStartStd)
                    lmEndStd = gDateValue(smEndStd)
                    imFullStd = True
                ElseIf (gDateValue(slEndDate) < lmNowDate + (7 - gWeekDayLong(lmNowDate))) And (gWeekDayLong(lmNowDate) >= 4) And ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) Then
                    slEndDate = gObtainNextSunday(slEndDate)
                    lacStdDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                    smStartStd = slStartDate
                    smEndStd = slEndDate
                    lmStartStd = gDateValue(smStartStd)
                    lmEndStd = gDateValue(smEndStd)
                    imFullStd = True
                Else
                    '10-31-01 plcStdDate.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(llEarliestUnComplete - 1, "m/d/yy")) & ", Expired Only"
                    If ((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) = INSTALLMENT) Then
                        '3/4/19: Temporarily remove advance bill feature
                        lacStdDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(llEarliestUnComplete - 1, "m/d/yy")) & ", Expired Contracts"   ' and Advance Billing"
                    Else
                        lacStdDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(llEarliestUnComplete - 1, "m/d/yy")) & ", Expired Contracts Only"
                    End If
                    smStartStd = slStartDate
                    smEndStd = Format$(llLatestDate, "m/d/yy")
                    lmStartStd = gDateValue(smStartStd)
                    lmEndStd = gDateValue(smEndStd)
                End If
            End If
        End If
        lmSpfCalDate = 0
        gUnpackDate tgSpf.iBLastCalMnth(0), tgSpf.iBLastCalMnth(1), slDate
        If slDate <> "" Then
            If gDateValue(slDate) Then
                lmSpfCalDate = gDateValue(slDate)
            End If
        End If
        If lmSpfCalDate = 0 Then
            slStartDate = gObtainStartCal(Format$(llEarliestDate, "m/d/yy"))
            slEndDate = gObtainEndCal(Format$(llEarliestDate, "m/d/yy"))
        Else
            slStartDate = gObtainStartCal(Format$(lmSpfCalDate + 10, "m/d/yy"))
            slEndDate = gObtainEndCal(Format$(lmSpfCalDate + 10, "m/d/yy"))
        End If
        If llLatestDate < gDateValue(slStartDate) Then
            '10-31-01 plcCalDate.Caption = "No Dates marked as Complete in" & slStartDate & "-" & slEndDate
            lacCalDates.Caption = "No Dates marked as Complete in " & slStartDate & "-" & slEndDate
        Else
            If llLatestDate >= gDateValue(slEndDate) Then
                '10-31-01 plcCalDate.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                lacCalDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                smStartCal = slStartDate
                smEndCal = slEndDate
                lmStartCal = gDateValue(smStartCal)
                lmEndCal = gDateValue(smEndCal)
                imFullCal = True
            Else
                If llEarliestUnComplete > gDateValue(slEndDate) Then
                    'plcCalDate.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                    lacCalDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                    smStartCal = slStartDate
                    smEndCal = slEndDate
                    lmStartCal = gDateValue(smStartCal)
                    lmEndCal = gDateValue(smEndCal)
                    imFullCal = True
                Else
                    '10-31-01 plcCalDate.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(llEarliestUnComplete - 1, "m/d/yy")) & ", Expired Only"
                    If ((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) = INSTALLMENT) Then
                        '3/4/19: Temporarily remove advance bill feature
                        lacCalDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(llEarliestUnComplete - 1, "m/d/yy")) & ", Expired Contracts"   ' and Advance Billing"
                    Else
                        lacCalDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(llEarliestUnComplete - 1, "m/d/yy")) & ", Expired Contracts Only"
                    End If
                    smStartCal = slStartDate
                    smEndCal = Format$(llLatestDate, "m/d/yy")
                    lmStartCal = gDateValue(smStartCal)
                    lmEndCal = gDateValue(smEndCal)
                End If
            End If
        End If
    
    
        lmSafWkDate = 0
        gUnpackDate tgSaf(0).iBLastWeeklyDate(0), tgSaf(0).iBLastWeeklyDate(1), slDate
        If slDate <> "" Then
            If gDateValue(slDate) Then
                lmSafWkDate = gDateValue(slDate)
            End If
        End If
        If lmSafWkDate = 0 Then
            slStartDate = gObtainPrevMonday(Format$(llEarliestDate, "m/d/yy"))
            slEndDate = gObtainNextSunday(Format$(llEarliestDate, "m/d/yy"))
        Else
            slStartDate = gObtainPrevMonday(Format$(lmSafWkDate + 1, "m/d/yy"))
            slEndDate = gObtainNextSunday(Format$(lmSafWkDate + 1, "m/d/yy"))
        End If
        If llLatestDate < gDateValue(slStartDate) Then
            '10-31-01 plcCalDate.Caption = "No Dates marked as Complete in" & slStartDate & "-" & slEndDate
            lacWkDates.Caption = "No Dates marked as Complete in " & slStartDate & "-" & slEndDate
        Else
            If llLatestDate >= gDateValue(slEndDate) Then
                '10-31-01 plcCalDate.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                lacWkDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Week"
                smStartWk = slStartDate
                smEndWk = slEndDate
                lmStartWk = gDateValue(smStartWk)
                lmEndWk = gDateValue(smEndWk)
                imFullWk = True
            Else
                If llEarliestUnComplete > gDateValue(slEndDate) Then
                    'plcCalDate.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Month"
                    lacWkDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Week"
                    smStartWk = slStartDate
                    smEndWk = slEndDate
                    lmStartWk = gDateValue(smStartWk)
                    lmEndWk = gDateValue(smEndWk)
                    imFullWk = True
                ElseIf (gDateValue(slEndDate) < lmNowDate + (7 - gWeekDayLong(lmNowDate))) And (gWeekDayLong(lmNowDate) >= 4) And ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) Then
                    slEndDate = gObtainNextSunday(slEndDate)
                    lacWkDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(slEndDate) & ", Full Week"
                    smStartWk = slStartDate
                    smEndWk = slEndDate
                    lmStartWk = gDateValue(smStartWk)
                    lmEndWk = gDateValue(smEndWk)
                    imFullWk = True
                Else
                    '10-31-01 plcCalDate.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(llEarliestUnComplete - 1, "m/d/yy")) & ", Expired Only"
                    If ((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) = INSTALLMENT) Then
                        '3/4/19: Temporarily remove advance bill feature
                        lacWkDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(llEarliestUnComplete - 1, "m/d/yy")) & ", Expired Contracts"    ' and Advance Billing"
                    Else
                        lacWkDates.Caption = gAddDayToDate(slStartDate) & " - " & gAddDayToDate(Format$(llEarliestUnComplete - 1, "m/d/yy")) & ", Expired Contracts Only"
                    End If
                    smStartWk = slStartDate
                    smEndWk = Format$(llLatestDate, "m/d/yy")
                    lmStartWk = gDateValue(smStartWk)
                    lmEndWk = gDateValue(smEndWk)
                End If
            End If
        End If
    End If
    If (rbcType(INVGEN_Preliminary).Value) And ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_GenRepAR).Value = vbChecked)) Then
        slMsg = ""
        If (Not imFullStd) And (ckcType(INVTYPE_Commercial).Value = vbChecked) Then
            slMsg = "Standard"
        End If
        If (Not imFullCal) And (ckcType(INVTYPE_Commercial).Value = vbChecked) And (ckcBillCycle(INVBILLCYCLE_Calendar).Enabled) Then
            If slMsg = "" Then
                slMsg = "Calendar"
            Else
                slMsg = slMsg & ", Calendar"
            End If
        End If
        If (Not imFullWk) And (ckcType(INVTYPE_Commercial).Value = vbChecked) And (ckcBillCycle(INVBILLCYCLE_Week).Enabled) Then
            If slMsg = "" Then
                slMsg = "Week"
            Else
                slMsg = slMsg & ", Week"
            End If
        End If
        If slMsg <> "" Then
            'sgGenMsg = "Generate Preliminary Invoice for Full " & slMsg & " or Expired Contracts Only"
            'sgCMCTitle(0) = "Full Period"
            'sgCMCTitle(1) = "Expired"
            'sgCMCTitle(2) = ""
            'sgCMCTitle(3) = ""
            'igDefCMC = 0
            'igEditBox = 0
            'GenMsg.Show vbModal
            'DoEvents
            'If igAnsCMC = 0 Then    'Full
            ilPos = InStrRev(slMsg, ",")
            If ilPos > 0 Then
                slMsg = Mid(slMsg, 1, ilPos - 1) & " and " & Mid(slMsg, ilPos + 2)
            End If
            '12/28/17: Ask question only once
            If imAppendFutureSpots = -1 Then
                ilRet = MsgBox("Append Future Spots through End of the Billing Cycles (" & slMsg & ")?", vbYesNo + vbDefaultButton2, "Preliminary")
                imAppendFutureSpots = ilRet
            Else
                ilRet = imAppendFutureSpots
            End If
            If ilRet = vbYes Then
                If (Not imFullStd) And (ckcType(INVTYPE_Commercial).Value = vbChecked) Then
                    If smStartStd <> "" Then
                        lacStdDates.Caption = gAddDayToDate(smStartStd) & " - " & gAddDayToDate(smEndStd) & ", Full Month"
                        smEndStd = gObtainEndStd(smStartStd)
                        lmEndStd = gDateValue(smEndStd)
                        lmStartStd = gDateValue(smStartStd)
                        lmEndStd = gDateValue(smEndStd)
                        imFullStd = True
                    Else
                        lacStdDates.Caption = "N/A"
                    End If
                End If
                If (Not imFullCal) And (ckcType(INVTYPE_Commercial).Value = vbChecked) And (ckcBillCycle(INVBILLCYCLE_Calendar).Enabled) Then
                    If smStartCal <> "" Then
                        lacCalDates.Caption = gAddDayToDate(smStartCal) & " - " & gAddDayToDate(smEndCal) & ", Full Month"
                        smEndCal = gObtainEndCal(smStartCal)
                        lmEndCal = gDateValue(smEndCal)
                        lmStartCal = gDateValue(smStartCal)
                        lmEndCal = gDateValue(smEndCal)
                        imFullCal = True
                    Else
                        lacCalDates.Caption = "N/A"
                    End If
                End If
                If (Not imFullWk) And (ckcType(INVTYPE_Commercial).Value = vbChecked) And (ckcBillCycle(INVBILLCYCLE_Week).Enabled) Then
                    If smStartWk <> "" Then
                        lacWkDates.Caption = gAddDayToDate(smStartWk) & " - " & gAddDayToDate(smEndWk) & ", Full Week"
                        smEndWk = gObtainNextSunday(smStartWk)
                        lmEndWk = gDateValue(smEndWk)
                        lmStartWk = gDateValue(smStartWk)
                        lmEndWk = gDateValue(smEndWk)
                        imFullWk = True
                    Else
                        lacWkDates.Caption = "N/A"
                    End If
                End If
                If imCombineAirAndNTR Then
                    lmNTRDate = lmEndStd
                End If
            End If
        End If
    End If
    smStdDateMsg = lacStdDates.Caption
    If ckcBillCycle(INVBILLCYCLE_STD).Value = vbUnchecked Then
        lacStdDates.Caption = ""
    End If
    smCalDateMsg = lacCalDates.Caption
    If ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbUnchecked Then
        If ckcBillCycle(INVBILLCYCLE_Calendar).Enabled Then
            lacCalDates.Caption = ""
        Else
            lacCalDates.Caption = "N/A"
        End If
    End If
    smWkDateMsg = lacWkDates.Caption
    If ckcBillCycle(INVBILLCYCLE_Week).Value = vbUnchecked Then
        If ckcBillCycle(INVBILLCYCLE_Week).Enabled Then
            lacWkDates.Caption = ""
        Else
            lacWkDates.Caption = "N/A"
        End If
    End If
    mSetViewControl
    imObtainDateCalled = True
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mObtainPsf                      *
'*                                                     *
'*             Created:9/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Get Package Spots              *
'*                                                     *
'*******************************************************
Private Sub mObtainPsf(ilSpots As Integer, llStartDate As Long, llEndDate As Long, ilAllowedDays() As Integer, ilUpper As Integer, llStdStartDate As Long, llStdEndDate As Long, llCalStartDate As Long, llCalEndDate As Long, llWkStartDate As Long, llWkEndDate As Long, llBaseDate As Long)
'
'   Where
'       tmCff(I)- Flight
'       tmClf(I)- Line
'
    Dim ilRet As Integer
    Dim slDate As String
    Dim llDate As Long
    Dim ilLoop As Integer
    Dim llRecPos As Long
    Dim ilNoSpotsFd As Integer   'Number of spots found or created
    Dim ilIncludeSpot As Integer
    Dim llPsfCode As Long
    Dim tlSdfExt As SDFEXT
    If ilSpots <= 0 Then
        Exit Sub
    End If
    ReDim tmPsfInfo(0 To 0) As PSFINFO
    ilNoSpotsFd = 0
    tmPsfSrchKey.iVefCode = tmClf.iVefCode
    tmPsfSrchKey.lChfCode = tmClf.lChfCode
    tmPsfSrchKey.iLineNo = tmClf.iLine
    tmPsfSrchKey.lFsfCode = 0
    slDate = Format$(llStartDate, "m/d/yy")
    gPackDate slDate, tmPsfSrchKey.iDate(0), tmPsfSrchKey.iDate(1)
    '12/14/15: Include cancelled spots
    'tmPsfSrchKey.sSchStatus = "S"
    tmPsfSrchKey.sSchStatus = ""
    tmPsfSrchKey.iTime(0) = 0
    tmPsfSrchKey.iTime(1) = 0
    ilRet = btrGetGreaterOrEqual(hmPsf, tmPsf, imPsfRecLen, tmPsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmPsf.iVefCode = tmClf.iVefCode) And (tmPsf.lChfCode = tmClf.lChfCode) And (tmPsf.iLineNo = tmClf.iLine)
        'gUnpackDateLong tmPsf.iDate(0), tmPsf.iDate(1), llDate
        gUnpackDateLongError tmPsf.iDate(0), tmPsf.iDate(1), llDate, "41:mObtainPsf " & tmPsf.lCode
        If llDate > llEndDate Then
            Exit Do
        End If
        If (llDate >= llStartDate) And (llDate <= llEndDate) Then
            ilRet = btrGetPosition(hmPsf, llRecPos)
            ilNoSpotsFd = ilNoSpotsFd + 1
            gUnpackDateLong tmPsf.iDate(0), tmPsf.iDate(1), tmPsfInfo(UBound(tmPsfInfo)).lDate
            gUnpackTimeLong tmPsf.iTime(0), tmPsf.iTime(1), True, tmPsfInfo(UBound(tmPsfInfo)).lTime
            ReDim Preserve tmPsfInfo(0 To UBound(tmPsfInfo) + 1) As PSFINFO
            ilIncludeSpot = False
            If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then     '11-15-16 archive, Reprint- get Billed spots
                If tmPsf.sBill = "Y" Then
                    ilIncludeSpot = True
                End If
            Else
                If tmPsf.sBill <> "Y" Then
                    ilIncludeSpot = True
                End If
            End If
            If tmChf.sBillCycle = "C" Then
                If (llDate < llCalStartDate) Or (llDate > llCalEndDate) Then
                    ilIncludeSpot = False
                End If
            ElseIf tmChf.sBillCycle = "W" Then
                If (llDate < llWkStartDate) Or (llDate > llWkEndDate) Then
                    ilIncludeSpot = False
                End If
            Else
                If (llDate < llStdStartDate) Or (llDate > llStdEndDate) Then
                    ilIncludeSpot = False
                End If
            End If
            If ilIncludeSpot Then
                'Assign Copy
                If tmPsf.sSchStatus = "S" Then
                    mAssignCopyToSpot 0, hmPsf, tmPsf, tmSmf
                End If
                'Add Spot to Sort
                'Build tlSdfExt so same sort code can be used
                tlSdfExt.iVefCode = tmPsf.iVefCode     'Vehicle Code (combos not allowed)
                tlSdfExt.lChfCode = tmPsf.lChfCode       'Contract code
                tlSdfExt.iLineNo = tmPsf.iLineNo       'Contract code
                tlSdfExt.iDate(0) = tmPsf.iDate(0)    'Schedule or missed Date of spot
                tlSdfExt.iDate(1) = tmPsf.iDate(1)    'Schedule or missed Date of spot
                tlSdfExt.iTime(0) = tmPsf.iTime(0)    'Schedule or missed Date of spot
                tlSdfExt.iTime(1) = tmPsf.iTime(1)    'Schedule or missed Date of spot
                tlSdfExt.sSchStatus = tmPsf.sSchStatus    'S=Scheduled, M=Missed, R=Ready to schd MG, U=Unscheduled MG,
                tlSdfExt.sTracer = " "
                tlSdfExt.iLen = tmPsf.iLen         'Spot length
                tlSdfExt.lRecPos = llRecPos         'Record position
                tlSdfExt.lCode = tmPsf.lCode
                tlSdfExt.lMdDate = 0    'Missed date for MG's (used in gCntrDisp)
                tlSdfExt.iStatus = 2     '0=From Sdf; 1= from Smf
                mCreateSortRec 2, ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate, tlSdfExt
                llPsfCode = tmPsf.lCode
                tmPsfSrchKey.iVefCode = tmClf.iVefCode
                tmPsfSrchKey.lChfCode = tmClf.lChfCode
                tmPsfSrchKey.iLineNo = tmClf.iLine
                tmPsfSrchKey.lFsfCode = 0
                tmPsfSrchKey.iDate(0) = tmPsf.iDate(0)
                tmPsfSrchKey.iDate(1) = tmPsf.iDate(1)
                tmPsfSrchKey.sSchStatus = "S"
                tmPsfSrchKey.iTime(0) = tmPsf.iTime(0)
                tmPsfSrchKey.iTime(1) = tmPsf.iTime(1)
                ilRet = btrGetEqual(hmPsf, tmPsf, imPsfRecLen, tmPsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tmPsf.lCode <> llPsfCode)
                    ilRet = btrGetNext(hmPsf, tmPsf, imPsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop
            End If
            If ilNoSpotsFd >= ilSpots Then
                Exit Sub
            End If
        End If
        ilRet = btrGetNext(hmPsf, tmPsf, imPsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    If ilSpots > ilNoSpotsFd Then
        For ilLoop = ilNoSpotsFd + 1 To ilSpots Step 1
            mMakePsf llStartDate, llEndDate, ilAllowedDays(), ilSpots
            ilRet = btrGetPosition(hmPsf, llRecPos)
            gUnpackDateLong tmPsf.iDate(0), tmPsf.iDate(1), tmPsfInfo(UBound(tmPsfInfo)).lDate
            gUnpackTimeLong tmPsf.iTime(0), tmPsf.iTime(1), True, tmPsfInfo(UBound(tmPsfInfo)).lTime
            ReDim Preserve tmPsfInfo(0 To UBound(tmPsfInfo) + 1) As PSFINFO
            ilIncludeSpot = True
            gUnpackDateLong tmPsf.iDate(0), tmPsf.iDate(1), llDate
            If tmChf.sBillCycle = "C" Then
                If (llDate < llCalStartDate) Or (llDate > llCalEndDate) Then
                    ilIncludeSpot = False
                End If
            ElseIf tmChf.sBillCycle = "W" Then
                If (llDate < llWkStartDate) Or (llDate > llWkEndDate) Then
                    ilIncludeSpot = False
                End If
            Else
                If (llDate < llStdStartDate) Or (llDate > llStdEndDate) Then
                    ilIncludeSpot = False
                End If
            End If
            If ilIncludeSpot Then
                'Assign Copy
                mAssignCopyToSpot 0, hmPsf, tmPsf, tmSmf
                'Add Spot to Sort
                'Build tlSdfExt so same sort code can be used
                tlSdfExt.iVefCode = tmPsf.iVefCode     'Vehicle Code (combos not allowed)
                tlSdfExt.lChfCode = tmPsf.lChfCode       'Contract code
                tlSdfExt.iLineNo = tmPsf.iLineNo       'Contract code
                tlSdfExt.iDate(0) = tmPsf.iDate(0)    'Schedule or missed Date of spot
                tlSdfExt.iDate(1) = tmPsf.iDate(1)    'Schedule or missed Date of spot
                tlSdfExt.iTime(0) = tmPsf.iTime(0)    'Schedule or missed Date of spot
                tlSdfExt.iTime(1) = tmPsf.iTime(1)    'Schedule or missed Date of spot
                tlSdfExt.sSchStatus = tmPsf.sSchStatus    'S=Scheduled, M=Missed, R=Ready to schd MG, U=Unscheduled MG,
                tlSdfExt.sTracer = " "
                tlSdfExt.iLen = tmPsf.iLen         'Spot length
                tlSdfExt.lRecPos = llRecPos         'Record position
                tlSdfExt.iGameNo = 0
                tlSdfExt.lCode = tmPsf.lCode
                tlSdfExt.lMdDate = 0    'Missed date for MG's (used in gCntrDisp)
                tlSdfExt.iStatus = 2     '0=From Sdf; 1= from Smf
                mCreateSortRec 2, ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate, tlSdfExt
            End If
        Next ilLoop
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mRepInv_ObtainCntrInfo           *
'*                                                     *
'*             Created:8/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Get Ordered Gross and # Spots  *
'*                                                     *
'*******************************************************
Sub mRepInv_ObtainCntrInfo(llChfCode As Long, ilPass As Integer, slPctTrade As String, llOGross As Long, ilONoSpots As Integer)
    Dim ilRet As Integer
    Dim ilClf As Integer
    Dim slSFlightDate As String
    Dim slEFlightDate As String
    Dim ilIncludeFlight As Integer
    Dim slTotalNoPerWk As String
    Dim slTotalRate As String
    Dim ilLoop As Integer
    Dim ilCff As Integer
    Dim slSpotRate As String
    Dim ilFound As Integer
    Dim llSpotRate As Long
    Dim ilDay As Integer
    Dim ilVef As Integer
    Dim ilIncludeClf As Integer
    Dim blPostByDateTime As Boolean

    llOGross = 0
    ilONoSpots = 0
    slTotalNoPerWk = "0"
    slTotalRate = "0"
    ReDim tmRepMatch(0 To 0) As REPMATCH
    ilRet = gObtainCntr(hmCHF, hmClf, hmCff, llChfCode, False, tgChfInv, tgClfInv(), tgCffInv())
    If ilRet Then
        For ilClf = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
            ilIncludeClf = False
            ilVef = gBinarySearchVef(tgClfInv(ilClf).ClfRec.iVefCode)
            If ilVef <> -1 Then
                If tgMVef(ilVef).sType = "R" Then
                    ilIncludeClf = True
                End If
            End If
            If (ilIncludeClf) And ((tgClfInv(ilClf).ClfRec.sType = "S") Or (tgClfInv(ilClf).ClfRec.sType = "H")) Then
                blPostByDateTime = mPostRepBy(tgChfInv, tgClfInv(ilClf).ClfRec)
                ilCff = tgClfInv(ilClf).iFirstCff
                Do While ilCff <> -1
                    gUnpackDate tgCffInv(ilCff).CffRec.iStartDate(0), tgCffInv(ilCff).CffRec.iStartDate(1), slSFlightDate
                    gUnpackDate tgCffInv(ilCff).CffRec.iEndDate(0), tgCffInv(ilCff).CffRec.iEndDate(1), slEFlightDate
                    ilIncludeFlight = True
                    If tgChfInv.sBillCycle = "C" Then
                        If (gDateValue(slSFlightDate) > lmEndCal) Or (gDateValue(slEFlightDate) < lmStartCal) Then
                            ilIncludeFlight = False
                        End If
                    ElseIf tgChfInv.sBillCycle = "W" Then
                        If (gDateValue(slSFlightDate) > lmEndWk) Or (gDateValue(slEFlightDate) < lmStartWk) Then
                            ilIncludeFlight = False
                        End If
                    Else
                        If (gDateValue(slSFlightDate) > lmEndStd) Or (gDateValue(slEFlightDate) < lmStartStd) Then
                            ilIncludeFlight = False
                        End If
                    End If
                    'Test if CBS
                    If gDateValue(slEFlightDate) < gDateValue(slSFlightDate) Then
                        ilIncludeFlight = False
                    End If
                    If ilIncludeFlight Then
                        'If the number of spots is zero- ignore flight
                        If tgCffInv(ilCff).CffRec.sDyWk = "D" Then
                            ilIncludeFlight = False
                            For ilDay = 0 To 6 Step 1
                                If tgCffInv(ilCff).CffRec.iDay(ilDay) <> 0 Then
                                    ilIncludeFlight = True
                                End If
                            Next ilDay
                        Else
                            If (tgCffInv(ilCff).CffRec.iSpotsWk = 0) And (tgCffInv(ilCff).CffRec.iXSpotsWk = 0) Then
                                ilIncludeFlight = False
                            End If
                        End If
                    End If
                    If ilIncludeFlight Then
                        slTotalNoPerWk = "0"
                        slTotalRate = "0"
                        mRepInv_ProcFlight ilCff, slSFlightDate, slEFlightDate, ilPass, slPctTrade, slSpotRate, slTotalNoPerWk, slTotalRate
                        'Build array of contracts, vehicle and prices
                        llSpotRate = gStrDecToLong(slSpotRate, 2)
                        ilFound = False
                        For ilLoop = LBound(tmRepMatch) To UBound(tmRepMatch) - 1 Step 1
                            'If tgSpf.sPostCalAff <> "D" Then
                            If Not blPostByDateTime Then
                                If (tmRepMatch(ilLoop).iVefCode = tgClfInv(ilClf).ClfRec.iVefCode) And (tmRepMatch(ilLoop).lPrice = llSpotRate) Then
                                    ilFound = True
                                    tmRepMatch(ilLoop).iONoSpots = tmRepMatch(ilLoop).iONoSpots + Val(slTotalNoPerWk)
                                    Exit For
                                End If
                            Else
                                If (tmRepMatch(ilLoop).iVefCode = tgClfInv(ilClf).ClfRec.iVefCode) And (tmRepMatch(ilLoop).lPrice = llSpotRate) And (tmRepMatch(ilLoop).iLineNo = tgClfInv(ilClf).ClfRec.iLine) Then
                                    ilFound = True
                                    tmRepMatch(ilLoop).iONoSpots = tmRepMatch(ilLoop).iONoSpots + Val(slTotalNoPerWk)
                                    Exit For
                                End If
                            End If
                        Next ilLoop
                        If Not ilFound Then
                            tmRepMatch(UBound(tmRepMatch)).iVefCode = tgClfInv(ilClf).ClfRec.iVefCode
                            tmRepMatch(UBound(tmRepMatch)).lPrice = llSpotRate
                            tmRepMatch(UBound(tmRepMatch)).iONoSpots = Val(slTotalNoPerWk)
                            tmRepMatch(UBound(tmRepMatch)).iLineNo = tgClfInv(ilClf).ClfRec.iLine
                            tmRepMatch(UBound(tmRepMatch)).iPkLineNo = tgClfInv(ilClf).ClfRec.iPkLineNo
                            If blPostByDateTime Then
                                tmRepMatch(UBound(tmRepMatch)).sPostBy = "L"
                            Else
                                tmRepMatch(UBound(tmRepMatch)).sPostBy = "C"
                            End If
                            ReDim Preserve tmRepMatch(0 To UBound(tmRepMatch) + 1) As REPMATCH
                        End If
                    End If
                    ilCff = tgCffInv(ilCff).iNextCff
                Loop

            End If
        Next ilClf
        ilONoSpots = Val(slTotalNoPerWk)
        If InStr(slTotalRate, ".") > 0 Then
            llOGross = gStrDecToLong(slTotalRate, 2)
        End If
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mOpenExportCntrFile             *
'*                                                     *
'*             Created:5/18/93       By:D. LeVine      *
'*            Modified:              By:D. Smith       *
'*                                                     *
'*            Comments:Open export file                *
'*                                                     *
'*******************************************************
Function mOpenExportCntrFile() As Integer
    Dim slFYear As String
    Dim slFMonth As String
    Dim slFDay As String
    'Dim slLetter As String
    Dim ilRet As Integer
    Dim slFileName As String
    Dim slToFile As String
    Dim slDateTime As String
    Dim ilFound As Integer
    Dim ilLoop As Integer
    Dim slExt As String

    ilFound = False
    'For ilLoop = 1 To UBound(tgSSMnf) - 1 Step 1
    For ilLoop = LBound(tgSSMnf) To UBound(tgSSMnf) - 1 Step 1
        If (Trim$(tgSSMnf(ilLoop).sUnitType) = "E") Or (Trim$(tgSSMnf(ilLoop).sUnitType) = "F") Then
            ilFound = True
            Exit For
        End If
    Next ilLoop

    If (Not ilFound) Or (rbcType(INVGEN_Aff).Value) Then
        smExportCntrName = ""
        mOpenExportCntrFile = True
        Exit Function
    End If

    'slExt = ".I" & Trim$(tgSpf.sInvExportId)
    '
    'gObtainYearMonthDayStr smStartStd, True, slFYear, slFMonth, slFDay
    'slFileName = right$(slFYear, 2) & slFMonth & slFDay
    'If rbcType(INVGEN_Preliminary).Value Then
    '    slFileName = "P" & slFileName
    'ElseIf rbcType(INVGEN_Reprint).Value Then
    '    slFileName = "R" & slFileName
    'Else
    '    slFileName = "F" & slFileName
    'End If
    '
    'File name is MMMYYInW.XX
    '     where MMM is month name
    '           YY is year
    '           Inv is Inv
    '           W is week number or v if month
    '           XX Client ID
    '
    slExt = "." & Trim$(tgSpf.sInvExportId)
    gObtainYearMonthDayStr smEndStd, True, slFYear, slFMonth, slFDay
    slFileName = Left$(gMonthName(smEndStd), 3) & right$(slFYear, 2) & "Inv"
    ilRet = 0
    'On Error GoTo mOpenExportCntrFileErr:
    slToFile = slFileName & slExt
    'slDateTime = FileDateTime(sgExportPath & slToFile)
    ilRet = gFileExist(sgExportPath & slToFile)
    If ilRet = 0 Then
        Kill sgExportPath & slToFile
    End If
    On Error GoTo 0
    slToFile = sgExportPath & slFileName & slExt 'slToFile
    ilRet = 0
    'On Error GoTo mOpenExportCntrFileErr:
    'hmExport = FreeFile
    'Open slToFile For Output As hmExport
    ilRet = gFileOpen(slToFile, "Output", hmExport)
    If ilRet <> 0 Then
        Screen.MousePointer = vbDefault
        gSetMousePointer grdAirTime, grdRevenue, vbDefault
        MsgBox "Open " & slToFile & ", Error #" & str$(ilRet), vbOKOnly + vbCritical + vbApplicationModal, "Open Error"
        mOpenExportCntrFile = False
        Exit Function
    End If
    On Error GoTo 0
    Print #hmExport, ""
    If rbcType(INVGEN_Preliminary).Value Then
        Print #hmExport, "Preliminary Invoicing on "; Format$(Now, "m/d/yy") & " at " & Format$(Now, "h:mm:ssAM/PM")
    ElseIf rbcType(INVGEN_Reprint).Value Then
        Print #hmExport, "Reprint Invoicing on "; Format$(Now, "m/d/yy") & " at " & Format$(Now, "h:mm:ssAM/PM")
    ElseIf rbcType(INVGEN_Archive).Value Then            '11-15-16 archive message
        Print #hmExport, "Archive Invoicing on "; Format$(Now, "m/d/yy") & " at " & Format$(Now, "h:mm:ssAM/PM")
    Else
        Print #hmExport, "Final Invoicing for "; Format$(Now, "m/d/yy") & " at " & Format$(Now, "h:mm:ssAM/PM")
    End If
    smExportCntrName = slToFile
    mOpenExportCntrFile = True
    Exit Function
'mOpenExportCntrFileErr:
'    ilRet = Err.Number
'    Resume Next

End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mOpenMsgFile                    *
'*                                                     *
'*             Created:5/18/93       By:D. LeVine      *
'*            Modified:              By:D. Smith       *
'*                                                     *
'*            Comments:Open error message file         *
'*                                                     *
'*******************************************************
Function mOpenMsgFile(slMsgFile As String) As Integer
    Dim slToFile As String
    Dim slDateTime As String
    Dim ilRet As Integer
    Dim ilERet As Integer

    ilRet = 0
    'On Error GoTo mOpenMsgFileErr:
    'slToFile = sgExportPath & "InvError.Txt"
    'slToFile = "c:\csi\" & "InvError.Txt"       '3-15-02 avoid conflict with multiple users running reprints
    slToFile = sgDBPath & "Messages\" & "InvError" & CStr(tgUrf(0).iCode) & ".Txt"
    'slDateTime = FileDateTime(slToFile)
    ilRet = gFileExist(slToFile)
    If ilRet = 0 Then
        Kill slToFile
        On Error GoTo 0
        ilRet = 0
        'On Error GoTo mOpenMsgFileErr:
        'hmMsg = FreeFile
        'Open slToFile For Output As hmMsg
        ilRet = gFileOpen(slToFile, "Output", hmMsg)
        ilERet = ilRet
        If ilRet <> 0 Then
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            MsgBox "Open " & slToFile & " error " & str$(ilERet), vbOKOnly + vbCritical + vbApplicationModal, "Open Error"
            mOpenMsgFile = False
            Exit Function
        End If
    Else
        On Error GoTo 0
        ilRet = 0
        'On Error GoTo mOpenMsgFileErr:
        'hmMsg = FreeFile
        'Open slToFile For Output As hmMsg
        ilRet = gFileOpen(slToFile, "Output", hmMsg)
        ilERet = ilRet
        If ilRet <> 0 Then
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            MsgBox "Open " & slToFile & " error " & str$(ilERet), vbOKOnly + vbCritical + vbApplicationModal, "Open Error"
            mOpenMsgFile = False
            Exit Function
        End If
    End If
    On Error GoTo 0
    Print #hmMsg, ""
    slMsgFile = slToFile
    mOpenMsgFile = True
    Exit Function
'mOpenMsgFileErr:
'    ilERet = ilRet
'    ilRet = 1
'    Resume Next
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mProcFlight                     *
'*                                                     *
'*             Created:8/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Read a record                  *
'*                                                     *
'*******************************************************
Private Sub mProcFlight(ilCff As Integer, slSFlightDate As String, slEFlightDate As String, ilPass As Integer, slPctTrade As String, slEDIRate As String, slTotalNoPerWk As String, ilEDINoOrderedSpots As Integer, slTotalRate As String, slEDITotalRate As String, slTotalVirtVehRate As String)
'
'   Where
'       ilCff(I)- Flight record index
'       slSFlightDate(I)- Flight Start date
'       slEFlightDate(I)- Flight End Date
'       slTotalNoPerWk(O)- Running Total number of spots per week (acroos all flights)
'       ilEDINoOrderedSpots(O)-
'       slTotalRate(I/O)- Ordered Total $'s
'       slEDITotalRate(I/O) - EDI Ordered Total $'s
'       slTotalVirtVehRate(O)-
'

    Dim llDate As Long
    Dim slDays As String
    Dim slEDIDays As String
    Dim ilDay As Integer
    Dim ilWkStart As Integer
    Dim ilLoop As Integer
    Dim ilUpper As Integer
    Dim llSDate As Long
    Dim slDDays As String
    Dim ilMkt As Integer
    
    'Get flight rate
    slEDIRate = "0"
    Select Case tgCffInv(ilCff).CffRec.sPriceType
        Case "T"    'True
            'gPDNToStr tgCffInv(ilCff).CffRec.sActPrice, 2, smCffPrice
            smCffPrice = gLongToStrDec(tgCffInv(ilCff).CffRec.lActPrice, 2)
            'gPDNToStr tgCffInv(ilCff).CffRec.sActPrice, 0, slEDIRate
            slEDIRate = gLongToStrDec(tgCffInv(ilCff).CffRec.lActPrice, 0)
            If (ilPass = 1) And (Val(slPctTrade) <> 0) Then
                smCffPrice = gDivStr(gMulStr(RTrim$(smCffPrice), gSubStr("100", slPctTrade)), "100")
                slEDIRate = gDivStr(gMulStr(slEDIRate, gSubStr("100", slPctTrade)), "100")
            ElseIf (ilPass = 2) And (Val(slPctTrade) <> 100) Then
                'smCffPrice = gDivStr(gMulStr(smCffPrice, slPctTrade), "100")
                smCffPrice = gSubStr(RTrim$(smCffPrice), gDivStr(gMulStr(RTrim$(smCffPrice), gSubStr("100", slPctTrade)), "100"))
                'slEDIRate = gDivStr(gMulStr(slEDIRate, slPctTrade), "100")
                slEDIRate = gSubStr(slEDIRate, gDivStr(gMulStr(slEDIRate, gSubStr("100", slPctTrade)), "100"))
            End If
        Case "N"    'No Charge
            smCffPrice = "N/C"
        Case "M"    'MG Line
            smCffPrice = "MG"
        Case "B"    'Bonus
            smCffPrice = "Bonus"
        Case "S"    'Spinoff
            smCffPrice = "Spinoff"
        Case "P"    'Package
            'gPDNToStr tgCffInv(ilCff).CffRec.sActPrice, 2, smCffPrice
            smCffPrice = gLongToStrDec(tgCffInv(ilCff).CffRec.lActPrice, 2)
            If (ilPass = 1) And (Val(slPctTrade) <> 0) Then
                smCffPrice = gDivStr(gMulStr(RTrim$(smCffPrice), gSubStr("100", slPctTrade)), "100")
            ElseIf (ilPass = 2) And (Val(slPctTrade) <> 100) Then
                'smCffPrice = gDivStr(gMulStr(smCffPrice, slPctTrade), "100")
                smCffPrice = gSubStr(RTrim$(smCffPrice), gDivStr(gMulStr(RTrim$(smCffPrice), gSubStr("100", slPctTrade)), "100"))
            End If
        Case "R"    'Recapturable
            smCffPrice = "Recapturable"
        Case "A"    'ADU
            smCffPrice = "ADU"
    End Select
    'Removed by hidden line- code is OK 1/31/01
    'Removed here and around each place tgMktTotal is incremented below
    'If tmClf.sType = "A" Then
    '    mMktByHidden slSFlightDate, slEFlightDate, ilPass, slPctTrade
    'Else    'Virtual and eaual
        ilMkt = -1
        For ilLoop = 0 To UBound(tgMktTotal) - 1 Step 1
            If tgMktTotal(ilLoop).iMnfVehGp3Mkt = imMnfVehGp3Mkt Then
                ilMkt = ilLoop
                Exit For
            End If
        Next ilLoop
        If ilMkt = -1 Then
            ilMkt = UBound(tgMktTotal)
            tgMktTotal(ilMkt).iMnfVehGp3Mkt = imMnfVehGp3Mkt
            tgMktTotal(ilMkt).lONoSpots = 0
            tgMktTotal(ilMkt).sOMktTotalGross = ".00"
            tgMktTotal(ilMkt).lANoSpots = 0
            tgMktTotal(ilMkt).sAMktTotalGross = ".00"
            ReDim Preserve tgMktTotal(0 To UBound(tgMktTotal) + 1) As MKTTOTAL
        End If
    'End If
    tmIvr.iWkNo = 0
    'If (tgCffInv(ilCff).CffRec.iSpotsWk > 0) Or (tgCffInv(ilCff).CffRec.iXSpotsWk > 0) Then   'Weekly
    If (tgCffInv(ilCff).CffRec.sDyWk <> "D") Then    'Weekly
        slDays = gDayNames(tgCffInv(ilCff).CffRec.iDay(), tgCffInv(ilCff).CffRec.sXDay(), 2, slEDIDays)
        slEDIDays = mConvertEDIDays(slEDIDays)
        If tmChf.sBillCycle = "C" Then
            llDate = gDateValue(slSFlightDate)
            Do While llDate <= gDateValue(slEFlightDate)
                If llDate < lmStartCal Then
                    If llDate + 6 >= lmStartCal Then
                        'If (tgSpf.sInvAirOrder <> "2") Or (StrComp(Trim(smCffPrice), "Bonus", 1) <> 0) Then
                        If (tgSpf.sBLaserForm <> "2") Or (StrComp(Trim$(smCffPrice), "Bonus", 1) <> 0) Then
                            slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk)))
                            ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iXSpotsWk
                            'If tmClf.sType <> "A" Then
                                tgMktTotal(ilMkt).lONoSpots = tgMktTotal(ilMkt).lONoSpots + tgCffInv(ilCff).CffRec.iXSpotsWk
                            'End If
                        End If
                        If InStr(RTrim$(smCffPrice), ".") > 0 Then
                            If tmClf.sType <> "E" Then
                                slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))))
                                slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))))
                                slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))))
                                'If tmClf.sType <> "A" Then
                                    tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))))
                                'End If
                            Else
                                slTotalRate = gAddStr(slTotalRate, RTrim$(smCffPrice))
                                slEDITotalRate = gAddStr(slEDITotalRate, RTrim$(smCffPrice))
                                slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, RTrim$(smCffPrice))
                                'If tmClf.sType <> "A" Then
                                    tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, RTrim$(smCffPrice))
                                'End If
                            End If
                        End If
                        ilUpper = UBound(tmWkDef)
                        tmWkDef(ilUpper).sDays = slDays
                        tmWkDef(ilUpper).sNoSpots = Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))
                        tmWkDef(ilUpper).sWkPrice = RTrim$(smCffPrice)
                        tmWkDef(UBound(tmWkDef)).lWkSDate = llDate
                        For ilDay = 0 To 6 Step 1
                            If tgCffInv(ilCff).CffRec.sXDay(ilDay) = "Y" Then
                                tmWkDef(ilUpper).lWkSDate = llDate + ilDay
                                Exit For
                            End If
                        Next ilDay
                        tmWkDef(ilUpper).lWkEDate = llDate + 6
                        tmWkDef(ilUpper).iWkShown = False
                        tmWkDef(ilUpper).sEDIDays = slEDIDays
                        tmWkDef(ilUpper).sEDIRate = slEDIRate
                        tmWkDef(ilUpper).iGameNo = tgCffInv(ilCff).iGameNo
                        ReDim Preserve tmWkDef(ilUpper + 1) As WKDEF
                    End If
                ElseIf (llDate <= lmEndCal) Then
                    'If (tgSpf.sInvAirOrder <> "2") Or (StrComp(Trim(smCffPrice), "Bonus", 1) <> 0) Then
                    If (tgSpf.sBLaserForm <> "2") Or (StrComp(Trim$(smCffPrice), "Bonus", 1) <> 0) Then
                        slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk)))
                        ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iSpotsWk
                        'If tmClf.sType <> "A" Then
                            tgMktTotal(ilMkt).lONoSpots = tgMktTotal(ilMkt).lONoSpots + tgCffInv(ilCff).CffRec.iSpotsWk
                        'End If
                    End If
                    If InStr(RTrim$(smCffPrice), ".") > 0 Then
                        If tmClf.sType <> "E" Then
                            slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                            slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                            slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                            'If tmClf.sType <> "A" Then
                                tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                            'End If
                        Else
                            slTotalRate = gAddStr(slTotalRate, RTrim$(smCffPrice))
                            slEDITotalRate = gAddStr(slEDITotalRate, RTrim$(smCffPrice))
                            slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, RTrim$(smCffPrice))
                            'If tmClf.sType <> "A" Then
                                tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, RTrim$(smCffPrice))
                            'End If
                        End If
                    End If
                    ilUpper = UBound(tmWkDef)
                    tmWkDef(ilUpper).sDays = slDays
                    tmWkDef(ilUpper).sNoSpots = Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))
                    tmWkDef(ilUpper).sWkPrice = RTrim$(smCffPrice)
                    tmWkDef(ilUpper).lWkSDate = llDate
                    tmWkDef(ilUpper).lWkEDate = llDate + 6
                    tmWkDef(ilUpper).iWkShown = False
                    tmWkDef(ilUpper).sEDIDays = slEDIDays
                    tmWkDef(ilUpper).sEDIRate = slEDIRate
                    tmWkDef(ilUpper).iGameNo = tgCffInv(ilCff).iGameNo
                    ReDim Preserve tmWkDef(ilUpper + 1) As WKDEF
                Else
                    Exit Do
                End If
                llDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
            Loop
        ElseIf tmChf.sBillCycle = "W" Then
            llDate = gDateValue(slSFlightDate)
            Do While llDate <= gDateValue(slEFlightDate)
                If llDate < lmStartWk Then
                    If llDate + 6 >= lmStartWk Then
                        'If (tgSpf.sInvAirOrder <> "2") Or (StrComp(Trim(smCffPrice), "Bonus", 1) <> 0) Then
                        If (tgSpf.sBLaserForm <> "2") Or (StrComp(Trim$(smCffPrice), "Bonus", 1) <> 0) Then
                            slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk)))
                            ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iXSpotsWk
                            'If tmClf.sType <> "A" Then
                                tgMktTotal(ilMkt).lONoSpots = tgMktTotal(ilMkt).lONoSpots + tgCffInv(ilCff).CffRec.iXSpotsWk
                            'End If
                        End If
                        If InStr(RTrim$(smCffPrice), ".") > 0 Then
                            If tmClf.sType <> "E" Then
                                slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))))
                                slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))))
                                slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))))
                                'If tmClf.sType <> "A" Then
                                    tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))))
                                'End If
                            Else
                                slTotalRate = gAddStr(slTotalRate, RTrim$(smCffPrice))
                                slEDITotalRate = gAddStr(slEDITotalRate, RTrim$(smCffPrice))
                                slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, RTrim$(smCffPrice))
                                'If tmClf.sType <> "A" Then
                                    tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, RTrim$(smCffPrice))
                                'End If
                            End If
                        End If
                        ilUpper = UBound(tmWkDef)
                        tmWkDef(ilUpper).sDays = slDays
                        tmWkDef(ilUpper).sNoSpots = Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))
                        tmWkDef(ilUpper).sWkPrice = RTrim$(smCffPrice)
                        tmWkDef(UBound(tmWkDef)).lWkSDate = llDate
                        For ilDay = 0 To 6 Step 1
                            If tgCffInv(ilCff).CffRec.sXDay(ilDay) = "Y" Then
                                tmWkDef(ilUpper).lWkSDate = llDate + ilDay
                                Exit For
                            End If
                        Next ilDay
                        tmWkDef(ilUpper).lWkEDate = llDate + 6
                        tmWkDef(ilUpper).iWkShown = False
                        tmWkDef(ilUpper).sEDIDays = slEDIDays
                        tmWkDef(ilUpper).sEDIRate = slEDIRate
                        tmWkDef(ilUpper).iGameNo = tgCffInv(ilCff).iGameNo
                        ReDim Preserve tmWkDef(ilUpper + 1) As WKDEF
                    End If
                ElseIf (llDate <= lmEndWk) Then
                    'If (tgSpf.sInvAirOrder <> "2") Or (StrComp(Trim(smCffPrice), "Bonus", 1) <> 0) Then
                    If (tgSpf.sBLaserForm <> "2") Or (StrComp(Trim$(smCffPrice), "Bonus", 1) <> 0) Then
                        slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk)))
                        ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iSpotsWk
                        'If tmClf.sType <> "A" Then
                            tgMktTotal(ilMkt).lONoSpots = tgMktTotal(ilMkt).lONoSpots + tgCffInv(ilCff).CffRec.iSpotsWk
                        'End If
                    End If
                    If InStr(RTrim$(smCffPrice), ".") > 0 Then
                        If tmClf.sType <> "E" Then
                            slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                            slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                            slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                            'If tmClf.sType <> "A" Then
                                tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                            'End If
                        Else
                            slTotalRate = gAddStr(slTotalRate, RTrim$(smCffPrice))
                            slEDITotalRate = gAddStr(slEDITotalRate, RTrim$(smCffPrice))
                            slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, RTrim$(smCffPrice))
                            'If tmClf.sType <> "A" Then
                                tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, RTrim$(smCffPrice))
                            'End If
                        End If
                    End If
                    ilUpper = UBound(tmWkDef)
                    tmWkDef(ilUpper).sDays = slDays
                    tmWkDef(ilUpper).sNoSpots = Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))
                    tmWkDef(ilUpper).sWkPrice = RTrim$(smCffPrice)
                    tmWkDef(ilUpper).lWkSDate = llDate
                    tmWkDef(ilUpper).lWkEDate = llDate + 6
                    tmWkDef(ilUpper).iWkShown = False
                    tmWkDef(ilUpper).sEDIDays = slEDIDays
                    tmWkDef(ilUpper).sEDIRate = slEDIRate
                    tmWkDef(ilUpper).iGameNo = tgCffInv(ilCff).iGameNo
                    ReDim Preserve tmWkDef(ilUpper + 1) As WKDEF
                Else
                    Exit Do
                End If
                llDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
            Loop
        Else
            llDate = gDateValue(slSFlightDate)
            Do While llDate <= gDateValue(slEFlightDate)
                If (llDate >= lmStartStd) And (llDate <= lmEndStd) Then
                    'If (tgSpf.sInvAirOrder <> "2") Or (StrComp(Trim(smCffPrice), "Bonus", 1) <> 0) Then
                    If (tgSpf.sBLaserForm <> "2") Or (StrComp(Trim$(smCffPrice), "Bonus", 1) <> 0) Then
                        slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk)))
                        ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iSpotsWk
                        'If tmClf.sType <> "A" Then
                            tgMktTotal(ilMkt).lONoSpots = tgMktTotal(ilMkt).lONoSpots + tgCffInv(ilCff).CffRec.iSpotsWk
                        'End If
                    End If
                    If InStr(RTrim$(smCffPrice), ".") > 0 Then
                        If tmClf.sType <> "E" Then
                            slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                            slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                            slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                            'If tmClf.sType <> "A" Then
                                tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                            'End If
                        Else
                            slTotalRate = gAddStr(slTotalRate, RTrim$(smCffPrice))
                            slEDITotalRate = gAddStr(slEDITotalRate, RTrim$(smCffPrice))
                            slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, RTrim$(smCffPrice))
                            'If tmClf.sType <> "A" Then
                                tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, RTrim$(smCffPrice))
                            'End If
                        End If
                    End If
                    ilUpper = UBound(tmWkDef)
                    tmWkDef(ilUpper).sDays = slDays
                    tmWkDef(ilUpper).sNoSpots = Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))
                    tmWkDef(ilUpper).sWkPrice = RTrim$(smCffPrice)
                    tmWkDef(ilUpper).lWkSDate = llDate
                    If gDateValue(slEFlightDate) < llDate + 6 Then
                        tmWkDef(ilUpper).lWkEDate = gDateValue(slEFlightDate)
                    Else
                        tmWkDef(ilUpper).lWkEDate = llDate + 6
                    End If
                    tmWkDef(ilUpper).iWkShown = False
                    tmWkDef(ilUpper).sEDIDays = slEDIDays
                    tmWkDef(ilUpper).sEDIRate = slEDIRate
                    tmWkDef(ilUpper).iGameNo = tgCffInv(ilCff).iGameNo
                    ReDim Preserve tmWkDef(ilUpper + 1) As WKDEF
                End If
                If llDate > lmEndStd Then
                    Exit Do
                End If
                llDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
            Loop
        End If
    Else    'Daily
        ilWkStart = False
        slDays = ""
        For ilDay = LBound(tgCffInv(ilCff).CffRec.sXDay) To UBound(tgCffInv(ilCff).CffRec.sXDay) Step 1
            tgCffInv(ilCff).CffRec.sXDay(ilDay) = "0"
        Next ilDay
        slDDays = gDayNames(tgCffInv(ilCff).CffRec.iDay(), tgCffInv(ilCff).CffRec.sXDay(), 2, slEDIDays)
        slEDIDays = mConvertEDIDays(slEDIDays)
        If tmChf.sBillCycle = "C" Then
            If gDateValue(slSFlightDate) >= lmStartCal Then
                llSDate = gDateValue(slSFlightDate)
            Else
                llSDate = lmStartCal
            End If
            For llDate = llSDate To gDateValue(slEFlightDate) Step 1
                If (llDate >= lmStartCal) And (llDate <= lmEndCal) Then
                    ilDay = gWeekDayLong(llDate)
                    'If (tgSpf.sInvAirOrder <> "2") Or (StrComp(Trim(smCffPrice), "Bonus", 1) <> 0) Then
                    If (tgSpf.sBLaserForm <> "2") Or (StrComp(Trim$(smCffPrice), "Bonus", 1) <> 0) Then
                        slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                        ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iDay(ilDay)
                        'If tmClf.sType <> "A" Then
                            tgMktTotal(ilMkt).lONoSpots = tgMktTotal(ilMkt).lONoSpots + tgCffInv(ilCff).CffRec.iDay(ilDay)
                        'End If
                    End If
                    If InStr(RTrim$(smCffPrice), ".") > 0 Then
                        If tmClf.sType <> "E" Then
                            slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                            slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                            slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                            'If tmClf.sType <> "A" Then
                                tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                            'End If
                        Else
                            If Not ilWkStart Then
                                slTotalRate = gAddStr(slTotalRate, RTrim$(smCffPrice))
                                slEDITotalRate = gAddStr(slEDITotalRate, RTrim$(smCffPrice))
                                slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, RTrim$(smCffPrice))
                                'If tmClf.sType <> "A" Then
                                    tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, RTrim$(smCffPrice))
                                'End If
                            Else
                                If (ilDay <= gWeekDayLong(tmWkDef(ilUpper).lWkSDate)) Or (llDate > tmWkDef(ilUpper).lWkSDate + 6) Then
                                    slTotalRate = gAddStr(slTotalRate, RTrim$(smCffPrice))
                                    slEDITotalRate = gAddStr(slEDITotalRate, RTrim$(smCffPrice))
                                    slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, RTrim$(smCffPrice))
                                    'If tmClf.sType <> "A" Then
                                        tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, RTrim$(smCffPrice))
                                    'End If
                                End If
                            End If
                        End If
                    End If
                    If Not ilWkStart Then
                        ilWkStart = True
                        slDays = ""
                        For ilLoop = 0 To ilDay - 1 Step 1
                            slDays = slDays & "0 "
                        Next ilLoop
                        ilUpper = UBound(tmWkDef)
                        tmWkDef(ilUpper).sDays = slDays
                        tmWkDef(ilUpper).sDays = Trim$(tmWkDef(ilUpper).sDays) & str$(tgCffInv(ilCff).CffRec.iDay(ilDay))
                        'Show day names intaed of day counts
                        tmWkDef(ilUpper).sDays = slDDays
                        tmWkDef(ilUpper).sNoSpots = gAddStr(Trim$(tmWkDef(ilUpper).sNoSpots), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                        tmWkDef(ilUpper).sWkPrice = RTrim$(smCffPrice)
                        tmWkDef(ilUpper).lWkSDate = llDate
                        tmWkDef(ilUpper).lWkEDate = llDate
                        tmWkDef(ilUpper).iWkShown = False
                        tmWkDef(ilUpper).sEDIDays = slEDIDays   '""
                        tmWkDef(ilUpper).sEDIRate = slEDIRate
                        tmWkDef(ilUpper).iGameNo = tgCffInv(ilCff).iGameNo
                        ReDim Preserve tmWkDef(ilUpper + 1) As WKDEF
                    Else
                        If (ilDay <= gWeekDayLong(tmWkDef(ilUpper).lWkSDate)) Or (llDate > tmWkDef(ilUpper).lWkSDate + 6) Or (tmWkDef(ilUpper).iGameNo <> tgCffInv(ilCff).iGameNo) Then
                            slDays = ""
                            For ilLoop = 0 To ilDay - 1 Step 1
                                slDays = slDays & "0 "
                            Next ilLoop
                            ilWkStart = True
                            ilUpper = UBound(tmWkDef)
                            tmWkDef(ilUpper).sDays = slDays
                            tmWkDef(ilUpper).sDays = Trim$(tmWkDef(ilUpper).sDays) & str$(tgCffInv(ilCff).CffRec.iDay(ilDay))
                            'Show day names intaed of day counts
                            tmWkDef(ilUpper).sDays = slDDays
                            tmWkDef(ilUpper).sNoSpots = gAddStr(Trim$(tmWkDef(ilUpper).sNoSpots), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                            tmWkDef(ilUpper).sWkPrice = RTrim$(smCffPrice)
                            tmWkDef(ilUpper).lWkSDate = llDate
                            tmWkDef(ilUpper).lWkEDate = llDate
                            tmWkDef(ilUpper).iWkShown = False
                            tmWkDef(ilUpper).sEDIDays = slEDIDays   '""
                            tmWkDef(ilUpper).sEDIRate = slEDIRate
                            tmWkDef(ilUpper).iGameNo = tgCffInv(ilCff).iGameNo
                            ReDim Preserve tmWkDef(ilUpper + 1) As WKDEF
                        Else
                            tmWkDef(ilUpper).sDays = Trim$(tmWkDef(ilUpper).sDays) & str$(tgCffInv(ilCff).CffRec.iDay(ilDay))
                            'Show day names intaed of day counts
                            tmWkDef(ilUpper).sDays = slDDays
                            tmWkDef(ilUpper).sNoSpots = gAddStr(Trim$(tmWkDef(ilUpper).sNoSpots), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                            tmWkDef(ilUpper).lWkEDate = llDate
                        End If
                    End If
                End If
                If llDate >= lmEndCal Then
                    Exit For
                End If
            Next llDate
        ElseIf tmChf.sBillCycle = "W" Then
            If gDateValue(slSFlightDate) >= lmStartWk Then
                llSDate = gDateValue(slSFlightDate)
            Else
                llSDate = lmStartWk
            End If
            For llDate = llSDate To gDateValue(slEFlightDate) Step 1
                If (llDate >= lmStartWk) And (llDate <= lmEndWk) Then
                    ilDay = gWeekDayLong(llDate)
                    'If (tgSpf.sInvAirOrder <> "2") Or (StrComp(Trim(smCffPrice), "Bonus", 1) <> 0) Then
                    If (tgSpf.sBLaserForm <> "2") Or (StrComp(Trim$(smCffPrice), "Bonus", 1) <> 0) Then
                        slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                        ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iDay(ilDay)
                        'If tmClf.sType <> "A" Then
                            tgMktTotal(ilMkt).lONoSpots = tgMktTotal(ilMkt).lONoSpots + tgCffInv(ilCff).CffRec.iDay(ilDay)
                        'End If
                    End If
                    If InStr(RTrim$(smCffPrice), ".") > 0 Then
                        If tmClf.sType <> "E" Then
                            slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                            slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                            slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                            'If tmClf.sType <> "A" Then
                                tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                            'End If
                        Else
                            If Not ilWkStart Then
                                slTotalRate = gAddStr(slTotalRate, RTrim$(smCffPrice))
                                slEDITotalRate = gAddStr(slEDITotalRate, RTrim$(smCffPrice))
                                slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, RTrim$(smCffPrice))
                                'If tmClf.sType <> "A" Then
                                    tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, RTrim$(smCffPrice))
                                'End If
                            Else
                                If (ilDay <= gWeekDayLong(tmWkDef(ilUpper).lWkSDate)) Or (llDate > tmWkDef(ilUpper).lWkSDate + 6) Then
                                    slTotalRate = gAddStr(slTotalRate, RTrim$(smCffPrice))
                                    slEDITotalRate = gAddStr(slEDITotalRate, RTrim$(smCffPrice))
                                    slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, RTrim$(smCffPrice))
                                    'If tmClf.sType <> "A" Then
                                        tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, RTrim$(smCffPrice))
                                    'End If
                                End If
                            End If
                        End If
                    End If
                    If Not ilWkStart Then
                        ilWkStart = True
                        slDays = ""
                        For ilLoop = 0 To ilDay - 1 Step 1
                            slDays = slDays & "0 "
                        Next ilLoop
                        ilUpper = UBound(tmWkDef)
                        tmWkDef(ilUpper).sDays = slDays
                        tmWkDef(ilUpper).sDays = Trim$(tmWkDef(ilUpper).sDays) & str$(tgCffInv(ilCff).CffRec.iDay(ilDay))
                        'Show day names intaed of day counts
                        tmWkDef(ilUpper).sDays = slDDays
                        tmWkDef(ilUpper).sNoSpots = gAddStr(Trim$(tmWkDef(ilUpper).sNoSpots), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                        tmWkDef(ilUpper).sWkPrice = RTrim$(smCffPrice)
                        tmWkDef(ilUpper).lWkSDate = llDate
                        tmWkDef(ilUpper).lWkEDate = llDate
                        tmWkDef(ilUpper).iWkShown = False
                        tmWkDef(ilUpper).sEDIDays = slEDIDays   '""
                        tmWkDef(ilUpper).sEDIRate = slEDIRate
                        tmWkDef(ilUpper).iGameNo = tgCffInv(ilCff).iGameNo
                        ReDim Preserve tmWkDef(ilUpper + 1) As WKDEF
                    Else
                        If (ilDay <= gWeekDayLong(tmWkDef(ilUpper).lWkSDate)) Or (llDate > tmWkDef(ilUpper).lWkSDate + 6) Or (tmWkDef(ilUpper).iGameNo <> tgCffInv(ilCff).iGameNo) Then
                            slDays = ""
                            For ilLoop = 0 To ilDay - 1 Step 1
                                slDays = slDays & "0 "
                            Next ilLoop
                            ilWkStart = True
                            ilUpper = UBound(tmWkDef)
                            tmWkDef(ilUpper).sDays = slDays
                            tmWkDef(ilUpper).sDays = Trim$(tmWkDef(ilUpper).sDays) & str$(tgCffInv(ilCff).CffRec.iDay(ilDay))
                            'Show day names intaed of day counts
                            tmWkDef(ilUpper).sDays = slDDays
                            tmWkDef(ilUpper).sNoSpots = gAddStr(Trim$(tmWkDef(ilUpper).sNoSpots), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                            tmWkDef(ilUpper).sWkPrice = RTrim$(smCffPrice)
                            tmWkDef(ilUpper).lWkSDate = llDate
                            tmWkDef(ilUpper).lWkEDate = llDate
                            tmWkDef(ilUpper).iWkShown = False
                            tmWkDef(ilUpper).sEDIDays = slEDIDays   '""
                            tmWkDef(ilUpper).sEDIRate = slEDIRate
                            tmWkDef(ilUpper).iGameNo = tgCffInv(ilCff).iGameNo
                            ReDim Preserve tmWkDef(ilUpper + 1) As WKDEF
                        Else
                            tmWkDef(ilUpper).sDays = Trim$(tmWkDef(ilUpper).sDays) & str$(tgCffInv(ilCff).CffRec.iDay(ilDay))
                            'Show day names intaed of day counts
                            tmWkDef(ilUpper).sDays = slDDays
                            tmWkDef(ilUpper).sNoSpots = gAddStr(Trim$(tmWkDef(ilUpper).sNoSpots), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                            tmWkDef(ilUpper).lWkEDate = llDate
                        End If
                    End If
                End If
                If llDate >= lmEndWk Then
                    Exit For
                End If
            Next llDate
        Else
            If gDateValue(slSFlightDate) >= lmStartStd Then
                llSDate = gDateValue(slSFlightDate)
            Else
                llSDate = lmStartStd
            End If
            For llDate = llSDate To gDateValue(slEFlightDate) Step 1
                If (llDate >= lmStartStd) And (llDate <= lmEndStd) Then
                    ilDay = gWeekDayLong(llDate)
                    'If (tgSpf.sInvAirOrder <> "2") Or (StrComp(Trim(smCffPrice), "Bonus", 1) <> 0) Then
                    If (tgSpf.sBLaserForm <> "2") Or (StrComp(Trim$(smCffPrice), "Bonus", 1) <> 0) Then
                        slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                        ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iDay(ilDay)
                        'If tmClf.sType <> "A" Then
                            tgMktTotal(ilMkt).lONoSpots = tgMktTotal(ilMkt).lONoSpots + tgCffInv(ilCff).CffRec.iDay(ilDay)
                        'End If
                    End If
                    If InStr(RTrim$(smCffPrice), ".") > 0 Then
                        If tmClf.sType <> "E" Then
                            slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                            slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                            slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                            'If tmClf.sType <> "A" Then
                                tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, gMulStr(RTrim$(smCffPrice), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                            'End If
                        Else
                            If Not ilWkStart Then
                                slTotalRate = gAddStr(slTotalRate, RTrim$(smCffPrice))
                                slEDITotalRate = gAddStr(slEDITotalRate, RTrim$(smCffPrice))
                                slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, RTrim$(smCffPrice))
                                'If tmClf.sType <> "A" Then
                                    tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, RTrim$(smCffPrice))
                                'End If
                            Else
                                If (ilDay <= gWeekDayLong(tmWkDef(ilUpper).lWkSDate)) Or (llDate > tmWkDef(ilUpper).lWkSDate + 6) Then
                                    slTotalRate = gAddStr(slTotalRate, RTrim$(smCffPrice))
                                    slEDITotalRate = gAddStr(slEDITotalRate, RTrim$(smCffPrice))
                                    slTotalVirtVehRate = gAddStr(slTotalVirtVehRate, RTrim$(smCffPrice))
                                    'If tmClf.sType <> "A" Then
                                        tgMktTotal(ilMkt).sOMktTotalGross = gAddStr(tgMktTotal(ilMkt).sOMktTotalGross, RTrim$(smCffPrice))
                                    'End If
                                End If
                            End If
                        End If
                    End If
                    If Not ilWkStart Then
                        ilWkStart = True
                        slDays = ""
                        For ilLoop = 0 To ilDay - 1 Step 1
                            slDays = slDays & "0 "
                        Next ilLoop
                        ilUpper = UBound(tmWkDef)
                        tmWkDef(ilUpper).sDays = slDays
                        tmWkDef(ilUpper).sDays = Trim$(tmWkDef(ilUpper).sDays) & str$(tgCffInv(ilCff).CffRec.iDay(ilDay))
                        'Show day names intaed of day counts
                        tmWkDef(ilUpper).sDays = slDDays
                        tmWkDef(ilUpper).sNoSpots = gAddStr(Trim$(tmWkDef(ilUpper).sNoSpots), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                        tmWkDef(ilUpper).sWkPrice = RTrim$(smCffPrice)
                        tmWkDef(ilUpper).lWkSDate = llDate
                        tmWkDef(ilUpper).lWkEDate = llDate
                        tmWkDef(ilUpper).iWkShown = False
                        tmWkDef(ilUpper).sEDIDays = slEDIDays   '""
                        tmWkDef(ilUpper).sEDIRate = slEDIRate
                        tmWkDef(ilUpper).iGameNo = tgCffInv(ilCff).iGameNo
                        ReDim Preserve tmWkDef(ilUpper + 1) As WKDEF
                    Else
                        If (ilDay <= gWeekDayLong(tmWkDef(ilUpper).lWkSDate)) Or (llDate > tmWkDef(ilUpper).lWkSDate + 6) Or (tmWkDef(ilUpper).iGameNo <> tgCffInv(ilCff).iGameNo) Then
                            slDays = ""
                            For ilLoop = 0 To ilDay - 1 Step 1
                                slDays = slDays & "0 "
                            Next ilLoop
                            ilWkStart = True
                            ilUpper = UBound(tmWkDef)
                            tmWkDef(ilUpper).sDays = slDays
                            tmWkDef(ilUpper).sDays = Trim$(tmWkDef(ilUpper).sDays) & str$(tgCffInv(ilCff).CffRec.iDay(ilDay))
                            'Show day names intaed of day counts
                            tmWkDef(ilUpper).sDays = slDDays
                            tmWkDef(ilUpper).sNoSpots = gAddStr(Trim$(tmWkDef(ilUpper).sNoSpots), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                            tmWkDef(ilUpper).sWkPrice = RTrim$(smCffPrice)
                            tmWkDef(ilUpper).lWkSDate = llDate
                            tmWkDef(ilUpper).lWkEDate = llDate
                            tmWkDef(ilUpper).iWkShown = False
                            tmWkDef(ilUpper).sEDIDays = slEDIDays   '""
                            tmWkDef(ilUpper).sEDIRate = slEDIRate
                            tmWkDef(ilUpper).iGameNo = tgCffInv(ilCff).iGameNo
                            ReDim Preserve tmWkDef(ilUpper + 1) As WKDEF
                        Else
                            tmWkDef(ilUpper).sDays = Trim$(tmWkDef(ilUpper).sDays) & str$(tgCffInv(ilCff).CffRec.iDay(ilDay))
                            'Show day names intaed of day counts
                            tmWkDef(ilUpper).sDays = slDDays
                            tmWkDef(ilUpper).sNoSpots = gAddStr(Trim$(tmWkDef(ilUpper).sNoSpots), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                            tmWkDef(ilUpper).lWkEDate = llDate
                        End If
                    End If
                End If
                If llDate >= lmEndStd Then
                    Exit For
                End If
            Next llDate
        End If
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mRepInv_ProcFlight              *
'*                                                     *
'*             Created:8/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Get totals for specified dates *
'*                                                     *
'*******************************************************
Sub mRepInv_ProcFlight(ilCff As Integer, slSFlightDate As String, slEFlightDate As String, ilPass As Integer, slPctTrade As String, slRate As String, slTotalNoPerWk As String, slTotalRate As String)
'
'   Where
'       ilCff(I)- Flight record index
'       slSFlightDate(I)- Flight Start date
'       slEFlightDate(I)- Flight End Date
'       slTotalNoPerWk(O)- Running Total number of spots per week
'       slTotalRate(I/O)- Ordered Total $'s
'

    Dim llDate As Long
    Dim ilDay As Integer
    Dim llSDate As Long

    'Get flight rate
    Select Case tgCffInv(ilCff).CffRec.sPriceType
        Case "T"    'True
            slRate = gLongToStrDec(tgCffInv(ilCff).CffRec.lActPrice, 2)
            'Remove separate records for trade and cash
            'If (ilPass = 1) And (Val(slPctTrade) <> 0) Then
            '    slRate = gDivStr(gMulStr(RTrim$(slRate), gSubStr("100", slPctTrade)), "100")
            'ElseIf (ilPass = 2) And (Val(slPctTrade) <> 100) Then
            '    slRate = gSubStr(RTrim$(slRate), gDivStr(gMulStr(RTrim$(slRate), gSubStr("100", slPctTrade)), "100"))
            'End If
        Case "N"    'No Charge
            slRate = "N/C"
        Case "M"    'MG Line
            slRate = "MG"
        Case "B"    'Bonus
            slRate = "Bonus"
        Case "S"    'Spinoff
            slRate = "Spinoff"
        Case "P"    'Package
            slRate = gLongToStrDec(tgCffInv(ilCff).CffRec.lActPrice, 2)
            'Remove separate records for trade and cash
            'If (ilPass = 1) And (Val(slPctTrade) <> 0) Then
            '    slRate = gDivStr(gMulStr(RTrim$(slRate), gSubStr("100", slPctTrade)), "100")
            'ElseIf (ilPass = 2) And (Val(slPctTrade) <> 100) Then
            '    slRate = gSubStr(RTrim$(slRate), gDivStr(gMulStr(RTrim$(slRate), gSubStr("100", slPctTrade)), "100"))
            'End If
        Case "R"    'Recapturable
            slRate = "Recapturable"
        Case "A"    'ADU
            slRate = "ADU"
    End Select
    'Ignore rates for all type except True and Package
    If (tgCffInv(ilCff).CffRec.sPriceType <> "T") And (tgCffInv(ilCff).CffRec.sPriceType <> "P") Then
        slRate = "0.00"
    End If

    If (tgCffInv(ilCff).CffRec.sDyWk <> "D") Then    'Weekly
        If tgChfInv.sBillCycle = "C" Then
            llDate = gDateValue(slSFlightDate)
            Do While llDate <= gDateValue(slEFlightDate)
                If llDate < lmStartCal Then
                    If llDate + 6 >= lmStartCal Then
                        slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk)))
                        If InStr(RTrim$(slRate), ".") > 0 Then
                            slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(slRate), Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))))
                        End If
                    End If
                ElseIf (llDate <= lmEndCal) Then
                    slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk)))
                    If InStr(RTrim$(slRate), ".") > 0 Then
                        slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(slRate), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                    End If
                Else
                    Exit Do
                End If
                llDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
            Loop
        ElseIf tgChfInv.sBillCycle = "W" Then
            llDate = gDateValue(slSFlightDate)
            Do While llDate <= gDateValue(slEFlightDate)
                If llDate < lmStartWk Then
                    If llDate + 6 >= lmStartWk Then
                        slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk)))
                        If InStr(RTrim$(slRate), ".") > 0 Then
                            slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(slRate), Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))))
                        End If
                    End If
                ElseIf (llDate <= lmEndWk) Then
                    slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk)))
                    If InStr(RTrim$(slRate), ".") > 0 Then
                        slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(slRate), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                    End If
                Else
                    Exit Do
                End If
                llDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
            Loop
        Else
            llDate = gDateValue(slSFlightDate)
            Do While llDate <= gDateValue(slEFlightDate)
                If (llDate >= lmStartStd) And (llDate <= lmEndStd) Then
                    slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk)))
                    If InStr(RTrim$(slRate), ".") > 0 Then
                        slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(slRate), Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                    End If
                End If
                If llDate > lmEndStd Then
                    Exit Do
                End If
                llDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
            Loop
        End If
    Else    'Daily
        If tgChfInv.sBillCycle = "C" Then
            If gDateValue(slSFlightDate) >= lmStartCal Then
                llSDate = gDateValue(slSFlightDate)
            Else
                llSDate = lmStartCal
            End If
            For llDate = llSDate To gDateValue(slEFlightDate) Step 1
                If (llDate >= lmStartCal) And (llDate <= lmEndCal) Then
                    ilDay = gWeekDayLong(llDate)
                    slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                    If InStr(RTrim$(slRate), ".") > 0 Then
                        slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(slRate), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                    End If
                End If
                If llDate >= lmEndCal Then
                    Exit For
                End If
            Next llDate
        ElseIf tgChfInv.sBillCycle = "W" Then
            If gDateValue(slSFlightDate) >= lmStartWk Then
                llSDate = gDateValue(slSFlightDate)
            Else
                llSDate = lmStartWk
            End If
            For llDate = llSDate To gDateValue(slEFlightDate) Step 1
                If (llDate >= lmStartWk) And (llDate <= lmEndWk) Then
                    ilDay = gWeekDayLong(llDate)
                    slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                    If InStr(RTrim$(slRate), ".") > 0 Then
                        slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(slRate), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                    End If
                End If
                If llDate >= lmEndWk Then
                    Exit For
                End If
            Next llDate
        Else
            If gDateValue(slSFlightDate) >= lmStartStd Then
                llSDate = gDateValue(slSFlightDate)
            Else
                llSDate = lmStartStd
            End If
            For llDate = llSDate To gDateValue(slEFlightDate) Step 1
                If (llDate >= lmStartStd) And (llDate <= lmEndStd) Then
                    ilDay = gWeekDayLong(llDate)
                    slTotalNoPerWk = gAddStr(slTotalNoPerWk, Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay))))
                    If InStr(RTrim$(slRate), ".") > 0 Then
                        slTotalRate = gAddStr(slTotalRate, gMulStr(RTrim$(slRate), Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                    End If
                End If
                If llDate >= lmEndStd Then
                    Exit For
                End If
            Next llDate
        End If
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mReadCffRec                     *
'*                                                     *
'*             Created:8/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Read a record                  *
'*                                                     *
'*******************************************************
Private Function mReadCffRec(ilClfIndex As Integer, llStartSortIndex As Long, llEndSortIndex As Long) As Integer
'
'   iRet = mReadCffRec(ilClfIndex)
'   Where:
'       ilClfIndex (I) - CLF index (starting at 0)
'       iRet (O)- True if record read,
'                 False if not read
'
    'Dim ilIndex As Integer
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim slNameCode As String
    Dim slCode As String
    Dim slStr As String
    Dim ilUpperBound As Integer
    Dim ilFirst As Integer
    Dim tlCff As CFF
    Dim tlCffInvExt As CFFINVEXT    'Flight extract record
    Dim ilExtLen As Integer
    Dim llNoRec As Long
    Dim llRecPos As Long
    Dim ilOffSet As Integer
    Dim ilCgfUpper As Integer
    Dim slGameNo As String
    Dim ilCgf As Integer
    Dim ilVef As Integer
    Dim ilDay As Integer
    Dim llDate As Long
    Dim llStartCffDate As Long
    Dim llEndCffDate As Long
    Dim llMoStartCffDate As Long
    Dim llSuEndCffDate As Long
    Dim ilCff As Integer
    Dim ilUpper As Integer
    Dim ilStartInc As Integer   'Used to handle partial weeks
    Dim ilEndInc As Integer     'Used to handle partial weeks
    ReDim tlCffInv(0 To 0) As CFFLIST
    ilUpperBound = UBound(tlCffInv)
    ilFirst = True
    lbcLnCode.Clear
    btrExtClear hmCff   'Clear any previous extend operation
    ilExtLen = Len(tlCffInvExt)  'Extract operation record size
    tmCffSrchKey.lChfCode = tgChfInv.lCode
    tmCffSrchKey.iClfLine = tgClfInv(ilClfIndex).ClfRec.iLine
    tmCffSrchKey.iCntRevNo = tgClfInv(ilClfIndex).ClfRec.iCntRevNo
    tmCffSrchKey.iPropVer = tgClfInv(ilClfIndex).ClfRec.iPropVer
    tmCffSrchKey.iStartDate(0) = 0
    tmCffSrchKey.iStartDate(1) = 0
    ilRet = btrGetGreaterOrEqual(hmCff, tlCff, imCffRecLen, tmCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    If (tlCff.lChfCode = tgChfInv.lCode) And (tlCff.iClfLine = tgClfInv(ilClfIndex).ClfRec.iLine) Then
        'If (tlCff.iClfVersion = tgClfInv(ilClfIndex).ClfRec.iVersion) And (tlCff.sDelete <> "Y") Then
        '    gUnpackDateForSort tlCff.iStartDate(0), tlCff.iStartDate(1), slStr
        '    ilRet = btrGetPosition(hmCff, llRecPos)
        '    slStr = slStr & "\" & Trim$(Str$(llRecPos))
        '    lbcLnCode.AddItem slStr    'Add ID (retain matching sorted order) and Code number to list box
        'End If
        llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlAdf) 'Obtain number of records
        Call btrExtSetBounds(hmCff, llNoRec, -1, "UC", "CFFINVEXTPK", CFFINVEXTPK) 'Set extract limits (all records)
        ilOffSet = gFieldOffset("Cff", "CffChfCode")
        ilRet = btrExtAddLogicConst(hmCff, BTRV_KT_INT, ilOffSet, 4, BTRV_EXT_EQUAL, BTRV_EXT_AND, tgChfInv.lCode, 4)
        If ilRet <> BTRV_ERR_NONE Then
            mReadCffRec = False
            Exit Function
        End If
        ilOffSet = gFieldOffset("Cff", "CffClfLine")
        ilRet = btrExtAddLogicConst(hmCff, BTRV_KT_INT, ilOffSet, 2, BTRV_EXT_EQUAL, BTRV_EXT_AND, tgClfInv(ilClfIndex).ClfRec.iLine, 2)
        If ilRet <> BTRV_ERR_NONE Then
            mReadCffRec = False
            Exit Function
        End If
        ilOffSet = gFieldOffset("Cff", "CffCntRevNo")
        ilRet = btrExtAddLogicConst(hmCff, BTRV_KT_INT, ilOffSet, 2, BTRV_EXT_EQUAL, BTRV_EXT_AND, tgClfInv(ilClfIndex).ClfRec.iCntRevNo, 2)
        If ilRet <> BTRV_ERR_NONE Then
            mReadCffRec = False
            Exit Function
        End If
        ilOffSet = gFieldOffset("Cff", "CffPropVer")
        ilRet = btrExtAddLogicConst(hmCff, BTRV_KT_INT, ilOffSet, 2, BTRV_EXT_EQUAL, BTRV_EXT_AND, tgClfInv(ilClfIndex).ClfRec.iPropVer, 2)
        If ilRet <> BTRV_ERR_NONE Then
            mReadCffRec = False
            Exit Function
        End If
        ilOffSet = gFieldOffset("Cff", "CffDelete")
        ilRet = btrExtAddLogicConst(hmCff, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_LAST_TERM, ByVal "Y", 1)
        If ilRet <> BTRV_ERR_NONE Then
            mReadCffRec = False
            Exit Function
        End If
        ilOffSet = gFieldOffset("Cff", "CffCode")
        ilRet = btrExtAddField(hmCff, ilOffSet, 4)  'Extract start date
        If ilRet <> BTRV_ERR_NONE Then
            mReadCffRec = False
            Exit Function
        End If
        ilOffSet = gFieldOffset("Cff", "CffStartDate")
        ilRet = btrExtAddField(hmCff, ilOffSet, 4)  'Extract start date
        If ilRet <> BTRV_ERR_NONE Then
            mReadCffRec = False
            Exit Function
        End If
        'ilRet = btrExtGetNextExt(hmCff)    'Extract record
        ilRet = btrExtGetNext(hmCff, tlCffInvExt, ilExtLen, llRecPos)
        If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
            ilExtLen = Len(tlCffInvExt)  'Extract operation record size
            If ilRet = BTRV_ERR_REJECT_COUNT Then
                ilRet = btrExtGetNext(hmCff, tlCffInvExt, ilExtLen, llRecPos)
            End If
            Do While ilRet = BTRV_ERR_NONE
                gUnpackDateForSort tlCffInvExt.iStartDate(0), tlCffInvExt.iStartDate(1), slStr
                'slStr = slStr & "\" & Trim$(str$(llRecPos))
                slStr = slStr & "\" & Trim$(str$(tlCffInvExt.lCode))
                lbcLnCode.AddItem slStr    'Add ID (retain matching sorted order) and Code number to list box
                ilRet = btrExtGetNext(hmCff, tlCffInvExt, ilExtLen, llRecPos)
                If ilRet = BTRV_ERR_REJECT_COUNT Then
                    ilRet = btrExtGetNext(hmCff, tlCffInvExt, ilExtLen, llRecPos)
                End If
            Loop
            btrExtClear hmCff   'Clear any previous extend operation
            For ilLoop = 0 To lbcLnCode.ListCount - 1 Step 1
                ilUpperBound = UBound(tlCffInv)
                slNameCode = lbcLnCode.List(ilLoop)
                ilRet = gParseItem(slNameCode, 2, "\", slCode)
                slCode = Trim$(slCode)
                'llRecPos = CLng(slCode)
                'ilRet = btrGetDirect(hmCff, tlCffInv(ilUpperBound).CffRec, imCffRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                tmCffSrchKey1.lCode = CLng(slCode)
                ilRet = btrGetEqual(hmCff, tlCffInv(ilUpperBound).CffRec, imCffRecLen, tmCffSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                If ilRet <> BTRV_ERR_NONE Then
                    mReadCffRec = False
                    Exit Function
                End If
                'tlCffInv(ilUpperBound).lRecPos = llRecPos
                tlCffInv(ilUpperBound).lRecPos = tlCffInv(ilUpperBound).CffRec.lCode
                ReDim Preserve tlCffInv(0 To ilUpperBound + 1) As CFFLIST
            Next ilLoop
        End If
    End If
    ilUpperBound = UBound(tgCffInv)
    ilVef = gBinarySearchVef(tgClfInv(ilClfIndex).ClfRec.iVefCode)
    If ilVef <> -1 Then
        If tgMVef(ilVef).sType <> "G" Then
            For ilLoop = 0 To UBound(tlCffInv) - 1 Step 1
                '2/24/12: Split fligts into separate week if calendar
                If (tgChfInv.sBillCycle <> "C") Or (tlCffInv(ilLoop).CffRec.sDyWk = "D") Then
                    ReDim tlTempCff(0 To 1) As CFFLIST
                    tlTempCff(0) = tlCffInv(ilLoop)
                Else
                    'For calendar billing: For week that crosses the Calendar end date, use the number of spots to be billed from start of week to end of calendar date
                    '                      For week that crosses the Calendar start date, use the Ordered number of spots minus the number of billed spots in the previous month that crossed the calendar end date
                    ReDim tlTempCff(0 To 0) As CFFLIST
                    gUnpackDateLong tlCffInv(ilLoop).CffRec.iStartDate(0), tlCffInv(ilLoop).CffRec.iStartDate(1), llStartCffDate
                    gUnpackDateLong tlCffInv(ilLoop).CffRec.iEndDate(0), tlCffInv(ilLoop).CffRec.iEndDate(1), llEndCffDate
                    llMoStartCffDate = llStartCffDate
                    Do While gWeekDayLong(llMoStartCffDate) <> 0
                        llMoStartCffDate = llMoStartCffDate - 1
                    Loop
                    llSuEndCffDate = llEndCffDate
                    Do While gWeekDayLong(llSuEndCffDate) <> 6
                        llSuEndCffDate = llSuEndCffDate + 1
                    Loop
                    For llDate = llMoStartCffDate To llSuEndCffDate Step 7
                        If llDate > lmEndCal Then
                            Exit For
                        End If
                        ilStartInc = 0
                        If llDate < llStartCffDate Then
                            ilStartInc = llStartCffDate - llDate
                        End If
                        ilEndInc = 6
                        If llDate + ilEndInc > llEndCffDate Then
                            ilEndInc = llEndCffDate - llDate
                        End If
                        ilUpper = UBound(tlTempCff)
                        If (llDate + ilStartInc < lmStartCal) And (llDate + ilEndInc > lmStartCal) Then
                            tlTempCff(ilUpper) = tlCffInv(ilLoop)
                            gPackDateLong lmStartCal, tlTempCff(ilUpper).CffRec.iStartDate(0), tlTempCff(ilUpper).CffRec.iStartDate(1)
                            gPackDateLong llDate + ilEndInc, tlTempCff(ilUpper).CffRec.iEndDate(0), tlTempCff(ilUpper).CffRec.iEndDate(1)
                            tlTempCff(ilUpper).CffRec.iSpotsWk = tlTempCff(ilUpper).CffRec.iSpotsWk - mCalFirstWkCount(ilClfIndex, llDate + ilStartInc, lmStartCal - 1)
                            tlTempCff(ilUpper).CffRec.iXSpotsWk = 0
                            For ilDay = 0 To 6 Step 1
                                If (ilDay < gWeekDayLong(lmStartCal)) Then
                                    tlTempCff(ilUpper).CffRec.iDay(ilDay) = 0
                                End If
                            Next ilDay
                        ElseIf (llDate + ilStartInc < lmEndCal) And (llDate + ilEndInc > lmEndCal) Then
                            tlTempCff(ilUpper) = tlCffInv(ilLoop)
                            gPackDateLong llDate + ilStartInc, tlTempCff(ilUpper).CffRec.iStartDate(0), tlTempCff(ilUpper).CffRec.iStartDate(1)
                            gPackDateLong lmEndCal, tlTempCff(ilUpper).CffRec.iEndDate(0), tlTempCff(ilUpper).CffRec.iEndDate(1)
                            'Count number of spots airing within part of the week
                            tlTempCff(ilUpper).CffRec.iSpotsWk = mCalLastWkCount(ilClfIndex, llDate + ilStartInc, lmEndCal, llStartSortIndex, llEndSortIndex)
                            tlTempCff(ilUpper).CffRec.iXSpotsWk = 0
                            For ilDay = 0 To 6 Step 1
                                If (ilDay < gWeekDayLong(llDate + ilStartInc)) Or (ilDay > gWeekDayLong(lmEndCal)) Then
                                    tlTempCff(ilUpper).CffRec.iDay(ilDay) = 0
                                End If
                            Next ilDay
                        Else
                            tlTempCff(ilUpper) = tlCffInv(ilLoop)
                            gPackDateLong llDate + ilStartInc, tlTempCff(ilUpper).CffRec.iStartDate(0), tlTempCff(ilUpper).CffRec.iStartDate(1)
                            gPackDateLong llDate + ilEndInc, tlTempCff(ilUpper).CffRec.iEndDate(0), tlTempCff(ilUpper).CffRec.iEndDate(1)
                        End If
                        If (llDate + ilEndInc >= lmStartCal) And (llDate + ilStartInc <= lmEndCal) And (tlTempCff(ilUpper).CffRec.iSpotsWk > 0) Then
                            ReDim Preserve tlTempCff(0 To UBound(tlTempCff) + 1) As CFFLIST
                        End If
                    Next llDate
                End If
                For ilCff = 0 To UBound(tlTempCff) - 1 Step 1
                    tgCffInv(ilUpperBound) = tlTempCff(ilCff)  'tlCffInv(ilLoop)
                    If tgClfInv(ilClfIndex).iFirstCff = -1 Then
                        tgClfInv(ilClfIndex).iFirstCff = ilUpperBound
                    Else
                        tgCffInv(ilUpperBound - 1).iNextCff = ilUpperBound
                    End If
                    tgCffInv(ilUpperBound).iNextCff = -1
                    tgCffInv(ilUpperBound).lRecPos = tlTempCff(ilCff).lRecPos   'tlCffInv(ilLoop).lRecPos
                    tgCffInv(ilUpperBound).iStatus = 1 'Old and retain
                    tgCffInv(ilUpperBound).iGameNo = 0
                    ilUpperBound = ilUpperBound + 1
                    ReDim Preserve tgCffInv(0 To ilUpperBound) As CFFLIST
                Next ilCff
                tgCffInv(ilUpperBound).iStatus = -1 'Not Used
                tgCffInv(ilUpperBound).iNextCff = -1
                tgCffInv(ilUpperBound).lRecPos = 0
            Next ilLoop
        Else
            ReDim tmCGFSort(0 To 0) As CGFSORT
            ilCgfUpper = 0
            imCgfRecLen = Len(tmCgf)
            tmCgfSrchKey1.lClfCode = tgClfInv(ilClfIndex).ClfRec.lCode
            ilRet = btrGetEqual(hmCgf, tmCgf, imCgfRecLen, tmCgfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            Do While (ilRet = BTRV_ERR_NONE) And (tmCgf.lClfCode = tgClfInv(ilClfIndex).ClfRec.lCode)
                gUnpackDateForSort tmCgf.iAirDate(0), tmCgf.iAirDate(1), slStr
                slGameNo = Trim$(str$(tmCgf.iGameNo))
                '6/30/12:  Allow 5 digit event #'s
                Do While Len(slGameNo) < 5  '3
                    slGameNo = "0" & slGameNo
                Loop
                tmCGFSort(ilCgfUpper).sKey = slStr & "|" & slGameNo
                tmCGFSort(ilCgfUpper).CgfRec = tmCgf
                ilCgfUpper = ilCgfUpper + 1
                ReDim Preserve tmCGFSort(0 To ilCgfUpper) As CGFSORT
                ilRet = btrGetNext(hmCgf, tmCgf, imCgfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
            If ilCgfUpper > 0 Then
                ArraySortTyp fnAV(tmCGFSort(), 0), ilCgfUpper, 0, LenB(tmCGFSort(0)), 0, LenB(tmCGFSort(0).sKey), 0
            End If
            'Create CFF record from game records
            For ilCgf = 0 To UBound(tmCGFSort) - 1 Step 1
                tgCffInv(ilUpperBound).CffRec.lChfCode = tgClfInv(ilClfIndex).ClfRec.lChfCode
                tgCffInv(ilUpperBound).CffRec.iClfLine = tgClfInv(ilClfIndex).ClfRec.iLine
                tgCffInv(ilUpperBound).CffRec.iCntRevNo = tgClfInv(ilClfIndex).ClfRec.iCntRevNo
                tgCffInv(ilUpperBound).CffRec.iPropVer = tgClfInv(ilClfIndex).ClfRec.iPropVer
                tgCffInv(ilUpperBound).CffRec.iStartDate(0) = tmCGFSort(ilCgf).CgfRec.iAirDate(0)
                tgCffInv(ilUpperBound).CffRec.iStartDate(1) = tmCGFSort(ilCgf).CgfRec.iAirDate(1)
                tgCffInv(ilUpperBound).CffRec.iEndDate(0) = tgCffInv(ilUpperBound).CffRec.iStartDate(0)
                tgCffInv(ilUpperBound).CffRec.iEndDate(1) = tgCffInv(ilUpperBound).CffRec.iStartDate(1)
                tgCffInv(ilUpperBound).CffRec.sDyWk = "D"
                tgCffInv(ilUpperBound).CffRec.iSpotsWk = 0
                tgCffInv(ilUpperBound).CffRec.iXSpotsWk = 0
                For ilDay = 0 To 6 Step 1
                    tgCffInv(ilUpperBound).CffRec.iDay(ilDay) = 0
                    tgCffInv(ilUpperBound).CffRec.sXDay(ilDay) = "0"
                Next ilDay
                ''UnpackDateLong tlCff(1).iStartDate(0), tlCff(1).iStartDate(1), llDate
                'gUnpackDateLong tmCGFSort(ilCgf).CgfRec.iAirDate(0), tmCGFSort(ilCgf).CgfRec.iAirDate(1), llDate
                gUnpackDateLongError tmCGFSort(ilCgf).CgfRec.iAirDate(0), tmCGFSort(ilCgf).CgfRec.iAirDate(1), llDate, "42:mReadCffRec " & tmCGFSort(ilCgf).CgfRec.lCode
                ilDay = gWeekDayLong(llDate)
                tgCffInv(ilUpperBound).CffRec.iDay(ilDay) = tmCGFSort(ilCgf).CgfRec.iNoSpots
                tgCffInv(ilUpperBound).CffRec.sDelete = "N"
                tgCffInv(ilUpperBound).CffRec.lActPrice = 0
                llRecPos = 0
                For ilLoop = 0 To UBound(tlCffInv) - 1 Step 1
                    'gUnpackDateLong tlCffInv(ilLoop).CffRec.iStartDate(0), tlCffInv(ilLoop).CffRec.iStartDate(1), llStartCffDate
                    gUnpackDateLongError tlCffInv(ilLoop).CffRec.iStartDate(0), tlCffInv(ilLoop).CffRec.iStartDate(1), llStartCffDate, "43:mReadCffRec-CFF "
                    'gUnpackDateLong tlCffInv(ilLoop).CffRec.iEndDate(0), tlCffInv(ilLoop).CffRec.iEndDate(1), llEndCffDate
                    gUnpackDateLongError tlCffInv(ilLoop).CffRec.iEndDate(0), tlCffInv(ilLoop).CffRec.iEndDate(1), llEndCffDate, "44:mReadCffRec-CFF "
                    If (llDate >= llStartCffDate) And (llDate <= llEndCffDate) Then
                        tgCffInv(ilUpperBound).CffRec.sPriceType = tlCffInv(ilLoop).CffRec.sPriceType
                        tgCffInv(ilUpperBound).CffRec.lActPrice = tlCffInv(ilLoop).CffRec.lActPrice
                        llRecPos = tlCffInv(ilLoop).lRecPos
                        Exit For
                    End If
                Next ilLoop
                If tgClfInv(ilClfIndex).iFirstCff = -1 Then
                    tgClfInv(ilClfIndex).iFirstCff = ilUpperBound
                Else
                    tgCffInv(ilUpperBound - 1).iNextCff = ilUpperBound
                End If
                tgCffInv(ilUpperBound).iNextCff = -1
                tgCffInv(ilUpperBound).lRecPos = llRecPos
                tgCffInv(ilUpperBound).iStatus = 1 'Old and retain
                tgCffInv(ilUpperBound).iGameNo = tmCGFSort(ilCgf).CgfRec.iGameNo
                ilUpperBound = ilUpperBound + 1
                ReDim Preserve tgCffInv(0 To ilUpperBound) As CFFLIST
                tgCffInv(ilUpperBound).iStatus = -1 'Not Used
                tgCffInv(ilUpperBound).iNextCff = -1
                tgCffInv(ilUpperBound).lRecPos = 0
                tgCffInv(ilUpperBound).iGameNo = 0
            Next ilCgf
        End If
    End If
    mReadCffRec = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mReadChfRec                     *
'*                                                     *
'*             Created:7/20/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Read a record                  *
'*                                                     *
'*******************************************************
Private Function mReadChfRec(llStartSortIndex As Long, llEndSortIndex As Long, slProduct As String) As Integer
'
'   iRet = mReadChfRec(llStartSortIndex, llEndSortIndex)
'   Where:
'       llStartSortIndex (I/O) - Index into tgSort for first spot to be invoiced
'       llEndSortIndex (I/O) - Index into tgSort for last spot to be invoiced
'                                First time this is set to LBound(tgSortKey) - 1
'       iRet (O)- True if record read,
'                 False if not read
'
    Dim ilLoop As Integer
    Dim llLoop As Long
    'Dim ilIndex As Integer
    Dim slStartProduct As String
    Dim slTestProduct As String
    Dim slStartVehicle As String
    Dim slTestVehicle As String
    Dim ilRet As Integer    'Return status
    Dim llDate As Long
    Dim llTime As Long
    'Dim slDate As String
    Dim ilFound As Integer
    Dim ilClfIndex As Integer
    Dim slNameCode As String
    Dim slCode As String
    'Dim llStdStartDate As Long
    'Dim llStdEndDate As Long
    'Dim llCalStartDate As Long
    'Dim llCalEndDate As Long
    'Dim ilVeh As Integer
    'Dim ilVsf As Integer
    'Dim ilVefCode As Integer
    'Dim ilExtLen As Integer
    'Dim llNoRec As Long
    'Dim ilOffset As Integer
    'Dim tlVef As VEF
    Dim slStr As String
    Dim llInvNo As Long
    Dim slPkLineNo As String
    Dim ilPkLineNo As Integer
    Dim ilVef As Integer
    Dim ilSvChkHistory As Integer

    ilFound = False
    Do
        If igUsedISR Then
            ReDim tgSortKey(0 To 0) As TYPESORTKEY
            If (llEndSortIndex = -1) Then
                gPackDate smGenDate, tmIsrSrchKey0.iGenDate(0), tmIsrSrchKey0.iGenDate(1)
                gPackTime smGenTime, tmIsrSrchKey0.iGenTime(0), tmIsrSrchKey0.iGenTime(1)
                tmIsrSrchKey0.sKey = ""
                ilRet = btrGetGreaterOrEqual(hmIsr, tmIsr, imIsrRecLen, tmIsrSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                If ilRet <> BTRV_ERR_NONE Then
                    mReadChfRec = False
                    Exit Function
                End If
            End If
            llEndSortIndex = -1
            ilRet = gParseItem(tmIsr.sKey, 4, "|", slStartProduct)
            ilRet = gParseItem(tmIsr.sKey, 5, "|", slStartVehicle)
            ilRet = gParseItem(tmIsr.sKey, 13, "|", slPkLineNo)
            ilPkLineNo = Val(slPkLineNo)
            Do
                'Test GenDate and Time
                'gUnpackDateLong tmIsr.iGenDate(0), tmIsr.iGenDate(1), llDate
                gUnpackDateLongError tmIsr.iGenDate(0), tmIsr.iGenDate(1), llDate, "45:mReadChfRec " & tmIsr.lCode
                If lmGenDate <> llDate Then
                    Exit Do
                End If
                gUnpackTimeLong tmIsr.iGenTime(0), tmIsr.iGenTime(1), False, llTime
                If lmGenTime <> llTime Then
                    Exit Do
                End If
                LSet tgSortKey(UBound(tgSortKey)) = tmIsr
                ReDim Preserve tgSortKey(0 To UBound(tgSortKey) + 1) As TYPESORTKEY
                ilRet = btrGetNext(hmIsr, tmIsr, imIsrRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                If ilRet <> BTRV_ERR_NONE Then
                    tmIsr.iGenDate(0) = 0
                    tmIsr.iGenDate(1) = 0
                    tmIsr.iGenTime(0) = 0
                    tmIsr.iGenTime(1) = 0
                    Exit Do
                End If
                If tgSortKey(0).lChfCode <> tmIsr.lChfCode Then
                    Exit Do
                End If
                If tgSortKey(0).sInvGp = "P" Then
                    If tgSortKey(0).lChfCode = tmIsr.lChfCode Then
                        If tgSpf.sBCombine <> "N" Then  '= "Y"
                            'Test product
                            ilRet = gParseItem(tmIsr.sKey, 4, "|", slTestProduct)
                            If StrComp(slStartProduct, slTestProduct, 1) <> 0 Then
                                Exit Do
                            End If
                        Else
                            'Test product
                            ilRet = gParseItem(tmIsr.sKey, 4, "|", slTestProduct)
                            ilRet = gParseItem(tmIsr.sKey, 5, "|", slTestVehicle)
                            ilRet = gParseItem(tmIsr.sKey, 13, "|", slPkLineNo)
                            If ilPkLineNo > 0 Then
                                If (StrComp(slStartProduct, slTestProduct, 1) <> 0) Or (Val(slPkLineNo) <> ilPkLineNo) Then
                                    Exit Do
                                End If
                            Else
                                If (StrComp(slStartProduct, slTestProduct, 1) <> 0) Or (StrComp(slStartVehicle, slTestVehicle, 1) <> 0) Then
                                    Exit Do
                                End If
                            End If
                        End If
                    End If
                ElseIf tgSortKey(0).sInvGp = "T" Then
                Else
                    If tgSortKey(0).lChfCode = tmIsr.lChfCode Then
                        If tgSpf.sBCombine = "N" Then  '= "Y"
                            ilRet = gParseItem(tmIsr.sKey, 5, "|", slTestVehicle)
                            ilRet = gParseItem(tmIsr.sKey, 13, "|", slPkLineNo)
                            If ilPkLineNo > 0 Then
                                If Val(slPkLineNo) <> ilPkLineNo Then
                                    Exit Do
                                End If
                            Else
                                If StrComp(slStartVehicle, slTestVehicle, 1) <> 0 Then
                                    Exit Do
                                End If
                            End If
                        End If
                    End If
                End If
            Loop While (ilRet = BTRV_ERR_NONE) And (tmIsr.lChfCode = tgSortKey(0).lChfCode)
            ReDim tmSpeedSortParse(0 To UBound(tgSortKey)) As SPEEDSORTPARSE
            For llLoop = 0 To UBound(tgSortKey) - 1 Step 1
                ilRet = gParseItem(tgSortKey(llLoop).sKey, 9, "|", slStr)
                tmSpeedSortParse(llLoop).sVehName = slStr
                ilRet = gParseItem(tgSortKey(llLoop).sKey, 11, "|", slStr)
                tmSpeedSortParse(llLoop).sSdfDate = slStr
                ilRet = gParseItem(tgSortKey(llLoop).sKey, 12, "|", slStr)
                tmSpeedSortParse(llLoop).sSdfTime = slStr
            Next llLoop
        Else
            'DL 11/19/01- removed code and added building of tgSortKey like code above
            'If (llEndSortIndex = -1) Then
            '    ReDim tmSpeedSortParse(0 To UBound(tgSortKey)) As SPEEDSORTPARSE
            '    For ilLoop = 0 To UBound(tgSortKey) - 1 Step 1
            '        ilRet = gParseItem(tgSortKey(ilLoop).sKey, 9, "|", slStr)
            '        tmSpeedSortParse(ilLoop).sVehName = slStr
            '        ilRet = gParseItem(tgSortKey(ilLoop).sKey, 11, "|", slStr)
            '        tmSpeedSortParse(ilLoop).sSdfDate = slStr
            '        ilRet = gParseItem(tgSortKey(ilLoop).sKey, 12, "|", slStr)
            '        tmSpeedSortParse(ilLoop).sSdfTime = slStr
            '    Next ilLoop
            'End If
            ReDim tgSortKey(0 To 0) As TYPESORTKEY
            llEndSortIndex = -1
            If imLbcKeyIndex < lbcKey.ListCount Then
                tmSortISR.sKey = lbcKey.List(imLbcKeyIndex)
                tmSortISR.tSort = tgSortNoKey(lbcKey.ItemData(imLbcKeyIndex))
                LSet tmIsr = tmSortISR
                'imLbcKeyIndex = imLbcKeyIndex + 1
                ilRet = gParseItem(tmIsr.sKey, 4, "|", slStartProduct)
                ilRet = gParseItem(tmIsr.sKey, 5, "|", slStartVehicle)
                ilRet = gParseItem(tmIsr.sKey, 13, "|", slPkLineNo)
                ilPkLineNo = Val(slPkLineNo)
                Do
                    ''Test GenDate and Time
                    'gUnpackDateLong tmIsr.iGenDate(0), tmIsr.iGenDate(1), llDate
                    'If lmGenDate <> llDate Then
                    '    Exit Do
                    'End If
                    'gUnpackTimeLong tmIsr.iGenTime(0), tmIsr.iGenTime(1), False, llTime
                    'If lmGenTime <> llTime Then
                    '    Exit Do
                    'End If
                    LSet tgSortKey(UBound(tgSortKey)) = tmIsr
                    ReDim Preserve tgSortKey(0 To UBound(tgSortKey) + 1) As TYPESORTKEY
                    imLbcKeyIndex = imLbcKeyIndex + 1
                    'ilRet = btrGetNext(hmIsr, tmIsr, imIsrRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If imLbcKeyIndex >= lbcKey.ListCount Then
                        'tmIsr.iGenDate(0) = 0
                        'tmIsr.iGenDate(1) = 0
                        'tmIsr.iGenTime(0) = 0
                        'tmIsr.iGenTime(1) = 0
                        Exit Do
                    End If
                    tmSortISR.sKey = lbcKey.List(imLbcKeyIndex)
                    tmSortISR.tSort = tgSortNoKey(lbcKey.ItemData(imLbcKeyIndex))
                    LSet tmIsr = tmSortISR
                    If tgSortKey(0).lChfCode <> tmIsr.lChfCode Then
                        Exit Do
                    End If
                    If tgSortKey(0).sInvGp = "P" Then
                        If tgSortKey(0).lChfCode = tmIsr.lChfCode Then
                            If tgSpf.sBCombine <> "N" Then  '= "Y"
                                'Test product
                                ilRet = gParseItem(tmIsr.sKey, 4, "|", slTestProduct)
                                If StrComp(slStartProduct, slTestProduct, 1) <> 0 Then
                                    Exit Do
                                End If
                            Else
                                'Test product
                                ilRet = gParseItem(tmIsr.sKey, 4, "|", slTestProduct)
                                ilRet = gParseItem(tmIsr.sKey, 5, "|", slTestVehicle)
                                ilRet = gParseItem(tmIsr.sKey, 13, "|", slPkLineNo)
                                If ilPkLineNo > 0 Then
                                    If (StrComp(slStartProduct, slTestProduct, 1) <> 0) Or (Val(slPkLineNo) <> ilPkLineNo) Then
                                        Exit Do
                                    End If
                                Else
                                    If (StrComp(slStartProduct, slTestProduct, 1) <> 0) Or (StrComp(slStartVehicle, slTestVehicle, 1) <> 0) Or (Val(slPkLineNo) <> 0) Then
                                        Exit Do
                                    End If
                                End If
                            End If
                        End If
                    ElseIf tgSortKey(0).sInvGp = "T" Then
                    Else
                        If tgSortKey(0).lChfCode = tmIsr.lChfCode Then
                            If tgSpf.sBCombine = "N" Then  '= "Y"
                                ilRet = gParseItem(tmIsr.sKey, 5, "|", slTestVehicle)
                                ilRet = gParseItem(tmIsr.sKey, 13, "|", slPkLineNo)
                                If ilPkLineNo > 0 Then
                                    If Val(slPkLineNo) <> ilPkLineNo Then
                                        Exit Do
                                    End If
                                Else
                                    If (StrComp(slStartVehicle, slTestVehicle, 1) <> 0) Or (Val(slPkLineNo) <> 0) Then
                                        Exit Do
                                    End If
                                End If
                            End If
                        End If
                    End If
                Loop While (imLbcKeyIndex < lbcKey.ListCount) And (tmIsr.lChfCode = tgSortKey(0).lChfCode)
            End If
            ReDim tmSpeedSortParse(0 To UBound(tgSortKey)) As SPEEDSORTPARSE
            For llLoop = 0 To UBound(tgSortKey) - 1 Step 1
                ilRet = gParseItem(tgSortKey(llLoop).sKey, 9, "|", slStr)
                tmSpeedSortParse(llLoop).sVehName = slStr
                ilRet = gParseItem(tgSortKey(llLoop).sKey, 11, "|", slStr)
                tmSpeedSortParse(llLoop).sSdfDate = slStr
                ilRet = gParseItem(tgSortKey(llLoop).sKey, 12, "|", slStr)
                tmSpeedSortParse(llLoop).sSdfTime = slStr
            Next llLoop
            'DL 11/19/01
        End If
        llStartSortIndex = llEndSortIndex + 1
        If llStartSortIndex >= UBound(tgSortKey) Then
            mReadChfRec = False
            Exit Function
        End If
        'Determine if contract selected
        'For ilLoop = 0 To lbcCntr.ListCount - 1 Step 1
        '    slNameCode = lbcCntrCode.List(ilLoop)
        '    ilRet = gParseItem(slNameCode, 2, "\", slCode)
        '    If Val(slCode) = tgSortKey(llStartSortIndex).lChfCode Then
        '        If lbcCntr.Selected(ilLoop) Then
        For ilLoop = grdAirTime.FixedRows To grdAirTime.rows - 1 Step 1
            slCode = grdAirTime.TextMatrix(ilLoop, ATCHFCODEINDEX)
            If Val(slCode) = tgSortKey(llStartSortIndex).lChfCode Then
                If grdAirTime.TextMatrix(ilLoop, ATSELECTEDINDEX) = "1" Then
                    'Find end index
                    tmChfSrchKey.lCode = Val(slCode)
                    ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        mReadChfRec = False
                        Exit Function
                    End If
                    ilFound = True
                End If
                Exit For
            End If
        Next ilLoop
        If ilFound Then
            ilRet = gParseItem(tgSortKey(llStartSortIndex).sKey, 4, "|", slStartProduct)
            ilRet = gParseItem(tgSortKey(llStartSortIndex).sKey, 5, "|", slStartVehicle)
            ilRet = gParseItem(tgSortKey(llStartSortIndex).sKey, 13, "|", slPkLineNo)
            ilPkLineNo = Val(slPkLineNo)
        End If
        For llLoop = llStartSortIndex To UBound(tgSortKey) - 1 Step 1
            If ilFound Then
                slProduct = slStartProduct
                If tgSortKey(llStartSortIndex).sInvGp = "P" Then
                    If tgSortKey(llStartSortIndex).lChfCode = tgSortKey(llLoop).lChfCode Then
                        If tgSpf.sBCombine <> "N" Then  '= "Y"
                            'Test product
                            ilRet = gParseItem(tgSortKey(llLoop).sKey, 4, "|", slTestProduct)
                            If StrComp(slStartProduct, slTestProduct, 1) = 0 Then
                                llEndSortIndex = llLoop
                            Else
                                Exit For
                            End If
                        Else
                            'Test product
                            ilRet = gParseItem(tgSortKey(llLoop).sKey, 4, "|", slTestProduct)
                            ilRet = gParseItem(tgSortKey(llLoop).sKey, 5, "|", slTestVehicle)
                            ilRet = gParseItem(tgSortKey(llLoop).sKey, 13, "|", slPkLineNo)
                            If ilPkLineNo > 0 Then
                                If (StrComp(slStartProduct, slTestProduct, 1) = 0) And (Val(slPkLineNo) = ilPkLineNo) Then
                                    llEndSortIndex = llLoop
                                Else
                                    Exit For
                                End If
                            Else
                                If (StrComp(slStartProduct, slTestProduct, 1) = 0) And (StrComp(slStartVehicle, slTestVehicle, 1) = 0) And (Val(slPkLineNo) = 0) Then
                                    llEndSortIndex = llLoop
                                Else
                                    Exit For
                                End If
                            End If
                        End If
                    Else
                        Exit For
                    End If
                ElseIf tgSortKey(llStartSortIndex).sInvGp = "T" Then
                Else
                    If tgSortKey(llStartSortIndex).lChfCode = tgSortKey(llLoop).lChfCode Then
                        If tgSpf.sBCombine <> "N" Then  '= "Y"
                            'If require bonus on separate invoice add this code
                            'We also want to add question to site option- Bonus on Separate Invoices Y or N
                            'If tgSortKey(llStartSortIndex).iLine <> -1 Then   '-1=Bonus spot
                            '    If tgSortKey(llLoop).iLine = -1 Then
                            '        Exit For
                            '    End If
                            'End If
                            llEndSortIndex = llLoop
                        Else
                            ilRet = gParseItem(tgSortKey(llLoop).sKey, 5, "|", slTestVehicle)
                            ilRet = gParseItem(tgSortKey(llLoop).sKey, 13, "|", slPkLineNo)
                            If ilPkLineNo > 0 Then
                                If Val(slPkLineNo) = ilPkLineNo Then
                                    llEndSortIndex = llLoop
                                Else
                                    Exit For
                                End If
                            Else
                                If (StrComp(slStartVehicle, slTestVehicle, 1) = 0) And (Val(slPkLineNo) = 0) Then
                                    llEndSortIndex = llLoop
                                Else
                                    Exit For
                                End If
                            End If
                        End If
                    Else
                        Exit For
                    End If
                End If
            Else
                'Bypass contract
                If tgSortKey(llStartSortIndex).lChfCode = tgSortKey(llLoop).lChfCode Then
                    llEndSortIndex = llLoop
                Else
                    Exit For
                End If
            End If
        Next llLoop
        If ilFound Then
            imSeparateVefCode = 0
            If (tgSpf.sBCombine = "N") And ((Asc(tgSpf.sUsingFeatures4) And LOCKBOXBYVEHICLE) = LOCKBOXBYVEHICLE) Then
                slStartVehicle = Trim$(slStartVehicle)
                For ilVef = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                    If StrComp(Trim$(tgMVef(ilVef).sName), slStartVehicle, vbTextCompare) = 0 Then
                        imSeparateVefCode = tgMVef(ilVef).iCode
                        Exit For
                    End If
                Next ilVef
            End If
            mGetAdfAgfSlf
            'If Bonus spots and all "Fill" Type- bypass
            ilFound = False
            For llLoop = llStartSortIndex To llEndSortIndex Step 1
                If tgSortKey(llLoop).iLineNo <> -1 Then
                    ilFound = True
                    Exit For
                End If
                ''If (tgSortKey(llLoop).sPriceType = "N") Then
                'If (tmAdf.sBonusOnInv = "N") Then
                If tmSdf.sPriceType = "+" Then
                    ilFound = True
                    Exit For
                ElseIf (tmAdf.sBonusOnInv = "N") Or (tmSdf.sPriceType = "-") Then
                    If rbcType(INVGEN_Final).Value Then
                        tgSortKey(llLoop).iBilled = True
                    End If
                Else
                    ilFound = True
                    Exit For
                End If

            Next llLoop
            If (Not ilFound) And rbcType(INVGEN_Final).Value Then
                If igUsedISR Then
                    ilRet = mUpdateInv(0)
                    ReDim tgRvf(0 To 0) As RVF
                    ReDim tgRvfByVef(0 To 0) As RVFVEF
                'DL 11/19/01- added else and code
                Else
                    ilRet = mUpdateInv(0)
                    ReDim tgRvf(0 To 0) As RVF
                    ReDim tgRvfByVef(0 To 0) As RVFVEF
                'DL 11/19/01
                End If
            End If
        End If
        If (ilFound) And rbcType(INVGEN_Final).Value Then
            'If (tgSpf.sBCombine = "Y") Or ((tgSpf.sBCombine = "N") And (tgChfInv.lCntrNo <> lmPrevCombineCntrNo)) Then
            '    If tgChfInv.sBillCycle = "C" Then
            '        gPackDate smEndCal, ilTranDate(0), ilTranDate(1)
            '    Else
            '        gPackDate smEndStd, ilTranDate(0), ilTranDate(1)
            '    End If
            '    tmRvfSrchKey1.iAdfCode = tgChfInv.iAdfCode
            '    ilRet = btrGetEqual(hmRvf, tmRvf, imRvfRecLen, tmRvfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            '    Do While (ilRet = BTRV_ERR_NONE) And (tmRvf.iAdfCode = tgChfInv.iAdfCode)
            '        If (tgChfInv.iagfCode = tmRvf.iagfCode) And (tgChfInv.lCntrNo = tmRvf.lCntrNo) Then
            '            If (ilTranDate(0) = tmRvf.iTranDate(0)) And (ilTranDate(1) = tmRvf.iTranDate(1)) And (tmRvf.sTranType = "IN") And ((tmRvf.sCashTrade = "C") Or (tmRvf.sCashTrade = "T")) Then
            '                ilFound = False
            '                Exit Do
            '            End If
            '        End If
            '        ilRet = btrGetNext(hmRvf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            '    Loop
            '    If (imGenCntrExport = True) And (ilFound) Then
            '        tmRvfSrchKey1.iAdfCode = tgChfInv.iAdfCode
            '        ilRet = btrGetEqual(hmPhf, tmRvf, imRvfRecLen, tmRvfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            '        Do While (ilRet = BTRV_ERR_NONE) And (tmRvf.iAdfCode = tgChfInv.iAdfCode)
            '            If (tgChfInv.iagfCode = tmRvf.iagfCode) And (tgChfInv.lCntrNo = tmRvf.lCntrNo) Then
            '                If (ilTranDate(0) = tmRvf.iTranDate(0)) And (ilTranDate(1) = tmRvf.iTranDate(1)) And (tmRvf.sTranType = "HI") And ((tmRvf.sCashTrade = "C") Or (tmRvf.sCashTrade = "T")) Then
            '                    ilFound = False
            '                    Exit Do
            '                End If
            '            End If
            '            ilRet = btrGetNext(hmRvf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            '        Loop
            '    End If
            '    If Not ilFound Then
            '        lmPrevCombineCntrNo = -1
            '    Else
            '        lmPrevCombineCntrNo = tgChfInv.lCntrNo
            '    End If
            'End If
            'If mRvfExist(llInvNo, 0, 0) Then
            ilSvChkHistory = imChkHistory
            imChkHistory = True
            If mRvfExist(llInvNo, 0, 0, "") Then
                ilFound = False
            Else
                ilFound = True
            End If
            imChkHistory = ilSvChkHistory

        End If
        'If ilFound And (tgSpf.sInvAirOrder = "2") And (tgSpf.sBLaserForm = "2") Then
        '    If rbcType(INVGEN_Preliminary).Value Or rbcType(INVGEN_Final).Value Then
        '        'Test if only missed spots (Missed, Missed part of MG or Missed part of O)
        '        'then test if any unbilled spots exist- if so, continus with contract
        '        'If not, bypass contract as previously billed
        '        ilFound = False
        '        For ilLoop = llStartSortIndex To llEndSortIndex Step 1
        '            If tgSortKey(ilLoop).sSchStatus = "S" Then
        '                ilFound = True
        '                Exit For
        '            ElseIf (tgSortKey(ilLoop).sSchStatus = "G") Or (tgSortKey(ilLoop).sSchStatus = "O") Then
        '                If tgSortKey(ilLoop).iType = 0 Then    '1=Missed part of MG or Outside; 2= PSF
        '                    ilFound = True
        '                    Exit For
        '                End If
        '            End If
        '        Next ilLoop
        '        If Not ilFound Then
        '            ilFound = True
        '            gObtainCntrSpots
        '            'Any spots other then missed
        '            llStdStartDate = lmStartStd 'gDateValue(smStartStd)
        '            llStdEndDate = lmEndStd 'gDateValue(smEndStd)
        '            llCalStartDate = lmStartCal 'gDateValue(smStartCal)
        '            llCalEndDate = lmEndCal 'gDateValue(smEndCal)
        '            For ilVeh = 0 To UBound(tgInvVehCode) - 1 Step 1'lbcVehicle.ListCount - 1 Step 1
        '                slNameCode = tgInvVehCode(ilVeh)    'Traffic!lbcVehicle.List(ilVeh)
        '                ilRet = gParseItem(slNameCode, 2, "\", slCode)
        '                ilVefCode = Val(slCode)
        '                tmVefSrchKey.iCode = ilVefCode
        '                ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        '                If tmVef.sType <> "V" Then
        '                    For ilVsf = LBound(tmVsf.iFSCode) To UBound(tmVsf.iFSCode) Step 1
        '                        tmVsf.iFSCode(ilVsf) = 0
        '                    Next ilVsf
        '                    tmVsf.iFSCode(LBound(tmVsf.iFSCode)) = ilVefCode
        '                Else
        '                    tmVsfSrchKey.lCode = tmVef.lVsfCode
        '                    ilRet = btrGetEqual(hmVsf, tmVsf, imVsfReclen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        '                    'Include virtual vehicle as first vehicle
        '                    For ilVsf = UBound(tmVsf.iFSCode) To LBound(tmVsf.iFSCode) + 1 Step -1
        '                        tmVsf.iFSCode(ilVsf) = tmVsf.iFSCode(ilVsf - 1)
        '                        tmVsf.iNoSpots(ilVsf) = tmVsf.iNoSpots(ilVsf - 1)
        '                        tmVsf.lFSComm(ilVsf) = tmVsf.lFSComm(ilVsf - 1)
        '                    Next ilVsf
        '                    tmVsf.iFSCode(LBound(tmVsf.iFSCode)) = ilVefCode
        '                    tmVsf.iNoSpots(LBound(tmVsf.iFSCode)) = 1
        '                    'gStrToPDN "100.0000", 4, 4, tmVsf.sFSComm(LBound(tmVsf.iFSCode))
        '                    tmVsf.lFSComm(LBound(tmVsf.iFSCode)) = 1000000
        '                End If
        '                For ilVsf = LBound(tmVsf.iFSCode) To UBound(tmVsf.iFSCode) Step 1
        '                    If tmVsf.iFSCode(ilVsf) > 0 Then
        '                        If tmVef.sType = "V" Then
        '                            tmVefSrchKey.iCode = tmVsf.iFSCode(ilVsf)   'ilVefCode
        '                            ilRet = btrGetEqual(hmVef, tlVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                tlVef.sName = "Vehicle Missing"
        '                            End If
        '                        Else
        '                            tlVef = tmVef
        '                        End If
        '                        ilExtLen = 2 + 4 + 2 + 4 + 4 + 1 + 1 + 2 + 1 + 1 + 1'VefCode+ChfCode+LineNo+Date+Time+Status+Tracer+Length+PriceType+SpotType+Bill Len(tmSdfExt(1)) - 4'Extract operation record size
        '                        llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hmSdf) 'Obtain number of records
        '                        btrExtClear hmSdf   'Clear any previous extend operation
        '                        tmSdfSrchKey1.iVefCode = tmVsf.iFSCode(ilVsf)   'ilVefCode
        '                        If (llStdStartDate > 0) And (llCalStartDate > 0) Then
        '                            If llStdStartDate < llCalStartDate Then
        '                                gPackDate smStartStd, tmSdfSrchKey1.iDate(0), tmSdfSrchKey1.iDate(1)
        '                            Else
        '                                gPackDate smStartCal, tmSdfSrchKey1.iDate(0), tmSdfSrchKey1.iDate(1)
        '                            End If
        '                        ElseIf llCalStartDate > 0 Then
        '                            gPackDate smStartCal, tmSdfSrchKey1.iDate(0), tmSdfSrchKey1.iDate(1)
        '                        Else
        '                            gPackDate smStartStd, tmSdfSrchKey1.iDate(0), tmSdfSrchKey1.iDate(1)
        '                        End If
        '                        tmSdfSrchKey1.iTime(0) = 0
        '                        tmSdfSrchKey1.iTime(1) = 0
        '                        tmSdfSrchKey1.sSchStatus = " "
        '                        ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        '                        If ilRet <> BTRV_ERR_END_OF_FILE Then
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                Exit For
        '                            End If
        '                            Call btrExtSetBounds(hmSdf, llNoRec, -1, "UC") 'Set extract limits (all records)
        '                            tlCharTypeBuff.sType = "Y"    'Extract all matching records
        '                            ilOffset = gFieldOffset("Sdf", "SdfBill")
        '                            ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffset, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
        '                            tlCharTypeBuff.sType = "H"    'Extract all non-matching records
        '                            ilOffset = gFieldOffset("Sdf", "SdfSchStatus")
        '                            ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffset, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
        '                            tlIntTypeBuff.iType = tmVsf.iFSCode(ilVsf)  'ilVefCode    'Extract all matching records
        '                            ilOffset = gFieldOffset("Sdf", "SdfVefCode")
        '                            ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_INT, ilOffset, 2, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlIntTypeBuff, 2)
        '                            If (llCalStartDate > 0) And (llStdStartDate > 0) Then
        '                                If llStdStartDate < llCalStartDate Then
        '                                    slDate = smStartStd
        '                                Else
        '                                    slDate = smStartCal
        '                                End If
        '                            ElseIf llCalStartDate > 0 Then
        '                                slDate = smStartCal
        '                            Else
        '                                slDate = smStartStd
        '                            End If
        '                            gPackDate slDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
        '                            ilOffset = gFieldOffset("Sdf", "SdfDate")
        '                            ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffset, 4, BTRV_EXT_GTE, BTRV_EXT_AND, tlDateTypeBuff, 4)
        '                            If (llStdEndDate > 0) And (llCalEndDate > 0) Then
        '                                If llStdEndDate > llCalEndDate Then
        '                                    slDate = smEndStd
        '                                Else
        '                                    slDate = smEndCal
        '                                End If
        '                            ElseIf llCalEndDate > 0 Then
        '                                slDate = smEndCal
        '                            Else
        '                                slDate = smEndStd
        '                            End If
        '                            gPackDate slDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
        '                            ilOffset = gFieldOffset("Sdf", "SdfDate")
        '                            ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffset, 4, BTRV_EXT_LTE, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)
        '
        '                            ilOffset = gFieldOffset("Sdf", "SdfVefCode")
        '                            ilRet = btrExtAddField(hmSdf, ilOffset, 2)  'Extract Name
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                Exit For
        '                            End If
        '                            ilOffset = gFieldOffset("Sdf", "SdfChfCode")
        '                            ilRet = btrExtAddField(hmSdf, ilOffset, 4)  'Extract iCode field
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                Exit For
        '                            End If
        '                            ilOffset = gFieldOffset("Sdf", "SdfLineNo")
        '                            ilRet = btrExtAddField(hmSdf, ilOffset, 2)  'Extract Name
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                Exit For
        '                            End If
        '                            ilOffset = gFieldOffset("Sdf", "SdfDate")
        '                            ilRet = btrExtAddField(hmSdf, ilOffset, 4) 'Extract Variation
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                Exit For
        '                            End If
        '                            ilOffset = gFieldOffset("Sdf", "SdfTime")
        '                            ilRet = btrExtAddField(hmSdf, ilOffset, 4) 'Extract Variation
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                Exit For
        '                            End If
        '                            ilOffset = gFieldOffset("Sdf", "SdfSchStatus")
        '                            ilRet = btrExtAddField(hmSdf, ilOffset, 1) 'Extract Variation
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                Exit For
        '                            End If
        '                            ilOffset = gFieldOffset("Sdf", "SdfTracer")
        '                            ilRet = btrExtAddField(hmSdf, ilOffset, 1) 'Extract Variation
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                Exit For
        '                            End If
        '                            ilOffset = gFieldOffset("Sdf", "SdfLen")
        '                            ilRet = btrExtAddField(hmSdf, ilOffset, 2) 'Extract Variation
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                Exit For
        '                            End If
        '                            ilOffset = gFieldOffset("Sdf", "SdfPriceType")
        '                            ilRet = btrExtAddField(hmSdf, ilOffset, 1) 'Extract Variation
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                Exit For
        '                            End If
        '                            ilOffset = gFieldOffset("Sdf", "SdfSpotType")
        '                            ilRet = btrExtAddField(hmSdf, ilOffset, 1) 'Extract Variation
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                Exit For
        '                            End If
        '                            ilOffset = gFieldOffset("Sdf", "SdfBill")
        '                            ilRet = btrExtAddField(hmSdf, ilOffset, 1) 'Extract Variation
        '                            If ilRet <> BTRV_ERR_NONE Then
        '                                Exit For
        '                            End If
        '                            'ilRet = btrExtGetNextExt(hmSdf)    'Extract record
        '                            ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
        '                            If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
        '                                If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
        '                                    Exit For
        '                                End If
        '                                ilExtLen = 2 + 4 + 2 + 4 + 4 + 1 + 1 + 2 + 1 + 1 + 1'VefCode+ChfCode+LineNo+Date+Time+Status+Tracer+Length+PriceType+SpotType+Bill Len(tmSdfExt(1)) - 4'Extract operation record size
        '                                'ilRet = btrExtGetFirst(hmSdf, tlSdfExt, ilExtLen, llRecPos)
        '                                Do While ilRet = BTRV_ERR_REJECT_COUNT
        '                                    ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
        '                                Loop
        '                                Do While ilRet = BTRV_ERR_NONE
        '                                    ilFound = False
        '                                    Exit Do
        '                                    ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
        '                                    Do While ilRet = BTRV_ERR_REJECT_COUNT
        '                                        ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
        '                                    Loop
        '                                Loop
        '                            End If
        '                            If Not ilFound Then
        '                                Exit For
        '                            End If
        '                        End If
        '                    End If
        '                Next ilVsf
        '                If Not ilFound Then
        '                    Exit For
        '                End If
        '            Next ilVeh
        '        End If
        '    End If
        'End If

    'd.s. 11/6/01
         If ilFound Then
            ReDim tgClfInv(0 To 0) As CLFLIST
            tgClfInv(0).iStatus = -1 'Not Used
            tgClfInv(0).lRecPos = 0
            tgClfInv(0).iFirstCff = -1
            ReDim tgCffInv(0 To 0) As CFFLIST
            tgCffInv(0).iStatus = -1 'Not Used
            tgCffInv(0).lRecPos = 0
            tgCffInv(0).iNextCff = -1
            If Not mReadClfRec() Then
                igInvErrFlag = True
                Print #hmMsg, "Unable to read lines for contract " & Trim$(str$(tgChfInv.lCntrNo))
                ilFound = False
            End If

        End If

        If ilFound And (tgSpf.sInvVehSel = "Y") And (ckcAll.Value = vbUnchecked) Then
            If Not mAllVehSel("C", tgChfInv.lCode) Then
                ilFound = False
            End If
        End If

    Loop While Not ilFound

    mSetExportCntrFlag tgChfInv.iSlfCode(0)
    mSetRemoteCntrFlag

    mReadChfRec = True
    For ilClfIndex = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
        If Not mReadCffRec(ilClfIndex, llStartSortIndex, llEndSortIndex) Then
            mReadChfRec = False
            Exit Function
        End If
    Next ilClfIndex

    'D.S. end
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mReadClfRec                     *
'*                                                     *
'*             Created:8/01/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Read a record                  *
'*                                                     *
'*******************************************************
Private Function mReadClfRec() As Integer
'
'   iRet = mReadClfRec()
'   Where:
'       iRet (O)- True if record read,
'                 False if not read
'
    Dim ilRet As Integer    'Return status
    Dim ilUpperBound As Integer
    Dim ilLoop As Integer
    Dim slStr As String
    'Dim ilRow As Integer
    'Dim ilCol As Integer
    Dim tlClf As CLF
    Dim tlClfExt As CLFEXT    'Contract line extract record
    Dim ilExtLen As Integer
    Dim llNoRec As Long
    Dim llRecPos As Long
    'Dim slNameCode As String
    'Dim slCode As String
    'Dim slLine As String
    'Dim slVersion As String
    Dim ilAddLine As Integer
    'Dim ilIndex As Integer
    Dim ilOffSet As Integer
    Dim ilUpper As Integer
    Dim ilCount As Integer
    Dim ilMaxCount As Integer
    Dim ilBumpVal As Integer
    Dim ilIncludeClf As Integer
    Dim ilVef As Integer


    ilCount = 0
    ilMaxCount = 100
    ilBumpVal = 50
    ReDim tmReadClf(0 To ilMaxCount) As READCLF
    ReDim tgClfInv(0 To 0) As CLFLIST
    ilUpperBound = UBound(tgClfInv)
    tgClfInv(ilUpperBound).iStatus = -1 'Not Used
    tgClfInv(ilUpperBound).lRecPos = 0
    tgClfInv(ilUpperBound).iFirstCff = -1
    'lbcLnCode.Clear
    btrExtClear hmClf   'Clear any previous extend operation
    ilExtLen = Len(tlClfExt)  'Extract operation record size
    tmClfSrchKey.lChfCode = tgChfInv.lCode
    tmClfSrchKey.iLine = 0
    tmClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
    tmClfSrchKey.iPropVer = 32000 ' 0 show latest version
    ilRet = btrGetGreaterOrEqual(hmClf, tlClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    'If (tlClf.lChfCode = tgChfInv.lCode) And (tlClf.sDelete <> "Y") Then
    If (tlClf.lChfCode = tgChfInv.lCode) Then
        llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlAdf) 'Obtain number of records
        Call btrExtSetBounds(hmClf, llNoRec, -1, "UC", "CLFEXTPK", CLFEXTPK) 'Set extract limits (all records)
        ilOffSet = gFieldOffset("Clf", "ClfChfCode")
        ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_INT, ilOffSet, 4, BTRV_EXT_EQUAL, BTRV_EXT_AND, tgChfInv.lCode, 4)
        If ilRet <> BTRV_ERR_NONE Then
            mReadClfRec = False
            Exit Function
        End If
        ilOffSet = gFieldOffset("Clf", "ClfDelete")
        ilRet = btrExtAddLogicConst(hmClf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_NOT_EQUAL, BTRV_EXT_LAST_TERM, ByVal "Y", 1)
        If ilRet <> BTRV_ERR_NONE Then
            mReadClfRec = False
            Exit Function
        End If
        ilOffSet = gFieldOffset("Clf", "ClfChfCode")
        ilRet = btrExtAddField(hmClf, ilOffSet, ilExtLen - 3) 'Extract start/end time, and days
        If ilRet <> BTRV_ERR_NONE Then
            mReadClfRec = False
            Exit Function
        End If
        ilOffSet = gFieldOffset("Clf", "ClfSchStatus")
        ilRet = btrExtAddField(hmClf, ilOffSet, 1) 'Extract start/end time, and days
        If ilRet <> BTRV_ERR_NONE Then
            mReadClfRec = False
            Exit Function
        End If
        ilOffSet = gFieldOffset("Clf", "ClfPropVer")
        ilRet = btrExtAddField(hmClf, ilOffSet, 2) 'Extract start/end time, and days
        If ilRet <> BTRV_ERR_NONE Then
            mReadClfRec = False
            Exit Function
        End If
        'ilRet = btrExtGetNextExt(hmClf)    'Extract record
        ilRet = btrExtGetNext(hmClf, tlClfExt, ilExtLen, llRecPos)
        If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
            'ilRet = btrExtGetFirst(hmClf, tlClfExt, ilExtLen, llRecPos)
            ilExtLen = Len(tlClfExt)  'Extract operation record size
            If ilRet = BTRV_ERR_REJECT_COUNT Then
                ilRet = btrExtGetNext(hmClf, tlClfExt, ilExtLen, llRecPos)
            End If
            Do While ilRet = BTRV_ERR_NONE
                'Only show the latest line
                ilAddLine = True
                'For ilLoop = 0 To lbcLnCode.ListCount - 1 Step 1
                '    slNameCode = lbcLnCode.List(ilLoop)
                '    lmReadClf1 = lmReadClf1 + 2
                '    ilRet = gParseItem(slNameCode, 1, "\", slLine)
                '    ilRet = gParseItem(slNameCode, 2, "\", slVersion)
                '    If tlClfExt.iLine = Val(slLine) Then
                '        If tlClfExt.iCntRevNo > Val(slVersion) Then
                '            lbcLnCode.RemoveItem ilLoop
                '        Else
                '            ilAddLine = False
                '        End If
                '        Exit For
                '    End If
                'Next ilLoop
                For ilLoop = 0 To ilCount - 1 Step 1
                    'slNameCode = lbcLnCode.List(ilLoop)
                    'lmReadClf1 = lmReadClf1 + 2
                    'ilRet = gParseItem(slNameCode, 1, "\", slLine)
                    'ilRet = gParseItem(slNameCode, 2, "\", slVersion)
                    If tlClfExt.iLine = tmReadClf(ilLoop).iLine Then
                        If tlClfExt.iCntRevNo > tmReadClf(ilLoop).iCntRevNo Then
                            tmReadClf(ilLoop).iCntRevNo = tlClfExt.iCntRevNo
                            tmReadClf(ilLoop).lRecPos = llRecPos
                        End If
                        ilAddLine = False
                        Exit For
                    End If
                Next ilLoop
                'If ilAddLine Then
                '    slStr = Trim$(Str$(tlClfExt.iLine))
                '    Do While Len(slStr) < 3
                '        slStr = "0" & slStr
                '    Loop
                '    slStr = slStr & "\" & Trim$(Str$(tlClfExt.iCntRevNo))
                '    slStr = slStr & "\" & Trim$(Str$(llRecPos))
                '    lbcLnCode.AddItem slStr
                'End If
                If ilAddLine Then
                    slStr = Trim$(str$(tlClfExt.iLine))
                    Do While Len(slStr) < 4
                        slStr = "0" & slStr
                    Loop
                    '12/8/15
                    'tmReadClf(2).sKey = slStr
                    tmReadClf(ilCount).sKey = slStr
                    tmReadClf(ilCount).iLine = tlClfExt.iLine
                    tmReadClf(ilCount).iCntRevNo = tlClfExt.iCntRevNo
                    tmReadClf(ilCount).lRecPos = llRecPos
                    ilCount = ilCount + 1
                    If ilCount = ilMaxCount Then
                        ilMaxCount = ilMaxCount + ilBumpVal
                        ReDim Preserve tmReadClf(0 To ilMaxCount)
                    End If
                End If

                ilRet = btrExtGetNext(hmClf, tlClfExt, ilExtLen, llRecPos)
                If ilRet = BTRV_ERR_REJECT_COUNT Then
                    ilRet = btrExtGetNext(hmClf, tlClfExt, ilExtLen, llRecPos)
                End If
            Loop
            btrExtClear hmClf   'Clear any previous extend operation
            ilUpper = ilCount   'UBound(tmReadClf)
            If ilUpper > 0 Then
                ReDim Preserve tmReadClf(0 To ilCount)
                ArraySortTyp fnAV(tmReadClf(), 0), ilUpper, 0, LenB(tmReadClf(0)), 0, LenB(tmReadClf(0).sKey), 0
            End If
            'For ilLoop = 0 To UBound(tmReadClf) - 1 Step 1
            For ilLoop = 0 To ilCount - 1 Step 1
                'slNameCode = lbcLnCode.List(ilLoop)
                'lmReadClf2 = lmReadClf2 + 1
                'ilRet = gParseItem(slNameCode, 3, "\", slCode)
                'slCode = Trim$(slCode)
                'llRecPos = CLng(slCode)
                llRecPos = tmReadClf(ilLoop).lRecPos
                ilRet = btrGetDirect(hmClf, tgClfInv(ilUpperBound).ClfRec, imClfRecLen, llRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                If ilRet <> BTRV_ERR_NONE Then
                    mReadClfRec = False
                    Exit Function
                End If
                ilIncludeClf = True
                ilVef = gBinarySearchVef(tgClfInv(ilUpperBound).ClfRec.iVefCode)
                If ilVef <> -1 Then
                    If tgMVef(ilVef).sType = "R" Then
                        ilIncludeClf = False
                    End If
                End If
                If ilIncludeClf Then
                    tgClfInv(ilUpperBound).iFirstCff = -1
                    tgClfInv(ilUpperBound).lRecPos = llRecPos
                    tgClfInv(ilUpperBound).iStatus = 1 'Old line
                    ilUpperBound = ilUpperBound + 1
                    ReDim Preserve tgClfInv(0 To ilUpperBound) As CLFLIST
                    tgClfInv(ilUpperBound).iStatus = -1 'Not Used
                    tgClfInv(ilUpperBound).iFirstCff = -1
                    tgClfInv(ilUpperBound).lRecPos = 0
                End If
            Next ilLoop
        End If
    End If
    mReadClfRec = True
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mRepInv_ReadRec                 *
'*                                                     *
'*             Created:9/04/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Read item bill records         *
'*                                                     *
'*******************************************************
Function mRepInv_ReadRec() As Integer
'
'   iRet = mRepInv_ReadRec
'   Where:
'       iRet (O)- True if record read,
'                 False if not read
'
    Dim ilRet As Integer    'Return status
    Dim llDate As Long
    Dim slKey As String
    Dim ilLoop As Integer
    Dim ilSLoop As Integer
    Dim ilELoop As Integer
    Dim ilFound As Integer
    Dim ilTest As Integer
    Dim slStartDate As String
    Dim slEndDate As String
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim slDate As String
    Dim ilSbf As Integer
    Dim llChfCode As Long
    Dim llSbfDate As Long

    ReDim tgSbfCntr(0 To 0) As SBFCNTR
    imSbfRecLen = Len(tmSbf)
    If (rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value) Then
        tmSbfSrchKey3.sTranType = "T"
        gPackDate smRepPrintDate, tmSbfSrchKey3.iPostDate(0), tmSbfSrchKey3.iPostDate(1)
        ilRet = btrGetGreaterOrEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Else
        tmSbfSrchKey2.sTranType = "T"
        gPackDate smStartStd, tmSbfSrchKey2.iDate(0), tmSbfSrchKey2.iDate(1)
        ilRet = btrGetGreaterOrEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    End If
    Do While (ilRet = BTRV_ERR_NONE) And (tmSbf.sTranType = "T")
        If tmSbf.sPostStatus = "P" Then
            If (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Undo).Value) Or (rbcType(INVGEN_Archive).Value) Then      '11-15-16 reprint, archvie or undo
                'gUnpackDateLong tmSbf.iDate(0), tmSbf.iDate(1), llDate
                gUnpackDateLongError tmSbf.iDate(0), tmSbf.iDate(1), llDate, "46:mRepInv_ReadRec " & tmSbf.lCode
                If llDate > lmEndStd Then
                    Exit Do
                End If
            End If
            slKey = Trim$(str$(tmSbf.lChfCode))
            Do While Len(slKey) < 8
                slKey = "0" & slKey
            Loop
            tmChfSrchKey.lCode = tmSbf.lChfCode
            ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
            If ilRet = BTRV_ERR_NONE Then
                'Filter out any contract that has advertiser invoice set as External.
                'This should not be required since they can not post spots but added for safety
                'For ilLoop = LBound(tgCommAdf) To UBound(tgCommAdf) - 1 Step 1
                '    If tgChfInv.iAdfCode = tgCommAdf(ilLoop).iCode Then
                    ilLoop = gBinarySearchAdf(tgChfInv.iAdfCode)
                    If ilLoop <> -1 Then
                        If tgCommAdf(ilLoop).sRepInvGen = "E" Then
                            ilRet = Not BTRV_ERR_NONE
                        End If
                '        Exit For
                    End If
                'Next ilLoop
            End If
            For ilLoop = 1 To UBound(lmCPMBypassCntr) - 1 Step 1
                If lmCPMBypassCntr(ilLoop) = tgChfInv.lCode Then
                    ilRet = Not BTRV_ERR_NONE
                    Exit For
                End If
            Next ilLoop
            If ilRet = BTRV_ERR_NONE Then
                gUnpackDate tmSbf.iDate(0), tmSbf.iDate(1), slDate
                If tgChfInv.sBillCycle = "C" Then
                    slStartDate = gObtainStartCal(slDate)
                ElseIf tgChfInv.sBillCycle = "W" Then
                    slStartDate = gObtainPrevMonday(slDate)
                Else
                    slStartDate = gObtainStartStd(slDate)
                End If
                slDate = Trim$(str$(gDateValue(slStartDate)))
                Do While Len(slDate) < 5
                    slDate = "0" & slDate
                Loop
                tgSbfCntr(UBound(tgSbfCntr)).sKey = slKey & "00000000" & slDate
                tgSbfCntr(UBound(tgSbfCntr)).lSDate = Val(slDate)
                If (rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value) Then
                    If tmSbf.sBilled <> "Y" Then
                        tgSbfCntr(UBound(tgSbfCntr)).tSbf = tmSbf
                        ReDim Preserve tgSbfCntr(0 To UBound(tgSbfCntr) + 1) As SBFCNTR
                    End If
                Else
                    If (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Archive).Value) Then            '11-15-16 reprint or archive
                        If tmSbf.sBilled = "Y" Then
                            tgSbfCntr(UBound(tgSbfCntr)).tSbf = tmSbf
                            ReDim Preserve tgSbfCntr(0 To UBound(tgSbfCntr) + 1) As SBFCNTR
                        End If
                    Else
                        tgSbfCntr(UBound(tgSbfCntr)).tSbf = tmSbf
                        ReDim Preserve tgSbfCntr(0 To UBound(tgSbfCntr) + 1) As SBFCNTR
                    End If
                End If
            End If
        End If
        ilRet = btrGetNext(hmSbf, tmSbf, imSbfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    'Sort by Contract and date- process one contract/date at a time
    If UBound(tgSbfCntr) > 0 Then
        ArraySortTyp fnAV(tgSbfCntr(), 0), UBound(tgSbfCntr), 0, LenB(tgSbfCntr(0)), 0, LenB(tgSbfCntr(0).sKey), 0
    End If
    'Gather all other SBF previously posted for new Posted
    If (rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value) Then
        ilSLoop = LBound(tgSbfCntr)
        ilELoop = UBound(tgSbfCntr)
        ilSbf = ilSLoop
        Do While ilSbf <= ilELoop - 1
            llChfCode = tgSbfCntr(ilSbf).tSbf.lChfCode
            llSbfDate = tgSbfCntr(ilSbf).lSDate
            tmChfSrchKey.lCode = llChfCode
            ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
            If ilRet = BTRV_ERR_NONE Then
                gUnpackDate tgSbfCntr(ilSbf).tSbf.iDate(0), tgSbfCntr(ilSbf).tSbf.iDate(1), slDate
                If tgChfInv.sBillCycle = "C" Then
                    slStartDate = gObtainStartCal(slDate)
                    slEndDate = gObtainEndCal(slDate)
                ElseIf tgChfInv.sBillCycle = "W" Then
                    slStartDate = gObtainPrevMonday(slDate)
                    slEndDate = gObtainNextSunday(slDate)
                Else
                    slStartDate = gObtainStartStd(slDate)
                    slEndDate = gObtainEndStd(slDate)
                End If
                llStartDate = gDateValue(slStartDate)
                llEndDate = gDateValue(slEndDate)
                tmSbfSrchKey0.lChfCode = tgSbfCntr(ilSbf).tSbf.lChfCode
                gPackDate slStartDate, tmSbfSrchKey0.iDate(0), tmSbfSrchKey0.iDate(1)
                tmSbfSrchKey0.sTranType = "T"
                ilRet = btrGetGreaterOrEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                Do While (ilRet = BTRV_ERR_NONE) And (tmSbf.lChfCode = tgSbfCntr(ilSbf).tSbf.lChfCode)
                    'gUnpackDateLong tmSbf.iDate(0), tmSbf.iDate(1), llDate
                    gUnpackDateLongError tmSbf.iDate(0), tmSbf.iDate(1), llDate, "47:mRepInv_ReadRec " & tmSbf.lCode
                    If llDate > llEndDate Then
                        Exit Do
                    End If
                    For ilLoop = 1 To UBound(lmCPMBypassCntr) - 1 Step 1
                        If lmCPMBypassCntr(ilLoop) = tmSbf.lChfCode Then
                            tmSbf.sTranType = ""
                            Exit For
                        End If
                    Next ilLoop
                    If (tmSbf.sTranType = "T") And (tmSbf.sPostStatus = "P") Then
                        slKey = Trim$(str$(tmSbf.lChfCode))
                        Do While Len(slKey) < 8
                            slKey = "0" & slKey
                        Loop
                        slDate = Trim$(str$(gDateValue(slStartDate)))
                        Do While Len(slDate) < 5
                            slDate = "0" & slDate
                        Loop
                        tgSbfCntr(UBound(tgSbfCntr)).sKey = slKey & "00000000" & slDate
                        tgSbfCntr(UBound(tgSbfCntr)).lSDate = Val(slDate)
                        If tmSbf.sBilled <> "Y" Then
                            tgSbfCntr(UBound(tgSbfCntr)).tSbf = tmSbf
                            ilFound = False
                            For ilTest = LBound(tgSbfCntr) To UBound(tgSbfCntr) - 1 Step 1
                                If tgSbfCntr(ilTest).tSbf.lCode = tmSbf.lCode Then
                                    ilFound = True
                                    Exit For
                                End If
                            Next ilTest
                            If Not ilFound Then
                                ReDim Preserve tgSbfCntr(0 To UBound(tgSbfCntr) + 1) As SBFCNTR
                            End If
                        End If
                    End If
                    ilRet = btrGetNext(hmSbf, tmSbf, imSbfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop
            End If
            Do
                If (llChfCode <> tgSbfCntr(ilSbf).tSbf.lChfCode) Or (llSbfDate <> tgSbfCntr(ilSbf).lSDate) Then
                    Exit Do
                End If
                ilSbf = ilSbf + 1
            Loop While ilSbf <= ilELoop - 1
        Loop
        If UBound(tgSbfCntr) > 0 Then
            ArraySortTyp fnAV(tgSbfCntr(), 0), UBound(tgSbfCntr), 0, LenB(tgSbfCntr(0)), 0, LenB(tgSbfCntr(0).sKey), 0
        End If
    End If
    mRepInv_ReadRec = True
    Exit Function

    On Error GoTo 0
    mRepInv_ReadRec = False
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mResetFieldsForIvr              *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Create IVR key                 *
'*                                                     *
'*******************************************************
Private Sub mResetFieldsForIvr(llSdfIndex As Long, ilAnyIvr As Integer, ilBonusSpot As Integer, ilEDIFlag As Integer)
    Dim ilLoop As Integer
    Dim slStr As String
    Dim ilPos As Integer
    Dim ilRet As Integer
    Dim ilLen As Integer
    Dim ilMnf As Integer
    Dim ilVef As Integer
    Dim ilStartPos As Integer
    Dim ilEndPos As Integer
    Dim ilInsertIVR As Integer      'd.s. 11/6/01
    Dim ilValue As Integer
    'ReDim slFields(1 To 13) As String
    ReDim slFields(0 To 13) As String   'Index zero ignored
    'tmIvr.lSpotKeyNo = tmIvr.lSpotKeyNo + 1
    'For ilLoop = 1 To 11 Step 1
    '    lmResetIvr1 = lmResetIvr1 + 1
    '    ilRet = gParseItemNoTrim(tgSortKey(llSdfIndex).sKey, ilLoop, "|", slFields(ilLoop))    'Get application name
    'Next ilLoop

    ilStartPos = 1
    'For ilLoop = LBound(slFields) To UBound(slFields) Step 1
    For ilLoop = LBONE To UBound(slFields) Step 1
        ilEndPos = InStr(ilStartPos, tgSortKey(llSdfIndex).sKey, "|", 1)
        If ilEndPos > 0 Then
            slFields(ilLoop) = Mid$(tgSortKey(llSdfIndex).sKey, ilStartPos, ilEndPos - ilStartPos)
            ilStartPos = ilEndPos + 1
        Else
            If ilLoop = UBound(slFields) Then
                slFields(ilLoop) = Mid$(tgSortKey(llSdfIndex).sKey, ilStartPos)
            Else
                slFields(ilLoop) = ""
            End If
        End If
    Next ilLoop

    If Trim$(tgSortKey(llSdfIndex).sAdjAirTime) <> "" Then
        slFields(12) = tgSortKey(llSdfIndex).sAdjAirTime
    End If
    If (tgSpf.sInvAirOrder = "2") And (tgSpf.sBLaserForm = "2") Then
        tmIvr.iType = IVRTYPE_Spot 'Spot/Bonus Spot/Detail Airtime
        tmIvr.iPrgEnfCode = 0
        slStr = UCase$(right$(Trim$(tmIvr.sOVehName), 2))
        If (slStr = " N") Or (slStr = " R") Or (slStr = " S") Then
            tmIvr.sOVehName = Left$(Trim$(tmIvr.sOVehName), Len(Trim$(tmIvr.sOVehName)) - 2)
        End If
        slStr = UCase$(right$(Trim$(tmIvr.sAVehName), 2))
        If (slStr = " N") Or (slStr = " R") Or (slStr = " S") Then
            tmIvr.sAVehName = Left$(Trim$(tmIvr.sAVehName), Len(Trim$(tmIvr.sAVehName)) - 2)
        End If
        slStr = UCase$(right$(Trim$(slFields(9)), 2))
        If (slStr = " N") Or (slStr = " R") Or (slStr = " S") Then
            ilLen = Len(slFields(9))
            slFields(9) = Left$(Trim$(slFields(9)), Len(Trim$(slFields(9))) - 2)
            Do While Len(slFields(9)) < ilLen
                slFields(9) = slFields(9) & " "
            Loop
        End If
        tmIvr.sKey = slFields(1) & slFields(2) & slFields(3) & slFields(4) & "0" & slFields(9) & slFields(11) & slFields(12) & slFields(13)
        smForm2Key = slFields(1) & slFields(2) & slFields(3) & slFields(4)
    'ElseIf (tgSpf.sInvAirOrder = "O") And (tgSpf.sBLaserForm = "2") Then
    ElseIf ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "A")) And (tgSpf.sBLaserForm = "2") Then
        tmIvr.iType = IVRTYPE_Spot 'Spot/Bonus Spot/Detail Airtime
        tmIvr.iPrgEnfCode = 0
        'If market name exist, then add the first 10 characters of market name to vehicle name (combination will only be 40 characters)
        For ilVef = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
            If StrComp(Trim$(tgMVef(ilVef).sName), Trim$(slFields(9)), 1) = 0 Then
                For ilMnf = LBound(tgMkMnf) To UBound(tgMkMnf) - 1 Step 1
                    If tgMVef(ilVef).iMnfVehGp3Mkt = tgMkMnf(ilMnf).iCode Then
                        tmIvr.iPrgEnfCode = tgMkMnf(ilMnf).iCode
                        ilLen = Len(slFields(9))
                        slFields(9) = Left$(Trim$(Left$(tgMkMnf(ilMnf).sName, 10)) & slFields(9), ilLen)
                        Exit For
                    End If
                Next ilMnf
                Exit For
            End If
        Next ilVef
        tmIvr.sKey = slFields(1) & slFields(2) & slFields(3) & slFields(4) & "0" & slFields(9) & slFields(11) & slFields(12) & slFields(13)
        smForm2Key = slFields(1) & slFields(2) & slFields(3) & slFields(4)
    ElseIf tgSpf.sBLaserForm = "3" Then
        mSetPrgEnfCode llSdfIndex
        ilPos = InStr(1, tmIvr.sRRemark, "Missed, MG")
        If ilPos = 1 Then
            tmIvr.sKey = slFields(1) & slFields(2) & slFields(3) & slFields(4) & slFields(8) & slFields(5) & slFields(11) & slFields(12) & slFields(13)
        Else
            tmIvr.sKey = slFields(1) & slFields(2) & slFields(3) & slFields(4) & slFields(8) & slFields(9) & slFields(11) & slFields(12) & slFields(13)
        End If
        smForm2Key = slFields(1) & slFields(2) & slFields(3) & slFields(4)
        'If (ilBonusSpot) Or (tmSdf.sSpotType = "X") Then
        '    tmIvr.iType = IVRTYPE_Bonus
        'Else
            tmIvr.iType = IVRTYPE_Spot 'Spot/Bonus Spot/Detail Airtime
        'End If
        'Change sort  if Missed, MG type spot
    Else
        tmIvr.sKey = slFields(1) & slFields(2) & slFields(3) & slFields(4) & slFields(5) & slFields(6) & slFields(7) & slFields(8) & slFields(9) & slFields(10) & slFields(11) & slFields(12) & slFields(13)
        smForm2Key = slFields(1) & slFields(2) & slFields(3) & slFields(4)
        'If (ilBonusSpot) Or (tmSdf.sSpotType = "X") Then
        '    tmIvr.iType = IVRTYPE_Bonus
        'Else
            tmIvr.iType = IVRTYPE_Spot 'Spot/Bonus Spot/Detail Airtime
        'End If
    End If

    'D.S. 11/6/01
    'Get rid of the convoluted if statement below
    'If ((tgSpf.sBLaserForm <> "2") And (tgSpf.sBLaserForm <> "3")) Or ((tgSpf.sBLaserForm = "2") And (tgSortKey(llSdfIndex).iType = 0) And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Or ((tgSpf.sBLaserForm = "2") And ((ilBonusSpot) Or (tmSdf.sSpotType = "X"))) Or ((tgSpf.sBLaserForm = "3") And ((tgSortKey(llSdfIndex).iType = 0) Or (tgSortKey(llSdfIndex).iType = 1)) And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Or ((tgSpf.sBLaserForm = "3") And ((ilBonusSpot) Or (tmSdf.sSpotType = "X"))) Then
    ilInsertIVR = False
    If (tgSpf.sBLaserForm <> "2") And (tgSpf.sBLaserForm <> "3") Then
        ilInsertIVR = True
    ElseIf tgSpf.sBLaserForm = "2" Then
        If (tgSortKey(llSdfIndex).iType = 0) And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) Then
            ilInsertIVR = True
        ElseIf (ilBonusSpot) Or (tmSdf.sSpotType = "X") Then
            ilInsertIVR = True
        End If
    ElseIf tgSpf.sBLaserForm = "3" Then
        If (ilBonusSpot) Or (tmSdf.sSpotType = "X") Then
            ilInsertIVR = True
        ElseIf ((tgSortKey(llSdfIndex).iType = 0) Or (tgSortKey(llSdfIndex).iType = 1)) And ((tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) Then
            'Include only if associated package line of hidden line is not a virtual vehicle
            If (tmClf.sType = "S") Or (tmClf.sType = "A") Or (tmClf.sType = "E") Then
                ilInsertIVR = True
            Else
                'look at tmSpotClf.iLine and sdf.iLineNo if they match check tmSpotClf.sType is it a "V" if so ok
                ilPos = ilPos
            End If
        ElseIf tgSortKey(llSdfIndex).iType = 2 Then
            'Include if the line is associated with a virtual package
            If tmClf.sType = "O" Then
                ilInsertIVR = True
            Else
                ilPos = ilPos
                'look at tmClf.sType  make sure that its an "A" or an "E"
            End If
        End If
    End If

    '6/18/07:  Set line comment
    mSetClfComment

    '4/7/06-  Handle BBs
    If ilInsertIVR And (tgSpf.sBLaserForm = "1" Or tgSpf.sBLaserForm = "4") And (tgSpf.sUsingBBs = "Y") Then        '3-8-12 treat aired/reconcile version and 3-col aired the same
        If Trim$(tmIvr.sADayDate) <> "" Then    'Not ordered info only, this would happen if no spots found for ordered week
            ilValue = Asc(tgSpf.sOverrideOptions)  'Option Fields in Orders/Proposals
            If (ilValue And BBSAMELINE) = BBSAMELINE Then
                If (tmSdf.sSpotType = "O") Or (tmSdf.sSpotType = "C") Then
                    ilInsertIVR = False
                Else
                    If (Not ilBonusSpot) And (tmSdf.sSpotType <> "X") And (Trim$(tmIvr.sRAmount) = "") Then
                        If (tmClf.iBBOpenLen > 0) Or (tmClf.iBBCloseLen > 0) Then
                            If ((Asc(tgSpf.sUsingFeatures6) And BBCLOSEST) = BBCLOSEST) Then
                                tmIvr.sRAmount = Trim$(str$(tmClf.iBBOpenLen)) & """" & " BB"
                            Else
                                If (tmClf.iBBOpenLen = tmClf.iBBCloseLen) Then
                                    tmIvr.sRAmount = Trim$(str$(tmClf.iBBOpenLen)) & """" & " O/C BB"
                                ElseIf (tmClf.iBBOpenLen > 0) And (tmClf.iBBCloseLen <= 0) Then
                                    tmIvr.sRAmount = Trim$(str$(tmClf.iBBOpenLen)) & """" & " O BB"
                                ElseIf (tmClf.iBBOpenLen <= 0) And (tmClf.iBBCloseLen > 0) Then
                                    tmIvr.sRAmount = Trim$(str$(tmClf.iBBCloseLen)) & """" & " C BB"
                                Else
                                    tmIvr.sRAmount = Trim$(str$(tmClf.iBBOpenLen)) & """" & "/" & Trim$(str$(tmClf.iBBCloseLen)) & """" & " O/C BB"
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
    End If

    'If ilInsertIVR And (Not imExportCntr) Then
    If ilInsertIVR And (Not imExportCntr) And (Not imRemoteCntr) Then
        If (tgSpf.sBLaserForm = "2") Then
            If rbcType(INVGEN_Aff).Value Then
                tmIvr.lSpotKeyNo = tmIvr.lSpotKeyNo + 1
                tmIvr.lCode = 0
                mGetInstallmentCounts tmChf ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
                tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
                tmIvr.iTotalInstallInvs = imTotalInstallInvs
                tmIvr.sInstallCntr = tmChf.sInstallDefined
                ilRet = mInsertIVRandClearDollars(ilEDIFlag, tmIvr)
                ilAnyIvr = True
            End If
        Else
            tmIvr.lSpotKeyNo = tmIvr.lSpotKeyNo + 1
            tmIvr.lCode = 0
            mGetInstallmentCounts tmChf ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
            tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
            tmIvr.iTotalInstallInvs = imTotalInstallInvs
            tmIvr.sInstallCntr = tmChf.sInstallDefined
            ilRet = mInsertIVRandClearDollars(ilEDIFlag, tmIvr)
            If tgSpf.sBLaserForm = "1" Then
                If imCombineAirAndNTR Then
                    'TTP 10517 - Invoices: if "ad server" option is not checked on, and "commercial and NTR" invoices are set to be separate, the air time portion of the invoice does not print
                    If (tmIvr.iType = IVRTYPE_TotalAirtimeRep) Or (tmIvr.iType = IVRTYPE_TotalAdServer) Or (tmIvr.iType = IVRTYPE_TotalNTR) Or (tmIvr.iType = IVRTYPE_TotalInstallment) Or (tmIvr.iType = IVRTYPE_TotalCntr) Then
                        LSet tmImr = tmIvr
                        tmImr.lIvrCode = tmIvr.lCode
                        tmImr.sUnused = ""
                        'ilRet = btrInsert(hmImr, tmImr, imImrRecLen, INDEXKEY0)
                        ilRet = mWriteImr(ilEDIFlag, tmImr)
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            Print #hmMsg, "mResetFieldsForIvr: btrInsert-Point 1, Imr Error # " & Trim$(str$(ilRet))
                        End If
                    End If
                End If
            End If
            ilAnyIvr = True
        End If
    End If
    'D.S. End
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mSdfExtExist                    *
'*                                                     *
'*             Created:5/17/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Determine if Spot previously   *
'*                      store into tgSort              *
'*                                                     *
'*******************************************************
Private Function mSdfExtExist(tlSdfExt As SDFEXT) As Integer
    Dim ilLoop As Integer
    Dim ilRet As Integer
    'Dim llSdfRecPos As Long
    mSdfExtExist = False
    If tlSdfExt.iStatus = 1 Then    'SMF
        'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tlSdfExt.lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
        If tlSdfExt.lCode <> tmSmf.lCode Then
            tmSmfSrchKey1.lCode = tlSdfExt.lCode
            ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        End If
        'tmSdfSrchKey3.lCode = tmSmf.lSdfCode
        'ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        'ilRet = btrGetPosition(hmSdf, llSdfRecPos)
        For ilLoop = LBound(tgSortNoKey) To UBound(tgSortNoKey) - 1 Step 1
            ''If (tgSortNoKey(ilLoop).lRecPos = llSdfRecPos) And (tgSortNoKey(ilLoop).iType = 0) Then  'Sdf already included- bypass
            '10/24/14: Aviod spots changed from type 0 to 3(cross night night spots)
            'If (tgSortNoKey(ilLoop).lCode = tmSmf.lSdfCode) And (tgSortNoKey(ilLoop).iType = 0) Then  'Sdf already included- bypass
            If (tgSortNoKey(ilLoop).lCode = tmSmf.lSdfCode) And ((tgSortNoKey(ilLoop).iType = 0) Or (tgSortNoKey(ilLoop).iType = 3)) Then  'Sdf already included- bypass
                mSdfExtExist = True
                Exit Function
            End If
            ''If (tgSortNoKey(ilLoop).lRecPos = tlSdfExt.lRecPos) And (tgSortNoKey(ilLoop).iType = 1) Then  'Smf already included- bypass
            '10/24/14: Aviod spots changed from type 0 to 3(cross night night spots)
            'If (tgSortNoKey(ilLoop).lCode = tmSmf.lCode) And (tgSortNoKey(ilLoop).iType = 1) Then  'Smf already included- bypass
            If (tgSortNoKey(ilLoop).lCode = tmSmf.lCode) And ((tgSortNoKey(ilLoop).iType = 1) Or (tgSortNoKey(ilLoop).iType = 3)) Then  'Smf already included- bypass
                mSdfExtExist = True
                Exit Function
            End If
        Next ilLoop
        If igUsedISR Then
            gPackDate smGenDate, tmIsrSrchKey1.iGenDate(0), tmIsrSrchKey1.iGenDate(1)
            gPackTime smGenTime, tmIsrSrchKey1.iGenTime(0), tmIsrSrchKey1.iGenTime(1)
            tmIsrSrchKey1.iType = 0
            tmIsrSrchKey1.lCode = tmSmf.lSdfCode
            ilRet = btrGetEqual(hmIsr, tmIsr, imIsrRecLen, tmIsrSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet = BTRV_ERR_NONE Then
                mSdfExtExist = True
                Exit Function
            End If
            gPackDate smGenDate, tmIsrSrchKey1.iGenDate(0), tmIsrSrchKey1.iGenDate(1)
            gPackTime smGenTime, tmIsrSrchKey1.iGenTime(0), tmIsrSrchKey1.iGenTime(1)
            tmIsrSrchKey1.iType = 1
            tmIsrSrchKey1.lCode = tmSmf.lCode
            ilRet = btrGetEqual(hmIsr, tmIsr, imIsrRecLen, tmIsrSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet = BTRV_ERR_NONE Then
                mSdfExtExist = True
                Exit Function
            End If
        End If
    Else
        For ilLoop = LBound(tgSortNoKey) To UBound(tgSortNoKey) - 1 Step 1
            'If (tgSortNoKey(ilLoop).lRecPos = tlSdfExt.lRecPos) And (tgSortNoKey(ilLoop).iType = 0) Then  'Sdf already included- bypass
            If (tgSortNoKey(ilLoop).lCode = tlSdfExt.lCode) And (tgSortNoKey(ilLoop).iType = 0) Then  'Sdf already included- bypass
                mSdfExtExist = True
                Exit Function
            End If
        Next ilLoop
        If igUsedISR Then
            gPackDate smGenDate, tmIsrSrchKey1.iGenDate(0), tmIsrSrchKey1.iGenDate(1)
            gPackTime smGenTime, tmIsrSrchKey1.iGenTime(0), tmIsrSrchKey1.iGenTime(1)
            tmIsrSrchKey1.iType = 0
            tmIsrSrchKey1.lCode = tlSdfExt.lCode
            ilRet = btrGetEqual(hmIsr, tmIsr, imIsrRecLen, tmIsrSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet = BTRV_ERR_NONE Then
                mSdfExtExist = True
                Exit Function
            End If
        End If
    End If
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mSelAdvt                        *
'*                                                     *
'*             Created:9/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Show Advertiser for selection  *
'*                                                     *
'*******************************************************
Private Sub mSelAdvt()
    '''If (lbcDates.ListIndex < 0) Then
    ''If ((lbcDates.ListIndex >= 0) And ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_PrintRep).Value = vbChecked))) Or ((lbcWeek.ListIndex >= 0) And (ckcType(INVTYPE_Installment).Value = vbChecked)) Then
    'If (((lbcDates.ListIndex >= 0) Or (lbcWeek.ListIndex >= 0)) And ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_PrintRep).Value = vbChecked))) Then
    'Else
    'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
    'If ((lbcDates.ListIndex < 0) And (lbcWeek.ListIndex < 0)) Then
    mClearRevenueGrid
    If ((cbcDates.ListIndex < 1) And (cbcWeek.ListIndex < 1)) Then
        'lbcAdvt.Clear
        'pbcLbcAdvt.Cls
        'mClearRevenueGrid
        Exit Sub
    End If
    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    'Build Dates
    mBuildDates
    'mAdvtPop smEndStd, smEndCal
    mAdvtPop lmStartStd, lmEndStd, lmStartCal, lmEndCal, lmStartWk, lmEndWk
    Screen.MousePointer = vbDefault
    gSetMousePointer grdAirTime, grdRevenue, vbDefault
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mSelCntr                        *
'*                                                     *
'*             Created:9/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Show Contracts for selection   *
'*                                                     *
'*******************************************************
Private Sub mSelCntr()
'
'   ilRepARCntr (I)- Find Rep contracts required for A/R generation
'
    Dim slStartDate As String
    Dim slEndDate As String
    Dim slStatus As String
    Dim slCntrType As String
    Dim ilHOType As Integer
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim ilVeh As Integer
    Dim slNameCode As String
    Dim slCode As String
    Dim ilVefCode As Integer
    Dim ilFound As Integer
    Dim ilLoop1 As Integer
    Dim ilChf As Integer
    Dim slName As String
    Dim slNameSort As String
    Dim ilMnf As Integer
    Dim ilTest As Integer
    Dim llRow As Long
    Dim ilAdf As Integer
    Dim ilAgf As Integer
    'TTP 10597 - Ad server/digital show Unposted Digital Contracts in Selective List in RED color
    Dim blDigitalBypass As Boolean
    Dim ilLoop2 As Integer
    Dim ilSlf As Integer
    
    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    If (lmStartStd > 0) Or (lmStartCal > 0) Or (lmStartWk > 0) Then
        'TTP 10960 - Invoice: digital lines will get partially invoiced if final invoices are run before the lines are expired/month is over
        'mCPM_BuildBypassCntr
        mCPM_BuildBypassCntr imFullCal, lmEndCal, imFullWk, lmEndWk, imFullStd, lmEndStd
        'If (lmStartStd > 0) And (lmStartCal > 0) Then
        '    If lmStartStd < lmStartCal Then
        '        slStartDate = Format$(lmStartStd, "m/d/yy")
        '    Else
        '        slStartDate = Format$(lmStartCal, "m/d/yy")
        '    End If
        'ElseIf lmStartStd > 0 Then
        '    slStartDate = Format$(lmStartStd, "m/d/yy")
        'Else
        '    slStartDate = Format$(lmStartCal, "m/d/yy")
        'End If
        slStartDate = ""
        If lmStartStd > 0 Then
            slStartDate = smStartStd
        End If
        If (lmStartCal > 0) And ((lmStartCal < gDateValue(slStartDate)) Or (slStartDate = "")) Then
            '12/15/12
            'slStartDate = smStartCal
            If bmCalBillExist Then
                slStartDate = smStartCal
            End If
        End If
        If (lmStartWk > 0) And ((lmStartWk < gDateValue(slStartDate)) Or (slStartDate = "")) Then
            '12/15/12
            'slStartDate = smStartWk
            If bmWeeklyBillExist Then
                slStartDate = smStartWk
            End If
        End If
        'If (lmEndStd > 0) And (lmEndCal > 0) Then
        '    If lmEndStd > lmEndCal Then
        '        slEndDate = Format$(lmEndStd, "m/d/yy")
        '    Else
        '        slEndDate = Format$(lmEndCal, "m/d/yy")
        '    End If
        'ElseIf lmEndStd > 0 Then
        '    slEndDate = Format$(lmEndStd, "m/d/yy")
        'Else
        '    slEndDate = Format$(lmEndCal, "m/d/yy")
        'End If
        slEndDate = ""
        If lmEndStd > 0 Then
            slEndDate = smEndStd
        End If
        If (lmEndCal > 0) And ((lmEndCal > gDateValue(slEndDate)) Or (slEndDate = "")) Then
            '12/15/12
            'slEndDate = smEndCal
            If bmCalBillExist Then
                slEndDate = smEndCal
            End If
        End If
        If (lmEndWk > 0) And ((lmEndWk > gDateValue(slEndDate)) Or (slEndDate = "")) Then
            '12/15/12
            'slEndDate = smEndWk
            If bmWeeklyBillExist Then
                slEndDate = smEndWk
            End If
        End If
        slStatus = "HO"
        slCntrType = ""
        ilHOType = 1
        sgCntrForDateStamp = ""
        ilRet = gObtainCntrForDate(Invoice, slStartDate, slEndDate, slStatus, slCntrType, ilHOType, tgChfAdvtExt())
    Else
        'ReDim tgChfAdvtExt(1 To 1) As CHFADVTEXT
        ReDim tgChfAdvtExt(0 To 0) As CHFADVTEXT
    End If
    ilRet = gObtainAdvt()
    ilRet = gObtainAgency()
    'lbcCntr.Clear
    'lbcCntrCode.Clear
    bmUnpostedVehicleExist = False
    mClearAirTimeGrid
    Screen.MousePointer = vbHourglass
    'TTP 10476 - Installment NTR invoice reprint: not all NTR items are being included
    grdAirTime.Redraw = False
    ReDim tgSelSort(0 To 0) As SELTYPESORT
    For ilChf = LBound(tgChfAdvtExt) To UBound(tgChfAdvtExt) - 1 Step 1
        'Debug.Print "mSelCntr:" & tgChfAdvtExt(ilChf).lCntrNo & ", " & ilChf & " of " & UBound(tgChfAdvtExt)
        If ((tgChfAdvtExt(ilChf).sBillCycle = "S") And (ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked)) Or ((tgChfAdvtExt(ilChf).sBillCycle = "C") And (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked)) Or ((tgChfAdvtExt(ilChf).sBillCycle = "W") And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked)) Then
            For ilVeh = 0 To lbcVehicle.ListCount - 1 Step 1
                If lbcVehicle.Selected(ilVeh) Then
                    slNameCode = Trim$(tmInvVehicle(ilVeh).sKey) 'Traffic!lbcVehicle.List(ilVeh)
                    ilRet = gParseItem(slNameCode, 2, "\", slCode)
                    ilVefCode = Val(slCode)
                    ilFound = False
                    If tgChfAdvtExt(ilChf).lVefCode > 0 Then
                        If tgChfAdvtExt(ilChf).lVefCode = ilVefCode Then
                            ilFound = True
                        End If
                    ElseIf tgChfAdvtExt(ilChf).lVefCode < 0 Then
                        tmVsfSrchKey.lCode = -tgChfAdvtExt(ilChf).lVefCode
                        ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                        Do While ilRet = BTRV_ERR_NONE
                            For ilLoop = LBound(tmVsf.iFSCode) To UBound(tmVsf.iFSCode) Step 1
                                If tmVsf.iFSCode(ilLoop) > 0 Then
                                    If tmVsf.iFSCode(ilLoop) = ilVefCode Then
                                        ilFound = True
                                        Exit For
                                    End If
                                    If tgChfAdvtExt(ilChf).lVefCode <> tmVef.iCode Then
                                        tmVefSrchKey.iCode = tmVsf.iFSCode(ilLoop)
                                        ilRet = btrGetEqual(hmVef, tmVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                        'On Error GoTo gPopCntrForAASBoxErr
                                        'gCPErrorMsg ilRet, "gPopCntrForAASBox (btrGetEqual: Vef)", Frm
                                        'On Error GoTo 0
                                    End If
                                    If tmVef.sType = "V" Then
                                        If tmVef.iCode <> ilVefCode Then
                                            tmVsfSrchKey.lCode = tmVef.lVsfCode
                                            ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                            For ilLoop1 = LBound(tmVsf.iFSCode) To UBound(tmVsf.iFSCode) Step 1
                                                If tmVsf.iFSCode(ilLoop1) > 0 Then
                                                    If tmVsf.iFSCode(ilLoop1) = ilVefCode Then
                                                        ilFound = True
                                                        Exit For
                                                    End If
                                                End If
                                            Next ilLoop1
                                        Else
                                            ilFound = True
                                        End If
                                    End If
                                    If ilFound Then
                                        Exit For
                                    End If
                                End If
                            Next ilLoop
                            If (ilFound) Or (tmVsf.lLkVsfCode <= 0) Then
                                Exit Do
                            End If
                            tmVsfSrchKey.lCode = tmVsf.lLkVsfCode
                            ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                        Loop
                    End If
                    If ilFound Then
                        'For ilTest = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                        '    If (ilVefCode = tgMVef(ilTest).iCode) Then
                            ilTest = gBinarySearchVef(ilVefCode)
                            If ilTest <> -1 Then
                                For ilMnf = LBound(tgMkMnf) To UBound(tgMkMnf) - 1 Step 1
                                    If tgMVef(ilTest).iMnfVehGp3Mkt = tgMkMnf(ilMnf).iCode Then
                                        If Trim$(tgMkMnf(ilMnf).sRPU) = "Y" Then
                                            ilFound = False
                                            Exit For
                                        End If
                                    End If
                                Next ilMnf
                        '        Exit For
                            End If
                        'Next ilTest
                        If Not ilFound Then
                            Exit For
                        End If
                    End If
                    If ilFound Then
                        tmChf.lCode = tgChfAdvtExt(ilChf).lCode
                        tmChf.iAgfCode = tgChfAdvtExt(ilChf).iAgfCode
                        tmChf.iAdfCode = tgChfAdvtExt(ilChf).iAdfCode
                        tmChf.sType = tgChfAdvtExt(ilChf).sType
                        tmChf.lCntrNo = tgChfAdvtExt(ilChf).lCntrNo
                        tmChf.sBillCycle = tgChfAdvtExt(ilChf).sBillCycle
                        tmChf.iEndDate(0) = tgChfAdvtExt(ilChf).iEndDate(0)
                        tmChf.iEndDate(1) = tgChfAdvtExt(ilChf).iEndDate(1)
                        tmChf.iSlfCode(0) = tgChfAdvtExt(ilChf).iSlfCode(0)
                        mSelCntrSort
                        Exit For
                    End If
                End If
            Next ilVeh
        End If
    Next ilChf
    'Screen.MousePointer = vbDefault
    grdAirTime.Redraw = True
    'Obtain MG or Outside spots that MG dates is within billing date.
    'If (rbcCntr(INVCNTR_Selective).Value) Then
    If bmIncludeMG And (rbcCntr(INVCNTR_Selective).Value) Then
        mSelCntrWithMg slStartDate, slEndDate
    End If
    mVerifyIfCntrPosted
    Screen.MousePointer = vbDefault
    If UBound(tgSelSort) > 0 Then
        'ArraySortTyp fnAV(tgSortKey(),0), ilUpper, 0, LenB(tgSortKey(0)), 0, -9, 0
        ArraySortTyp fnAV(tgSelSort(), 0), UBound(tgSelSort), 0, LenB(tgSelSort(0)), 0, LenB(tgSelSort(0).sKey), 0
    End If
    grdAirTime.Redraw = False
    llRow = grdAirTime.FixedRows
    
    For ilLoop = 0 To UBound(tgSelSort) - 1 Step 1
        'ilRet = gParseItem(tgSelSort(ilLoop).sKey, 2, "|", slName)    'Get application name
        'slNameSort = Trim$(slName) & "/" & Trim$(Str$(tgSelSort(ilLoop).lCntrNo))
        'lbcCntr.AddItem slNameSort
        'lbcCntrCode.AddItem slNameSort & "\" & Trim$(Str$(tgSelSort(ilLoop).lChfCode))
        If tgSelSort(ilLoop).iPosted = False Then
            bmUnpostedVehicleExist = True
        End If
        
        'TTP 10597 - Ad server/digital show Unposted Digital Contracts in Selective List in RED color
        blDigitalBypass = False
        For ilLoop2 = 1 To UBound(lmCPMBypassCntr) - 1 Step 1
            If lmCPMBypassCntr(ilLoop2) = tgSelSort(ilLoop).lChfCode Then
                blDigitalBypass = True
                Exit For
            End If
        Next ilLoop2
        
        'TTP 10597 - Ad server/digital show Unposted Digital Contracts in Selective List in RED color
        'If (tgSelSort(ilLoop).iPosted) Or ((tgSelSort(ilLoop).iPosted = False) And (rbcCntr(INVCNTR_Posted).Value)) Then
        If (tgSelSort(ilLoop).iPosted) Or ((tgSelSort(ilLoop).iPosted = False) And (rbcCntr(INVCNTR_Posted).Value)) Or blDigitalBypass Then
            If llRow >= grdAirTime.rows Then
                grdAirTime.AddItem ""
            End If
            grdAirTime.RowHeight(llRow) = fgBoxGridH + 15
            If tgSelSort(ilLoop).iAgfCode > 0 Then
                ilAgf = gBinarySearchAgf(tgSelSort(ilLoop).iAgfCode)
                If ilAgf <> -1 Then
                    grdAirTime.TextMatrix(llRow, ATBILLINDEX) = Trim$(tgCommAgf(ilAgf).sName) & "/" & Trim$(tgCommAgf(ilAgf).sCityID)
                End If
            Else
                grdAirTime.TextMatrix(llRow, ATBILLINDEX) = "Direct"
            End If
            ilAdf = gBinarySearchAdf(tgSelSort(ilLoop).iAdfCode)
            If ilAdf <> -1 Then
                grdAirTime.TextMatrix(llRow, ATADVTINDEX) = Trim$(tgCommAdf(ilAdf).sName)
            End If
            'TTP 10813 - PDF invoice - selective invoice feature checklist
            ilSlf = gBinarySearchSlf(tgSelSort(ilLoop).iSlfCode)
            If ilSlf <> -1 Then
                grdAirTime.TextMatrix(llRow, ATSPERSONINDEX) = Trim$(tgMSlf(ilSlf).sLastName) & ", " & Trim$(tgMSlf(ilSlf).sFirstName)
            End If
            grdAirTime.TextMatrix(llRow, ATCNTRNOINDEX) = Trim$(str$(tgSelSort(ilLoop).lCntrNo))
            Select Case tgSelSort(ilLoop).sBillCycle
                Case "C"
                    grdAirTime.TextMatrix(llRow, ATCYCLEINDEX) = "Calendar"
                Case "W"
                    grdAirTime.TextMatrix(llRow, ATCYCLEINDEX) = "Weekly"
                Case Else
                    grdAirTime.TextMatrix(llRow, ATCYCLEINDEX) = "Std B'cast"
            End Select
            grdAirTime.TextMatrix(llRow, ATENDDATEINDEX) = Trim$(tgSelSort(ilLoop).sEndDate)
            ilRet = gParseItem(tgSelSort(ilLoop).sKey, 1, "|", slNameSort)    'Get application name
            grdAirTime.TextMatrix(llRow, ATNAMESORTINDEX) = Trim$(slNameSort)
            grdAirTime.TextMatrix(llRow, ATCHFCODEINDEX) = Trim$(str$(tgSelSort(ilLoop).lChfCode))
            If tgSelSort(ilLoop).iPosted Then
                grdAirTime.TextMatrix(llRow, ATSELECTEDINDEX) = "0"
            Else
                grdAirTime.TextMatrix(llRow, ATSELECTEDINDEX) = "-1"
                mPaintAirTimeRowColor llRow
            End If
            llRow = llRow + 1
        End If
    Next ilLoop
    'lbcCntr.Enabled = True
    grdAirTime.Redraw = True
    Screen.MousePointer = vbDefault
    gSetMousePointer grdAirTime, grdRevenue, vbDefault
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mSelCntrWithMG                  *
'*                                                     *
'*             Created:9/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Show Contracts for selection   *
'*                      which have MGs or Outsides     *
'*                                                     *
'*******************************************************
Private Sub mSelCntrWithMg(slStartDate As String, slEndDate As String)
    Dim ilVeh As Integer
    Dim slNameCode As String
    Dim slCode As String
    Dim ilVefCode As Integer
    Dim ilRet As Integer
    'Dim ilPass As Integer
    Dim ilLoop As Integer
    Dim ilExtLen As Integer
    Dim llNoRec As Long
    'Dim slSchStatus As String
    'Dim llRecPos As Long        'Record location
    Dim ilOffSet As Integer
    Dim ilIncludeSpot As Integer
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
    Dim tlDateTypeBuff As POPDATETYPE   'Type field record
    'Dim tlLTypeBuff As POPLCODE   'Type field record
    Dim tlIntTypeBuff As POPINTEGERTYPE   'Type field record
    Dim tlSdfExt As SDFEXT
    Dim ilMnf As Integer
    Dim ilTest As Integer
    Dim ilFound As Integer
    Dim llMidDate As Long

    If slStartDate = "" Then
        Exit Sub
    End If
    For ilVeh = 0 To lbcVehicle.ListCount - 1 Step 1
        If lbcVehicle.Selected(ilVeh) Then
            slNameCode = Trim$(tmInvVehicle(ilVeh).sKey) 'Traffic!lbcVehicle.List(ilVeh)
            ilRet = gParseItem(slNameCode, 2, "\", slCode)
            ilVefCode = Val(slCode)
            ilFound = True
            'For ilTest = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
            '    If (ilVefCode = tgMVef(ilTest).iCode) Then
                ilTest = gBinarySearchVef(ilVefCode)
                If ilTest <> -1 Then
                    For ilMnf = LBound(tgMkMnf) To UBound(tgMkMnf) - 1 Step 1
                        If tgMVef(ilTest).iMnfVehGp3Mkt = tgMkMnf(ilMnf).iCode Then
                            If Trim$(tgMkMnf(ilMnf).sRPU) = "Y" Then
                                ilFound = False
                                Exit For
                            End If
                        End If
                    Next ilMnf
            '        Exit For
                End If
            'Next ilTest
            If ilFound Then
            'For ilPass = 0 To 1 Step 1
            '    If ilPass = 0 Then
            '        slSchStatus = "G"
            '    Else
            '        slSchStatus = "O"
            '    End If
                ilExtLen = 2 + 4 + 2 + 4 + 4 + 1 + 1 + 2 + 1 + 1 + 1 + 2 + 2 + 1 + 4 'VefCode+ChfCode+LineNo+Date+Time+Status+Tracer+Length+PriceType+SpotType+Bill+Adf+GameNo+Midnight+Code Len(tmSdfExt(1)) - 4'Extract operation record size
                llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hmSdf) 'Obtain number of records
                btrExtClear hmSdf   'Clear any previous extend operation
                tmSdfSrchKey1.iVefCode = ilVefCode
                '5/22/14: Check spots that cross night and are to be billing in current period
                If (imXMidHandle <> 2) Then
                    gPackDate slStartDate, tmSdfSrchKey1.iDate(0), tmSdfSrchKey1.iDate(1)
                Else
                    gPackDate gDecOneDay(slStartDate), tmSdfSrchKey1.iDate(0), tmSdfSrchKey1.iDate(1)
                End If
                tmSdfSrchKey1.iTime(0) = 0
                tmSdfSrchKey1.iTime(1) = 0
                tmSdfSrchKey1.sSchStatus = ""   'slSchStatus
                ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                If ilRet = BTRV_ERR_NONE Then
                    Call btrExtSetBounds(hmSdf, llNoRec, -1, "UC", "SDFEXTPK", SDFEXTPK) 'Set extract limits (all records)
                    tlCharTypeBuff.sType = "N"    'Extract all matching records
                    ilOffSet = gFieldOffset("Sdf", "SdfBill")
                    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
            '        tlCharTypeBuff.sType = slSchStatus    'Extract all non-matching records
            '        ilOffset = gFieldOffset("Sdf", "SdfSchStatus")
            '        ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_STRING, ilOffset, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
                    tlIntTypeBuff.iType = ilVefCode    'Extract all matching records
                    ilOffSet = gFieldOffset("Sdf", "SdfVefCode")
                    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_INT, ilOffSet, 2, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlIntTypeBuff, 2)
                    '5/22/14: Check spots that cross night and are to be billing in current period
                    'gPackDate slStartDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
                    If (imXMidHandle <> 2) Then
                        gPackDate slStartDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
                    Else
                        gPackDate gDecOneDay(slStartDate), tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfDate")
                    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_GTE, BTRV_EXT_AND, tlDateTypeBuff, 4)
                    gPackDate slEndDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
                    ilOffSet = gFieldOffset("Sdf", "SdfDate")
                    ilRet = btrExtAddLogicConst(hmSdf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_LTE, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)

                    ilOffSet = gFieldOffset("Sdf", "SdfVefCode")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 2)  'Extract Name
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfChfCode")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 4)  'Extract iCode field
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfLineNo")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 2)  'Extract Name
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfDate")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 4) 'Extract Variation
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfTime")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 4) 'Extract Variation
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfSchStatus")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfTracer")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfLen")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 2) 'Extract Variation
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfPriceType")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfSpotType")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfBill")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfAdfCode")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 2) 'Extract Variation
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    ilOffSet = gFieldOffset("Sdf", "SdfGameNo")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 2) 'Extract Variation
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    
                    '5/22/14: Add Cross Midnight
                    ilOffSet = gFieldOffset("Sdf", "SdfXCrossMidnight")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 1) 'Extract Variation
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    
                    ilOffSet = gFieldOffset("Sdf", "SdfCode")
                    ilRet = btrExtAddField(hmSdf, ilOffSet, 4) 'Extract Variation
                    If ilRet <> BTRV_ERR_NONE Then
                        Exit Sub
                    End If
                    'ilRet = btrExtGetNextExt(hmSdf)    'Extract record
                    ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
                    If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
                        If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                            Exit Sub
                        End If
                        ilExtLen = 2 + 4 + 2 + 4 + 4 + 1 + 1 + 2 + 1 + 1 + 1 + 2 + 2 + 1 + 4 'VefCode+ChfCode+LineNo+Date+Time+Status+Tracer+Length+PriceType+SpotType+Bill+Adf+GameNo+Midnight+Code Len(tmSdfExt(1)) - 4'Extract operation record size
                        'ilRet = btrExtGetFirst(hmSdf, tlSdfExt, ilExtLen, llRecPos)
                        Do While ilRet = BTRV_ERR_REJECT_COUNT
                            ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
                        Loop
                        ReDim tgSdfExtIn(0 To 0) As SORTSDFEXT
                        Do While ilRet = BTRV_ERR_NONE
                            'Check that spot has not been include (G and O spots)
                            '5/22/14: Gather spots that aired cross midnight
                            ilIncludeSpot = False
                            If (imXMidHandle = 2) Then
                                gUnpackDateLong tlSdfExt.iDate(0), tlSdfExt.iDate(1), llMidDate
                                If tlSdfExt.sXCrossMidnight = "Y" Then
                                    If llMidDate + 1 = gDateValue(slStartDate) Then
                                        ilIncludeSpot = True
                                    End If
                                End If
                            End If
                            'If (tlSdfExt.sSchStatus = "G") Or (tlSdfExt.sSchStatus = "O") Then
                            If (tlSdfExt.sSchStatus = "G") Or (tlSdfExt.sSchStatus = "O") Or ilIncludeSpot Then
                                ilIncludeSpot = True
                                For ilLoop = 0 To UBound(tgSelSort) - 1 Step 1
                                    If tgSelSort(ilLoop).lChfCode = tlSdfExt.lChfCode Then
                                        ilIncludeSpot = False
                                        Exit For
                                    End If
                                Next ilLoop
                            Else
                                ilIncludeSpot = False
                            End If
                            If ilIncludeSpot Then
                                tmChfSrchKey.lCode = tlSdfExt.lChfCode
                                ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                If ilRet = BTRV_ERR_NONE Then
                                    mSelCntrSort
                                End If
                            End If
                            ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
                            Do While ilRet = BTRV_ERR_REJECT_COUNT
                                ilRet = btrExtGetNext(hmSdf, tlSdfExt, ilExtLen, tlSdfExt.lRecPos)
                            Loop
                        Loop
                    End If
                End If
            'Next ilPass
            End If
        End If
    Next ilVeh
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mSetExportCntrFlag              *
'*                                                     *
'*             Created:5/17/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Set Contract Export flag       *
'*                                                     *
'*******************************************************
Sub mSetExportCntrFlag(ilSlfCode As Integer)
    Dim ilRet As Integer
    Dim ilSSMnf As Integer

    imExportCntr = False
    If rbcType(INVGEN_Aff).Value Then    'Affidavit
        Exit Sub
    End If
    If imGenCntrExport = False Then
        Exit Sub
    End If
    If ilSlfCode <> tmSlf.iCode Then
        tmSlfSrchKey.iCode = ilSlfCode
        ilRet = btrGetEqual(hmSlf, tmSlf, imSlfRecLen, tmSlfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_NONE Then
            Exit Sub
        End If
    End If
    If tmSlf.iSofCode > 0 Then
        If tmSlf.iSofCode <> tmSof.iCode Then
            tmSofSrchKey.iCode = tmSlf.iSofCode
            ilRet = btrGetEqual(hmSof, tmSof, imSofRecLen, tmSofSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                Exit Sub
            End If
        End If
    End If
    If tmSof.iMnfSSCode > 0 Then
        For ilSSMnf = LBound(tgSSMnf) To UBound(tgSSMnf) - 1 Step 1
            If tmSof.iMnfSSCode = tgSSMnf(ilSSMnf).iCode Then
                If Trim$(tgSSMnf(ilSSMnf).sUnitType) = "E" Then
                    imExportCntr = True
                ElseIf Trim$(tgSSMnf(ilSSMnf).sUnitType) = "F" Then
                    imExportCntr = True
                ElseIf Trim$(tgSSMnf(ilSSMnf).sUnitType) = "A" Then
                    'Look at each Line and check vehicle sales source
                End If
                Exit For
            End If
        Next ilSSMnf
    End If

End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mSetPasses                      *
'*                                                     *
'*             Created:5/17/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Determine number of passes     *
'*                                                     *
'*******************************************************
Private Sub mSetPasses(slPctTrade As String, ilStartPass As Integer, ilEndPass As Integer)
    Dim ilLoop As Integer
    'gPDNToStr tmChf.sPctTrade, 0, slPctTrade
    slPctTrade = gIntToStrDec(tmChf.iPctTrade, 0)
    If tmChf.iPctTrade = 100 Then
        ilStartPass = 2
        ilEndPass = 2
    ElseIf tmChf.iPctTrade = 0 Then
        ilStartPass = 1
        ilEndPass = 1
    Else
        If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then     '11-15-16 archive, Reprint, determine pass numbers (1 for Cash, 2 for Trade)
            ilStartPass = 2 'Assume only trade
            For ilLoop = 0 To UBound(tmRPInfo) - 1 Step 1
                If (tmRPInfo(ilLoop).lCntrNo = tmChf.lCntrNo) And (tmRPInfo(ilLoop).sCashTrade = "C") And ((tmRPInfo(ilLoop).iMnfItem = 0) Or (tmRPInfo(ilLoop).iMnfItem = -1)) Then
                    ilStartPass = 1
                    Exit For
                End If
            Next ilLoop
            ilEndPass = 1
            For ilLoop = 0 To UBound(tmRPInfo) - 1 Step 1
                If (tmRPInfo(ilLoop).lCntrNo = tmChf.lCntrNo) And (tmRPInfo(ilLoop).sCashTrade = "T") And ((tmRPInfo(ilLoop).iMnfItem = 0) Or (tmRPInfo(ilLoop).iMnfItem = -1)) Then
                    ilEndPass = 2
                    Exit For
                End If
            Next ilLoop
        Else
            ilStartPass = 1
            ilEndPass = 2
        End If
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mSetPrgEnfCode                  *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Get Program Event Name Code    *
'*                                                     *
'*******************************************************
Private Sub mSetPrgEnfCode(llSdfIndex As Long)
    Dim llTime As Long
    Dim ilType As Integer       '10-31-01
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim llSTime As Long
    Dim llETime As Long
    Dim slStartTime As String
    Dim slStr As String
    Dim slSTime As String
    Dim slETime As String
    Dim slXMid As String

    tmIvr.iPrgEnfCode = 0
    If (tgSpf.sBLaserForm = "3") And (tgSortKey(llSdfIndex).iType = 0) Then
        If (tmSdf.sSchStatus = "S") Or (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
            gUnpackTimeLong tmSdf.iTime(0), tmSdf.iTime(1), False, llTime
            ''slType = "O"
            '11/24/12
            'ilType = 0          '10-31-01
            ilType = tmSdf.iGameNo
            imSsfRecLen = Len(tmSsf) 'Max size of variable length record
            tmSsfSrchKey.iType = ilType '10-31-01
            tmSsfSrchKey.iVefCode = tmSdf.iVefCode  'ilVefCode
            tmSsfSrchKey.iDate(0) = tmSdf.iDate(0)  'ilLogDate0
            tmSsfSrchKey.iDate(1) = tmSdf.iDate(1)  'ilLogDate1
            tmSsfSrchKey.iStartTime(0) = 0
            tmSsfSrchKey.iStartTime(1) = 0
            '10-31-01 If (tmSsf.sType <> slType) Or (tmSsf.iVefcode <> tmSdf.iVefcode) Or (tmSsf.iDate(0) <> tmSdf.iDate(0)) Or (tmSsf.iDate(1) <> tmSdf.iDate(1)) Or (tmSsf.iStartTime(0) <> 0) Or (tmSsf.iStartTime(1) <> 0) Then
            If (tmSsf.iType <> ilType) Or (tmSsf.iVefCode <> tmSdf.iVefCode) Or (tmSsf.iDate(0) <> tmSdf.iDate(0)) Or (tmSsf.iDate(1) <> tmSdf.iDate(1)) Or (tmSsf.iStartTime(0) <> 0) Or (tmSsf.iStartTime(1) <> 0) Then
                ilRet = gSSFGetGreaterOrEqual(hmSsf, tmSsf, imSsfRecLen, tmSsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get last current record to obtain date
            Else
                ilRet = BTRV_ERR_NONE
            End If
            '10-31-01 Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.sType = slType) And (tmSsf.iVefcode = tmSdf.iVefcode) And (tmSsf.iDate(0) = tmSdf.iDate(0)) And (tmSsf.iDate(1) = tmSdf.iDate(1))
            Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.iType = ilType) And (tmSsf.iVefCode = tmSdf.iVefCode) And (tmSsf.iDate(0) = tmSdf.iDate(0)) And (tmSsf.iDate(1) = tmSdf.iDate(1))
                For ilLoop = 1 To tmSsf.iCount Step 1
                   LSet tmProg = tmSsf.tPas(ilLoop + ADJSSFPASBZ)
                    If ((tmProg.iRecType And &HF) = 1) Then
                        gUnpackTimeLong tmProg.iStartTime(0), tmProg.iStartTime(1), False, llSTime
                        gUnpackTimeLong tmProg.iEndTime(0), tmProg.iEndTime(1), True, llETime
                        If (llTime >= llSTime) And (llTime < llETime) Then
                            gUnpackTime tmProg.iStartTime(0), tmProg.iStartTime(1), "A", "1", slStartTime
                            tmLefSrchKey.lLvfCode = tmProg.lLvfCode
                            tmLefSrchKey.iStartTime(0) = 0
                            tmLefSrchKey.iStartTime(1) = 0
                            tmLefSrchKey.iSeqNo = 0
                            ilRet = btrGetGreaterOrEqual(hmLef, tmLef, imLefRecLen, tmLefSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                            Do While (ilRet = BTRV_ERR_NONE) And (tmLef.lLvfCode = tmProg.lLvfCode)
                                If tmLef.iEtfCode = 1 Then
                                    gUnpackLength tmLef.iStartTime(0), tmLef.iStartTime(1), "3", False, slStr
                                    gAddTimeLength slStartTime, slStr, "A", "1", slSTime, slXMid
                                    llSTime = gTimeToLong(slSTime, False)
                                    gUnpackLength tmLef.iLen(0), tmLef.iLen(1), "3", False, slStr
                                    gAddTimeLength slSTime, slStr, "A", "1", slETime, slXMid
                                    llETime = gTimeToLong(slETime, True)
                                    If (llTime >= llSTime) And (llTime < llETime) Then
                                        tmIvr.iPrgEnfCode = tmLef.iEnfCode
                                    End If
                                End If
                                ilRet = btrGetNext(hmLef, tmLef, imLefRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                            Loop
                            Exit Do
                        End If
                    End If
                Next ilLoop
                imSsfRecLen = Len(tmSsf) 'Max size of variable length record
                ilRet = gSSFGetNext(hmSsf, tmSsf, imSsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
        End If
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mSetRemoteCntrFlag              *
'*                                                     *
'*             Created:5/17/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Set Contract Remote flag       *
'*                                                     *
'*******************************************************
Sub mSetRemoteCntrFlag()
    Dim ilClf As Integer
    Dim ilVeh As Integer
    Dim ilMnf As Integer

    imRemoteCntr = False
    If UBound(tmMktCode) <= 0 Then
        Exit Sub
    End If
    For ilClf = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
        tmClf = tgClfInv(ilClf).ClfRec
        If (tmClf.sType = "S") Or (tmClf.sType = "H") Then
            'For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
            '    If (tmClf.iVefCode = tgMVef(ilVeh).iCode) Then
                ilVeh = gBinarySearchVef(tmClf.iVefCode)
                If ilVeh <> -1 Then
                    For ilMnf = LBound(tgMkMnf) To UBound(tgMkMnf) - 1 Step 1
                        If tgMVef(ilVeh).iMnfVehGp3Mkt = tgMkMnf(ilMnf).iCode Then
                            If Trim$(tgMkMnf(ilMnf).sRPU) = "Y" Then
                                imRemoteCntr = True
                                Exit Sub
                            End If
                        End If
                    Next ilMnf
            '        Exit For
                End If
            'Next ilVeh
        End If
    Next ilClf
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mShowMGVehicle                  *
'*                                                     *
'*             Created:9/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Show MG Vehicle                *
'*                                                     *
'*******************************************************
Private Sub mShowMGVehicle(llSdfIndex As Long, ilMGVehShown As Integer, tlVef As VEF)
    Dim slNameCode As String
    Dim slStr As String
    Dim ilRet As Integer

    ilMGVehShown = False
    If ((tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") And ((tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Or ((tgSpf.sBLaserForm = "2") And ((tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O"))) Then
        If tmSmf.sMGSource = "A" Then
            ilMGVehShown = True
            tmVefSrchKey.iCode = tmSdf.iVefCode 'tmVsf.iFSCode(ilVsf)   'ilVefCode
            If tmVefSrchKey.iCode <> tlVef.iCode Then
                ilRet = btrGetEqual(hmVef, tlVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            End If
            If (tmSdf.sSchStatus = "O") Then
                tmIvr.sAVehName = Trim$(tlVef.sName)
            Else
                slStr = "on " & Trim$(tlVef.sName)
                If Trim$(tmIvr.sRRemark) <> "" Then
                    tmIvr.sRRemark = Trim$(tmIvr.sRRemark) & " " & RTrim$(slStr)
                Else
                    tmIvr.sRRemark = RTrim$(slStr)
                End If
                tmIvr.sAVehName = Trim$(tlVef.sName)
            End If
        'ElseIf ((tmSdf.sSpotType = "X") And (tmClf.sType = "O")) Or ((tmSdf.sSpotType = "X") And (tmVef.sType = "V") And ((imVirtBillMethod = 2) Or (imVirtBillMethod = 3))) Then
        ElseIf ((tmSdf.sSpotType = "X") And (tmVef.sType = "V") And ((imVirtBillMethod = 2) Or (imVirtBillMethod = 3))) Then
            ilMGVehShown = True
            tmVefSrchKey.iCode = tmSdf.iVefCode 'tmVsf.iFSCode(ilVsf)   'ilVefCode
            If tmVefSrchKey.iCode <> tlVef.iCode Then
                ilRet = btrGetEqual(hmVef, tlVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            End If
            tmIvr.sAVehName = Trim$(tlVef.sName)
        End If
    'ElseIf ((tmSdf.sSpotType = "X") And (tmClf.sType = "O")) Or ((tmSdf.sSpotType = "X") And (tmVef.sType = "V") And ((imVirtBillMethod = 2) Or (imVirtBillMethod = 3))) Then
    ElseIf ((tmSdf.sSpotType = "X") And (tmVef.sType = "V") And ((imVirtBillMethod = 2) Or (imVirtBillMethod = 3))) Then
        ilMGVehShown = True
        tmVefSrchKey.iCode = tmSdf.iVefCode 'tmVsf.iFSCode(ilVsf)   'ilVefCode
        If tmVefSrchKey.iCode <> tlVef.iCode Then
            ilRet = btrGetEqual(hmVef, tlVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        End If
        tmIvr.sAVehName = Trim$(tlVef.sName)
    ElseIf ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) And (tmSdf.sSpotType = "X") And ((tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O")) Then
        If tmSmf.sMGSource = "A" Then
            ilMGVehShown = True
            tmVefSrchKey.iCode = tmSdf.iVefCode 'tmVsf.iFSCode(ilVsf)   'ilVefCode
            If tmVefSrchKey.iCode <> tlVef.iCode Then
                ilRet = btrGetEqual(hmVef, tlVef, imVefRecLen, tmVefSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            End If
            tmIvr.sAVehName = Trim$(tlVef.sName)
        End If
    End If
    If (Not ilMGVehShown) And ((tmClf.sType = "A") Or ((tmClf.sType = "E") And (tgSpf.sInvAirOrder = "2"))) Then
        ilRet = gParseItem(tgSortKey(llSdfIndex).sKey, 5, "|", slNameCode) 'Ordered vehicle
        'ilRet = gParseItem(tgSortKey(llSdfIndex).sKey, 9, "|", slStr) 'Aired
        slStr = Trim$(tmSpeedSortParse(llSdfIndex).sVehName)

        If StrComp(Trim$(slNameCode), Trim$(slStr), 1) <> 0 Then
            ilMGVehShown = True
            tmIvr.sAVehName = Trim$(slStr)
        End If
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mTerminate                      *
'*                                                     *
'*             Created:5/18/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: terminate form                 *
'*                                                     *
'*******************************************************
Private Sub mTerminate()
'
'   mTerminate
'   Where:
'
    Dim ilRet As Integer

    On Error Resume Next

    ilRet = gDeleteLockRec_ByRlfCode(hmRlf, lmLockRecCode)

    Screen.MousePointer = vbDefault
    gSetMousePointer grdAirTime, grdRevenue, vbDefault
    'Unload IconTraf
    igManUnload = YES
    Unload Invoice
    igManUnload = NO
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mTestSdfExt                     *
'*                                                     *
'*             Created:9/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Test if spots should be        *
'*                      invoiced and create sort record*
'*                                                     *
'*******************************************************
Private Function mTestSdfExt(ilTestType As Integer, ilTestBilled As Integer, tlSdfExt As SDFEXT, slUnbilled As String, llStdStartDate As Long, llStdEndDate As Long, llCalStartDate As Long, llCalEndDate As Long, llWkStartDate As Long, llWkEndDate As Long, llBaseDate As Long, ilUpper As Integer, llLastUnbilledDate As Long, ilTestDupl As Integer) As Integer
'   Where:
'       ilTestType(I)- 0=Spots straight from SDF; 1=Not Used was for MG or Outside spot (called by mGetAnyVehSpots)
    Dim ilLoop As Integer
    Dim ilRet As Integer
    Dim slDate As String
    Dim llDate As Long
    Dim ilIncludeSpot As Integer
    Dim slNameCode As String
    Dim ilVeh As Integer
    Dim ilVefCode As Integer
    Dim tlClf As CLF
    If ilTestBilled > 0 Then
        mTestSdfExt = False    'Set as if all spots billed
    Else
        mTestSdfExt = True
    End If
    ilIncludeSpot = True
    If ilTestBilled > 0 Then
        'Ignore Missed spots
        If ((tlSdfExt.sSchStatus = "S") Or (tlSdfExt.sSchStatus = "G") Or (tlSdfExt.sSchStatus = "O")) Or ((((tgSpf.sInvAirOrder = "O") And (tgSpf.sBLaserForm <> "2")) Or (tgSpf.sInvAirOrder = "S")) And ((tmSdf.sSchStatus = "M") Or (tmSdf.sSchStatus = "U") Or (tmSdf.sSchStatus = "R"))) Then
            If tmChf.lCode <> tlSdfExt.lChfCode Then
                tmChfSrchKey.lCode = tlSdfExt.lChfCode
                ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                If ilRet <> BTRV_ERR_NONE Then
                    mTestSdfExt = True
                    lbcUnbilled.AddItem slUnbilled & "GetEqual Error, #" & str$(ilRet)
                    'Screen.MousePointer = vbDefault
                    Exit Function
                End If
            End If
            If tmChf.sBillCycle = "C" Then
                If ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbUnchecked Then
                    Exit Function
                End If
                If Not imFullCal Then
                    gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                    If gDateValue(slDate) > llCalEndDate Then
                        Exit Function
                    End If
                End If
            ElseIf tmChf.sBillCycle = "W" Then
                If ckcBillCycle(INVBILLCYCLE_Week).Value = vbUnchecked Then
                    Exit Function
                End If
                If Not imFullWk Then
                    gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                    If gDateValue(slDate) > llWkEndDate Then
                        Exit Function
                    End If
                End If
            Else
                If ckcBillCycle(INVBILLCYCLE_STD).Value = vbUnchecked Then
                    Exit Function
                End If
                If Not imFullStd Then
                    gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                    If gDateValue(slDate) > llStdEndDate Then
                        Exit Function
                    End If
                End If
            End If
            If (tmChf.sType <> "S") And (tmChf.sType <> "M") And (tmChf.sType <> "V") Then
                If (tmChf.lCode <> tmClf.lChfCode) Or (tlSdfExt.iLineNo <> tmClf.iLine) Then
                    tmClfSrchKey.lChfCode = tmChf.lCode
                    tmClfSrchKey.iLine = tlSdfExt.iLineNo
                    tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
                    tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
                    ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                End If
                If (tmClf.lChfCode = tmChf.lCode) And (tmClf.iLine = tlSdfExt.iLineNo) Then
                    ilIncludeSpot = True
                    'Test if any virtual vehicles defined- if not bypass test (all vehicles)
                    'This test is used to determine if spot belongs to vehicle for which
                    'spots are being gathered.
                    If ilTestType = 0 Then
                        'D.S. 8/31/01
                        'If UBound(igVirtVefCode) > LBound(igVirtVefCode) Then
                        If (UBound(igVirtVefCode) > LBound(igVirtVefCode)) And (Not ckcAll.Value = vbChecked) Then  '10-31-01
                            If tmVef.iCode <> tmClf.iVefCode Then
                                ilIncludeSpot = False
                            End If
                        End If
                    Else
                        ilIncludeSpot = False
                        For ilVeh = 0 To UBound(tgInvVehCode) - 1 Step 1 'lbcVehicle.ListCount - 1 Step 1
                            slNameCode = Trim$(tgInvVehCode(ilVeh).sKey)    'Traffic!lbcVehicle.List(ilVeh)
                            ilVefCode = tgInvVehCode(ilVeh).iCode
                            If tmClf.iVefCode = tgInvVehCode(ilVeh).iCode Then
                                ilIncludeSpot = True
                                Exit For
                            End If
                        Next ilVeh
                    End If

                    '5/22/14: Ignore spots that will be billed in the next period
                    If ilIncludeSpot Then
                        If (imXMidHandle = 2) And (tlSdfExt.sXCrossMidnight = "Y") Then
                            'Don't increment day if line is within a virtual package
                            tmClfSrchKey.lChfCode = tlSdfExt.lChfCode
                            tmClfSrchKey.iLine = tlSdfExt.iLineNo
                            tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
                            tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
                            ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                            If (tmClf.lChfCode = tlSdfExt.lChfCode) And (tmClf.iLine = tlSdfExt.iLineNo) Then
                                If tmClf.sType = "H" Then
                                    tmClfSrchKey.lChfCode = tlSdfExt.lChfCode
                                    tmClfSrchKey.iLine = tmClf.iPkLineNo
                                    tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
                                    tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
                                    ilRet = btrGetGreaterOrEqual(hmClf, tlClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                    If (tmClf.lChfCode = tlSdfExt.lChfCode) And (tlClf.iLine = tmClf.iPkLineNo) Then
                                        If tlClf.sType <> "O" Then
                                            llDate = llDate + 1
                                        End If
                                    End If
                                Else
                                    llDate = llDate + 1
                                End If
                            End If
                            If tmChf.sBillCycle = "C" Then
                                If (llDate < llCalStartDate) Or (llDate > llCalEndDate) Then
                                    ilIncludeSpot = False
                                End If
                            ElseIf tmChf.sBillCycle = "W" Then
                                If (llDate < llWkStartDate) Or (llDate > llWkEndDate) Then
                                    ilIncludeSpot = False
                                End If
                            Else
                                '10/5/14
                                If tlSdfExt.sXCrossMidnight = "Y" Then
                                    If (llDate < llStdStartDate) Or (llDate - 1 > llStdEndDate) Then
                                        ilIncludeSpot = False
                                    End If
                                Else
                                    If (llDate < llStdStartDate) Or (llDate > llStdEndDate) Then
                                        ilIncludeSpot = False
                                    End If
                                End If
                            End If
                        End If
                    End If
    
                    If ilIncludeSpot Then
                        'Test if MG and Billing by Order, then ignore spot if missed date
                        'outside billing period
                        If tmClf.sType = "H" Then
                            If (tmChf.lCode <> tmPkClf.lChfCode) Or (tmClf.iPkLineNo <> tmPkClf.iLine) Then
                                tmClfSrchKey.lChfCode = tmChf.lCode
                                tmClfSrchKey.iLine = tmClf.iPkLineNo
                                tmClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
                                tmClfSrchKey.iPropVer = 32000 ' 0 show latest version
                                ilRet = btrGetGreaterOrEqual(hmClf, tmPkClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                            End If
                            tlClf = tmPkClf
                        End If
                        If ((tgSpf.sInvAirOrder = "O") And (Not (rbcType(INVGEN_Aff).Value))) Or ((tgSpf.sInvAirOrder = "S") And (Not (rbcType(INVGEN_Aff).Value))) Or ((tmClf.sType = "H") And (tlClf.sType = "O")) Then
                            If (tlSdfExt.sSchStatus = "G") Or (tlSdfExt.sSchStatus = "O") Then
                                If ilTestType = 0 Then
                                    tmSdfSrchKey3.lCode = tlSdfExt.lCode
                                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                    tmSmfSrchKey2.lCode = tmSdf.lCode
                                    ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                    Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tlSdfExt.lChfCode) And (tmSmf.iLineNo = tlSdfExt.iLineNo)
                                        If tmSdf.lCode = tmSmf.lSdfCode Then
                                            gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                            llDate = gDateValue(slDate)
                                            If tmChf.sBillCycle = "C" Then
                                                If (llDate < llCalStartDate) Or (llDate > llCalEndDate) Then
                                                    ilIncludeSpot = False
                                                Else
                                                    If Not imFullCal Then
                                                        gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                                                        If gDateValue(slDate) > llCalEndDate Then
                                                            ilIncludeSpot = False
                                                        End If
                                                    End If
                                                End If
                                            ElseIf tmChf.sBillCycle = "W" Then
                                                If (llDate < llWkStartDate) Or (llDate > llWkEndDate) Then
                                                    ilIncludeSpot = False
                                                Else
                                                    If Not imFullWk Then
                                                        gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                                                        If gDateValue(slDate) > llWkEndDate Then
                                                            ilIncludeSpot = False
                                                        End If
                                                    End If
                                                End If
                                            Else
                                                If (llDate < llStdStartDate) Or (llDate > llStdEndDate) Then
                                                    ilIncludeSpot = False
                                                Else
                                                    If Not imFullStd Then
                                                        gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                                                        If gDateValue(slDate) > llStdEndDate Then
                                                            ilIncludeSpot = False
                                                        End If
                                                    End If
                                                End If
                                            End If
                                            Exit Do
                                        End If
                                        ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                    Loop
                                End If
                            End If
                        End If
                    End If
                    
                    If ilIncludeSpot Then
                        If ((tmChf.sBillCycle = "C") And (ilTestBilled = 2)) Or ((tmChf.sBillCycle = "S") And (ilTestBilled = 1)) Or ((tmChf.sBillCycle = "W") And (ilTestBilled = 3)) Then
                            mTestSdfExt = True
                             For ilVeh = 0 To UBound(tgInvVehCode) - 1 Step 1
                                If tgInvVehCode(ilVeh).iCode = tlSdfExt.iVefCode Then
                                    tgInvVehCode(ilVeh).iStatus = 1
                                    Exit For
                                End If
                             Next ilVeh
                        End If
                    End If
                End If
            End If
        End If
    Else
        'Build Sort record (Agency or Advt if direct; Advt; Contract #, Product; Vehicle; Line #; Date; Time)
        If tmChf.lCode <> tlSdfExt.lChfCode Then
            tmChfSrchKey.lCode = tlSdfExt.lChfCode
            ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
            If ilRet <> BTRV_ERR_NONE Then
                mTestSdfExt = False
                Exit Function
            End If
        End If
        If tmChf.sBillCycle = "C" Then
            If ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbUnchecked Then
                Exit Function
            End If
            If Not imFullCal Then
                gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                If gDateValue(slDate) > llCalEndDate Then
                    Exit Function
                End If
            End If
        ElseIf tmChf.sBillCycle = "W" Then
            If ckcBillCycle(INVBILLCYCLE_Week).Value = vbUnchecked Then
                Exit Function
            End If
            If Not imFullWk Then
                gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                If gDateValue(slDate) > llWkEndDate Then
                    Exit Function
                End If
            End If
        Else
            If ckcBillCycle(INVBILLCYCLE_STD).Value = vbUnchecked Then
                Exit Function
            End If
            If Not imFullStd Then
                gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slDate
                If gDateValue(slDate) > llStdEndDate Then
                    Exit Function
                End If
            End If
        End If
        ilIncludeSpot = True
        gUnpackDate tlSdfExt.iDate(0), tlSdfExt.iDate(1), slDate
        llDate = gDateValue(slDate)
        '5/22/14: Adjust spot date if cross midnight
        If (imXMidHandle = 2) And (tlSdfExt.sXCrossMidnight = "Y") Then
            'Don't increment day if line is within a virtual package
            tmClfSrchKey.lChfCode = tlSdfExt.lChfCode
            tmClfSrchKey.iLine = tlSdfExt.iLineNo
            tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
            tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
            ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
            If (tmClf.lChfCode = tlSdfExt.lChfCode) And (tmClf.iLine = tlSdfExt.iLineNo) Then
                If tmClf.sType = "H" Then
                    tmClfSrchKey.lChfCode = tlSdfExt.lChfCode
                    tmClfSrchKey.iLine = tmClf.iPkLineNo
                    tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
                    tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
                    ilRet = btrGetGreaterOrEqual(hmClf, tlClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                    If (tmClf.lChfCode = tlSdfExt.lChfCode) And (tlClf.iLine = tmClf.iPkLineNo) Then
                        If tlClf.sType <> "O" Then
                            llDate = llDate + 1
                        End If
                    End If
                Else
                    llDate = llDate + 1
                End If
            End If
        End If
        
        'Bypass PSA/Promos-Remove this code for PSA/Promo invoicing
        If (tmChf.sType = "M") Or (tmChf.sType = "S") Or (tmChf.sType = "V") Then
            ilIncludeSpot = False
        End If
        If ilIncludeSpot Then
            If (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Aff).Value) Or (rbcType(INVGEN_Archive).Value) Then      '11-15-16 reprint,aff, or archive
                ilIncludeSpot = False
                For ilLoop = 0 To UBound(tmRPInfo) - 1 Step 1
                    If tgSpf.sBCombine = "N" Then
                        If (tmChf.lCntrNo = tmRPInfo(ilLoop).lCntrNo) And ((tmRPInfo(ilLoop).iMnfItem = 0) Or (tmRPInfo(ilLoop).iMnfItem = -1)) Then
                            '10/17/14
                            If (imXMidHandle = 2) And (tlSdfExt.sXCrossMidnight = "Y") Then
                                If (tmChf.sBillCycle = tmRPInfo(ilLoop).sBillCycle) And (llDate >= tmRPInfo(ilLoop).lInvStartDate) And (llDate - 1 <= tmRPInfo(ilLoop).lInvEndDate) Then
                                    ilIncludeSpot = True
                                    Exit For
                                End If
                            Else
                                If (tmChf.sBillCycle = tmRPInfo(ilLoop).sBillCycle) And (llDate >= tmRPInfo(ilLoop).lInvStartDate) And (llDate <= tmRPInfo(ilLoop).lInvEndDate) Then
                                    ilIncludeSpot = True
                                    Exit For
                                End If
                            End If
                        End If
                    Else
                        If (tmChf.lCntrNo = tmRPInfo(ilLoop).lCntrNo) And ((tmRPInfo(ilLoop).iMnfItem = 0) Or (tmRPInfo(ilLoop).iMnfItem = -1)) Then
                            '10/17/14
                            If (imXMidHandle = 2) And (tlSdfExt.sXCrossMidnight = "Y") Then
                                If (tmChf.sBillCycle = tmRPInfo(ilLoop).sBillCycle) And (llDate >= tmRPInfo(ilLoop).lInvStartDate) And (llDate - 1 <= tmRPInfo(ilLoop).lInvEndDate) Then
                                    ilIncludeSpot = True
                                    Exit For
                                End If
                            Else
                                If (tmChf.sBillCycle = tmRPInfo(ilLoop).sBillCycle) And (llDate >= tmRPInfo(ilLoop).lInvStartDate) And (llDate <= tmRPInfo(ilLoop).lInvEndDate) Then
                                    ilIncludeSpot = True
                                    Exit For
                                End If
                            End If
                        End If
                    End If
                Next ilLoop
            Else
                If tmChf.sBillCycle = "C" Then
                    If (llDate < llCalStartDate) Or (llDate > llCalEndDate) Then
                        ilIncludeSpot = False
                    End If
                ElseIf tmChf.sBillCycle = "W" Then
                    If (llDate < llWkStartDate) Or (llDate > llWkEndDate) Then
                        ilIncludeSpot = False
                    End If
                Else
                    '10/5/14
                    If (imXMidHandle = 2) And (tlSdfExt.sXCrossMidnight = "Y") Then
                        If (llDate < llStdStartDate) Or (llDate - 1 > llStdEndDate) Then
                            ilIncludeSpot = False
                        Else
                            If llDate - 1 = llStdEndDate Then
                                tlSdfExt.sSchStatus = "Z"
                            End If
                        End If
                    Else
                        If (llDate < llStdStartDate) Or (llDate > llStdEndDate) Then
                            ilIncludeSpot = False
                        End If
                    End If
                End If
            End If
        End If
        
        If (ilIncludeSpot) And (rbcCntr(INVCNTR_Selective).Value Or rbcCntr(INVCNTR_WOExpired).Value Or rbcCntr(INVCNTR_Posted).Value) And ((rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value)) Then
            ilIncludeSpot = False
            For ilLoop = 0 To UBound(lmSelCntrCode) - 1 Step 1
                If tmChf.lCode = lmSelCntrCode(ilLoop) Then
                    ilIncludeSpot = True
                    Exit For
                End If
            Next ilLoop
        End If
        
        If ilTestType = 0 Then
            If ilIncludeSpot Then
                If UBound(igVirtVefCode) > LBound(igVirtVefCode) Then
                    If mSdfExtExist(tlSdfExt) Then
                        ilIncludeSpot = False
                    End If
                End If
            End If
            If ilIncludeSpot Then
                'Test if any virtual vehicles defined- if not bypass test (all vehicles)
                'This test is used to determine if spot belongs to vehicle for which
                'spots are being gathered.
                'D.S. 8/31/01 Added "And (Not ckcAll.Value)" bonus spot times were showing 12m
                'due to virtual vehicles
                'If UBound(igVirtVefCode) > LBound(igVirtVefCode) Then
'3/14/03- removed test as tmVef not set any longer and virtual vehicles are not used
'                If (UBound(igVirtVefCode) > LBound(igVirtVefCode)) And ((ckcAll.Value = vbUnchecked) And (rbcType(INVGEN_Reprint).Value <> True)) Then  '10-31-01
'                    If (tmClf.lChfCode <> tmChf.lCode) Or (tmClf.iLine <> tlSdfExt.iLineNo) Then
'                        tmClfSrchKey.lChfCode = tmChf.lCode
'                        tmClfSrchKey.iLine = tlSdfExt.iLineNo
'                        tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
'                        tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
'                        ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
'                    End If
'
'                    If (tmClf.lChfCode = tmChf.lCode) And (tmClf.iLine = tlSdfExt.iLineNo) Then
'                        'tmVef contains selected vehicle, tlVef contains processing vehicle
'                        If tmVef.iCode <> tmClf.iVefCode Then
'                            ilIncludeSpot = False
'                        End If
'                    End If
'                End If
            End If
            If ilIncludeSpot Then
                'Test that line vehicle is also being invoiced- if not bypass spot
                'this is required for spots moved to other vehicles and only that vehicle
                'being invoiced
                If (tlSdfExt.sSchStatus = "O") Or (tlSdfExt.sSchStatus = "G") Then
                    ilIncludeSpot = False
                    tmSdfSrchKey3.lCode = tlSdfExt.lCode
                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilTestType = 1 Then
                        tmSmfSrchKey1.lCode = tlSdfExt.lCode
                        ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    Else
                        tmSmfSrchKey2.lCode = tlSdfExt.lCode
                        ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    End If
                    Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tlSdfExt.lChfCode) And (tmSmf.iLineNo = tlSdfExt.iLineNo)
                        If tmSdf.lCode = tmSmf.lSdfCode Then
                            If (tmClf.lChfCode <> tlSdfExt.lChfCode) Or (tmClf.iLine <> tlSdfExt.iLineNo) Then
                                tmClfSrchKey.lChfCode = tlSdfExt.lChfCode
                                tmClfSrchKey.iLine = tlSdfExt.iLineNo
                                tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
                                tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
                                ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                            End If
                            If (tmClf.lChfCode = tlSdfExt.lChfCode) And (tmClf.iLine = tlSdfExt.iLineNo) Then
                                'tmVef contains selected vehicle, tlVef contains processing vehicle
                                For ilVeh = 0 To UBound(tgInvVehCode) - 1 Step 1 'lbcVehicle.ListCount - 1 Step 1
                                    slNameCode = Trim$(tgInvVehCode(ilVeh).sKey)    'Traffic!lbcVehicle.List(ilVeh)
                                    ilVefCode = tgInvVehCode(ilVeh).iCode
                                    If tmClf.iVefCode = tgInvVehCode(ilVeh).iCode Then
                                        ilIncludeSpot = True
                                        If tmClf.sType = "H" Then
                                            If (tmPkClf.lChfCode <> tmChf.lCode) Or (tmPkClf.iLine <> tmClf.iPkLineNo) Then
                                                tmClfSrchKey.lChfCode = tmChf.lCode
                                                tmClfSrchKey.iLine = tmClf.iPkLineNo
                                                tmClfSrchKey.iCntRevNo = 32000 ' 0 show latest version
                                                tmClfSrchKey.iPropVer = 32000 ' 0 show latest version
                                                ilRet = btrGetGreaterOrEqual(hmClf, tmPkClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                                            End If
                                            tlClf = tmPkClf
                                        End If
                                        If ((tgSpf.sInvAirOrder = "O") And (Not (rbcType(INVGEN_Aff).Value))) Or ((tgSpf.sInvAirOrder = "S") And (Not (rbcType(INVGEN_Aff).Value))) Or ((tmClf.sType = "H") And (tlClf.sType = "O")) Then
                                            gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                            llDate = gDateValue(slDate)
                                            If (rbcType(INVGEN_Reprint).Value) Or (rbcType(INVGEN_Aff).Value) Or (rbcType(INVGEN_Archive).Value) Then      '11-15-16 reprint, aff or archive
                                                ilIncludeSpot = False
                                                For ilLoop = 0 To UBound(tmRPInfo) - 1 Step 1
                                                    If tgSpf.sBCombine = "N" Then
                                                        If (tmChf.lCntrNo = tmRPInfo(ilLoop).lCntrNo) And ((tmRPInfo(ilLoop).iMnfItem = 0) Or (tmRPInfo(ilLoop).iMnfItem = -1)) Then
                                                            If (tmChf.sBillCycle = tmRPInfo(ilLoop).sBillCycle) And (llDate >= tmRPInfo(ilLoop).lInvStartDate) And (llDate <= tmRPInfo(ilLoop).lInvEndDate) Then
                                                                ilIncludeSpot = True
                                                                Exit For
                                                            End If
                                                        End If
                                                    Else
                                                        If (tmChf.lCntrNo = tmRPInfo(ilLoop).lCntrNo) And ((tmRPInfo(ilLoop).iMnfItem = 0) Or (tmRPInfo(ilLoop).iMnfItem = -1)) Then
                                                            If (tmChf.sBillCycle = tmRPInfo(ilLoop).sBillCycle) And (llDate >= tmRPInfo(ilLoop).lInvStartDate) And (llDate <= tmRPInfo(ilLoop).lInvEndDate) Then
                                                                ilIncludeSpot = True
                                                                Exit For
                                                            End If
                                                        End If
                                                    End If
                                                Next ilLoop
                                            Else
                                                If tmChf.sBillCycle = "C" Then
                                                    If (llDate < llCalStartDate) Or (llDate > llCalEndDate) Then
                                                        ilIncludeSpot = False
                                                    Else
                                                        If Not imFullCal Then
                                                            gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                                            If gDateValue(slDate) > llCalEndDate Then
                                                                ilIncludeSpot = False
                                                            End If
                                                        End If
                                                    End If
                                                ElseIf tmChf.sBillCycle = "W" Then
                                                    If (llDate < llWkStartDate) Or (llDate > llWkEndDate) Then
                                                        ilIncludeSpot = False
                                                    Else
                                                        If Not imFullWk Then
                                                            gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                                            If gDateValue(slDate) > llWkEndDate Then
                                                                ilIncludeSpot = False
                                                            End If
                                                        End If
                                                    End If
                                                Else
                                                    If (llDate < llStdStartDate) Or (llDate > llStdEndDate) Then
                                                        ilIncludeSpot = False
                                                    Else
                                                        If Not imFullStd Then
                                                            gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slDate
                                                            If gDateValue(slDate) > llStdEndDate Then
                                                                ilIncludeSpot = False
                                                            End If
                                                        End If
                                                    End If
                                                End If
                                            End If
                                        End If
                                        Exit For
                                    End If
                                Next ilVeh
                            End If
                            Exit Do
                        End If
                        ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    Loop
                    If ilIncludeSpot And ilTestDupl Then
                        If mSdfExtExist(tlSdfExt) Then
                            ilIncludeSpot = False
                        End If
                    End If
               End If
            End If
        Else
            'Determine if Already included
            If ilTestDupl Then
                If mSdfExtExist(tlSdfExt) Then
                    ilIncludeSpot = False
                End If
            End If
            If ilIncludeSpot Then
                If (tmClf.lChfCode <> tmChf.lCode) Or (tmClf.iLine <> tlSdfExt.iLineNo) Then
                    tmClfSrchKey.lChfCode = tmChf.lCode
                    tmClfSrchKey.iLine = tlSdfExt.iLineNo
                    tmClfSrchKey.iCntRevNo = 32000 ' Plug with very high number
                    tmClfSrchKey.iPropVer = 32000 ' Plug with very high number
                    ilRet = btrGetGreaterOrEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                End If
                If (tmClf.lChfCode = tmChf.lCode) And (tmClf.iLine = tlSdfExt.iLineNo) Then
                    'tmVef contains selected vehicle, tlVef contains processing vehicle
                    ilIncludeSpot = False
                    For ilVeh = 0 To UBound(tgInvVehCode) - 1 Step 1 'lbcVehicle.ListCount - 1 Step 1
                        slNameCode = Trim$(tgInvVehCode(ilVeh).sKey)    'Traffic!lbcVehicle.List(ilVeh)
                        ilVefCode = tgInvVehCode(ilVeh).iCode
                        If tmClf.iVefCode = tgInvVehCode(ilVeh).iCode Then
                            ilIncludeSpot = True
                            Exit For
                        End If
                    Next ilVeh
                End If
            End If
        End If
        If ilIncludeSpot Then
            mCreateSortRec ilTestType, ilUpper, llStdStartDate, llStdEndDate, llCalStartDate, llCalEndDate, llWkStartDate, llWkEndDate, llBaseDate, tlSdfExt
        End If
    End If
'    If ilIncludeSpot = True Then
'        Debug.Print "mTestSdfExt, include spot:" & tlSdfExt.lCode
'    Else
'        Debug.Print "mTestSdfExt, DON'T include spot:" & tlSdfExt.lCode & ", " & tlSdfExt.lChfCode
'    End If
End Function

Private Function mUpdateDates(llInvoiceNo As Long) As Integer
    Dim ilRet As Integer
    Dim hlSpf As Integer
    Dim ilVeh As Integer
    Dim slNameCode As String
    Dim ilUpdateStd As Integer
    Dim ilUpdateCal As Integer
    Dim ilUpdateWk As Integer
    Dim ilFullStd As Integer
    Dim ilFullCal As Integer
    Dim ilFullWk As Integer
    Dim slCode As String
    Dim slName As String
    Dim ilLoop As Integer
    Dim ilUnbilledCount As Integer
    Dim ilRepMsgAdded As Integer
    Dim hlSaf As Integer
    Dim tlSafSrchKey0 As INTKEY0

    ilRepMsgAdded = False
    ilUnbilledCount = 0
    'If rbcCntr(INVCNTR_All).Value Then    'All 8-24-01 Always check spots to see if all billed.  if so, set the billed dates in Site
        hlSpf = CBtrvTable(TWOHANDLES)
        ilRet = btrOpen(hlSpf, "", sgDBPath & "Spf.btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        ilFullStd = imFullStd
        ilFullCal = imFullCal
        ilFullWk = imFullWk
        lbcUnbilled.Clear
        lmAddItemLen = 0
        If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_GenRepAR).Value = vbChecked)) Then
            If ckcType(INVTYPE_Commercial).Visible Then
                'Test all vehicles
                ReDim tgInvVehCode(0 To 0) As VEHSORT
                If ((Asc(tgSpf.sUsingFeatures3) And USINGHUB) = USINGHUB) And (tgUrf(0).iMnfHubCode > 0) Then
                    gObtainVefIgnoreHub tmMVef()
                    For ilVeh = LBound(tmMVef) To UBound(tmMVef) - 1 Step 1
                        tgInvVehCode(UBound(tgInvVehCode)).iCode = tmMVef(ilVeh).iCode
                        tgInvVehCode(UBound(tgInvVehCode)).iStatus = 0
                        ReDim Preserve tgInvVehCode(0 To UBound(tgInvVehCode) + 1) As VEHSORT
                    Next ilVeh
                Else
                    For ilVeh = 0 To lbcVehicle.ListCount - 1 Step 1
                        slNameCode = Trim$(tmInvVehicle(ilVeh).sKey) 'Traffic!lbcVehicle.List(ilVeh)
                        tgInvVehCode(UBound(tgInvVehCode)).sKey = slNameCode
                        ilRet = gParseItem(Trim$(slNameCode), 2, "\", slCode)
                        tgInvVehCode(UBound(tgInvVehCode)).iCode = Val(slCode)
                        tgInvVehCode(UBound(tgInvVehCode)).iStatus = 0
                        ReDim Preserve tgInvVehCode(0 To UBound(tgInvVehCode) + 1) As VEHSORT
                    Next ilVeh
                End If
                'Test if any spots remain unbilled for period- if not update last bill date
                imShowMsg = True
                If (ilFullStd) And (ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked) Then
                    ilUpdateStd = Not mObtainCntrToInvoice(1)
                Else
                    ilUpdateStd = False
                End If
                If (ilFullCal) And (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked) Then
                    ilUpdateCal = Not mObtainCntrToInvoice(2)
                Else
                    ilUpdateCal = False
                End If
                If (ilFullWk) And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked) Then
                    ilUpdateWk = Not mObtainCntrToInvoice(3)
                Else
                    ilUpdateWk = False
                End If

                If UBound(lmCPMBypassCntr) > 1 Then
                    For ilLoop = 1 To UBound(lmCPMBypassCntr) - 1 Step 1
                        'Get Contract Bill Cycle
                        tmChfSrchKey.lCode = lmCPMBypassCntr(ilLoop)
                        ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                        If ilRet = BTRV_ERR_NONE Then
                            If tmChf.sBillCycle = "C" Then
                                ilUpdateCal = False
                            ElseIf tmChf.sBillCycle = "W" Then
                                ilUpdateWk = False
                            Else
                                ilUpdateStd = False
                            End If
                        End If
                    Next ilLoop
                End If
            Else
                If (ilFullStd) And (ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked) Then
                    ilUpdateStd = True
                Else
                    ilUpdateStd = False
                End If
                If (ilFullCal) And (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked) Then
                    ilUpdateCal = True
                Else
                    ilUpdateCal = False
                End If
                If (ilFullWk) And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked) Then
                    ilUpdateWk = True
                Else
                    ilUpdateWk = False
                End If
            End If
            Screen.MousePointer = vbHourglass
            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
            'If ckcType(INVTYPE_PrintRep).Value = vbChecked Then
            '    ilRet = mRepInv_CheckCntr()
            '    If Not ilRet Then
            '        ilUpdateStd = False
            '        ilUpdateCal = False
            '    End If
            'End If
            '5/10/12: Rep only billed by Std, therefore only test if std billing selected
            'If ((ilFullStd) And (ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked)) Or ((ilFullCal) And (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked)) Or ((ilFullWk) And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked)) Then
            If ((ilFullStd) And (ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked)) Then
                If ((ckcType(INVTYPE_GenRepAR).Value = vbUnchecked) And (ckcType(INVTYPE_GenRepAR).Visible)) Or (ckcType(INVTYPE_GenRepAR).Value = vbChecked) Then
                    mRepAR_GetCntr
                    ilRet = mRepAR_GenRvf(1, llInvoiceNo)
                    If Not ilRet Then
                        ilUpdateStd = False
                        ilUpdateCal = False
                        ilUpdateWk = False
                        lbcUnbilled.AddItem "Not all Rep Contracts Billed"
                        plcUnbilled.BackColor = Red
                        ilUnbilledCount = ilUnbilledCount + 1
                    Else
                        lbcUnbilled.AddItem "All Rep Contracts Billed"
                        plcUnbilled.BackColor = DARKGREEN
                        ilRepMsgAdded = True
                        ilUnbilledCount = ilUnbilledCount + 1
                    End If
                End If
            End If
            
            If ((ilFullStd) And (ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked)) Or ((ilFullCal) And (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked)) Or ((ilFullWk) And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked)) Then
                If ckcType(INVTYPE_Commercial).Visible Then
                    For ilVeh = 0 To UBound(tgInvVehCode) - 1 Step 1
                        If tgInvVehCode(ilVeh).iStatus = 1 Then
                            ilRet = gParseItem(Trim$(tgInvVehCode(ilVeh).sKey), 3, "|", slNameCode)
                            ilRet = gParseItem(Trim$(slNameCode), 1, "\", slName)
                            If ((Asc(tgSpf.sUsingFeatures3) And USINGHUB) = USINGHUB) And (tgUrf(0).iMnfHubCode > 0) Then
                                ilRet = gBinarySearchVef(tgInvVehCode(ilVeh).iCode)
                                If ilRet <> -1 Then
                                    lbcUnbilled.AddItem "Unbilled Spots in " & Trim$(slName)
                                End If
                            Else
                                lbcUnbilled.AddItem "Unbilled Spots in " & Trim$(slName)
                            End If
                            ilUnbilledCount = ilUnbilledCount + 1
                        End If
                    Next ilVeh
                    For ilLoop = 1 To UBound(lmCPMBypassCntr) - 1 Step 1
                        tmChfSrchKey.lCode = lmCPMBypassCntr(ilLoop)
                        ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                        If ilRet = BTRV_ERR_NONE Then
                            lbcUnbilled.AddItem "Unbilled Digital Contract " & Trim$(str(tmChf.lCntrNo))
                        End If
                        ilUnbilledCount = ilUnbilledCount + 1
                    Next ilLoop
                                        
                    plcUnbilled.Move plcFromLine.Left + (plcFromLine.Width - plcUnbilled.Width) \ 2, plcFromLine.Top + (plcFromLine.Height - plcUnbilled.Height) \ 2
                    If ((ilUnbilledCount <= 0) Or ((ilUnbilledCount = 1) And (ilRepMsgAdded = True))) And (bmUnpostedVehicleExist = False) Then
                        If ilFullStd And (ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked) Then        '3-8-12
                            lbcUnbilled.AddItem "All Contracts in Standard Broadcast Month Billed"
                        End If
                        If ilFullCal And (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked) Then
                            lbcUnbilled.AddItem "All Contracts in Calendar Month Billed"
                        End If
                        If ilFullWk And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked) Then
                            lbcUnbilled.AddItem "All Contracts in Week Billed"
                        End If
                        plcUnbilled.BackColor = DARKGREEN
                    Else
                        If bmUnpostedVehicleExist Then
                            lbcUnbilled.AddItem "See: ContractNotPosted_" & Format(Now, "mmddyyyy") & " for list of Unposted Contracts/Vehicles"
                        End If
                        For ilLoop = 0 To lbcUnbilled.ListCount - 1 Step 1
                            Print #hmMsg, lbcUnbilled.List(ilLoop)
                        Next ilLoop
                        igInvErrFlag = True
                        plcUnbilled.BackColor = Red
                        ilUpdateStd = False
                    End If
                End If
                plcFromLine.Enabled = False
                Invoice.ZOrder
                plcUnbilled.ZOrder
                plcUnbilled.Visible = True
                DoEvents
            End If
            Do
                ilRet = btrGetFirst(hlSpf, tgSpf, Len(tgSpf), 0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                tgSpf.lBNextNo = llInvoiceNo
                If ilUpdateStd Then
                    gPackDate smEndStd, tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1)
                End If
                If ilUpdateCal Then
                    gPackDate smEndCal, tgSpf.iBLastCalMnth(0), tgSpf.iBLastCalMnth(1)
                End If
                If (ckcType(INVTYPE_PrintRep).Value = vbChecked) And (rbcType(INVGEN_Final).Value) Then
                    gPackDateLong lmNowDate, tgSpf.iRepPrintDate(0), tgSpf.iRepPrintDate(1)
                End If
                ilRet = btrUpdate(hlSpf, tgSpf, Len(tgSpf))
            Loop While ilRet = BTRV_ERR_CONFLICT
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                Print #hmMsg, "mUpdateDates: btrUpdate-Point 1, Spf Error # " & Trim$(str$(ilRet))
            End If
            If ilUpdateWk Then
                hlSaf = CBtrvTable(TWOHANDLES)
                ilRet = btrOpen(hlSaf, "", sgDBPath & "Saf.btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
                Do
                    tlSafSrchKey0.iCode = tgSaf(0).iCode
                    ilRet = btrGetEqual(hlSaf, tgSaf(0), Len(tgSaf(0)), tlSafSrchKey0, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                    If ilRet = BTRV_ERR_NONE Then
                        gPackDate smEndWk, tgSaf(0).iBLastWeeklyDate(0), tgSaf(0).iBLastWeeklyDate(1)
                        ilRet = btrUpdate(hlSaf, tgSaf(0), Len(tgSaf(0)))
                    End If
                Loop While ilRet = BTRV_ERR_CONFLICT
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    Print #hmMsg, "mUpdateDates: btrUpdate-Point 3, Saf Error # " & Trim$(str$(ilRet))
                End If
                ilRet = btrClose(hlSaf)
                btrDestroy hlSaf
            End If
        Else
            Do
                ilRet = btrGetFirst(hlSpf, tgSpf, Len(tgSpf), 0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                If (ckcType(INVTYPE_PrintRep).Value = vbChecked) And (rbcType(INVGEN_Final).Value) Then
                    gPackDateLong lmNowDate, tgSpf.iRepPrintDate(0), tgSpf.iRepPrintDate(1)
                End If
                ilRet = btrUpdate(hlSpf, tgSpf, Len(tgSpf))
            Loop While ilRet = BTRV_ERR_CONFLICT
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                Print #hmMsg, "mUpdateDates: btrUpdate-Point 2, Spf Error # " & Trim$(str$(ilRet))
            End If
        End If
        mUpdateDates = ilRet
        ilRet = btrClose(hlSpf)
        btrDestroy hlSpf
    'End If
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mUpdateInv                      *
'*                                                     *
'*             Created:3/01/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Update agency/advertiser/..    *
'*                      Code removed from mInvoiceRpt  *
'*                      to make room                   *
'*                                                     *
'*******************************************************
Private Function mUpdateInv(ilCallFrom As Integer) As Integer
'   ilCallFrom(I)- 0=Air time; 1=NTR; 2=Rep; 3=Installment; 4=CPM
    Dim ilRet As Integer
    Dim slStr As String
    Dim ilRvf As Integer
    Dim hlSpf As Integer
    Dim ilFound As Integer
    Dim ilVeh As Integer
    'Dim slNameCode As String
    Dim llSdfIndex As Long
    Dim slGross As String
    Dim slNet As String
    Dim llGross As Long
    Dim llNet As Long
    'Dim ilUpdateStd As Integer
    'Dim ilUpdateCal As Integer
    'Dim ilFullStd As Integer
    'Dim ilFullCal As Integer
    Dim ilAgf As Integer
    Dim ilAdf As Integer
    Dim ilLoop As Integer
    Dim ilSSMnf As Integer
    Dim ilTestSS As Integer
    Dim ilPartBreak As Integer
    Dim ilUpdateRvf As Integer
    Dim llCurCntrNo As Long
    Dim llCurSbfDate As Long
    Dim ilMatchCntrNo As Integer
    Dim slPct As String
    Dim slDollar As String
    Dim ilPartLastIndex As Integer
    Dim slRunGross As String
    Dim slRunNet As String
    Dim llAcquisitionCost As Long
    Dim llPartAcquisitionCost As Long
    Dim llRunAcquisitionCost As Long
    Dim ilInstallmentStatus As Integer  '0=Generate RVF as specified;
                                        '1=Installment as Billed and update History (Air & NTR);
                                        '2=Installment as Billed and don't update (Air & NTR);
                                        '3=Installment as Earned and place into history (Air & NTR: Retain dollars)
                                        '4=Installment as Earned and place into Receivables (Installment)
    Dim ilUpdaterHistory_Installment As Integer
    Dim slDate As String
    Dim tlRvf As RVF
    Dim ilUpdateHIOnly_RepAtNet As Integer

    mUpdateInv = BTRV_ERR_NONE
    If rbcType(INVGEN_Final).Value Then    'Final
        ilTestSS = False
        For ilSSMnf = LBound(tgSSMnf) To UBound(tgSSMnf) - 1 Step 1
            'If (Trim$(tgSSMnf(ilSSMnf).sUnitType) = "N") Or (Trim$(tgSSMnf(ilSSMnf).sUnitType) = "A") Then
            If (Trim$(tgSSMnf(ilSSMnf).sUnitType) = "N") Or (Trim$(tgSSMnf(ilSSMnf).sUnitType) = "A") Or (Trim$(tgSSMnf(ilSSMnf).sUnitType) = "E") Or (Trim$(tgSSMnf(ilSSMnf).sUnitType) = "F") Then
                ilTestSS = True
            End If
        Next ilSSMnf
        hlSpf = CBtrvTable(TWOHANDLES)
        ilRet = btrOpen(hlSpf, "", sgDBPath & "Spf.btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
        'Update spots and receivable
        llCurCntrNo = -1
        llCurSbfDate = -1
        ilInstallmentStatus = -1
        llSdfIndex = LBound(tgSortKey)
        ReDim tgUpdateAgf(0 To 0) As UPDATEADFAGF
        ReDim tgUpdateAdf(0 To 0) As UPDATEADFAGF
        Do
            If ((tgSortKey(llSdfIndex).lCntrNo <> llCurCntrNo) And (tgSortKey(llSdfIndex).iType <> 10)) Or (((tgSortKey(llSdfIndex).lCntrNo <> llCurCntrNo) Or (tgSortKey(llSdfIndex).lSbfDate <> llCurSbfDate)) And (tgSortKey(llSdfIndex).iType = 10)) Then
                If llCurCntrNo <> -1 Then
                    'Update Advertiser and Agency
                    '6/6/16: Replaced GoSub
                    'GoSub UpdateAdfAgfSub
                    If Not mUpdateAdfAgfSub(ilRet) Then
                        mUpdateInv = ilRet
                        Exit Function
                    End If
                    'ilRet = btrEndTrans(hmRvf)
                    ilInstallmentStatus = -1
                End If
                llCurCntrNo = tgSortKey(llSdfIndex).lCntrNo
                llCurSbfDate = tgSortKey(llSdfIndex).lSbfDate
                tmChfSrchKey.lCode = tgSortKey(llSdfIndex).lChfCode
                ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                'Removed on 11/14/97 because updating at Dallas and NY
                'causes a btrieve error 2
                'Writting to two db at dallas is OK
                'ilRet = btrBeginTrans(hmRvf, 1000)
                'If ilRet <> BTRV_ERR_NONE Then
                '    Screen.MousePointer = vbDefault
                '    ilRet = MsgBox("Update Not Completed, Try Later", vbOkOnly + vbExclamation, "Invoice")
                '    Exit Sub
                'End If
                '7/31/10:  Use salesperson sales source like any other contract
                ilUpdateHIOnly_RepAtNet = False
                If ((Asc(tgSpf.sAutoType2) And RN_NET) = RN_NET) Then
                    If Trim$(tmChf.sRepDBID) <> "" Then
                       'ilUpdateHIOnly_RepAtNet = True
                    End If
                End If
                ReDim tgUpdateAgf(0 To 0) As UPDATEADFAGF
                ReDim tgUpdateAdf(0 To 0) As UPDATEADFAGF
                For ilRvf = 0 To UBound(tgRvf) - 1 Step 1
                    'Add test- was record created previously
                    tgRvf(ilRvf).sType = ""
                    ilMatchCntrNo = False
                    If tgRvf(ilRvf).lCntrNo = llCurCntrNo Then
                        If tgSortKey(llSdfIndex).iType <> 10 Then
                            ilMatchCntrNo = True
                        Else
                            '6/7/15: Check number changed to string
                            'If llCurSbfDate = tgRvf(ilRvf).lCheckNo Then
                            If llCurSbfDate = Val(tgRvf(ilRvf).sCheckNo) Then
                                'tgRvf(ilRvf).lCheckNo = 0
                                tgRvf(ilRvf).sCheckNo = ""
                                ilMatchCntrNo = True
                            End If
                        End If
                    End If
                    If ilMatchCntrNo Then
                        If (ilCallFrom = 2) And (imPrintRepInv) Then
                            'Find transaction date
                            ReDim tmPif(0 To 0) As PIF
                            tmRvfSrchKey4.lCntrNo = tgRvf(ilRvf).lCntrNo
                            tmRvfSrchKey4.iTranDate(0) = 0  'tlRvf.iTranDate(0)
                            tmRvfSrchKey4.iTranDate(1) = 0  'tlRvf.iTranDate(1)
                            ilRet = btrGetGreaterOrEqual(hmRvf, tmRvf, imRvfRecLen, tmRvfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                            Do While (ilRet = BTRV_ERR_NONE) And (tmRvf.lCntrNo = tgRvf(ilRvf).lCntrNo)
                                If (tgRvf(ilRvf).iAirVefCode = tmRvf.iAirVefCode) And (tgRvf(ilRvf).iBillVefCode = tmRvf.iBillVefCode) Then
                                    If ((tgRvf(ilRvf).lInvNo = tmRvf.lInvNo)) And ((tmRvf.sTranType = "IN")) And (tgRvf(ilRvf).sCashTrade = tmRvf.sCashTrade) And (tmRvf.sInvoiceUndone <> "Y") Then
                                        If tmRvf.iMnfGroup > 0 Then
                                            gUnpackDate tmRvf.iTranDate(0), tmRvf.iTranDate(1), slDate
                                            ilRet = gObtainPIF_ForDate(hmPif, slDate, tmPif())
                                        End If
                                        Exit Do
                                    End If
                                End If
                                ilRet = btrGetNext(hmRvf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                            Loop
                        End If
                        ilFound = False
                        If ilInstallmentStatus = -1 Then
                            If ((Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) <> INSTALLMENT) Or (tmChf.sInstallDefined <> "Y") Then
                                ilInstallmentStatus = 0
                            Else
                                If (Asc(tgSpf.sUsingFeatures6) And INSTALLMENTREVENUEEARNED) <> INSTALLMENTREVENUEEARNED Then
                                    'If Air time and NTR, set all dollars to zero and update phf as HI only if no installment for month
                                    If (ilCallFrom = 0) Or (ilCallFrom = 1) Or (ilCallFrom = 4) Then
                                        If mAnyInstallmentsForCntr(tgSortKey(llSdfIndex).lChfCode) Then
                                            ilInstallmentStatus = 2
                                        Else
                                            ilInstallmentStatus = 1
                                        End If
                                    Else
                                        ilInstallmentStatus = 0
                                    End If
                                Else
                                    'Air Time and NTR updates phf retaining dollars as HI
                                    If (ilCallFrom = 0) Or (ilCallFrom = 1) Or (ilCallFrom = 4) Then
                                        ilInstallmentStatus = 3
                                    ElseIf ilCallFrom = 3 Then
                                        ilInstallmentStatus = 4
                                    Else
                                        ilInstallmentStatus = 0
                                    End If
                                End If
                            End If
                        End If
                        ilUpdaterHistory_Installment = False
                        If (ilInstallmentStatus = 1) Or (ilInstallmentStatus = 2) Or (ilInstallmentStatus = 3) Then
                            ilUpdaterHistory_Installment = True
                        End If
                        'tmRvfSrchKey1.iAdfCode = tgRvf(ilRvf).iAdfCode
                        'ilRet = btrGetEqual(hmRvf, tmRvf, imRvfRecLen, tmRvfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                        'Do While (ilRet = BTRV_ERR_NONE) And (tmRvf.iAdfCode = tgRvf(ilRvf).iAdfCode)
                        '    If (tgRvf(ilRvf).iAgfCode = tmRvf.iAgfCode) And (tgRvf(ilRvf).iBillVefCode = tmRvf.iBillVefCode) And (tgRvf(ilRvf).iAirVefCode = tmRvf.iAirVefCode) And (tgRvf(ilRvf).lCntrNo = tmRvf.lCntrNo) Then
                        '        If (tgRvf(ilRvf).iTranDate(0) = tmRvf.iTranDate(0)) And (tgRvf(ilRvf).iTranDate(1) = tmRvf.iTranDate(1)) And (tgRvf(ilRvf).sTranType = tmRvf.sTranType) And (tgRvf(ilRvf).sCashTrade = tmRvf.sCashTrade) Then
                        '            ilFound = True
                        '            Exit Do
                        '        End If
                        '    End If
                        '    ilRet = btrGetNext(hmRvf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE)
                        'Loop
                        If (ilInstallmentStatus = 1) Or (ilInstallmentStatus = 2) Then
                            gStrToPDN "0.00", 2, 6, tgRvf(ilRvf).sGross
                            gStrToPDN "0.00", 2, 6, tgRvf(ilRvf).sNet
                            tgRvf(ilRvf).lTax1 = 0
                            tgRvf(ilRvf).lTax2 = 0
                        End If
                        If ilInstallmentStatus = 2 Then
                            If (ilCallFrom <> 1) Or (tgRvf(ilRvf).lAcquisitionCost <= 0) Then
                                ilFound = True
                            End If
                        End If
                        If Not ilFound Then
                            If ilInstallmentStatus = 3 Then
                                tgRvf(ilRvf).sType = "A"
                            ElseIf ilInstallmentStatus = 4 Then
                                tgRvf(ilRvf).sType = "I"
                            Else
                                tgRvf(ilRvf).sType = ""
                            End If
                            ilUpdateRvf = True
                            ilPartBreak = False
                            If ilTestSS Then
                                'Determine if Rvf or Phf should be updated
                                'Test sales Source to determine if receivables shall be collected
                                If tgRvf(ilRvf).iSlfCode <> tmSlf.iCode Then
                                    tmSlfSrchKey.iCode = tgRvf(ilRvf).iSlfCode
                                    ilRet = btrGetEqual(hmSlf, tmSlf, imSlfRecLen, tmSlfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                    If ilRet <> BTRV_ERR_NONE Then
                                        If ilRet >= 30000 Then
                                            ilRet = csiHandleValue(0, 7)
                                        End If
                                        mUpdateInv = ilRet
                                        'ilRet = btrAbortTrans(hmRvf)
                                        Screen.MousePointer = vbDefault
                                        gSetMousePointer grdAirTime, grdRevenue, vbDefault
                                        ilRet = MsgBox("Update Not Completed, Try Later (Slf GetEqual Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                                        Screen.MousePointer = vbHourglass
                                        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                                        Exit Function
                                    End If
                                End If
                                If tmSlf.iSofCode > 0 Then
                                    If tmSlf.iSofCode <> tmSof.iCode Then
                                        tmSofSrchKey.iCode = tmSlf.iSofCode
                                        ilRet = btrGetEqual(hmSof, tmSof, imSofRecLen, tmSofSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                                        If ilRet <> BTRV_ERR_NONE Then
                                            If ilRet >= 30000 Then
                                                ilRet = csiHandleValue(0, 7)
                                            End If
                                            mUpdateInv = ilRet
                                            'ilRet = btrAbortTrans(hmRvf)
                                            Screen.MousePointer = vbDefault
                                            gSetMousePointer grdAirTime, grdRevenue, vbDefault
                                            ilRet = MsgBox("Update Not Completed, Try Later (Sof Get Equal Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                                            Screen.MousePointer = vbHourglass
                                            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                                            Exit Function
                                        End If
                                    End If
                                End If
                                If tmSof.iMnfSSCode > 0 Then
                                    For ilSSMnf = LBound(tgSSMnf) To UBound(tgSSMnf) - 1 Step 1
                                        If tmSof.iMnfSSCode = tgSSMnf(ilSSMnf).iCode Then
                                            'If Trim$(tgSSMnf(ilSSMnf).sUnitType) = "N" Then
                                            If (Trim$(tgSSMnf(ilSSMnf).sUnitType) = "N") Or (Trim$(tgSSMnf(ilSSMnf).sUnitType) = "E") Then
                                                ilUpdateRvf = False
                                            ElseIf (Trim$(tgSSMnf(ilSSMnf).sUnitType) = "F") Then
                                                ilUpdateRvf = True
                                            ElseIf Trim$(tgSSMnf(ilSSMnf).sUnitType) = "A" Then
                                                ilPartBreak = True
                                            End If
                                            Exit For
                                        End If
                                    Next ilSSMnf
                                End If
                            End If
                            If ilPartBreak Then
                                gPDNToStr tgRvf(ilRvf).sGross, 2, slGross
                                gPDNToStr tgRvf(ilRvf).sNet, 2, slNet
                                llAcquisitionCost = tgRvf(ilRvf).lAcquisitionCost
                                ilPartLastIndex = -1
                                'For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                                '    If tgRvf(ilRvf).iAirVefCode = tgMVef(ilVeh).iCode Then
                                    ilVeh = gBinarySearchVef(tgRvf(ilRvf).iAirVefCode)
                                    If ilVeh <> -1 Then
                                        'For ilLoop = 1 To 8 Step 1
                                        For ilLoop = 0 To UBound(tmPif) - 1 Step 1
                                            'If tmSof.iMnfSSCode = tgMVef(ilVeh).iMnfSSCode(ilLoop) Then
                                            If (tmSof.iMnfSSCode = tmPif(ilLoop).iMnfSSCode) And (tgMVef(ilVeh).iCode = tmPif(ilLoop).iVefCode) Then
                                                ilPartLastIndex = ilLoop
                                            End If
                                        Next ilLoop
                                    End If
                                'Next ilVeh
                                If ilPartLastIndex > 0 Then
                                    If tgRvf(ilRvf).iAdfCode <> tmAdf.iCode Then
                                        tmAdfSrchKey.iCode = tgRvf(ilRvf).iAdfCode
                                        ilRet = btrGetEqual(hmAdf, tmAdf, imAdfRecLen, tmAdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                                        If ilRet <> BTRV_ERR_NONE Then
                                            tmAdf.sRepInvGen = "I"
                                        End If
                                    End If
                                    slRunGross = ".00"
                                    slRunNet = ".00"
                                    llRunAcquisitionCost = 0
                                    'For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                                    '    If tgRvf(ilRvf).iAirVefCode = tgMVef(ilVeh).iCode Then
                                        ilVeh = gBinarySearchVef(tgRvf(ilRvf).iAirVefCode)
                                        If ilVeh <> -1 Then
                                            For ilLoop = 0 To UBound(tmPif) - 1 Step 1
                                                tgRvf(ilRvf).lCode = 0
                                                tgRvf(ilRvf).iMnfGroup = tmPif(ilLoop).iMnfGroup    'tgMVef(ilVeh).iMnfGroup(ilLoop)
                                                'If tmSof.iMnfSSCode = tgMVef(ilVeh).iMnfSSCode(ilLoop) Then
                                                If (tmSof.iMnfSSCode = tmPif(ilLoop).iMnfSSCode) And (tgMVef(ilVeh).iCode = tmPif(ilLoop).iVefCode) Then
                                                    If ilLoop <> ilPartLastIndex Then
                                                        'slPct = gIntToStrDec(tgMVef(ilVeh).iProdPct(ilLoop), 2)
                                                        slPct = gIntToStrDec(tmPif(ilLoop).iProdPct, 2)
                                                        slDollar = gDivStr(gMulStr(slGross, slPct), "100.00")
                                                        slRunGross = gAddStr(slRunGross, slDollar)
                                                        gStrToPDN slDollar, 2, 6, tgRvf(ilRvf).sGross
                                                        slDollar = gDivStr(gMulStr(slNet, slPct), "100.00")
                                                        slRunNet = gAddStr(slRunNet, slDollar)
                                                        gStrToPDN slDollar, 2, 6, tgRvf(ilRvf).sNet
                                                        llPartAcquisitionCost = gStrDecToLong(gDivStr(gMulStr(gLongToStrDec(llAcquisitionCost, 2), slPct), "100.00"), 2)
                                                        llRunAcquisitionCost = llRunAcquisitionCost + llPartAcquisitionCost
                                                        tgRvf(ilRvf).lAcquisitionCost = llPartAcquisitionCost
                                                    Else
                                                        slDollar = gSubStr(slGross, slRunGross)
                                                        gStrToPDN slDollar, 2, 6, tgRvf(ilRvf).sGross
                                                        slDollar = gSubStr(slNet, slRunNet)
                                                        gStrToPDN slDollar, 2, 6, tgRvf(ilRvf).sNet
                                                        tgRvf(ilRvf).lAcquisitionCost = llAcquisitionCost - llRunAcquisitionCost
                                                    End If
                                                    If (tmAdf.sRepInvGen = "E") And (tgMVef(ilVeh).sType = "R") Then
                                                        'If (Trim$(tgMVef(ilVeh).sExtUpdateRvf(ilLoop)) = "N") Then
                                                        If (Trim$(tmPif(ilLoop).sExtUpdateRvf) = "N") Or (ilUpdaterHistory_Installment) Or (ilUpdateHIOnly_RepAtNet) Then
                                                            tgRvf(ilRvf).sInvoiceUndone = "N"
                                                            tgRvf(ilRvf).sTranType = "HI"
                                                            ilRet = btrInsert(hmPhf, tgRvf(ilRvf), imRvfRecLen, INDEXKEY0)
                                                            If ilRet <> BTRV_ERR_NONE Then
                                                                If ilRet >= 30000 Then
                                                                    ilRet = csiHandleValue(0, 7)
                                                                End If
                                                                Print #hmMsg, "mUpdateInv: btrInsert-Point 1, Phf Error # " & Trim$(str$(ilRet))
                                                            End If
                                                        Else
                                                            tgRvf(ilRvf).sTranType = "IN"
                                                            'Save so that the dates can be restored
                                                            tlRvf = tgRvf(ilRvf)
                                                            If mTestUpdateRvf(tgRvf(ilRvf)) Then
                                                                tgRvf(ilRvf).sInvoiceUndone = "N"
                                                                tgRvf(ilRvf).iPnfBuyer = tmChf.iPnfBuyer
                                                                ilRet = btrInsert(hmRvf, tgRvf(ilRvf), imRvfRecLen, INDEXKEY0)
                                                                If ilRet <> BTRV_ERR_NONE Then
                                                                    If ilRet >= 30000 Then
                                                                        ilRet = csiHandleValue(0, 7)
                                                                    End If
                                                                    Print #hmMsg, "mUpdateInv: btrInsert-Point 2, Rvf Error # " & Trim$(str$(ilRet))
                                                                End If
                                                                If tgRvf(ilRvf).sTranType = "AN" Then
                                                                    lmANAddedRvf(UBound(lmANAddedRvf)) = tgRvf(ilRvf).lCode
                                                                    ReDim Preserve lmANAddedRvf(0 To UBound(lmANAddedRvf) + 1) As Long
                                                                    tgRvf(ilRvf) = tlRvf
                                                                End If
                                                            Else
                                                                ilRet = BTRV_ERR_NONE
                                                            End If
                                                        End If
                                                    Else
                                                        'If (Trim$(tgMVef(ilVeh).sUpdateRVF(ilLoop)) = "N") Or (Trim$(tgMVef(ilVeh).sUpdateRVF(ilLoop)) = "E") Then
                                                        If (Trim$(tmPif(ilLoop).sUpdateRVF) = "N") Or (Trim$(tmPif(ilLoop).sUpdateRVF) = "E") Or (ilUpdaterHistory_Installment) Or (ilUpdateHIOnly_RepAtNet) Then
                                                            tgRvf(ilRvf).sInvoiceUndone = "N"
                                                            tgRvf(ilRvf).sTranType = "HI"
                                                            ilRet = btrInsert(hmPhf, tgRvf(ilRvf), imRvfRecLen, INDEXKEY0)
                                                            If ilRet <> BTRV_ERR_NONE Then
                                                                If ilRet >= 30000 Then
                                                                    ilRet = csiHandleValue(0, 7)
                                                                End If
                                                                Print #hmMsg, "mUpdateInv: btrInsert-Point 3, Phf Error # " & Trim$(str$(ilRet))
                                                            End If
                                                        Else
                                                            tgRvf(ilRvf).sTranType = "IN"
                                                            'Save so that the dates can be restored
                                                            tlRvf = tgRvf(ilRvf)
                                                            If mTestUpdateRvf(tgRvf(ilRvf)) Then
                                                                tgRvf(ilRvf).sInvoiceUndone = "N"
                                                                tgRvf(ilRvf).iPnfBuyer = tmChf.iPnfBuyer
                                                                ilRet = btrInsert(hmRvf, tgRvf(ilRvf), imRvfRecLen, INDEXKEY0)
                                                                If ilRet <> BTRV_ERR_NONE Then
                                                                    If ilRet >= 30000 Then
                                                                        ilRet = csiHandleValue(0, 7)
                                                                    End If
                                                                    Print #hmMsg, "mUpdateInv: btrInsert-Point 4, Rvf Error # " & Trim$(str$(ilRet))
                                                                End If
                                                                If tgRvf(ilRvf).sTranType = "AN" Then
                                                                    lmANAddedRvf(UBound(lmANAddedRvf)) = tgRvf(ilRvf).lCode
                                                                    ReDim Preserve lmANAddedRvf(0 To UBound(lmANAddedRvf) + 1) As Long
                                                                    tgRvf(ilRvf) = tlRvf
                                                                End If
                                                            Else
                                                                ilRet = BTRV_ERR_NONE
                                                            End If
                                                        End If
                                                    End If
                                                    If ilRet <> BTRV_ERR_NONE Then
                                                        If ilRet >= 30000 Then
                                                            ilRet = csiHandleValue(0, 7)
                                                        End If
                                                        mUpdateInv = ilRet
                                                        'ilRet = btrAbortTrans(hmRvf)
                                                        Screen.MousePointer = vbDefault
                                                        gSetMousePointer grdAirTime, grdRevenue, vbDefault
                                                        ilRet = MsgBox("Update Not Completed, Try Later (Rvf Insert Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                                                        Screen.MousePointer = vbHourglass
                                                        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                                                        Exit Function
                                                    End If
                                                End If
                                            Next ilLoop
                                        End If
                                    'Next ilVeh
                                    'Reset so that advt; agy update is correct
                                    gStrToPDN slGross, 2, 6, tgRvf(ilRvf).sGross
                                    gStrToPDN slNet, 2, 6, tgRvf(ilRvf).sNet
                                    tgRvf(ilRvf).sTranType = "IN"
                                Else
                                    tgRvf(ilRvf).lCode = 0
                                    If mTestUpdateRvf(tgRvf(ilRvf)) Then
                                        If (ilUpdaterHistory_Installment) Or (ilUpdateHIOnly_RepAtNet) Then
                                            tgRvf(ilRvf).sInvoiceUndone = "N"
                                            tgRvf(ilRvf).sTranType = "HI"
                                            ilRet = btrInsert(hmPhf, tgRvf(ilRvf), imRvfRecLen, INDEXKEY0)
                                            If ilRet <> BTRV_ERR_NONE Then
                                                If ilRet >= 30000 Then
                                                    ilRet = csiHandleValue(0, 7)
                                                End If
                                                Print #hmMsg, "mUpdateInv: btrInsert-Point 5, Phf Error # " & Trim$(str$(ilRet))
                                            End If
                                        Else
                                            tgRvf(ilRvf).sInvoiceUndone = "N"
                                            tgRvf(ilRvf).iPnfBuyer = tmChf.iPnfBuyer
                                            ilRet = btrInsert(hmRvf, tgRvf(ilRvf), imRvfRecLen, INDEXKEY0)
                                            If ilRet <> BTRV_ERR_NONE Then
                                                If ilRet >= 30000 Then
                                                    ilRet = csiHandleValue(0, 7)
                                                End If
                                                Print #hmMsg, "mUpdateInv: btrInsert-Point 6, Rvf Error # " & Trim$(str$(ilRet))
                                            End If
                                        End If
                                        If ilRet <> BTRV_ERR_NONE Then
                                            If ilRet >= 30000 Then
                                                ilRet = csiHandleValue(0, 7)
                                            End If
                                            mUpdateInv = ilRet
                                            'ilRet = btrAbortTrans(hmRvf)
                                            Screen.MousePointer = vbDefault
                                            gSetMousePointer grdAirTime, grdRevenue, vbDefault
                                            ilRet = MsgBox("Update Not Completed, Try Later (Rvf Insert Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                                            Screen.MousePointer = vbHourglass
                                            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                                            Exit Function
                                        End If
                                        lmANAddedRvf(UBound(lmANAddedRvf)) = tgRvf(ilRvf).lCode
                                        ReDim Preserve lmANAddedRvf(0 To UBound(lmANAddedRvf) + 1) As Long
                                    End If
                                End If
                            Else
                                tgRvf(ilRvf).lCode = 0
                                If (Not ilUpdateRvf) Or (ilUpdaterHistory_Installment) Or (ilUpdateHIOnly_RepAtNet) Then
                                    tgRvf(ilRvf).sInvoiceUndone = "N"
                                    tgRvf(ilRvf).sTranType = "HI"
                                    ilRet = btrInsert(hmPhf, tgRvf(ilRvf), imRvfRecLen, INDEXKEY0)
                                    If ilRet <> BTRV_ERR_NONE Then
                                        If ilRet >= 30000 Then
                                            ilRet = csiHandleValue(0, 7)
                                        End If
                                        Print #hmMsg, "mUpdateInv: btrInsert-Point 7, Phf Error # " & Trim$(str$(ilRet))
                                    End If
                                Else
                                    If mTestUpdateRvf(tgRvf(ilRvf)) Then
                                        tgRvf(ilRvf).sInvoiceUndone = "N"
                                        tgRvf(ilRvf).iPnfBuyer = tmChf.iPnfBuyer
                                        ilRet = btrInsert(hmRvf, tgRvf(ilRvf), imRvfRecLen, INDEXKEY0)
                                        If ilRet <> BTRV_ERR_NONE Then
                                            If ilRet >= 30000 Then
                                                ilRet = csiHandleValue(0, 7)
                                            End If
                                            Print #hmMsg, "mUpdateInv: btrInsert-Point 8, Rvf Error # " & Trim$(str$(ilRet))
                                        End If
                                        lmANAddedRvf(UBound(lmANAddedRvf)) = tgRvf(ilRvf).lCode
                                        ReDim Preserve lmANAddedRvf(0 To UBound(lmANAddedRvf) + 1) As Long
                                    Else
                                        ilRet = BTRV_ERR_NONE
                                    End If
                                End If
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    mUpdateInv = ilRet
                                    'ilRet = btrAbortTrans(hmRvf)
                                    Screen.MousePointer = vbDefault
                                    gSetMousePointer grdAirTime, grdRevenue, vbDefault
                                    ilRet = MsgBox("Update Not Completed, Try Later (Rvf Insert Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                                    Screen.MousePointer = vbHourglass
                                    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                                    Exit Function
                                End If
                            End If
                            If imPrintRepInv <> True Then
                                Do
                                    ilRet = btrGetFirst(hlSpf, tgSpf, Len(tgSpf), 0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                                    If ilRet <> BTRV_ERR_NONE Then
                                        If ilRet >= 30000 Then
                                            ilRet = csiHandleValue(0, 7)
                                        End If
                                        mUpdateInv = ilRet
                                        'ilRet = btrAbortTrans(hmRvf)
                                        Screen.MousePointer = vbDefault
                                        gSetMousePointer grdAirTime, grdRevenue, vbDefault
                                        ilRet = MsgBox("Update Not Completed, Try Later (Spf GetFirst Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                                        Screen.MousePointer = vbHourglass
                                        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                                        Exit Function
                                    End If
                                    tgSpf.lBNextNo = tgRvf(ilRvf).lInvNo + 1
                                    ilRet = btrUpdate(hlSpf, tgSpf, Len(tgSpf))
                                Loop While ilRet = BTRV_ERR_CONFLICT
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    Print #hmMsg, "mUpdateInv: btrUpdate-Point 1, Spf Error # " & Trim$(str$(ilRet))
                                End If
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    mUpdateInv = ilRet
                                    'ilRet = btrAbortTrans(hmRvf)
                                    Screen.MousePointer = vbDefault
                                    gSetMousePointer grdAirTime, grdRevenue, vbDefault
                                    ilRet = MsgBox("Update Not Completed, Try Later (Spf Update Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                                    Screen.MousePointer = vbHourglass
                                    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                                    Exit Function
                                End If
                            End If
                            If tgRvf(ilRvf).sCashTrade <> "T" Then
                                If tgRvf(ilRvf).sTranType <> "HI" Then  'bypass records not updating rvf
                                    gPDNToStr tgRvf(ilRvf).sGross, 2, slGross
                                    llGross = gStrDecToLong(slGross, 2)
                                    gPDNToStr tgRvf(ilRvf).sNet, 2, slNet
                                    llNet = gStrDecToLong(slNet, 2)
                                    If tgRvf(ilRvf).iAgfCode > 0 Then
                                        ilFound = False
                                        For ilLoop = LBound(tgUpdateAgf) To UBound(tgUpdateAgf) - 1 Step 1
                                            If (tgUpdateAgf(ilLoop).iCode = tgRvf(ilRvf).iAgfCode) Then
                                                ilFound = True
                                                tgUpdateAgf(ilLoop).lGross = tgUpdateAgf(ilLoop).lGross + llGross
                                                tgUpdateAgf(ilLoop).lNet = tgUpdateAgf(ilLoop).lNet + llNet
                                                Exit For
                                            End If
                                        Next ilLoop
                                        If Not ilFound Then
                                            tgUpdateAgf(UBound(tgUpdateAgf)).iCode = tgRvf(ilRvf).iAgfCode
                                            tgUpdateAgf(UBound(tgUpdateAgf)).lGross = llGross
                                            tgUpdateAgf(UBound(tgUpdateAgf)).lNet = llNet
                                            tgUpdateAgf(UBound(tgUpdateAgf)).iTranDate(0) = tgRvf(ilRvf).iTranDate(0)
                                            tgUpdateAgf(UBound(tgUpdateAgf)).iTranDate(1) = tgRvf(ilRvf).iTranDate(1)
                                            ReDim Preserve tgUpdateAgf(0 To UBound(tgUpdateAgf) + 1) As UPDATEADFAGF
                                        End If
                                    End If
                                    ilFound = False
                                    For ilLoop = LBound(tgUpdateAdf) To UBound(tgUpdateAdf) - 1 Step 1
                                        If (tgUpdateAdf(ilLoop).iCode = tgRvf(ilRvf).iAdfCode) Then
                                            ilFound = True
                                            tgUpdateAdf(ilLoop).lGross = tgUpdateAdf(ilLoop).lGross + llGross
                                            tgUpdateAdf(ilLoop).lNet = tgUpdateAdf(ilLoop).lNet + llNet
                                            Exit For
                                        End If
                                    Next ilLoop
                                    If Not ilFound Then
                                        tgUpdateAdf(UBound(tgUpdateAdf)).iCode = tgRvf(ilRvf).iAdfCode
                                        tgUpdateAdf(UBound(tgUpdateAdf)).lGross = llGross
                                        tgUpdateAdf(UBound(tgUpdateAdf)).lNet = llNet
                                        tgUpdateAdf(UBound(tgUpdateAdf)).iTranDate(0) = tgRvf(ilRvf).iTranDate(0)
                                        tgUpdateAdf(UBound(tgUpdateAdf)).iTranDate(1) = tgRvf(ilRvf).iTranDate(1)
                                        ReDim Preserve tgUpdateAdf(0 To UBound(tgUpdateAdf) + 1) As UPDATEADFAGF
                                    End If
                                End If
                            End If
                        End If
                    End If
                Next ilRvf
            End If
            If (tgSortKey(llSdfIndex).iBilled) And (tgSortKey(llSdfIndex).iType = 0) Then 'Billed and Sdf record type
                Do
                    'ilRet = btrGetDirect(hmSdf, tmSdf, imSdfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        mUpdateInv = ilRet
                        'ilRet = btrAbortTrans(hmRvf)
                        Screen.MousePointer = vbDefault
                        gSetMousePointer grdAirTime, grdRevenue, vbDefault
                        ilRet = MsgBox("Update Not Completed, Try Later (Sdf GetDirect Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                        Screen.MousePointer = vbHourglass
                        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                        Exit Function
                    End If
                    '3/16/11: Use the schedule status of the spot when invoicing started.
                    '         This is to avoid spots originally in missed, moved as MG during invoicing in the spot screen being set as Billed.
                    'If (tgSortKey(llSdfIndex).iBillMissed) And (tmSdf.sSchStatus = "M") Then
                    If (tgSortKey(llSdfIndex).iBillMissed) And (tgSortKey(llSdfIndex).sSchStatus = "M") Then
                    Else
                        '3/16/11: Use the schedule status of the spot when invoicing started.
                        '         This is to avoid spots originally in missed, moved as MG during invoicing in the spot screen being set as Billed.
                        'If (tmSdf.sSchStatus <> "S") And (tmSdf.sSchStatus <> "O") And (tmSdf.sSchStatus <> "G") And (tmSdf.sSchStatus <> "C") Then
                        If (tgSortKey(llSdfIndex).sSchStatus <> "S") And (tgSortKey(llSdfIndex).sSchStatus <> "O") And (tgSortKey(llSdfIndex).sSchStatus <> "G") And (tgSortKey(llSdfIndex).sSchStatus <> "C") Then
                            If (tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") Then
                                Exit Do
                            End If
                        End If
                    End If
                    'tmRec = tmSdf
                    'ilRet = gGetByKeyForUpdate("SDF", hmSdf, tmRec)
                    'tmSdf = tmRec
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    mUpdateInv = ilRet
                    '    'ilRet = btrAbortTrans(hmRvf)
                    '    Screen.MousePointer = vbDefault
                    '    ilRet = MsgBox("Update Not Completed, Try Later (Sdf GetByKey Error" & Str$(ilRet) & ")", vbOkOnly + vbExclamation, "Invoice")
                    '    Screen.MousePointer = vbHourGlass
                    '    Exit Function
                    'End If
                    tmSdf.sBill = "Y"
                    ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
                Loop While ilRet = BTRV_ERR_CONFLICT
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    Print #hmMsg, "mUpdateInv: btrUpdate-Point 2, Sdf Error # " & Trim$(str$(ilRet))
                End If
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    mUpdateInv = ilRet
                    'ilRet = btrAbortTrans(hmRvf)
                    Screen.MousePointer = vbDefault
                    gSetMousePointer grdAirTime, grdRevenue, vbDefault
                    ilRet = MsgBox("Update Not Completed, Try Later (Sdf Update Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                    Screen.MousePointer = vbHourglass
                    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                    Exit Function
                End If
            End If
            'If (tgSortKey(llSdfIndex).iBilled) And (tgSortKey(llSdfIndex).iType = 1) And ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) Then 'Billed and Smf record type
            If (tgSortKey(llSdfIndex).iBilled) And (tgSortKey(llSdfIndex).iType = 1) Then 'And ((tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S")) Then 'Billed and Smf record type
                Do
                    'ilRet = btrGetDirect(hmSmf, tmSmf, imSmfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSmfSrchKey1.lCode = tgSortKey(llSdfIndex).lCode
                    ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        mUpdateInv = ilRet
                        'ilRet = btrAbortTrans(hmRvf)
                        Screen.MousePointer = vbDefault
                        gSetMousePointer grdAirTime, grdRevenue, vbDefault
                        ilRet = MsgBox("Update Not Completed, Try Later (Smf GetDirect Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                        Screen.MousePointer = vbHourglass
                        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                        Exit Function
                    End If
                    tmSdfSrchKey3.lCode = tmSmf.lSdfCode
                    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        mUpdateInv = ilRet
                        'ilRet = btrAbortTrans(hmRvf)
                        Screen.MousePointer = vbDefault
                        gSetMousePointer grdAirTime, grdRevenue, vbDefault
                        ilRet = MsgBox("Update Not Completed, Try Later (Sdf GetEqual Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                        Screen.MousePointer = vbHourglass
                        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                        Exit Function
                    End If
                    tmSdf.sBill = "Y"
                    ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
                Loop While ilRet = BTRV_ERR_CONFLICT
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    Print #hmMsg, "mUpdateInv: btrUpdate-Point 3, Sdf Error # " & Trim$(str$(ilRet))
                End If
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    mUpdateInv = ilRet
                    'ilRet = btrAbortTrans(hmRvf)
                    Screen.MousePointer = vbDefault
                    gSetMousePointer grdAirTime, grdRevenue, vbDefault
                    ilRet = MsgBox("Update Not Completed, Try Later (Sdf Update Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                    Screen.MousePointer = vbHourglass
                    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                    Exit Function
                End If
            End If
            If (tgSortKey(llSdfIndex).iBilled) And (tgSortKey(llSdfIndex).iType = 2) Then 'Billed and Psf record type
                Do
                    'ilRet = btrGetDirect(hmPsf, tmPsf, imPsfRecLen, tgSortKey(llSdfIndex).lRecPos, INDEXKEY0, BTRV_LOCK_NONE)
                    tmSdfSrchKey3.lCode = tgSortKey(llSdfIndex).lCode
                    ilRet = btrGetEqual(hmPsf, tmPsf, imPsfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                    If ilRet <> BTRV_ERR_NONE Then
                        If ilRet >= 30000 Then
                            ilRet = csiHandleValue(0, 7)
                        End If
                        mUpdateInv = ilRet
                        'ilRet = btrAbortTrans(hmRvf)
                        Screen.MousePointer = vbDefault
                        gSetMousePointer grdAirTime, grdRevenue, vbDefault
                        ilRet = MsgBox("Update Not Completed, Try Later (Psf GetDirect Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                        Screen.MousePointer = vbHourglass
                        gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                        Exit Function
                    End If
                    'tmRec = tmPsf
                    'ilRet = gGetByKeyForUpdate("PSF", hmPsf, tmRec)
                    'tmPsf = tmRec
                    'If ilRet <> BTRV_ERR_NONE Then
                    '    mUpdateInv = ilRet
                    '    'ilRet = btrAbortTrans(hmRvf)
                    '    Screen.MousePointer = vbDefault
                    '    ilRet = MsgBox("Update Not Completed, Try Later (Psf GetByKey Error" & Str$(ilRet) & ")", vbOkOnly + vbExclamation, "Invoice")
                    '    Screen.MousePointer = vbHourGlass
                    '    Exit Function
                    'End If
                    tmPsf.sBill = "Y"
                    ilRet = btrUpdate(hmPsf, tmPsf, imPsfRecLen)
                Loop While ilRet = BTRV_ERR_CONFLICT
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    Print #hmMsg, "mUpdateInv: btrUpdate-Point 4, Psf Error # " & Trim$(str$(ilRet))
                End If
                If ilRet <> BTRV_ERR_NONE Then
                    If ilRet >= 30000 Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    mUpdateInv = ilRet
                    'ilRet = btrAbortTrans(hmRvf)
                    Screen.MousePointer = vbDefault
                    gSetMousePointer grdAirTime, grdRevenue, vbDefault
                    ilRet = MsgBox("Update Not Completed, Try Later (Psf Update Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                    Screen.MousePointer = vbHourglass
                    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                    Exit Function
                End If
            End If
            If (tgSortKey(llSdfIndex).iBilled) And (tgSortKey(llSdfIndex).iType = 10) Then 'Billed and Sbf record type
                For ilLoop = LBound(tgSbfCntr) To UBound(tgSbfCntr) - 1 Step 1
                    ''If tgSbfCntr(ilLoop).tSbf.lChfCode = tgSortKey(llSdfIndex).lChfCode Then
                    'Removed the date test as it did not work when billing NTR from past months
                    'This was added to help speed up the update
                    'If (tgSbfCntr(ilLoop).tSbf.lChfCode = tgSortKey(llSdfIndex).lChfCode) And (tgSbfCntr(ilLoop).lSDate = tgSortKey(llSdfIndex).lSbfDate) Then
                    'If (tgSbfCntr(ilLoop).tSbf.lChfCode = tgSortKey(llSdfIndex).lChfCode) Then
                    If (tgSbfCntr(ilLoop).tSbf.lChfCode = tgSortKey(llSdfIndex).lChfCode) And ((tgSbfCntr(ilLoop).tSbf.iMnfItem > 0) Or ((tgSbfCntr(ilLoop).tSbf.iMnfItem = 0) And (tgSbfCntr(ilLoop).lSDate = tgSortKey(llSdfIndex).lSbfDate))) Then
                        Do
                            tmSbfSrchKey1.lCode = tgSbfCntr(ilLoop).tSbf.lCode
                            ilRet = btrGetEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                            If ilRet <> BTRV_ERR_NONE Then
                                If ilRet >= 30000 Then
                                    ilRet = csiHandleValue(0, 7)
                                End If
                                mUpdateInv = ilRet
                                'ilRet = btrAbortTrans(hmRvf)
                                Screen.MousePointer = vbDefault
                                gSetMousePointer grdAirTime, grdRevenue, vbDefault
                                ilRet = MsgBox("Update Not Completed, Try Later (Sbf GetEqual Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                                Screen.MousePointer = vbHourglass
                                gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                                Exit Function
                            End If
                            If (ckcType(INVTYPE_PrintRep).Value = vbChecked) And (tmSbf.sTranType = "T") Then    'Print Rep Invoices
                                gPackDateLong lmNowDate, tmSbf.iPrintInvDate(0), tmSbf.iPrintInvDate(1)
                            End If
                            If (ckcType(INVTYPE_NTR).Value = vbChecked) And (tmSbf.sTranType = "I") Then    'Print Rep Invoices
                                gPackDateLong lmNowDate, tmSbf.iPrintInvDate(0), tmSbf.iPrintInvDate(1)
                            End If
                            tmSbf.sBilled = "Y"
                            ilRet = btrUpdate(hmSbf, tmSbf, imSbfRecLen)
                        Loop While ilRet = BTRV_ERR_CONFLICT
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            Print #hmMsg, "mUpdateInv: btrUpdate-Point 5, Sbf Error # " & Trim$(str$(ilRet))
                        End If
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            mUpdateInv = ilRet
                            'ilRet = btrAbortTrans(hmRvf)
                            Screen.MousePointer = vbDefault
                            gSetMousePointer grdAirTime, grdRevenue, vbDefault
                            ilRet = MsgBox("Update Not Completed, Try Later (Sbf Update Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                            Screen.MousePointer = vbHourglass
                            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                            Exit Function
                        End If
                        'Update Game Inventory
                        ilRet = mUpdateGameInv(tmSbf)
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            mUpdateInv = ilRet
                            'ilRet = btrAbortTrans(hmRvf)
                            Screen.MousePointer = vbDefault
                            gSetMousePointer grdAirTime, grdRevenue, vbDefault
                            ilRet = MsgBox("Update Not Completed, Try Later (Mgf Update Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                            Screen.MousePointer = vbHourglass
                            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                            Exit Function
                        End If
                    End If
                Next ilLoop
                For ilLoop = LBound(tgSbfInstall) To UBound(tgSbfInstall) - 1 Step 1
                    '''If tgSbfInstall(ilLoop).tSbf.lChfCode = tgSortKey(llSdfIndex).lChfCode Then
                    ''Removed the date test as it did not work when billing NTR from past months
                    ''This was added to help speed up the update
                    ''If (tgSbfInstall(ilLoop).tSbf.lChfCode = tgSortKey(llSdfIndex).lChfCode) And (tgSbfInstall(ilLoop).lSDate = tgSortKey(llSdfIndex).lSbfDate) Then
                    ''If (tgSbfInstall(ilLoop).tSbf.lChfCode = tgSortKey(llSdfIndex).lChfCode) Then
                    'If (tgSbfInstall(ilLoop).tSbf.lChfCode = tgSortKey(llSdfIndex).lChfCode) And ((tgSbfInstall(ilLoop).tSbf.iMnfItem > 0) Or ((tgSbfInstall(ilLoop).tSbf.iMnfItem = 0) And (tgSbfInstall(ilLoop).lSDate = tgSortKey(llSdfIndex).lSbfDate))) Then
                    'Remove the date test as only one tgSortKey is created and the tgSbfInstall might have different dates for the same contract
                    'This was causing double billing.  First tgSbfInstall had a date of 3/31/08 (from NTR) and other transactions had a date of 4/27/08 (from games)
                    If (tgSbfInstall(ilLoop).tSbf.lChfCode = tgSortKey(llSdfIndex).lChfCode) Then
                        Do
                            tmSbfSrchKey1.lCode = tgSbfInstall(ilLoop).tSbf.lCode
                            ilRet = btrGetEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
                            If ilRet <> BTRV_ERR_NONE Then
                                If ilRet >= 30000 Then
                                    ilRet = csiHandleValue(0, 7)
                                End If
                                mUpdateInv = ilRet
                                'ilRet = btrAbortTrans(hmRvf)
                                Screen.MousePointer = vbDefault
                                gSetMousePointer grdAirTime, grdRevenue, vbDefault
                                ilRet = MsgBox("Update Not Completed, Try Later (Sbf GetEqual Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                                Screen.MousePointer = vbHourglass
                                gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                                Exit Function
                            End If
                            gPackDateLong lmNowDate, tmSbf.iPrintInvDate(0), tmSbf.iPrintInvDate(1)
                            tmSbf.sBilled = "Y"
                            ilRet = btrUpdate(hmSbf, tmSbf, imSbfRecLen)
                        Loop While ilRet = BTRV_ERR_CONFLICT
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            Print #hmMsg, "mUpdateInv: btrUpdate-Point 6, Sbf Error # " & Trim$(str$(ilRet))
                        End If
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            mUpdateInv = ilRet
                            'ilRet = btrAbortTrans(hmRvf)
                            Screen.MousePointer = vbDefault
                            gSetMousePointer grdAirTime, grdRevenue, vbDefault
                            ilRet = MsgBox("Update Not Completed, Try Later (Sbf Update Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                            Screen.MousePointer = vbHourglass
                            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                            Exit Function
                        End If
                    End If
                Next ilLoop
            End If
            If (tgSortKey(llSdfIndex).iBilled) And (tgSortKey(llSdfIndex).iType = 11) Then 'Billed and Pcf/Ibf record type
                ilRet = mSetCPMBillFlag(llSdfIndex)
                If ilRet <> BTRV_ERR_NONE Then
                    mUpdateInv = ilRet
                    Screen.MousePointer = vbDefault
                    gSetMousePointer Invoice.grdAirTime, Invoice.grdRevenue, vbDefault
                    ilRet = MsgBox("Update Not Completed, Try Later (Ibf GetEqual Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                    Screen.MousePointer = vbHourglass
                    gSetMousePointer Invoice.grdAirTime, Invoice.grdRevenue, vbHourglass
                    Exit Function
                End If
            End If
            
            llSdfIndex = llSdfIndex + 1
        Loop While llSdfIndex <= UBound(tgSortKey) - 1
        '6/6/16: Replaced GoSub
        'GoSub UpdateAdfAgfSub
        If Not mUpdateAdfAgfSub(ilRet) Then
            mUpdateInv = ilRet
            Exit Function
        End If
        mUpdateInv = BTRV_ERR_NONE
        ilRet = btrClose(hlSpf)
        btrDestroy hlSpf
        mAddApf
    Else
        mUpdateInv = BTRV_ERR_NONE
    End If
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mVehPop                         *
'*                                                     *
'*             Created:5/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Populate the selection combo   *
'*                      box                            *
'*                                                     *
'*******************************************************
Private Sub mVehPop()
    Dim ilRet As Integer
    Dim llVehEarliestDate As Long
    Dim llVehLatestDate As Long
    Dim llVehEarliestUnComplete As Long
    Dim slNameCode As String
    Dim slName As String
    Dim slCode As String
    Dim ilLoop As Integer
    Dim ilVefCode As Integer
    'Include DORMANTVEH incase user set vehicle as dormant prior to invoicing
    'ilRet = gPopUserVehicleBox(Invoice, VEHCONV_WO_FEED + VEHCONV_W_FEED + VEHSELLING + VEHVIRTUAL + ACTIVEVEH + DORMANTVEH, lbcVehicle, Traffic!lbcVehicle)
    ilRet = gPopUserVehicleBox(Invoice, VEHCONV_WO_FEED + VEHCONV_W_FEED + VEHSELLING + VEHNTR + VEHVIRTUAL + ACTIVEVEH + DORMANTVEH, lbcVehicle, tmInvVehicle(), smInvVehicleTag)
    If ilRet <> CP_MSG_NOPOPREQ Then
        On Error GoTo mVehPopErr
        gCPErrorMsg ilRet, "mVehPop (gPopUserVehicleBox)", Invoice
        On Error GoTo 0
    End If
    lbcVehicle.Clear
    ckcAll.Value = vbUnchecked  '10-31-01 False
    ReDim tgNotMarkComplete(0 To 0) As NOTMARKCOMPLETE
    'Add last completed date
    For ilLoop = UBound(tmInvVehicle) - 1 To 0 Step -1 'Traffic!lbcVehicle.ListCount - 1 To 0 Step -1
        slNameCode = tmInvVehicle(ilLoop).sKey    'Traffic!lbcVehicle.List(ilLoop)
        ilRet = gParseItem(slNameCode, 1, "\", slName)    'Get application name
        ilRet = gParseItem(slName, 3, "|", slName)    'Get application name
        ilRet = gParseItem(slNameCode, 2, "\", slCode)    'Get application name
        ilVefCode = Val(slCode)
        mLastCompletedDate ilVefCode, llVehEarliestDate, llVehLatestDate, llVehEarliestUnComplete
        If llVehEarliestDate = -1 Then  'Remove vehicle
            'gRemoveItemFromSortCode ilLoop, tmInvVehicle()
            'Show all vehicles, in case mg or outside scheduled passed end of vehicle
            lbcVehicle.AddItem slName, 0
        ElseIf llVehEarliestDate = 0 Then
            lbcVehicle.AddItem slName, 0
        Else
            lbcVehicle.AddItem slName & " " & Format$(llVehLatestDate, "m/d/yy"), 0
        End If
    Next ilLoop
    mSetViewControl
    'ckcAll.Value = vbChecked    '10-31-01 True
    Exit Sub
mVehPopErr:
    Screen.MousePointer = vbDefault
    gSetMousePointer grdAirTime, grdRevenue, vbDefault
    On Error GoTo 0
    imTerminate = True
    Exit Sub
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mWriteExportRec                 *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Write export record            *
'*                                                     *
'*******************************************************
Function mWriteExportRec(ilStartRvf As Integer) As Integer
    Dim slCntrNo As String
    Dim slBillDate As String
    Dim slInvNo As String
    Dim slCashTrade As String
    Dim slBillVehicle As String
    Dim slAirVehicle As String
    Dim slLnVehicle As String
    Dim slGross As String
    Dim slNet As String
    Dim slTax1 As String
    Dim slTax2 As String
    Dim slBillNoSpots As String
    Dim slAirNoSpots As String
    Dim slBonusNoSpots As String
    Dim slCombineID As String
    Dim slOGross As String
    Dim slCommPct As String
    Dim ilVeh As Integer
    Dim slStr As String
    Dim ilRvf As Integer
    Dim slFlightPrice As String

    If Not imExportCntr Then
        mWriteExportRec = True
        Exit Function
    End If
    If imRemoteCntr Then
        mWriteExportRec = True
        Exit Function
    End If
    If rbcType(INVGEN_Aff).Value Then
        mWriteExportRec = True
        Exit Function
    End If
    'First record for contract will contain the total order spots for the billing period
    'Each record will contain the Aired spots for the vehicle within the contract
    'Note: Virtual will be the virtual spots; real will be from scheduled spots
    For ilRvf = ilStartRvf To UBound(tgRvf) - 1 Step 1
        If (tmChf.iPctTrade = 0) Or (tmChf.iPctTrade = 100) Or (tgRvf(ilRvf).sCashTrade = "C") Then
            slCntrNo = Trim$(str$(tmChf.lCntrNo))
            If tmChf.sBillCycle = "C" Then
                slBillDate = smEndCal
            ElseIf tmChf.sBillCycle = "W" Then
                slBillDate = smEndWk
            Else
                slBillDate = smEndStd
            End If
            slInvNo = Trim$(str$(tgRvf(ilRvf).lInvNo))
            If (tmChf.iPctTrade = 0) Or (tmChf.iPctTrade = 100) Then
                slCashTrade = tgRvf(ilRvf).sCashTrade
            Else
                slCashTrade = "B"
            End If
            slBillVehicle = ""
            'For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
            '    If tgMVef(ilVeh).iCode = tgRvf(ilRvf).iBillVefCode Then
                ilVeh = gBinarySearchVef(tgRvf(ilRvf).iBillVefCode)
                If ilVeh <> -1 Then
                    slBillVehicle = Trim$(tgMVef(ilVeh).sName)
            '        Exit For
                End If
            'Next ilVeh
            slAirVehicle = ""
            'For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
            '    If tgMVef(ilVeh).iCode = tgRvf(ilRvf).iAirVefCode Then
                ilVeh = gBinarySearchVef(tgRvf(ilRvf).iAirVefCode)
                If ilVeh <> -1 Then
                    slAirVehicle = Trim$(tgMVef(ilVeh).sName)
            '        Exit For
                End If
            'Next ilVeh
            slLnVehicle = ""
            'For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
            '    If tgMVef(ilVeh).iCode = tgExportCount(ilRvf - ilStartRvf).iLnVefCode Then
                ilVeh = gBinarySearchVef(tgExportCount(ilRvf - ilStartRvf).iLnVefCode)
                If ilVeh <> -1 Then
                    slLnVehicle = Trim$(tgMVef(ilVeh).sName)
            '        Exit For
                End If
            'Next ilVeh
            gPDNToStr tgRvf(ilRvf).sGross, 2, slGross
            gPDNToStr tgRvf(ilRvf).sNet, 2, slNet
            slTax1 = gLongToStrDec(lmTax1, 2)
            slTax2 = gLongToStrDec(lmTax2, 2)
            slBillNoSpots = Trim$(str$(tgExportCount(ilRvf - ilStartRvf).lONoSpots))
            slAirNoSpots = Trim$(str$(tgExportCount(ilRvf - ilStartRvf).lANoSpots))
            slBonusNoSpots = Trim$(str$(tgExportCount(ilRvf - ilStartRvf).lBNoSpots))
            slCombineID = Trim$(str$(tgExportCount(ilRvf - ilStartRvf).iCombineID))
            slOGross = gLongToStrDec(tgExportCount(ilRvf - ilStartRvf).lOGross, 2)
            slCommPct = gIntToStrDec(tgExportCount(ilRvf - ilStartRvf).iCommPct, 2)
            slFlightPrice = gLongToStrDec(tgExportCount(ilRvf - ilStartRvf).lPrice, 2)
            slStr = slCntrNo
            slStr = slStr & ", " & slBillDate
            slStr = slStr & ", " & slInvNo
            slStr = slStr & ", " & slCashTrade
            slStr = slStr & ", " & """" & slBillVehicle & """"
            slStr = slStr & ", " & """" & slAirVehicle & """"
            slStr = slStr & ", " & slGross
            slStr = slStr & ", " & slNet
            slStr = slStr & ", " & slTax1
            slStr = slStr & ", " & slTax2
            slStr = slStr & ", " & slBillNoSpots
            slStr = slStr & ", " & slAirNoSpots
            slStr = slStr & ", " & slBonusNoSpots
            slStr = slStr & ", " & slCombineID
            slStr = slStr & ", " & smNowDate
            slStr = slStr & ", " & slOGross
            slStr = slStr & ", " & slCommPct
            slStr = slStr & ", " & slFlightPrice
            slStr = slStr & ", " & """" & slLnVehicle & """"
            Print #hmExport, slStr
            imCntrExported = True
        End If
    Next ilRvf
    mWriteExportRec = True
End Function

Private Sub lbcView_Click()
    If lbcView.ListItems.Count = 0 Then Exit Sub
    If lbcView.SelectedItem.Index >= 1 Then
        If lbcView.ListItems.Item(lbcView.SelectedItem.Index).Selected Then
            lbcView.ListItems.Item(lbcView.SelectedItem.Index).Selected = False
        End If
    End If
End Sub

'JW fix lbcView
Private Sub lbcView_ColumnClick(ByVal ColumnHeader As ComctlLib.ColumnHeader)
    If ColumnHeader.Text = "X" Then
        lbcView.Visible = False
        lbcView.Top = Me.ScaleHeight + 100
    End If
End Sub

Private Sub lbcWeek_Click()
    If (rbcAdvt(1).Value) And (Not imIgnoreSelAdvtRequest) Then
        mSelAdvt
    End If
End Sub

Private Sub cbcWeek_Click()
    If (rbcAdvt(1).Value) And cbcWeek.ListIndex >= 0 And (Not imIgnoreSelAdvtRequest) Then
        mSelAdvt
    End If
End Sub


Private Sub pbcClickFocus_GotFocus()
    lacUndoReason.Visible = False
    imButtonIndex = -1
    'If plcUnbilled.Visible Then
    '    plcUnbilled.Visible = False
    '    plcFromLine.Enabled = True
    'End If
End Sub

Private Sub pbcClickFocus_KeyUp(KeyCode As Integer, Shift As Integer)
    If KeyCode = KEYF1 Then    'Functio key 1= Help
        Traffic!cdcSetup.HelpFile = sgHelpPath & "traffic.hlp"
        Traffic!cdcSetup.HelpCommand = cdlHelpIndex
        Traffic!cdcSetup.Action = 6
    End If
End Sub

Private Sub pbcPrinting_Paint()
    pbcPrinting.CurrentX = (pbcPrinting.Width - pbcPrinting.TextWidth("Printing Invoice Information....")) / 2
    pbcPrinting.CurrentY = (pbcPrinting.Height - pbcPrinting.TextHeight("Printing Invoice Information....")) / 2 - 30
    pbcPrinting.Print "Printing Log Check Information...."
End Sub

Private Sub plcFromLine_Click()
    pbcClickFocus.SetFocus
End Sub

Private Sub plcFromLine_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    lacUndoReason.Visible = False
    imButtonIndex = -1
End Sub

Private Sub plcInvSpotTimeZone_Paint()
    plcInvSpotTimeZone.CurrentX = 0
    plcInvSpotTimeZone.CurrentY = -30
    plcInvSpotTimeZone.Print "Change Invoice Spot Times to"
End Sub

Private Sub plcScreen_Click()
    pbcClickFocus.SetFocus
End Sub

Private Sub rbcAdvt_Click(Index As Integer)
    'Code added because Value removed as parameter
    Dim Value As Integer
    Value = rbcAdvt(Index).Value
    'End of coded added
    Dim ilValue As Integer
    Dim llRg As Long
    Dim llRet As Long
    Dim ilAdvt As Integer
    Dim llRow As Long
    If Value Then
        If Index = 0 Then
            ''lbcAdvt.Enabled = False
            ''ilValue = True
            ''If lbcAdvt.ListCount > 0 Then
            ''    llRg = CLng(lbcAdvt.ListCount - 1) * &H10000 Or 0
            ''    llRet = SendMessageByNum(lbcAdvt.hwnd, LB_SELITEMRANGE, ilValue, llRg)
            ''End If
            ''lbcAdvt.Clear
            ''pbcLbcAdvt.Cls
            'mClearRevenueGrid
            '4/24/14: ask password undo
            If rbcType(INVGEN_Undo).Value Then
                If (igWinStatus(INVOICESJOB) = 1) And (Trim$(tgUrf(0).sName) <> sgCPName) And (Trim$(tgUrf(0).sName) <> sgSUName) Then
                    igPasswordOk = False
                ElseIf (Trim$(tgUrf(0).sName) = sgCPName) Then
                    igPasswordOk = True
                Else
                    sgPasswordAddition = "Replace: Undoing All Invoices is a serious step and should not be done lightly.  Call Counterpoint to explain why and get a new Keycode"
                    CSPWord.Show vbModal
                End If
                If Not igPasswordOk Then
                    rbcAdvt(0).Value = False
                    rbcAdvt(1).Value = True
                    Screen.MousePointer = vbDefault
                    gSetMousePointer grdAirTime, grdRevenue, vbDefault
                    Exit Sub
                End If
                For llRow = grdRevenue.FixedRows To grdRevenue.rows - 1 Step 1
                    If grdRevenue.TextMatrix(llRow, ADVTINDEX) <> "" Then
                        ilAdvt = grdRevenue.TextMatrix(llRow, INDEXCODEINDEX)
                        If (tmRPSelInfo(ilAdvt).iSelAllowed) Then
                            grdRevenue.TextMatrix(llRow, SELECTEDINDEX) = "1"
                        Else
                            grdRevenue.TextMatrix(llRow, SELECTEDINDEX) = "0"
                            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                            If grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) <> "-1" Or grdRevenue.TextMatrix(llRow, CNTRNOINDEX) = "" Then
                                grdRevenue.TextMatrix(llRow, EMAILINDEX) = ""
                                grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) = "0"
                            End If
                        End If
                        mPaintRevenueRowColor llRow
                    End If
                Next llRow
            Else
                mClearRevenueGrid
            End If
        Else
            mSelAdvt
        End If
    End If
    mSetGridColumns
End Sub

Private Sub ckcBillCycle_Click(Index As Integer)
    If ckcBillCycle(Index).Value = vbChecked Then
        If Index = 0 Then
            lacStdDates.Caption = smStdDateMsg
        ElseIf Index = 1 Then
            lacCalDates.Caption = smCalDateMsg
        ElseIf Index = 2 Then
            lacWkDates.Caption = smWkDateMsg
        End If
    Else
        If Index = 0 Then
            lacStdDates.Caption = ""
        ElseIf Index = 1 Then
            lacCalDates.Caption = ""
        ElseIf Index = 2 Then
            lacWkDates.Caption = ""
        End If
    End If
    If (ckcBillCycle(INVBILLCYCLE_STD).Value = vbUnchecked) And (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbUnchecked) Then
        If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then        '11-15-16 reprint, undo, archive
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'lbcDates.Enabled = False
            cbcDates.Enabled = False
        End If
    Else
        If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then        '11-15-16 reprint, undo, archive
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'lbcDates.Enabled = True
            cbcDates.Enabled = True
        End If
    End If
    If (ckcBillCycle(INVBILLCYCLE_Week).Value = vbUnchecked) Then
        If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then            '11-15-16 reprint, undo, archive
            'lbcWeek.Enabled = False
            cbcWeek.Enabled = False
        End If
    Else
        If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then            '11-15-16 reprint, udno, archive
            'lbcWeek.Enabled = True
            cbcWeek.Enabled = True
        End If
    End If
    If rbcCntr(INVCNTR_Selective).Value Or rbcCntr(INVCNTR_WOExpired).Value Or rbcCntr(INVCNTR_Posted).Value Then
        mSelCntr
    End If
    If ((rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value) And (rbcAdvt(1).Value)) Or rbcType(INVGEN_Undo).Value Then     '11-15-16 reprint or archive
        mSelAdvt
    End If
    '6/5/12: Reset rollback state.  Only one month and/or one week will have been selected.
    '        mSelAdvt will reset dates used by mRollbackReconcRequired
    'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
    'If (rbcType(INVGEN_Undo).Value) And ((lbcDates.ListIndex >= 0) Or (lbcWeek.ListIndex >= 0)) Then
    If (rbcType(INVGEN_Undo).Value) And ((cbcDates.ListIndex >= 1) Or (lbcWeek.ListIndex >= 1)) Then
        imRollbackReconcRequired = -1
        mRollbackReconcRequired
    End If
End Sub

Private Sub rbcCntr_Click(Index As Integer)
    'Code added because Value removed as parameter
    Dim Value As Integer
    Value = rbcCntr(Index).Value
    'End of coded added
    Dim llRet As Long
    Dim llRg As Long
    Dim ilValue As Integer
    Dim ilRet As Integer
    bmIncludeMG = True
    If Value Then
        rbcCntr(INVCNTR_Selective).Caption = "Selective"
        Select Case Index
            Case 0  'All
                cmcClearPsf.Enabled = True
                'lbcCntr.Clear
                'lbcCntr.Enabled = False
                'ilValue = True
                'If lbcCntr.ListCount > 0 Then
                '    llRg = CLng(lbcCntr.ListCount - 1) * &H10000 Or 0
                '    llRet = SendMessageByNum(lbcCntr.hwnd, LB_SELITEMRANGE, ilValue, llRg)
                'End If
                'lbcCntr.Clear
                'lbcCntrCode.Clear
                mClearAirTimeGrid
            Case 1  'Selected
                ilRet = MsgBox("Include MG/Outside spots scheduled in this billing period for previously expired Orders", vbYesNo + vbQuestion + vbDefaultButton1, "Which Contracts")
                If ilRet = vbNo Then
                    rbcCntr(INVCNTR_Selective).Caption = "Selective w/o MGs"
                    bmIncludeMG = False
                Else
                    rbcCntr(INVCNTR_Selective).Caption = "Selective + MGs"
                    bmIncludeMG = True
                End If
                cmcClearPsf.Enabled = False
                'lbcCntr.Enabled = True
                'If lbcCntr.ListCount <= 0 Then
                '    ReDim tgInvVehCode(0 To 0) As String
                '    For ilVeh = 0 To lbcVehicle.ListCount - 1 Step 1
                '        slNameCode = Trim$(tmInvVehicle(ilVeh).sKey)  'Traffic!lbcVehicle.List(ilVeh)
                '        tgInvVehCode(UBound(tgInvVehCode)) = slNameCode
                '        ReDim Preserve tgInvVehCode(0 To UBound(tgInvVehCode) + 1) As String
                '    Next ilVeh
                '    ilRet = mObtainCntrToInvoice(0)
                'End If
                mSelCntr
            Case 2  'Selected
                cmcClearPsf.Enabled = False
                mSelCntr
            Case 3  'Posted
                cmcClearPsf.Enabled = False
                mSelCntr
        End Select
    End If
End Sub

Private Sub rbcCntr_GotFocus(Index As Integer)
    'plcUnbilled.Visible = False
End Sub

Private Sub rbcOutput_Click(Index As Integer)
    'Code added because Value removed as parameter
    Dim Value As Integer
    Value = rbcOutput(Index).Value
    'End of coded added
    If rbcOutput(Index).Value Then
        Select Case Index
            Case 0  'Display
                cmcSetup.Enabled = False
                cmcAlign.Enabled = False
                frcPrtType.Enabled = False
            Case 1  'Print
                cmcSetup.Enabled = True
                cmcAlign.Enabled = True
                frcPrtType.Enabled = True
        End Select
    End If
End Sub

Private Sub rbcOutput_GotFocus(Index As Integer)
    If imFirstTime Then
        imFirstTime = False
    End If
    'plcUnbilled.Visible = False
End Sub

Private Sub rbcPrtType_GotFocus(Index As Integer)
    If imFirstTime Then
        imFirstTime = False
    End If
    'plcUnbilled.Visible = False
End Sub

Private Sub rbcType_Click(Index As Integer)
    Dim slDate As String
    mSetGridColumns 'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
    '3-4-05 allow NTR to Show Prelim notation.  Not showing when selecting NTR without AIRTime

    'Code added because Value removed as parameter
    Dim Value As Integer
    Value = rbcType(Index).Value
    'End of coded added

    lmLastClickedRow = -1
    If Value Then
        smPostLogSource = smSvPostLogSource
        frcOutput.Visible = True
        frcReprint.Visible = False
        'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
        'lbcDates.Visible = False
        cbcDates.Visible = False
        lacMonth.Visible = False
        'lbcWeek.Visible = False
        cbcWeek.Visible = False
        lacWeek.Visible = False
        'lbcAdvt.Visible = False
        'pbcLbcAdvt.Visible = False
        grdRevenue.Visible = False
        'imcSortTitle.Visible = False
        lbcVehicle.Visible = False
        'lbcCntr.Visible = False
        grdAirTime.Visible = False
        ckcAll.Visible = False
        plcCntr.Visible = False
        plcAdvt.Visible = False
        ckcShowPrel.Visible = False
        If rbcType(2).Value Then
            If ckcType(3).Value = vbChecked Then
                ckcSuppressNTRDetails.Visible = True 'TTP 10745
            Else
                ckcSuppressNTRDetails.Visible = False 'TTP 10745
                ckcSuppressNTRDetails.Value = vbUnchecked
            End If
        Else
            ckcSuppressNTRDetails.Visible = False 'TTP 10745
            ckcSuppressNTRDetails.Value = vbUnchecked
        End If
        
        lacUndoReconc.Visible = False
        plcInvSpotTimeZone.Visible = False
        rbcAdvt(0).Enabled = True
        cmcGenerate.Caption = "&Generate"
        'Dan M moved out of if's 4/13/09
        rbcOutput(0).Enabled = True
        '12/31/15: For Preliminary check Standard lines (Non-hidden lines)
        If (Index = 0) And (smPostLogSource = "S") Then
            smPostLogSource = "T"
        End If
        If (Index = 0) And ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked)) Then   'Prel. 3-4-05 allow NTR to Show Prelim notation
            Screen.MousePointer = vbHourglass
            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
            'Dan don 't need here anymore
            'rbcOutput(0).Enabled = True
            frcReprint.Visible = False
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'lbcDates.Visible = False
            cbcDates.Visible = False
            lacMonth.Visible = False
            'lbcWeek.Visible = False
            cbcWeek.Visible = False
            lacWeek.Visible = False
            'lbcAdvt.Visible = False
            'pbcLbcAdvt.Visible = False
            grdRevenue.Visible = False
            'imcSortTitle.Visible = False
            If ckcType(INVTYPE_Commercial).Value = vbChecked Then
                lbcVehicle.Visible = True
                'lbcCntr.Visible = True
                grdAirTime.Visible = True
                ckcAll.Visible = True
                plcCntr.Visible = True
                If bmToggleAirAndNTR Then
                    ckcType(INVTYPE_NTR).Value = vbUnchecked
                End If
            Else
                lbcVehicle.Visible = False
                'lbcCntr.Visible = False
                grdAirTime.Visible = False
                ckcAll.Visible = False
                plcCntr.Visible = False
            End If
            plcAdvt.Visible = False
            'frcBilling.Visible = True
            If (lbcVehicle.ListCount <= 0) And (ckcType(INVTYPE_Commercial).Visible) Then
                mVehPop
            End If
            ckcAll.Value = vbChecked        '11-2-01
            'ckcAll.Enabled = True
            'If tgSpf.sInvVehSel = "Y" Then
            If (tgSpf.sInvVehSel = "Y") And (tgSpf.sBLaserForm <> "2") Then
                ckcAll.Enabled = True  '8-24-01
                lbcVehicle.Enabled = True
             Else
                ckcAll.Enabled = False
                lbcVehicle.Enabled = False
            End If
            ckcType(INVTYPE_GenRepAR).Value = vbUnchecked
        'End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
        ElseIf (Index = 0) And (ckcType(INVTYPE_GenRepAR).Value = vbChecked) Then   'Prel. and Gen Rep A/R
            'ckcShowPrel.Caption = "Show " & """" & "Preliminary" & """" & " on Invoice"
            'ckcShowPrel.Enabled = True
            'ckcShowPrel.Visible = True
            'ckcShowPrel.Value = vbChecked   '10-31-01 True
            'mObtainDates
        ' Dan M this allows display and final to be together for 'printRep' and 'Installments' (1 and 2). 4/13/09 this no longer allowed. This if moved down.
        'ElseIf (Index = 1) And ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_GenRepAR).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value)) Then    'Final 3-4-05 allow NTR to Show Prelim notation
         ElseIf (Index = 1) Then
            If tgUrf(0).sAllowInvDisplay <> "I" Then
                rbcOutput(0).Enabled = False
            End If
            If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_GenRepAR).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked)) Then
                Screen.MousePointer = vbHourglass
                gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                rbcOutput(1).Value = True   'Select printing
                ' Dan M 4/13/09
                'this code moved above 'if'. Changed to test sAllwInvDisplay as this is now set for cpname and internal guide.
    '           ' If (Trim$(tgUrf(0).sName) <> sgCPName) And (Trim$(tgUrf(0).sName) <> sgSUName) Then
    '                rbcOutput(0).Enabled = False
    '            End If
                frcReprint.Visible = False
                ckcShowPrel.Value = vbUnchecked '10-31-01 False
                ckcSuppressNTRDetails.Value = vbUnchecked 'TTP 10745
                ckcShowPrel.Enabled = False
                ckcShowPrel.Visible = False
                ckcSuppressNTRDetails.Visible = False
                'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                'lbcDates.Visible = False
                cbcDates.Visible = False
                lacMonth.Visible = False
                'lbcWeek.Visible = False
                cbcWeek.Visible = False
                lacWeek.Visible = False
                'lbcAdvt.Visible = False
                'pbcLbcAdvt.Visible = False
                grdRevenue.Visible = False
                'imcSortTitle.Visible = False
                If ckcType(INVTYPE_Commercial).Value = vbChecked Then
                    lbcVehicle.Visible = True
                    'lbcCntr.Visible = True
                    grdAirTime.Visible = True
                    ckcAll.Visible = True
                    plcCntr.Visible = True
                Else
                    lbcVehicle.Visible = False
                    'lbcCntr.Visible = False
                    grdAirTime.Visible = False
                    ckcAll.Visible = False
                    plcCntr.Visible = False
                End If
                plcAdvt.Visible = False
                'frcBilling.Visible = True
                'If lbcVehicle.ListCount <= 0 Then
                If (lbcVehicle.ListCount <= 0) And (ckcType(INVTYPE_Commercial).Visible) Then
                    mVehPop
                End If
                ckcAll.Value = vbChecked        '11-2-01
                'ckcAll.Enabled = True
                'If tgSpf.sInvVehSel = "Y" Then
                If (tgSpf.sInvVehSel = "Y") And (tgSpf.sBLaserForm <> "2") Then
                    ckcAll.Enabled = True      '8-24-01
                    lbcVehicle.Enabled = True
                Else
                    ckcAll.Enabled = False
                    lbcVehicle.Enabled = False
                End If
                'End If
                Screen.MousePointer = vbDefault
                gSetMousePointer grdAirTime, grdRevenue, vbDefault
            End If
        ElseIf Index = 2 Or Index = 5 Then    '11-15-16 Reprint or archive
            'lbcDates.Visible = False
            'lbcAdvt.Visible = False
            'pbcLbcAdvt.Visible = False
            'lbcVehicle.Visible = False
            'lbcCntr.Visible = False
            'ckcShowPrel.Value = vbUnchecked '10-31-01 False
            'ckcShowPrel.Enabled = False
            'ckcAll.Visible = False
            'plcAdvt.Visible = False
            'plcCntr.Visible = False
            ''frcBilling.Visible = False
            'frcReprint.Visible = True
            'ckcType(INVTYPE_GenRepAR).Value = vbUnchecked
            Screen.MousePointer = vbHourglass
            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
            frcReprint.Visible = False
            ckcShowPrel.Caption = "Show " & """" & "Reprint" & """" & " on Invoice"
            ckcShowPrel.Enabled = True
            ckcShowPrel.Visible = True
            
            If rbcType(2).Value Then
                If ckcType(3).Value = vbChecked Then
                    ckcSuppressNTRDetails.Visible = True 'TTP 10745
                Else
                    ckcSuppressNTRDetails.Visible = False 'TTP 10745
                    ckcSuppressNTRDetails.Value = vbUnchecked
                End If
            Else
                ckcSuppressNTRDetails.Visible = False 'TTP 10745
                ckcSuppressNTRDetails.Value = vbUnchecked
            End If
            
            If Index = 5 Then
                ckcSuppressNTRDetails.Visible = False 'TTP 10745
                ckcSuppressNTRDetails.Value = vbUnchecked
            End If
            lbcVehicle.Visible = False
            'lbcCntr.Visible = False
            grdAirTime.Visible = False
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'lbcDates.Visible = True
            cbcDates.Visible = True
            lacMonth.Visible = True
            '12/15/12
            'If ((Asc(tgSpf.sUsingFeatures9) And WEEKLYBILL) = WEEKLYBILL) Then
            If bmWeeklyBillExist Then
                'lbcWeek.Visible = True
                cbcWeek.Visible = True
                lacWeek.Visible = True
                If ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked Then
                    'lbcWeek.Enabled = True
                    cbcWeek.Enabled = True
                Else
                    'lbcWeek.Enabled = False
                    cbcWeek.Enabled = False
                End If
            Else
                'lbcWeek.Visible = False
                cbcWeek.Visible = False
                lacWeek.Visible = False
            End If
            'lbcAdvt.Visible = True
            'pbcLbcAdvt.Visible = True
            grdRevenue.Visible = True
            'imcSortTitle.Visible = True
            ckcAll.Visible = False
            plcCntr.Visible = False
            plcAdvt.Visible = True
            ckcType(INVTYPE_GenRepAR).Value = vbUnchecked
            'frcBilling.Visible = False
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'If (lbcDates.ListCount <= 0) Or (lbcWeek.ListCount <= 0) Then
            If (cbcDates.ListCount <= 1) Or (lbcWeek.ListCount <= 1) Then
                cbcDates.Clear
                cbcDates.AddItem "Date (Select One)"
                cbcWeek.AddItem "Week (Select One)"
                mDatePop
                cbcDates.ListIndex = 0
                cbcWeek.ListIndex = 0
            End If
            If rbcAdvt(1).Value Then
                rbcAdvt_Click 1
            End If
            If rbcInvSpotTimeZone(4).Value <> True Then
                plcInvSpotTimeZone.Visible = True
            End If
            
            If Index = 5 Then                           'archive Invoices to PDF only, do not show the output method
                frcOutput.Visible = False
                lacUndoReconc.Visible = True
                lacUndoReconc.Caption = "Invoices will be exported to PDF"
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
        ElseIf Index = 3 Then   'Affidavit
            Screen.MousePointer = vbHourglass
            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
            'no longer needed Dan M
           ' rbcOutput(0).Enabled = True
            frcReprint.Visible = False
            ckcShowPrel.Enabled = False
            ckcShowPrel.Visible = False
            ckcSuppressNTRDetails.Visible = False 'TTP 10745
            ckcSuppressNTRDetails.Value = vbUnchecked
            ckcShowPrel.Value = vbUnchecked '10-31-01 False
            lbcVehicle.Visible = False
            'lbcCntr.Visible = False
            grdAirTime.Visible = False
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'lbcDates.Visible = True
            cbcDates.Visible = True
            lacMonth.Visible = True
            '12/15/12
            'If ((Asc(tgSpf.sUsingFeatures9) And WEEKLYBILL) = WEEKLYBILL) Then
            If bmWeeklyBillExist Then
                'lbcWeek.Visible = True
                cbcWeek.Visible = True
                lacWeek.Visible = True
                If ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked Then
                    'lbcWeek.Enabled = True
                    cbcWeek.Enabled = True
                Else
                    'lbcWeek.Enabled = False
                    cbcWeek.Enabled = False
                End If
            Else
                'lbcWeek.Visible = False
                cbcWeek.Visible = False
                lacWeek.Visible = False
            End If
            'lbcAdvt.Visible = True
            'pbcLbcAdvt.Visible = True
            grdRevenue.Visible = True
            'imcSortTitle.Visible = True
            ckcAll.Visible = False
            plcCntr.Visible = False
            plcAdvt.Visible = True
            'frcBilling.Visible = False
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'If (lbcDates.ListCount <= 0) Or (lbcWeek.ListCount <= 0) Then
            If (cbcDates.ListCount <= 1) Or (lbcWeek.ListCount <= 1) Then
                mDatePop
            End If
            If rbcAdvt(1).Value Then
                rbcAdvt_Click 1
            End If
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
        ElseIf Index = 4 Then    'Undo
            If Not imFromCallRadioButton Then
                If (igWinStatus(INVOICESJOB) = 1) And (Trim$(tgUrf(0).sName) <> sgCPName) And (Trim$(tgUrf(0).sName) <> sgSUName) Then
                    igPasswordOk = False
                'ElseIf (Trim$(tgUrf(0).sName) = sgCPName) Or (Trim$(tgUrf(0).sName) = sgSUName) Then
                'Remove Guide 2/14/03-Jim request
                ElseIf (Trim$(tgUrf(0).sName) = sgCPName) Then
                    igPasswordOk = True
                Else
                    '4/24/14: Change password message
                    'sgPasswordAddition = ""
                    sgPasswordAddition = "Replace: Obtain new Keycode from Counterpoint to Undo one or more Invoices"
                    CSPWord.Show vbModal
                End If
                If Not igPasswordOk Then
                    rbcType(INVGEN_Undo).Value = False
                    Screen.MousePointer = vbDefault
                    gSetMousePointer grdAirTime, grdRevenue, vbDefault
                    Exit Sub
                End If
            End If
            Screen.MousePointer = vbHourglass
            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
            mClearRevenueGrid
            cmcGenerate.Caption = "&Process"
            imIgnoreSelAdvtRequest = True
            '10016
            If bmToggleAirAndNTR = False Then
                If ckcType(INVTYPE_Commercial).Value = vbChecked Then
                    If tgSpf.sUsingNTR = "Y" Then
                        ckcType(INVTYPE_NTR).Value = vbChecked
                    End If
                ElseIf ckcType(INVTYPE_NTR).Value = vbChecked Then
                    ckcType(INVTYPE_Commercial).Value = vbChecked
                End If
            End If
            frcOutput.Visible = False
            frcReprint.Visible = False
            ckcShowPrel.Enabled = False
            ckcShowPrel.Visible = False    'True
            ckcSuppressNTRDetails.Visible = False 'TTP 10745
            ckcSuppressNTRDetails.Value = vbUnchecked
            lbcVehicle.Visible = False
            grdAirTime.Visible = False
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'lbcDates.Visible = True
            cbcDates.Visible = True
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'lbcDates.Clear
            cbcDates.Clear
            cbcDates.AddItem "Dates (Select One)"
            cbcDates.ListIndex = 0
            lacMonth.Visible = True
            If bmWeeklyBillExist Then
                'lbcWeek.Visible = True
                cbcWeek.Visible = True
                lacWeek.Visible = True
                If ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked Then
                    'lbcWeek.Enabled = True
                    cbcWeek.Enabled = True
                Else
                    'lbcWeek.Enabled = False
                    cbcWeek.Enabled = False
                End If
            Else
                'lbcWeek.Visible = False
                cbcWeek.Visible = False
                lacWeek.Visible = False
            End If
            'lbcWeek.Clear
            cbcWeek.Clear
            cbcWeek.AddItem "Week (Select One)"
            cbcWeek.ListIndex = 0
            grdRevenue.Visible = True
            ckcAll.Visible = False
            plcCntr.Visible = False
            lmUndoInvDate = mGetUndoMonth()
            slDate = Format$(lmUndoInvDate, "m/d/yy")
            slDate = gMonthYearFormat(slDate)
            'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
            'lbcDates.AddItem slDate
            cbcDates.AddItem slDate
            'lbcDates.ListIndex = 0
            cbcDates.ListIndex = 0
            lmUndoInvWeek = mGetUndoWeek()
            slDate = Format$(lmUndoInvWeek, "m/d/yy")
            slDate = gObtainPrevMonday(slDate)
            'lbcWeek.AddItem slDate
            cbcWeek.AddItem slDate
            'lbcWeek.ListIndex = 0
            cbcWeek.ListIndex = 0
            plcAdvt.Visible = True
            imIgnoreSelAdvtRequest = False
            If rbcAdvt(1).Value = True Then
                mSelAdvt
            Else
                rbcAdvt(1).Value = True
            End If
            '4/24/14: Allow all to be selected.  Add password if selected.
            'rbcAdvt(0).Enabled = False
            ''frcBilling.Visible = False
            ''If lbcDates.ListCount <= 0 Then
            ''    mDatePop
            ''End If
            mRollbackReconcRequired
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
        End If
        If Index = 0 Then
            ckcShowPrel.Caption = "Show " & """" & "Preliminary" & """" & " on Invoice"
            ckcShowPrel.Enabled = True
            ckcShowPrel.Visible = True
            ckcSuppressNTRDetails.Visible = False 'TTP 10745
            ckcShowPrel.Value = vbChecked   '10-31-01 True
            lbcView.Visible = False
            imObtainDateCalled = False
            mObtainDates
        '6/12/12: Obtain Day Complete flag
        ElseIf Index = 1 Then
            imObtainDateCalled = False
            mObtainDates
        End If
    End If
    If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or (ckcType(INVTYPE_NTR).Value = vbChecked) Or (ckcType(INVTYPE_GenRepAR).Value = vbChecked)) And ((rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value)) Then
        frcBilling.Visible = True
    Else
        frcBilling.Visible = False
    End If
    If ((ckcType(INVTYPE_Commercial).Value = vbChecked) Or ((ckcType(INVTYPE_PrintRep).Value = vbChecked) And ((Asc(tgSpf.sUsingFeatures8) And REPBYDT) = REPBYDT))) And (rbcType(INVGEN_Final).Value) Then
        ckcIncludeEDI.Visible = True        '11-14-16
        If Not ckcType(INVTYPE_Commercial).Value Then
            ckcArchive.Visible = True
            ckcArchive.Value = vbChecked
        End If
    ElseIf ckcType(INVTYPE_PrintRep).Value = vbChecked And rbcType(INVGEN_Final).Value Then           '12-20-16
        ckcArchive.Visible = True
        ckcArchive.Value = vbChecked
    Else
        ckcIncludeEDI.Visible = False
        ckcArchive.Visible = False
        ckcArchive.Value = vbUnchecked
    End If
    mSetCommands
End Sub

Private Sub rbcType_GotFocus(Index As Integer)
    'plcUnbilled.Visible = False
    If imFirstTime Then
        imFirstTime = False
    End If
    gCtrlGotFocus rbcType(Index)
End Sub

Private Sub plcUnbilled_Paint()
    plcUnbilled.CurrentX = 0
    plcUnbilled.CurrentY = 0
    plcUnbilled.Print "Billing Discrepancies"
End Sub

Private Sub plcScreen_Paint()
    plcScreen.CurrentX = 0
    plcScreen.CurrentY = 0
    plcScreen.Print "Invoices"
End Sub

Private Sub plcCntr_Paint()
    plcCntr.CurrentX = 0
    plcCntr.CurrentY = 0
    plcCntr.Print "Contracts"
End Sub

Private Sub plcAdvt_Paint()
    plcAdvt.CurrentX = 0
    plcAdvt.CurrentY = 0
    plcAdvt.Print "Advertisers"
End Sub

Private Sub mSelCntrSort()
    Dim ilLoop As Integer
    Dim slName As String
    Dim ilRet As Integer
    Dim slSort As String
    Dim slStr As String
    Dim slKey As String
    'TTP 10597 - Ad server/digital show Unposted Digital Contracts in Selective List in RED color
    '    For ilLoop = 1 To UBound(lmCPMBypassCntr) - 1 Step 1
    '        If lmCPMBypassCntr(ilLoop) = tmChf.lCode Then
    '            Exit Sub
    '        End If
    '    Next ilLoop
    If tmChf.iAgfCode = 0 Then  'Obtain advertiser- direct bill
        ilLoop = gBinarySearchAdf(tmChf.iAdfCode)
        If ilLoop <> -1 Then
            slName = Trim$(tgCommAdf(ilLoop).sName)
            tmMnfSrchKey.iCode = tgCommAdf(ilLoop).iMnfSort
        End If
    Else    'Obtain agency
        ilLoop = gBinarySearchAgf(tmChf.iAgfCode)
        If ilLoop <> -1 Then
            slName = Trim$(tgCommAgf(ilLoop).sName) & "/" & Trim$(tgCommAgf(ilLoop).sCityID)
            tmMnfSrchKey.iCode = tgCommAgf(ilLoop).iMnfSort
        End If
        If tmMnfSrchKey.iCode <= 0 Then
            ilLoop = gBinarySearchAdf(tmChf.iAdfCode)
            If ilLoop <> -1 Then
                tmMnfSrchKey.iCode = tgCommAdf(ilLoop).iMnfSort
            End If
        End If
    End If

    If tmMnfSrchKey.iCode > 0 Then
        If tmMnf.iCode <> tmMnfSrchKey.iCode Then
            ilRet = btrGetEqual(hmMnf, tmMnf, imMnfRecLen, tmMnfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        Else
            ilRet = BTRV_ERR_NONE
        End If
        If ilRet <> BTRV_ERR_NONE Then
            tmMnf.iCode = 0
            tmMnf.iGroupNo = 0
            'Sort PSA and Promos to end of list
            If (tmChf.sType = "S") Or (tmChf.sType = "M") Then
                slSort = "99999"
            Else
                slSort = "99998"
            End If
        Else
            If tmMnf.iGroupNo > 0 Then
                slSort = Trim$(str$(tmMnf.iGroupNo))
                Do While Len(slSort) < 5
                    slSort = "0" & slSort
                Loop
            Else
                'Sort PSA and Promos to end of list
                If (tmChf.sType = "S") Or (tmChf.sType = "M") Then
                    slSort = "99999"
                Else
                    slSort = "99998"
                End If
            End If
        End If
    Else
        'Sort PSA and Promos to end of list
        If (tmChf.sType = "S") Or (tmChf.sType = "M") Then
            slSort = "99999"
        Else
            slSort = "99998"
        End If
    End If
    Do While Len(slName) < 46
        slName = slName & " "
    Loop
    slKey = slSort & slName
    'Advertiser
    ilLoop = gBinarySearchAdf(tmChf.iAdfCode)
    If ilLoop <> -1 Then
        slKey = slKey & "|" & tgCommAdf(ilLoop).sName
    End If
    'Contract number
    slStr = Trim$(str$(tmChf.lCntrNo))
    Do While Len(slStr) < 8
        slStr = "0" & slStr
    Loop
    slKey = slKey & "|" & slStr
    tgSelSort(UBound(tgSelSort)).sKey = slKey
    tgSelSort(UBound(tgSelSort)).lChfCode = tmChf.lCode
    tgSelSort(UBound(tgSelSort)).iAdfCode = tmChf.iAdfCode
    tgSelSort(UBound(tgSelSort)).lCntrNo = tmChf.lCntrNo
    tgSelSort(UBound(tgSelSort)).iSlfCode = tmChf.iSlfCode(0) 'TTP 10813 - PDF invoice - selective invoice feature checklist
    tgSelSort(UBound(tgSelSort)).sBillCycle = tmChf.sBillCycle
    gUnpackDate tmChf.iEndDate(0), tmChf.iEndDate(1), slStr
    tgSelSort(UBound(tgSelSort)).sEndDate = slStr
    tgSelSort(UBound(tgSelSort)).iAgfCode = tmChf.iAgfCode
    tgSelSort(UBound(tgSelSort)).iPosted = True
    
    'TTP 10597 - Ad server/digital show Unposted Digital Contracts in Selective List in RED color
    For ilLoop = 1 To UBound(lmCPMBypassCntr) - 1 Step 1
        If lmCPMBypassCntr(ilLoop) = tmChf.lCode Then
            tgSelSort(UBound(tgSelSort)).iPosted = False
            Exit For
        End If
    Next ilLoop

    ReDim Preserve tgSelSort(0 To UBound(tgSelSort) + 1) As SELTYPESORT

End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mRvfExist                       *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Determine if contract          *
'*                      previously invoiced            *
'*                                                     *
'*******************************************************
Public Function mRvfExist(llInvNo As Long, ilAirTimeOrNTR As Integer, llSbfCode As Long, slCashTrade As String, Optional llPcfCode = 0) As Integer
'   tgChfInv(I)- CHF Record
'   llInvNo(O) Invoice Number
'   ilAirTimeOrNTR(I)- 0=Air Time (or Rep); 1=NTR
'   ilRet:  True if RVF or PHF matching record exist;  False if no matching record exist
'
    Dim ilFound As Integer
    Dim ilRet As Integer
    Dim ilMatch As Integer
    Dim ilTranDate(0 To 1) As Integer

    ilFound = False
    If (tgSpf.sBCombine = "Y") Or ((tgSpf.sBCombine = "N") And (tgChfInv.lCntrNo <> lmPrevCombineCntrNo)) Then
        If tgChfInv.sBillCycle = "C" Then
            gPackDate smEndCal, ilTranDate(0), ilTranDate(1)
        ElseIf tgChfInv.sBillCycle = "W" Then
            gPackDate smEndWk, ilTranDate(0), ilTranDate(1)
        Else
            gPackDate smEndStd, ilTranDate(0), ilTranDate(1)
        End If
        tmRvfSrchKey4.lCntrNo = tgChfInv.lCntrNo
        tmRvfSrchKey4.iTranDate(0) = ilTranDate(0)
        tmRvfSrchKey4.iTranDate(1) = ilTranDate(1)
        ilRet = btrGetGreaterOrEqual(hmRvf, tmRvf, imRvfRecLen, tmRvfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        Do While (ilRet = BTRV_ERR_NONE) And (tmRvf.lCntrNo = tgChfInv.lCntrNo)
            ilMatch = False
            If (tmRvf.sInvoiceUndone <> "Y") Then
                If slCashTrade = "" Then
                    If (ilTranDate(0) = tmRvf.iTranDate(0)) And (ilTranDate(1) = tmRvf.iTranDate(1)) And (tmRvf.sTranType = "IN") And ((tmRvf.sCashTrade = "C") Or (tmRvf.sCashTrade = "T")) Then
                        ilMatch = True
                    End If
                Else
                    If (ilTranDate(0) = tmRvf.iTranDate(0)) And (ilTranDate(1) = tmRvf.iTranDate(1)) And (tmRvf.sTranType = "IN") And (tmRvf.sCashTrade = slCashTrade) Then
                        ilMatch = True
                    End If
                End If
            End If
            If ilMatch Then
                If ilAirTimeOrNTR = 1 Then
                    If llPcfCode > 0 Then
                        If (tmRvf.iMnfItem = 0) And (llPcfCode = tmRvf.lPcfCode) Then
                            ilFound = True
                            llInvNo = tmRvf.lInvNo
                            Exit Do
                        End If
                    Else
                        If (tmRvf.iMnfItem <> 0) And (llSbfCode = tmRvf.lSbfCode) Then
                            ilFound = True
                            llInvNo = tmRvf.lInvNo
                            Exit Do
                        End If
                    End If
                Else
                    If tmRvf.iMnfItem = 0 Then
                        ilFound = True
                        llInvNo = tmRvf.lInvNo
                        Exit Do
                    End If
                End If
            End If
            ilRet = btrGetNext(hmRvf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        Loop
        If ((imGenCntrExport = True) Or (imChkHistory = True)) And (Not ilFound) Then
            tmRvfSrchKey4.lCntrNo = tgChfInv.lCntrNo
            tmRvfSrchKey4.iTranDate(0) = ilTranDate(0)
            tmRvfSrchKey4.iTranDate(1) = ilTranDate(1)
            ilRet = btrGetGreaterOrEqual(hmPhf, tmRvf, imRvfRecLen, tmRvfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
            Do While (ilRet = BTRV_ERR_NONE) And (tmRvf.lCntrNo = tgChfInv.lCntrNo)
                ilMatch = False
                If (tmRvf.sInvoiceUndone <> "Y") Then
                    If slCashTrade = "" Then
                        If (ilTranDate(0) = tmRvf.iTranDate(0)) And (ilTranDate(1) = tmRvf.iTranDate(1)) And ((tmRvf.sTranType = "HI") Or ((tmRvf.sTranType = "IN") And (tmRvf.sCashTrade = "T") And (tgSpf.sRUseTrade <> "Y"))) And ((tmRvf.sCashTrade = "C") Or (tmRvf.sCashTrade = "T")) Then
                            ilMatch = True
                        End If
                    Else
                        'If (ilTranDate(0) = tmRvf.iTranDate(0)) And (ilTranDate(1) = tmRvf.iTranDate(1)) And ((tmRvf.sTranType = "HI") Or ((tmRvf.sTranType = "IN") And (tmRvf.sCashTrade = "T") And (tgSpf.sRUseTrade <> "Y"))) And (tmRvf.sCashTrade = slCashTrade) Then
                        If (ilTranDate(0) = tmRvf.iTranDate(0)) And (ilTranDate(1) = tmRvf.iTranDate(1)) And ((tmRvf.sTranType = "HI") Or ((tmRvf.sTranType = "IN") And (tgSpf.sRUseTrade <> "Y"))) And (tmRvf.sCashTrade = slCashTrade) Then 'L.Bianchi TTP 10162
                            ilMatch = True
                        End If
                    End If
                End If
                If ilMatch Then
                    If ilAirTimeOrNTR = 1 Then
                        If llPcfCode > 0 Then
                            If (tmRvf.iMnfItem = 0) And (llPcfCode = tmRvf.lPcfCode) Then
                                ilFound = True
                                llInvNo = tmRvf.lInvNo
                                Exit Do
                            End If
                        Else
                            If (tmRvf.iMnfItem <> 0) And (llSbfCode = tmRvf.lSbfCode) Then
                                ilFound = True
                                llInvNo = tmRvf.lInvNo
                                Exit Do
                            End If
                        End If
                    Else
                        If tmRvf.iMnfItem = 0 Then
                            ilFound = True
                            llInvNo = tmRvf.lInvNo
                            Exit Do
                        End If
                    End If
                End If
                ilRet = btrGetNext(hmPhf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
        End If
        If ilFound Then
            lmPrevCombineCntrNo = -1
        Else
            lmPrevCombineCntrNo = tgChfInv.lCntrNo
        End If
    End If
    mRvfExist = ilFound
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mTestUpdateRvf                  *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Determine type of update to RVF*
'*                                                     *
'*******************************************************
Private Function mTestUpdateRvf(tlRvf As RVF) As Integer
    Dim llGross As Long
    Dim ilRet As Integer
    Dim ilFound As Integer
    Dim slGross As String
    Dim slNet As String
    Dim llNet As Long
    Dim llAcquisitionCost As Long
    Dim llRvfGross As Long
    Dim slRvfGross As String
    Dim llRvfNet As Long
    Dim slRvfNet As String
    Dim slSDate As String
    Dim slEDate As String
    Dim llSDate As Long
    Dim llEDate As Long
    Dim ilTest As Integer
    Dim ilBypass As Integer

    If (Not rbcType(INVGEN_Undo).Value) And (Not imPrintRepInv) Then
        '12/18/17: Check if gross is negative and if so change type to AN
        gPDNToStr tlRvf.sGross, 2, slRvfGross
        llRvfGross = gStrDecToLong(slRvfGross, 2)
        If (llRvfGross < 0) And (tlRvf.sTranType = "IN") And (tlRvf.lSbfCode > 0) Then
            tlRvf.sTranType = "AN"
        End If
        mTestUpdateRvf = True
        Exit Function
    End If
    'Determine if previous existed, then adjust amount
    'Make all corrections as AN, even if new vehicle
    tlRvf.sTranType = "AN"
    llGross = 0
    llNet = 0
    llAcquisitionCost = 0
    ilFound = False
    tmRvfSrchKey4.lCntrNo = tlRvf.lCntrNo
    '2/7/08: The transaction date might not match the one used to create the original Rep invoice
    tmRvfSrchKey4.iTranDate(0) = 0  'tlRvf.iTranDate(0)
    tmRvfSrchKey4.iTranDate(1) = 0  'tlRvf.iTranDate(1)
    ilRet = btrGetGreaterOrEqual(hmRvf, tmRvf, imRvfRecLen, tmRvfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmRvf.lCntrNo = tlRvf.lCntrNo)
        'If (tlRvf.iAgfCode = tmRvf.iAgfCode) And (tlRvf.lCntrNo = tmRvf.lCntrNo) And (tlRvf.iAirVefCode = tmRvf.iAirVefCode) And (tlRvf.iBillVefCode = tmRvf.iBillVefCode) Then
        If (tlRvf.iAirVefCode = tmRvf.iAirVefCode) And (tlRvf.iBillVefCode = tmRvf.iBillVefCode) And (tlRvf.iMnfGroup = tmRvf.iMnfGroup) Then
            '11/2/04- removed transaction date test as extra AN were included.  Contract rep for Aug and Sept.  Aug Print Rep had 9/26 as
            'Transaction date for invoice 1901.  When Sept Rep Print, then Transaction date initially set to 9/26 and the
            'Aug "AN" found to match.  Later in this code the transaction date was changed top end of Oct.
            'If (((tlRvf.iTranDate(0) = tmRvf.iTranDate(0)) And (tlRvf.iTranDate(1) = tmRvf.iTranDate(1))) Or (tlRvf.lInvNo = tmRvf.lInvNo)) And ((tmRvf.sTranType = "IN") Or (tmRvf.sTranType = "AN")) And (tlRvf.sCashTrade = tmRvf.sCashTrade) Then
            If ((tlRvf.lInvNo = tmRvf.lInvNo)) And ((tmRvf.sTranType = "IN") Or (tmRvf.sTranType = "AN")) And (tlRvf.sCashTrade = tmRvf.sCashTrade) And (tmRvf.sInvoiceUndone <> "Y") Then
                If tmRvf.sTranType = "AN" Then
                    ilBypass = False
                    For ilTest = LBound(lmANAddedRvf) To UBound(lmANAddedRvf) - 1 Step 1
                        If tmRvf.lCode = lmANAddedRvf(ilTest) Then
                            ilBypass = True
                            Exit For
                        End If
                    Next ilTest
                Else
                    ilBypass = False
                End If
                If Not ilBypass Then
                    ilFound = True
                    gPDNToStr tmRvf.sGross, 2, slGross
                    llGross = llGross + gStrDecToLong(slGross, 2)
                    gPDNToStr tmRvf.sNet, 2, slNet
                    llNet = llNet + gStrDecToLong(slNet, 2)
                    llAcquisitionCost = llAcquisitionCost + tmRvf.lAcquisitionCost
                End If
            End If
        End If
        ilRet = btrGetNext(hmRvf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    If (Not ilFound) Then
        tmRvfSrchKey4.lCntrNo = tlRvf.lCntrNo
        '2/7/08: The transaction date might not match the one used to create the original Rep invoice
        tmRvfSrchKey4.iTranDate(0) = 0  'tlRvf.iTranDate(0)
        tmRvfSrchKey4.iTranDate(1) = 0  'tlRvf.iTranDate(1)
        ilRet = btrGetGreaterOrEqual(hmPhf, tmRvf, imRvfRecLen, tmRvfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        Do While (ilRet = BTRV_ERR_NONE) And (tmRvf.lCntrNo = tlRvf.lCntrNo)
            If (tlRvf.iAirVefCode = tmRvf.iAirVefCode) And (tlRvf.iBillVefCode = tmRvf.iBillVefCode) And (tlRvf.iMnfGroup = tmRvf.iMnfGroup) Then
                '11/2/04- removed transaction date test as extra AN were included.  Contract rep for Aug and Sept.  Aug Print Rep had 9/26 as
                'Transaction date for invoice 1901.  When Sept Rep Print, then Transaction date initially set to 9/26 and the
                'Aug "AN" found to match.  Later in this code the transaction date was changed top end of Oct.
                'If (((tlRvf.iTranDate(0) = tmRvf.iTranDate(0)) And (tlRvf.iTranDate(1) = tmRvf.iTranDate(1))) Or (tlRvf.lInvNo = tmRvf.lInvNo)) And ((tmRvf.sTranType = "IN") Or (tmRvf.sTranType = "AN")) And (tlRvf.sCashTrade = tmRvf.sCashTrade) Then
                If ((tlRvf.lInvNo = tmRvf.lInvNo)) And ((tmRvf.sTranType = "IN") Or (tmRvf.sTranType = "AN")) And (tlRvf.sCashTrade = tmRvf.sCashTrade) And (tmRvf.sInvoiceUndone <> "Y") Then
                    If tmRvf.sTranType = "AN" Then
                        ilBypass = False
                        For ilTest = LBound(lmANAddedPhf) To UBound(lmANAddedPhf) - 1 Step 1
                            If tmRvf.lCode = lmANAddedPhf(ilTest) Then
                                ilBypass = True
                                Exit For
                            End If
                        Next ilTest
                    Else
                        ilBypass = False
                    End If
                    If Not ilBypass Then
                        gPDNToStr tmRvf.sGross, 2, slGross
                        llGross = llGross + gStrDecToLong(slGross, 2)
                        gPDNToStr tmRvf.sNet, 2, slNet
                        llNet = llNet + gStrDecToLong(slNet, 2)
                        llAcquisitionCost = llAcquisitionCost + tmRvf.lAcquisitionCost
                    End If
                End If
            End If
            ilRet = btrGetNext(hmPhf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        Loop
    End If
    gPDNToStr tlRvf.sGross, 2, slRvfGross
    llRvfGross = gStrDecToLong(slRvfGross, 2)
    gPDNToStr tlRvf.sNet, 2, slRvfNet
    llRvfNet = gStrDecToLong(slRvfNet, 2)
    If (llRvfGross <> llGross) Or (llRvfNet <> llNet) Or (tlRvf.lAcquisitionCost <> llAcquisitionCost) Then
        llRvfGross = llRvfGross - llGross
        llRvfNet = llRvfNet - llNet
        slGross = gLongToStrDec(llRvfGross, 2)
        slNet = gLongToStrDec(llRvfNet, 2)
        gStrToPDN slGross, 2, 6, tlRvf.sGross
        gStrToPDN slNet, 2, 6, tlRvf.sNet
        tlRvf.lAcquisitionCost = tlRvf.lAcquisitionCost - llAcquisitionCost
        'Set TranDate- Use todays date if within next billing period, if not within use start date of next billing period
        tmChfSrchKey1.lCntrNo = tmRvf.lCntrNo
        tmChfSrchKey1.iCntRevNo = 32000
        tmChfSrchKey1.iPropVer = 32000
        ilRet = btrGetGreaterOrEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        Do While (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tmRvf.lCntrNo) And (tmChf.sSchStatus = "A")
            ilRet = btrGetNext(hmCHF, tmChf, imCHFRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        Loop
        If tmChf.sBillCycle = "C" Then
            gUnpackDate tgSpf.iBLastCalMnth(0), tgSpf.iBLastCalMnth(1), slSDate
            slSDate = gIncOneDay(slSDate)
            slEDate = gObtainEndCal(slSDate)
        ElseIf tmChf.sBillCycle = "W" Then
            gUnpackDate tgSaf(0).iBLastWeeklyDate(0), tgSaf(0).iBLastWeeklyDate(1), slSDate
            slSDate = gIncOneDay(slSDate)
            slEDate = gObtainNextSunday(slSDate)
        Else
            gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slSDate
            slSDate = gIncOneDay(slSDate)
            slEDate = gObtainEndStd(slSDate)
        End If
        llSDate = gDateValue(slSDate)
        llEDate = gDateValue(slEDate)
        If (lmNowDate >= llSDate) And (lmNowDate <= llEDate) Then
            gPackDateLong lmNowDate, tlRvf.iTranDate(0), tlRvf.iTranDate(1)
        Else
            'gPackDateLong llSDate, tlRvf.iTranDate(0), tlRvf.iTranDate(1)
            gPackDateLong llEDate, tlRvf.iTranDate(0), tlRvf.iTranDate(1)
        End If
        tlRvf.iInvDate(0) = tlRvf.iTranDate(0)
        tlRvf.iInvDate(1) = tlRvf.iTranDate(1)
        gPackDateLong lmNowDate, tlRvf.iDateEntrd(0), tlRvf.iDateEntrd(1)
        mTestUpdateRvf = True
    Else
        mTestUpdateRvf = False
    End If
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mRepAR_ProcFlight                 *
'*                                                     *
'*             Created:8/02/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Call mRepInv_ProcFlight        *
'*                      same code                      *
'*                                                     *
'*******************************************************
Public Sub mRepAR_ProcFlight(ilCff As Integer, slSFlightDate As String, slEFlightDate As String, ilPass As Integer, slPctTrade As String, slRate As String, slTotalNoPerWk As String, slTotalRate As String)
    mRepInv_ProcFlight ilCff, slSFlightDate, slEFlightDate, ilPass, slPctTrade, slRate, slTotalNoPerWk, slTotalRate
End Sub

Private Sub rbcType_MouseDown(Index As Integer, Button As Integer, Shift As Integer, X As Single, Y As Single)
    If (rbcType(INVGEN_Undo).Value) And (Index <> 4) Then
        'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
        'lbcDates.Clear
        cbcDates.Clear
        cbcDates.AddItem "Date (Select One)"
        cbcDates.ListIndex = 0
        'lbcWeek.Clear
        cbcWeek.Clear
        cbcWeek.AddItem "Week (Select One)"
        cbcWeek.ListIndex = 0
    End If
End Sub

Private Sub tmcPrt_Timer()
    tmcPrt.Enabled = False
    pbcPrinting.Visible = False
End Sub

Private Sub tmcStart_Timer()
    Dim ilLoop As Integer
    Dim slMsg As String
    
    tmcStart.Enabled = False
    If imTerminate Then
        mTerminate
        Exit Sub
    End If
    If Not gRecLengthOk("Ivr.btr", Len(tmIvr)) Then
        mTerminate
        Exit Sub
    End If
    If Not gRecLengthOk("Isr.btr", Len(tmIsr)) Then
        mTerminate
        Exit Sub
    End If
    slMsg = ""
    If lmSpfStdDate <= 0 Then
        slMsg = "Last Billed date not set for " & "Standard Broadcast Month"
    End If
    If bmCalBillExist Then
        If lmSpfCalDate <= 0 Then
            If slMsg = "" Then
                slMsg = "Last Billed date not set for " & "Calendar Month"
            Else
                If bmWeeklyBillExist And (lmSafWkDate <= 0) Then
                    slMsg = slMsg & ", Calendar Month"
                Else
                    slMsg = slMsg & " and Calendar Month"
                End If
            End If
        End If
    End If
    '12/15/12
    If bmWeeklyBillExist Then
        If lmSafWkDate <= 0 Then
            If slMsg = "" Then
                slMsg = "Last Billed date not set for " & "Weekly"
            Else
                slMsg = slMsg & " and Weekly"
            End If
        End If
    End If
    If slMsg <> "" Then
        MsgBox slMsg, vbCritical + vbOKOnly, "Invoice Dates Missing"
        mTerminate
        Exit Sub
    End If
    Screen.MousePointer = vbHourglass
    gSetMousePointer grdAirTime, grdRevenue, vbHourglass
    ckcType(INVTYPE_Commercial).Visible = False
    For ilLoop = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
        If (tgMVef(ilLoop).sType = "C") Or (tgMVef(ilLoop).sType = "G") Or (tgMVef(ilLoop).sType = "S") Then
            ckcType(INVTYPE_Commercial).Visible = True
            Exit For
        End If
    Next ilLoop
    lbcVehicle.Visible = False
    grdAirTime.Visible = False
    ckcAll.Visible = False
    plcCntr.Visible = False
    If ckcType(INVTYPE_Commercial).Visible = False Then
        ckcType(INVTYPE_GenRepAR).Move ckcType(INVTYPE_Commercial).Left, ckcType(INVTYPE_Commercial).Top
        rbcType(INVGEN_Preliminary).Enabled = False
        ckcShowPrel.Enabled = False
        If (tgSpf.sBLaserForm = "2") And (Trim$(tgUrf(0).sName) = sgCPName) Then
            rbcType(INVGEN_Aff).Enabled = False
        End If
    End If
    If ckcType(INVTYPE_Installment).Visible = False Then
        ckcType(INVTYPE_NTR).Move ckcType(INVTYPE_Installment).Left, ckcType(INVTYPE_Installment).Top
    End If
    If tgSpf.sUsingNTR <> "Y" Then
        ckcType(INVTYPE_NTR).Enabled = False
    End If
    'Market Processing
    mMarketPop
    gAnyClustersDef
    gAnyRepDef
    If (UBound(igRepVefCode) > 0) Or (UBound(igMktVefCode) > 0) Then
        ckcType(INVTYPE_PrintRep).Visible = True
        ckcType(INVTYPE_PrintRep).Value = vbUnchecked
        ckcType(INVTYPE_GenRepAR).Visible = True
        ckcType(INVTYPE_GenRepAR).Value = vbUnchecked
    Else
        ckcType(INVTYPE_PrintRep).Visible = False
        ckcType(INVTYPE_PrintRep).Value = vbUnchecked
        ckcType(INVTYPE_GenRepAR).Visible = False
        ckcType(INVTYPE_GenRepAR).Value = vbUnchecked
        If ckcType(INVTYPE_Installment).Visible = True Then
            ckcType(INVTYPE_NTR).Move ckcType(INVTYPE_Commercial).Left, ckcType(INVTYPE_Installment).Top
            ckcType(INVTYPE_Installment).Move ckcType(INVTYPE_Commercial).Left, ckcType(INVTYPE_PrintRep).Top
        Else
            ckcType(INVTYPE_NTR).Move ckcType(INVTYPE_Commercial).Left, ckcType(INVTYPE_PrintRep).Top
        End If
    End If
    smInvSpotTimeZone = tgSpf.sInvSpotTimeZone
    If tgSpf.sInvSpotTimeZone = "E" Then
        rbcInvSpotTimeZone(0).Value = True
    ElseIf tgSpf.sInvSpotTimeZone = "C" Then
        rbcInvSpotTimeZone(1).Value = True
    ElseIf tgSpf.sInvSpotTimeZone = "M" Then
        rbcInvSpotTimeZone(2).Value = True
    ElseIf tgSpf.sInvSpotTimeZone = "P" Then
        rbcInvSpotTimeZone(3).Value = True
    Else
        rbcInvSpotTimeZone(4).Value = True
    End If
    Screen.MousePointer = vbDefault
    gSetMousePointer grdAirTime, grdRevenue, vbDefault
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mNTR_BuildReprint               *
'*                                                     *
'*             Created:9/04/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Get SBF records for reprint    *
'*                                                     *
'*******************************************************
Private Function mNTR_BuildReprint() As Integer
    Dim ilPass As Integer
    Dim hlFile As Integer
    Dim ilRet As Integer
    Dim ilExtLen As Integer
    Dim llNoRec As Long
    Dim ilMnfSort As Integer
    Dim llSbfCode As Long
    Dim ilOffSet As Integer
    Dim ilFound As Integer
    Dim ilLoop As Integer
    Dim slKey As String
    Dim llRecPos As Long
    Dim slDate As String
    Dim slInvNo As String
    Dim sCashTrade As String
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
    '12/31/17
    Dim llMergeInvNo As Long
    Dim ilMerge As Integer
    '1/11/18
    Dim tlSbf As SBF
    Dim slTranDate As String
    Dim ilIncludeNTR As Integer
    
    'TTP 10476 - Installment NTR invoice reprint: not all NTR items are being included
    'ilPass: 1 = Receivables, 2 = History
    'For ilPass = 1 To 2 Step 1
    'TTP 10648 - NTR invoice reprint: blank reprint invoice after zero purging records when payment was an on account payment that was applied
    'ilPass 0=rvf+IN, 1=phf+IN, 2=phf+HI
    For ilPass = 0 To 2 Step 1
        'TTP 10476 - Installment NTR invoice reprint: not all NTR items are being included
        'If ilPass = 1 Then
        If ilPass = 0 Then
            hlFile = hmRvf
        Else
            hlFile = hmPhf
        End If
        ilExtLen = Len(tmRvf)  'Extract operation record size
        llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlRvf) 'Obtain number of records
        btrExtClear hlFile   'Clear any previous extend operation
        ilRet = btrGetFirst(hlFile, tmRvf, imRvfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_END_OF_FILE Then
            'TTP 10476 - Installment NTR invoice reprint: not all NTR items are being included
            'TTP 10648
            'If ilPass = 1 Then
            If ilPass = 0 Then
                Call btrExtSetBounds(hlFile, llNoRec, -1, "UC", "RVF", "") 'Set extract limits (all records)
            Else
                Call btrExtSetBounds(hlFile, llNoRec, -1, "UC", "PHF", "") 'Set extract limits (all records)
            End If
            'TTP 10648
            'If ilPass = 1 Then
            If ilPass <> 2 Then
                tlCharTypeBuff.sType = "I"
            Else
                tlCharTypeBuff.sType = "H"
            End If
            ilOffSet = gFieldOffset("Rvf", "RvfTranType")
            ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
            If ilRet <> BTRV_ERR_NONE Then
                mNTR_BuildReprint = ilRet
                Exit Function
            End If
            'TTP 10648
            'If ilPass = 1 Then
            If ilPass <> 2 Then
                tlCharTypeBuff.sType = "N"
            Else
                tlCharTypeBuff.sType = "I"
            End If
            ilOffSet = gFieldOffset("Rvf", "RvfTranType") + 1
            ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
            If ilRet <> BTRV_ERR_NONE Then
                mNTR_BuildReprint = ilRet
                Exit Function
            End If
            ilMnfSort = 0
            ilOffSet = gFieldOffset("Rvf", "RvfMnfItem")
            ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_INT, ilOffSet, 2, BTRV_EXT_NOT_EQUAL, BTRV_EXT_AND, ilMnfSort, 2)
            If ilRet <> BTRV_ERR_NONE Then
                mNTR_BuildReprint = ilRet
                Exit Function
            End If
            llSbfCode = 0
            ilOffSet = gFieldOffset("Rvf", "RvfSbfCode")
            ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_INT, ilOffSet, 4, BTRV_EXT_GT, BTRV_EXT_LAST_TERM, llSbfCode, 4)
            If ilRet <> BTRV_ERR_NONE Then
                mNTR_BuildReprint = ilRet
                Exit Function
            End If
            ilOffSet = 0
            ilRet = btrExtAddField(hlFile, ilOffSet, ilExtLen)  'Extract First Name field
            If ilRet <> BTRV_ERR_NONE Then
                imBuildingAdvt = False
                Exit Function
            End If
            ilRet = btrExtGetNext(hlFile, tmRvf, ilExtLen, llRecPos)
            If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
                If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                    imBuildingAdvt = False
                    Exit Function
                End If
                ilExtLen = Len(tmRvf)  'Extract operation record size
                Do While ilRet = BTRV_ERR_REJECT_COUNT
                    ilRet = btrExtGetNext(hlFile, tmRvf, ilExtLen, llRecPos)
                Loop
                Do While ilRet = BTRV_ERR_NONE
                    ilFound = False
                    llMergeInvNo = -1
                    If ilPass > 1 Then
                        For ilMerge = 0 To UBound(tgAdvanceBillMergeInfo) - 1 Step 1
                            If tmRvf.lInvNo = tgAdvanceBillMergeInfo(ilMerge).lPhfInvNo Then
                                llMergeInvNo = tgAdvanceBillMergeInfo(ilMerge).lRvfInvNo
                                Exit For
                            End If
                        Next ilMerge
                    End If
                    For ilLoop = 0 To UBound(tmRPInfo) - 1 Step 1
                        If (tmRPInfo(ilLoop).iMnfItem > 0) Or (tmRPInfo(ilLoop).iMnfItem = -1) Then
                            If (tmRvf.lCntrNo = tmRPInfo(ilLoop).lCntrNo) And ((tmRvf.lInvNo = tmRPInfo(ilLoop).lInvNo) Or (llMergeInvNo = tmRPInfo(ilLoop).lInvNo)) Then
                                llSbfCode = tmRvf.lSbfCode
                                sCashTrade = tmRPInfo(ilLoop).sCashTrade
                                ilFound = True
                            End If
                        End If
                    Next ilLoop
                    If ilFound Then
                        gUnpackDate tmRvf.iTranDate(0), tmRvf.iTranDate(1), slTranDate
                        ilFound = False
                        For ilLoop = LBound(tgSbfCntr) To UBound(tgSbfCntr) - 1 Step 1
                            If tgSbfCntr(ilLoop).tSbf.lCode = tmRvf.lSbfCode Then
                                ilFound = True
                                tgSbfCntr(ilLoop).lTax1 = tgSbfCntr(ilLoop).lTax1 + tmRvf.lTax1
                                tgSbfCntr(ilLoop).lTax2 = tgSbfCntr(ilLoop).lTax2 + tmRvf.lTax2
                                Exit For
                            End If
                        Next ilLoop
                        If Not ilFound Then
                            tmSbfSrchKey1.lCode = tmRvf.lSbfCode
                            ilRet = btrGetEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)
                            If (ilRet = BTRV_ERR_NONE) Then
                                tmChfSrchKey.lCode = tmSbf.lChfCode
                                ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                If (ilRet = BTRV_ERR_NONE) Then
                                    If ((tmSbf.sTranType = "I") And (tgChfInv.sInstallDefined <> "Y")) Then
                                        slKey = Trim$(str$(tmSbf.lChfCode))
                                        Do While Len(slKey) < 8
                                            slKey = "0" & slKey
                                        Loop
                                        slInvNo = Trim(str$(tmRvf.lInvNo))
                                        Do While Len(slInvNo) < 8
                                            slInvNo = "0" & slInvNo
                                        Loop
                                        gUnpackDate tmSbf.iDate(0), tmSbf.iDate(1), slDate
                                        slDate = Trim$(str$(gDateValue(slDate)))
                                        Do While Len(slDate) < 5
                                            slDate = "0" & slDate
                                        Loop
                                        tgSbfCntr(UBound(tgSbfCntr)).sKey = slKey & slInvNo & slDate
                                        tgSbfCntr(UBound(tgSbfCntr)).lSDate = Val(slDate)
                                        tgSbfCntr(UBound(tgSbfCntr)).tSbf = tmSbf
                                        If llMergeInvNo = -1 Then
                                            tgSbfCntr(UBound(tgSbfCntr)).lInvNo = tmRvf.lInvNo
                                        Else
                                            tgSbfCntr(UBound(tgSbfCntr)).lInvNo = llMergeInvNo
                                        End If
                                        tgSbfCntr(UBound(tgSbfCntr)).lTax1 = tmRvf.lTax1
                                        tgSbfCntr(UBound(tgSbfCntr)).lTax2 = tmRvf.lTax2
                                        tgSbfCntr(UBound(tgSbfCntr)).sCashTrade = sCashTrade 'L.Bianchi 07/08/2021
                                        gUnpackDateLongError tmRvf.iTranDate(0), tmRvf.iTranDate(1), tgSbfCntr(UBound(tgSbfCntr)).lInvDate, "48:mNTR_BuildReprint " & tmRvf.lCode
                                        ReDim Preserve tgSbfCntr(0 To UBound(tgSbfCntr) + 1) As SBFCNTR
                                        'TTP 10605 - NTR only invoice reprint: when reprinting a single NTR only invoice, the header is not showing "NTR Invoice and Affidavit", it shows "Invoice and Affidavit"
                                        'Fix TTP 10826 / TTP 10813 - RE: v81 TTP 10826 - updated test results Issue #4
                                        mSetAirNTRStatus tmRvf.lCntrNo, "NTR", IIF(tmRvf.iAgfCode = 0, tmRvf.iAdfCode, tmRvf.iAgfCode)
                                    ElseIf ((tmSbf.sTranType = "F" Or tmSbf.sTranType = "I") And (tgChfInv.sInstallDefined = "Y")) Then
                                        'Get sbf with type = "I" that match mnfItem
                                        tmSbfSrchKey0.lChfCode = tmSbf.lChfCode
                                        tmSbfSrchKey0.sTranType = "I"
                                        ilRet = btrGetGreaterOrEqual(hmSbf, tlSbf, imSbfRecLen, tmSbfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)
                                        Do While (ilRet = BTRV_ERR_NONE) And (tmSbf.lChfCode = tlSbf.lChfCode)
                                            gUnpackDate tlSbf.iDate(0), tlSbf.iDate(1), slDate
                                            ilIncludeNTR = False
                                            If tgChfInv.sBillCycle = "C" Then
                                                If (gDateValue(slDate) >= gDateValue(gObtainStartCal(slTranDate))) And (gDateValue(slDate) <= gDateValue(gObtainEndCal(slTranDate))) Then
                                                    ilIncludeNTR = True
                                                End If
                                            ElseIf tgChfInv.sBillCycle = "W" Then
                                                If (gDateValue(slDate) >= gDateValue(gObtainPrevMonday(slTranDate))) And (gDateValue(slDate) <= gDateValue(gObtainNextSunday(slTranDate))) Then
                                                    ilIncludeNTR = True
                                                End If
                                            Else
                                                If (gDateValue(slDate) >= gDateValue(gObtainStartStd(slTranDate))) And (gDateValue(slDate) <= gDateValue(gObtainEndStd(slTranDate))) Then
                                                    ilIncludeNTR = True
                                                End If
                                            End If
                                            'TTP 10476 - Installment NTR invoice reprint: not all NTR items are being included
                                            If ilIncludeNTR Then 'Check if this sbf (with type = "I") that matches the mnfItem
                                                If tlSbf.iMnfItem <> tmSbf.iMnfItem Then
                                                    ilIncludeNTR = False
                                                End If
                                            End If
                                            If ilIncludeNTR Then
                                                slKey = Trim$(str$(tlSbf.lChfCode))
                                                Do While Len(slKey) < 8
                                                    slKey = "0" & slKey
                                                Loop
                                                slInvNo = Trim(str$(tmRvf.lInvNo))
                                                Do While Len(slInvNo) < 8
                                                    slInvNo = "0" & slInvNo
                                                Loop
                                                slDate = Trim$(str$(gDateValue(slDate)))
                                                Do While Len(slDate) < 5
                                                    slDate = "0" & slDate
                                                Loop
                                                tgSbfCntr(UBound(tgSbfCntr)).sKey = slKey & slInvNo & slDate
                                                tgSbfCntr(UBound(tgSbfCntr)).lSDate = Val(slDate)
                                                tgSbfCntr(UBound(tgSbfCntr)).tSbf = tlSbf
                                                If llMergeInvNo = -1 Then
                                                    tgSbfCntr(UBound(tgSbfCntr)).lInvNo = tmRvf.lInvNo
                                                Else
                                                    tgSbfCntr(UBound(tgSbfCntr)).lInvNo = llMergeInvNo
                                                End If
                                                tgSbfCntr(UBound(tgSbfCntr)).lTax1 = tmRvf.lTax1
                                                tgSbfCntr(UBound(tgSbfCntr)).lTax2 = tmRvf.lTax2
                                                tgSbfCntr(UBound(tgSbfCntr)).sCashTrade = sCashTrade 'L.Bianchi 07/08/2021
                                                gUnpackDateLongError tmRvf.iTranDate(0), tmRvf.iTranDate(1), tgSbfCntr(UBound(tgSbfCntr)).lInvDate, "48:mNTR_BuildReprint " & tmRvf.lCode
                                                ReDim Preserve tgSbfCntr(0 To UBound(tgSbfCntr) + 1) As SBFCNTR
                                                'TTP 10605 - NTR only invoice reprint: when reprinting a single NTR only invoice, the header is not showing "NTR Invoice and Affidavit", it shows "Invoice and Affidavit"
                                                'Fix TTP 10826 / TTP 10813 - RE: v81 TTP 10826 - updated test results Issue #4
                                                mSetAirNTRStatus tmRvf.lCntrNo, "NTR", IIF(tmRvf.iAgfCode = 0, tmRvf.iAdfCode, tmRvf.iAgfCode)
                                            End If
                                            ilRet = btrGetNext(hmSbf, tlSbf, imSbfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
                                        Loop
                                        
                                    End If
                                End If
                            End If
                        End If
                    End If
                    ilRet = btrExtGetNext(hlFile, tmRvf, ilExtLen, llRecPos)
                    Do While ilRet = BTRV_ERR_REJECT_COUNT
                        ilRet = btrExtGetNext(hlFile, tmRvf, ilExtLen, llRecPos)
                    Loop
                Loop
            End If
        End If
    Next ilPass
    mNTR_BuildReprint = BTRV_ERR_NONE
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mForm2Key                       *
'*                                                     *
'*             Created:6/16/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Code matches mResetFieldsForIvr*
'*                      and is used to form the key    *
'*                      in the case that               *
'*                      mResetFieldsForIvr is not      *
'*                      called (spots founded not      *
'*                      ignored- bonus not to be       *
'*                      invoiced)                      *
'*                                                     *
'*******************************************************
Private Function mForm2Key(llSdfIndex As Long) As String
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  slStr                                                                                 *
'******************************************************************************************
    Dim ilLoop As Integer
    Dim ilStartPos As Integer
    Dim ilEndPos As Integer
    ReDim slFields(0 To 13) As String   'Index zero ignored

    ilStartPos = 1
    For ilLoop = LBONE To UBound(slFields) Step 1
        ilEndPos = InStr(ilStartPos, tgSortKey(llSdfIndex).sKey, "|", 1)
        If ilEndPos > 0 Then
            slFields(ilLoop) = Mid$(tgSortKey(llSdfIndex).sKey, ilStartPos, ilEndPos - ilStartPos)
            ilStartPos = ilEndPos + 1
        Else
            If ilLoop = UBound(slFields) Then
                slFields(ilLoop) = Mid$(tgSortKey(llSdfIndex).sKey, ilStartPos)
            Else
                slFields(ilLoop) = ""
            End If
        End If
    Next ilLoop
    If Trim$(tgSortKey(llSdfIndex).sAdjAirTime) <> "" Then
        slFields(12) = tgSortKey(llSdfIndex).sAdjAirTime
    End If

    mForm2Key = slFields(1) & slFields(2) & slFields(3) & slFields(4)
End Function

Private Sub mGetTeams(ilVefCode As Integer, ilGameNo As Integer, llWkDate As Long, slVisitTeam As String, slHomeTeam As String, slAbbrVisitTeam As String, slAbbrHomeTeam As String)
    Dim ilRet As Integer
    Dim ilTeam As Integer
    Dim llMoDate As Long
    Dim llDate As Long

    slVisitTeam = ""
    slHomeTeam = ""
    llDate = llWkDate
    Do While gWeekDayLong(llDate) <> 0
        llDate = llDate - 1
    Loop
    llMoDate = llDate
    tmGsfSrchKey3.iVefCode = ilVefCode
    tmGsfSrchKey3.iGameNo = ilGameNo
    ilRet = btrGetGreaterOrEqual(hmGsf, tmGsf, imGsfRecLen, tmGsfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE)   'Get last current record to obtain date
    Do While (ilRet = BTRV_ERR_NONE) And (tmGsf.iVefCode = ilVefCode) And (tmGsf.iGameNo = ilGameNo)
        gUnpackDateLong tmGsf.iAirDate(0), tmGsf.iAirDate(1), llDate
        If (llDate >= llMoDate) And (llDate <= llMoDate + 6) Then
            Exit Do
        End If
        ilRet = btrGetNext(hmGsf, tmGsf, imGsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
    Loop
    If (ilRet = BTRV_ERR_NONE) And (tmGsf.iVefCode = ilVefCode) And (tmGsf.iGameNo = ilGameNo) Then
        For ilTeam = LBound(tmTeam) To UBound(tmTeam) - 1 Step 1 'Traffic!lbcAgency.ListCount - 1 Step 1
            If tmGsf.iVisitMnfCode = tmTeam(ilTeam).iCode Then
                slVisitTeam = Trim$(tmTeam(ilTeam).sName)
                If Trim$(tmTeam(ilTeam).sUnitType) <> "" Then
                    slAbbrVisitTeam = Trim$(tmTeam(ilTeam).sUnitType)
                Else
                    slAbbrVisitTeam = Left$(slVisitTeam, 4)
                End If
                Exit For
            End If
        Next ilTeam
        For ilTeam = LBound(tmTeam) To UBound(tmTeam) - 1 Step 1 'Traffic!lbcAgency.ListCount - 1 Step 1
            If tmGsf.iHomeMnfCode = tmTeam(ilTeam).iCode Then
                slHomeTeam = "@" & Trim$(tmTeam(ilTeam).sName)
                If Trim$(tmTeam(ilTeam).sUnitType) <> "" Then
                    slAbbrHomeTeam = Trim$(tmTeam(ilTeam).sUnitType)
                Else
                    slAbbrHomeTeam = Left$(slHomeTeam, 4)
                End If
                Exit For
            End If
        Next ilTeam
    End If
End Sub

Private Sub mSetViewControl()
    Dim ilLoop As Integer
    Dim llDate As Long
    Dim slDate As String
    Dim slGameNo As String
    Dim slStr As String

    gLogMsg "Invoice Not Marked as Complete " & Format$(gNow(), "m/d/yy"), "NotMarkedComplete.Txt", True

    For ilLoop = LBound(tgNotMarkComplete) To UBound(tgNotMarkComplete) - 1 Step 1
        llDate = gDateValue(tgNotMarkComplete(ilLoop).sDate)
        slDate = Trim$(str$(llDate))
        Do While Len(slDate) < 6
            slDate = "0" & slDate
        Loop
        slGameNo = Trim$(str$(tgNotMarkComplete(ilLoop).iGameNo))
        '6/30/12:  Allow 5 digit event #'s
        Do While Len(slGameNo) < 5  '4
            slGameNo = "0" & slGameNo
        Loop
        tgNotMarkComplete(ilLoop).sKey = tgNotMarkComplete(ilLoop).sVehName & "|" & slDate & "|" & slGameNo
    Next ilLoop
    If UBound(tgNotMarkComplete) - 1 > 0 Then
        ArraySortTyp fnAV(tgNotMarkComplete(), 0), UBound(tgNotMarkComplete), 0, LenB(tgNotMarkComplete(0)), 0, LenB(tgNotMarkComplete(0).sKey), 0
    End If
    If UBound(tgNotMarkComplete) > LBound(tgNotMarkComplete) Then
        For ilLoop = LBound(tgNotMarkComplete) To UBound(tgNotMarkComplete) - 1 Step 1
            slStr = Trim$(tgNotMarkComplete(ilLoop).sVehName)
            If tgNotMarkComplete(ilLoop).iGameNo > 0 Then
                slStr = slStr & " Event " & Trim$(str$(tgNotMarkComplete(ilLoop).iGameNo)) & " on " & tgNotMarkComplete(ilLoop).sDate
            Else
                slStr = slStr & " " & tgNotMarkComplete(ilLoop).sDate
            End If
            gLogMsg slStr, "NotMarkedComplete.Txt", False
        Next ilLoop
        'cmcView.Visible = True
        'cmcView.Enabled = True
        mSetViewListColumnWidth 0
        mPopViewList 0
        lbcView.Visible = True
        'JW Fix lbcView, add Close button
        lbcView.ZOrder (0)
        lbcView.Height = 3000
        lbcView.Top = (Me.ScaleHeight - lbcView.Height) / 2
        lbcView.Left = (Me.ScaleWidth - lbcView.Width) / 2
    Else
        cmcView.Visible = False
        cmcView.Enabled = False
    End If
End Sub

Private Function mGetVefLockBox(tlChf As CHF) As Integer
    Dim ilTest As Integer
    Dim ilVefLockBox As Integer
    Dim ilVefCode As Integer
    Dim ilRet As Integer
    Dim ilLoop As Integer

    ilVefLockBox = False
    If ((Asc(tgSpf.sUsingFeatures4) And LOCKBOXBYVEHICLE) = LOCKBOXBYVEHICLE) Then
        If (imInvGenType = 0) And (tgSpf.sBCombine = "N") And (imSeparateVefCode > 0) Then
            ilTest = gBinarySearchVef(imSeparateVefCode)
            If ilTest <> -1 Then
                If Trim$(tgMVef(ilTest).sAddr(0)) <> "" Then
                    ilVefLockBox = True
                    tmArf.sNmAd(0) = tgMVef(ilTest).sAddr(0)
                    tmArf.sNmAd(1) = tgMVef(ilTest).sAddr(1)
                    tmArf.sNmAd(2) = tgMVef(ilTest).sAddr(2)
                    tmArf.sNmAd(3) = " "
                    tmArf.iCode = 0
                End If
                '5-24-13 get 4th line of address
                tmVffSrchKey1.iCode = tgMVef(ilTest).iCode
                ilRet = btrGetEqual(hmVff, tmVff, imVffRecLen, tmVffSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)

                If ilRet = BTRV_ERR_NONE Then
                    tmArf.sNmAd(3) = tmVff.sAddr4
                End If

            End If
        Else
            If tlChf.lVefCode > 0 Then
                ilVefCode = tlChf.lVefCode
                ilTest = gBinarySearchVef(ilVefCode)
                If ilTest <> -1 Then
                    If Trim$(tgMVef(ilTest).sAddr(0)) <> "" Then
                        ilVefLockBox = True
                        tmArf.sNmAd(0) = tgMVef(ilTest).sAddr(0)
                        tmArf.sNmAd(1) = tgMVef(ilTest).sAddr(1)
                        tmArf.sNmAd(2) = tgMVef(ilTest).sAddr(2)
                        tmArf.sNmAd(3) = " "
                        tmArf.iCode = 0
                    End If
                    '5-24-13 get 4th line of address
                    tmVffSrchKey1.iCode = tgMVef(ilTest).iCode
                    ilRet = btrGetEqual(hmVff, tmVff, imVffRecLen, tmVffSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)
    
                    If ilRet = BTRV_ERR_NONE Then
                        tmArf.sNmAd(3) = tmVff.sAddr4
                    End If
                End If
            ElseIf tlChf.lVefCode < 0 Then
                tmVsfSrchKey.lCode = -tlChf.lVefCode
                ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                Do While ilRet = BTRV_ERR_NONE
                    For ilLoop = LBound(tmVsf.iFSCode) To UBound(tmVsf.iFSCode) Step 1
                        If tmVsf.iFSCode(ilLoop) > 0 Then
                            ilVefCode = tmVsf.iFSCode(ilLoop)
                            ilTest = gBinarySearchVef(ilVefCode)
                            If ilTest <> -1 Then
                                If Trim$(tgMVef(ilTest).sAddr(0)) <> "" Then
                                    ilVefLockBox = True
                                    tmArf.sNmAd(0) = tgMVef(ilTest).sAddr(0)
                                    tmArf.sNmAd(1) = tgMVef(ilTest).sAddr(1)
                                    tmArf.sNmAd(2) = tgMVef(ilTest).sAddr(2)
                                    tmArf.sNmAd(3) = " "
                                    tmArf.iCode = 0
                                    Exit Do
                                End If
                                '5-24-13 get 4th line of address
                                tmVffSrchKey1.iCode = tgMVef(ilTest).iCode
                                ilRet = btrGetEqual(hmVff, tmVff, imVffRecLen, tmVffSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)
                
                                If ilRet = BTRV_ERR_NONE Then
                                    tmArf.sNmAd(3) = tmVff.sAddr4
                                End If
                            End If
                        End If
                    Next ilLoop
                    If (tmVsf.lLkVsfCode <= 0) Then
                        Exit Do
                    End If
                    tmVsfSrchKey.lCode = tmVsf.lLkVsfCode
                    ilRet = btrGetEqual(hmVsf, tmVsf, imVsfRecLen, tmVsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop
            End If
        End If
    End If
    mGetVefLockBox = ilVefLockBox
End Function

'If sUsingFeatures4, INVSORTBYVEHICLE then
'   1. populates a list of Agencies and Direct Advertisers
'   2. populates a list of Vehicles
Private Sub mBuildInvVehicleSort()
    Dim ilAgf As Integer
    Dim ilAdf As Integer
    Dim ilVef As Integer
    
    lbcSortAgyAdvtDir.Clear
    lbcSortVehicle.Clear
    If (Asc(tgSpf.sUsingFeatures4) And INVSORTBYVEHICLE) = INVSORTBYVEHICLE Then
        For ilAgf = LBound(tgCommAgf) To UBound(tgCommAgf) - 1 Step 1
            lbcSortAgyAdvtDir.AddItem Trim$(tgCommAgf(ilAgf).sName) & "/" & Trim$(tgCommAgf(ilAgf).sCityID)
            lbcSortAgyAdvtDir.ItemData(lbcSortAgyAdvtDir.NewIndex) = tgCommAgf(ilAgf).iCode
        Next ilAgf
        For ilAdf = LBound(tgCommAdf) To UBound(tgCommAdf) - 1 Step 1
            If tgCommAdf(ilAdf).sBillAgyDir = "D" Then
                If Trim$(tgCommAdf(ilAdf).sAddrID) <> "" Then
                    lbcSortAgyAdvtDir.AddItem Trim$(tgCommAdf(ilAdf).sName) & ", " & Trim$(tgCommAdf(ilAdf).sAddrID)
                Else
                    lbcSortAgyAdvtDir.AddItem Trim$(tgCommAdf(ilAdf).sName) & "/Direct"
                End If
                lbcSortAgyAdvtDir.ItemData(lbcSortAgyAdvtDir.NewIndex) = tgCommAdf(ilAdf).iCode
            End If
        Next ilAdf
        For ilVef = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
            lbcSortVehicle.AddItem Trim$(tgMVef(ilVef).sName)
            lbcSortVehicle.ItemData(lbcSortVehicle.NewIndex) = tgMVef(ilVef).iCode
        Next ilVef
    End If
End Sub

Private Sub mCheckAirCntr()
    Dim slStartDate As String
    Dim slEndDate As String
    Dim slStatus As String
    Dim slCntrType As String
    Dim ilHOType As Integer
    Dim ilRet As Integer
    Dim ilChf As Integer
    Dim llChfCode As Long
    Dim ilFound As Integer
    Dim ilIndex As Integer
    Dim llEarliestDate As Long
    ReDim tmAirCntStatus(0 To 0) As INVCNTRSTATUS
    
    imAirStatusConflict = False
    If rbcCntr(INVCNTR_Selective).Value Or rbcCntr(INVCNTR_WOExpired).Value Or rbcCntr(INVCNTR_Posted).Value Then
        For ilChf = 0 To UBound(lmSelCntrCode) - 1 Step 1
            llChfCode = lmSelCntrCode(ilChf)
            mCheckChf llChfCode, llEarliestDate
        Next ilChf
    Else
        If (lmStartStd > 0) Or (lmStartCal > 0) Or (lmStartWk > 0) Then
            slStartDate = ""
            If lmStartStd > 0 Then
                slStartDate = smStartStd
            End If
            If (lmStartCal > 0) And ((lmStartCal < gDateValue(slStartDate)) Or (slStartDate = "")) Then
                slStartDate = smStartCal
            End If
            If (lmStartWk > 0) And ((lmStartWk < gDateValue(slStartDate)) Or (slStartDate = "")) Then
                slStartDate = smStartWk
            End If
            slEndDate = ""
            If lmEndStd > 0 Then
                slEndDate = smEndStd
            End If
            If (lmEndCal > 0) And ((lmEndCal > gDateValue(slEndDate)) Or (slEndDate = "")) Then
                slEndDate = smEndCal
            End If
            If (lmEndWk > 0) And ((lmEndWk > gDateValue(slEndDate)) Or (slEndDate = "")) Then
                slEndDate = smEndWk
            End If
            slStatus = "HO"
            slCntrType = ""
            ilHOType = 1
            sgCntrForDateStamp = ""
            ilRet = gObtainCntrForDate(Invoice, slStartDate, slEndDate, slStatus, slCntrType, ilHOType, tgChfAdvtExt())
        Else
            Exit Sub
        End If
        For ilChf = LBound(tgChfAdvtExt) To UBound(tgChfAdvtExt) - 1 Step 1
            llChfCode = tgChfAdvtExt(ilChf).lCode
            mCheckChf llChfCode, llEarliestDate
        Next ilChf
    End If
    imAirStatusConflict = False
    For ilIndex = 0 To UBound(tmAirCntStatus) - 1 Step 1
        If mCompareChfInPast("A", tmAirCntStatus(ilIndex).lChfCodeSchd, tmAirCntStatus(ilIndex).lChfCodeAltered, tmAirCntStatus(ilIndex).lEarliestDate, tmAirCntStatus(ilIndex).sBillCycle) Then
            tmAirCntStatus(ilIndex).lChfCodeSchd = 0
            tmAirCntStatus(ilIndex).lChfCodeAltered = 0
        Else
            imAirStatusConflict = True
        End If
    Next ilIndex
    Exit Sub
End Sub

Private Sub mSetClfComment()
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilPos                                                                                 *
'******************************************************************************************
    Dim ilRet As Integer
    Dim slStr As String
    
    tmIvr.lClfCode = tmClf.lCode
    tmIvr.lClfCxfCode = 0
    If tmClf.lCxfCode <> 0 Then
        tmCxf.sComment = ""
        imCxfRecLen = Len(tmCxf) '5027
        tmCxSrchKey.lCode = tmClf.lCxfCode
        ilRet = btrGetEqual(hmCxf, tmCxf, imCxfRecLen, tmCxSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If (ilRet = BTRV_ERR_NONE) Then
            slStr = gStripChr0(tmCxf.sComment)
            'If (tmCxf.iStrLen > 0) And (tmCxf.sShInv = "Y") Then
            If (slStr <> "") And (tmCxf.sShInv = "Y") Then
                tmIvr.lClfCxfCode = tmClf.lCxfCode
            End If
        End If
    End If
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mInstall_ReadRec                    *
'*                                                     *
'*             Created:9/04/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Read NTR records               *
'*                                                     *
'*******************************************************
Function mInstall_ReadRec() As Integer
'
'   iRet = mRepInv_ReadRec
'   Where:
'       iRet (O)- True if record read,
'                 False if not read
'
    Dim ilRet As Integer    'Return status
    Dim slKey As String
    Dim slDate As String
    Dim ilAdd As Integer
    Dim ilLoop As Integer
    Dim ilIndex As Integer
    Dim ilFound As Integer
    Dim llEarliestDate As Long
    Dim blStdCntrTest As Boolean
    Dim llEndCalDate As Long
    Dim llEndWkDate As Long
    Dim llEndStdDate As Long
    Dim ilSbf As Integer
    Dim slChfStartDate As String

    ReDim tgSbfInstall(0 To 0) As SBFCNTR
    ReDim tmInstallCntStatus(0 To 0) As INVCNTRSTATUS
    ReDim llSbfCode(0 To 0) As Long
    imInstallStatusConflict = False
    If (Asc(tgSpf.sUsingFeatures6) And INSTALLMENT) <> INSTALLMENT Then
        mInstall_ReadRec = True
        Exit Function
    End If
    imSbfRecLen = Len(tmSbf)
    If (rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Archive).Value) Then          '11-15-16 reprint or archive
        'Need to have created an array of sbf records to reprint
        ilRet = mInstall_BuildReprint()
    ElseIf (rbcType(INVGEN_Preliminary).Value) Or (rbcType(INVGEN_Final).Value) Then
        '12/28/17: Get the possible advance Billing Contracts (only one date defined for the installment)
        gGetAdvanceBillInfo
        llEndCalDate = 0
        llEndWkDate = 0
        llEndStdDate = 0
        If lmEndCal > 0 Then
            llEndCalDate = gDateValue(gObtainEndCal(Format(lmEndCal, "ddddd")))
        End If
        If lmEndWk > 0 Then
            llEndWkDate = gDateValue(gObtainNextSunday(Format(lmEndWk, "ddddd")))
        End If
        If lmEndStd > 0 Then
            llEndStdDate = gDateValue(gObtainEndStd(Format(lmEndStd, "ddddd")))
        End If
        tmSbfSrchKey2.sTranType = "F"
        'If lmStartCal < lmStartStd Then
        '    gPackDate smStartCal, tmSbfSrchKey2.iDate(0), tmSbfSrchKey2.iDate(1)
        'Else
        '    gPackDate smStartStd, tmSbfSrchKey2.iDate(0), tmSbfSrchKey2.iDate(1)
        'End If
        slDate = ""
        If lmStartStd > 0 Then
            slDate = smStartStd
        End If
        If (lmStartCal > 0) And ((lmStartCal < gDateValue(slDate)) Or (slDate = "")) Then
            slDate = smStartCal
        End If
        If (lmStartWk > 0) And ((lmStartWk < gDateValue(slDate)) Or (slDate = "")) Then
            slDate = smStartWk
        End If
        gPackDate slDate, tmSbfSrchKey2.iDate(0), tmSbfSrchKey2.iDate(1)
        ilRet = btrGetGreaterOrEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        Do While (ilRet = BTRV_ERR_NONE) And (tmSbf.sTranType = "F")
            If tmSbf.sBilled <> "Y" Then
                ilFound = False
                For ilLoop = 0 To UBound(llSbfCode) - 1 Step 1
                    If tmSbf.lCode = llSbfCode(ilLoop) Then
                        ilFound = True
                        Exit For
                    End If
                Next ilLoop
                If Not ilFound Then
                    llSbfCode(UBound(llSbfCode)) = tmSbf.lCode
                    ReDim Preserve llSbfCode(0 To UBound(llSbfCode) + 1) As Long
                End If
            End If
            ilRet = btrGetNext(hmSbf, tmSbf, imSbfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        Loop
        For ilSbf = 0 To UBound(tgAdanceBillInfo) - 1 Step 1
            tmSbfSrchKey0.lChfCode = tgAdanceBillInfo(ilSbf).lChfCode
            tmSbfSrchKey0.iDate(0) = 0
            tmSbfSrchKey0.iDate(1) = 0
            tmSbfSrchKey0.sTranType = "F"
            ilRet = btrGetGreaterOrEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
            Do While (ilRet = BTRV_ERR_NONE) And (tmSbf.sTranType = "F") And (tmSbf.lChfCode = tgAdanceBillInfo(ilSbf).lChfCode)
                If tmSbf.sBilled <> "Y" Then
                    ilFound = False
                    For ilLoop = 0 To UBound(llSbfCode) - 1 Step 1
                        If tmSbf.lCode = llSbfCode(ilLoop) Then
                            ilFound = True
                            Exit For
                        End If
                    Next ilLoop
                    If Not ilFound Then
                        llSbfCode(UBound(llSbfCode)) = tmSbf.lCode
                        ReDim Preserve llSbfCode(0 To UBound(llSbfCode) + 1) As Long
                    End If
                End If
                ilRet = btrGetNext(hmSbf, tmSbf, imSbfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
        Next ilSbf
        For ilSbf = 0 To UBound(llSbfCode) - 1 Step 1
            tmSbfSrchKey1.lCode = llSbfCode(ilSbf)
            ilRet = btrGetEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)
            If ilRet = BTRV_ERR_NONE And tmSbf.sBilled <> "Y" Then
                If ((Asc(tgSpf.sUsingFeatures3) And USINGHUB) = USINGHUB) And (tgUrf(0).iMnfHubCode > 0) Then
                    ilRet = gBinarySearchVef(tmSbf.iBillVefCode)
                    If ilRet <> -1 Then
                        ilAdd = True
                    Else
                        ilAdd = False
                    End If
                Else
                    ilAdd = True
                End If
                If ilAdd Then
                    If rbcCntr(INVCNTR_Selective).Value Or rbcCntr(INVCNTR_WOExpired).Value Or rbcCntr(INVCNTR_Posted).Value Then
                        ilAdd = False
                        For ilLoop = 0 To UBound(lmSelCntrCode) - 1 Step 1
                            If tmSbf.lChfCode = lmSelCntrCode(ilLoop) Then
                                ilAdd = True
                                Exit For
                            End If
                        Next ilLoop
                    End If
                End If
                If ilAdd Then
                    If (tgSpf.sInvVehSel = "Y") And (ckcAll.Value = vbUnchecked) Then
                        If Not mAllVehSel("I", tmSbf.lChfCode) Then
                            ilAdd = False
                        End If
                    End If
                End If
                If ilAdd Then
                    If (ckcType(INVTYPE_Commercial).Value = vbUnchecked) And (ckcType(INVTYPE_NTR).Value = vbChecked) And ((Asc(tgSpf.sUsingFeatures5) And COMBINEAIRNTR) = COMBINEAIRNTR) And (tgSpf.sUsingNTR = "Y") Then
                        'Only allow contract if no air time
                        ilRet = gObtainChfClf(hmCHF, hmClf, tmSbf.lChfCode, False, tgChfInv, tgClfInv())
                        If UBound(tgClfInv) > LBound(tgClfInv) Then
                            ilAdd = False
                        End If
                    End If
                End If
                If ilAdd Then
                    slKey = Trim$(str$(tmSbf.lChfCode))
                    Do While Len(slKey) < 8
                        slKey = "0" & slKey
                    Loop

                    tmChfSrchKey.lCode = tmSbf.lChfCode
                    ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                    If ilRet = BTRV_ERR_NONE Then
                        '12/28/17: Rule date equal to or prior to end bill date
                        blStdCntrTest = True
                        gUnpackDate tmSbf.iDate(0), tmSbf.iDate(1), slDate
                        gUnpackDate tgChfInv.iStartDate(0), tgChfInv.iStartDate(1), slChfStartDate
                        For ilLoop = 0 To UBound(tgAdanceBillInfo) - 1 Step 1
                            If tgAdanceBillInfo(ilLoop).lChfCode = tmSbf.lChfCode Then
                                blStdCntrTest = False
                                If tgChfInv.sBillCycle = "C" Then
                                    If (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbUnchecked) Then
                                        ilAdd = False
                                    Else
                                        If tgAdanceBillInfo(ilLoop).lDate > gDateValue(gObtainEndCal(slChfStartDate)) Then
                                            If (gDateValue(slDate) > llEndCalDate) Then
                                                ilAdd = False
                                            End If
                                        End If
                                    End If
                                ElseIf tgChfInv.sBillCycle = "W" Then
                                    If (ckcBillCycle(INVBILLCYCLE_Week).Value = vbUnchecked) Then
                                        ilAdd = False
                                    Else
                                        If tgAdanceBillInfo(ilLoop).lDate > gDateValue(gObtainNextSunday(slChfStartDate)) Then
                                            If (gDateValue(slDate) > llEndWkDate) Then
                                                ilAdd = False
                                            End If
                                        End If
                                    End If
                                Else
                                    If (ckcBillCycle(INVBILLCYCLE_STD).Value = vbUnchecked) Then
                                        ilAdd = False
                                    Else
                                        If tgAdanceBillInfo(ilLoop).lDate > gDateValue(gObtainEndStd(slChfStartDate)) Then
                                            If (gDateValue(slDate) > llEndStdDate) Then
                                                ilAdd = False
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        Next ilLoop
                        If blStdCntrTest Then
                            If tgChfInv.sBillCycle = "C" Then
                                If (gDateValue(slDate) > lmEndCal) Or (gDateValue(slDate) < lmStartCal) Or (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbUnchecked) Then
                                    ilAdd = False
                                End If
                            ElseIf tgChfInv.sBillCycle = "W" Then
                                If (gDateValue(slDate) > lmEndWk) Or (gDateValue(slDate) < lmStartWk) Or (ckcBillCycle(INVBILLCYCLE_Week).Value = vbUnchecked) Then
                                    ilAdd = False
                                End If
                            Else
                                If (gDateValue(slDate) > lmEndStd) Or (gDateValue(slDate) < lmStartStd) Or (ckcBillCycle(INVBILLCYCLE_STD).Value = vbUnchecked) Then
                                    ilAdd = False
                                End If
                            End If
                        End If
                    End If
                    If (ilAdd) And (ilRet = BTRV_ERR_NONE) And (tgChfInv.sDelete = "N") And (tgChfInv.iCntRevNo = 0) And ((tgChfInv.sStatus = "W") Or (tgChfInv.sStatus = "C")) Then
                        ilAdd = False
                    End If
                    If (ilAdd) And (ilRet = BTRV_ERR_NONE) And (tgChfInv.sDelete = "N") And (tgChfInv.sStatus <> "D") Then
                        ilFound = False
                        For ilIndex = 0 To UBound(tmInstallCntStatus) - 1 Step 1
                            If tmInstallCntStatus(ilIndex).lCntrNo = tgChfInv.lCntrNo Then
                                ilFound = True
                                'gUnpackDateLong tmSbf.iDate(0), tmSbf.iDate(1), llEarliestDate
                                gUnpackDateLongError tmSbf.iDate(0), tmSbf.iDate(1), llEarliestDate, "51:mInstll_ReadRec " & tmSbf.lCode
                                If llEarliestDate < tmInstallCntStatus(ilIndex).lEarliestDate Then
                                    tmInstallCntStatus(ilIndex).lEarliestDate = llEarliestDate
                                End If
                                If (tgChfInv.sSchStatus = "F") Or (tgChfInv.sSchStatus = "M") Then
                                    tmInstallCntStatus(ilIndex).lChfCodeSchd = tgChfInv.lCode
                                Else
                                    tmInstallCntStatus(ilIndex).lChfCodeAltered = tgChfInv.lCode
                                    tmInstallCntStatus(ilIndex).sSchStatus = tgChfInv.sSchStatus
                                End If
                            End If
                        Next ilIndex
                        If Not ilFound Then
                            ilIndex = UBound(tmInstallCntStatus)
                            tmInstallCntStatus(ilIndex).lCntrNo = tgChfInv.lCntrNo
                            tmInstallCntStatus(ilIndex).iAdfCode = tgChfInv.iAdfCode
                            tmInstallCntStatus(ilIndex).sSchStatus = ""
                            'gUnpackDateLong tmSbf.iDate(0), tmSbf.iDate(1), tmInstallCntStatus(ilIndex).lEarliestDate
                            gUnpackDateLongError tmSbf.iDate(0), tmSbf.iDate(1), tmInstallCntStatus(ilIndex).lEarliestDate, "52:mInstll_ReadRec " & tmSbf.lCode
                            tmInstallCntStatus(ilIndex).sBillCycle = tgChfInv.sBillCycle
                            If (tgChfInv.sSchStatus = "F") Or (tgChfInv.sSchStatus = "M") Then
                                tmInstallCntStatus(ilIndex).lChfCodeSchd = tgChfInv.lCode
                                tmInstallCntStatus(ilIndex).lChfCodeAltered = 0
                            Else
                                tmInstallCntStatus(ilIndex).lChfCodeSchd = 0
                                tmInstallCntStatus(ilIndex).lChfCodeAltered = tgChfInv.lCode
                                tmInstallCntStatus(ilIndex).sSchStatus = tgChfInv.sSchStatus
                            End If
                            ReDim Preserve tmInstallCntStatus(0 To ilIndex + 1) As INVCNTRSTATUS
                        End If
                    End If
                    If (ilAdd) And (ilRet = BTRV_ERR_NONE) And (tgChfInv.sDelete = "N") And (tgChfInv.sStatus <> "D") And ((tgChfInv.sSchStatus = "F") Or (tgChfInv.sSchStatus = "M")) Then
                        slKey = mCreateField1Key(tgChfInv) & slKey
                        gUnpackDate tmSbf.iDate(0), tmSbf.iDate(1), slDate
                        slDate = Trim$(str$(gDateValue(slDate)))
                        Do While Len(slDate) < 5
                            slDate = "0" & slDate
                        Loop
                        tgSbfInstall(UBound(tgSbfInstall)).sKey = slKey & "00000000" + slDate
                        tgSbfInstall(UBound(tgSbfInstall)).lSDate = Val(slDate)
                        tgSbfInstall(UBound(tgSbfInstall)).tSbf = tmSbf
                        ReDim Preserve tgSbfInstall(0 To UBound(tgSbfInstall) + 1) As SBFCNTR
                    End If
                End If
            End If
        Next ilSbf
    End If
    'Sort by Contract and date- process one contract/date at a time
    If UBound(tgSbfInstall) > 0 Then
        ArraySortTyp fnAV(tgSbfInstall(), 0), UBound(tgSbfInstall), 0, LenB(tgSbfInstall(0)), 0, LenB(tgSbfInstall(0).sKey), 0
    End If
    imInstallStatusConflict = False
    For ilIndex = 0 To UBound(tmInstallCntStatus) - 1 Step 1
        If mCompareChfInPast("I", tmInstallCntStatus(ilIndex).lChfCodeSchd, tmInstallCntStatus(ilIndex).lChfCodeAltered, tmInstallCntStatus(ilIndex).lEarliestDate, tmInstallCntStatus(ilIndex).sBillCycle) Then
            tmInstallCntStatus(ilIndex).lChfCodeSchd = 0
            tmInstallCntStatus(ilIndex).lChfCodeAltered = 0
        Else
            imInstallStatusConflict = True
        End If
    Next ilIndex
    mInstall_ReadRec = True
    Exit Function

    On Error GoTo 0
    mInstall_ReadRec = False
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mInstall_BuildReprint               *
'*                                                     *
'*             Created:9/04/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Get SBF records for reprint    *
'*                                                     *
'*******************************************************
Private Function mInstall_BuildReprint() As Integer
    Dim ilPass As Integer
    Dim hlFile As Integer
    Dim ilRet As Integer
    Dim ilExtLen As Integer
    Dim llNoRec As Long
    Dim ilMnfSort As Integer
    Dim llSbfCode As Long
    Dim ilOffSet As Integer
    Dim ilFound As Integer
    Dim ilLoop As Integer
    Dim slKey As String
    Dim llRecPos As Long
    Dim slDate As String
    Dim slInvNo As String
    Dim tlCharTypeBuff As POPCHARTYPE   'Type field record
        
    'TTP 10476 - Installment NTR invoice reprint: not all NTR items are being included
    'For ilPass = 1 To 2 Step 1
    'TTP 10648 - NTR invoice reprint: blank reprint invoice after zero purging records when payment was an on account payment that was applied
    'ilPass 0=rvf+IN, 1=phf+IN, 2=phf+HI
    For ilPass = 0 To 2 Step 1
        'If ilPass = 1 Then
        If ilPass = 0 Then
            hlFile = hmRvf
        Else
            hlFile = hmPhf
        End If
        ilExtLen = Len(tmRvf)  'Extract operation record size
        llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlRvf) 'Obtain number of records
        btrExtClear hlFile   'Clear any previous extend operation
        ilRet = btrGetFirst(hlFile, tmRvf, imRvfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_END_OF_FILE Then
            'TTP 10476 - Installment NTR invoice reprint: not all NTR items are being included
            'TTP 10648
            'If ilPass = 1 Then
            If ilPass = 0 Then
                Call btrExtSetBounds(hlFile, llNoRec, -1, "UC", "RVF", "") 'Set extract limits (all records)
            Else
                Call btrExtSetBounds(hlFile, llNoRec, -1, "UC", "PHF", "") 'Set extract limits (all records)
            End If
            
            'TTP 10648
            'If ilPass = 1 Then
            If ilPass <> 2 Then
                tlCharTypeBuff.sType = "I"
            Else
                tlCharTypeBuff.sType = "H"
            End If
            ilOffSet = gFieldOffset("Rvf", "RvfTranType")
            ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
            If ilRet <> BTRV_ERR_NONE Then
                mInstall_BuildReprint = ilRet
                Exit Function
            End If
            
            'TTP 10648
            'If ilPass = 1 Then
            If ilPass <> 2 Then
                tlCharTypeBuff.sType = "N"
            Else
                tlCharTypeBuff.sType = "I"
            End If
            ilOffSet = gFieldOffset("Rvf", "RvfTranType") + 1
            ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_STRING, ilOffSet, 1, BTRV_EXT_EQUAL, BTRV_EXT_AND, tlCharTypeBuff, 1)
            If ilRet <> BTRV_ERR_NONE Then
                mInstall_BuildReprint = ilRet
                Exit Function
            End If
            
            llSbfCode = 0
            ilOffSet = gFieldOffset("Rvf", "RvfSbfCode")
            ilRet = btrExtAddLogicConst(hlFile, BTRV_KT_INT, ilOffSet, 4, BTRV_EXT_GT, BTRV_EXT_LAST_TERM, llSbfCode, 4)
            If ilRet <> BTRV_ERR_NONE Then
                mInstall_BuildReprint = ilRet
                Exit Function
            End If
            ilOffSet = 0
            ilRet = btrExtAddField(hlFile, ilOffSet, ilExtLen)  'Extract First Name field
            If ilRet <> BTRV_ERR_NONE Then
                imBuildingAdvt = False
                Exit Function
            End If
            'ilRet = btrExtGetNextExt(hlRvf)    'Extract record
            ilRet = btrExtGetNext(hlFile, tmRvf, ilExtLen, llRecPos)
            If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
                If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
                    imBuildingAdvt = False
                    Exit Function
                End If
                ilExtLen = Len(tmRvf)  'Extract operation record size
                Do While ilRet = BTRV_ERR_REJECT_COUNT
                    ilRet = btrExtGetNext(hlFile, tmRvf, ilExtLen, llRecPos)
                Loop
                Do While ilRet = BTRV_ERR_NONE
                    ilFound = False
                    For ilLoop = 0 To UBound(tmRPInfo) - 1 Step 1
                        'TTP 10476 - Installment NTR invoice reprint: not all NTR items are being included
                        'If (tmRPInfo(ilLoop).iMnfItem = 0) Or (tmRPInfo(ilLoop).iMnfItem = -1) Or (tmRPInfo(ilLoop).iMnfItem = tmRvf.iMnfItem) Then
                        'TTP 10484 - Air time invoice reprint: advance installment billing invoice reprint is blank
                        'If (tmRPInfo(ilLoop).iMnfItem > 0) Or (tmRPInfo(ilLoop).iMnfItem = -1) Then
                        If (tmRPInfo(ilLoop).iMnfItem = 0) Or (tmRPInfo(ilLoop).iMnfItem = -1) Or (tmRPInfo(ilLoop).iMnfItem > 0 And tmRvf.iMnfItem > 0) Then
                            If (tmRvf.lCntrNo = tmRPInfo(ilLoop).lCntrNo) And (tmRvf.lInvNo = tmRPInfo(ilLoop).lInvNo) Then
                                llSbfCode = tmRvf.lSbfCode
                                ilFound = True
                            End If
                        End If
                    Next ilLoop
                    If ilFound Then
                        ilFound = False
                        For ilLoop = LBound(tgSbfInstall) To UBound(tgSbfInstall) - 1 Step 1
                            If tgSbfInstall(ilLoop).tSbf.lCode = tmRvf.lSbfCode Then
                                ilFound = True
                                tgSbfInstall(ilLoop).lTax1 = tgSbfInstall(ilLoop).lTax1 + tmRvf.lTax1
                                tgSbfInstall(ilLoop).lTax2 = tgSbfInstall(ilLoop).lTax2 + tmRvf.lTax2
                                Exit For
                            End If
                        Next ilLoop
                        If Not ilFound Then
                            tmSbfSrchKey1.lCode = tmRvf.lSbfCode
                            ilRet = btrGetEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)
                            If (ilRet = BTRV_ERR_NONE) Then
                                If tmSbf.sTranType = "F" Then
                                    slKey = Trim$(str$(tmSbf.lChfCode))
                                    Do While Len(slKey) < 8
                                        slKey = "0" & slKey
                                    Loop
                                    slInvNo = Trim(str$(tmRvf.lInvNo))
                                    Do While Len(slInvNo) < 8
                                        slInvNo = "0" & slInvNo
                                    Loop
                                    tmChfSrchKey.lCode = tmSbf.lChfCode
                                    ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                                    If (ilRet = BTRV_ERR_NONE) Then
                                        gUnpackDate tmSbf.iDate(0), tmSbf.iDate(1), slDate
                                        slDate = Trim$(str$(gDateValue(slDate)))
                                        Do While Len(slDate) < 5
                                            slDate = "0" & slDate
                                        Loop
                                        tgSbfInstall(UBound(tgSbfInstall)).sKey = slKey & slInvNo & slDate
                                        tgSbfInstall(UBound(tgSbfInstall)).lSDate = Val(slDate)
                                        tgSbfInstall(UBound(tgSbfInstall)).tSbf = tmSbf
                                        tgSbfInstall(UBound(tgSbfInstall)).lInvNo = tmRvf.lInvNo
                                        tgSbfInstall(UBound(tgSbfInstall)).lTax1 = tmRvf.lTax1
                                        tgSbfInstall(UBound(tgSbfInstall)).lTax2 = tmRvf.lTax2
                                        'gUnpackDateLong tmRvf.iTranDate(0), tmRvf.iTranDate(1), tgSbfInstall(UBound(tgSbfInstall)).lInvDate
                                        gUnpackDateLongError tmRvf.iTranDate(0), tmRvf.iTranDate(1), tgSbfInstall(UBound(tgSbfInstall)).lInvDate, "53:mInstall_BuildReprint " & tmRvf.lCode
                                        ReDim Preserve tgSbfInstall(0 To UBound(tgSbfInstall) + 1) As SBFCNTR
                                    End If
                                End If
                            End If
                        End If
                    End If
                    ilRet = btrExtGetNext(hlFile, tmRvf, ilExtLen, llRecPos)
                    Do While ilRet = BTRV_ERR_REJECT_COUNT
                        ilRet = btrExtGetNext(hlFile, tmRvf, ilExtLen, llRecPos)
                    Loop
                Loop
            End If
        End If
    Next ilPass
    mInstall_BuildReprint = BTRV_ERR_NONE
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mInstall_GenIvr                 *
'*                                                     *
'*             Created:6/13/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Generate IVR records for NTR    *
'*                                                     *
'*      1-24-05 If agency has tax1 off & tax 2 on,
'*          dont apply tax1 on NTR invoice when taxes
'*          apply
'*******************************************************
Sub mInstall_GenIvr(llInvoiceNo As Long)
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  llSDate                       llEDate                       slSDate                   *
'*  slEDate                       ilTrf                         tlIvr                     *
'*                                                                                        *
'******************************************************************************************
    Dim ilSbf As Integer
    Dim ilImpactPrt As Integer
    Dim ilPass As Integer
    Dim ilFound As Integer
    Dim slPctTrade As String
    Dim ilVeh As Integer
    Dim slForm2Key As String
    Dim ilONoSpots As Integer
    Dim ilANoSpots As Integer
    Dim llOGross As Long
    Dim llAGross As Long
    Dim llANet As Long
    Dim slTGross As String
    Dim slTNet As String
    Dim slProduct As String
    Dim ilRvf As Integer
    Dim ilSRvf As Integer
    Dim slAgyRate As String
    Dim slGross As String
    Dim slNet As String
    Dim slAmount As String
    Dim slStr As String
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim llChfCode As Long
    Dim llInvNo As Long
    Dim llSbfDate As Long
    Dim llTax1 As Long
    Dim llTax2 As Long
    Dim ilIncInvNo As Integer
    Dim llReprintInvNo As Long
    Dim ilNowTime(0 To 1) As Integer        '10-31-01
    Dim ilTax1 As Integer                   '1-24-05
    Dim ilTax2 As Integer                   '1-24-05
    Dim llTax1Rate As Long
    Dim llTax2Rate As Long
    Dim slGrossNet As String
    Dim llAirNTRInvNo As Long
    Dim llIvrCode As Long
    Dim ilTest As Integer
    Dim ilEDIFlag As Integer
    '10/11/16: Determine Agecny Installment commission
    Dim ilPctComm As Integer

    If Not imCombineAirAndNTR Then
        smRemoteGenDate = Format$(Now, "m/d/yy")
        lmRemoteGenDate = gDateValue(smRemoteGenDate)
        smRemoteGenTime = Format$(Now, "h:mm:ssAM/PM")
        lmRemoteGenTime = gTimeToLong(smRemoteGenTime, False)
        gPackDate smRemoteGenDate, tmIvr.iGenDate(0), tmIvr.iGenDate(1)
        'gPackTime smSbfGenTime, tmIvr.iGenTime(0), tmIvr.iGenTime(1)
        gPackTime smRemoteGenTime, ilNowTime(0), ilNowTime(1)
        gUnpackTimeLong ilNowTime(0), ilNowTime(1), False, tmIvr.lGenTime
    Else
        smRemoteGenDate = smGenDate
        lmRemoteGenDate = gDateValue(smRemoteGenDate)
        smRemoteGenTime = smGenTime
        lmRemoteGenTime = gTimeToLong(smRemoteGenTime, False)
        gPackDate smGenDate, tmIvr.iGenDate(0), tmIvr.iGenDate(1)
        '10-31-01 gPackTime smGenTime, tmIvr.iGenTime(0), tmIvr.iGenTime(1)
        gPackTime smGenTime, ilNowTime(0), ilNowTime(1)
        gUnpackTimeLong ilNowTime(0), ilNowTime(1), False, tmIvr.lGenTime
    End If

    'Remove disclaimer from NTR
    'tmIvr.lDisclaimer = tgSpf.lBCxfDisclaimer
    ilIncInvNo = False
    tmIvr.lDisclaimer = 0
    ilImpactPrt = False
    tmIvr.lSpotKeyNo = 0
    ilSbf = LBound(tgSbfInstall)
    Do While ilSbf <= UBound(tgSbfInstall) - 1
        llChfCode = tgSbfInstall(ilSbf).tSbf.lChfCode
        llReprintInvNo = tgSbfInstall(ilSbf).lInvNo
        'Jim 1/19/07: Use sbf bill date unless it is less then last closing date
        ''Use todays date so that all sbf records for the contract will be on same invoice
        'llSbfDate = lmNTRDate   'lmNowDate    'tgSbfInstall(ilSbf).lSDate
        'gUnpackDateLong tgSbfInstall(ilSbf).tSbf.iDate(0), tgSbfInstall(ilSbf).tSbf.iDate(1), llSbfDate
        gUnpackDateLongError tgSbfInstall(ilSbf).tSbf.iDate(0), tgSbfInstall(ilSbf).tSbf.iDate(1), llSbfDate, "54:mInstll_GenIvr " & tgSbfInstall(ilSbf).tSbf.lCode
        tmChfSrchKey.lCode = llChfCode
        ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
        If ilRet = BTRV_ERR_NONE Then
        
            '10/11/16: Determine Agency Installment commission
            ilPctComm = mInstallmentCommission()
            
            tgSortKey(UBound(tgSortKey)).lCntrNo = tgChfInv.lCntrNo
            tgSortKey(UBound(tgSortKey)).lChfCode = tgChfInv.lCode
            'Use todays date so that all sbf records show on same invoice
            tgSortKey(UBound(tgSortKey)).lSbfDate = llSbfDate
            tgSortKey(UBound(tgSortKey)).iType = 10
            'Moved to create rvf records
            'If rbcType(INVGEN_Final).Value Then
            '    tgSortKey(UBound(tgSortKey)).iBilled = True
            'Else
                tgSortKey(UBound(tgSortKey)).iBilled = False
            'End If
            ReDim Preserve tgSortKey(0 To UBound(tgSortKey) + 1) As TYPESORTKEY
            slPctTrade = gIntToStrDec(tgChfInv.iPctTrade, 0)
            slProduct = Trim$(tgChfInv.sProduct)
            For ilPass = 1 To 2 Step 1
                ilFound = False
                If (ilPass = 1) And (tgChfInv.iPctTrade <> 100) Then
                    ilFound = True
                End If
                If (ilPass = 2) And (tgChfInv.iPctTrade <> 0) Then
                    ilFound = True
                End If
                If ilFound Then
                    'Determine Aired Gross, Ordered number of spots, Aired number of Spots
                    llOGross = 0
                    llAGross = 0
                    llANet = 0
                    ilONoSpots = 0
                    ilANoSpots = 0
                    llChfCode = tgChfInv.lCode
                    ilFound = True
                    ilIncInvNo = False
                    ilEDIFlag = False
                    imArfPDFEMailCode = -1
                    If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then      '11-15-16 reprint,aff, undo, archive Determine invoice number
                        ilFound = True
                        llInvoiceNo = llReprintInvNo
                        llAirNTRInvNo = llReprintInvNo
                        llIvrCode = 0
                    Else
                        'Determine invoice number
                        llAirNTRInvNo = -1
                        llIvrCode = 0
                        If imCombineAirAndNTR Then
                            For ilTest = LBound(tmAirNTRCombine) To UBound(tmAirNTRCombine) - 1 Step 1
                                If tmAirNTRCombine(ilTest).lChfCode = tgSbfInstall(ilSbf).tSbf.lChfCode Then
                                    If ((ilPass = 1) And (tmAirNTRCombine(ilTest).sCashTrade = "C")) Or ((ilPass = 2) And (tmAirNTRCombine(ilTest).sCashTrade = "T")) Then
                                        llAirNTRInvNo = tmAirNTRCombine(ilTest).lInvNo
                                        ilEDIFlag = tmAirNTRCombine(ilTest).iEDIFlag
                                        imArfPDFEMailCode = tmAirNTRCombine(ilTest).iArfPDFEMailCode
                                        Exit For
                                    End If
                                End If
                            Next ilTest
                        End If
                        'ilFound = Not mRvfExist(llInvNo, 1, tgSbfInstall(ilSbf).tSbf.lCode)
                        If ilPass = 1 Then
                            ilFound = Not mRvfExist(llInvNo, 1, tgSbfInstall(ilSbf).tSbf.lCode, "C")
                        Else
                            ilFound = Not mRvfExist(llInvNo, 1, tgSbfInstall(ilSbf).tSbf.lCode, "T")
                        End If
                        If ilFound Then
                            If llAirNTRInvNo = -1 Then
                                ilIncInvNo = True
                                llAirNTRInvNo = llInvoiceNo
                            End If
                        End If
                    End If

                    If ilFound Then
                        tmChf = tgChfInv
                        mGetComment
                        mGetAdfAgfSlf
                        'mGenHeader ilImpactPrt, llInvoiceNo, ilPageNo, ilPass, slPctTrade, 1, True
                        'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81; Add Contract # so that the contract can be checked for AirTime/CPM & NTR to determine if Header should show NTR
                        mGenHeader ilImpactPrt, llAirNTRInvNo, ilPass, slPctTrade, 1, True, ilEDIFlag, tmChf.lCntrNo
                        slForm2Key = mRepInv_BuildKey()
                        slTNet = ".00"
                        slTGross = ".00"
                        llTax1 = 0
                        llTax2 = 0
                        ilTax1 = False      '1-24-05 assume no taxes apply
                        ilTax2 = False
                        For ilLoop = ilSbf To UBound(tgSbfInstall) - 1 Step 1
                            If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then      '11-15-16 reprint, aff, undo or archive, Determine invoice number
                                If (llChfCode <> tgSbfInstall(ilLoop).tSbf.lChfCode) Or (llReprintInvNo <> tgSbfInstall(ilLoop).lInvNo) Then
                                    Exit For
                                End If
                            Else
                                If (llChfCode <> tgSbfInstall(ilLoop).tSbf.lChfCode) Then
                                    Exit For
                                End If
                            End If
                            
                            '10/11/16: Set Installment commission
                            'If (tmChf.iAgfCode > 0) And (ilPass = 1) Then   '(Val(slPctTrade) <> 100) Then
                            '    'gPDNToStr tmAgf.sComm, 2, slAgyRate
                            '    slAgyRate = gIntToStrDec(tmAgf.iComm, 2)
                            '    tmIvr.iPctComm = tmAgf.iComm
                            ''ElseIf (tmChf.iAgfCode > 0) And (tmChf.sAgyCTrade = "Y") And (tgSbfInstall(ilLoop).tSbf.sAgyComm = "Y") And (ilPass = 2) Then   '(Val(slPctTrade) <> 100) Then
                            'ElseIf (tmChf.iAgfCode > 0) And (ilPass = 2) Then     '(Val(slPctTrade) <> 100) Then
                            '    'gPDNToStr tmAgf.sComm, 2, slAgyRate
                            '    slAgyRate = gIntToStrDec(tmAgf.iComm, 2)
                            '    tmIvr.iPctComm = tmAgf.iComm
                            'Else
                            '    slAgyRate = ""
                            '    tmIvr.iPctComm = 0
                            'End If
                            If ilPctComm <= 0 Then
                                slAgyRate = ""
                                tmIvr.iPctComm = 0
                            Else
                                slAgyRate = gIntToStrDec(ilPctComm, 2)
                                tmIvr.iPctComm = ilPctComm
                            End If
                            'TTP 10517 - Invoices: if "ad server" option is not checked on, and "commercial and NTR" invoices are set to be separate, the air time portion of the invoice does not print
                            'If imCombineAirAndNTR Then
                            '    tmIvr.iType = IVRTYPE_TotalNTR 'NTR Total
                            'Else
                            '    tmIvr.iType = IVRTYPE_TotalVefMkt 'Vehicle or Market Subtotal
                            'End If
                            tmIvr.iType = IVRTYPE_TotalNTR 'NTR Total
                            tmIvr.iLineNo = 0           '1-12-05
                            tmIvr.iRdfCode = 0          '4/14/11
                            tmIvr.sADayDate = ""
                            tmIvr.iPrgEnfCode = 0
                            tmIvr.sOVehName = "Vehicle Name Missing"
                            'For ilVeh = LBound(tgMVef) To UBound(tgMVef) - 1 Step 1
                            '    If (tgSbfInstall(ilLoop).tSbf.iBillVefCode = tgMVef(ilVeh).iCode) Then
                                ilVeh = gBinarySearchVef(tgSbfInstall(ilLoop).tSbf.iBillVefCode)
                                If ilVeh <> -1 Then
                                    tmIvr.sOVehName = tgMVef(ilVeh).sName
                            '        Exit For
                                End If
                            'Next ilVeh
                            'Description will be obtained directly from the sbf record
                            tmIvr.lSpotKeyNo = tgSbfInstall(ilLoop).tSbf.lCode
                            'Amount/item
                            llAGross = tgSbfInstall(ilLoop).tSbf.lGross
                            slGross = gLongToStrDec(llAGross, 2)
                            'Moved because trade/cash split on amount/item and total amount (amount/item times # Items)
                            'gFormatStr slGross, FMTCOMMA, 2, tmIvr.sORate
                            'slGross = gMulStr(slGross, Trim$(Str$(tgSbfInstall(ilLoop).tSbf.iNoItems)))
                            'slAmount = slGross  'gMulStr(slGross, Trim$(Str$(tmIvr.iOTotalSpots)))
                            'gFormatStr slAmount, FMTCOMMA, 2, tmIvr.sRAmount
                            If ilPass = 1 Then
                                If Val(slPctTrade) <> 100 Then
                                    slGross = gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100")
                                End If
                                gFormatStr slGross, FMTCOMMA, 2, tmIvr.sORate
                                'slGross = gMulStr(slGross, Trim$(Str$(tgSbfInstall(ilLoop).tSbf.iNoItems)))
                                If slAgyRate = "" Then
                                    slStr = slGross
                                Else
                                    slStr = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                                End If
                            ElseIf ilPass = 2 Then
                                If Val(slPctTrade) <> 100 Then
                                    slGross = gSubStr(slGross, gDivStr(gMulStr(slGross, gSubStr("100", slPctTrade)), "100"))
                                End If
                                gFormatStr slGross, FMTCOMMA, 2, tmIvr.sORate
                                'slGross = gMulStr(slGross, Trim$(Str$(tgSbfInstall(ilLoop).tSbf.iNoItems)))
                                If slAgyRate = "" Then
                                    slStr = slGross
                                Else
                                    slStr = gDivStr(gMulStr(slGross, gSubStr("100.00", slAgyRate)), "100.00")
                                End If
                            End If
                            slNet = slStr
                            slTNet = gAddStr(slTNet, slStr)

                            tgSbfInstall(ilLoop).lNTRNet = gStrDecToLong(slStr, 2)
                            '12/17/06-Change to tax by agency or vehicle
                            'If (tgSpf.iBTax(0) <> 0) And (tgSbfInstall(ilLoop).tSbf.sSlsTax = "Y") And (ilTax1 = True) Then
                            If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Archive).Value Then      '11-15-16 reprint, aff, archive Determine invoice number
                                llTax1 = llTax1 + tgSbfInstall(ilLoop).lTax1
                                llTax2 = llTax2 + tgSbfInstall(ilLoop).lTax2
                            Else
                                tgSbfInstall(ilLoop).lTax1 = 0
                                tgSbfInstall(ilLoop).lTax2 = 0
                                If ilPass = 1 Then
                                    If ((Asc(tgSpf.sUsingFeatures3) And TAXONAIRTIME) = TAXONAIRTIME) Or ((Asc(tgSpf.sUsingFeatures3) And TAXONNTR) = TAXONNTR) Then
                                        If ((ilPass = 1) And ((Asc(tgSpf.sUsingFeatures4) And TAXBYUSA) = TAXBYUSA)) Or ((Asc(tgSpf.sUsingFeatures4) And TAXBYCANADA) = TAXBYCANADA) Then
                                            gGetNTRTaxRates tgSbfInstall(ilLoop).tSbf.iTrfCode, llTax1Rate, llTax2Rate, slGrossNet
                                            If llTax1Rate > 0 Then
                                                '12/17/06-Change to tax by agency or vehicle
                                                'tgSbfInstall(ilLoop).tSbf.lTax1 = gStrDecToLong(gRoundStr(gMulStr(slStr, gIntToStrDec(tgSpf.iBTax(0), 4)), ".01", 2), 2)
                                                'llTax1 = llTax1 + tgSbfInstall(ilLoop).tSbf.lTax1
                                                ''Don't set tax amount into sbf because only one record and cash/trade might not be 50% so tax amount would be different
                                                ''tgSbfInstall(ilLoop).tSbf.lTax1 = 0
                                                'If (Asc(tgSpf.sUsingFeatures4) And TAXBYUSA) = TAXBYUSA Then
                                                If slGrossNet = "G" Then
                                                    'Compute from Gross amount
                                                    slStr = slGross
                                                'ElseIf (Asc(tgSpf.sUsingFeatures4) And TAXBYCANADA) = TAXBYCANADA Then
                                                ElseIf slGrossNet = "N" Then
                                                    'Compute from Net amount
                                                    slStr = slNet
                                                End If
                                                tgSbfInstall(ilLoop).lTax1 = gStrDecToLong(gRoundStr(gDivStr(gMulStr(slStr, gLongToStrDec(llTax1Rate, 4)), "100."), ".01", 2), 2)
                                                llTax1 = llTax1 + tgSbfInstall(ilLoop).lTax1
                                            Else
                                                '12/17/06-Change to tax by agency or vehicle
                                                'tgSbfInstall(ilLoop).tSbf.lTax1 = 0
                                            End If
                                            '12/17/06-Change to tax by agency or vehicle
                                            'If (tgSpf.iBTax(1) <> 0) And (tgSbfInstall(ilLoop).tSbf.sSlsTax = "Y") And (ilTax2 = True) Then
                                            If llTax2Rate > 0 Then
                                                '12/17/06-Change to tax by agency or vehicle
                                                'tgSbfInstall(ilLoop).tSbf.lTax2 = gStrDecToLong(gRoundStr(gMulStr(slStr, gIntToStrDec(tgSpf.iBTax(1), 4)), ".01", 2), 2)
                                                'llTax2 = llTax2 + tgSbfInstall(ilLoop).tSbf.lTax2
                                                ''tgSbfInstall(ilLoop).tSbf.lTax2 = 0
                                                'If (Asc(tgSpf.sUsingFeatures4) And TAXBYUSA) = TAXBYUSA Then
                                                If slGrossNet = "G" Then
                                                    'Compute from Gross amount
                                                    slStr = slGross
                                                'ElseIf (Asc(tgSpf.sUsingFeatures4) And TAXBYCANADA) = TAXBYCANADA Then
                                                ElseIf slGrossNet = "N" Then
                                                    'Compute from Net amount
                                                    slStr = slNet
                                                End If
                                                tgSbfInstall(ilLoop).lTax2 = gStrDecToLong(gRoundStr(gDivStr(gMulStr(slStr, gLongToStrDec(llTax2Rate, 4)), "100."), ".01", 2), 2)
                                                llTax2 = llTax2 + tgSbfInstall(ilLoop).lTax2
                                            Else
                                                '12/17/06-Change to tax by agency or vehicle
                                                'tgSbfInstall(ilLoop).tSbf.lTax2 = 0
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                            slTGross = gAddStr(slTGross, slGross)
                            tgSbfInstall(ilLoop).lNTRGross = gStrDecToLong(slGross, 2)
                            'Units/Item
                            tmIvr.sRRemark = ""
                            '# Items
                            tmIvr.lOTotalSpots = 0
                            slAmount = slGross  'gMulStr(slGross, Trim$(Str$(tmIvr.iOTotalSpots)))
                            gFormatStr slAmount, FMTCOMMA, 2, tmIvr.sRAmount
                            tmIvr.lATotalGross = 0
                            tmIvr.lATotalNet = 0
                            If imCombineAirAndNTR Then
                                tmIvr.sKey = slForm2Key & "4" & tmIvr.sOVehName
                            Else
                                tmIvr.sKey = slForm2Key & "2" & tmIvr.sOVehName
                            End If
                            If imCombineAirAndNTR Then
                                If tgChfInv.sBillCycle = "C" Then
                                    gPackDateLong lmSvStartCal, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
                                    gPackDateLong lmSvEndCal, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
                                ElseIf tgChfInv.sBillCycle = "W" Then
                                    gPackDateLong lmSvStartWk, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
                                    gPackDateLong lmSvEndWk, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
                                Else
                                    gPackDateLong lmSvStartStd, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
                                    gPackDateLong lmSvEndStd, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
                                End If
                            End If
                            tmIvr.iFormType = 1  'Force to Air
                            tmIvr.lCode = 0
                            tmIvr.lClfCxfCode = 0
                            tmIvr.lClfCode = 0
                            tmIvr.sInstallCntr = tmChf.sInstallDefined
                        Next ilLoop
                        'Now form type 3 record
                        If imCombineAirAndNTR Then
                            tmIvr.iType = IVRTYPE_TotalInstallment 'Installment Total?
                        Else
                            tmIvr.iType = IVRTYPE_TotalAirtimeRep 'AirTime or REP Total
                        End If
                        tmIvr.sOVehName = ""
                        tmIvr.sORate = ""
                        tmIvr.sRRemark = ""
                        tmIvr.sRAmount = ""
                        tmIvr.lOTotalSpots = 0  'ilONoSpots
                        tmIvr.lOTotalGross = 0  'llOGross
                        tmIvr.lATotalSpots = 0  'ilANoSpots
                        tmIvr.lATotalGross = gStrDecToLong(slTGross, 2)
                        tmIvr.lRTotalGross = 0
                        tmIvr.lATotalNet = gStrDecToLong(slTNet, 2)
                        tmIvr.lTax1 = llTax1
                        tmIvr.lTax2 = llTax2
                        tmIvr.lSpotKeyNo = 0
                        If imCombineAirAndNTR Then
                            tmIvr.sKey = slForm2Key & "5"
                        Else
                            tmIvr.sKey = slForm2Key & "3"
                        End If
                        If imCombineAirAndNTR Then
                            If tgChfInv.sBillCycle = "C" Then
                                gPackDateLong lmSvStartCal, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
                                gPackDateLong lmSvEndCal, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
                            ElseIf tgChfInv.sBillCycle = "W" Then
                                gPackDateLong lmSvStartWk, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
                                gPackDateLong lmSvEndWk, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
                            Else
                                gPackDateLong lmSvStartStd, tmIvr.iInvStartDate(0), tmIvr.iInvStartDate(1)
                                gPackDateLong lmSvEndStd, tmIvr.iInvDate(0), tmIvr.iInvDate(1)
                            End If
                        End If
                        tmIvr.lClfCxfCode = 0
                        tmIvr.lClfCode = 0
                        tmIvr.iFormType = 1  'Force to Air
                        tmIvr.lCode = 0
                        mGetInstallmentCounts tmChf ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
                        tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
                        tmIvr.iTotalInstallInvs = imTotalInstallInvs
                        tmIvr.sInstallCntr = tmChf.sInstallDefined
                        If imCombineAirAndNTR Then
                            tmIvr.iType = IVRTYPE_TotalInstallment   'Installment Total
                            tmIvr.lCode = 0
                            mGetInstallmentCounts tmChf ', tmIvr.iInstallInvoiceNo, tmIvr.iTotalInstallInvs
                            tmIvr.iInstallInvoiceNo = imInstallInvoiceNo
                            tmIvr.iTotalInstallInvs = imTotalInstallInvs
                            tmIvr.sInstallCntr = tmChf.sInstallDefined
                            '1/10/18: EDI and installment not allowed
                            ilRet = mDetermineIfEDIRequired()
                            ilEDIFlag = False
                            tmIvr.sEDIComment = ""
                            For ilLoop = LBound(tmIvr.sTitle) To UBound(tmIvr.sTitle) Step 1
                                tmIvr.sTitle(ilLoop) = ""
                            Next ilLoop
                            tmIvr.sTitle(LBound(tmIvr.sTitle)) = "INVOICE and"
                            tmIvr.sTitle(LBound(tmIvr.sTitle) + 1) = "AFFIDAVIT"
                            'Replace totals with Installment amounts
                            ilRet = mWriteIvr(ilEDIFlag, tmIvr, tmChf)
                            If ilRet <> BTRV_ERR_NONE Then
                                If ilRet >= 30000 Then
                                    ilRet = csiHandleValue(0, 7)
                                End If
                                Print #hmMsg, "mInstall_GenIvr: btrInsert-Point 1, Ivr Error # " & Trim$(str$(ilRet))
                            End If
                            'TTP 10517 - Invoices: if "ad server" option is not checked on, and "commercial and NTR" invoices are set to be separate, the air time portion of the invoice does not print
                            If (tmIvr.iType = IVRTYPE_TotalAirtimeRep) Or (tmIvr.iType = IVRTYPE_TotalAdServer) Or (tmIvr.iType = IVRTYPE_TotalNTR) Or (tmIvr.iType = IVRTYPE_TotalInstallment) Or (tmIvr.iType = IVRTYPE_TotalCntr) Then
                                LSet tmImr = tmIvr
                                tmImr.lIvrCode = tmIvr.lCode
                                tmImr.sUnused = ""
                                'ilRet = btrInsert(hmImr, tmImr, imImrRecLen, INDEXKEY0)
                                ilRet = mWriteImr(ilEDIFlag, tmImr)
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    Print #hmMsg, "mInstall_GenIvr: btrInsert-Point 2, Imr Error # " & Trim$(str$(ilRet))
                                End If
                            End If
                        End If
                        'Create RVF record
                        If rbcType(INVGEN_Final).Value Then

                            tgSortKey(UBound(tgSortKey) - 1).iBilled = True

                            ilRvf = UBound(tgRvf)
                            ilSRvf = ilRvf
                            tgRvf(ilRvf).lCode = 0
                            'Product- update prf now instead of after all invoices generated
                            tgRvf(ilRvf).lPrfCode = 0
                            If (Trim$(slProduct) <> "") Then
                                ilFound = False
                                tmPrfSrchKey.iAdfCode = tmChf.iAdfCode
                                ilRet = btrGetGreaterOrEqual(hmPrf, tmPrf, imPrfRecLen, tmPrfSrchKey, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point
                                Do While (ilRet = BTRV_ERR_NONE) And (tmPrf.iAdfCode = tmChf.iAdfCode) 'tmRvf.iAdfCode)
                                    If StrComp(Trim$(Trim$(slProduct)), Trim$(tmPrf.sName), 1) = 0 Then
                                        ilFound = True
                                        tgRvf(ilRvf).lPrfCode = tmPrf.lCode
                                        Exit Do
                                    End If
                                    ilRet = btrGetNext(hmPrf, tmPrf, imPrfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                                Loop
                                If (Not ilFound) And (rbcType(INVGEN_Final).Value) Then
                                    Do  'Loop until record updated or added
                                        tmPrf.lCode = 0
                                        tmPrf.iAdfCode = tmChf.iAdfCode
                                        tmPrf.sName = Trim$(slProduct)
                                        tmPrf.iMnfComp(0) = 0
                                        tmPrf.iMnfComp(1) = 0
                                        tmPrf.iMnfExcl(0) = 0
                                        tmPrf.iMnfExcl(1) = 0
                                        tmPrf.iUrfCode = tgUrf(0).iCode
                                        tmPrf.iRemoteID = tgUrf(0).iRemoteUserID
                                        tmPrf.lAutoCode = tmPrf.lCode
                                        ilRet = btrInsert(hmPrf, tmPrf, imPrfRecLen, INDEXKEY0)
                                    Loop While ilRet = BTRV_ERR_CONFLICT
                                    If ilRet <> BTRV_ERR_NONE Then
                                        If ilRet >= 30000 Then
                                            ilRet = csiHandleValue(0, 7)
                                        End If
                                        Print #hmMsg, "mInstall_GenIvr: btrInsert-Point 3, Prf Error # " & Trim$(str$(ilRet))
                                    End If
                                    If ilRet = BTRV_ERR_NONE Then
                                        tgRvf(ilRvf).lPrfCode = tmPrf.lCode
                                        Do
                                            tmPrf.iRemoteID = tgUrf(0).iRemoteUserID
                                            tmPrf.lAutoCode = tmPrf.lCode
                                            tmPrf.iSourceID = tgUrf(0).iRemoteUserID
                                            gPackDate smSyncDate, tmPrf.iSyncDate(0), tmPrf.iSyncDate(1)
                                            gPackTime smSyncTime, tmPrf.iSyncTime(0), tmPrf.iSyncTime(1)
                                            ilRet = btrUpdate(hmPrf, tmPrf, imPrfRecLen)
                                        Loop While ilRet = BTRV_ERR_CONFLICT
                                        If ilRet <> BTRV_ERR_NONE Then
                                            If ilRet >= 30000 Then
                                                ilRet = csiHandleValue(0, 7)
                                            End If
                                            Print #hmMsg, "mInstall_GenIvr: btrUpdate-Point 1, Prf Error # " & Trim$(str$(ilRet))
                                        End If
                                    Else
                                        tgRvf(ilRvf).lPrfCode = 0
                                    End If
                                End If
                            End If
                            tgRvf(ilRvf).iAgfCode = tmChf.iAgfCode
                            tgRvf(ilRvf).iAdfCode = tmChf.iAdfCode
                            tgRvf(ilRvf).iSlfCode = tmChf.iSlfCode(0)
                            tgRvf(ilRvf).lCntrNo = tmChf.lCntrNo
                            tgRvf(ilRvf).lInvNo = llAirNTRInvNo
                            tgRvf(ilRvf).lRefInvNo = 0
                            '6/7/15: Check number changed to string
                            'tgRvf(ilRvf).lCheckNo = llSbfDate   'should be 0 but temporary store llSbfDate so that RVF can be tied to tgSortKey
                            tgRvf(ilRvf).sCheckNo = Trim$(str$(llSbfDate))   'should be 0 but temporary store llSbfDate so that RVF can be tied to tgSortKey
                            If tmChf.sBillCycle = "C" Then
                                gPackDate smEndCal, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                            ElseIf tmChf.sBillCycle = "W" Then
                                gPackDate smEndWk, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                            Else
                                gPackDate smEndStd, tgRvf(ilRvf).iTranDate(0), tgRvf(ilRvf).iTranDate(1)
                            End If
                            tgRvf(ilRvf).sTranType = "IN"
                            tgRvf(ilRvf).sAction = " "
                            If tmChf.sBillCycle = "C" Then
                                tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndCal))
                                tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndCal))
                            ElseIf tmChf.sBillCycle = "W" Then
                                tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndWk))
                                tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndWk))
                            Else
                                tgRvf(ilRvf).iAgePeriod = Month(gDateValue(smEndStd))
                                tgRvf(ilRvf).iAgingYear = Year(gDateValue(smEndStd))
                            End If
                            gPackDate "", tgRvf(ilRvf).iPurgeDate(0), tgRvf(ilRvf).iPurgeDate(1)
                            'If Val(slPctTrade) = 100 Then
                            If ilPass = 2 Then
                                tgRvf(ilRvf).sCashTrade = "T"
                            Else
                                tgRvf(ilRvf).sCashTrade = "C"
                            End If
                            tgRvf(ilRvf).iPkLineNo = 0
                            tgRvf(ilRvf).iInvDate(0) = tgRvf(ilRvf).iTranDate(0)
                            tgRvf(ilRvf).iInvDate(1) = tgRvf(ilRvf).iTranDate(1)
                            gPackDate smNowDate, tgRvf(ilRvf).iDateEntrd(0), tgRvf(ilRvf).iDateEntrd(1)
                            tgRvf(ilRvf).iUrfCode = tgUrf(0).iCode
                            tgRvf(ilRvf).iRemoteID = 0
                            tgRvf(ilRvf).iMnfGroup = 0  'Participant MnfCode, set in mUpdateRvf if Sales Source is Ask
                            tgRvf(ilRvf).lCefCode = 0
                            tgRvf(ilRvf).sInCollect = "N"
                            tgRvf(ilRvf).iRemoteID = 0
                            tgRvf(ilRvf).iBacklogTrfCode = 0
                            '1/17/09: Added buyer
                            'tgRvf(ilRvf).sUnused = ""
                            tgRvf(ilRvf).iPnfBuyer = tmChf.iPnfBuyer
                            For ilLoop = ilSbf To UBound(tgSbfInstall) - 1 Step 1
                                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then      '11-1-5-16 reprint, aff, undo, archive Determine invoice number
                                    If (llChfCode <> tgSbfInstall(ilLoop).tSbf.lChfCode) Or (llReprintInvNo <> tgSbfInstall(ilLoop).lInvNo) Then
                                        Exit For
                                    End If
                                Else
                                    If (llChfCode <> tgSbfInstall(ilLoop).tSbf.lChfCode) Then
                                        Exit For
                                    End If
                                End If
                                ilRvf = UBound(tgRvf)
                                tgRvf(ilRvf).iBillVefCode = tgSbfInstall(ilLoop).tSbf.iBillVefCode
                                tgRvf(ilRvf).iAirVefCode = tgSbfInstall(ilLoop).tSbf.iBillVefCode
                                tgRvf(ilRvf).lRefInvNo = 0  'tgSbfInstall(ilLoop).tSbf.lRefInvNo
                                tgRvf(ilRvf).iMnfItem = tgSbfInstall(ilLoop).tSbf.iMnfItem
                                tgRvf(ilRvf).lSbfCode = tgSbfInstall(ilLoop).tSbf.lCode
                                tgRvf(ilRvf).lPcfCode = 0

                                slGross = gLongToStrDec(tgSbfInstall(ilLoop).lNTRGross, 2)
                                slNet = gLongToStrDec(tgSbfInstall(ilLoop).lNTRNet, 2)
                                gStrToPDN slGross, 2, 6, tgRvf(ilRvf).sGross
                                gStrToPDN slNet, 2, 6, tgRvf(ilRvf).sNet
                                '12/17/06-Change to tax by agency or vehicle
                                'tgRvf(ilRvf).lTax1 = tgSbfInstall(ilLoop).tSbf.lTax1
                                'tgRvf(ilRvf).lTax2 = tgSbfInstall(ilLoop).tSbf.lTax2   '2-24-04
                                'tgSbfInstall(ilLoop).tSbf.lTax1 = 0
                                'tgSbfInstall(ilLoop).tSbf.lTax2 = 0
                                tgRvf(ilRvf).lTax1 = tgSbfInstall(ilLoop).lTax1
                                tgRvf(ilRvf).lTax2 = tgSbfInstall(ilLoop).lTax2
                                tgSbfInstall(ilLoop).lTax1 = 0
                                tgSbfInstall(ilLoop).lTax2 = 0
                                tgRvf(ilRvf).lAcquisitionCost = 0
                                If tgSbfInstall(ilLoop).tSbf.lAcquisitionCost > 0 Then
                                    tgRvf(ilRvf).lAcquisitionCost = tgSbfInstall(ilLoop).tSbf.lAcquisitionCost * tgSbfInstall(ilLoop).tSbf.iNoItems
                                    If ilPass = 1 Then
                                        If Val(slPctTrade) <> 100 Then
                                            tgRvf(ilRvf).lAcquisitionCost = ((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100
                                        End If
                                    ElseIf ilPass = 2 Then
                                        If Val(slPctTrade) <> 100 Then
                                            tgRvf(ilRvf).lAcquisitionCost = tgRvf(ilRvf).lAcquisitionCost - (((100 - Val(slPctTrade)) * tgRvf(ilRvf).lAcquisitionCost) / 100)
                                        End If
                                    End If
                                End If

                                ReDim Preserve tgRvf(0 To UBound(tgRvf) + 1) As RVF
                                tgRvf(ilRvf + 1) = tgRvf(ilRvf)
                        
                            Next ilLoop
                        End If
                        If ilIncInvNo Then
                            llInvoiceNo = llInvoiceNo + 1
                            mCheckNextInvNo llInvoiceNo
                        End If
                    End If
                End If
            Next ilPass
            'Advance ilSbf to next contract
            Do
                If rbcType(INVGEN_Reprint).Value Or rbcType(INVGEN_Aff).Value Or rbcType(INVGEN_Undo).Value Or rbcType(INVGEN_Archive).Value Then      '11-15-16 reprint, aff, undo, archiveDetermine invoice number
                    If (llChfCode <> tgSbfInstall(ilSbf).tSbf.lChfCode) Or (llReprintInvNo <> tgSbfInstall(ilSbf).lInvNo) Then
                        Exit Do
                    End If
                Else
                    If (llChfCode <> tgSbfInstall(ilSbf).tSbf.lChfCode) Then
                        Exit Do
                    End If
                End If
                ilSbf = ilSbf + 1
            Loop While ilSbf <= UBound(tgSbfInstall) - 1
        End If
    Loop
End Sub

Private Function mAnyInstallmentsForCntr(llChfCode As Long) As Integer
    Dim ilLoop As Integer

    For ilLoop = LBound(tgSbfInstall) To UBound(tgSbfInstall) - 1 Step 1
        If llChfCode = tgSbfInstall(ilLoop).tSbf.lChfCode Then
            mAnyInstallmentsForCntr = True
            Exit Function
        End If
    Next ilLoop
    mAnyInstallmentsForCntr = False
    Exit Function
End Function

Private Sub imcPrt_Click()
    Dim ilCurrentLineNo As Integer
    Dim ilLinesPerPage As Integer
    Dim slRecord As String
    Dim slHeading As String
    Dim ilLoop As Integer
    Dim ilRet As Integer
    pbcPrinting.Visible = True
    DoEvents
    ilCurrentLineNo = 0
    ilLinesPerPage = (Printer.Height - 1440) / Printer.TextHeight("TEST") - 1
    ilRet = 0
    On Error GoTo imcPrtErr:
    slHeading = "Counterpoint Invoice Information for " & Trim$(tgUrf(0).sRept) & " on " & Format$(gNow(), "m/d/yy") & " at " & Format$(gNow(), "h:mm:ssAM/PM")
    '6/6/16: Replaced GoSub
    mHeading1 ilRet, slHeading, ilCurrentLineNo
    If ilRet <> 0 Then
        Printer.EndDoc
        On Error GoTo 0
        pbcPrinting.Visible = False
        Exit Sub
    End If
    'Output Information
    For ilLoop = 0 To lbcUnbilled.ListCount - 1 Step 1
        slRecord = "    " & lbcUnbilled.List(ilLoop)
        '6/6/16: Replaced GoSub
        mLineOutput ilRet, slHeading, ilCurrentLineNo, slRecord, ilLinesPerPage
        If ilRet <> 0 Then
            Printer.EndDoc
            On Error GoTo 0
            pbcPrinting.Visible = False
            Exit Sub
        End If
    Next ilLoop
    Printer.EndDoc
    On Error GoTo 0
    tmcPrt.Enabled = True
    Exit Sub
imcPrtErr:
    ilRet = err.Number
    MsgBox "Printing Error # " & str$(ilRet)
    Resume Next
End Sub

Private Function mUpdateGameInv(tlSbf As SBF) As Integer
    Dim ilGameNo As Integer
    Dim ilRet As Integer
    Dim llGsfDate As Long
    Dim llSbfDate As Long

    mUpdateGameInv = BTRV_ERR_NONE
    If tlSbf.iIhfCode <= 0 Then
        Exit Function
    End If
    gUnpackDateLongError tlSbf.iDate(0), tlSbf.iDate(1), llSbfDate, "65:mUpdateGameInv " & tlSbf.lCode
    tmMsfSrchKey2.lChfCode = tlSbf.lChfCode
    ilRet = btrGetEqual(hmMsf, tmMsf, imMsfRecLen, tmMsfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmMsf.lChfCode = tlSbf.lChfCode)
        If tlSbf.iIhfCode = tmMsf.iIhfCode Then
            ilGameNo = 0
            Do
                tmMgfSrchKey1.lMsfCode = tmMsf.lCode
                tmMgfSrchKey1.iGameNo = ilGameNo
                ilRet = btrGetGreaterOrEqual(hmMgf, tmMgf, imMgfRecLen, tmMgfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
                If (ilRet = BTRV_ERR_NONE) And (tmMgf.lMsfCode = tmMsf.lCode) Then
                    If tmMgf.iGameNo > 0 Then
                        tmGsfSrchKey1.lghfcode = tmMsf.lghfcode
                        tmGsfSrchKey1.iGameNo = tmMgf.iGameNo
                        ilRet = btrGetEqual(hmGsf, tmGsf, imGsfRecLen, tmGsfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get last current record to obtain date
                        If (ilRet = BTRV_ERR_NONE) Then
                            'gUnpackDateLong tmGsf.iAirDate(0), tmGsf.iAirDate(1), llGsfDate
                            gUnpackDateLongError tmGsf.iAirDate(0), tmGsf.iAirDate(1), llGsfDate, "66:mUpdateGameInv " & tmGsf.lCode
                            If llGsfDate <= llSbfDate Then
                                tmMgf.sBilled = "Y"
                                ilRet = btrUpdate(hmMgf, tmMgf, imMgfRecLen)
                                If ilRet <> BTRV_ERR_NONE Then
                                    If ilRet >= 30000 Then
                                        ilRet = csiHandleValue(0, 7)
                                    End If
                                    Print #hmMsg, "mUpdateGameInv: btrUpdate-Point 1, Mgf Error # " & Trim$(str$(ilRet))
                                End If
                            End If
                        End If
                    Else
                        tmMgf.sBilled = "Y"
                        ilRet = btrUpdate(hmMgf, tmMgf, imMgfRecLen)
                        If ilRet <> BTRV_ERR_NONE Then
                            If ilRet >= 30000 Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            Print #hmMsg, "mUpdateGameInv: btrUpdate-Point 2, Mgf Error # " & Trim$(str$(ilRet))
                        End If
                    End If
                    If ilRet = BTRV_ERR_NONE Then
                        If tmMgf.iGameNo <= 0 Then
                            Exit Do
                        End If
                        ilGameNo = tmMgf.iGameNo + 1
                    ElseIf ilRet <> BTRV_ERR_CONFLICT Then
                        mUpdateGameInv = ilRet
                        Exit Function
                    End If
                Else
                    Exit Do
                End If
            Loop
        End If
        ilRet = btrGetNext(hmMsf, tmMsf, imMsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    mUpdateGameInv = BTRV_ERR_NONE
End Function

Private Function mNetToRepInv() As Integer
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  llStartDate                                                                           *
'******************************************************************************************
    Dim ilRet As Integer
    Dim ilLoop As Integer

    For ilLoop = 0 To UBound(smXferRepDBID) - 1 Step 1
        'tmCef.iStrLen = Len(Trim$(smXferChfCode(ilLoop)))
        tmCef.sComment = Trim$(smXferChfCode(ilLoop)) & Chr$(0) '& Chr$(0) 'sgTB
        imCefRecLen = Len(tmCef)    '5 + Len(Trim$(tmCef.sComment)) + 2   '5 = fixed record length; 2 is the length of the record which is part of the variable record
        tmCef.lCode = 0 'Autoincrement
        ilRet = btrInsert(hmCef, tmCef, imCefRecLen, INDEXKEY0)
        tmGif.lCode = 0
        tmGif.sNRProcessed = "N"
        tmGif.sType = "S"
        tmGif.lGenDate = gDateValue(Format$(gNow(), "m/d/yy"))
        tmGif.lGenTime = gTimeToLong(Format$(gNow(), "h:mm:ssAM/PM"), False) + ilLoop
        Select Case Left$(gGetLocalTZName(), 1)
            Case "E"
            Case "C"
                tmGif.lGenTime = tmGif.lGenTime + 3600
            Case "M"
                tmGif.lGenTime = tmGif.lGenTime + 7200
            Case "P"
                tmGif.lGenTime = tmGif.lGenTime + 10800
        End Select
        tmGif.lCntrNo = lmEndStd    'Use contract number to pass Invoice end date
        tmGif.iVefCode = 0
        gPackDate smStartStd, tmGif.iStartDate(0), tmGif.iStartDate(1)
        gPackDate smEndStd, tmGif.iEndDate(0), tmGif.iEndDate(1)
        tmGif.sMessageRepDBID = smXferRepDBID(ilLoop)
        tmGif.sMessageNetDBID = sgNetDBID
        tmGif.lMessageCefCode = tmCef.lCode
        gPackDate "", tmGif.iProcessedDate(0), tmGif.iProcessedDate(1)
        gPackTime "", tmGif.iProcessedTime(0), tmGif.iProcessedTime(1)
        ilRet = btrInsert(hmGif, tmGif, imGifRecLen, INDEXKEY0)
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            Print #hmMsg, "mNetToRepInv: btrInsert-Point 1, Gif Error # " & Trim$(str$(ilRet))
            mNetToRepInv = False
            Exit Function
        End If
    Next ilLoop
    mNetToRepInv = True
End Function

Private Function mGetUndoMonth() As Long
    Dim slDate As String
    Dim llDate As Long
    Dim llStdDate As Long
    Dim ilRet As Integer

    gUnpackDate tgSpf.iBLastStdMnth(0), tgSpf.iBLastStdMnth(1), slDate
    llStdDate = gDateValue(slDate)
    gPackDateLong llStdDate + 1, tmRvfSrchKey3.iTranDate(0), tmRvfSrchKey3.iTranDate(1)
    ilRet = btrGetGreaterOrEqual(hmRvf, tmRvf, imRvfRecLen, tmRvfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE)
        If (tmRvf.sTranType = "IN") And ((tmRvf.sCashTrade = "C") Or (tmRvf.sCashTrade = "T")) Then
            tmChfSrchKey1.lCntrNo = tmRvf.lCntrNo
            tmChfSrchKey1.iCntRevNo = 32000
            tmChfSrchKey1.iPropVer = 32000
            ilRet = btrGetGreaterOrEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
            Do While (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tmRvf.lCntrNo) And (tmChf.sSchStatus = "A")
                ilRet = btrGetNext(hmCHF, tmChf, imCHFRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            Loop
            If (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tmRvf.lCntrNo) And (tmChf.sBillCycle <> "W") Then
                'gUnpackDateLong tmRvf.iTranDate(0), tmRvf.iTranDate(1), llDate
                gUnpackDateLongError tmRvf.iTranDate(0), tmRvf.iTranDate(1), llDate, "68:mGetUndoMonth " & tmRvf.lCode
                If llDate > llStdDate Then
                    llStdDate = llDate
                End If
            End If
        End If
        ilRet = btrGetNext(hmRvf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    mGetUndoMonth = llStdDate
End Function

Private Function mGetUndoWeek() As Long
    Dim slDate As String
    Dim llDate As Long
    Dim llWkDate As Long
    Dim ilRet As Integer

    gUnpackDate tgSaf(0).iBLastWeeklyDate(0), tgSaf(0).iBLastWeeklyDate(1), slDate
    llWkDate = gDateValue(slDate)
    gPackDateLong llWkDate + 1, tmRvfSrchKey3.iTranDate(0), tmRvfSrchKey3.iTranDate(1)
    ilRet = btrGetGreaterOrEqual(hmRvf, tmRvf, imRvfRecLen, tmRvfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE)
        If (tmRvf.sTranType = "IN") And ((tmRvf.sCashTrade = "C") Or (tmRvf.sCashTrade = "T")) Then
            tmChfSrchKey1.lCntrNo = tmRvf.lCntrNo
            tmChfSrchKey1.iCntRevNo = 32000
            tmChfSrchKey1.iPropVer = 32000
            ilRet = btrGetGreaterOrEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
            Do While (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tmRvf.lCntrNo) And (tmChf.sSchStatus = "A")
                ilRet = btrGetNext(hmCHF, tmChf, imCHFRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
            Loop
            If (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tmRvf.lCntrNo) And (tmChf.sBillCycle = "W") Then
                'gUnpackDateLong tmRvf.iTranDate(0), tmRvf.iTranDate(1), llDate
                gUnpackDateLongError tmRvf.iTranDate(0), tmRvf.iTranDate(1), llDate, "68:mGetUndoWeek " & tmRvf.lCode
                If llDate > llWkDate Then
                    llWkDate = llDate
                End If
            End If
        End If
        ilRet = btrGetNext(hmRvf, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    mGetUndoWeek = llWkDate
End Function

Private Sub mRollbackReconcRequired()
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  slUndoDate                                                                            *
'******************************************************************************************
    Dim slRPRPDate As String
    Dim slRCRPDate As String
    Dim slStdDate As String
    Dim ilRet As Integer
    Dim slDate As String
    Dim ilPass As Integer
    Dim ilRollbackReconcRequired As Integer

    If imRollbackReconcRequired <> -1 Then
        If imRollbackReconcRequired > 0 Then
            lacUndoReconc.Visible = True
        End If
        Exit Sub
    End If
    'Done in mSelAdvt
    'mBuildDates
    imRollbackReconcRequired = 0
    lacUndoReconc.Visible = False
    gUnpackDate tgSpf.iRPRP(0), tgSpf.iRPRP(1), slRPRPDate
    slRPRPDate = gAdjYear(slRPRPDate)
    
    'slStdDate = gAdjYear(smEndStd)
    For ilPass = 1 To 3 Step 1
        ilRollbackReconcRequired = 0
        slDate = ""
        Select Case ilPass
            Case 1
                slDate = smEndStd
            Case 2
                slDate = smEndCal
            Case 3
                slDate = smEndWk
        End Select
        If slDate <> "" Then
            If (Year(slRPRPDate) > Year(slDate)) Or (Year(slRPRPDate) = Year(slDate)) And (Month(slRPRPDate) > Month(slDate)) Then
                'Disallow
                'imRollbackReconcRequired = 1
                'lacUndoReconc.Caption = "Unable to Undo because: " & gMonthName(slRPRPDate) & " closed before Billing " & gMonthName(slRPRPDate)
                'lacUndoReconc.Visible = True
                ilRollbackReconcRequired = 1
            ElseIf (Year(slRPRPDate) = Year(slDate)) And (Month(slRPRPDate) = Month(slDate)) And (gDateValue(slRPRPDate) >= gDateValue(slDate)) Then
                If btrRecords(hmRhf) <= 0 Then
                    'imRollbackReconcRequired = 2
                    'lacUndoReconc.Caption = "Unable to Undo because: " & "This feature has just been installed and can't be used until one month has been Reconciled"
                    'lacUndoReconc.Visible = True
                    ilRollbackReconcRequired = 2
                Else
                    'Roll back Ok
                    'imRollbackReconcRequired = 3
                    'lacUndoReconc.Caption = "The Reconcile closing period " & gMonthName(slRPRPDate) & " will be Rolled Back if Undo is performed"
                    'lacUndoReconc.Visible = True
                    ilRollbackReconcRequired = 3
                End If
            Else
                ilRet = btrGetLast(hmRhf, tmRhf, imRhfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
                If ilRet = BTRV_ERR_NONE Then
                    If tmRhf.sSourceType = "U" Then
                        gUnpackDate tgSpf.iRCRP(0), tgSpf.iRCRP(1), slRCRPDate
                        slRCRPDate = gAdjYear(slRCRPDate)
                        If (Year(slRCRPDate) = Year(slDate)) And (Month(slRCRPDate) = Month(slDate)) And (gDateValue(slRCRPDate) >= gDateValue(slDate)) Then
                            'imRollbackReconcRequired = 4
                            'lacUndoReconc.Caption = "The Reconcile period " & gMonthName(slRCRPDate) & " previously Rolled Back by Invoice Undo Operation"
                            'lacUndoReconc.Visible = True
                            ilRollbackReconcRequired = 4
                        End If
                    End If
                End If
            End If
            If ilRollbackReconcRequired > 0 Then
                If imRollbackReconcRequired = 0 Then
                    imRollbackReconcRequired = ilRollbackReconcRequired
                ElseIf ilRollbackReconcRequired < imRollbackReconcRequired Then
                    imRollbackReconcRequired = ilRollbackReconcRequired
                End If
            End If
        End If
    Next ilPass
    Select Case imRollbackReconcRequired
        Case 1
            lacUndoReconc.Caption = "Unable to Undo because: " & gMonthName(slRPRPDate) & " closed before Billing " & gMonthName(slRPRPDate)
            lacUndoReconc.Visible = True
        Case 2
            lacUndoReconc.Caption = "Unable to Undo because: " & "This feature has just been installed and can't be used until one month has been Reconciled"
            lacUndoReconc.Visible = True
        Case 3
            lacUndoReconc.Caption = "The Reconcile closing period " & gMonthName(slRPRPDate) & " will be Rolled Back if Undo is performed"
            lacUndoReconc.Visible = True
        Case 4
            lacUndoReconc.Caption = "The Reconcile period " & gMonthName(slRCRPDate) & " previously Rolled Back by Invoice Undo Operation"
            lacUndoReconc.Visible = True
    End Select
End Sub

Private Sub mBuildDates()
    Dim slName As String
    Dim ilRet As Integer
    Dim slDate As String
    Dim slMonth As String
    Dim slYear As String

    'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
    'If (lbcDates.ListIndex >= 0) And ((ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked) Or (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked)) Then
    If (cbcDates.ListIndex >= 1) And ((ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked) Or (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked)) Then
        'slName = lbcDates.List(lbcDates.ListIndex)
        slName = cbcDates.List(cbcDates.ListIndex)
        ilRet = gParseItem(slName, 1, ",", slMonth)
        ilRet = gParseItem(slName, 2, ",", slYear)
        Select Case UCase$(slMonth)
            Case "JAN"
                slDate = "1/15/" & slYear
            Case "FEB"
                slDate = "2/15/" & slYear
            Case "MAR"
                slDate = "3/15/" & slYear
            Case "APR"
                slDate = "4/15/" & slYear
            Case "MAY"
                slDate = "5/15/" & slYear
            Case "June"
                slDate = "6/15/" & slYear
            Case "July"
                slDate = "7/15/" & slYear
            Case "AUG"
                slDate = "8/15/" & slYear
            Case "SEPT"
                slDate = "9/15/" & slYear
            Case "OCT"
                slDate = "10/15/" & slYear
            Case "NOV"
                slDate = "11/15/" & slYear
            Case "DEC"
                slDate = "12/15/" & slYear
        End Select
        imFullCal = True
        imFullStd = True
        If ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbChecked Then
            smStartCal = gObtainStartCal(slDate)
            smEndCal = gObtainEndCal(smStartCal)
            lmStartCal = gDateValue(smStartCal)
            lmEndCal = gDateValue(smEndCal)
        Else
            smStartCal = ""
            smEndCal = ""
            lmStartCal = 0
            lmEndCal = 0
        End If
        If ckcBillCycle(INVBILLCYCLE_STD).Value = vbChecked Then
            smStartStd = gObtainStartStd(slDate)
            smEndStd = gObtainEndStd(smStartStd)
            lmStartStd = gDateValue(smStartStd)
            lmEndStd = gDateValue(smEndStd)
        Else
            smStartStd = ""
            smEndStd = ""
            lmStartStd = 0
            lmEndStd = 0
        End If
    Else
        smStartCal = ""
        smEndCal = ""
        smStartStd = ""
        smEndStd = ""
        lmStartStd = 0
        lmEndStd = 0
        lmStartCal = 0
        lmEndCal = 0
    End If
    'If (lbcWeek.ListIndex >= 0) And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked) Then
    If (cbcWeek.ListIndex >= 1) And (ckcBillCycle(INVBILLCYCLE_Week).Value = vbChecked) Then
        'smStartWk = lbcWeek.List(lbcWeek.ListIndex)
        smStartWk = cbcWeek.List(cbcWeek.ListIndex)
        smEndWk = gObtainNextSunday(smStartWk)
        lmStartWk = gDateValue(smStartWk)
        lmEndWk = gDateValue(smEndWk)
        imFullWk = True
    Else
        smStartWk = ""
        smEndWk = ""
        lmStartWk = 0
        lmEndWk = 0
    End If
End Sub

'7/31/19: Remove parameter as not used and was amount was over 21,000,000.00
Private Sub mReconcTextFile(tlRhf As RHF, ilRollbackReconcRequired As Integer)  ', slAdjustedAmount As String)
    Dim hlMsg As Integer
    Dim slToFile As String
    Dim slMsg As String
    Dim slEndPrevPeriod As String
    Dim slLastMonthClosing As String
    Dim slStr As String
    Dim ilRet As Integer

    slToFile = sgDBPath & "Messages\Reconcile.Txt"
    ilRet = gFileOpen(slToFile, "Append", hlMsg)

    If ilRollbackReconcRequired = 3 Then
        slMsg = "Undo Reconcile period run on " & Format(Now, "m/d/yy") & " at " & Format(Now, "h:mm:ssAM/PM")
        Print #hlMsg, slMsg
        Print #hlMsg, ""
        gUnpackDate tgSpf.iRPRP(0), tgSpf.iRPRP(1), slEndPrevPeriod
        slMsg = "     " & "Account Receivable Balance, Previous Closing " & slEndPrevPeriod
        Do While Len(slMsg) < 60
            slMsg = slMsg & " "
        Loop
        gPDNToStr tgSpf.sRB, 2, slLastMonthClosing
        gFormatStr slLastMonthClosing, FMTCOMMA + FMTDOLLARSIGN, 2, slStr
        slMsg = slMsg & slStr
        Print #hlMsg, slMsg
    Else
        slMsg = "Undo Invoice run on " & Format(Now, "m/d/yy") & " at " & Format(Now, "h:mm:ssAM/PM")
        Print #hlMsg, slMsg

        Print #hlMsg, ""
        gPDNToStr tgSpf.sRB, 2, slStr
        gFormatStr slStr, FMTCOMMA + FMTDOLLARSIGN, 2, slStr
        slMsg = "     " & "Account Receivable Balance " & slStr
        Print #hlMsg, slMsg
    End If
    Print #hlMsg, ""
    Close #hlMsg
    Exit Sub
End Sub

Private Function mObtainRepSpots(llChfCode As Long) As Integer
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilUpper                                                                               *
'******************************************************************************************
    Dim ilRet As Integer
    Dim llDate As Long
    Dim ilIncludeSpot As Integer
    Dim slVehicle As String
    Dim slSortDate As String
    Dim slSortTime As String
    Dim slGameNo As String
    Dim slLineNo As String
    Dim llTime As Long
    Dim ilVef As Integer

    ReDim tmRepSdf(0 To 0) As TYPESORTREPSPOTS
    tmSdfSrchKey5.lCode = llChfCode
    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey5, INDEXKEY5, BTRV_LOCK_NONE, SETFORWRITE)  'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmSdf.lChfCode = llChfCode)
        'gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llDate
        gUnpackDateLongError tmSdf.iDate(0), tmSdf.iDate(1), llDate, "70:mObtainRepSpots " & tmSdf.lCode
        If (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
            tmSmfSrchKey2.lCode = tmSdf.lCode
            ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        End If
        ilIncludeSpot = True
        If tgChfRep.sBillCycle = "C" Then
            If (llDate > lmEndCal) Or (llDate < lmStartCal) Then
                ilIncludeSpot = False
            End If
        ElseIf tgChfRep.sBillCycle = "W" Then
            If (llDate > lmEndWk) Or (llDate < lmStartWk) Then
                ilIncludeSpot = False
            End If
        Else
            If (llDate > lmEndStd) Or (llDate < lmStartStd) Then
                ilIncludeSpot = False
            End If
        End If
        If ilIncludeSpot Then
            If (tmSdf.sSchStatus <> "G") And (tmSdf.sSchStatus <> "O") Then
                ilVef = gBinarySearchVef(tmSdf.iVefCode)
            Else
                ilVef = gBinarySearchVef(tmSmf.iOrigSchVef)
            End If
            If ilVef <> -1 Then
                slVehicle = tgMVef(ilVef).sName
            Else
                slVehicle = String(40, "Z")
            End If
            gUnpackDateForSort tmSdf.iDate(0), tmSdf.iDate(1), slSortDate
            gUnpackTimeLong tmSdf.iTime(0), tmSdf.iTime(1), False, llTime
            slSortTime = Trim$(str$(llTime))
            Do While Len(slSortTime) < 6
                slSortTime = "0" & slSortTime
            Loop
            slGameNo = Trim$(str$(tmSdf.iGameNo))
            '6/30/12:  Allow 5 digit event #'s
            Do While Len(slGameNo) < 5  '4
                slGameNo = "0" & slGameNo
            Loop
            slLineNo = Trim$(str$(tmSdf.iLineNo))
            Do While Len(slLineNo) < 4
                slLineNo = "0" & slLineNo
            Loop
            tmRepSdf(UBound(tmRepSdf)).sKey = slVehicle & "|" & slLineNo & "|" & slGameNo & "|" & slSortDate & "|" & slSortTime
            tmRepSdf(UBound(tmRepSdf)).tSdf = tmSdf
            ReDim Preserve tmRepSdf(0 To UBound(tmRepSdf) + 1) As TYPESORTREPSPOTS
        End If
        ilRet = btrGetNext(hmSdf, tmSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
    Loop
    If UBound(tmRepSdf) > 0 Then
        ArraySortTyp fnAV(tmRepSdf(), 0), UBound(tmRepSdf), 0, LenB(tmRepSdf(0)), 0, LenB(tmRepSdf(0).sKey), 0
    End If
    mObtainRepSpots = True
End Function

Private Sub mGenerateRepEDI(llChfCode As Long, llInvoiceNo As Long, ilPass As Integer, slAgyRate As String, slPctTrade As String, slEDITotalAired As String, ilEDITotalNoInv As Integer)
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  slEDILnStartDate              slEDILnEndDate                slEDIMGDate               *
'*  slEDIMGTime                   slEDIMissedTime                                         *
'******************************************************************************************
    Dim ilBonusSpot As Integer
    Dim ilLoop As Integer
    Dim ilEDIUpper As Integer
    Dim ilRet As Integer
    Dim ilEDIFlag As Integer
    Dim slEDIDays As String
    Dim slEDISTime As String
    Dim slEDIETime As String
    Dim slEDIRate As String     'Value without decimal point
    Dim slSpotRate As String
    Dim ilEDINoOrderedSpots As Integer
    Dim ilShowVehicleName As Integer
    Dim ilEDIDay As Integer
    Dim slEDIAirDate As String
    Dim slEDIAirTime As String
    Dim ilEDIVefCode As Integer     'Vehicle for which EDI is being generated
    Dim slEDITotalRate As String    'EDI Ordered total (by Vehicle)
    Dim slEDITotalAirRate As String 'EDI Aired Total (by Vehicle)
    Dim slEDIAirRate As String      'EDI Spot Rate
    Dim slEDIMissedDate As String
    Dim slSBMonth As String
    Dim slCBMonth As String
    Dim slWBMonth As String
    Dim slStdSDate As String
    Dim slStdEDate As String
    Dim slCalSDate As String
    Dim slCalEDate As String
    Dim slWkSDate As String
    Dim slWkEDate As String
    Dim slCInvDate As String
    Dim slSInvDate As String
    Dim slWInvDate As String
    Dim ilClf As Integer
    Dim ilCff As Integer
    Dim slStartTime As String
    Dim slEndTime As String
    Dim ilRdf As Integer
    Dim slStr As String
    Dim ilSpotsPerWk As Integer
    Dim llDate As Long
    Dim llSDate As Long
    Dim llFlightStartDate As Long
    Dim slSFlightDate As String
    Dim slEFlightDate As String
    Dim ilIncludeFlight As Integer
    Dim ilDay As Integer
    ReDim slCopyProduct(0 To 6) As String   'Index zero ignored
    ReDim slCopy(0 To 6) As String  'Zone plus ISCI. Index zero ignored
    Dim llNextStartWkDate As Long
    Dim ilGen41 As Integer
    Dim llDailyLastDate As Long
    Dim ilVef As Integer
    Dim llPriceDate As Long
    Dim ilExtraWeek As Integer

    ilExtraWeek = False
    ilEDIVefCode = -1
    llNextStartWkDate = -1
    llDailyLastDate = -1
    slEDITotalRate = ".00"
    slEDITotalAirRate = ".00"
    ReDim tmRepSdf(0 To 0) As TYPESORTREPSPOTS
    ilEDIUpper = 0
    ReDim smEDIRecords(0 To ilEDIUpper) As String
    ReDim smEDIByVehSort(0 To 0) As SORTCODE
    ilShowVehicleName = True
    ilEDIFlag = mDetermineIfEDIRequired()
    If ilEDIFlag Then
        slStdSDate = Format$(gDateValue(smStartStd), "yymmdd")
        slStdEDate = Format$(gDateValue(smEndStd), "yymmdd")
        slCalSDate = Format$(gDateValue(smStartCal), "yymmdd")
        slCalEDate = Format$(gDateValue(smEndCal), "yymmdd")
        slWkSDate = Format$(gDateValue(smStartWk), "yymmdd")
        slWkEDate = Format$(gDateValue(smEndWk), "yymmdd")
        slCBMonth = Format$(gDateValue(gObtainEndStd(smEndCal)), "yymm")
        slSBMonth = Format$(gDateValue(smEndStd), "yymm")
        slWBMonth = Format$(gDateValue(smEndWk), "yymm")
        slSInvDate = Format$(gDateValue(smEndStd), "yymmdd")
        slCInvDate = Format$(gDateValue(smEndCal), "yymmdd")
        slWInvDate = Format$(gDateValue(smEndWk), "yymmdd")
        ilRet = mObtainRepSpots(llChfCode)
        'Output EDI
        ilLoop = 0
        Do While ilLoop <= UBound(tmRepSdf) - 1
            tmSdf = tmRepSdf(ilLoop).tSdf
            gUnpackDate tmSdf.iDate(0), tmSdf.iDate(1), slEDIAirDate
            gUnpackTime tmSdf.iTime(0), tmSdf.iTime(1), "A", "1", slEDIAirTime
            If (tmSdf.sSchStatus = "O") Or (tmSdf.sSchStatus = "G") Then
                tmSmfSrchKey2.lCode = tmSdf.lCode
                ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                If ilRet = BTRV_ERR_NONE Then
                    gUnpackDateLongError tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), llPriceDate, "71:mObtainRepEDI " & tmSmf.lCode
                End If
            Else
                gUnpackDateLongError tmSdf.iDate(0), tmSdf.iDate(1), llPriceDate, "72:mObtainRepEDI " & tmSdf.lCode
            End If
            'Setup parameters for 41, 42, 51 ans 52
            slEDISTime = ""
            slEDIETime = ""
            tmClf.lCode = -1
            For ilClf = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
                If tmSdf.iLineNo = tgClfInv(ilClf).ClfRec.iLine Then
                    tmClf = tgClfInv(ilClf).ClfRec
                    If (tmClf.iStartTime(0) <> 1) Or (tmClf.iStartTime(1) <> 0) Then
                        gUnpackTime tmClf.iStartTime(0), tmClf.iStartTime(1), "A", "1", slStartTime
                        gUnpackTime tmClf.iEndTime(0), tmClf.iEndTime(1), "A", "1", slEndTime
                        gAdjOverrideTimes tmClf.iVefCode, slStartTime, slEndTime
                        slEDISTime = gFormatTime(slStartTime, "M", "2")
                        slEDIETime = gFormatTime(slEndTime, "M", "2")
                        If slEDIETime = "0000" Then
                            slEDIETime = "2400"
                        End If
                    Else
                        If tgSpf.sBOrderDPShow = "T" Then
                            For ilRdf = LBound(tmRdf.iStartTime, 2) To UBound(tmRdf.iStartTime, 2) Step 1 'Row
                                If (tmRdf.iStartTime(0, ilRdf) <> 1) Or (tmRdf.iStartTime(1, ilRdf) <> 0) Then
                                    gUnpackTime tmRdf.iStartTime(0, ilRdf), tmRdf.iStartTime(1, ilRdf), "A", "1", slStartTime
                                    gUnpackTime tmRdf.iEndTime(0, ilRdf), tmRdf.iEndTime(1, ilRdf), "A", "1", slEndTime
                                    gAdjOverrideTimes tmClf.iVefCode, slStartTime, slEndTime
                                    slEDISTime = gFormatTime(slStartTime, "M", "2")
                                    slEDIETime = gFormatTime(slEndTime, "M", "2")
                                    If slEDIETime = "0000" Then
                                        slEDIETime = "2400"
                                    End If
                                    Exit For
                                End If
                            Next ilRdf
                        End If
                    End If
                    Exit For
                End If
            Next ilClf
            ilBonusSpot = False
            If Not ilExtraWeek Then
                If tmRepSdf(ilLoop).tSdf.sSpotType = "X" Then
                    ilBonusSpot = True
                End If
            End If
            If tmClf.lCode <> -1 Then
                ilVef = gBinarySearchVef(tmClf.iVefCode)
                If ilVef <> -1 Then
                    tmVef = tgMVef(ilVef)
                Else
                    tmVef.sName = "Vehicle Missing"
                End If
            Else
                tmVef.sName = "Vehicle Missing"
            End If
            If ilEDIVefCode <> -1 Then
                If (tgSpf.sBCombine = "N") Then
                    If ilEDIVefCode <> tmClf.iVefCode Then
                        mEDIStationEnd ilEDIUpper, ilPass, slEDITotalRate, slEDITotalAirRate, slAgyRate, slEDITotalAired, ilEDITotalNoInv
                        ilEDIVefCode = -1
                    End If
                End If
            End If
            If ilEDIVefCode = -1 Then
                If (Not ilBonusSpot) Or (tgSpf.sBCombine = "N") Then
                    ilEDIVefCode = tmClf.iVefCode
                Else
                    ilEDIVefCode = 0
                End If
                mEDIStationStart ilEDIUpper, ilEDIVefCode, slSInvDate, slCInvDate, slWInvDate, llInvoiceNo, slSBMonth, slCBMonth, slWBMonth, slStdSDate, slStdEDate, slCalSDate, slCalEDate, slWkSDate, slWkEDate
            End If
            ilEDINoOrderedSpots = 0
            ilCff = tgClfInv(ilClf).iFirstCff
            llFlightStartDate = 0
            ilEDINoOrderedSpots = 0
            slEDIAirRate = "0"
            slEDIDays = String(7, "N")
            Do While ilCff <> -1
                gUnpackDate tgCffInv(ilCff).CffRec.iStartDate(0), tgCffInv(ilCff).CffRec.iStartDate(1), slSFlightDate
                gUnpackDate tgCffInv(ilCff).CffRec.iEndDate(0), tgCffInv(ilCff).CffRec.iEndDate(1), slEFlightDate
                ilIncludeFlight = True
                If tmChf.sBillCycle = "C" Then
                    If (gDateValue(slSFlightDate) > lmEndCal) Or (gDateValue(slEFlightDate) < lmStartCal) Then
                        ilIncludeFlight = False
                    End If
                ElseIf tmChf.sBillCycle = "W" Then
                    If (gDateValue(slSFlightDate) > lmEndWk) Or (gDateValue(slEFlightDate) < lmStartWk) Then
                        ilIncludeFlight = False
                    End If
                Else
                    If (gDateValue(slSFlightDate) > lmEndStd) Or (gDateValue(slEFlightDate) < lmStartStd) Then
                        ilIncludeFlight = False
                    End If
                End If
                'Test if CBS
                If gDateValue(slEFlightDate) < gDateValue(slSFlightDate) Then
                    ilIncludeFlight = False
                End If
                If (ilIncludeFlight) And (Not ilExtraWeek) Then
                    If (llPriceDate < gDateValue(slSFlightDate)) Or (llPriceDate > gDateValue(slEFlightDate)) Then
                        ilIncludeFlight = False
                    End If
                End If
                If ilIncludeFlight Then
                    slEDIRate = "0"
                    slSpotRate = ".00"
                    Select Case tgCffInv(ilCff).CffRec.sPriceType
                        Case "T"    'True
                            slSpotRate = gLongToStrDec(tgCffInv(ilCff).CffRec.lActPrice, 2)
                            slEDIRate = gLongToStrDec(tgCffInv(ilCff).CffRec.lActPrice, 0)
                            If (ilPass = 1) And (Val(slPctTrade) <> 0) Then
                                slSpotRate = gDivStr(gMulStr(slSpotRate, gSubStr("100", slPctTrade)), "100")
                                slEDIRate = gDivStr(gMulStr(slEDIRate, gSubStr("100", slPctTrade)), "100")
                            ElseIf (ilPass = 2) And (Val(slPctTrade) <> 100) Then
                                slSpotRate = gSubStr(slSpotRate, gDivStr(gMulStr(slSpotRate, gSubStr("100", slPctTrade)), "100"))
                                slEDIRate = gSubStr(slEDIRate, gDivStr(gMulStr(slEDIRate, gSubStr("100", slPctTrade)), "100"))
                            End If
                    End Select
                    If Not ilExtraWeek Then
                        If Not ilBonusSpot Then
                            slEDIAirRate = slEDIRate
                            slEDITotalAirRate = gAddStr(slEDITotalAirRate, slSpotRate)
                        Else
                            slEDIAirRate = "0"
                            slSpotRate = ".00"
                        End If
                    End If
                    ilSpotsPerWk = 0
                    slStr = ""
                    slEDIDays = ""
                    For ilDay = 0 To 6 Step 1
                        ilSpotsPerWk = ilSpotsPerWk + tgCffInv(ilCff).CffRec.iDay(ilDay)
                        slStr = slStr & str$(tgCffInv(ilCff).CffRec.iDay(ilDay)) & " "
                        If tgCffInv(ilCff).CffRec.sDyWk <> "D" Then
                            If tgCffInv(ilCff).CffRec.iDay(ilDay) > 0 Then
                                Select Case ilDay
                                    Case 0
                                        slEDIDays = slEDIDays & "Y"
                                    Case 1
                                        slEDIDays = slEDIDays & "Y"
                                    Case 2
                                        slEDIDays = slEDIDays & "Y"
                                    Case 3
                                        slEDIDays = slEDIDays & "Y"
                                    Case 4
                                        slEDIDays = slEDIDays & "Y"
                                    Case 5
                                        slEDIDays = slEDIDays & "Y"
                                    Case 6
                                        slEDIDays = slEDIDays & "Y"
                                End Select
                            Else
                                slEDIDays = slEDIDays & "N"
                            End If
                        Else
                            If tgCffInv(ilCff).CffRec.iDay(ilDay) > 0 Then
                                Select Case ilDay
                                    Case 0
                                        slEDIDays = slEDIDays & "M"
                                    Case 1
                                        slEDIDays = slEDIDays & "T"
                                    Case 2
                                        slEDIDays = slEDIDays & "W"
                                    Case 3
                                        slEDIDays = slEDIDays & "T"
                                    Case 4
                                        slEDIDays = slEDIDays & "F"
                                    Case 5
                                        slEDIDays = slEDIDays & "S"
                                    Case 6
                                        slEDIDays = slEDIDays & "S"
                                End Select
                            Else
                                slEDIDays = slEDIDays & " "
                            End If
                        End If
                    Next ilDay

                    slStr = ""
                    If tgCffInv(ilCff).CffRec.sDyWk <> "D" Then
                        'slStr = gDayNames(tgCffInv(ilCff).CffRec.iDay(), tgCffInv(ilCff).CffRec.sXDay(), 2, slEDIDays)
                        If tmChf.sBillCycle = "C" Then
                            llDate = gDateValue(slSFlightDate)
                            Do While llDate <= gDateValue(slEFlightDate)
                                If llDate >= llNextStartWkDate Then
                                    ilGen41 = False
                                    If llDate < lmStartCal Then
                                        If llDate + 6 >= lmStartCal Then
                                            If Not ilBonusSpot Then
                                                ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iXSpotsWk
                                            End If
                                            If tmClf.sType <> "E" Then
                                                slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(slSpotRate, Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))))
                                            Else
                                                slEDITotalRate = gAddStr(slEDITotalRate, slSpotRate)
                                            End If
                                            ilGen41 = True
                                        End If
                                    ElseIf (llDate <= lmEndCal) Then
                                        If Not ilBonusSpot Then
                                            ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iSpotsWk
                                        End If
                                        If tmClf.sType <> "E" Then
                                            slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(slSpotRate, Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                                        Else
                                            slEDITotalRate = gAddStr(slEDITotalRate, slSpotRate)
                                        End If
                                        ilGen41 = True
                                    Else
                                        Exit Do
                                    End If
                                    'Output week if not previously generated
                                    'Output 41 and optionally 42
                                    If ((Not ilBonusSpot)) And (ilGen41) Or ((ilExtraWeek) And (ilGen41)) Then
                                        'EDI Flight Info
                                        mRemovePriorEDI41WOSpots ilEDIUpper
                                        smEDIRecords(ilEDIUpper) = "41;" & Trim$(str$(tmRepSdf(ilLoop).tSdf.iLineNo)) & ";" & slEDIDays & ";" & slEDISTime & ";" & slEDIETime & ";;" & slEDIRate & ";" & Trim$(str$(ilEDINoOrderedSpots)) & ";" & "" & ";" & "" & ";"
                                        ilEDIUpper = ilEDIUpper + 1
                                        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                        If ilShowVehicleName Then
                                            smEDIRecords(ilEDIUpper) = "42;" & Trim$(tmVef.sName) & ";"
                                            ilEDIUpper = ilEDIUpper + 1
                                            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                            ilShowVehicleName = False
                                        End If
                                    End If
                                    llNextStartWkDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
                                End If
                                'If spot within week, exit
                                'Check if spot within flight, if so exist loop
                                If Not ilExtraWeek Then
                                    'If (gDateValue(slEDIAirDate) >= llDate) Or (gDateValue(slEDIAirDate) < gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))) Then
                                    If (gDateValue(slEDIAirDate) >= llDate) And (gDateValue(slEDIAirDate) <= gDateValue(gObtainNextSunday(Format$(llDate, "m/d/yy")))) Then
                                        Exit Do
                                    End If
                                End If
                                llDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
                            Loop
                        ElseIf tmChf.sBillCycle = "W" Then
                            llDate = gDateValue(slSFlightDate)
                            Do While llDate <= gDateValue(slEFlightDate)
                                If llDate >= llNextStartWkDate Then
                                    ilGen41 = False
                                    If llDate < lmStartWk Then
                                        If llDate + 6 >= lmStartWk Then
                                            If Not ilBonusSpot Then
                                                ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iXSpotsWk
                                            End If
                                            If tmClf.sType <> "E" Then
                                                slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(slSpotRate, Trim$(str$(tgCffInv(ilCff).CffRec.iXSpotsWk))))
                                            Else
                                                slEDITotalRate = gAddStr(slEDITotalRate, slSpotRate)
                                            End If
                                            ilGen41 = True
                                        End If
                                    ElseIf (llDate <= lmEndWk) Then
                                        If Not ilBonusSpot Then
                                            ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iSpotsWk
                                        End If
                                        If tmClf.sType <> "E" Then
                                            slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(slSpotRate, Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                                        Else
                                            slEDITotalRate = gAddStr(slEDITotalRate, slSpotRate)
                                        End If
                                        ilGen41 = True
                                    Else
                                        Exit Do
                                    End If
                                    'Output week if not previously generated
                                    'Output 41 and optionally 42
                                    If ((Not ilBonusSpot)) And (ilGen41) Or ((ilExtraWeek) And (ilGen41)) Then
                                        'EDI Flight Info
                                        mRemovePriorEDI41WOSpots ilEDIUpper
                                        smEDIRecords(ilEDIUpper) = "41;" & Trim$(str$(tmRepSdf(ilLoop).tSdf.iLineNo)) & ";" & slEDIDays & ";" & slEDISTime & ";" & slEDIETime & ";;" & slEDIRate & ";" & Trim$(str$(ilEDINoOrderedSpots)) & ";" & "" & ";" & "" & ";"
                                        ilEDIUpper = ilEDIUpper + 1
                                        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                        If ilShowVehicleName Then
                                            smEDIRecords(ilEDIUpper) = "42;" & Trim$(tmVef.sName) & ";"
                                            ilEDIUpper = ilEDIUpper + 1
                                            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                            ilShowVehicleName = False
                                        End If
                                    End If
                                    llNextStartWkDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
                                End If
                                'If spot within week, exit
                                'Check if spot within flight, if so exist loop
                                If Not ilExtraWeek Then
                                    'If (gDateValue(slEDIAirDate) >= llDate) Or (gDateValue(slEDIAirDate) < gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))) Then
                                    If (gDateValue(slEDIAirDate) >= llDate) And (gDateValue(slEDIAirDate) <= gDateValue(gObtainNextSunday(Format$(llDate, "m/d/yy")))) Then
                                        Exit Do
                                    End If
                                End If
                                llDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
                            Loop
                        Else
                            llDate = gDateValue(slSFlightDate)
                            Do While llDate <= gDateValue(slEFlightDate)
                                If llDate >= llNextStartWkDate Then
                                    ilGen41 = False
                                    If (llDate >= lmStartStd) And (llDate <= lmEndStd) Then
                                        If Not ilBonusSpot Then
                                            ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iSpotsWk
                                        End If
                                        If tmClf.sType <> "E" Then
                                            slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(slSpotRate, Trim$(str$(tgCffInv(ilCff).CffRec.iSpotsWk))))
                                        Else
                                            slEDITotalRate = gAddStr(slEDITotalRate, slSpotRate)
                                        End If
                                        ilGen41 = True
                                    End If
                                    If llDate > lmEndStd Then
                                        Exit Do
                                    End If
                                    'Output 41 and optionally 42
                                    If ((Not ilBonusSpot) And (ilGen41)) Or ((ilExtraWeek) And (ilGen41)) Then
                                        'EDI Flight Info
                                        mRemovePriorEDI41WOSpots ilEDIUpper
                                        smEDIRecords(ilEDIUpper) = "41;" & Trim$(str$(tmRepSdf(ilLoop).tSdf.iLineNo)) & ";" & slEDIDays & ";" & slEDISTime & ";" & slEDIETime & ";;" & slEDIRate & ";" & Trim$(str$(ilEDINoOrderedSpots)) & ";" & "" & ";" & "" & ";"
                                        ilEDIUpper = ilEDIUpper + 1
                                        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                        If ilShowVehicleName Then
                                            smEDIRecords(ilEDIUpper) = "42;" & Trim$(tmVef.sName) & ";"
                                            ilEDIUpper = ilEDIUpper + 1
                                            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                            ilShowVehicleName = False
                                        End If
                                    End If
                                    llNextStartWkDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
                                End If
                                'Check if spot within flight, if so exist loop
                                If Not ilExtraWeek Then
                                    'If (gDateValue(slEDIAirDate) >= llDate) Or (gDateValue(slEDIAirDate) < gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))) Then
                                    If (gDateValue(slEDIAirDate) >= llDate) And (gDateValue(slEDIAirDate) <= gDateValue(gObtainNextSunday(Format$(llDate, "m/d/yy")))) Then
                                        Exit Do
                                    End If
                                End If
                                llDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
                            Loop
                        End If
                    Else
                        If tmChf.sBillCycle = "C" Then
                            If gDateValue(slSFlightDate) >= lmStartCal Then
                                llSDate = gDateValue(slSFlightDate)
                            Else
                                llSDate = lmStartCal
                            End If
                            For llDate = llSDate To gDateValue(slEFlightDate) Step 1
                                'Output week if not previously generated
                                If llDate > llDailyLastDate Then
                                    ilGen41 = False
                                    If (llDate >= lmStartCal) And (llDate <= lmEndCal) Then
                                        ilDay = gWeekDayLong(llDate)
                                        If Not ilBonusSpot Then
                                            ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iDay(ilDay)
                                        End If
                                        If tmClf.sType <> "E" Then
                                            slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(slSpotRate, Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                                        Else
                                            slEDITotalRate = gAddStr(slEDITotalRate, slSpotRate)
                                        End If
                                        ilGen41 = True
                                    End If
                                    llDailyLastDate = llDate
                                End If
                                If llDate >= llNextStartWkDate Then
                                    'Output 41 and optionally 42
                                    If ((Not ilBonusSpot) And (ilGen41)) Or ((ilExtraWeek) And (ilGen41)) Then
                                        'EDI Flight Info
                                        mRemovePriorEDI41WOSpots ilEDIUpper
                                        smEDIRecords(ilEDIUpper) = "41;" & Trim$(str$(tmRepSdf(ilLoop).tSdf.iLineNo)) & ";" & slEDIDays & ";" & slEDISTime & ";" & slEDIETime & ";;" & slEDIRate & ";" & Trim$(str$(ilEDINoOrderedSpots)) & ";" & "" & ";" & "" & ";"
                                        ilEDIUpper = ilEDIUpper + 1
                                        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                        If ilShowVehicleName Then
                                            smEDIRecords(ilEDIUpper) = "42;" & Trim$(tmVef.sName) & ";"
                                            ilEDIUpper = ilEDIUpper + 1
                                            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                            ilShowVehicleName = False
                                        End If
                                    End If
                                    llNextStartWkDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
                                End If
                                'Check if spot within flight, if so exist loop
                                If Not ilExtraWeek Then
                                    'If (gDateValue(slEDIAirDate) >= llDate) Or (gDateValue(slEDIAirDate) <= gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))) Then
                                    If (gDateValue(slEDIAirDate) >= llDate) And (gDateValue(slEDIAirDate) <= gDateValue(gObtainNextSunday(Format$(llDate, "m/d/yy")))) Then
                                        Exit Do
                                    End If
                                End If
                                If llDate >= lmEndCal Then
                                    Exit For
                                End If
                            Next llDate
                       ElseIf tmChf.sBillCycle = "W" Then
                            If gDateValue(slSFlightDate) >= lmStartWk Then
                                llSDate = gDateValue(slSFlightDate)
                            Else
                                llSDate = lmStartWk
                            End If
                            For llDate = llSDate To gDateValue(slEFlightDate) Step 1
                                'Output week if not previously generated
                                If llDate > llDailyLastDate Then
                                    ilGen41 = False
                                    If (llDate >= lmStartWk) And (llDate <= lmEndWk) Then
                                        ilDay = gWeekDayLong(llDate)
                                        If Not ilBonusSpot Then
                                            ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iDay(ilDay)
                                        End If
                                        If tmClf.sType <> "E" Then
                                            slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(slSpotRate, Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                                        Else
                                            slEDITotalRate = gAddStr(slEDITotalRate, slSpotRate)
                                        End If
                                        ilGen41 = True
                                    End If
                                    llDailyLastDate = llDate
                                End If
                                If llDate >= llNextStartWkDate Then
                                    'Output 41 and optionally 42
                                    If ((Not ilBonusSpot) And (ilGen41)) Or ((ilExtraWeek) And (ilGen41)) Then
                                        'EDI Flight Info
                                        mRemovePriorEDI41WOSpots ilEDIUpper
                                        smEDIRecords(ilEDIUpper) = "41;" & Trim$(str$(tmRepSdf(ilLoop).tSdf.iLineNo)) & ";" & slEDIDays & ";" & slEDISTime & ";" & slEDIETime & ";;" & slEDIRate & ";" & Trim$(str$(ilEDINoOrderedSpots)) & ";" & "" & ";" & "" & ";"
                                        ilEDIUpper = ilEDIUpper + 1
                                        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                        If ilShowVehicleName Then
                                            smEDIRecords(ilEDIUpper) = "42;" & Trim$(tmVef.sName) & ";"
                                            ilEDIUpper = ilEDIUpper + 1
                                            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                            ilShowVehicleName = False
                                        End If
                                    End If
                                    llNextStartWkDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
                                End If
                                'Check if spot within flight, if so exist loop
                                If Not ilExtraWeek Then
                                    'If (gDateValue(slEDIAirDate) >= llDate) Or (gDateValue(slEDIAirDate) <= gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))) Then
                                    If (gDateValue(slEDIAirDate) >= llDate) And (gDateValue(slEDIAirDate) <= gDateValue(gObtainNextSunday(Format$(llDate, "m/d/yy")))) Then
                                        Exit Do
                                    End If
                                End If
                                If llDate >= lmEndWk Then
                                    Exit For
                                End If
                            Next llDate
                        Else
                            If gDateValue(slSFlightDate) >= lmStartStd Then
                                llSDate = gDateValue(slSFlightDate)
                            Else
                                llSDate = lmStartStd
                            End If
                            For llDate = llSDate To gDateValue(slEFlightDate) Step 1
                                'Output week if not previously generated
                                If llDate >= llNextStartWkDate Then
                                    ilGen41 = False
                                    If (llDate >= lmStartStd) And (llDate <= lmEndStd) Then
                                        ilDay = gWeekDayLong(llDate)
                                        If Not ilBonusSpot Then
                                            ilEDINoOrderedSpots = ilEDINoOrderedSpots + tgCffInv(ilCff).CffRec.iDay(ilDay)
                                        End If
                                        If tmClf.sType <> "E" Then
                                            slEDITotalRate = gAddStr(slEDITotalRate, gMulStr(slSpotRate, Trim$(str$(tgCffInv(ilCff).CffRec.iDay(ilDay)))))
                                        Else
                                            slEDITotalRate = gAddStr(slEDITotalRate, slSpotRate)
                                        End If
                                        ilGen41 = True
                                    End If
                                    'Output 41 and optionally 42
                                    If ((Not ilBonusSpot) And (ilGen41)) Or ((ilExtraWeek) And (ilGen41)) Then
                                        'EDI Flight Info
                                        mRemovePriorEDI41WOSpots ilEDIUpper
                                        smEDIRecords(ilEDIUpper) = "41;" & Trim$(str$(tmRepSdf(ilLoop).tSdf.iLineNo)) & ";" & slEDIDays & ";" & slEDISTime & ";" & slEDIETime & ";;" & slEDIRate & ";" & Trim$(str$(ilEDINoOrderedSpots)) & ";" & "" & ";" & "" & ";"
                                        ilEDIUpper = ilEDIUpper + 1
                                        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                        If ilShowVehicleName Then
                                            smEDIRecords(ilEDIUpper) = "42;" & Trim$(tmVef.sName) & ";"
                                            ilEDIUpper = ilEDIUpper + 1
                                            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
                                            ilShowVehicleName = False
                                        End If
                                    End If
                                    llNextStartWkDate = gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))
                                End If
                                'Check if spot within flight, if so exist loop
                                If Not ilExtraWeek Then
                                    'If (gDateValue(slEDIAirDate) >= llDate) Or (gDateValue(slEDIAirDate) <= gDateValue(gObtainNextMonday(Format$(llDate + 1, "m/d/yy")))) Then
                                    If (gDateValue(slEDIAirDate) >= llDate) And (gDateValue(slEDIAirDate) <= gDateValue(gObtainNextSunday(Format$(llDate, "m/d/yy")))) Then
                                        Exit Do
                                    End If
                                End If
                                If llDate >= lmEndStd Then
                                    Exit For
                                End If
                            Next llDate
                        End If
                    End If
                    If Not ilExtraWeek Then
                        Exit Do
                    End If
                End If
                ilCff = tgCffInv(ilCff).iNextCff
            Loop
            If Not ilExtraWeek Then
                'Output 51 and 52
                slEDIAirDate = Format$(slEDIAirDate, "yymmdd")
                ilEDIDay = gWeekDayStr(slEDIAirDate) + 1
                slEDIAirTime = gFormatTime(slEDIAirTime, "M", "2")
                smEDIRecords(ilEDIUpper) = "51;" & "Y;" & slEDIAirDate & ";" & Trim$(str$(ilEDIDay)) & ";" & slEDIAirTime & ";" & Trim$(str$(tmClf.iLen)) & ";"
                'Get Copy
                slStr = ""      'Copy
                mObtainCopy slCopyProduct(), slCopy()
                If Trim$(slCopy(1)) <> "" Then
                    slStr = slCopy(1)
                End If
                smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & slStr & ";" & slEDIAirRate & ";"
                slEDIMissedDate = ""
                If (tmRepSdf(ilLoop).tSdf.sSchStatus = "O") Or (tmRepSdf(ilLoop).tSdf.sSchStatus = "G") Then
                    tmSmfSrchKey2.lCode = tmSdf.lCode
                    ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    If ilRet = BTRV_ERR_NONE Then
                        gUnpackDate tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), slEDIMissedDate
                    End If
                End If
                If slEDIMissedDate = "" Then
                    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";;;;;;;;;;N;"
                Else
                    smEDIRecords(ilEDIUpper) = smEDIRecords(ilEDIUpper) & ";;" & slEDIMissedDate & ";;;;;;;;N;"
                End If

                ilEDIUpper = ilEDIUpper + 1
                ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
            End If

            If ilLoop = UBound(tmRepSdf) - 1 Then
                If ilExtraWeek Then
                    Exit Do
                    ilExtraWeek = False
                Else
                    ilExtraWeek = True
                End If
            Else
                If tmRepSdf(ilLoop).tSdf.iLineNo <> tmRepSdf(ilLoop + 1).tSdf.iLineNo Then
                    If ilExtraWeek Then
                        ilLoop = ilLoop + 1
                        ilExtraWeek = False
                        llNextStartWkDate = -1
                        llDailyLastDate = -1
                        ilShowVehicleName = True
                    Else
                        ilExtraWeek = True
                    End If
                Else
                    ilLoop = ilLoop + 1
                    ilExtraWeek = False
                End If
            End If
        Loop
        mEDIStationEnd ilEDIUpper, ilPass, slEDITotalRate, slEDITotalAirRate, slAgyRate, slEDITotalAired, ilEDITotalNoInv
    End If
End Sub

Private Function mUpdateRepSpotsBillFlag(llChfCode As Long) As Integer
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilUpper                       slVehicle                     slSortDate                *
'*  slSortTime                    slGameNo                      slLineNo                  *
'*  llTime                        ilVef                                                   *
'******************************************************************************************
    Dim ilRet As Integer
    Dim llDate As Long
    Dim ilIncludeSpot As Integer
    Dim ilLoop As Integer

    If rbcType(INVGEN_Final).Value <> True Then
        mUpdateRepSpotsBillFlag = True
        Exit Function
    End If
    ReDim llSdfCode(0 To 0) As Long
    tmSdfSrchKey5.lCode = llChfCode
    ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey5, INDEXKEY5, BTRV_LOCK_NONE, SETFORWRITE)  'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmSdf.lChfCode = llChfCode)
        gUnpackDateLongError tmSdf.iDate(0), tmSdf.iDate(1), llDate, "73:mUpdateRepSpotsBillFlag " & tmSdf.lCode
        If (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
            tmSmfSrchKey2.lCode = tmSdf.lCode
            ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        End If
        ilIncludeSpot = True
        If tgChfRep.sBillCycle = "C" Then
            If (llDate > lmEndCal) Or (llDate < lmStartCal) Then
                ilIncludeSpot = False
            End If
        ElseIf tgChfRep.sBillCycle = "W" Then
            If (llDate > lmEndWk) Or (llDate < lmStartWk) Then
                ilIncludeSpot = False
            End If
        Else
            If (llDate > lmEndStd) Or (llDate < lmStartStd) Then
                ilIncludeSpot = False
            End If
        End If
        If ilIncludeSpot Then
            llSdfCode(UBound(llSdfCode)) = tmSdf.lCode
            ReDim Preserve llSdfCode(0 To UBound(llSdfCode) + 1) As Long
        End If
        ilRet = btrGetNext(hmSdf, tmSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
    Loop
    For ilLoop = 0 To UBound(llSdfCode) - 1 Step 1
        tmSdfSrchKey3.lCode = llSdfCode(ilLoop)
        ilRet = btrGetEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If ilRet <> BTRV_ERR_NONE Then
            'Debug
            ilRet = ilRet
        Else
            tmSdf.sBill = "Y"
            ilRet = btrUpdate(hmSdf, tmSdf, imSdfRecLen)
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                Print #hmMsg, "mUpdateRepSpotsBillFlag: btrUpdate-Point 1, Sdf Error # " & Trim$(str$(ilRet))
            End If
        End If
    Next ilLoop
    mUpdateRepSpotsBillFlag = True
End Function

Private Sub mEDIByVehSort(ilEDIFlag, llSdfIndex As Long)
    Dim ilRet As Integer
    Dim ilVef As Integer
    Dim slVehicleName As String
    Dim ilLineNo As Integer
    Dim slLineNo As String
    Dim ilEDILnIndex As Integer
    Dim ilLoop As Integer
    Dim slEDILnIndex As String
    Dim slEDISpotIndex As String
    Dim slSort As String
    Dim slBonus As String

    If Not ilEDIFlag Then
        Exit Sub
    End If
    If ((tmEDIArf.sSepInvByVeh = "Y") And (tgSpf.sBCombine <> "N")) Then
        ilVef = gBinarySearchVef(tmSdf.iVefCode)
        If ilVef <> -1 Then
            slVehicleName = tgMVef(ilVef).sName
        Else
            ilRet = gParseItem(tgSortKey(llSdfIndex).sKey, 9, "|", slVehicleName)
        End If
        Do While Len(slVehicleName) < 40
            slVehicleName = slVehicleName & " "
        Loop
        'Find index for line record (41;)
        ilLineNo = tmSdf.iLineNo
        If tmSdf.sSpotType <> "X" Then
            slBonus = "N"
            For ilLoop = UBound(smEDIRecords) To 0 Step -1
                If Left$(smEDIRecords(ilLoop), 3) = "41;" Then
                    ilEDILnIndex = ilLoop
                    Exit For
                End If
            Next ilLoop
        Else
            slBonus = "Y"
            ilRet = gParseItem(tgSortKey(llSdfIndex).sKey, 9, "|", slVehicleName)
            For ilLoop = UBound(smEDIRecords) To 0 Step -1
                If Left$(smEDIRecords(ilLoop), 3) = "41;" Then
                    ilRet = gParseItem(tgSortKey(llSdfIndex).sKey, 6, "|", slLineNo)
                    If ilLineNo = Val(slLineNo) Then
                        ilEDILnIndex = ilLoop
                        Exit For
                    End If
                End If
            Next ilLoop
        End If
        slEDILnIndex = Trim$(str$(ilEDILnIndex))
        Do While Len(slEDILnIndex) < 4
            slEDILnIndex = "0" & slEDILnIndex
        Loop
        slEDISpotIndex = Trim$(str$(UBound(smEDIRecords)))
        Do While Len(slEDISpotIndex) < 4
            slEDISpotIndex = "0" & slEDISpotIndex
        Loop
        slSort = slVehicleName & "|" & slEDILnIndex & "|" & slEDISpotIndex & "|" & slBonus
        smEDIByVehSort(UBound(smEDIByVehSort)).sKey = slSort
        ReDim Preserve smEDIByVehSort(0 To UBound(smEDIByVehSort) + 1) As SORTCODE
    End If
End Sub

Private Function mConvertEDIDays(slInEDIDays As String) As String
    Dim ilDay As Integer
    Dim slDays As String

    slDays = ""
    For ilDay = 1 To 7 Step 1
        If Mid(slInEDIDays, ilDay, 1) = "Y" Then
            Select Case ilDay
                Case 1
                    slDays = slDays & "M"
                Case 2
                    slDays = slDays & "T"
                Case 3
                    slDays = slDays & "W"
                Case 4
                    slDays = slDays & "T"
                Case 5
                    slDays = slDays & "F"
                Case 6
                    slDays = slDays & "S"
                Case 7
                    slDays = slDays & "S"
            End Select
        Else
            slDays = slDays & " "
        End If
    Next ilDay
    mConvertEDIDays = slDays
End Function

Private Sub mCallRadioButtons()
    Dim ilRadioTypeSet As Integer
    Dim c As Integer
    If imIgnoreSelAdvtRequest Then
        Exit Sub
    End If
    ilRadioTypeSet = -1
    For c = 0 To rbcType.UBound
        If rbcType(c).Value = True Then
            ilRadioTypeSet = c
            Exit For
        End If
    Next c
    If ilRadioTypeSet > -1 Then
        If ilRadioTypeSet = 4 Then
            imFromCallRadioButton = True
        End If
        rbcType_Click (c)
    Else
        mSetCommands
    End If
    imFromCallRadioButton = False
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mPopulate                       *
'*                                                     *
'*             Created:6/28/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Populate the selection combo   *
'*                      box                            *
'*                                                     *
'*******************************************************
Private Sub mPopViewList(ilType As Integer)
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  ilRet                                                                                 *
'******************************************************************************************
'
'   mPopViewList
'   Where:
'         ilType(I)- 0=Contract to be cleared before invoives allowed
'                    1=End of contract
'                    2 = emailer error messages
'
    Dim mItem As ListItem
    Dim llLoop As Long
    Dim slVehName As String
    Dim slStr As String
    
    If ilType = 0 Then
        lbcView.ListItems.Clear
        slVehName = ""
        For llLoop = LBound(tgNotMarkComplete) To UBound(tgNotMarkComplete) - 1 Step 1
            Set mItem = lbcView.ListItems.Add()
            If StrComp(Trim$(tgNotMarkComplete(llLoop).sVehName), slVehName, vbTextCompare) <> 0 Then
                mItem.Text = ""
                mItem.SubItems(1) = Trim$(tgNotMarkComplete(llLoop).sVehName)
                slVehName = Trim$(tgNotMarkComplete(llLoop).sVehName)
            End If
            If tgNotMarkComplete(llLoop).iGameNo > 0 Then
                slStr = "Event #: " & Trim$(str$(tgNotMarkComplete(llLoop).iGameNo)) & " @ "
            Else
                slStr = ""
            End If
            slStr = slStr & tgNotMarkComplete(llLoop).sDate
            mItem.SubItems(2) = slStr
            mItem.SubItems(3) = llLoop
        Next llLoop
    ElseIf ilType = 1 Then
        If UBound(tmViewListInfo) > 0 Then
            gLogMsg "Invoice Messages", "InvoiceMsgInfo.Txt", True
            mSetViewListColumnWidth 1
            For llLoop = 0 To UBound(tmViewListInfo) - 1 Step 1
                Set mItem = lbcView.ListItems.Add()
                mItem.Text = ""
                If tmViewListInfo(llLoop).lContrNo > 0 Then
                    mItem.SubItems(1) = Trim$(str$(tmViewListInfo(llLoop).lContrNo))
                    mItem.SubItems(2) = Trim$(tmViewListInfo(llLoop).sErrMsg)
                    mItem.SubItems(3) = llLoop
                    gLogMsg "Contract " & Trim$(str$(tmViewListInfo(llLoop).lContrNo)) & " Message: " & Trim$(tmViewListInfo(llLoop).sErrMsg), "InvoiceMsgInfo.Txt", False
                Else                '12-15-16 entries without contract # represent bad email address for pdf
                    mItem.SubItems(2) = Trim$(tmViewListInfo(llLoop).sErrMsg)
                    mItem.SubItems(3) = llLoop
                    gLogMsg "Message: " & Trim$(tmViewListInfo(llLoop).sErrMsg), "InvoiceMsgInfo.Txt", False
                End If
            Next llLoop
            lbcView.Visible = True
            lbcView.ZOrder (0)
            lbcView.Height = 3000
            lbcView.Top = (Me.ScaleHeight - lbcView.Height) / 2
            lbcView.Left = (Me.ScaleWidth - lbcView.Width) / 2
        End If
    End If
    Exit Sub
End Sub

Private Sub mSetViewListColumnWidth(ilType As Integer)
'   Where:
'         ilType(I)- 0=Contract to be cleared before invoives allowed
'                    1=End of contract messages
'
    Dim ilNoColumns As Integer
    Dim ilCol As Integer
    Dim llWidth As Long

    'JW Fix lbcView, add a way to close listview
    ilNoColumns = 5
    If ilType = 0 Then
        lbcView.ColumnHeaders.Item(1).Width = 0
        lbcView.ColumnHeaders.Item(2).Text = "Vehicle Name"
        lbcView.ColumnHeaders.Item(2).Width = (2 * lbcView.Width) / 3  'Vehicle
        lbcView.ColumnHeaders.Item(4).Width = 0
        
        'JW Fix lbcView, add a way to close listview
        If lbcView.ColumnHeaders.Count = 4 Then
            lbcView.ColumnHeaders.Add 5, "Close", "X", 100
        End If
        
        'For ilCol = 1 To 4 Step 1
        For ilCol = 1 To 5 Step 1
            If ilCol <> 3 Then
                llWidth = llWidth + lbcView.ColumnHeaders.Item(ilCol).Width
            End If
        Next ilCol
        '150 was used to get scroll with correct
        lbcView.ColumnHeaders.Item(3).Text = "Dates"
        lbcView.ColumnHeaders.Item(3).Width = lbcView.Width - llWidth - GRIDSCROLLWIDTH - ilNoColumns * 120 - 150
    ElseIf ilType = 1 Then
        lbcView.ListItems.Clear
        lbcView.ColumnHeaders.Item(1).Width = 0
        lbcView.ColumnHeaders.Item(3).Text = "Message"
        lbcView.ColumnHeaders.Item(3).Width = (2 * lbcView.Width) / 3  'Vehicle
        lbcView.ColumnHeaders.Item(4).Width = 0
        lbcView.ColumnHeaders.Item(2).Text = "Contract"
        lbcView.ColumnHeaders.Item(3).Width = 2680
        'JW Fix lbcView, add a way to close listview
        If lbcView.ColumnHeaders.Count = 4 Then
            lbcView.ColumnHeaders.Add 5, "Close", "X", 100
        End If
        'For ilCol = 1 To 4 Step 1
        For ilCol = 1 To 5 Step 1
            'If ilCol <> 2 Then
            If ilCol <> 3 Then
                llWidth = llWidth + lbcView.ColumnHeaders.Item(ilCol).Width
            End If
        Next ilCol

        '150 was used to get scroll with correct
        'lbcView.ColumnHeaders.Item(2).Width = lbcView.Width - llWidth - GRIDSCROLLWIDTH - ilNoColumns * 120 - 150
        lbcView.ColumnHeaders.Item(3).Width = lbcView.Width - llWidth - GRIDSCROLLWIDTH - (ilNoColumns * 100) - 450
        lbcView.Visible = True
    End If
End Sub

Private Sub mAddViewListMsg(ilType As Integer, llCntrNo As Long, slMsg As String)
    Dim ilFound As Integer
    Dim ilLoop As Integer

    ilFound = False
    For ilLoop = 0 To UBound(tmViewListInfo) - 1 Step 1
        If (tmViewListInfo(ilLoop).iType = ilType) And (tmViewListInfo(ilLoop).lContrNo = llCntrNo) Then
            ilFound = True
            Exit For
        End If
    Next ilLoop
    If Not ilFound Then
        tmViewListInfo(UBound(tmViewListInfo)).iType = ilType
        tmViewListInfo(UBound(tmViewListInfo)).lContrNo = llCntrNo
        tmViewListInfo(UBound(tmViewListInfo)).sErrMsg = slMsg
        ReDim Preserve tmViewListInfo(0 To UBound(tmViewListInfo) + 1) As VIEWLISTINFO
    End If
End Sub

'Emailer error messages in global array becaus coming from rptselin.frm
'build into array for the view list after generation of invoices complete
Private Sub mAddViewListMsgForPDFEmail()
    Dim ilLoop As Integer
    For ilLoop = LBound(tgInvPDFEmailer_ErrMsg) To UBound(tgInvPDFEmailer_ErrMsg) - 1
        tmViewListInfo(UBound(tmViewListInfo)).iType = 1
        tmViewListInfo(UBound(tmViewListInfo)).lContrNo = 0
        tmViewListInfo(UBound(tmViewListInfo)).sErrMsg = tgInvPDFEmailer_ErrMsg(ilLoop).sMsg
        ReDim Preserve tmViewListInfo(0 To UBound(tmViewListInfo) + 1) As VIEWLISTINFO
    Next ilLoop
End Sub

Private Function mRollbackZeroPurge() As Integer
    Dim ilRet As Integer
    Dim ilCRet As Integer
    Dim ilExtLen As Integer
    Dim ilOffSet As Integer
    Dim llNoRec As Long
    Dim llRecPos As Long
    Dim slDate As String
    Dim slRPRPDate As String
    Dim slNet As String
    Dim slAmount As String
    Dim llUpper As Long
    Dim llLoop As Long
    Dim tlDateTypeBuff As POPDATETYPE   'Type field record
    ReDim tlRvfUnpurge(0 To 0) As RVFUNPURGE

    mRollbackZeroPurge = True
    ilExtLen = Len(tlRvfUnpurge(0))  'Extract operation record size
    llUpper = 0
    llNoRec = gExtNoRec(ilExtLen) 'btrRecords(hlAdf) 'Obtain number of records
    btrExtClear hmPhf   'Clear any previous extend operation
    ilRet = btrGetFirst(hmPhf, tmRvf, imRvfRecLen, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If ilRet = BTRV_ERR_END_OF_FILE Then
        If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
            ilRet = csiHandleValue(0, 7)
        End If
        ilRet = MsgBox("The Rollback of Zero Purge 'Get First' Failed as EOF found" & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
        Exit Function
    Else
        If ilRet <> BTRV_ERR_NONE Then
            If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
                ilRet = csiHandleValue(0, 7)
            End If
            ilRet = MsgBox("The Rollback of Zero Purge 'Get First' Failed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
        End If
    End If
    slAmount = "0.00"
    mRollbackZeroPurge = False
    Call btrExtSetBounds(hmPhf, llNoRec, -1, "UC", "RVFUNPURGEPK", RVFUNPURGEPK) 'Set extract limits (all records)

    gUnpackDate tgSpf.iRPRP(0), tgSpf.iRPRP(1), slRPRPDate
    slDate = gDecOneWeek(slRPRPDate)
    gPackDate slDate, tlDateTypeBuff.iDate0, tlDateTypeBuff.iDate1
    ilOffSet = gFieldOffset("Phf", "phfPurgeDate")
    ilRet = btrExtAddLogicConst(hmPhf, BTRV_KT_DATE, ilOffSet, 4, BTRV_EXT_GT, BTRV_EXT_LAST_TERM, tlDateTypeBuff, 4)
    If ilRet <> BTRV_ERR_NONE Then
        If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
            ilRet = csiHandleValue(0, 7)
        End If
        ilRet = MsgBox("The Rollback of Zero Purge 'Add Logic Constant' operation ailed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
        Exit Function
    End If

    ilOffSet = gFieldOffset("Rvf", "RvfCode")
    ilRet = btrExtAddField(hmPhf, ilOffSet, 4) 'Extract entry date field
    If ilRet <> BTRV_ERR_NONE Then
        If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
            ilRet = csiHandleValue(0, 7)
        End If
        ilRet = MsgBox("The Rollback of Zero Purge 'Add Field' operation ailed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
        Exit Function
    End If
    ilOffSet = gFieldOffset("Rvf", "RvfTranType")
    ilRet = btrExtAddField(hmPhf, ilOffSet, 2) 'Extract transaction type
    If ilRet <> BTRV_ERR_NONE Then
        If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
            ilRet = csiHandleValue(0, 7)
        End If
        ilRet = MsgBox("The Rollback of Zero Purge 'Add Field' operation ailed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
        Exit Function
    End If
    ilOffSet = gFieldOffset("Rvf", "RvfCashTrade")
    ilRet = btrExtAddField(hmPhf, ilOffSet, 1) 'Extract Cash/Trade
    If ilRet <> BTRV_ERR_NONE Then
        If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
            ilRet = csiHandleValue(0, 7)
        End If
        ilRet = MsgBox("The Rollback of Zero Purge 'Add Field' operation ailed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
        Exit Function
    End If
    ilOffSet = gFieldOffset("Rvf", "RvfNet")
    ilRet = btrExtAddField(hmPhf, ilOffSet, 6) 'Extract Cash/Trade
    If ilRet <> BTRV_ERR_NONE Then
        If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
            ilRet = csiHandleValue(0, 7)
        End If
        ilRet = MsgBox("The Rollback of Zero Purge 'Add Field' operation ailed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
        Exit Function
    End If
    ilOffSet = gFieldOffset("Rvf", "RvfTax1")
    ilRet = btrExtAddField(hmPhf, ilOffSet, 4) 'Extract entry date field
    If ilRet <> BTRV_ERR_NONE Then
        If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
            ilRet = csiHandleValue(0, 7)
        End If
        ilRet = MsgBox("The Rollback of Zero Purge 'Add Field' operation ailed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
        Exit Function
    End If
    ilOffSet = gFieldOffset("Rvf", "RvfTax2")
    ilRet = btrExtAddField(hmPhf, ilOffSet, 4) 'Extract entry date field
    If ilRet <> BTRV_ERR_NONE Then
        If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
            ilRet = csiHandleValue(0, 7)
        End If
        ilRet = MsgBox("The Rollback of Zero Purge 'Add Field' operation ailed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
        Exit Function
    End If
    ilRet = btrExtGetNext(hmPhf, tlRvfUnpurge(llUpper), ilExtLen, llRecPos)
    If (ilRet <> BTRV_ERR_END_OF_FILE) And (ilRet <> BTRV_ERR_FILTER_LIMIT) Then
        If (ilRet <> BTRV_ERR_NONE) And (ilRet <> BTRV_ERR_REJECT_COUNT) Then
            Exit Function
            If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
                ilRet = csiHandleValue(0, 7)
            End If
            ilRet = MsgBox("The Rollback of Zero Purge 'Ext Get Next' operation Failed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
        End If
        ilExtLen = Len(tlRvfUnpurge(0))  'Extract operation record size
        Do While ilRet = BTRV_ERR_REJECT_COUNT
            ilRet = btrExtGetNext(hmPhf, tlRvfUnpurge(llUpper), ilExtLen, llRecPos)
        Loop
        Do While ilRet = BTRV_ERR_NONE
            If (tlRvfUnpurge(llUpper).sCashTrade = "C") And (tlRvfUnpurge(llUpper).sTranType <> "HI") Then
                gPDNToStr tlRvfUnpurge(llUpper).sNet, 2, slNet
                slAmount = gAddStr(slAmount, slNet)
                slAmount = gAddStr(slAmount, gLongToStrDec(tlRvfUnpurge(llUpper).lTax1, 2))
                slAmount = gAddStr(slAmount, gLongToStrDec(tlRvfUnpurge(llUpper).lTax2, 2))
            End If
            If ((tlRvfUnpurge(llUpper).sCashTrade = "C") Or (tlRvfUnpurge(llUpper).sCashTrade = "T")) And (tlRvfUnpurge(llUpper).sTranType <> "HI") Then
                llUpper = llUpper + 1
                ReDim Preserve tlRvfUnpurge(0 To llUpper) As RVFUNPURGE
            End If
            ilRet = btrExtGetNext(hmPhf, tlRvfUnpurge(llUpper), ilExtLen, llRecPos)
            Do While ilRet = BTRV_ERR_REJECT_COUNT
                ilRet = btrExtGetNext(hmPhf, tlRvfUnpurge(llUpper), ilExtLen, llRecPos)
            Loop
        Loop
        If (gCompNumberStr(slAmount, ".00") <> 0) Then
            ilRet = MsgBox("The Rollback of Zero Purged discontinued because it did not Balance to Zero, Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
            Exit Function
        End If
        'Transfer records from PHF to RVF, Remove purged date
        If llUpper > 0 Then
            ilRet = btrBeginTrans(hmPhf, 1000)
            If ilRet <> BTRV_ERR_NONE Then
                ilRet = MsgBox("The Rollback of Zero Purged Failed because unable to place Pervasive into Restore Mode, Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
                Exit Function
            End If
            For llLoop = 0 To UBound(tlRvfUnpurge) - 1 Step 1
                tmRvfSrchKey2.lCode = tlRvfUnpurge(llLoop).lCode
                ilRet = btrGetEqual(hmPhf, tmRvf, imRvfRecLen, tmRvfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORWRITE)
                If ilRet <> BTRV_ERR_NONE Then
                    If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    ilCRet = btrAbortTrans(hmPhf)
                    ilRet = MsgBox("The Rollback of Zero Purged Failed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
                    Exit Function
                End If
                tmRvf.lCode = 0 'Can't retain code since autoInc installed after phf records created
                gPackDate "", tmRvf.iPurgeDate(0), tmRvf.iPurgeDate(1)
                ilRet = btrInsert(hmRvf, tmRvf, imRvfRecLen, INDEXKEY0)
                If ilRet <> BTRV_ERR_NONE Then
                    If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    ilCRet = btrAbortTrans(hmPhf)
                    ilRet = MsgBox("The Rollback of Zero Purge 'Insert' into RVF Failed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
                    Exit Function
                End If
                Do
                    ilRet = btrDelete(hmPhf)
                    If ilRet = BTRV_ERR_CONFLICT Then
                        tmRvfSrchKey2.lCode = tlRvfUnpurge(llLoop).lCode
                        ilCRet = btrGetEqual(hmPhf, tmRvf, imRvfRecLen, tmRvfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORWRITE)
                        If ilCRet <> BTRV_ERR_NONE Then
                            If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
                                ilRet = csiHandleValue(0, 7)
                            End If
                            ilCRet = btrAbortTrans(hmPhf)
                            ilRet = MsgBox("The Rollback of Zero Purge 'Get Equal' operation Failed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
                            Exit Function
                        End If
                    End If
                Loop While ilRet = BTRV_ERR_CONFLICT
                If ilRet <> BTRV_ERR_NONE Then
                    If (ilRet = 30000) Or (ilRet = 30001) Or (ilRet = 30002) Or (ilRet = 30003) Then
                        ilRet = csiHandleValue(0, 7)
                    End If
                    ilCRet = btrAbortTrans(hmPhf)
                    ilRet = MsgBox("The Rollback of Zero Purge Delete from PHF Failed for Error " & ilRet & ", Undo operation was not performed", vbCritical + vbOKOnly, "Warning")
                    Exit Function
                End If
            Next llLoop
            ilRet = btrEndTrans(hmPhf)
        End If
    End If
    mRollbackZeroPurge = True
End Function

Private Sub mCheckIfMissedChgdToMG()
    Dim llSpecialDateTest As Long
    Dim ilRet As Integer
    
    '7/2/09:  Handle case where spot was set as Missed when invoicing started but is now Scheduled.  Treat as Missed.
    If (tmSdf.sSchStatus = "G") Or (tmSdf.sSchStatus = "O") Then
        If tgSpf.sInvAirOrder = "A" Then
            gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llSpecialDateTest
            If tmChf.sBillCycle = "C" Then
                If (llSpecialDateTest > lmEndCal) Or (llSpecialDateTest < lmStartCal) Then
                    If tmSdf.lCode <> tmSmf.lSdfCode Then
                        tmSmfSrchKey2.lCode = tmSdf.lCode
                        ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    End If
                    tmSdf.sSchStatus = "M"
                    tmSdf.iDate(0) = tmSmf.iMissedDate(0)
                    tmSdf.iDate(1) = tmSmf.iMissedDate(1)
                    tmSdf.iTime(0) = tmSmf.iMissedTime(0)
                    tmSdf.iTime(1) = tmSmf.iMissedTime(1)
                    tmSdf.iVefCode = tmSmf.iOrigSchVef
                    tmSdf.iGameNo = tmSmf.iGameNo
                End If
            ElseIf tmChf.sBillCycle = "W" Then
                If (llSpecialDateTest > lmEndWk) Or (llSpecialDateTest < lmStartWk) Then
                    If tmSdf.lCode <> tmSmf.lSdfCode Then
                        tmSmfSrchKey2.lCode = tmSdf.lCode
                        ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    End If
                    tmSdf.sSchStatus = "M"
                    tmSdf.iDate(0) = tmSmf.iMissedDate(0)
                    tmSdf.iDate(1) = tmSmf.iMissedDate(1)
                    tmSdf.iTime(0) = tmSmf.iMissedTime(0)
                    tmSdf.iTime(1) = tmSmf.iMissedTime(1)
                    tmSdf.iVefCode = tmSmf.iOrigSchVef
                    tmSdf.iGameNo = tmSmf.iGameNo
                End If
            Else
                If (llSpecialDateTest > lmEndStd) Or (llSpecialDateTest < lmStartStd) Then
                    If tmSdf.lCode <> tmSmf.lSdfCode Then
                        tmSmfSrchKey2.lCode = tmSdf.lCode
                        ilRet = btrGetEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
                    End If
                    tmSdf.sSchStatus = "M"
                    tmSdf.iDate(0) = tmSmf.iMissedDate(0)
                    tmSdf.iDate(1) = tmSmf.iMissedDate(1)
                    tmSdf.iTime(0) = tmSmf.iMissedTime(0)
                    tmSdf.iTime(1) = tmSmf.iMissedTime(1)
                    tmSdf.iVefCode = tmSmf.iOrigSchVef
                    tmSdf.iGameNo = tmSmf.iGameNo
                End If
            End If
        End If
    End If
End Sub

Private Sub mInitEDIServices()
    Dim ilLoop As Integer
    For ilLoop = 0 To UBound(tgEDIServiceInfo) - 1 Step 1
        tgEDIServiceInfo(ilLoop).hEDI = -1
        tgEDIServiceInfo(ilLoop).sUsed = "N"
        '4/3/12: Retain totals by service
        tgEDIServiceInfo(ilLoop).iTotalNoInv = 0
        tgEDIServiceInfo(ilLoop).sTotalAired = ".00"
    Next ilLoop
End Sub

Private Sub mAdjEDIDateTime(ilVefCode As Integer, slInDate As String, slInTime As String, ilEDIDay As Integer, slEDIDate As String, slEDITime As String)
    Dim ilTimeAdj As Integer
    Dim ilZone As Integer
    Dim ilVpf As Integer
    Dim slDate As String
    Dim slTime As String
    Dim llTime As Long
    
    If (smInvSpotTimeZone = "E") Or (smInvSpotTimeZone = "C") Or (smInvSpotTimeZone = "M") Or (smInvSpotTimeZone = "P") Then
        ilTimeAdj = 0
        slDate = slInDate
        slTime = slInTime
        ilVpf = gBinarySearchVpf(ilVefCode)
        If ilVpf <> -1 Then
            'For ilZone = 1 To 5 Step 1
            For ilZone = 0 To 4 Step 1
                If Left$(tgVpf(ilVpf).sGZone(ilZone), 1) = smInvSpotTimeZone Then
                    ilTimeAdj = tgVpf(ilVpf).iGLocalAdj(ilZone)
                    Exit For
                End If
            Next ilZone
        End If
        If ilTimeAdj <> 0 Then
            llTime = gTimeToLong(slTime, False) + (CLng(ilTimeAdj) * 3600)
            If llTime < 0 Then
'                llTime = 86400 - llTime
                llTime = 86400 + llTime     '7-17-19  start time adjustment
                slDate = gDecOneDay(slDate)
            ElseIf llTime > 86399 Then
                llTime = llTime - 86400
                slDate = gIncOneDay(slDate)
            End If
            ilEDIDay = gWeekDayStr(slDate) + 1
            'slEDIDate = Trim$(Left$(Format$(slDate, "ddd"), 2) & ", " & slDate)
            'slEDITime = gFormatTimeLong(llTime, "A", "1")
            slEDIDate = Format$(slDate, "yymmdd")
            slEDITime = gFormatTimeLong(llTime, "M", "2")
        End If
    End If
End Sub

Private Function mPostRepBy(tlChf As CHF, tlClf As CLF) As Boolean
    Dim blPostByDateTime As Boolean
    Dim ilVef As Integer
    
    tmChf = tlChf
    blPostByDateTime = mDetermineIfEDIRequired()
    ilVef = gBinarySearchVef(tlClf.iVefCode)
    If Not blPostByDateTime Then
        If (Asc(tgSpf.sUsingFeatures8) And REPBYDT) = REPBYDT Then
            If tgSpf.sPostCalAff = "N" Then
                blPostByDateTime = True
            Else
                If ilVef <> -1 Then
                    If tgMVef(ilVef).iNrfCode > 0 Then
                        blPostByDateTime = True
                    End If
                End If
            End If
        Else
            If ilVef <> -1 Then
                If tgMVef(ilVef).iNrfCode > 0 Then
                    blPostByDateTime = True
                End If
            End If
        End If
    Else
        If (Asc(tgSpf.sUsingFeatures8) And REPBYDT) <> REPBYDT Then
            If ilVef <> -1 Then
                If tgMVef(ilVef).iNrfCode = 0 Then
                    blPostByDateTime = False
                End If
            End If
        End If
    End If
    mPostRepBy = blPostByDateTime
End Function

Private Sub mGenXRndNos(ilRndNo() As Integer)
    Dim ilNumber As Integer
    Dim ilCount As Integer
    Dim ilLoop As Integer
    
    ilCount = UBound(ilRndNo)
    For ilLoop = 0 To UBound(ilRndNo) Step 1
        ilRndNo(ilLoop) = -1
    Next ilLoop
    Do
        ilNumber = Int((ilCount - 0 + 1) * Rnd + 0)
        For ilLoop = 0 To UBound(ilRndNo) Step 1
            If ilRndNo(ilLoop) = ilNumber Then
                Exit For
            End If
            If ilRndNo(ilLoop) = -1 Then
                ilRndNo(ilLoop) = ilNumber
                If ilLoop = UBound(ilRndNo) Then
                    Exit Sub
                End If
                Exit For
            End If
        Next ilLoop
    Loop
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mSortArray                      *
'*                                                     *
'*             Created:4/21/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments:Order array in ascending order  *
'*                     with equal values insert in     *
'*                     random order                    *
'*                                                     *
'*******************************************************
Private Sub mSortArray(ilInArray() As Integer, ilOutArray() As Integer)
'
'   mSortArray slSort, ilInArray, ilOutArray
'   Where:
'       slSort(I)- N=No sorting; No randomizing
'                  R=No sorting; randomize all counts
'                  S=Sorting counts lowest to highest; No randomizing of matched counts
'                  B=Sorting counts lowest to highest; Randomize matching counts
'       ilInArray(I)- The array to be sorted (any entry as -1 will be ignored)
'       ilOutArray(I)- The array of indices into ilInArray so ilInArray is sorted
'
    Dim slSortRnd As String
    Dim ilNextValue As Integer
    Dim ilLoop As Integer
    Dim ilCount As Integer  'Number of values stored into ilOutArray
    Dim ilNoMatches As Integer  'Number of values that are the same
    Dim ilMatchIndex As Integer
    Dim ilLowestValue As Integer
    Dim ilCompact As Integer
    Dim ilDone As Integer   'Flag indicating if sort completed
    Dim ilRnd As Integer    'Set to true for slSort = "R" or "B"
    ReDim ilMatch(0 To UBound(ilInArray)) As Integer    'Index zero ignored
    ReDim ilOutArray(0 To UBound(ilInArray)) As Integer 'Index zero ignored

    slSortRnd = "B"
    ilRnd = True
    ilNextValue = -1
    ilCount = 0
    ilDone = False
    Do
        If igDoEvent Then
            DoEvents
        End If
        ilNoMatches = 0
        ilLowestValue = 32000
        For ilLoop = LBONE To UBound(ilInArray) Step 1
            If (ilInArray(ilLoop) <> -1) And (ilInArray(ilLoop) < 30000) Then
                If (ilInArray(ilLoop) = ilLowestValue) Then
                    ilNoMatches = ilNoMatches + 1
                    ilMatch(ilNoMatches) = ilLoop
                ElseIf (ilInArray(ilLoop) < ilLowestValue) And (ilInArray(ilLoop) > ilNextValue) Then
                    ilNoMatches = 1
                    ilMatch(ilNoMatches) = ilLoop
                    ilLowestValue = ilInArray(ilLoop)
                End If
            End If
        Next ilLoop
        If igDoEvent Then
            DoEvents
        End If
        If ilNoMatches > 0 Then
            Do
                If igDoEvent Then
                    DoEvents
                End If
                If (ilNoMatches > 1) And (ilRnd) Then
                    ilMatchIndex = Int(ilNoMatches * Rnd + 1)
                Else
                    ilMatchIndex = 1
                End If
                ilCount = ilCount + 1
                ilOutArray(ilCount) = ilMatch(ilMatchIndex)
                ilNextValue = ilInArray(ilMatch(ilMatchIndex))
                For ilCompact = ilMatchIndex + 1 To ilNoMatches Step 1
                    ilMatch(ilCompact - 1) = ilMatch(ilCompact)
                Next ilCompact
                ilNoMatches = ilNoMatches - 1
            Loop While ilNoMatches > 0
        Else
            ilDone = True
        End If
    Loop While Not ilDone
    If igDoEvent Then
        DoEvents
    End If
    If ilCount > 0 Then
        ReDim Preserve ilOutArray(0 To ilCount) As Integer
    Else
        ReDim ilOutArray(0 To 1) As Integer
        ilOutArray(1) = -1
    End If
End Sub

Private Sub mSaveDates()
    smSvStartStd = smStartStd
    smSvEndStd = smEndStd
    smSvStartCal = smStartCal
    smSvEndCal = smEndCal
    smSvStartWk = smStartWk
    smSvEndWk = smEndWk
    lmSvStartStd = lmStartStd
    lmSvEndStd = lmEndStd
    lmSvStartCal = lmStartCal
    lmSvEndCal = lmEndCal
    lmSvStartWk = lmStartWk
    lmSvEndWk = lmEndWk
    imSvFullStd = imFullStd
    imSvFullCal = imFullCal
    imSvFullWk = imFullWk
    '12-14-16 determine month and year based on std end date
    sgInvMonthYear = gMonthYearFormat(smEndStd)         'save the month and year generated for pdf filenames
End Sub

Private Sub mClearDates()
    If ckcBillCycle(INVBILLCYCLE_STD).Value = vbUnchecked Then
        smStartStd = ""
        smEndStd = ""
        lmStartStd = 0
        lmEndStd = 0
    End If
    If (ckcBillCycle(INVBILLCYCLE_Calendar).Value = vbUnchecked) Or (Not bmCalBillExist) Then
        smStartCal = ""
        smEndCal = ""
        lmStartCal = 0
        lmEndCal = 0
    End If
    If (ckcBillCycle(INVBILLCYCLE_Week).Value = vbUnchecked) Or (Not bmWeeklyBillExist) Then
        smStartWk = ""
        smEndWk = ""
        lmStartWk = 0
        lmEndWk = 0
    End If
End Sub

Private Sub mRestoreDates()
    smStartStd = smSvStartStd
    smEndStd = smSvEndStd
    smStartCal = smSvStartCal
    smEndCal = smSvEndCal
    smStartWk = smSvStartWk
    smEndWk = smSvEndWk
    lmStartStd = lmSvStartStd
    lmEndStd = lmSvEndStd
    lmStartCal = lmSvStartCal
    lmEndCal = lmSvEndCal
    lmStartWk = lmSvStartWk
    lmEndWk = lmSvEndWk
    imFullStd = imSvFullStd
    imFullCal = imSvFullCal
    imFullWk = imSvFullWk
End Sub

Private Function mCalLastWkCount(ilClfIndex As Integer, llSDate As Long, llEDate As Long, llStartSortIndex As Long, llEndSortIndex As Long) As Integer
    Dim ilRet As Integer
    Dim ilCount As Integer
    Dim llSdf As Long
    Dim slDate As String
    Dim llDate As Long
    
    ilCount = 0
    For llSdf = llStartSortIndex To llEndSortIndex Step 1
        'Bypass Bonus spots
        If InStr(1, tgSortKey(llSdf).sKey, smBlkVefName, vbBinaryCompare) <= 0 Then
            'bypass Open/close spot by checking spot length
            If (tgClfInv(ilClfIndex).ClfRec.iLine = tgSortKey(llSdf).iLineNo) And (tgClfInv(ilClfIndex).ClfRec.iLen = tgSortKey(llSdf).iLen) Then
                'Field 11: If invoicing by air, then field is the air date
                '          If invoicing by order, then field is the order date (aired or missed date)
                ilRet = gParseItem(tgSortKey(llSdf).sKey, 11, "|", slDate)
                llDate = Val(slDate)
                If (llDate >= llSDate) And (llDate <= llEDate) Then
                    If (tgSpf.sInvAirOrder = "S") Or (tgSpf.sInvAirOrder = "O") Then    'Show Order
                        ilCount = ilCount + 1
                    Else    'Show aired
                        'Bypass missed if not billed
                        If (tgSortKey(llSdf).sSchStatus <> "M") Or ((tgSortKey(llSdf).sSchStatus = "M") And (tgSortKey(llSdf).iBillMissed)) Then
                            ilCount = ilCount + 1
                        End If
                    End If
                End If
                
            End If
        End If
    Next llSdf
    mCalLastWkCount = ilCount
End Function

Private Function mCalFirstWkCount(ilClfIndex As Integer, llSDate As Long, llEDate As Long) As Integer
    Dim ilRet As Long
    Dim llDate As Long
    Dim ilCount As Integer
    Dim llTestDate As Long
    
    ilCount = 0
    If (tgClfInv(ilClfIndex).ClfRec.sType = "S") Or (tgClfInv(ilClfIndex).ClfRec.sType = "H") Then
        For llDate = llSDate To llEDate Step 1
            gPackDateLong llDate, tmSdfSrchKey4.iDate(0), tmSdfSrchKey4.iDate(1)
            tmSdfSrchKey4.lChfCode = tgClfInv(ilClfIndex).ClfRec.lChfCode
            ilRet = btrGetGreaterOrEqual(hmSdf, tmSdf, imSdfRecLen, tmSdfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)
            Do While (ilRet = BTRV_ERR_NONE) And (tmSdf.lChfCode = tgClfInv(ilClfIndex).ClfRec.lChfCode)
                If (tgClfInv(ilClfIndex).ClfRec.iLine = tmSdf.iLineNo) Then
                    gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llTestDate
                    If llTestDate > llEDate Then
                        Exit Do
                    End If
                    If (tmSdf.sSpotType <> "X") And (tmSdf.sSpotType <> "O") And (tmSdf.sSpotType <> "C") And (tmSdf.sBill = "Y") Then
                        ilCount = ilCount + 1
                    End If
                End If
                ilRet = btrGetNext(hmSdf, tmSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
        Next llDate
    
        If (tgSpf.sInvAirOrder = "S") Or (tgSpf.sInvAirOrder = "O") Then    'Show Order
            For llDate = llSDate To llEDate Step 1
                gPackDateLong llDate, tmSmfSrchKey4.iMissedDate(0), tmSmfSrchKey4.iMissedDate(1)
                tmSmfSrchKey4.lChfCode = tgClfInv(ilClfIndex).ClfRec.lChfCode
                ilRet = btrGetGreaterOrEqual(hmSmf, tmSmf, imSmfRecLen, tmSmfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)
                Do While (ilRet = BTRV_ERR_NONE) And (tmSmf.lChfCode = tgClfInv(ilClfIndex).ClfRec.lChfCode)
                    If (tgClfInv(ilClfIndex).ClfRec.iLine = tmSmf.iLineNo) Then
                        gUnpackDateLong tmSmf.iMissedDate(0), tmSmf.iMissedDate(1), llTestDate
                        If llTestDate > llEDate Then
                            Exit Do
                        End If
                        ilCount = ilCount + 1
                    End If
                    ilRet = btrGetNext(hmSmf, tmSmf, imSmfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
                Loop
            Next llDate
        End If
    Else        'Package
        For llDate = llSDate To llEDate Step 1
            gPackDateLong llDate, tmSdfSrchKey4.iDate(0), tmSdfSrchKey4.iDate(1)
            tmSdfSrchKey4.lChfCode = tgClfInv(ilClfIndex).ClfRec.lChfCode
            ilRet = btrGetGreaterOrEqual(hmPsf, tmSdf, imSdfRecLen, tmSdfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)
            Do While (ilRet = BTRV_ERR_NONE) And (tmSdf.lChfCode = tgClfInv(ilClfIndex).ClfRec.lChfCode)
                If (tgClfInv(ilClfIndex).ClfRec.iLine = tmSdf.iLineNo) Then
                    gUnpackDateLong tmSdf.iDate(0), tmSdf.iDate(1), llTestDate
                    If llTestDate > llEDate Then
                        Exit Do
                    End If
                    If (tmSdf.sBill = "Y") Then
                        ilCount = ilCount + 1
                    End If
                End If
                ilRet = btrGetNext(hmPsf, tmSdf, imSdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
        Next llDate
    End If
    mCalFirstWkCount = ilCount
End Function

Private Sub mSetGridColumns()
    Dim ilCol As Integer
    Dim llColWidth As Long
    'TTP 10813 - add Salesperson
    grdAirTime.ColWidth(ATSELECTEDINDEX) = 0
    grdAirTime.ColWidth(ATCHFCODEINDEX) = 0
    grdAirTime.ColWidth(ATNAMESORTINDEX) = 0
    grdAirTime.ColWidth(ATSORTINDEX) = 0
    grdAirTime.ColWidth(ATBILLINDEX) = 0
    grdAirTime.ColWidth(ATADVTINDEX) = 0
    grdAirTime.ColWidth(ATSPERSONINDEX) = 1450
    grdAirTime.ColWidth(ATCNTRNOINDEX) = 930 'grdAirTime.Width * 0.12
    grdAirTime.ColWidth(ATCYCLEINDEX) = 960 'grdAirTime.Width * 0.14
    grdAirTime.ColWidth(ATENDDATEINDEX) = 820 ' grdAirTime.Width * 0.12
    
    grdAirTime.ColWidth(ATBILLINDEX) = grdAirTime.Width - GRIDSCROLLWIDTH - 15
    For ilCol = 0 To ATENDDATEINDEX Step 1
        If (ilCol <> ATBILLINDEX) And (ilCol <> ATADVTINDEX) Then
            grdAirTime.ColWidth(ATBILLINDEX) = grdAirTime.ColWidth(ATBILLINDEX) - grdAirTime.ColWidth(ilCol)
        End If
    Next ilCol
    llColWidth = grdAirTime.ColWidth(ATBILLINDEX)
    grdAirTime.ColWidth(ATADVTINDEX) = llColWidth / 2
    grdAirTime.ColWidth(ATBILLINDEX) = llColWidth - grdAirTime.ColWidth(ATADVTINDEX)
    
    'Align columns to left
    gGrid_AlignAllColsLeft grdAirTime
    gGrid_IntegralHeight grdAirTime, fgBoxGridH + 15
    
    If rbcType(INVGEN_Reprint).Value = False Or rbcAdvt(0).Value = True Then
        grdRevenue.ColWidth(EMAILINDEX) = 0
    Else
        If (tgSpfx.iInvExpFeature And INVEXP_SELECTIVEEMAIL) = INVEXP_SELECTIVEEMAIL Then  'Selective reprint only setting is enabled in Site
            grdRevenue.ColWidth(EMAILINDEX) = 560
        End If
    End If
    grdRevenue.ColWidth(AGYINDEX) = grdRevenue.Width - GRIDSCROLLWIDTH - 15
    grdRevenue.ColWidth(SOFFICEINDEX) = 1125 'grdRevenue.Width * 0.12
    grdRevenue.ColWidth(SPERSONINDEX) = 1600
    grdRevenue.ColWidth(CNTRNOINDEX) = 930 ' grdRevenue.Width * 0.1
    grdRevenue.ColWidth(INVNOINDEX) = 930 ' grdRevenue.Width * 0.1
    grdRevenue.ColWidth(CASHTRADEINDEX) = 465 ' grdRevenue.Width * 0.05
    grdRevenue.ColWidth(CYCLEINDEX) = 1015 '1215 'grdRevenue.Width * 0.13
    grdRevenue.ColWidth(TRANDATEINDEX) = 820 ' 1020 ' grdRevenue.Width * 0.11
    
    grdRevenue.ColWidth(SORTINDEX) = 0
    grdRevenue.ColWidth(INDEXCODEINDEX) = 0
    grdRevenue.ColWidth(SELECTEDINDEX) = 0
    grdRevenue.ColWidth(EMAILSELECTEDINDEX) = 0
    
    'Dynamically size Adv and Agy cols
    For ilCol = 0 To TRANDATEINDEX Step 1
        If (ilCol <> AGYINDEX) And (ilCol <> ADVTINDEX) Then
            grdRevenue.ColWidth(AGYINDEX) = grdRevenue.ColWidth(AGYINDEX) - grdRevenue.ColWidth(ilCol)
        End If
    Next ilCol
    llColWidth = grdRevenue.ColWidth(AGYINDEX)
    grdRevenue.ColWidth(AGYINDEX) = llColWidth / 2
    grdRevenue.ColWidth(ADVTINDEX) = llColWidth - grdRevenue.ColWidth(AGYINDEX)
    'Align columns to left
    gGrid_AlignAllColsLeft grdRevenue
    gGrid_IntegralHeight grdRevenue, fgBoxGridH + 15
End Sub

Private Sub mSetGridTitles()
    Dim llCol As Long
    
    grdAirTime.TextMatrix(0, ATBILLINDEX) = "Payee (output order)"
    grdAirTime.TextMatrix(0, ATADVTINDEX) = "Advertiser"
    grdAirTime.TextMatrix(0, ATSPERSONINDEX) = "Salesperson" 'TTP 10813 - add Salesperson
    grdAirTime.TextMatrix(0, ATCNTRNOINDEX) = "Contract"
    grdAirTime.TextMatrix(0, ATCYCLEINDEX) = "Cycle"
    grdAirTime.TextMatrix(0, ATENDDATEINDEX) = "End Date"
    grdAirTime.TextMatrix(0, ATSORTINDEX) = "Sort"
    grdAirTime.TextMatrix(0, ATNAMESORTINDEX) = "NameSort"
    grdAirTime.TextMatrix(0, ATCHFCODEINDEX) = "ChfCode"
    grdAirTime.TextMatrix(0, ATSELECTEDINDEX) = "Selected"

    grdAirTime.Row = 0
    For llCol = ATBILLINDEX To ATENDDATEINDEX Step 1
        grdAirTime.Col = llCol
        grdAirTime.CellBackColor = LIGHTBLUE
    Next llCol
    grdRevenue.TextMatrix(0, EMAILINDEX) = "Email"
    grdRevenue.TextMatrix(0, AGYINDEX) = "Agency"
    grdRevenue.TextMatrix(0, ADVTINDEX) = "Advertiser"
    grdRevenue.TextMatrix(0, SOFFICEINDEX) = "Sales Office"
    grdRevenue.TextMatrix(0, SPERSONINDEX) = "Salesperson"
    grdRevenue.TextMatrix(0, CNTRNOINDEX) = "Contract"
    grdRevenue.TextMatrix(0, INVNOINDEX) = "Invoice #"
    grdRevenue.TextMatrix(0, CASHTRADEINDEX) = "C/T"
    grdRevenue.TextMatrix(0, CYCLEINDEX) = "Cycle"
    grdRevenue.TextMatrix(0, TRANDATEINDEX) = "Date"
    grdRevenue.TextMatrix(0, SORTINDEX) = "Sort"
    grdRevenue.TextMatrix(0, INDEXCODEINDEX) = "ChfCode"
    grdRevenue.TextMatrix(0, SELECTEDINDEX) = "Selected"

    grdRevenue.Row = 0
    'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
    'For llCol = AGYINDEX To TRANDATEINDEX Step 1
    For llCol = EMAILINDEX To TRANDATEINDEX Step 1
        grdRevenue.Col = llCol
        grdRevenue.CellBackColor = LIGHTBLUE
    Next llCol
End Sub

Private Sub mClearAirTimeGrid()
    Dim llRow As Long
    Dim llCol As Long

    'Blank rows within grid
    grdAirTime.RowHeight(0) = fgBoxGridH + 15
    'TTP 10476 - Installment NTR invoice reprint: not all NTR items are being included
    grdAirTime.Redraw = False
    'grdAirTime.Rows = 12
    grdAirTime.rows = 21
    For llRow = grdAirTime.FixedRows To grdAirTime.rows - 1 Step 1
        grdAirTime.RowHeight(llRow) = fgBoxGridH + 15
        For llCol = ATBILLINDEX To ATSELECTEDINDEX Step 1
            grdAirTime.Row = llRow
            grdAirTime.Col = llCol
            If grdAirTime.CellForeColor <> vbBlack Then grdAirTime.CellForeColor = vbBlack
            If grdAirTime.CellBackColor <> vbWhite Then grdAirTime.CellBackColor = vbWhite
            grdAirTime.TextMatrix(llRow, llCol) = ""
        Next llCol
        grdAirTime.RowHeight(llRow) = fgBoxGridH + 15
    Next llRow
    llRow = grdAirTime.FixedRows
    Do
        If llRow >= grdAirTime.rows Then
            grdAirTime.AddItem ""
        End If
        grdAirTime.RowHeight(llRow) = fgBoxGridH + 15
        If grdAirTime.RowPos(llRow) > grdAirTime.Height Then
            Exit Do
        End If
        llRow = llRow + 1
    Loop
    grdAirTime.Redraw = True
End Sub

Private Sub mPaintAirTimeRowColor(llRow As Long)
    Dim llCol As Long

    grdAirTime.Row = llRow
    For llCol = ATBILLINDEX To ATENDDATEINDEX Step 1
        grdAirTime.Col = llCol
        If grdAirTime.TextMatrix(llRow, ATSELECTEDINDEX) = "-1" Then
            grdAirTime.CellBackColor = vbRed
        ElseIf grdAirTime.TextMatrix(llRow, ATSELECTEDINDEX) <> "1" Then
            grdAirTime.CellBackColor = vbWhite
        Else
            grdAirTime.CellBackColor = GRAY    'vbBlue
        End If
    Next llCol

End Sub

Private Sub mAddGrdAirTime(llRow As Long, slNameSort As String, llChfCode As Long, blUnpostedFileOpen As Boolean)
    Dim ilRet As Integer
    Dim ilAdf As Integer
    Dim ilAgf As Integer
    Dim slNotPosted As String
    Dim slMsg As String
    Dim ilSlf As Integer
    slNotPosted = mTestUnposted(llChfCode)
    If slNotPosted <> "" Then
        bmUnpostedVehicleExist = True
        If Not blUnpostedFileOpen Then
            gLogMsgWODT "O", hmUnposted, sgDBPath & "Messages\" & "ContractNotPosted_" & Format(Now, "mmddyyyy") & ".csv"
            gLogMsgWODT "W", hmUnposted, "Contract/Vehicles Not Posted as of " & Format(Now, "m/d/yy") & " " & Format(Now, "h:mm:ssAM/PM")
            If rbcType(INVGEN_Preliminary).Value Then
                gLogMsgWODT "W", hmUnposted, "Generating Preliminary Invoices"
            ElseIf rbcType(INVGEN_Final).Value Then
                gLogMsgWODT "W", hmUnposted, "Generating Final Invoices"
            End If
            gLogMsgWODT "W", hmUnposted, "Contract #, Advertiser, Vehicle(s)"
            blUnpostedFileOpen = True
        End If
        tmChf = tgChfInv
        ilAdf = gBinarySearchAdf(tgChfInv.iAdfCode)
        If ilAdf <> -1 Then
            slMsg = tgChfInv.lCntrNo & ", " & """" & Trim$(tgCommAdf(ilAdf).sName) & """"
        Else
            slMsg = tgChfInv.lCntrNo & ", adfCode = " & tgChfInv.iAdfCode
        End If
        gLogMsgWODT "W", hmUnposted, slMsg & ", " & slNotPosted
        Exit Sub
    End If
    
    tmChfSrchKey.lCode = llChfCode
    ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
    If ilRet = BTRV_ERR_NONE Then
        If llRow >= grdAirTime.rows Then
            grdAirTime.AddItem ""
        End If
        grdAirTime.RowHeight(llRow) = fgBoxGridH + 15
        If tmChf.iAgfCode > 0 Then
            ilAgf = gBinarySearchAgf(tmChf.iAgfCode)
            If ilAgf <> -1 Then
                grdAirTime.TextMatrix(llRow, ATBILLINDEX) = Trim$(tgCommAgf(ilAgf).sName) & "/" & Trim$(tgCommAgf(ilAgf).sCityID)
            End If
        Else
            grdAirTime.TextMatrix(llRow, ATBILLINDEX) = "Direct"
        End If
        ilAdf = gBinarySearchAdf(tmChf.iAdfCode)
        If ilAdf <> -1 Then
            grdAirTime.TextMatrix(llRow, ATADVTINDEX) = Trim$(tgCommAdf(ilAdf).sName)
        End If
        'TTP 10813 - PDF invoice - selective invoice feature checklist
        ilSlf = gBinarySearchSlf(tmChf.iSlfCode(0))
        If ilSlf <> -1 Then
            grdAirTime.TextMatrix(llRow, ATSPERSONINDEX) = Trim$(tgMSlf(ilSlf).sLastName) & ", " & Trim$(tgMSlf(ilSlf).sFirstName)
        End If
        grdAirTime.TextMatrix(llRow, ATCNTRNOINDEX) = Trim$(str$(tmChf.lCntrNo))
        Select Case tmChf.sBillCycle
            Case "C"
                grdAirTime.TextMatrix(llRow, ATCYCLEINDEX) = "Calendar"
            Case "W"
                grdAirTime.TextMatrix(llRow, ATCYCLEINDEX) = "Weekly"
            Case Else
                grdAirTime.TextMatrix(llRow, ATCYCLEINDEX) = "Std B'cast"
        End Select
        grdAirTime.TextMatrix(llRow, ATNAMESORTINDEX) = Trim$(slNameSort)
        grdAirTime.TextMatrix(llRow, ATCHFCODEINDEX) = Trim$(str$(llChfCode))
        llRow = llRow + 1
    End If
End Sub

Private Sub grdAirtime_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim llRow As Long
    Dim llCol As Long
    Dim ilFound As Integer
    Dim llHeight As Long

    For llRow = 0 To grdAirTime.FixedRows - 1 Step 1
        llHeight = grdAirTime.RowHeight(llRow)
    Next llRow
    'grdAirTime.ToolTipText = ""
    If Y <= llHeight Then
        grdAirTime.ToolTipText = ""
        Exit Sub
    End If
    ilFound = gGrid_GetRowCol(grdAirTime, X, Y, llRow, llCol)
    
    If llCol = imLastCol And llRow = imLastRow Then
        Exit Sub
    End If
    
    grdAirTime.ToolTipText = ""
    imLastCol = llCol
    imLastRow = llRow
    
    grdAirTime.ToolTipText = Trim$(grdAirTime.TextMatrix(grdAirTime.MouseRow, grdAirTime.MouseCol))
End Sub

Private Sub grdAirtime_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  slStr                                                                                 *
'******************************************************************************************
    Dim llRow As Long
    Dim llCurrentRow As Long
    Dim llTopRow As Long
    Dim llCol As Long
    Dim ilFound As Integer

    If Y < grdAirTime.RowHeight(0) Then
        grdAirTime.Col = grdAirTime.MouseCol
        mAirTimeSortCol grdAirTime.Col
        grdAirTime.Row = 0
        grdAirTime.Col = ATCHFCODEINDEX
        Exit Sub
    End If
    ilFound = gGrid_GetRowCol(grdAirTime, X, Y, llCurrentRow, llCol)
    If llCurrentRow < grdAirTime.FixedRows Then
        Exit Sub
    End If
    If grdAirTime.TextMatrix(llCurrentRow, ATSELECTEDINDEX) = "-1" Then
        Exit Sub
    End If
    If llCurrentRow >= grdAirTime.FixedRows Then
        If grdAirTime.TextMatrix(llCurrentRow, ATBILLINDEX) <> "" Then
            grdAirTime.TopRow = lmScrollTop
            llTopRow = grdAirTime.TopRow
            If (Shift And CTRLMASK) > 0 Then
                If grdAirTime.TextMatrix(grdAirTime.Row, ATSELECTEDINDEX) <> "1" Then
                    grdAirTime.TextMatrix(grdAirTime.Row, ATSELECTEDINDEX) = "1"
                Else
                    grdAirTime.TextMatrix(grdAirTime.Row, ATSELECTEDINDEX) = "0"
                End If
                mPaintAirTimeRowColor grdAirTime.Row
            Else
                For llRow = grdAirTime.FixedRows To grdAirTime.rows - 1 Step 1
                    If (grdAirTime.TextMatrix(llRow, ATBILLINDEX) <> "") Then
                        If (grdAirTime.TextMatrix(llRow, ATSELECTEDINDEX) <> "-1") Then
                            grdAirTime.TextMatrix(llRow, ATSELECTEDINDEX) = "0"
                            If (lmLastClickedRow = -1) Or ((Shift And SHIFTMASK) <= 0) Then
                                If llRow = llCurrentRow Then
                                    grdAirTime.TextMatrix(llRow, ATSELECTEDINDEX) = "1"
                                Else
                                    grdAirTime.TextMatrix(llRow, ATSELECTEDINDEX) = "0"
                                End If
                            ElseIf lmLastClickedRow < llCurrentRow Then
                                If (llRow >= lmLastClickedRow) And (llRow <= llCurrentRow) Then
                                    grdAirTime.TextMatrix(llRow, ATSELECTEDINDEX) = "1"
                                End If
                            Else
                                If (llRow >= llCurrentRow) And (llRow <= lmLastClickedRow) Then
                                    grdAirTime.TextMatrix(llRow, ATSELECTEDINDEX) = "1"
                                End If
                            End If
                        End If
                        mPaintAirTimeRowColor llRow
                    End If
                Next llRow
                grdAirTime.TopRow = llTopRow
                grdAirTime.Row = llCurrentRow
            End If
            lmLastClickedRow = llCurrentRow
        End If
    End If
End Sub

Private Sub grdAirtime_Scroll()
    lmScrollTop = grdAirTime.TopRow
End Sub

Private Sub grdAirtime_KeyDown(KeyCode As Integer, Shift As Integer)
    If (Shift And CTRLMASK) > 0 Then
        imCtrlKey = True
    Else
        imCtrlKey = False
    End If
    If (Shift And SHIFTMASK) > 0 Then
        imShiftKey = True
    Else
        imShiftKey = False
    End If
End Sub

Private Sub grdAirtime_KeyUp(KeyCode As Integer, Shift As Integer)
    imCtrlKey = False
    imShiftKey = False
End Sub

Private Sub mAirTimeSortCol(ilCol As Integer)
    Dim llRow As Long
    Dim slStr As String
    Dim slSort As String
    Dim ilPos As Integer
    Dim slRow As String
    Dim slDate As String
    Dim slTime As String
    Dim slDays As String
    Dim slHours As String
    Dim slMinutes As String
    Dim ilChar As Integer

    For llRow = grdAirTime.FixedRows To grdAirTime.rows - 1 Step 1
        slStr = Trim$(grdAirTime.TextMatrix(llRow, ATBILLINDEX))
        If slStr <> "" Then
            If ilCol = ATBILLINDEX Then
                slSort = grdAirTime.TextMatrix(llRow, ATNAMESORTINDEX)
            ElseIf (ilCol = ATENDDATEINDEX) Then
                slStr = grdAirTime.TextMatrix(llRow, ATENDDATEINDEX)
                If slStr <> "" Then
                    slSort = gDateValue(slStr)
                    Do While Len(slSort) < 6
                        slSort = "0" & slSort
                    Loop
                Else
                    slSort = "999999"
                End If
            Else
                slSort = UCase$(Trim$(grdAirTime.TextMatrix(llRow, ilCol)))
            End If
            slStr = grdAirTime.TextMatrix(llRow, ATSORTINDEX)
            ilPos = InStr(1, slStr, "|", vbTextCompare)
            If ilPos > 1 Then
                slStr = Left$(slStr, ilPos - 1)
            End If
            If (ilCol <> imLastAirTimeColSorted) Or ((ilCol = imLastAirTimeColSorted) And (imLastAirTimeSort = flexSortStringNoCaseDescending)) Then
                'Ascending
                slRow = Trim$(str$(llRow))
                Do While Len(slRow) < 4
                    slRow = "0" & slRow
                Loop
                grdAirTime.TextMatrix(llRow, ATSORTINDEX) = slSort & "|" & slRow
            Else
                'Descending
                slRow = Trim$(str$(llRow))
                Do While Len(slRow) < 4
                    slRow = "0" & slRow
                Loop
                grdAirTime.TextMatrix(llRow, ATSORTINDEX) = slSort & "|" & slRow
            End If
        End If
    Next llRow
    If ilCol = imLastAirTimeColSorted Then
        imLastAirTimeColSorted = ATSORTINDEX
    Else
        imLastAirTimeColSorted = -1
        imLastAirTimeSort = -1
    End If
    gGrid_SortByCol grdAirTime, ATBILLINDEX, ATSORTINDEX, imLastAirTimeColSorted, imLastAirTimeSort
    imLastAirTimeColSorted = ilCol
End Sub

Private Sub mClearRevenueGrid()
    Dim llRow As Long
    Dim llCol As Long
    'Blank rows within grid
    grdRevenue.RowHeight(0) = fgBoxGridH + 15
    'TTP 10476 - Installment NTR invoice reprint: not all NTR items are being included
    'Fix issue per Jason Email: v81 TTP 10813 on Thu 1/11/24 3:38 PM
    'grdRevenue.Visible = False
    grdRevenue.Redraw = False
    'grdRevenue.Rows = 14
    grdRevenue.rows = 21
    For llRow = grdRevenue.FixedRows To grdRevenue.rows - 1 Step 1
        grdRevenue.RowHeight(llRow) = fgBoxGridH + 15
        If grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) = "-1" Then
            grdRevenue.Row = llRow
            grdRevenue.Col = EMAILINDEX
            If grdRevenue.CellForeColor <> vbBlack Then grdRevenue.CellForeColor = vbBlack
        End If
        'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
        If grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) <> "0" Or grdRevenue.TextMatrix(llRow, CNTRNOINDEX) = "" Then
            grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) = "0"
            grdRevenue.TextMatrix(llRow, EMAILINDEX) = ""
        End If
        For llCol = AGYINDEX To SELECTEDINDEX Step 1
            grdRevenue.Row = llRow
            grdRevenue.Col = llCol
            If grdRevenue.CellForeColor <> vbBlack Then grdRevenue.CellForeColor = vbBlack
            If grdRevenue.CellBackColor <> vbWhite Then grdRevenue.CellBackColor = vbWhite
            grdRevenue.TextMatrix(llRow, llCol) = ""
        Next llCol
        grdRevenue.RowHeight(llRow) = fgBoxGridH + 15
    Next llRow
    llRow = grdRevenue.FixedRows
    Do
        If llRow >= grdRevenue.rows Then
            grdRevenue.AddItem ""
        End If
        grdRevenue.RowHeight(llRow) = fgBoxGridH + 15
        If grdRevenue.RowPos(llRow) > grdRevenue.Height Then
            Exit Do
        End If
        llRow = llRow + 1
    Loop
    grdRevenue.TopRow = 1
    grdRevenue.Redraw = True
    'Fix issue per Jason Email: v81 TTP 10813 on Thu 1/11/24 3:38 PM
    'grdRevenue.Visible = True
End Sub

Private Sub mPaintRevenueRowColor(llRow As Long)
    Dim llCol As Long
    Dim llScOl As Long
    Dim llECol As Long

    grdRevenue.Row = llRow
    'grdRevenue.Visible = False
    For llCol = AGYINDEX To TRANDATEINDEX Step 1
        grdRevenue.Col = llCol
        If grdRevenue.TextMatrix(llRow, SELECTEDINDEX) <> "1" Then
            grdRevenue.CellBackColor = vbWhite
            If grdRevenue.TextMatrix(grdRevenue.Row, CNTRNOINDEX) <> "" Then 'Has a Contract
                If grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) <> "-1" Or grdRevenue.TextMatrix(llRow, CNTRNOINDEX) = "" Then
                    grdRevenue.TextMatrix(llRow, EMAILINDEX) = ""
                    grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) = "0"
                End If
            End If
        Else
            grdRevenue.CellBackColor = GRAY    'vbBlue
        End If
    Next llCol
    'grdRevenue.Visible = True
End Sub

Private Sub grdRevenue_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim llRow As Long
    Dim llCol As Long
    Dim ilFound As Integer
    Dim llHeight As Long

    '5/19/16: TTP 8020
    On Error GoTo ErrExit:
    'grdRevenue.ToolTipText = ""
    For llRow = 0 To grdRevenue.FixedRows - 1 Step 1
        llHeight = grdRevenue.RowHeight(llRow)
    Next llRow
    'grdRevenue.ToolTipText = ""
    If Y <= llHeight Then
        grdRevenue.ToolTipText = ""
        Exit Sub
    End If
    ilFound = gGrid_GetRowCol(grdRevenue, X, Y, llRow, llCol)
    If llCol = imLastCol And llRow = imLastRow Then
        Exit Sub
    End If
    
    grdRevenue.ToolTipText = ""
    imLastCol = llCol
    imLastRow = llRow
    'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
    If llCol > EMAILINDEX Then
        grdRevenue.ToolTipText = Trim$(grdRevenue.TextMatrix(grdRevenue.MouseRow, grdRevenue.MouseCol))
        If (rbcType(INVGEN_Undo).Value) And (grdRevenue.TextMatrix(grdRevenue.MouseRow, INDEXCODEINDEX) <> "") Then
            llRow = grdRevenue.TextMatrix(grdRevenue.MouseRow, INDEXCODEINDEX)
            If Not tmRPSelInfo(llRow).iSelAllowed Then
                lacUndoReason.Caption = Trim$(tmRPSelInfo(llRow).sReason) & ", Contract " & tmRPSelInfo(llRow).lCntrNo
                lacUndoReason.Visible = True
                Exit Sub
            End If
        End If
    End If
ErrExit:
    lacUndoReason.Visible = False
End Sub

Private Sub grdRevenue_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
'******************************************************************************************
'* Note: VBC id'd the following unreferenced items and handled them as described:         *
'*                                                                                        *
'* Local Variables (Removed)                                                              *
'*  slStr                                                                                 *
'******************************************************************************************
    Dim llRow As Long
    Dim llCurrentRow As Long
    Dim llTopRow As Long
    Dim llCol As Long
    Dim ilFound As Integer
    Dim ilAdvt As Integer
    Dim llCntrNo As Long
    Dim llInvNo As Long
    Dim slSelected As String
    
    If Y < grdRevenue.RowHeight(0) Then
        grdRevenue.Col = grdRevenue.MouseCol
        mRevenueSortCol grdRevenue.Col
        grdRevenue.Row = 0
        grdRevenue.Col = INDEXCODEINDEX
        Exit Sub
    End If
    ilFound = gGrid_GetRowCol(grdRevenue, X, Y, llCurrentRow, llCol)
    If llCurrentRow < grdRevenue.FixedRows Then
        Exit Sub
    End If
    frcInvoice.Enabled = False 'JW Fix Archive click after emailing invoices
    grdRevenue.Redraw = False 'JW Performance fix
    If llCurrentRow >= grdRevenue.FixedRows Then
        If grdRevenue.TextMatrix(llCurrentRow, ADVTINDEX) <> "" Then
            If rbcType(INVGEN_Undo).Value Then
                ilAdvt = grdRevenue.TextMatrix(llCurrentRow, INDEXCODEINDEX)
                If (tmRPSelInfo(ilAdvt).iSelAllowed) And ((imRollbackReconcRequired = 0) Or (imRollbackReconcRequired > 2)) Then
                    llCntrNo = tmRPSelInfo(ilAdvt).lCntrNo
                    llInvNo = tmRPSelInfo(ilAdvt).lInvNo
                    slSelected = grdRevenue.TextMatrix(llCurrentRow, SELECTEDINDEX)
                    If slSelected = "1" Then
                        slSelected = "0"
                    Else
                        slSelected = "1"
                    End If
                    For llRow = grdRevenue.FixedRows To grdRevenue.rows - 1 Step 1
                        If (Val(grdRevenue.TextMatrix(llRow, CNTRNOINDEX)) = llCntrNo) And (Val(grdRevenue.TextMatrix(llRow, INVNOINDEX)) = llInvNo) Then
                            ilAdvt = grdRevenue.TextMatrix(llRow, INDEXCODEINDEX)
                            If (tmRPSelInfo(ilAdvt).iSelAllowed) Then
                                grdRevenue.TextMatrix(llRow, SELECTEDINDEX) = slSelected
                            Else
                                grdRevenue.TextMatrix(llRow, SELECTEDINDEX) = "0"
                            End If
                            mPaintRevenueRowColor llRow
                        End If
                    Next llRow
                Else
                    grdRevenue.TextMatrix(llCurrentRow, SELECTEDINDEX) = "0"
                    mPaintRevenueRowColor llCurrentRow
                End If
            Else
                grdRevenue.TopRow = lmScrollTop
                llTopRow = grdRevenue.TopRow
                If (Shift And CTRLMASK) > 0 Then
                    'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                    If llCol > EMAILINDEX Then
                        If grdRevenue.TextMatrix(grdRevenue.Row, SELECTEDINDEX) <> "1" Then
                            grdRevenue.TextMatrix(grdRevenue.Row, SELECTEDINDEX) = "1"
                        Else
                            grdRevenue.TextMatrix(grdRevenue.Row, SELECTEDINDEX) = "0"
                        End If
                        mPaintRevenueRowColor grdRevenue.Row
                    End If
                    'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
                    If (tgSpfx.iInvExpFeature And INVEXP_SELECTIVEEMAIL) = INVEXP_SELECTIVEEMAIL Then  'Selective reprint only setting is enabled in Site
                        If llCol = EMAILINDEX Then
                            If grdRevenue.TextMatrix(grdRevenue.Row, CNTRNOINDEX) <> "" Then 'Has a Contract
                                'Handle Toggle Email On/off (Single Select)
                                If grdRevenue.TextMatrix(grdRevenue.Row, EMAILSELECTEDINDEX) <> "-1" And grdRevenue.TextMatrix(llCurrentRow, EMAILSELECTEDINDEX) <> "1" Then
                                    grdRevenue.Col = EMAILINDEX
                                    grdRevenue.CellFontName = "Monotype Sorts"
                                    grdRevenue.TextMatrix(grdRevenue.Row, EMAILINDEX) = "4"
                                    grdRevenue.TextMatrix(grdRevenue.Row, EMAILSELECTEDINDEX) = "1"
                                    If grdRevenue.TextMatrix(grdRevenue.Row, SELECTEDINDEX) <> "1" Then
                                        grdRevenue.TextMatrix(grdRevenue.Row, SELECTEDINDEX) = "1"
                                        mPaintRevenueRowColor grdRevenue.Row
                                    End If
                                Else
                                    If grdRevenue.TextMatrix(grdRevenue.Row, EMAILSELECTEDINDEX) = "1" Then
                                        grdRevenue.Col = EMAILINDEX
                                        grdRevenue.TextMatrix(grdRevenue.Row, EMAILINDEX) = ""
                                        grdRevenue.TextMatrix(grdRevenue.Row, EMAILSELECTEDINDEX) = "0"
                                    End If
                                End If
                            End If
                        End If
                    End If
                Else
                    'Selected Range
                    For llRow = grdRevenue.FixedRows To grdRevenue.rows - 1 Step 1
                        If grdRevenue.TextMatrix(llRow, ADVTINDEX) <> "" Then
                            'grdRevenue.TextMatrix(llRow, SELECTEDINDEX) = "0"
                            If (lmLastClickedRow = -1) Or ((Shift And SHIFTMASK) <= 0) Then
                                If llRow = llCurrentRow Then
                                    grdRevenue.TextMatrix(llRow, SELECTEDINDEX) = "1"
                                    mPaintRevenueRowColor llRow
                                    If llCol = EMAILINDEX Then
                                        If grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) <> "-1" Then
                                            grdRevenue.Col = EMAILINDEX
                                            grdRevenue.Row = llRow
                                            grdRevenue.CellFontName = "Monotype Sorts"
                                            grdRevenue.TextMatrix(llRow, EMAILINDEX) = "4"
                                            grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) = "1"
                                        End If
                                    End If
                                Else
                                    grdRevenue.TextMatrix(llRow, SELECTEDINDEX) = "0"
                                    mPaintRevenueRowColor llRow
                                    If grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) = "1" Then
                                        grdRevenue.TextMatrix(llRow, EMAILINDEX) = ""
                                        grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) = "0"
                                    End If
                                End If
                            ElseIf lmLastClickedRow < llCurrentRow Then
                                If (llRow >= lmLastClickedRow) And (llRow <= llCurrentRow) Then
                                    grdRevenue.TextMatrix(llRow, SELECTEDINDEX) = "1"
                                    mPaintRevenueRowColor llRow
                                    If llCol = EMAILINDEX Then
                                        If grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) <> "-1" Then
                                            grdRevenue.Col = EMAILINDEX
                                            grdRevenue.Row = llRow
                                            grdRevenue.CellFontName = "Monotype Sorts"
                                            grdRevenue.TextMatrix(llRow, EMAILINDEX) = "4"
                                            grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) = "1"
                                        End If
                                    End If
                                End If
                            Else
                                If (llRow >= llCurrentRow) And (llRow <= lmLastClickedRow) Then
                                    grdRevenue.TextMatrix(llRow, SELECTEDINDEX) = "1"
                                    mPaintRevenueRowColor llRow
                                    If llCol = EMAILINDEX Then
                                        If grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) <> "-1" Then
                                            grdRevenue.Col = EMAILINDEX
                                            grdRevenue.Row = llRow
                                            grdRevenue.CellFontName = "Monotype Sorts"
                                            grdRevenue.TextMatrix(llRow, EMAILINDEX) = "4"
                                            grdRevenue.TextMatrix(llRow, EMAILSELECTEDINDEX) = "1"
                                        End If
                                    End If
                                End If
                            End If
                            
                        End If
                    Next llRow
                    grdRevenue.TopRow = llTopRow
                    grdRevenue.Row = llCurrentRow
                End If
                lmLastClickedRow = llCurrentRow
            End If
        End If
    End If
    grdRevenue.Redraw = True 'JW Performance fix
    frcInvoice.Enabled = True 'JW Fix Archive click after emailing invoices
End Sub

Private Sub grdRevenue_Scroll()
    lmScrollTop = grdRevenue.TopRow
End Sub

Private Sub grdRevenue_KeyDown(KeyCode As Integer, Shift As Integer)
    If (Shift And CTRLMASK) > 0 Then
        imCtrlKey = True
    Else
        imCtrlKey = False
    End If
    If (Shift And SHIFTMASK) > 0 Then
        imShiftKey = True
    Else
        imShiftKey = False
    End If
End Sub

Private Sub grdRevenue_KeyUp(KeyCode As Integer, Shift As Integer)
    imCtrlKey = False
    imShiftKey = False
End Sub

Private Sub mRevenueSortCol(ilCol As Integer)
    Dim llRow As Long
    Dim slStr As String
    Dim slSort As String
    Dim ilPos As Integer
    Dim slRow As String
    Dim slDate As String
    Dim slTime As String
    Dim slDays As String
    Dim slHours As String
    Dim slMinutes As String
    Dim ilChar As Integer

    For llRow = grdRevenue.FixedRows To grdRevenue.rows - 1 Step 1
        'Fix RE: v81 TTP 10826 - updated test results Thu 1/18/24 2:18 PM (Issue 2)
        'slStr = Trim$(grdRevenue.TextMatrix(llRow, ATBILLINDEX))
        slStr = Trim$(grdRevenue.TextMatrix(llRow, CNTRNOINDEX))
        If slStr <> "" Then
            If (ilCol = TRANDATEINDEX) Then
                slStr = grdRevenue.TextMatrix(llRow, TRANDATEINDEX)
                If slStr <> "" Then
                    slSort = gDateValue(slStr)
                    Do While Len(slSort) < 6
                        slSort = "0" & slSort
                    Loop
                Else
                    slSort = "999999"
                End If
            Else
                slSort = UCase$(Trim$(grdRevenue.TextMatrix(llRow, ilCol)))
            End If
            slStr = grdRevenue.TextMatrix(llRow, SORTINDEX)
            ilPos = InStr(1, slStr, "|", vbTextCompare)
            If ilPos > 1 Then
                slStr = Left$(slStr, ilPos - 1)
            End If
            If (ilCol <> imLastRevenueColSorted) Or ((ilCol = imLastRevenueColSorted) And (imLastRevenueSort = flexSortStringNoCaseDescending)) Then
                'Ascending
                slRow = Trim$(str$(llRow))
                Do While Len(slRow) < 4
                    slRow = "0" & slRow
                Loop
                grdRevenue.TextMatrix(llRow, SORTINDEX) = slSort & "|" & slRow
            Else
                'Descending
                slRow = Trim$(str$(llRow))
                Do While Len(slRow) < 4
                    slRow = "0" & slRow
                Loop
                grdRevenue.TextMatrix(llRow, SORTINDEX) = slSort & "|" & slRow
            End If
        End If
    Next llRow
    If ilCol = imLastRevenueColSorted Then
        imLastRevenueColSorted = SORTINDEX
    Else
        imLastRevenueColSorted = -1
        imLastRevenueSort = -1
    End If
    gGrid_SortByCol grdRevenue, ADVTINDEX, SORTINDEX, imLastRevenueColSorted, imLastRevenueSort
    imLastRevenueColSorted = ilCol
End Sub

Private Function mUserInPostLog(slUserName As String) As Integer
    Dim llNow As Long
    Dim llDate As Long
    Dim ilRet As Integer
    
    mUserInPostLog = False
    slUserName = ""
    'llNow = gDateValue(Format(gNow(), "m/d/yy"))
    llNow = gDateValue(Format(Now, "m/d/yy"))
    gPackDateLong llNow, tmUafSrchKey3.iStartDate(0), tmUafSrchKey3.iStartDate(1)
    ilRet = btrGetEqual(hmUaf, tmUaf, imUafRecLen, tmUafSrchKey3, INDEXKEY3, BTRV_LOCK_NONE, SETFORREADONLY)
    Do While ilRet = BTRV_ERR_NONE
        gUnpackDateLong tmUaf.iStartDate(0), tmUaf.iStartDate(1), llDate
        If llDate <> llNow Then
            Exit Do
        End If
        If tmUaf.sSystemType = "T" Then
            If tmUaf.sStatus = "I" Then
                If UCase(Trim$(tmUaf.sName)) = "POST LOG" Then
                    tmUrfSrchKey.iCode = tmUaf.iUserCode
                    ilRet = btrGetEqual(hmUrf, tmUrf, imUrfRecLen, tmUrfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)  'Get first record as starting point of extend operation
                    If ilRet = BTRV_ERR_NONE Then
                        If Trim$(tmUrf.sRept) = "" Then
                            slUserName = Trim$(gDecryptField(tmUrf.sName))
                        Else
                            slUserName = Trim$(gDecryptField(tmUrf.sRept))
                        End If
                    End If
                    mUserInPostLog = True
                    Exit Function
                End If
            End If
        End If
        ilRet = btrGetNext(hmUaf, tmUaf, imUafRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
End Function

Private Function mAdjXMidnightDate(slDate As String, slPkLineType As String, blMsgRequired As Boolean, blAddComment52 As Boolean) As String
    blAddComment52 = False
    If (tgSpf.sInvAirOrder <> "O") And (tgSpf.sInvAirOrder <> "S") Then
        If (imXMidHandle = 0) Then
            mAdjXMidnightDate = gIncOneDay(slDate)
        ElseIf (imXMidHandle = 2) Then
            If (tmClf.sType = "H") Then
                If slPkLineType <> "O" Then
                    mAdjXMidnightDate = gIncOneDay(slDate)
                Else
                    mAdjXMidnightDate = slDate
                End If
            Else
                mAdjXMidnightDate = gIncOneDay(slDate)
            End If
        Else
            If tmChf.sBillCycle = "C" Then
                If gDateValue(slDate) = lmEndCal Then
                    'Set Flag to print message
                    If blMsgRequired Then
                        bmAddXMidMessage = True
                        blAddComment52 = True
                    End If
                    mAdjXMidnightDate = slDate
                Else
                    mAdjXMidnightDate = gIncOneDay(slDate)
                End If
            ElseIf tmChf.sBillCycle = "W" Then
                If (gDateValue(slDate) = lmEndWk) And (lmEndWk = gDateValue(gObtainEndStd(smEndWk))) Then
                    'Set Flag to print message
                    If blMsgRequired Then
                        bmAddXMidMessage = True
                        blAddComment52 = True
                    End If
                    mAdjXMidnightDate = slDate
                Else
                    mAdjXMidnightDate = gIncOneDay(slDate)
                End If
            Else
                If gDateValue(slDate) = lmEndStd Then
                    'Set Flag to print message
                    If blMsgRequired Then
                        bmAddXMidMessage = True
                        blAddComment52 = True
                    End If
                    mAdjXMidnightDate = slDate
                Else
                    mAdjXMidnightDate = gIncOneDay(slDate)
                End If
            End If
        End If
    Else
        mAdjXMidnightDate = slDate
    End If
End Function

'9/12/14: Remove EDI records 41 if no spot records 51 added prior to adding the next 41
Private Sub mRemovePriorEDI41WOSpots(ilEDIUpper As Integer, Optional ilEDIFirstLineIndex As Integer = -1)
    If ilEDIUpper - 1 < UBound(smEDIRecords) Then
        Exit Sub
    End If
    If Left(smEDIRecords(ilEDIUpper - 1), 3) = "41;" Then
        If ilEDIFirstLineIndex = ilEDIUpper Then
            ilEDIFirstLineIndex = ilEDIFirstLineIndex - 1
        End If
        ilEDIUpper = ilEDIUpper - 1
        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
        Exit Sub
    End If
    If Left(smEDIRecords(ilEDIUpper - 1), 3) = "42;" Then
        If ilEDIFirstLineIndex = ilEDIUpper - 1 Then
            ilEDIFirstLineIndex = ilEDIFirstLineIndex - 2
        End If
        ilEDIUpper = ilEDIUpper - 2
        ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
    End If
End Sub

Private Function mIncludeMissed(Optional blIncludePostedTest As Boolean = True) As Boolean
    Dim ilLoop As Integer
    Dim llStartDate As Long
    Dim ilRet As Integer
    Dim ilVff As Integer
    
    mIncludeMissed = False
    If tmSdf.sSchStatus = "M" Then
        If (tgSpf.sInvAirOrder = "O") Or (tgSpf.sInvAirOrder = "S") Then
            mIncludeMissed = True
        Else
            For ilLoop = LBound(tgMRMnf) To UBound(tgMRMnf) - 1 Step 1
                If tmSdf.iMnfMissed = tgMRMnf(ilLoop).iCode Then
                    If tgMRMnf(ilLoop).iGroupNo = 2 Then
                        mIncludeMissed = True
                        Exit Function
                    End If
                    Exit For
                End If
            Next ilLoop
            If blIncludePostedTest Then
                If (Asc(tgSaf(0).sFeatures2) And PAYMENTONCOLLECTION) = PAYMENTONCOLLECTION Then 'Payment on Collection
                    mIncludeMissed = True
                End If
            End If
        End If
    End If
End Function

Private Sub mVerifyIfCntrPosted()
    Dim ilChf As Integer
    Dim slNotPosted As String
    Dim llChfCode As Long
    Dim ilAdf As Integer
    Dim hmUnposted As Integer
    Dim slMsg As String
    
    If (smPostLogSource <> "S") And (smPostLogSource <> "T") Then
        Exit Sub
    End If
    If (Not rbcType(INVGEN_Preliminary).Value) And (Not rbcType(INVGEN_Final).Value) Then
        Exit Sub
    End If
    gLogMsgWODT "O", hmUnposted, sgDBPath & "Messages\" & "ContractNotPosted_" & Format(Now, "mmddyyyy") & ".csv"
    gLogMsgWODT "W", hmUnposted, "Contract/Vehicles Not Posted as of " & Format(Now, "m/d/yy") & " " & Format(Now, "h:mm:ssAM/PM")
    If rbcType(INVGEN_Preliminary).Value Then
        gLogMsgWODT "W", hmUnposted, "Generating Preliminary Invoices"
    ElseIf rbcType(INVGEN_Final).Value Then
        gLogMsgWODT "W", hmUnposted, "Generating Final Invoices"
    End If
    gLogMsgWODT "W", hmUnposted, "Contract #, Advertiser, Vehicle(s)"
    For ilChf = 0 To UBound(tgSelSort) - 1 Step 1
        slNotPosted = mTestUnposted(tgSelSort(ilChf).lChfCode)
        If slNotPosted <> "" Then
            tgSelSort(ilChf).iPosted = False
            ilAdf = gBinarySearchAdf(tgChfInv.iAdfCode)
            If ilAdf <> -1 Then
                slMsg = tgChfInv.lCntrNo & ", " & Trim$(tgCommAdf(ilAdf).sName)
            Else
                slMsg = tgChfInv.lCntrNo & ", adfCode = " & tgChfInv.iAdfCode
            End If
            gLogMsgWODT "W", hmUnposted, slMsg & ", " & slNotPosted
        End If
    Next ilChf
    gLogMsgWODT "C", hmUnposted, ""
End Sub

Private Function mTestUnposted(llChfCode As Long) As String
    Dim ilClf As Integer
    Dim ilCff As Integer
    Dim ilAdf As Integer
    Dim ilVff As Integer
    Dim ilVef As Integer
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim ilRet As Integer
    Dim llCffStartDate As Long
    Dim llCffEndDate As Long
    Dim slNotPosted As String
    Dim tlClf As CLF
    
    slNotPosted = ""
    If (smPostLogSource <> "S") And (smPostLogSource <> "T") Then
        Exit Function
    End If
    ilRet = gObtainCntr(hmCHF, hmClf, hmCff, llChfCode, False, tgChfInv, tgClfInv(), tgCffInv())
    If ilRet Then
        If tgChfInv.sBillCycle = "C" Then
            llStartDate = lmStartCal
            llEndDate = lmEndCal
        ElseIf tgChfInv.sBillCycle = "W" Then
            llStartDate = lmStartWk
            llEndDate = lmEndWk
        Else
            llStartDate = lmStartStd
            llEndDate = lmEndStd
        End If
        
        For ilClf = LBound(tgClfInv) To UBound(tgClfInv) - 1 Step 1
            tlClf = tgClfInv(ilClf).ClfRec
            If (tlClf.sType <> "O") And (tlClf.sType <> "A") And (tlClf.sType <> "E") Then
                If (smPostLogSource = "S") Or ((tlClf.sType <> "H") And (smPostLogSource = "T")) Then
                    ilVff = gBinarySearchVff(tlClf.iVefCode)
                    If ilVff <> -1 Then
                        If tgVff(ilVff).sPostLogSource = "S" Then
                            'Dates and if Posted
                            ilCff = tgClfInv(ilClf).iFirstCff
                            Do While ilCff <> -1
                                llCffStartDate = tgCffInv(ilCff).lStartDate
                                llCffEndDate = tgCffInv(ilCff).lEndDate
                                If (llCffStartDate <= llCffEndDate) And (llCffEndDate >= llStartDate) And (llCffStartDate <= llEndDate) Then
                                    'Test if IIHF exist
                                    tmIihfSrchKey2.lChfCode = llChfCode
                                    tmIihfSrchKey2.iVefCode = tlClf.iVefCode
                                    gPackDateLong llStartDate, tmIihfSrchKey2.iInvStartDate(0), tmIihfSrchKey2.iInvStartDate(1)
                                    ilRet = btrGetEqual(hmIihf, tmIihf, imIihfRecLen, tmIihfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)
                                    If ilRet <> BTRV_ERR_NONE Then
                                        ilVef = gBinarySearchVef(tlClf.iVefCode)
                                        If ilVef <> -1 Then
                                            If slNotPosted = "" Then
                                                slNotPosted = Trim$(tgMVef(ilVef).sName)
                                            Else
                                                If InStr(1, slNotPosted, Trim$(tgMVef(ilVef).sName), vbTextCompare) <= 0 Then
                                                    slNotPosted = slNotPosted & ", " & Trim$(tgMVef(ilVef).sName)
                                                End If
                                            End If
                                        Else
                                            If slNotPosted = "" Then
                                                'slNotPosted = "vefCode = " & tgMVef(ilVef).iCode
                                                slNotPosted = "vefCode = " & tlClf.iVefCode
                                            Else
                                                'If InStr(1, slNotPosted, Trim$(str(tgMVef(ilVef).iCode)), vbTextCompare) <= 0 Then
                                                '    slNotPosted = slNotPosted & ", vefCode= " & tgMVef(ilVef).iCode
                                                If InStr(1, slNotPosted, Trim$(str(tlClf.iVefCode)), vbTextCompare) <= 0 Then
                                                    slNotPosted = slNotPosted & ", vefCode= " & tlClf.iVefCode
                                                End If
                                            End If
                                        End If
                                    End If
                                    Exit Do
                                End If
                                ilCff = tgCffInv(ilCff).iNextCff
                            Loop
                        End If
                    End If
                End If
            End If
        Next ilClf
    End If
    mTestUnposted = slNotPosted
End Function

Private Sub mAddApf()
    Dim llLoop As Long
    Dim llInner As Long
    Dim ilRet As Integer
    Dim llStartDate As Long
    Dim llEndDate As Long
    Dim ilLoInx As Integer
    Dim ilHiInx As Integer
    Dim ilVefCode As Integer
    Dim llAcqCost As Long
    Dim blOk As Boolean
    
    If Not rbcType(INVGEN_Final).Value Then
        Exit Sub
    End If
    If (Asc(tgSaf(0).sFeatures2) And PAYMENTONCOLLECTION) <> PAYMENTONCOLLECTION Then 'Payment on Collection
        Exit Sub
    End If
    'Determine order count
    For llLoop = 0 To UBound(tmAcqWithCommInfo) - 1 Step 1
        If (tmAcqWithCommInfo(llLoop).lChfCode > 0) And (tmAcqWithCommInfo(llLoop).lClfCode > 0) Then
            tmAcqWithCommInfo(llLoop).iOrderCount = mDetermineOrderedSpotCount(tmAcqWithCommInfo(llLoop).lChfCode, tmAcqWithCommInfo(llLoop).lClfCode)
        End If
    Next llLoop
    'Combine
    For llLoop = 0 To UBound(tmAcqWithCommInfo) - 1 Step 1
        If (tmAcqWithCommInfo(llLoop).lChfCode > 0) And (tmAcqWithCommInfo(llLoop).lClfCode > 0) Then
            For llInner = llLoop + 1 To UBound(tmAcqWithCommInfo) - 1 Step 1
                If (tmAcqWithCommInfo(llInner).lChfCode > 0) And (tmAcqWithCommInfo(llInner).lClfCode > 0) Then
                    'If (tmAcqWithCommInfo(llLoop).lChfCode = tmAcqWithCommInfo(llInner).lChfCode) And (tmAcqWithCommInfo(llLoop).lClfCode = tmAcqWithCommInfo(llInner).lClfCode) And (tmAcqWithCommInfo(llLoop).iAirVefCode = tmAcqWithCommInfo(llInner).iAirVefCode) And (tmAcqWithCommInfo(llLoop).lAcqCost = tmAcqWithCommInfo(llInner).lAcqCost) Then
                    If (tmAcqWithCommInfo(llLoop).lChfCode = tmAcqWithCommInfo(llInner).lChfCode) And (tmAcqWithCommInfo(llLoop).iAirVefCode = tmAcqWithCommInfo(llInner).iAirVefCode) And (tmAcqWithCommInfo(llLoop).lAcqCost = tmAcqWithCommInfo(llInner).lAcqCost) Then
                        tmAcqWithCommInfo(llLoop).iAirCount = tmAcqWithCommInfo(llLoop).iAirCount + tmAcqWithCommInfo(llInner).iAirCount
                        tmAcqWithCommInfo(llLoop).iOrderCount = tmAcqWithCommInfo(llLoop).iOrderCount + tmAcqWithCommInfo(llInner).iOrderCount
                        tmAcqWithCommInfo(llInner).lChfCode = -1
                    End If
                End If
            Next llInner
        End If
    Next llLoop
    For llLoop = 0 To UBound(tmAcqWithCommInfo) - 1 Step 1
        If tmAcqWithCommInfo(llLoop).lChfCode > 0 Then
            tmChfSrchKey.lCode = tmAcqWithCommInfo(llLoop).lChfCode
            ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
            If tmChf.sBillCycle = "C" Then
                llStartDate = lmStartCal
                llEndDate = lmEndCal
            ElseIf tmChf.sBillCycle = "W" Then
                llStartDate = lmStartWk
                llEndDate = lmEndWk
            Else
                llStartDate = lmStartStd
                llEndDate = lmEndStd
            End If
            ilVefCode = tmAcqWithCommInfo(llLoop).iAirVefCode
            tmApf.lCode = 0
            tmApf.iAgfCode = tmChf.iAgfCode
            tmApf.iAdfCode = tmChf.iAdfCode
            tmApf.lPrfCode = tmAcqWithCommInfo(llLoop).lPrfCode
            tmApf.iSlfCode = tmChf.iSlfCode(0)
            tmApf.lCntrNo = tmChf.lCntrNo
            tmApf.lInvNo = tmAcqWithCommInfo(llLoop).lInvNo
            tmApf.sAgyEst = Trim$(tmChf.sAgyEstNo) & Trim$(tmChf.sTitle)    'tmChf.sAgyEstNo
            tmApf.iMnfItem = tmAcqWithCommInfo(llLoop).iMnfItem
            tmApf.lSbfCode = tmAcqWithCommInfo(llLoop).lSbfCode
            gPackDateLong llEndDate, tmApf.iInvDate(0), tmApf.iInvDate(1)
            tmApf.iOrderSpotCount = tmAcqWithCommInfo(llLoop).iOrderCount
            tmApf.iAiredSpotCount = tmAcqWithCommInfo(llLoop).iAirCount
            tmApf.lAcquisitionCost = tmAcqWithCommInfo(llLoop).lAcqCost
            tmApf.iAcqCommPct = 0
            If (Asc(tgSaf(0).sFeatures2) And ACQUISITIONCOMMISSIONABLE) = ACQUISITIONCOMMISSIONABLE Then 'Acquisition Commissionable then
                'If (tmChf.iPctTrade = 0) And (tmAcqWithCommInfo(llLoop).lClfCode > 0) Then
                If (tmChf.iPctTrade = 0) Then
                    blOk = gGetAcqCommInfoByVehicle(ilVefCode, ilLoInx, ilHiInx)
                    If blOk Then
                        tmApf.iAcqCommPct = gGetEffectiveAcqComm(llEndDate, ilLoInx, ilHiInx)
                    End If
                End If
            End If
            gPackDate "1/1/1970", tmApf.iFullyPaidDate(0), tmApf.iFullyPaidDate(1)
            tmIihfSrchKey2.lChfCode = tmChf.lCode
            tmIihfSrchKey2.iVefCode = ilVefCode
            gPackDateLong llStartDate, tmIihfSrchKey2.iInvStartDate(0), tmIihfSrchKey2.iInvStartDate(1)
            ilRet = btrGetEqual(hmIihf, tmIihf, imIihfRecLen, tmIihfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)
            If ilRet = BTRV_ERR_NONE Then
                tmApf.sStationInvNo = tmIihf.sStnInvoiceNo
                tmApf.sStationCntrNo = tmIihf.sStnContractNo
                If Trim$(tmIihf.sStnEstimateNo) <> "" Then
                    tmApf.sAgyEst = tmIihf.sStnEstimateNo
                End If
            Else
                tmApf.sStationInvNo = ""
                tmApf.sStationCntrNo = ""
            End If
            tmApf.iVefCode = ilVefCode
            tmApf.sUnused = ""
            'Loop on iidf
            ilRet = btrInsert(hmApf, tmApf, imApfRecLen, INDEXKEY0)
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                Print #hmMsg, "mUpdateInv: btrInsert, Apf Error # " & Trim$(str$(ilRet))
            End If
        End If
    Next llLoop
    ReDim tmAcqWithCommInfo(0 To 0) As ACQWITHCOMMINFO
End Sub

Private Sub mBuildAcqWithCommInfo(slType As String, tlRvf As RVF, llAcqCost As Long)
    Dim blFound As Boolean
    Dim llUpper As Long
    Dim llLoop As Long
    Dim ilRet As Integer
    
    If Not rbcType(INVGEN_Final).Value Then
        Exit Sub
    End If
    If (Asc(tgSaf(0).sFeatures2) And PAYMENTONCOLLECTION) <> PAYMENTONCOLLECTION Then 'Payment on Collection
        Exit Sub
    End If
    If slType = "Air" Then
        If tmClf.iVefCode <> tmSdf.iVefCode Then
            Exit Sub
        End If
        If (tmSdf.sSchStatus = "C") Or (tmSdf.sSchStatus = "H") Then
            Exit Sub
        End If
        If tmSdf.sSchStatus = "M" Then
            If Not mIncludeMissed() Then
                Exit Sub
            End If
        End If
        blFound = False
        For llLoop = 0 To UBound(tmAcqWithCommInfo) - 1 Step 1
            If (tmAcqWithCommInfo(llLoop).lChfCode = tmClf.lChfCode) And (tmAcqWithCommInfo(llLoop).lClfCode = tmClf.lCode) Then
                llUpper = llLoop
                blFound = True
                Exit For
            End If
        Next llLoop
        If Not blFound Then
            llUpper = UBound(tmAcqWithCommInfo)
            tmAcqWithCommInfo(llUpper).lChfCode = tmClf.lChfCode
            tmAcqWithCommInfo(llUpper).lClfCode = tmClf.lCode
            tmAcqWithCommInfo(llUpper).iOrderCount = 0
            tmAcqWithCommInfo(llUpper).iAirCount = 0
            tmAcqWithCommInfo(llUpper).iAirVefCode = tmSdf.iVefCode
            tmAcqWithCommInfo(llUpper).iMnfItem = 0
            tmAcqWithCommInfo(llUpper).lSbfCode = 0
            tmAcqWithCommInfo(llUpper).lInvNo = tlRvf.lInvNo
            tmAcqWithCommInfo(llUpper).lPrfCode = tlRvf.lPrfCode
            tmAcqWithCommInfo(llUpper).lAcqCost = tmClf.lAcquisitionCost
            ReDim Preserve tmAcqWithCommInfo(0 To llUpper + 1) As ACQWITHCOMMINFO
        End If
        If (tmSdf.sSchStatus <> "M") Or mIncludeMissed(False) Then
            tmAcqWithCommInfo(llUpper).iAirCount = tmAcqWithCommInfo(llUpper).iAirCount + 1
        End If
    Else
        If (Asc(tgSpf.sOverrideOptions) And SPNTRACQUISITION) <> SPNTRACQUISITION Then
            Exit Sub
        End If
        llUpper = UBound(tmAcqWithCommInfo)
        tmAcqWithCommInfo(llUpper).lChfCode = tmChf.lCode
        tmAcqWithCommInfo(llUpper).lClfCode = 0
        tmAcqWithCommInfo(llUpper).iOrderCount = 0
        tmAcqWithCommInfo(llUpper).iAirCount = 0
        tmAcqWithCommInfo(llUpper).iAirVefCode = tlRvf.iBillVefCode
        tmAcqWithCommInfo(llUpper).iMnfItem = tlRvf.iMnfItem
        tmAcqWithCommInfo(llUpper).lSbfCode = tlRvf.lSbfCode
        tmAcqWithCommInfo(llUpper).lInvNo = tlRvf.lInvNo
        tmAcqWithCommInfo(llUpper).lPrfCode = tlRvf.lPrfCode
        tmSbfSrchKey1.lCode = tlRvf.lSbfCode
        'ilRet = btrGetEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
        tmAcqWithCommInfo(llUpper).lAcqCost = llAcqCost 'tmSbf.lAcquisitionCost
        ReDim Preserve tmAcqWithCommInfo(0 To llUpper + 1) As ACQWITHCOMMINFO
    End If
End Sub

Private Function mDetermineOrderedSpotCount(llChfCode As Long, llClfCode As Long) As Integer
    Dim ilRet As Integer
    Dim llCffStartDate As Long
    Dim llCffEndDate As Long
    Dim ilDay As Integer
    Dim ilNoSpots As Integer
    Dim llDate As Long
    Dim llStartDate As Long
    Dim llEndDate As Long
    
    ilNoSpots = 0
    tmChfSrchKey.lCode = llChfCode
    ilRet = btrGetEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
    If ilRet <> BTRV_ERR_NONE Then
        mDetermineOrderedSpotCount = 0
        Exit Function
    End If
    If tmChf.sBillCycle = "C" Then
        llStartDate = lmStartCal
        llEndDate = lmEndCal
    ElseIf tmChf.sBillCycle = "W" Then
        llStartDate = lmStartWk
        llEndDate = lmEndWk
    Else
        llStartDate = lmStartStd
        llEndDate = lmEndStd
    End If
    tmClfSrchKey2.lCode = llClfCode
    ilRet = btrGetEqual(hmClf, tmClf, imClfRecLen, tmClfSrchKey2, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)
    If ilRet <> BTRV_ERR_NONE Then
        mDetermineOrderedSpotCount = 0
        Exit Function
    End If
    tmCffSrchKey.lChfCode = tmChf.lCode
    tmCffSrchKey.iClfLine = tmClf.iLine
    tmCffSrchKey.iCntRevNo = tmClf.iCntRevNo
    tmCffSrchKey.iPropVer = tmClf.iPropVer
    tmCffSrchKey.iStartDate(0) = 0
    tmCffSrchKey.iStartDate(1) = 0
    ilRet = btrGetGreaterOrEqual(hmCff, tmCff, imCffRecLen, tmCffSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
    Do While (ilRet = BTRV_ERR_NONE) And (tmCff.lChfCode = tmChf.lCode) And (tmCff.iClfLine = tmClf.iLine)
        If (tmCff.iCntRevNo = tmClf.iCntRevNo) And (tmCff.iPropVer = tmClf.iPropVer) And (tmCff.sDelete <> "Y") Then
            gUnpackDateLong tmCff.iStartDate(0), tmCff.iStartDate(1), llCffStartDate    'Week Start date
            gUnpackDateLong tmCff.iEndDate(0), tmCff.iEndDate(1), llCffEndDate    'Week Start date
            If llCffEndDate >= llStartDate Then
                For llDate = llStartDate To llEndDate Step 7
                    If (llDate + 6 >= llCffStartDate) And (llDate <= llCffEndDate) Then
                        If (tmCff.iSpotsWk <> 0) Or (tmCff.iXSpotsWk <> 0) Then 'Weekly
                            ilNoSpots = ilNoSpots + tmCff.iSpotsWk + tmCff.iXSpotsWk
                        Else    'Daily
                            For ilDay = 0 To 6 Step 1
                                If (llDate + ilDay >= llCffStartDate) And (llDate + ilDay <= llCffEndDate) Then
                                    ilNoSpots = ilNoSpots + tmCff.iDay(ilDay)
                                End If
                            Next ilDay
                        End If
                    End If
                Next llDate
            End If
            If llCffStartDate > llEndDate Then
                Exit Do
            End If
        End If
        ilRet = btrGetNext(hmCff, tmCff, imCffRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    mDetermineOrderedSpotCount = ilNoSpots
End Function

Private Function mFormatAirDateColumn(ilVefCode As Integer, slDate As String) As String
    Dim ilVpf As Integer
    
    ilVpf = gBinarySearchVpf(ilVefCode)
    If ilVpf <> -1 Then
        If (Asc(tgVpf(ilVpf).sUsingFeatures2) And INVOICEAIRDATEWO) = INVOICEAIRDATEWO Then
            mFormatAirDateColumn = "w/o " & gObtainPrevMonday(slDate)
            Exit Function
        End If
    End If
    mFormatAirDateColumn = Trim$(Left$(Format$(slDate, "ddd"), 2) & ", " & slDate)
End Function

Private Sub mTestAssg(slPtType As String, llCopyCode As Long, ilRotNo As Integer, ilTestAssg As Integer)
    Dim ilRet As Integer
    Dim ilZone As Integer
    
    If slPtType = "3" Then 'Time zone
        tmTzfSrchKey.lCode = llCopyCode
        ilRet = btrGetEqual(hmTzf, tmTzf, imTzfRecLen, tmTzfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        If ilRet = BTRV_ERR_NONE Then
            If Trim$(tmCrf.sZone) = "" Then 'All zones (note zone copy superseded by all zones will be check when assigning)
                For ilZone = 0 To 5 Step 1
                    If ((Trim$(tmTzf.sZone(ilZone)) = "") Or (StrComp(tmTzf.sZone(ilZone), "Oth", 1) = 0)) And (tmTzf.lCifZone(ilZone) <> 0) Then
                        If tmTzf.iRotNo(ilZone) = tmCrf.iRotNo Then
                            'Zone copy must be Ok because of way rot # assigned
                            ilTestAssg = False
                            Exit For
                        End If
                    End If
                Next ilZone
            Else
                For ilZone = 0 To 5 Step 1
                    If tmTzf.sZone(ilZone) = tmCrf.sZone Then
                        If tmTzf.iRotNo(ilZone) = tmCrf.iRotNo Then
                            ilTestAssg = False
                            Exit For
                        End If
                    End If
                Next ilZone
            End If
        End If
    Else
        If (slPtType = "1") Or (slPtType = "2") Then
            If ilRotNo = tmCrf.iRotNo Then
                ilTestAssg = False
            End If
        End If
    End If
End Sub

Private Function mUpdateAdfAgfSub(ilReturnRet As Integer) As Integer
    Dim ilAgf As Integer
    Dim ilAdf As Integer
    Dim slGross As String
    Dim slNet As String
    Dim slStr As String
    Dim ilRet As Integer
    
    mUpdateAdfAgfSub = True
    ilReturnRet = 0
    If (rbcType(INVGEN_Undo).Value) Or (imPrintRepInv) Then
        'Return
        Exit Function
    End If
    'Update Advertiser and Agency
    For ilAgf = 0 To UBound(tgUpdateAgf) - 1 Step 1
        slGross = gLongToStrDec(tgUpdateAgf(ilAgf).lGross, 2)
        slNet = gLongToStrDec(tgUpdateAgf(ilAgf).lNet, 2)
        Do
            tmAgfSrchKey.iCode = tgUpdateAgf(ilAgf).iCode
            ilRet = btrGetEqual(hmAgf, tmAgf, imAgfRecLen, tmAgfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                ilReturnRet = ilRet
                Screen.MousePointer = vbDefault
                gSetMousePointer grdAirTime, grdRevenue, vbDefault
                ilRet = MsgBox("Update Not Completed, Try Later (Agf GetEqual Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                Screen.MousePointer = vbHourglass
                gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                mUpdateAdfAgfSub = False
            End If
            gPDNToStr tmAgf.sCurrAR, 2, slStr
            slStr = gAddStr(slStr, slNet)
            gStrToPDN slStr, 2, 6, tmAgf.sCurrAR
            gPDNToStr tmAgf.sTotalGross, 2, slStr
            slStr = gAddStr(slStr, slGross)
            gStrToPDN slStr, 2, 6, tmAgf.sTotalGross
            
            '7/5/14: Adjust Unbilled
            gPDNToStr tmAgf.sUnbilled, 2, slStr
            '2/5/16: it whould be using Net, not Gross
            'slStr = gSubStr(slStr, slGross)
            slStr = gSubStr(slStr, slNet)
            gStrToPDN slStr, 2, 6, tmAgf.sUnbilled
            
            tmAgf.iDateLstInv(0) = tgUpdateAgf(ilAgf).iTranDate(0)
            tmAgf.iDateLstInv(1) = tgUpdateAgf(ilAgf).iTranDate(1)
            gPDNToStr tmAgf.sCurrAR, 2, slStr
            gPDNToStr tmAgf.sHiCredit, 2, slGross
            If gCompNumberStr(slStr, slGross) > 0 Then
                gStrToPDN slStr, 2, 6, tmAgf.sHiCredit
            End If
            ilRet = btrUpdate(hmAgf, tmAgf, imAgfRecLen)
        Loop While ilRet = BTRV_ERR_CONFLICT
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            Print #hmMsg, "mUpdateInv: btrUpdate-Point 7, Agf Error # " & Trim$(str$(ilRet))
        End If
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            ilReturnRet = ilRet
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            ilRet = MsgBox("Update Not Completed, Try Later (Agf Update Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
            Screen.MousePointer = vbHourglass
            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
            mUpdateAdfAgfSub = False
            Exit Function
        End If
    Next ilAgf
    For ilAdf = 0 To UBound(tgUpdateAdf) - 1 Step 1
        slGross = gLongToStrDec(tgUpdateAdf(ilAdf).lGross, 2)
        slNet = gLongToStrDec(tgUpdateAdf(ilAdf).lNet, 2)
        Do
            tmAdfSrchKey.iCode = tgUpdateAdf(ilAdf).iCode
            ilRet = btrGetEqual(hmAdf, tmAdf, imAdfRecLen, tmAdfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)   'Get first record as starting point of extend operation
            If ilRet <> BTRV_ERR_NONE Then
                If ilRet >= 30000 Then
                    ilRet = csiHandleValue(0, 7)
                End If
                ilReturnRet = ilRet
                Screen.MousePointer = vbDefault
                gSetMousePointer grdAirTime, grdRevenue, vbDefault
                ilRet = MsgBox("Update Not Completed, Try Later (Adf GetEqual Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
                Screen.MousePointer = vbHourglass
                gSetMousePointer grdAirTime, grdRevenue, vbHourglass
                mUpdateAdfAgfSub = False
                Exit Function
            End If
            'Test if previously updated
            'If (tmAdf.iDateLstInv(0) = tgUpdateAdf(ilAdf).iTranDate(0)) And (tmAdf.iDateLstInv(1) = tgUpdateAdf(ilAdf).iTranDate(1)) Then
            '    Exit Do
            'End If
            gPDNToStr tmAdf.sCurrAR, 2, slStr
            slStr = gAddStr(slStr, slNet)
            gStrToPDN slStr, 2, 6, tmAdf.sCurrAR
            gPDNToStr tmAdf.sTotalGross, 2, slStr
            slStr = gAddStr(slStr, slGross)
            gStrToPDN slStr, 2, 6, tmAdf.sTotalGross
            
            '7/5/14: Adjust Unbilled
            gPDNToStr tmAdf.sUnbilled, 2, slStr
            '2/5/16: it whould be using Net, not Gross
            'slStr = gSubStr(slStr, slGross)
            slStr = gSubStr(slStr, slNet)
            gStrToPDN slStr, 2, 6, tmAdf.sUnbilled
            
            tmAdf.iDateLstInv(0) = tgUpdateAdf(ilAdf).iTranDate(0)
            tmAdf.iDateLstInv(1) = tgUpdateAdf(ilAdf).iTranDate(1)
            gPDNToStr tmAdf.sCurrAR, 2, slStr
            gPDNToStr tmAdf.sHiCredit, 2, slGross
            If gCompNumberStr(slStr, slGross) > 0 Then
                gStrToPDN slStr, 2, 6, tmAdf.sHiCredit
            End If
            ilRet = btrUpdate(hmAdf, tmAdf, imAdfRecLen)
        Loop While ilRet = BTRV_ERR_CONFLICT
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            Print #hmMsg, "mUpdateInv: btrUpdate-Point 8, Adf Error # " & Trim$(str$(ilRet))
        End If
        If ilRet <> BTRV_ERR_NONE Then
            If ilRet >= 30000 Then
                ilRet = csiHandleValue(0, 7)
            End If
            'mUpdateInv = ilRet
            ilReturnRet = ilRet
            'ilRet = btrAbortTrans(hmRvf)
            Screen.MousePointer = vbDefault
            gSetMousePointer grdAirTime, grdRevenue, vbDefault
            ilRet = MsgBox("Update Not Completed, Try Later (Adf Update Error" & str$(ilRet) & ")", vbOKOnly + vbExclamation, "Invoice")
            Screen.MousePointer = vbHourglass
            gSetMousePointer grdAirTime, grdRevenue, vbHourglass
            mUpdateAdfAgfSub = False
            Exit Function
        End If
    Next ilAdf
    ilReturnRet = BTRV_ERR_NONE
    mUpdateAdfAgfSub = True
End Function

Private Sub mCheckChf(llChfCode As Long, llEarliestDate As Long)
    Dim ilRet As Integer
    Dim ilFound As Integer
    Dim ilIndex As Integer
    
    tmChfSrchKey.lCode = llChfCode
    ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
    If (ilRet = BTRV_ERR_NONE) Then
        tmChfSrchKey1.lCntrNo = tgChfInv.lCntrNo
        tmChfSrchKey1.iCntRevNo = 32000
        tmChfSrchKey1.iPropVer = 32000
        ilRet = btrGetGreaterOrEqual(hmCHF, tmChf, imCHFRecLen, tmChfSrchKey1, INDEXKEY1, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        Do While (ilRet = BTRV_ERR_NONE) And (tmChf.lCntrNo = tgChfInv.lCntrNo)
            If (tmChf.sDelete = "N") Then
                ilFound = False
                For ilIndex = 0 To UBound(tmAirCntStatus) - 1 Step 1
                    If tmAirCntStatus(ilIndex).lCntrNo = tmChf.lCntrNo Then
                        ilFound = True
                        gUnpackDateLongError tmChf.iStartDate(0), tmChf.iStartDate(1), llEarliestDate, "49:mCheckAirCntr " & tmChf.lCode
                        If llEarliestDate < tmAirCntStatus(ilIndex).lEarliestDate Then
                            tmAirCntStatus(ilIndex).lEarliestDate = llEarliestDate
                        End If
                        If (tmChf.sSchStatus = "F") Or (tmChf.sSchStatus = "M") Then
                            tmAirCntStatus(ilIndex).lChfCodeSchd = tmChf.lCode
                        Else
                            tmAirCntStatus(ilIndex).lChfCodeAltered = tmChf.lCode
                            tmAirCntStatus(ilIndex).sSchStatus = tmChf.sSchStatus
                        End If
                    End If
                Next ilIndex
                If Not ilFound Then
                    ilIndex = UBound(tmAirCntStatus)
                    tmAirCntStatus(ilIndex).lCntrNo = tmChf.lCntrNo
                    tmAirCntStatus(ilIndex).iAdfCode = tmChf.iAdfCode
                    tmAirCntStatus(ilIndex).sSchStatus = ""
                    gUnpackDateLongError tmChf.iStartDate(0), tmChf.iStartDate(1), tmAirCntStatus(ilIndex).lEarliestDate, "50:mCheckAirCntr " & tmChf.lCode
                    tmAirCntStatus(ilIndex).sBillCycle = tmChf.sBillCycle
                    If (tmChf.sSchStatus = "F") Or (tmChf.sSchStatus = "M") Then
                        tmAirCntStatus(ilIndex).lChfCodeSchd = tmChf.lCode
                        tmAirCntStatus(ilIndex).lChfCodeAltered = 0
                    Else
                        tmAirCntStatus(ilIndex).lChfCodeSchd = 0
                        tmAirCntStatus(ilIndex).lChfCodeAltered = tmChf.lCode
                        tmAirCntStatus(ilIndex).sSchStatus = tmChf.sSchStatus
                    End If
                    ReDim Preserve tmAirCntStatus(0 To ilIndex + 1) As INVCNTRSTATUS
                End If
            End If
            ilRet = btrGetNext(hmCHF, tmChf, imCHFRecLen, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
        Loop
    End If
End Sub

Private Sub mHeading1(ilRet As Integer, slHeading As String, ilCurrentLineNo As Integer)
    On Error GoTo mHeading1Err:
    Printer.Print slHeading
    If ilRet <> 0 Then
        Exit Sub
    End If
    ilCurrentLineNo = ilCurrentLineNo + 1
    Printer.Print " "
    ilCurrentLineNo = ilCurrentLineNo + 1
    Exit Sub
mHeading1Err:
    ilRet = err.Number
    MsgBox "Printing Error # " & str$(ilRet)
    Resume Next
End Sub

Private Sub mLineOutput(ilRet As Integer, slHeading As String, ilCurrentLineNo As Integer, slRecord As String, ilLinesPerPage As Integer)
    On Error GoTo mLineOutputErr:
    If ilCurrentLineNo >= ilLinesPerPage Then
        Printer.NewPage
        If ilRet <> 0 Then
            Exit Sub
        End If
        ilCurrentLineNo = 0
        mHeading1 ilRet, slHeading, ilCurrentLineNo
        If ilRet <> 0 Then
            Exit Sub
        End If
    End If
    Printer.Print slRecord
    ilCurrentLineNo = ilCurrentLineNo + 1
    Exit Sub
mLineOutputErr:
    ilRet = err.Number
    MsgBox "Printing Error # " & str$(ilRet)
    Resume Next
End Sub

Private Function mInstallmentCommission() As Integer
    Dim ilVef As Integer
    Dim ilCommPct As Integer
    Dim ilAgf As Integer
    Dim ilRet As Integer
    
    ilCommPct = 0
    If tgChfInv.iAgfCode > 0 Then
        ilAgf = gBinarySearchAgf(tgChfInv.iAgfCode)
        If ilAgf <> -1 Then
            ilCommPct = tgCommAgf(ilAgf).iCommPct
            'Check if NTR exits and if so check if agency commission specified
            tmSbfSrchKey0.lChfCode = tgChfInv.lCode
            gPackDate "1/1/1970", tmSbfSrchKey0.iDate(0), tmSbfSrchKey0.iDate(1)
            tmSbfSrchKey0.sTranType = "I"
            ilRet = btrGetGreaterOrEqual(hmSbf, tmSbf, imSbfRecLen, tmSbfSrchKey0, INDEXKEY0, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
            Do While (ilRet = BTRV_ERR_NONE) And (tmSbf.lChfCode = tgChfInv.lCode)
                If tmSbf.sTranType = "I" Then
                    If tmSbf.sAgyComm <> "Y" Then
                        ilCommPct = 0
                        Exit Do
                    End If
                End If
                ilRet = btrGetNext(hmSbf, tmSbf, imSbfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
            Loop
        End If
    End If
    mInstallmentCommission = ilCommPct
End Function

'       mIsItPDFEmail - does the agency match one of the export services as PDF Email?
'       <input>  ARF pointer from agency or direct advertiser
'       <return>  true - its pdf email option
'                 false - no pdf
Private Function mIsItPDFEmail(ilArfInvCode As Integer) As Integer
    Dim ilEDI As Integer
    For ilEDI = 0 To UBound(tgEDIServiceInfo) - 1 Step 1
        If ilArfInvCode = tgEDIServiceInfo(ilEDI).tArf.iCode Then
            If Trim$(tgEDIServiceInfo(ilEDI).tArf.sID) = "PDF EMail" Then
                '10-11-16 COMMENT OUT UNTIL PDF EMAIL SCHEME HAS BEEN FINALIZED
                'DO NOT WANT TO CREATE ANY PDFS FOR PDFEMAIL SERVICE OPTION UNTIL FURTHER NOTICE
                mIsItPDFEmail = True
                'imArfPDFEMailCode = 0           '10-11-16 remove once the email pdf scheme is implemented
                Exit Function
            Else
                imArfPDFEMailCode = ilArfInvCode
            End If
        End If
    Next ilEDI
    mIsItPDFEmail = False
End Function

Private Function mGetPDFEmailAddress(blGetAgency As Boolean, ilCode As Integer) As String
    Dim slEmailAdress As String
    Dim ilRet As Integer
    Dim slPDFEmailAddress As String
    slPDFEmailAddress = ""
    tmPDfSrchKey.iCode = ilCode 'agency or direct advt code
    If blGetAgency Then
        ilRet = btrGetEqual(hmPDF, tmPdf, imPdfRecLen, tmPDfSrchKey, INDEXKEY2, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    Else
        ilRet = btrGetEqual(hmPDF, tmPdf, imPdfRecLen, tmPDfSrchKey, INDEXKEY1, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    End If
    Do While (ilRet = BTRV_ERR_NONE) And (((blGetAgency) And (ilCode = tmPdf.iAgfCode)) Or ((Not blGetAgency) And (ilCode = tmPdf.iAdfCode)))       '11-21-16
        If Trim$(slPDFEmailAddress) = "" Then
            slPDFEmailAddress = Trim$(tmPdf.sEMailAddress)
        Else
            slPDFEmailAddress = slPDFEmailAddress & ";" & Trim$(tmPdf.sEMailAddress)
        End If
        
        ilRet = btrGetNext(hmPDF, tmPdf, imPdfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    mGetPDFEmailAddress = slPDFEmailAddress
    Exit Function
End Function

'*******************************************************
'*                                                     *
'*      Procedure Name:mParseCmmdLine                  *
'*                                                     *
'*             Created:5/17/93       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Parse command line             *
'*                                                     *
'*******************************************************
Private Sub mParseCmmdLine()
    Dim slCommand As String
    Dim slStr As String
    Dim ilRet As Integer
    Dim slTestSystem As String
    Dim ilTestSystem As Integer
    Dim slStartIn As String
    Dim slCSIName As String
    Dim slDate As String
    Dim slMonth As String
    Dim slYear As String
    Dim llValue As Long
    Dim ilValue As Integer
    
    sgCommandStr = Command$
    slStartIn = CurDir$
    slCSIName = ""
    If InStr(1, slStartIn, "Test", vbTextCompare) = 0 Then
        igTestSystem = False
    Else
        igTestSystem = True
    End If
    igShowVersionNo = 0
    If (InStr(1, slStartIn, "Prod", vbTextCompare) = 0) And (InStr(1, slStartIn, "Test", vbTextCompare) = 0) Then
        igShowVersionNo = 1
        If InStr(1, sgCommandStr, "Debug", vbTextCompare) > 0 Then
            igShowVersionNo = 2
        End If
    End If
    slCommand = sgCommandStr    'Command$
    lgCurrHRes = GetDeviceCaps(Traffic!pbcList.hdc, HORZRES)
    lgCurrVRes = GetDeviceCaps(Traffic!pbcList.hdc, VERTRES)
    lgCurrBPP = GetDeviceCaps(Traffic!pbcList.hdc, BITSPIXEL)
    mTestPervasive
    '4/2/11: Add setting of value
    lgUlfCode = 0
    'If (Trim$(sgCommandStr) = "") Or (Trim$(sgCommandStr) = "/UserInput") Or (Trim$(sgCommandStr) = "Debug") Then
    If InStr(1, sgCommandStr, "^", vbTextCompare) <= 0 Then
        Signon.Show vbModal
        If igExitTraffic Then
            imTerminate = True
            Exit Sub
        End If
        slStr = sgUserName
        sgCallAppName = "Traffic"
    Else
        igSportsSystem = 0
        ilRet = gParseItem(slCommand, 1, "\", slStr)    'Get application name
        ilRet = gParseItem(slStr, 1, "^", sgCallAppName)    'Get application name
        ilRet = gParseItem(slStr, 2, "^", slTestSystem)    'Get application name
        ilRet = gParseItem(slCommand, 2, "\", slStr)    'Get user name
        sgUrfStamp = "~" 'Clear time stamp incase same name
        sgUserName = Trim$(slStr)
        '6/20/09:  Jim requested that the Guide sign in be changed to CSI for internal Guide only
        If StrComp(sgUserName, "CSI", vbTextCompare) = 0 Then
            slDate = Format$(Now(), "m/d/yy")
            slMonth = Month(slDate)
            slYear = Year(slDate)
            llValue = Val(slMonth) * Val(slYear)
            ilValue = Int(10000 * Rnd(-llValue) + 1)
            llValue = ilValue
            ilValue = Int(10000 * Rnd(-llValue) + 1)
            slStr = Trim$(str$(ilValue))
            Do While Len(slStr) < 4
                slStr = "0" & slStr
            Loop
            sgSpecialPassword = slStr
            slCSIName = "CSI"
            sgUserName = "Guide"
        End If
        gUrfRead Signon, sgUserName, True, tgUrf(), False  'Obtain user records
        If StrComp(slCSIName, "CSI", vbTextCompare) = 0 Then
            gExpandGuideAsUser tgUrf(0)
        End If
        mGetUlfCode
    End If
    DoEvents
    gInitStdAlone
    mCheckForDate
    ilRet = gObtainSAF()
    igLogActivityStatus = 32123
    gUserActivityLog "L", "Invoice.Frm"
    If igWinStatus(INVOICESJOB) = 0 Then
        imTerminate = True
    End If
End Sub

Private Sub mTestPervasive()
    Dim ilRet As Integer
    Dim ilRecLen As Integer
    Dim hlSpf As Integer
    Dim tlSpf As SPF

    gInitGlobalVar
    hlSpf = CBtrvTable(ONEHANDLE)
    ilRet = btrOpen(hlSpf, "", sgDBPath & "Spf.btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        btrDestroy hlSpf
        hgDB = CBtrvMngrInit(0, sgMDBPath, sgSDBPath, sgTDBPath, igRetrievalDB, sgDBPath) 'Use 0 as 1 gets a GPF. 1=Initialize Btrieve only if not initialized
        Do While csiHandleValue(0, 3) = 0
            '7/6/11
            Sleep 1000
        Loop
        Exit Sub
    End If
    ilRecLen = Len(tlSpf)
    ilRet = btrGetFirst(hlSpf, tlSpf, ilRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    If ilRet <> BTRV_ERR_NONE Then
        btrDestroy hlSpf
        hgDB = CBtrvMngrInit(0, sgMDBPath, sgSDBPath, sgTDBPath, igRetrievalDB, sgDBPath) 'Use 0 as 1 gets a GPF. 1=Initialize Btrieve only if not initialized
        Do While csiHandleValue(0, 3) = 0
            '7/6/11
            Sleep 1000
        Loop
        Exit Sub
    End If
    btrDestroy hlSpf
End Sub

Private Sub mCheckForDate()
    Dim ilPos As Integer
    Dim ilSpace As Integer
    Dim slDate As String
    Dim slSetDate As String
    Dim ilRet As Integer
    
    ilPos = InStr(1, sgCommandStr, "/D:", 1)
    If ilPos > 0 Then
        ilSpace = InStr(ilPos, sgCommandStr, " ")
        If ilSpace = 0 Then
            slDate = Trim$(Mid$(sgCommandStr, ilPos + 3))
        Else
            slDate = Trim$(Mid$(sgCommandStr, ilPos + 3, ilSpace - ilPos - 3))
        End If
        If gValidDate(slDate) Then
            slDate = gAdjYear(slDate)
            slSetDate = slDate
        End If
    End If
    If Trim$(slSetDate) = "" Then
        If (InStr(1, tgSpf.sGClient, "XYZ Broadcasting", vbTextCompare) > 0) Or (InStr(1, tgSpf.sGClient, "XYZ Network", vbTextCompare) > 0) Then
            slSetDate = "12/15/1999"
            slDate = slSetDate
        End If
    End If
    If Trim$(slSetDate) <> "" Then
        'Dan M 9/20/10 problems with gGetCSIName("SYSDate") in v57 reports.exe... change to global variable
     '   ilRet = csiSetName("SYSDate", slDate)
        ilRet = gCsiSetName(slDate)
    End If
End Sub

'4/2/11: Add routine
Private Sub mGetUlfCode()
    Dim ilPos As Integer
    Dim ilSpace As Integer
    
    ilPos = InStr(1, sgCommandStr, "/ULF:", 1)
    If ilPos > 0 Then
        ilSpace = InStr(ilPos, sgCommandStr, " ")
        If ilSpace = 0 Then
            lgUlfCode = Val(Trim$(Mid$(sgCommandStr, ilPos + 5)))
        Else
            lgUlfCode = Val(Trim$(Mid$(sgCommandStr, ilPos + 5, ilSpace - ilPos - 3)))
        End If
    End If
End Sub

Private Sub mCheckAndPopEDIServiceNames()
    Dim ilRet As Integer
    Dim ilDonovanFd As Integer
    Dim ilKatzFd As Integer
    Dim ilRadioInvFd As Integer
    Dim ilWarrenLambFd As Integer
    Dim ilSpotDataFd As Integer     '11-12-10
    Dim ilMediaBankFd As Integer    '11-12-10
    Dim ilPDFEMailFd As Integer
    Dim ilMOceanOmni As Integer     'TTP 10897 - EDI new format: MOcean Omni
    Dim ilLoop As Integer
    Dim ilSave As Integer
    Dim ilUpper As Integer
    
    ReDim tgEDIServiceInfo(0 To 0) As EDISERVICEINFO
    hmArf = CBtrvTable(ONEHANDLE) 'CBtrvObj()
    ilRet = btrOpen(hmArf, "", sgDBPath & "ARF.Btr", BTRV_OPEN_NORMAL, BTRV_OPEN_NONSHARE, BTRV_LOCK_NONE)
    If ilRet <> BTRV_ERR_NONE Then
        Exit Sub
    End If
    imArfRecLen = Len(tmArf)
    ilDonovanFd = False
    ilKatzFd = False
    ilRadioInvFd = False
    ilWarrenLambFd = False
    ilSpotDataFd = False
    ilMediaBankFd = False
    ilPDFEMailFd = False
    ilMOceanOmni = False 'TTP 10897 - EDI new format: MOcean Omni
    ilRet = btrGetFirst(hmArf, tmArf, imArfRecLen, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)   'Get first record as starting point of extend operation
    Do While ilRet = BTRV_ERR_NONE
        If tmArf.sType = "A" Then
            ilSave = False
            If (StrComp(Trim$(tmArf.sID), "Donovan", vbTextCompare) = 0) Or (StrComp(Trim$(tmArf.sID), "MOcean DS", vbTextCompare) = 0) Then
                ilDonovanFd = True
                ilSave = True
            End If
            If StrComp(Trim$(tmArf.sID), "Katz", vbTextCompare) = 0 Then
                ilKatzFd = True
                ilSave = True
            End If
            If StrComp(Trim$(tmArf.sID), "RadioInv", vbTextCompare) = 0 Then
                ilRadioInvFd = True
                ilSave = True
            End If
            If StrComp(Trim$(tmArf.sID), "WarrenLamb", vbTextCompare) = 0 Then
                ilWarrenLambFd = True
                ilSave = True
            End If
            If StrComp(Trim$(tmArf.sID), "SpotData", vbTextCompare) = 0 Then
                ilSpotDataFd = True
                ilSave = True
            End If
            If (StrComp(Trim$(tmArf.sID), "MediaBank", vbTextCompare) = 0) Or (StrComp(Trim$(tmArf.sID), "MOcean OX", vbTextCompare) = 0) Then
                ilMediaBankFd = True
                ilSave = True
            End If
            'TTP 10897 - EDI new format: MOcean Omni
            If (StrComp(Trim$(tmArf.sID), "Omni", vbTextCompare) = 0) Then
                ilMOceanOmni = True
                ilSave = True
            End If
            If StrComp(Trim$(tmArf.sID), "PDF EMail", vbTextCompare) = 0 Then
                ilPDFEMailFd = True
                '10/12/16: PDF EMail test so that only CSI will see it
                '11-21-16 remove test to test for CSI on PDF email.  Full feature implemented
'                If (Trim$(tgUrf(0).sName) = sgCPName) Or (Trim$(tgUrf(0).sName) = sgSUName) Then
                    ilSave = True
'                End If
            End If
            If ilSave Then
                ilUpper = UBound(tgEDIServiceInfo)
                tgEDIServiceInfo(ilUpper).tArf = tmArf
                tgEDIServiceInfo(ilUpper).hEDI = -1
                tgEDIServiceInfo(ilUpper).sPathFile = ""
                tgEDIServiceInfo(ilUpper).sUsed = "N"
                ReDim Preserve tgEDIServiceInfo(0 To ilUpper + 1) As EDISERVICEINFO
            End If
        End If
        ilRet = btrGetNext(hmArf, tmArf, imArfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
    Loop
    For ilLoop = 0 To 3 Step 1
        tmArf.sNmAd(ilLoop) = ""
    Next ilLoop
    tmArf.sType = "A"
    tmArf.sSepInvByVeh = "N"
    tmArf.sEMail = ""
    tmArf.sFTP = ""
    tmArf.sSendISCITo = ""
    tmArf.sWebSite = ""
    tmArf.sContactName = ""
    tmArf.sContactPhone = ""
    tmArf.sContactFax = ""
    If Not ilDonovanFd Then
        tmArf.iCode = 0
        tmArf.sID = "MOcean DS" '"Donovan"
        ilRet = btrInsert(hmArf, tmArf, imArfRecLen, 0)
        ilUpper = UBound(tgEDIServiceInfo)
        tgEDIServiceInfo(ilUpper).tArf = tmArf
        tgEDIServiceInfo(ilUpper).hEDI = -1
        tgEDIServiceInfo(ilUpper).sUsed = "N"
        ReDim Preserve tgEDIServiceInfo(0 To ilUpper + 1) As EDISERVICEINFO
    End If
    If Not ilKatzFd Then
        tmArf.iCode = 0
        tmArf.sID = "Katz"
        ilRet = btrInsert(hmArf, tmArf, imArfRecLen, 0)
        ilUpper = UBound(tgEDIServiceInfo)
        tgEDIServiceInfo(ilUpper).tArf = tmArf
        tgEDIServiceInfo(ilUpper).hEDI = -1
        tgEDIServiceInfo(ilUpper).sUsed = "N"
        ReDim Preserve tgEDIServiceInfo(0 To ilUpper + 1) As EDISERVICEINFO
    End If
    If Not ilRadioInvFd Then
        tmArf.iCode = 0
        tmArf.sID = "RadioInv"
        ilRet = btrInsert(hmArf, tmArf, imArfRecLen, 0)
        ilUpper = UBound(tgEDIServiceInfo)
        tgEDIServiceInfo(ilUpper).tArf = tmArf
        tgEDIServiceInfo(ilUpper).hEDI = -1
        tgEDIServiceInfo(ilUpper).sUsed = "N"
        ReDim Preserve tgEDIServiceInfo(0 To ilUpper + 1) As EDISERVICEINFO
    End If
    If Not ilWarrenLambFd Then
        tmArf.iCode = 0
        tmArf.sID = "WarrenLamb"
        ilRet = btrInsert(hmArf, tmArf, imArfRecLen, 0)
        ilUpper = UBound(tgEDIServiceInfo)
        tgEDIServiceInfo(ilUpper).tArf = tmArf
        tgEDIServiceInfo(ilUpper).hEDI = -1
        tgEDIServiceInfo(ilUpper).sUsed = "N"
        ReDim Preserve tgEDIServiceInfo(0 To ilUpper + 1) As EDISERVICEINFO
    End If
    If Not ilSpotDataFd Then
        tmArf.iCode = 0
        tmArf.sID = "SpotData"
        ilRet = btrInsert(hmArf, tmArf, imArfRecLen, 0)
        ilUpper = UBound(tgEDIServiceInfo)
        tgEDIServiceInfo(ilUpper).tArf = tmArf
        tgEDIServiceInfo(ilUpper).hEDI = -1
        tgEDIServiceInfo(ilUpper).sUsed = "N"
        ReDim Preserve tgEDIServiceInfo(0 To ilUpper + 1) As EDISERVICEINFO
    End If
    If Not ilMediaBankFd Then
        tmArf.iCode = 0
        tmArf.sID = "MOcean OX" '"MediaBank"
        ilRet = btrInsert(hmArf, tmArf, imArfRecLen, 0)
        ilUpper = UBound(tgEDIServiceInfo)
        tgEDIServiceInfo(ilUpper).tArf = tmArf
        tgEDIServiceInfo(ilUpper).hEDI = -1
        tgEDIServiceInfo(ilUpper).sUsed = "N"
        ReDim Preserve tgEDIServiceInfo(0 To ilUpper + 1) As EDISERVICEINFO
    End If
    'TTP 10897 - EDI new format: MOcean Omni
    If Not ilMOceanOmni Then
        tmArf.iCode = 0
        tmArf.sID = "Omni"
        ilRet = btrInsert(hmArf, tmArf, imArfRecLen, 0)
        ilUpper = UBound(tgEDIServiceInfo)
        tgEDIServiceInfo(ilUpper).tArf = tmArf
        tgEDIServiceInfo(ilUpper).hEDI = -1
        tgEDIServiceInfo(ilUpper).sUsed = "N"
        ReDim Preserve tgEDIServiceInfo(0 To ilUpper + 1) As EDISERVICEINFO
    End If
    If Not ilPDFEMailFd Then
        tmArf.iCode = 0
        tmArf.sID = "PDF EMail"
        ilRet = btrInsert(hmArf, tmArf, imArfRecLen, 0)
        '10/12/16: PDF EMail test so that only CSI will see it
        If (Trim$(tgUrf(0).sName) = sgCPName) Or (Trim$(tgUrf(0).sName) = sgSUName) Then
            ilUpper = UBound(tgEDIServiceInfo)
            tgEDIServiceInfo(ilUpper).tArf = tmArf
            tgEDIServiceInfo(ilUpper).hEDI = -1
            tgEDIServiceInfo(ilUpper).sUsed = "N"
            ReDim Preserve tgEDIServiceInfo(0 To ilUpper + 1) As EDISERVICEINFO
        End If
    End If
    'Check if name needs to be changed
    For ilLoop = 0 To UBound(tgEDIServiceInfo) - 1 Step 1
        If (StrComp(Trim$(tgEDIServiceInfo(ilLoop).tArf.sID), "Donovan", vbTextCompare) = 0) Then
            tmArfSrchKey.iCode = tgEDIServiceInfo(ilLoop).tArf.iCode
            ilRet = btrGetEqual(hmArf, tmArf, imArfRecLen, tmArfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)
            If ilRet = BTRV_ERR_NONE Then
                tmArf.sID = "MOcean DS"
                ilRet = btrUpdate(hmArf, tmArf, imArfRecLen)
            End If
        End If
        If (StrComp(Trim$(tgEDIServiceInfo(ilLoop).tArf.sID), "MediaBank", vbTextCompare) = 0) Then
            tmArfSrchKey.iCode = tgEDIServiceInfo(ilLoop).tArf.iCode
            ilRet = btrGetEqual(hmArf, tmArf, imArfRecLen, tmArfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORWRITE)
            If ilRet = BTRV_ERR_NONE Then
                tmArf.sID = "MOcean OX"
                ilRet = btrUpdate(hmArf, tmArf, imArfRecLen)
            End If
        End If
    Next ilLoop
    ilRet = btrClose(hmArf)
    btrDestroy hmArf
End Sub

'*******************************************************
'*                                                     *
'*      Procedure Name:mAvailTimePop                   *
'*                                                     *
'*             Created:3/01/94       By:D. LeVine      *
'*            Modified:              By:               *
'*                                                     *
'*            Comments: Populate list box with avail   *
'*                      times                          *
'*                                                     *
'*******************************************************
Private Sub mClosestAvailTime(llMissedDate As Long, llMissedTime As Long, ilTBIndex As Integer, llOrigMissedDate As Long)
    Dim ilDate0 As Integer
    Dim ilDate1 As Integer
    Dim slTime As String
    Dim ilRet As Integer
    Dim ilLoop As Integer
    Dim ilType As Integer
    Dim llPrevAvailTime As Long
    Dim llCurAvailTime As Long
    Dim ilTime As Integer
    Dim ilPass As Integer
    
    llPrevAvailTime = -1
    
    For ilPass = 0 To 1 Step 1
        ilType = tmSmf.iGameNo
        If ilPass = 0 Then
            gPackDateLong llMissedDate, ilDate0, ilDate1
        Else
            gPackDateLong llOrigMissedDate, ilDate0, ilDate1
        End If
        imSsfRecLen = Len(tmSsf) 'Max size of variable length record
        tmSsfSrchKey.iType = ilType 'slType-On Air
        tmSsfSrchKey.iVefCode = tmSmf.iOrigSchVef
        tmSsfSrchKey.iDate(0) = ilDate0
        tmSsfSrchKey.iDate(1) = ilDate1
        tmSsfSrchKey.iStartTime(0) = 0
        tmSsfSrchKey.iStartTime(1) = 0
        ilRet = gSSFGetGreaterOrEqual(hmSsf, tmSsf, imSsfRecLen, tmSsfSrchKey, INDEXKEY0, BTRV_LOCK_NONE)   'Get last current record to obtain date
        Do While (ilRet = BTRV_ERR_NONE) And (tmSsf.iType = ilType) And (tmSsf.iVefCode = tmSmf.iOrigSchVef) And (tmSsf.iDate(0) = ilDate0) And (tmSsf.iDate(1) = ilDate1)
            For ilLoop = 1 To tmSsf.iCount Step 1
                LSet tmAvail = tmSsf.tPas(ADJSSFPASBZ + ilLoop)
                If (tmAvail.iRecType >= 2) And (tmAvail.iRecType <= 9) Then
                    gUnpackTimeLong tmAvail.iTime(0), tmAvail.iTime(1), False, llCurAvailTime
                    If (llMissedTime >= llPrevAvailTime) And (llMissedTime <= llCurAvailTime) Then
                        If llPrevAvailTime <> -1 Then
                            For ilTime = 1 To ilTBIndex Step 1
                                If (llPrevAvailTime >= lmTBStartTime(ilTime)) And (llPrevAvailTime < lmTBEndTime(ilTime)) Then
                                    llMissedTime = llPrevAvailTime
                                    If ilPass = 1 Then
                                        llMissedDate = llOrigMissedDate
                                    End If
                                    Exit Sub
                                End If
                            Next ilTime
                        End If
                        For ilTime = 1 To ilTBIndex Step 1
                            If (llCurAvailTime >= lmTBStartTime(ilTime)) And (llCurAvailTime < lmTBEndTime(ilTime)) Then
                                llMissedTime = llCurAvailTime
                                If ilPass = 1 Then
                                    llMissedDate = llOrigMissedDate
                                End If
                                Exit Sub
                            End If
                        Next ilTime
                        llPrevAvailTime = llCurAvailTime
                    End If
                End If
            Next ilLoop
            imSsfRecLen = Len(tmSsf) 'Max size of variable length record
            ilRet = gSSFGetNext(hmSsf, tmSsf, imSsfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        Loop
    Next ilPass
End Sub

'Check if bill flag for NTR needs to be set
Private Function mSetNTRBillFlagIfMissing() As Boolean
    Dim ilRet As Integer
    Dim ilPass As Integer
    Dim hlFile As Integer
    
    mSetNTRBillFlagIfMissing = False
    tmChfSrchKey.lCode = tmSbf.lChfCode
    ilRet = btrGetEqual(hmCHF, tgChfInv, imCHFRecLen, tmChfSrchKey, INDEXKEY0, BTRV_LOCK_NONE, SETFORREADONLY)
    If ilRet <> BTRV_ERR_NONE Then
        Exit Function
    End If
    For ilPass = 0 To 1 Step 1
        If ilPass = 0 Then
            hlFile = hmRvf
        Else
            hlFile = hmPhf
        End If
        tmRvfSrchKey4.lCntrNo = tgChfInv.lCntrNo
        tmRvfSrchKey4.iTranDate(0) = 0
        tmRvfSrchKey4.iTranDate(1) = 0
        ilRet = btrGetGreaterOrEqual(hlFile, tmRvf, imRvfRecLen, tmRvfSrchKey4, INDEXKEY4, BTRV_LOCK_NONE)   'Get first record as starting point of extend operation
        Do While (ilRet = BTRV_ERR_NONE) And (tmRvf.lCntrNo = tgChfInv.lCntrNo)
            If tmRvf.lSbfCode = tmSbf.lCode Then
                If (tmRvf.sTranType = "IN") Or (tmRvf.sTranType = "HI") Then
                    If tmRvf.sInvoiceUndone = "Y" Then
                        Exit Function
                    End If
                    tmSbf.sBilled = "Y"
                    ilRet = btrUpdate(hmSbf, tmSbf, imSbfRecLen)
                    mSetNTRBillFlagIfMissing = True
                    Exit Function
                End If
            End If
            ilRet = btrGetNext(hlFile, tmRvf, imRvfRecLen, BTRV_LOCK_NONE, SETFORREADONLY)
        Loop
    Next ilPass
End Function

Private Sub mAdd41IfMissing(tlSdf As SDF, ilEDIUpper As Integer)
    Dim ilEDI As Integer
    'Check for MG past contract end and 41 not crecated
    If (tlSdf.sSchStatus <> "G") And (tlSdf.sSchStatus <> "O") Then
        Exit Sub
    End If
    If UBound(tmWkDef) > LBound(tmWkDef) Then
        Exit Sub
    End If
    For ilEDI = ilEDIUpper - 1 To 0 Step -1
        If InStr(1, smEDIRecords(ilEDI), "41;") Then
            Exit Sub
        End If
        If InStr(1, smEDIRecords(ilEDI), "31;") Then
            'Add record
            smEDIRecords(ilEDIUpper) = "41;" & Trim$(str$(tmSdf.iLineNo)) & ";" & "" & ";" & "" & ";" & "" & ";;" & "" & ";" & "" & ";" & "" & ";" & "" & ";"
            ilEDIUpper = ilEDIUpper + 1
            ReDim Preserve smEDIRecords(0 To ilEDIUpper) As String
            Exit Sub
        End If
    Next ilEDI
End Sub

Private Sub mSetPDFEmailAllowed()
    imPDFEmailAllowed = combine
    If ((Asc(tgSpf.sUsingFeatures5) And COMBINEAIRNTR) <> COMBINEAIRNTR) Then
    'If imCombineAirAndNTR = 0 Then
        If (Asc(tgSaf(0).sFeatures7) And INVEMAILAIRONLY) = INVEMAILAIRONLY Then
            imPDFEmailAllowed = AirOnly
        ElseIf (Asc(tgSaf(0).sFeatures7) And INVEMAILNTRONLY) = INVEMAILNTRONLY Then
            imPDFEmailAllowed = NtrOnly
        End If
    End If
End Sub

Private Function mIsAllowedToPdFEmail(ilNtr As Integer) As Boolean
    Dim blRet As Boolean
    blRet = True
    If imPDFEmailAllowed <> combine Then
        If (imPDFEmailAllowed = NtrOnly And ilNtr = 0) Or (imPDFEmailAllowed = AirOnly And ilNtr = -1) Then
            blRet = False
        End If
    End If
    mIsAllowedToPdFEmail = blRet
End Function

Private Sub mSetPDFToggling()
    If imPDFEmailAllowed = combine Then
        bmToggleAirAndNTR = False
    Else
        bmToggleAirAndNTR = True
    End If
End Sub

Private Sub mnuTestPDFEmail_Click()
    If mnuTestPDFEmail.Checked = False Then
        mnuTestPDFEmail.Checked = True
        bgPDFEmailTestMode = True
    Else
        mnuTestPDFEmail.Checked = False
        bgPDFEmailTestMode = False
    End If
End Sub

'TTP 10515 - NTR Invoices - "NTR INVOICE and AFFIDAVIT" not displaying correct on NTR Invoices it shows "INVOICES and AFFIDAVIT" started with V81
' Fix TTP 10826 / TTP 10813 - RE: v81 TTP 10826 - updated test results Issue #4
'Sub mSetAirNTRStatus(lCntrNo As Long, sHasAirOrNTR As String)
Sub mSetAirNTRStatus(lCntrNo As Long, sHasAirOrNTR As String, iPayeeCode As Integer)
    Dim ilLoop As Integer
    Dim blFound As Boolean
    For ilLoop = 0 To UBound(tmInvAirNTRStatus)
        If tmInvAirNTRStatus(ilLoop).lCntrNo = lCntrNo Then
            If sHasAirOrNTR = "NTR" Then tmInvAirNTRStatus(ilLoop).bHasNTR = True
            If sHasAirOrNTR = "AIR" Then tmInvAirNTRStatus(ilLoop).bHasAir = True
            tmInvAirNTRStatus(ilLoop).iPayeeCode = iPayeeCode  'Advertiser or Agency code (payee)
            blFound = True
        End If
    Next ilLoop
    If blFound = False Then
        tmInvAirNTRStatus(UBound(tmInvAirNTRStatus)).lCntrNo = lCntrNo
        If sHasAirOrNTR = "NTR" Then tmInvAirNTRStatus(UBound(tmInvAirNTRStatus)).bHasNTR = True
        If sHasAirOrNTR = "AIR" Then tmInvAirNTRStatus(UBound(tmInvAirNTRStatus)).bHasAir = True
        tmInvAirNTRStatus(UBound(tmInvAirNTRStatus)).iPayeeCode = iPayeeCode  'Advertiser or Agency code (payee)
        ReDim Preserve tmInvAirNTRStatus(0 To UBound(tmInvAirNTRStatus) + 1) As INVAIRNTRSTATUS
    End If
End Sub

Private Function mGetNTRHeaderStatus(lCntrNo As Long) As Boolean
    Dim ilLoop As Integer
    For ilLoop = 0 To UBound(tmInvAirNTRStatus)
        If tmInvAirNTRStatus(ilLoop).lCntrNo = lCntrNo Then
            If tmInvAirNTRStatus(ilLoop).bHasNTR = True Then
                If tmInvAirNTRStatus(ilLoop).bHasAir = False Then
                    'Allow NTR Header because This Contract has NTR and NO AirTime/CPM
                    mGetNTRHeaderStatus = True
                    Exit Function
                End If
            End If
            Exit Function
        End If
    Next ilLoop
End Function

'TTP 10622 - Invoice: exclude trade portion from "pay this amount" value shown on the final invoice page
Private Function CheckSuppressNetAmount(iAgfCode As Integer, iAdfCode As Integer) As Boolean
    Dim blSuppressNetAmount As Boolean
    Dim slSQLQuery As String
    Dim rs As ADODB.Recordset
    
    'check if this is the same Agf/Adf code that was queried, if yes then return the last value
    If smLastAgyAdvTradeSuppressNetAmount = iAgfCode & "," & iAdfCode Then
        CheckSuppressNetAmount = bmLastTradeSuppressNetAmount
        Exit Function
    End If
    
    'Last Agf/Adf code queried
    smLastAgyAdvTradeSuppressNetAmount = iAgfCode & "," & iAdfCode
    
    'Query, get agfxInvFeatures and adfxInvFeatures
    slSQLQuery = "SELECT "
    slSQLQuery = slSQLQuery & " (SELECT agfxInvFeatures FROM AGFX_Agencies WHERE agfxCode = " & iAgfCode & ") as agfxInvFeatures,"
    slSQLQuery = slSQLQuery & " (SELECT adfxInvFeatures FROM ADFX_Advertisers WHERE adfxCode = " & iAdfCode & ") as adfxInvFeatures"
    
    'Check agfxInvFeatures and adfxInvFeatures Bit "0=None, 1=Suppress Net Amount for trade invoices"
    blSuppressNetAmount = False
    Set rs = gSQLSelectCall(slSQLQuery)
    If Not rs.EOF Then
        'Check if Agency has TRADEINVSUPRESSNETAMT set
        If Not IsNull(rs!agfxInvFeatures) Then
            If (rs!agfxInvFeatures And TRADEINVSUPRESSNETAMT) = TRADEINVSUPRESSNETAMT Then blSuppressNetAmount = True
        End If
        'If this is a Direct advertiser (has No Agency), check if Direct Advertiser has TRADEINVSUPRESSNETAMT set
        If iAgfCode = 0 And blSuppressNetAmount = False Then
            If Not IsNull(rs!adfxInvFeatures) Then
                If (rs!adfxInvFeatures And TRADEINVSUPRESSNETAMT) = TRADEINVSUPRESSNETAMT Then blSuppressNetAmount = True
            End If
        End If
    End If
    
    'set Last bmLastTradeSuppressNetAmount and Return value
    bmLastTradeSuppressNetAmount = blSuppressNetAmount
    CheckSuppressNetAmount = blSuppressNetAmount
End Function

'TTP 10826 / TTP 10813 - PDF invoice - selective invoice feature checklist
'This is used to capture the ID of the Arf record "PDF Email".  Any matching Direct Adv or Agency having agfarfInvCode set to this ID can Have selective PDF emailing
Function mGetPDFEmailArfCode() As Integer
    Dim ilEDI As Integer
    For ilEDI = 0 To UBound(tgEDIServiceInfo) - 1 Step 1
        If Trim$(tgEDIServiceInfo(ilEDI).tArf.sID) = "PDF EMail" Then
            mGetPDFEmailArfCode = tgEDIServiceInfo(ilEDI).tArf.iCode
        End If
    Next ilEDI
End Function
